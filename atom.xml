<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Ruan Bekker's Blog]]></title>
  <link href="http://blog.ruanbekker.com/atom.xml" rel="self"/>
  <link href="http://blog.ruanbekker.com/"/>
  <updated>2017-10-25T06:46:06-04:00</updated>
  <id>http://blog.ruanbekker.com/</id>
  <author>
    <name><![CDATA[Ruan]]></name>
    <email><![CDATA[ruan@ruanbekker.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Running Java Web Applications on Tomcat With Docker Swarm]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/24/running-java-web-applications-on-tomcat-with-docker-swarm/"/>
    <updated>2017-10-24T09:37:38-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/24/running-java-web-applications-on-tomcat-with-docker-swarm</id>
    <content type="html"><![CDATA[<p>From <a href="https://sysadmins.co.za/running-java-web-applications-on-docker-with-payara-micro/?referral=blog.ruanbekker.com?category=java">this post</a> we used Payara Micro to Setup a Web Application, and a full example was provided on how to create a <code>war</code> file that will be used for the deployment.</p>

<p>Today we will be using Tomcat to deploy the same application. The official repository can be found on <a href="https://hub.docker.com/_/tomcat/">hub.docker.com/_/tomcat</a> .</p>

<h2>Our Dockerfile for our Own Tomcat Image:</h2>

<p>The <code>Dockerfile</code> is modified a bit (CATALINA_OPTS) to be able to pass <code>JVM</code> environment variables, but if you would like to use the standard image you can skip this and just use the image from their repository.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM openjdk:8-jre-alpine
</span><span class='line'>
</span><span class='line'>ENV CATALINA_HOME /usr/local/tomcat
</span><span class='line'>ENV PATH <span class="nv">$CATALINA_HOME</span>/bin:<span class="nv">$PATH</span>
</span><span class='line'>RUN mkdir -p <span class="s2">&quot;$CATALINA_HOME&quot;</span>
</span><span class='line'>WORKDIR <span class="nv">$CATALINA_HOME</span>
</span><span class='line'>ENV CATALINA_OPTS -Xmx768m -Xms512m -XX:PermSize<span class="o">=</span>256m -XX:MaxPermSize<span class="o">=</span>512m -XX:ReservedCodeCacheSize<span class="o">=</span>64m -XX:+UseG1GC -XX:+CMSClassUnloadingEnabled -XX:+PrintHeapAtGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps
</span><span class='line'><span class="c"># let &quot;Tomcat Native&quot; live somewhere isolated</span>
</span><span class='line'>ENV TOMCAT_NATIVE_LIBDIR <span class="nv">$CATALINA_HOME</span>/native-jni-lib
</span><span class='line'>ENV LD_LIBRARY_PATH <span class="k">${</span><span class="nv">LD_LIBRARY_PATH</span><span class="p">:+</span><span class="nv">$LD_LIBRARY_PATH</span><span class="p">:</span><span class="k">}</span><span class="nv">$TOMCAT_NATIVE_LIBDIR</span>
</span><span class='line'>
</span><span class='line'>RUN apk add --no-cache gnupg
</span><span class='line'>
</span><span class='line'><span class="c"># see https://www.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/KEYS</span>
</span><span class='line'><span class="c"># see also &quot;update.sh&quot; (https://github.com/docker-library/tomcat/blob/master/update.sh)</span>
</span><span class='line'>ENV GPG_KEYS 05AB33110949707C93A279E3D3EFE6B686867BA6 07E48665A34DCAFAE522E5E6266191C37C037D42 47309207D818FFD8DCD3F83F1931D684307A10A5 541FBE7D8F78B25E055DDEE13C370389288584E7 61B832AC2F1C5A90F0F9B00A1C506407564C17A3 713DA88BE50911535FE716F5208B0AB1D63011C7 79F7026C690BAA50B92CD8B66A3AD3F4F22C4FED 9BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23
</span><span class='line'>RUN <span class="nb">set</span> -ex<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="k">for</span> key in <span class="nv">$GPG_KEYS</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
</span><span class='line'>      gpg --keyserver ha.pool.sks-keyservers.net --recv-keys <span class="s2">&quot;$key&quot;</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'>
</span><span class='line'>ENV TOMCAT_MAJOR 8
</span><span class='line'>ENV TOMCAT_VERSION 8.5.23
</span><span class='line'>ENV TOMCAT_SHA1 1ba27c1bb86ab9c8404e98068800f90bd662523c
</span><span class='line'>
</span><span class='line'>ENV TOMCAT_TGZ_URLS <span class="se">\</span>
</span><span class='line'><span class="c"># https://issues.apache.org/jira/browse/INFRA-8753?focusedCommentId=14735394#comment-14735394</span>
</span><span class='line'>  https://www.apache.org/dyn/closer.cgi?action<span class="o">=</span>download<span class="p">&amp;</span><span class="nv">filename</span><span class="o">=</span>tomcat/tomcat-<span class="nv">$TOMCAT_MAJOR</span>/v<span class="nv">$TOMCAT_VERSION</span>/bin/apache-tomcat-<span class="nv">$TOMCAT_VERSION</span>.tar.gz <span class="se">\</span>
</span><span class='line'><span class="c"># if the version is outdated, we might have to pull from the dist/archive :/</span>
</span><span class='line'>  https://www-us.apache.org/dist/tomcat/tomcat-<span class="nv">$TOMCAT_MAJOR</span>/v<span class="nv">$TOMCAT_VERSION</span>/bin/apache-tomcat-<span class="nv">$TOMCAT_VERSION</span>.tar.gz <span class="se">\</span>
</span><span class='line'>  https://www.apache.org/dist/tomcat/tomcat-<span class="nv">$TOMCAT_MAJOR</span>/v<span class="nv">$TOMCAT_VERSION</span>/bin/apache-tomcat-<span class="nv">$TOMCAT_VERSION</span>.tar.gz <span class="se">\</span>
</span><span class='line'>  https://archive.apache.org/dist/tomcat/tomcat-<span class="nv">$TOMCAT_MAJOR</span>/v<span class="nv">$TOMCAT_VERSION</span>/bin/apache-tomcat-<span class="nv">$TOMCAT_VERSION</span>.tar.gz
</span><span class='line'>
</span><span class='line'>ENV TOMCAT_ASC_URLS <span class="se">\</span>
</span><span class='line'>  https://www.apache.org/dyn/closer.cgi?action<span class="o">=</span>download<span class="p">&amp;</span><span class="nv">filename</span><span class="o">=</span>tomcat/tomcat-<span class="nv">$TOMCAT_MAJOR</span>/v<span class="nv">$TOMCAT_VERSION</span>/bin/apache-tomcat-<span class="nv">$TOMCAT_VERSION</span>.tar.gz.asc <span class="se">\</span>
</span><span class='line'><span class="c"># not all the mirrors actually carry the .asc files :&#39;(</span>
</span><span class='line'>  https://www-us.apache.org/dist/tomcat/tomcat-<span class="nv">$TOMCAT_MAJOR</span>/v<span class="nv">$TOMCAT_VERSION</span>/bin/apache-tomcat-<span class="nv">$TOMCAT_VERSION</span>.tar.gz.asc <span class="se">\</span>
</span><span class='line'>  https://www.apache.org/dist/tomcat/tomcat-<span class="nv">$TOMCAT_MAJOR</span>/v<span class="nv">$TOMCAT_VERSION</span>/bin/apache-tomcat-<span class="nv">$TOMCAT_VERSION</span>.tar.gz.asc <span class="se">\</span>
</span><span class='line'>  https://archive.apache.org/dist/tomcat/tomcat-<span class="nv">$TOMCAT_MAJOR</span>/v<span class="nv">$TOMCAT_VERSION</span>/bin/apache-tomcat-<span class="nv">$TOMCAT_VERSION</span>.tar.gz.asc
</span><span class='line'>
</span><span class='line'>RUN <span class="nb">set</span> -eux<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="se">\</span>
</span><span class='line'>  apk add --no-cache --virtual .fetch-deps <span class="se">\</span>
</span><span class='line'>      ca-certificates <span class="se">\</span>
</span><span class='line'>      openssl <span class="se">\</span>
</span><span class='line'>  <span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="se">\</span>
</span><span class='line'>  <span class="nv">success</span><span class="o">=</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="k">for</span> url in <span class="nv">$TOMCAT_TGZ_URLS</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
</span><span class='line'>      <span class="k">if</span> wget -O tomcat.tar.gz <span class="s2">&quot;$url&quot;</span><span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
</span><span class='line'>          <span class="nv">success</span><span class="o">=</span>1<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>          <span class="nb">break</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>      <span class="k">fi</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="k">done</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="o">[</span> -n <span class="s2">&quot;$success&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="se">\</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;$TOMCAT_SHA1 *tomcat.tar.gz&quot;</span> <span class="p">|</span> sha1sum -c -<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="se">\</span>
</span><span class='line'>  <span class="nv">success</span><span class="o">=</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="k">for</span> url in <span class="nv">$TOMCAT_ASC_URLS</span><span class="p">;</span> <span class="k">do</span> <span class="se">\</span>
</span><span class='line'>      <span class="k">if</span> wget -O tomcat.tar.gz.asc <span class="s2">&quot;$url&quot;</span><span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
</span><span class='line'>          <span class="nv">success</span><span class="o">=</span>1<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>          <span class="nb">break</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>      <span class="k">fi</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="k">done</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="o">[</span> -n <span class="s2">&quot;$success&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="se">\</span>
</span><span class='line'>  gpg --batch --verify tomcat.tar.gz.asc tomcat.tar.gz<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  tar -xvf tomcat.tar.gz --strip-components<span class="o">=</span>1<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  rm bin/*.bat<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  rm tomcat.tar.gz*<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="se">\</span>
</span><span class='line'>  <span class="nv">nativeBuildDir</span><span class="o">=</span><span class="s2">&quot;$(mktemp -d)&quot;</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  tar -xvf bin/tomcat-native.tar.gz -C <span class="s2">&quot;$nativeBuildDir&quot;</span> --strip-components<span class="o">=</span>1<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  apk add --no-cache --virtual .native-build-deps <span class="se">\</span>
</span><span class='line'>      apr-dev <span class="se">\</span>
</span><span class='line'>      coreutils <span class="se">\</span>
</span><span class='line'>      dpkg-dev dpkg <span class="se">\</span>
</span><span class='line'>      gcc <span class="se">\</span>
</span><span class='line'>      libc-dev <span class="se">\</span>
</span><span class='line'>      make <span class="se">\</span>
</span><span class='line'>      <span class="s2">&quot;openjdk${JAVA_VERSION%%[-~bu]*}&quot;</span><span class="o">=</span><span class="s2">&quot;$JAVA_ALPINE_VERSION&quot;</span> <span class="se">\</span>
</span><span class='line'>      openssl-dev <span class="se">\</span>
</span><span class='line'>  <span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="o">(</span> <span class="se">\</span>
</span><span class='line'>      <span class="nb">export </span><span class="nv">CATALINA_HOME</span><span class="o">=</span><span class="s2">&quot;$PWD&quot;</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>      <span class="nb">cd</span> <span class="s2">&quot;$nativeBuildDir/native&quot;</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>      <span class="nv">gnuArch</span><span class="o">=</span><span class="s2">&quot;$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)&quot;</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>      ./configure <span class="se">\</span>
</span><span class='line'>          --build<span class="o">=</span><span class="s2">&quot;$gnuArch&quot;</span> <span class="se">\</span>
</span><span class='line'>          --libdir<span class="o">=</span><span class="s2">&quot;$TOMCAT_NATIVE_LIBDIR&quot;</span> <span class="se">\</span>
</span><span class='line'>          --prefix<span class="o">=</span><span class="s2">&quot;$CATALINA_HOME&quot;</span> <span class="se">\</span>
</span><span class='line'>          --with-apr<span class="o">=</span><span class="s2">&quot;$(which apr-1-config)&quot;</span> <span class="se">\</span>
</span><span class='line'>          --with-java-home<span class="o">=</span><span class="s2">&quot;$(docker-java-home)&quot;</span> <span class="se">\</span>
</span><span class='line'>          --with-ssl<span class="o">=</span>yes<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>      make -j <span class="s2">&quot;$(nproc)&quot;</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>      make install<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="o">)</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="nv">runDeps</span><span class="o">=</span><span class="s2">&quot;$( \</span>
</span><span class='line'><span class="s2">     scanelf --needed --nobanner --format &#39;%n#p&#39; --recursive &quot;</span><span class="nv">$TOMCAT_NATIVE_LIBDIR</span><span class="s2">&quot; \</span>
</span><span class='line'><span class="s2">         | tr &#39;,&#39; &#39;\n&#39; \</span>
</span><span class='line'><span class="s2">         | sort -u \</span>
</span><span class='line'><span class="s2">         | awk &#39;system(&quot;</span><span class="o">[</span> -e /usr/local/lib/<span class="s2">&quot; $1 &quot;</span> <span class="o">]</span><span class="s2">&quot;) == 0 { next } { print &quot;</span>so:<span class="s2">&quot; $1 }&#39; \</span>
</span><span class='line'><span class="s2"> )&quot;</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  apk add --virtual .tomcat-native-rundeps <span class="nv">$runDeps</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  apk del .fetch-deps .native-build-deps<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  rm -rf <span class="s2">&quot;$nativeBuildDir&quot;</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  rm bin/tomcat-native.tar.gz<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="se">\</span>
</span><span class='line'><span class="c"># sh removes env vars it doesn&#39;t support (ones with periods)</span>
</span><span class='line'><span class="c"># https://github.com/docker-library/tomcat/issues/77</span>
</span><span class='line'>  apk add --no-cache bash<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  find ./bin/ -name <span class="s1">&#39;*.sh&#39;</span> -exec sed -ri <span class="s1">&#39;s|^#!/bin/sh$|#!/usr/bin/env bash|&#39;</span> <span class="s1">&#39;{}&#39;</span> +
</span><span class='line'>
</span><span class='line'><span class="c"># verify Tomcat Native is working properly</span>
</span><span class='line'>RUN <span class="nb">set</span> -e <span class="se">\</span>
</span><span class='line'>  <span class="o">&amp;&amp;</span> <span class="nv">nativeLines</span><span class="o">=</span><span class="s2">&quot;$(catalina.sh configtest 2&gt;&amp;1)&quot;</span> <span class="se">\</span>
</span><span class='line'>  <span class="o">&amp;&amp;</span> <span class="nv">nativeLines</span><span class="o">=</span><span class="s2">&quot;$(echo &quot;</span><span class="nv">$nativeLines</span><span class="s2">&quot; | grep &#39;Apache Tomcat Native&#39;)&quot;</span> <span class="se">\</span>
</span><span class='line'>  <span class="o">&amp;&amp;</span> <span class="nv">nativeLines</span><span class="o">=</span><span class="s2">&quot;$(echo &quot;</span><span class="nv">$nativeLines</span><span class="s2">&quot; | sort -u)&quot;</span> <span class="se">\</span>
</span><span class='line'>  <span class="o">&amp;&amp;</span> <span class="k">if</span> ! <span class="nb">echo</span> <span class="s2">&quot;$nativeLines&quot;</span> <span class="p">|</span> grep <span class="s1">&#39;INFO: Loaded APR based Apache Tomcat Native library&#39;</span> &gt;<span class="p">&amp;</span>2<span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
</span><span class='line'>      <span class="nb">echo</span> &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="s2">&quot;$nativeLines&quot;</span><span class="p">;</span> <span class="se">\</span>
</span><span class='line'>      <span class="nb">exit </span>1<span class="p">;</span> <span class="se">\</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>EXPOSE 8080
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;catalina.sh&quot;</span>, <span class="s2">&quot;run&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>Building our Image and Pusing to our Registry:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker build -t registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/&lt;image&gt;:&lt;tag&gt;
</span><span class='line'><span class="nv">$ </span>docker push registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/&lt;image&gt;:&lt;tag&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Dockerfile for our Application:</h2>

<p>Now that we have built our image for Tomcat, we can write our <code>Dockerfile</code> for our application, note that the <code>hello.war</code> file also needs to be in the same working directory, unless written otherwise:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'><span class="k">FROM</span> registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/&lt;image&gt;:&lt;tag&gt;
</span><span class='line'>COPY hello.war /usr/local/tomcat/webapps/hello.war
</span></code></pre></td></tr></table></div></figure>


<h2>Setup the Compose file for our Stack:</h2>

<p>We will use docker stack to deploy our application, note that I have <a href="https://sysadmins.co.za/traefik-a-modern-http-reverse-proxy-and-load-balancer-for-microservices-such-as-docker/">Traefik</a> that acts as my reverse proxy.</p>

<p>Below, our <code>app.yml</code> compose file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">hello</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/&lt;image&gt;:&lt;tag&gt;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.port=8080&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.docker.network=appnet&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.frontend.rule=Host:apps.mydomain.com;</span><span class="nv"> </span><span class="s">PathPrefix:</span><span class="nv"> </span><span class="s">/hello/&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">replicated</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">placement</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="s">&#39;node.role==worker&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">appnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy our Application:</h2>

<p>From our compose file we defined that our network is external, so if you are using the same name, and you have not yet setup the overlay network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create --driver overlay appnet
</span></code></pre></td></tr></table></div></figure>


<p>Now deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy --compose-file app.yml apps
</span></code></pre></td></tr></table></div></figure>


<h2>Testing our Application:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://apps.mydomain.com/hello/
</span><span class='line'>
</span><span class='line'>&lt;!DOCTYPE html&gt;
</span><span class='line'>&lt;html&gt;
</span><span class='line'>            Hello World!
</span><span class='line'>   Test Page with Docker + Payara Micro&lt;/h3&gt;
</span><span class='line'>
</span><span class='line'>   Serving From ContainerId: d24f8cd982fc
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Managing Traefik Configuration With Consul on Docker Swarm]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/24/managing-traefik-configuration-with-consul-on-docker-swarm/"/>
    <updated>2017-10-24T03:08:15-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/24/managing-traefik-configuration-with-consul-on-docker-swarm</id>
    <content type="html"><![CDATA[<p>Today we will Setup Consul with Traefik on Docker Swarm</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://docs.traefik.io/user-guide/kv-config/">https://docs.traefik.io/user-guide/kv-config/</a></li>
</ul>


<h2>Create Consul in the Swarm:</h2>

<p>Investigate using Consul with Traefik in Docker Swarm.</p>

<p>I have configured consul with constraints to be placed only on my one manager, as I was bind mounting the data directory to <code>/mnt</code>, as this was for testing on a small docker swarm cluster, but with Docker for AWS, we will use cloudstor with EFS, or GlusterFS, NFS for data persistency across any nodes.</p>

<h2>Create Compose Files:</h2>

<ul>
<li>consul.yml</li>
<li>traefik.yml</li>
<li>apps.yml</li>
</ul>


<p><code>consul.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; consul.yml <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">version: &#39;3.3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s">services:</span>
</span><span class='line'><span class="s">  consul:</span>
</span><span class='line'><span class="s">    image: progrium/consul</span>
</span><span class='line'><span class="s">    command: -server -bootstrap -log-level debug -ui-dir /ui</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'><span class="s">    deploy:</span>
</span><span class='line'><span class="s">      placement:</span>
</span><span class='line'><span class="s">        constraints: [node.role == manager]</span>
</span><span class='line'><span class="s">    volumes:</span>
</span><span class='line'><span class="s">      - type: bind</span>
</span><span class='line'><span class="s">        source: /mnt/consul</span>
</span><span class='line'><span class="s">        target: /data</span>
</span><span class='line'><span class="s">    ports:</span>
</span><span class='line'><span class="s">      - &quot;8400:8400&quot;</span>
</span><span class='line'><span class="s">      - &quot;8500:8500&quot;</span>
</span><span class='line'><span class="s">      - &quot;8600:53/udp&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">networks:</span>
</span><span class='line'><span class="s">  appnet:</span>
</span><span class='line'><span class="s">    external: true</span>
</span><span class='line'>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>traefik.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; traefik.yml <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">version: &#39;3.3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s">services:</span>
</span><span class='line'><span class="s">  traefik:</span>
</span><span class='line'><span class="s">    image: traefik</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'><span class="s">    command: --consul --consul.endpoint=consul:8500</span>
</span><span class='line'><span class="s">    ports:</span>
</span><span class='line'><span class="s">      - &quot;80:80&quot;</span>
</span><span class='line'><span class="s">      - &quot;8080:8080&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">networks:</span>
</span><span class='line'><span class="s">  appnet:</span>
</span><span class='line'><span class="s">    external: true</span>
</span><span class='line'>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>apps.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; apps.yml <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">version: &#39;3.3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s">services:</span>
</span><span class='line'><span class="s">  whoami1:</span>
</span><span class='line'><span class="s">    image: emilevauge/whoami</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'>
</span><span class='line'><span class="s">  whoami2:</span>
</span><span class='line'><span class="s">    image: emilevauge/whoami</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'>
</span><span class='line'><span class="s">  whoami3:</span>
</span><span class='line'><span class="s">    image: emilevauge/whoami</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'>
</span><span class='line'><span class="s">  whoami4:</span>
</span><span class='line'><span class="s">    image: emilevauge/whoami</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'>
</span><span class='line'><span class="s">  whoami5:</span>
</span><span class='line'><span class="s">    image: rbekker87/flask-containername</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'>
</span><span class='line'><span class="s">  whoami6:</span>
</span><span class='line'><span class="s">    image: rbekker87/flask-containername</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'>
</span><span class='line'><span class="s">networks:</span>
</span><span class='line'><span class="s">  appnet:</span>
</span><span class='line'><span class="s">    external: true</span>
</span><span class='line'>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create Overlay Network and Deploy Stacks</h2>

<p>Create the overlay network, and deploy the 3 stacks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create --driver<span class="o">=</span>overlay appnet
</span><span class='line'><span class="nv">$ </span>docker stack deploy --compose-file consul.yml kvstore
</span><span class='line'><span class="nv">$ </span>docker stack deploy --compose-file traefik.yml proxy
</span><span class='line'><span class="nv">$ </span>docker stack deploy --compose-file apps.yml apps
</span></code></pre></td></tr></table></div></figure>


<h2>Populate Configs and Push to Consul KV Store:</h2>

<p>Config for Traefik:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; create_traefik_config.sh <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/loglevel -d &#39;DEBUG&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/defaultentrypoints/0 -d &#39;http&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/entrypoints/http/address -d &#39;:80&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/consul/endpoint -d &#39;consul:8500&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/consul/watch -d &#39;true&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/consul/prefix -d &#39;traefik&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/web/address -d &#39;:8081&#39;</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Config for WhoAmI Web Apps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; create_whoami_config.sh <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s"># backend-1</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend1/circuitbreaker/expression -d &#39;NetworkErrorRatio() &gt; 0.5&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend1/servers/server1/url -d &#39;http://whoami1:80&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend1/servers/server1/weight -d &#39;10&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend1/servers/server2/url -d &#39;http://whoami2:80&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend1/servers/server2/weight -d &#39;1&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend1/servers/server2/tags -d &#39;api,helloworld&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s"># backend-2</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend2/maxconn/amount -d &#39;10&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend2/maxconn/extractorfunc -d &#39;request.host&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend2/loadbalancer/method -d &#39;drr&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend2/servers/server1/url -d &#39;http://whoami3:80&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend2/servers/server1/weight -d &#39;1&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend2/servers/server2/url -d &#39;http://whoami4:80&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend2/servers/server2/weight -d &#39;2&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend2/servers/server2/tags -d &#39;web&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s"># frontend-1</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend1/backend -d &#39;backend2&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend1/routes/test_1/rule -d &#39;Host:test.localhost&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s"># frontend-2</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend2/backend -d &#39;backend1&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend2/passHostHeader -d &#39;true&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend2/priority -d &#39;10&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend2/entrypoints -d &#39;http&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend2/routes/test_2/rule -d &#39;PathPrefix:/test&#39;</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Config for Flask Container Name Web Apps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; create_flask_config.sh <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s"># backends</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/amount -d &#39;5&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/maxconn/extractorfunc -d &#39;request.host&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/loadbalancer/method -d &#39;drr&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/servers/server1/url -d &#39;http://whoami5:5000&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/servers/server1/weight -d &#39;1&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/servers/server1/tags -d &#39;flask&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/servers/server2/url -d &#39;http://whoami6:5000&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/servers/server2/weight -d &#39;2&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/servers/server2/tags -d &#39;flask&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s"># frontend:</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend3/backend -d &#39;backend3&#39;</span>
</span><span class='line'><span class="s">curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend3/routes/test_1/rule -d &#39;Host:flask.localhost&#39;</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Push Configs to Consul:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sh create_traefik_config.sh
</span><span class='line'><span class="nv">$ </span>sh create_whoami_config.sh
</span><span class='line'><span class="nv">$ </span>sh create_flask_config.sh
</span></code></pre></td></tr></table></div></figure>


<h2>Testing Applications:</h2>

<p>Test Frontend with Host Header: test.localhost</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:test.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Hostname: 88c29de3aeb0
</span><span class='line'>IP: 127.0.0.1
</span><span class='line'>IP: 10.0.0.6
</span><span class='line'>IP: 10.0.0.7
</span><span class='line'>IP: 172.18.0.3
</span><span class='line'>GET / HTTP/1.1
</span><span class='line'>Host: test.localhost
</span><span class='line'>User-Agent: curl/7.47.0
</span><span class='line'>Accept: */*
</span><span class='line'>Accept-Encoding: gzip
</span><span class='line'>X-Forwarded-For: 10.255.0.2
</span><span class='line'>X-Forwarded-Host: test.localhost
</span><span class='line'>X-Forwarded-Proto: http
</span><span class='line'>X-Forwarded-Server: 2f827d04fbfb
</span></code></pre></td></tr></table></div></figure>


<p>Test Frontend with PathPrefix: /test</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://127.0.0.1:80/test
</span><span class='line'>Hostname: 14bd4dc0ab00
</span><span class='line'>IP: 127.0.0.1
</span><span class='line'>IP: 10.0.0.12
</span><span class='line'>IP: 10.0.0.13
</span><span class='line'>IP: 172.18.0.4
</span><span class='line'>GET /test HTTP/1.1
</span><span class='line'>Host: 127.0.0.1
</span><span class='line'>User-Agent: curl/7.47.0
</span><span class='line'>Accept: */*
</span><span class='line'>Accept-Encoding: gzip
</span><span class='line'>X-Forwarded-For: 10.255.0.2
</span><span class='line'>X-Forwarded-Host: 127.0.0.1
</span><span class='line'>X-Forwarded-Proto: http
</span><span class='line'>X-Forwarded-Server: 2f827d04fbfb
</span></code></pre></td></tr></table></div></figure>


<p>Test with failure expected:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://127.0.0.1:80
</span><span class='line'><span class="m">404</span> page not found
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:foo.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'><span class="m">404</span> page not found
</span></code></pre></td></tr></table></div></figure>


<p>Change the frontend rule to <code>foo.localhost</code> and test again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPUT http://127.0.0.1:8500/v1/kv/traefik/frontends/frontend1/routes/test_1/rule -d <span class="s1">&#39;Host:foo.localhost&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Testing with <code>foo.localhost</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:foo.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Hostname: 88c29de3aeb0
</span><span class='line'>IP: 127.0.0.1
</span><span class='line'>IP: 10.0.0.6
</span><span class='line'>IP: 10.0.0.7
</span><span class='line'>IP: 172.18.0.3
</span><span class='line'>GET / HTTP/1.1
</span><span class='line'>Host: test.localhost
</span><span class='line'>User-Agent: curl/7.47.0
</span><span class='line'>Accept: */*
</span><span class='line'>Accept-Encoding: gzip
</span><span class='line'>X-Forwarded-For: 10.255.0.2
</span><span class='line'>X-Forwarded-Host: foo.localhost
</span><span class='line'>X-Forwarded-Proto: http
</span><span class='line'>X-Forwarded-Server: 2f827d04fbfb
</span></code></pre></td></tr></table></div></figure>


<p>Test Flask Web Apps, with RoundRobin + Weight:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:flask.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Container Hostname: c94e41420ec7 , UUID: 8d536277-1041-4140-b28a-91630d69ab15
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:flask.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Container Hostname: 786a3b15a32e , UUID: 50bb435f-dac3-4cb0-8ecf-250f13a4d7a5
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:flask.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Container Hostname: c94e41420ec7 , UUID: 680ca88c-8048-4044-a31b-1e922545dc8c
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:flask.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Container Hostname: c94e41420ec7 , UUID: 5506792c-04e5-4517-b58e-fad57b5d1da5
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:flask.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Container Hostname: 786a3b15a32e , UUID: 930056e5-4667-4c2c-976b-246cf891a351
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:flask.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Container Hostname: c94e41420ec7 , UUID: 7c757b50-0e3a-47e2-8636-ae0583802afb
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:flask.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Container Hostname: c94e41420ec7 , UUID: 918bf337-1476-480c-aacb-72fc89392c45
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:flask.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Container Hostname: 786a3b15a32e , UUID: 5c2c6a0e-f2ea-4d5f-a6ce-a7df2ef4886b
</span></code></pre></td></tr></table></div></figure>


<h2>Data Persistent Test:</h2>

<p>List the Stacks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack ls
</span><span class='line'>NAME                SERVICES
</span><span class='line'>apps                6
</span><span class='line'>kvstore             1
</span><span class='line'>proxy               1
</span></code></pre></td></tr></table></div></figure>


<p>Kill the Consul Container to ensure data is persistent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">kill</span> <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>consul -q<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify that the replica has been fulfilled to its desired state:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack ps kvstore
</span><span class='line'>ID                  NAME                   IMAGE                    NODE                DESIRED STATE       CURRENT STATE                ERROR                         PORTS
</span><span class='line'>j80kxxei6lyx        kvstore_consul.1       progrium/consul:latest   ip-10-1-4-51        Running             Running about a minute ago
</span><span class='line'>lsvww0z8g24c         <span class="se">\_</span> kvstore_consul.1   progrium/consul:latest   ip-10-1-4-51        Shutdown            Failed about a minute ago    <span class="s2">&quot;task: non-zero exit (137)&quot;</span>
</span><span class='line'>amkmsfodslwk         <span class="se">\_</span> kvstore_consul.1   progrium/consul:latest   ip-10-1-4-51        Shutdown            Shutdown <span class="m">33</span> minutes ago
</span></code></pre></td></tr></table></div></figure>


<p>Read the Value of the Backend3 URL Key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1:8500/v1/kv/traefik/backends/backend3/servers/server1/url?raw
</span><span class='line'>http://whoami5:5000
</span></code></pre></td></tr></table></div></figure>


<p>`</p>

<p>Test The Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Host:flask.localhost&quot;</span> http://127.0.0.1:80
</span><span class='line'>Container Hostname: 786a3b15a32e , UUID: 4cf985e0-3f47-4320-ac38-42745b00ba1e
</span></code></pre></td></tr></table></div></figure>


<h2>Inspect Services:</h2>

<p>Consul:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service inspect kvstore_consul
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;ID&quot;</span>: <span class="s2">&quot;ppe2c1ld5eyvby6x62fr649z8&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Version&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Index&quot;</span>: 2097
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;CreatedAt&quot;</span>: <span class="s2">&quot;2017-10-03T12:40:27.342669337Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;UpdatedAt&quot;</span>: <span class="s2">&quot;2017-10-03T12:55:22.93080059Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Spec&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;kvstore_consul&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;com.docker.stack.image&quot;</span>: <span class="s2">&quot;progrium/consul&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;com.docker.stack.namespace&quot;</span>: <span class="s2">&quot;kvstore&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;TaskTemplate&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;ContainerSpec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Image&quot;</span>: <span class="s2">&quot;progrium/consul:latest@sha256:8cc8023462905929df9a79ff67ee435a36848ce7a10f18d6d0faba9306b97274&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;com.docker.stack.namespace&quot;</span>: <span class="s2">&quot;kvstore&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;Args&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="s2">&quot;-server&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;-bootstrap&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;-log-level&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;debug&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;-ui-dir&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;/ui&quot;</span>
</span><span class='line'>                    <span class="o">]</span>,
</span><span class='line'>                    <span class="s2">&quot;Privileges&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;CredentialSpec&quot;</span>: null,
</span><span class='line'>                        <span class="s2">&quot;SELinuxContext&quot;</span>: null
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;Mounts&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="o">{</span>
</span><span class='line'>                            <span class="s2">&quot;Type&quot;</span>: <span class="s2">&quot;bind&quot;</span>,
</span><span class='line'>                            <span class="s2">&quot;Source&quot;</span>: <span class="s2">&quot;/mnt/consul&quot;</span>,
</span><span class='line'>                            <span class="s2">&quot;Target&quot;</span>: <span class="s2">&quot;/data&quot;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">]</span>,
</span><span class='line'>                    <span class="s2">&quot;StopGracePeriod&quot;</span>: 10000000000,
</span><span class='line'>                    <span class="s2">&quot;DNSConfig&quot;</span>: <span class="o">{}</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Resources&quot;</span>: <span class="o">{}</span>,
</span><span class='line'>                <span class="s2">&quot;RestartPolicy&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Condition&quot;</span>: <span class="s2">&quot;any&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Delay&quot;</span>: 5000000000,
</span><span class='line'>                    <span class="s2">&quot;MaxAttempts&quot;</span>: 0
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Placement&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Constraints&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="s2">&quot;node.role == manager&quot;</span>
</span><span class='line'>                    <span class="o">]</span>,
</span><span class='line'>                    <span class="s2">&quot;Platforms&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="o">{</span>
</span><span class='line'>                            <span class="s2">&quot;Architecture&quot;</span>: <span class="s2">&quot;amd64&quot;</span>,
</span><span class='line'>                            <span class="s2">&quot;OS&quot;</span>: <span class="s2">&quot;linux&quot;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">]</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Networks&quot;</span>: <span class="o">[</span>
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Target&quot;</span>: <span class="s2">&quot;5q3puzw9pfxa5gokx2mx1kn9j&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;Aliases&quot;</span>: <span class="o">[</span>
</span><span class='line'>                            <span class="s2">&quot;consul&quot;</span>
</span><span class='line'>                        <span class="o">]</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">]</span>,
</span><span class='line'>                <span class="s2">&quot;ForceUpdate&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Runtime&quot;</span>: <span class="s2">&quot;container&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;Mode&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Replicated&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Replicas&quot;</span>: 1
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;UpdateConfig&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Parallelism&quot;</span>: 1,
</span><span class='line'>                <span class="s2">&quot;FailureAction&quot;</span>: <span class="s2">&quot;pause&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Monitor&quot;</span>: 5000000000,
</span><span class='line'>                <span class="s2">&quot;MaxFailureRatio&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Order&quot;</span>: <span class="s2">&quot;stop-first&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;RollbackConfig&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Parallelism&quot;</span>: 1,
</span><span class='line'>                <span class="s2">&quot;FailureAction&quot;</span>: <span class="s2">&quot;pause&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Monitor&quot;</span>: 5000000000,
</span><span class='line'>                <span class="s2">&quot;MaxFailureRatio&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Order&quot;</span>: <span class="s2">&quot;stop-first&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;EndpointSpec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;vip&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Ports&quot;</span>: <span class="o">[</span>
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 8400,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8400,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 8500,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8500,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;udp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 53,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8600,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">]</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;PreviousSpec&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;kvstore_consul&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;com.docker.stack.image&quot;</span>: <span class="s2">&quot;progrium/consul&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;com.docker.stack.namespace&quot;</span>: <span class="s2">&quot;kvstore&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;TaskTemplate&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;ContainerSpec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Image&quot;</span>: <span class="s2">&quot;progrium/consul:latest@sha256:8cc8023462905929df9a79ff67ee435a36848ce7a10f18d6d0faba9306b97274&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;com.docker.stack.namespace&quot;</span>: <span class="s2">&quot;kvstore&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;Args&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="s2">&quot;-server&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;-bootstrap&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;-log-level&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;debug&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;-ui-dir&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;/ui&quot;</span>
</span><span class='line'>                    <span class="o">]</span>,
</span><span class='line'>                    <span class="s2">&quot;Privileges&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;CredentialSpec&quot;</span>: null,
</span><span class='line'>                        <span class="s2">&quot;SELinuxContext&quot;</span>: null
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;Mounts&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="o">{</span>
</span><span class='line'>                            <span class="s2">&quot;Type&quot;</span>: <span class="s2">&quot;bind&quot;</span>,
</span><span class='line'>                            <span class="s2">&quot;Source&quot;</span>: <span class="s2">&quot;/mnt/consul&quot;</span>,
</span><span class='line'>                            <span class="s2">&quot;Target&quot;</span>: <span class="s2">&quot;/data&quot;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">]</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Resources&quot;</span>: <span class="o">{}</span>,
</span><span class='line'>                <span class="s2">&quot;Placement&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Platforms&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="o">{</span>
</span><span class='line'>                            <span class="s2">&quot;Architecture&quot;</span>: <span class="s2">&quot;amd64&quot;</span>,
</span><span class='line'>                            <span class="s2">&quot;OS&quot;</span>: <span class="s2">&quot;linux&quot;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">]</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Networks&quot;</span>: <span class="o">[</span>
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Target&quot;</span>: <span class="s2">&quot;5q3puzw9pfxa5gokx2mx1kn9j&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;Aliases&quot;</span>: <span class="o">[</span>
</span><span class='line'>                            <span class="s2">&quot;consul&quot;</span>
</span><span class='line'>                        <span class="o">]</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">]</span>,
</span><span class='line'>                <span class="s2">&quot;ForceUpdate&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Runtime&quot;</span>: <span class="s2">&quot;container&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;Mode&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Replicated&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Replicas&quot;</span>: 1
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;EndpointSpec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;vip&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Ports&quot;</span>: <span class="o">[</span>
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 8400,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8400,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 8500,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8500,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;udp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 53,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8600,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">]</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;Endpoint&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Spec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;vip&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Ports&quot;</span>: <span class="o">[</span>
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 8400,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8400,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 8500,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8500,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;udp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 53,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8600,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">]</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;Ports&quot;</span>: <span class="o">[</span>
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;TargetPort&quot;</span>: 8400,
</span><span class='line'>                    <span class="s2">&quot;PublishedPort&quot;</span>: 8400,
</span><span class='line'>                    <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;TargetPort&quot;</span>: 8500,
</span><span class='line'>                    <span class="s2">&quot;PublishedPort&quot;</span>: 8500,
</span><span class='line'>                    <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;udp&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;TargetPort&quot;</span>: 53,
</span><span class='line'>                    <span class="s2">&quot;PublishedPort&quot;</span>: 8600,
</span><span class='line'>                    <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">]</span>,
</span><span class='line'>            <span class="s2">&quot;VirtualIPs&quot;</span>: <span class="o">[</span>
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;NetworkID&quot;</span>: <span class="s2">&quot;zz458844j2msbqa6a1g2es8re&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Addr&quot;</span>: <span class="s2">&quot;10.255.0.5/16&quot;</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;NetworkID&quot;</span>: <span class="s2">&quot;5q3puzw9pfxa5gokx2mx1kn9j&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Addr&quot;</span>: <span class="s2">&quot;10.0.0.2/24&quot;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">]</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;UpdateStatus&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;State&quot;</span>: <span class="s2">&quot;completed&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;StartedAt&quot;</span>: <span class="s2">&quot;2017-10-03T12:55:09.724524449Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;CompletedAt&quot;</span>: <span class="s2">&quot;2017-10-03T12:55:22.930760766Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Message&quot;</span>: <span class="s2">&quot;update completed&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Traefik:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service inspect proxy_traefik
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;ID&quot;</span>: <span class="s2">&quot;oqb0lyiprpwby9xkb4n1mn5kl&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Version&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Index&quot;</span>: 2037
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;CreatedAt&quot;</span>: <span class="s2">&quot;2017-10-03T12:40:37.696749025Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;UpdatedAt&quot;</span>: <span class="s2">&quot;2017-10-03T12:40:37.698038856Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Spec&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;proxy_traefik&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;com.docker.stack.image&quot;</span>: <span class="s2">&quot;traefik&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;com.docker.stack.namespace&quot;</span>: <span class="s2">&quot;proxy&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;TaskTemplate&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;ContainerSpec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Image&quot;</span>: <span class="s2">&quot;traefik:latest@sha256:90697fb79a104520f350a3a1db6402584f473301ab6d1a71d264758b65fa232e&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;com.docker.stack.namespace&quot;</span>: <span class="s2">&quot;proxy&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;Args&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="s2">&quot;--consul&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;--consul.endpoint=consul:8500&quot;</span>
</span><span class='line'>                    <span class="o">]</span>,
</span><span class='line'>                    <span class="s2">&quot;Privileges&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;CredentialSpec&quot;</span>: null,
</span><span class='line'>                        <span class="s2">&quot;SELinuxContext&quot;</span>: null
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;StopGracePeriod&quot;</span>: 10000000000,
</span><span class='line'>                    <span class="s2">&quot;DNSConfig&quot;</span>: <span class="o">{}</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Resources&quot;</span>: <span class="o">{}</span>,
</span><span class='line'>                <span class="s2">&quot;RestartPolicy&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Condition&quot;</span>: <span class="s2">&quot;any&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Delay&quot;</span>: 5000000000,
</span><span class='line'>                    <span class="s2">&quot;MaxAttempts&quot;</span>: 0
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Placement&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Platforms&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="o">{</span>
</span><span class='line'>                            <span class="s2">&quot;Architecture&quot;</span>: <span class="s2">&quot;amd64&quot;</span>,
</span><span class='line'>                            <span class="s2">&quot;OS&quot;</span>: <span class="s2">&quot;linux&quot;</span>
</span><span class='line'>                        <span class="o">}</span>,
</span><span class='line'>                        <span class="o">{</span>
</span><span class='line'>                            <span class="s2">&quot;OS&quot;</span>: <span class="s2">&quot;linux&quot;</span>
</span><span class='line'>                        <span class="o">}</span>,
</span><span class='line'>                        <span class="o">{</span>
</span><span class='line'>                            <span class="s2">&quot;Architecture&quot;</span>: <span class="s2">&quot;arm64&quot;</span>,
</span><span class='line'>                            <span class="s2">&quot;OS&quot;</span>: <span class="s2">&quot;linux&quot;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">]</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Networks&quot;</span>: <span class="o">[</span>
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Target&quot;</span>: <span class="s2">&quot;5q3puzw9pfxa5gokx2mx1kn9j&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;Aliases&quot;</span>: <span class="o">[</span>
</span><span class='line'>                            <span class="s2">&quot;traefik&quot;</span>
</span><span class='line'>                        <span class="o">]</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">]</span>,
</span><span class='line'>                <span class="s2">&quot;ForceUpdate&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Runtime&quot;</span>: <span class="s2">&quot;container&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;Mode&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Replicated&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Replicas&quot;</span>: 1
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;UpdateConfig&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Parallelism&quot;</span>: 1,
</span><span class='line'>                <span class="s2">&quot;FailureAction&quot;</span>: <span class="s2">&quot;pause&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Monitor&quot;</span>: 5000000000,
</span><span class='line'>                <span class="s2">&quot;MaxFailureRatio&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Order&quot;</span>: <span class="s2">&quot;stop-first&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;RollbackConfig&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Parallelism&quot;</span>: 1,
</span><span class='line'>                <span class="s2">&quot;FailureAction&quot;</span>: <span class="s2">&quot;pause&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Monitor&quot;</span>: 5000000000,
</span><span class='line'>                <span class="s2">&quot;MaxFailureRatio&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Order&quot;</span>: <span class="s2">&quot;stop-first&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;EndpointSpec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;vip&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Ports&quot;</span>: <span class="o">[</span>
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 80,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 80,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 8080,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8080,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">]</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;Endpoint&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Spec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;vip&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Ports&quot;</span>: <span class="o">[</span>
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 80,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 80,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;TargetPort&quot;</span>: 8080,
</span><span class='line'>                        <span class="s2">&quot;PublishedPort&quot;</span>: 8080,
</span><span class='line'>                        <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">]</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;Ports&quot;</span>: <span class="o">[</span>
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;TargetPort&quot;</span>: 80,
</span><span class='line'>                    <span class="s2">&quot;PublishedPort&quot;</span>: 80,
</span><span class='line'>                    <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Protocol&quot;</span>: <span class="s2">&quot;tcp&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;TargetPort&quot;</span>: 8080,
</span><span class='line'>                    <span class="s2">&quot;PublishedPort&quot;</span>: 8080,
</span><span class='line'>                    <span class="s2">&quot;PublishMode&quot;</span>: <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">]</span>,
</span><span class='line'>            <span class="s2">&quot;VirtualIPs&quot;</span>: <span class="o">[</span>
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;NetworkID&quot;</span>: <span class="s2">&quot;zz458844j2msbqa6a1g2es8re&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Addr&quot;</span>: <span class="s2">&quot;10.255.0.7/16&quot;</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;NetworkID&quot;</span>: <span class="s2">&quot;5q3puzw9pfxa5gokx2mx1kn9j&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Addr&quot;</span>: <span class="s2">&quot;10.0.0.4/24&quot;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">]</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Flask App:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service inspect apps_whoami5
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;ID&quot;</span>: <span class="s2">&quot;hy0443u03j8pygaegdorsrjot&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Version&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Index&quot;</span>: 2052
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;CreatedAt&quot;</span>: <span class="s2">&quot;2017-10-03T12:41:06.582341297Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;UpdatedAt&quot;</span>: <span class="s2">&quot;2017-10-03T12:41:06.583398389Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Spec&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;apps_whoami5&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;com.docker.stack.image&quot;</span>: <span class="s2">&quot;rbekker87/flask-containername&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;com.docker.stack.namespace&quot;</span>: <span class="s2">&quot;apps&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;TaskTemplate&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;ContainerSpec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Image&quot;</span>: <span class="s2">&quot;rbekker87/flask-containername:latest@sha256:fa4dc5905a10130d4309ffbc877155b9f61956980dc51ee2eaa16ac4255bcc2b&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;com.docker.stack.namespace&quot;</span>: <span class="s2">&quot;apps&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;Privileges&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;CredentialSpec&quot;</span>: null,
</span><span class='line'>                        <span class="s2">&quot;SELinuxContext&quot;</span>: null
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;StopGracePeriod&quot;</span>: 10000000000,
</span><span class='line'>                    <span class="s2">&quot;DNSConfig&quot;</span>: <span class="o">{}</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Resources&quot;</span>: <span class="o">{}</span>,
</span><span class='line'>                <span class="s2">&quot;RestartPolicy&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Condition&quot;</span>: <span class="s2">&quot;any&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Delay&quot;</span>: 5000000000,
</span><span class='line'>                    <span class="s2">&quot;MaxAttempts&quot;</span>: 0
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Placement&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Platforms&quot;</span>: <span class="o">[</span>
</span><span class='line'>                        <span class="o">{</span>
</span><span class='line'>                            <span class="s2">&quot;Architecture&quot;</span>: <span class="s2">&quot;amd64&quot;</span>,
</span><span class='line'>                            <span class="s2">&quot;OS&quot;</span>: <span class="s2">&quot;linux&quot;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">]</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;Networks&quot;</span>: <span class="o">[</span>
</span><span class='line'>                    <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;Target&quot;</span>: <span class="s2">&quot;5q3puzw9pfxa5gokx2mx1kn9j&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;Aliases&quot;</span>: <span class="o">[</span>
</span><span class='line'>                            <span class="s2">&quot;whoami5&quot;</span>
</span><span class='line'>                        <span class="o">]</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">]</span>,
</span><span class='line'>                <span class="s2">&quot;ForceUpdate&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Runtime&quot;</span>: <span class="s2">&quot;container&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;Mode&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Replicated&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Replicas&quot;</span>: 1
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;UpdateConfig&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Parallelism&quot;</span>: 1,
</span><span class='line'>                <span class="s2">&quot;FailureAction&quot;</span>: <span class="s2">&quot;pause&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Monitor&quot;</span>: 5000000000,
</span><span class='line'>                <span class="s2">&quot;MaxFailureRatio&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Order&quot;</span>: <span class="s2">&quot;stop-first&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;RollbackConfig&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Parallelism&quot;</span>: 1,
</span><span class='line'>                <span class="s2">&quot;FailureAction&quot;</span>: <span class="s2">&quot;pause&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;Monitor&quot;</span>: 5000000000,
</span><span class='line'>                <span class="s2">&quot;MaxFailureRatio&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;Order&quot;</span>: <span class="s2">&quot;stop-first&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;EndpointSpec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;vip&quot;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;Endpoint&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Spec&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;vip&quot;</span>
</span><span class='line'>            <span class="o">}</span>,
</span><span class='line'>            <span class="s2">&quot;VirtualIPs&quot;</span>: <span class="o">[</span>
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;NetworkID&quot;</span>: <span class="s2">&quot;5q3puzw9pfxa5gokx2mx1kn9j&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Addr&quot;</span>: <span class="s2">&quot;10.0.0.8/24&quot;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">]</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Basic Example With Python to Create a Module That Consists of Classes and Functions]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/22/basic-example-with-python-to-create-a-module-that-consists-of-classes-and-functions/"/>
    <updated>2017-10-22T05:45:17-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/22/basic-example-with-python-to-create-a-module-that-consists-of-classes-and-functions</id>
    <content type="html"><![CDATA[<p>Just a very basic example how to create a Python Module that consists of a Single Class and 2 basic functions.</p>

<p>Our main app will can our module to print out a word, that we pass to our first function.</p>

<h2>The Directory Setup:</h2>

<p>Below is a tree view of my current working directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tree
</span><span class='line'>.
</span><span class='line'>├── providers
</span><span class='line'>│   ├── __init__.py
</span><span class='line'>│   ├── test.py
</span><span class='line'>├── README.md
</span><span class='line'>└── main.py
</span></code></pre></td></tr></table></div></figure>


<p>In order to make a python file a module, we need to have a blank <code>__init__.py</code> file in our directory. So any files under our providers directory will be seen as modules from our <code>main.py</code> file.</p>

<h2>Our Test Module:</h2>

<p>in our <code>providers/test.py</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TestClass</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">word_to_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_value</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">word_value</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">simple_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_to_return</span><span class="p">(</span><span class="s">&#39;its me!&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">data</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then our <code>providers/test.py</code> file will be blank.</p>

<p>Our <code>main.py</code>, we will import our test module, instantiate our class, and call our function within the class that we instantiated:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">providers</span> <span class="kn">import</span> <span class="n">test</span>
</span><span class='line'>
</span><span class='line'><span class="n">test_instance</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">TestClass</span><span class="p">()</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">test_instance</span><span class="o">.</span><span class="n">simple_test</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>instead of <code>response = test_instance.simple_test()</code>, you could also do <code>print(test_instance.simple_test()</code></p>

<h2>Testing it out:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python main.py
</span><span class='line'>its me!
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s very basic but will post some more topics around this in the future.</p>

<p>Also note, this blog is for quick posts that I come accross during my daily doings, for more details tutorials have a look at my main blog: <a href="https://sysadmins.co.za/?referral=blog.ruanbekker.com?category=python">sysadmins.co.za</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python Script to Decrypt Encrypted Data With AWS KMS]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/20/python-script-to-decrypt-encrypted-data-with-aws-kms/"/>
    <updated>2017-10-20T04:54:51-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/20/python-script-to-decrypt-encrypted-data-with-aws-kms</id>
    <content type="html"><![CDATA[<p>Quick script to decrypt data that was encrypted with your KMS key:</p>

<h2>The Script:</h2>

<p>The script requires the encrypted scring as an argument:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
</span><span class='line'>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="n">encrypted_value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'><span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Usage: {} {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;the-encrypted-string&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span>
</span><span class='line'>        <span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">kms</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;kms&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">kms</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">CiphertextBlob</span><span class="o">=</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encrypted_value</span><span class="p">))[</span><span class="s">&#39;Plaintext&#39;</span><span class="p">]</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;Decrypted Value: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Change the permissions so that the file is executable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x decrypt.py
</span></code></pre></td></tr></table></div></figure>


<h2>Usage:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./decrypt.py asdlaskjdasidausd09q3uoijad09ujd38u309
</span><span class='line'>Decrypted Value: thisIsMyDecryptedValue
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup Kerberos Server and Client on Ubuntu]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/18/setup-kerberos-server-and-client-on-ubuntu/"/>
    <updated>2017-10-18T18:25:11-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/18/setup-kerberos-server-and-client-on-ubuntu</id>
    <content type="html"><![CDATA[<p>Kerberos is a authentication protocol that provides a centralized authentication server, that works with the concepts of tickets that are encrypted.</p>

<p>Today we will setup a Kerberos Server (KDC) and setup and Kerberos Enabled Client, and then testing our setup by obtaining a Kerberos Ticket from our server.</p>

<h2>Setup the Server:</h2>

<p>Install Kerberos KDC and Admin Server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install krb5-kdc krb5-admin-server krb5-config -y
</span><span class='line'><span class="nv">$ </span>krb5_newrealm
</span></code></pre></td></tr></table></div></figure>


<p>You will be prompted for realm, and hostnames, in my case I have setup the following:</p>

<ul>
<li>REALM: <code>LAN.RUANBEKER.COM</code></li>
<li>HOST: <code>localhost</code></li>
<li>ADMIN_SERVER: <code>localhost</code></li>
</ul>


<p>Then our master password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>This script should be run on the master KDC/admin server to initialize
</span><span class='line'>a Kerberos realm.  It will ask you to <span class="nb">type </span>in a master key password.
</span><span class='line'>This password will be used to generate a key that is stored in
</span><span class='line'>/etc/krb5kdc/stash.  You should try to remember this password, but it
</span><span class='line'>is much more important that it be a strong password than that it be
</span><span class='line'>remembered.  However, <span class="k">if</span> you lose the password and /etc/krb5kdc/stash,
</span><span class='line'>you cannot decrypt your Kerberos database.
</span><span class='line'>Loading random data
</span><span class='line'>Initializing database <span class="s1">&#39;/var/lib/krb5kdc/principal&#39;</span> <span class="k">for</span> realm <span class="s1">&#39;LAN.RUANBEKKER.COM&#39;</span>,
</span><span class='line'>master key name <span class="s1">&#39;K/M@LAN.RUANBEKKER.COM&#39;</span>
</span><span class='line'>You will be prompted <span class="k">for</span> the database Master Password.
</span><span class='line'>It is important that you NOT FORGET this password.
</span><span class='line'>Enter KDC database master key:
</span><span class='line'>Re-enter KDC database master key to verify:
</span></code></pre></td></tr></table></div></figure>


<p>The output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Now that your realm is <span class="nb">set </span>up you may wish to create an administrative
</span><span class='line'>principal using the addprinc subcommand of the kadmin.local program.
</span><span class='line'>Then, this principal can be added to /etc/krb5kdc/kadm5.acl so that
</span><span class='line'>you can use the kadmin program on other computers.  Kerberos admin
</span><span class='line'>principals usually belong to a single user and end in /admin.  For
</span><span class='line'>example, <span class="k">if</span> jruser is a Kerberos administrator, <span class="k">then</span> in addition to
</span><span class='line'>the normal jruser principal, a jruser/admin principal should be
</span><span class='line'>created.
</span><span class='line'>
</span><span class='line'>Don<span class="err">&#39;</span>t forget to <span class="nb">set </span>up DNS information so your clients can find your
</span><span class='line'>KDC and admin servers.  Doing so is documented in the administration
</span><span class='line'>guide.
</span></code></pre></td></tr></table></div></figure>


<p>Uncomment the last line which contains <code>admin</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi /etc/krb5kdc/kadm5.acl
</span></code></pre></td></tr></table></div></figure>


<p>a Kerberos principal is a unique identity to which Kerberos can assign tickets, lets add our first principal, <code>james</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>kadmin.local
</span><span class='line'>Authenticating as principal root/admin@LAN.RUANBEKKER.COM with password.
</span><span class='line'>kadmin.local:  addprinc james
</span><span class='line'>
</span><span class='line'>WARNING: no policy specified <span class="k">for</span> james@LAN.RUANBEKKER.COM<span class="p">;</span> defaulting to no policy
</span><span class='line'>Enter password <span class="k">for</span> principal <span class="s2">&quot;james@LAN.RUANBEKKER.COM&quot;</span>:
</span><span class='line'>Re-enter password <span class="k">for</span> principal <span class="s2">&quot;james@LAN.RUANBEKKER.COM&quot;</span>:
</span><span class='line'>Principal <span class="s2">&quot;james@LAN.RUANBEKKER.COM&quot;</span> created.
</span><span class='line'>kadmin.local:  <span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setup the Client:</h2>

<p>Setup a Host Entry:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;10.1.1.1 kdc.lan.ruanbekker.com kdc&#39;</span> &gt;&gt; /etc/hosts
</span></code></pre></td></tr></table></div></figure>


<p>Setup Kerberos Client:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install krb5-user -y
</span><span class='line'>- realm
</span><span class='line'>- hostname
</span><span class='line'>- hostname
</span></code></pre></td></tr></table></div></figure>


<p>Obtain a Ticket from the Server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>kinit -p james
</span><span class='line'>Password <span class="k">for</span> james@LAN.RUANBEKKER.COM:
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>klist
</span><span class='line'>Ticket cache: FILE:/tmp/krb5cc_0
</span><span class='line'>Default principal: james@LAN.RUANBEKKER.COM
</span><span class='line'>
</span><span class='line'>Valid starting     Expires            Service principal
</span><span class='line'>10/18/17 22:13:34  10/19/17 08:13:34  krbtgt/LAN.RUANBEKKER.COM@LAN.RUANBEKKER.COM
</span><span class='line'>  renew <span class="k">until</span> 10/19/17 22:13:30
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="http://csetutorials.com/setup-kerberos-ubuntu.html">http://csetutorials.com/setup-kerberos-ubuntu.html</a></li>
<li><a href="https://www.rootusers.com/how-to-configure-linux-to-authenticate-using-kerberos/">https://www.rootusers.com/how-to-configure-linux-to-authenticate-using-kerberos/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Python to Build a Dictionary From Data Eg Sports Per Person]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/14/using-python-to-build-a-dictionary-from-data-eg-sports-per-person/"/>
    <updated>2017-10-14T14:53:48-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/14/using-python-to-build-a-dictionary-from-data-eg-sports-per-person</id>
    <content type="html"><![CDATA[<p>I had to achieve a way to provide data in key-value format, where I wanted to see what sports people like, eg: <code>{"ruan": ["rugby", "cricket"]}</code></p>

<h2>The Idea</h2>

<p>So my idea was to have the <code>name</code> as the key, and the <code>sports</code> as the value in a list.</p>

<h2>Some Catches</h2>

<p>So for this post, I will be setting the data statically in the code, while at the time I was working data that was returned via a API.</p>

<p>I am looping through each occurence, adding the name, and when the name exists, I append the sport to the list of the person.</p>

<p>The catch was that, if there was any duplicated data, the person will only exists once in the dictionary that I am building, but the sport will be appended, so if there were 2 occurences of <code>rugby</code> it will show the sport 2 times. So I had to put some logic into the code to handle that.</p>

<h2>The Code</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="sd">&quot;&quot;&quot;|Info:</span>
</span><span class='line'>
</span><span class='line'><span class="sd">Printing Sports per Person, by looping through data, appending the sports to a list per person, which gets added to our dictionary.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">Variables:</span>
</span><span class='line'><span class="sd"> group {dict} -- &quot;the dictionary that we are building up&quot;</span>
</span><span class='line'><span class="sd"> people {list} -- &quot;list of people with their sport choices&quot;</span>
</span><span class='line'><span class="sd"> for sportman in people: {[for-loop]} -- &quot;iterating through our data, if the sport exists, continue, if not, apeend it to the list&quot;</span>
</span><span class='line'><span class="sd"> print(group) {[dict]} -- &quot;printing the results&quot;</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">group</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'><span class="n">people</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;ruan&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;sport&quot;</span><span class="p">:</span> <span class="s">&quot;cricket&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;stefan&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;sport&quot;</span><span class="p">:</span> <span class="s">&quot;rugby&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;stefan&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;sport&quot;</span><span class="p">:</span> <span class="s">&quot;cricket&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;james&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;sport&quot;</span><span class="p">:</span> <span class="s">&quot;rugby&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;james&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;sport&quot;</span><span class="p">:</span> <span class="s">&quot;golf&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;stefan&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;sport&quot;</span><span class="p">:</span> <span class="s">&quot;rugby&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;james&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;sport&quot;</span><span class="p">:</span> <span class="s">&quot;hockey&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">sportman</span> <span class="ow">in</span> <span class="n">people</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">sportman</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">sportman</span><span class="p">[</span><span class="s">&#39;sport&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">[</span><span class="n">sportman</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]:</span>
</span><span class='line'>            <span class="n">group</span><span class="p">[</span><span class="n">sportman</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sportman</span><span class="p">[</span><span class="s">&#39;sport&#39;</span><span class="p">])</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="k">pass</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">group</span><span class="p">[</span><span class="n">sportman</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="n">group</span><span class="p">[</span><span class="n">sportman</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sportman</span><span class="p">[</span><span class="s">&#39;sport&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Running the Script:</h2>

<p>When running the script results in the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python sports.py
</span><span class='line'><span class="o">{</span><span class="s1">&#39;james&#39;</span>: <span class="o">[</span><span class="s1">&#39;rugby&#39;</span>, <span class="s1">&#39;golf&#39;</span>, <span class="s1">&#39;hockey&#39;</span><span class="o">]</span>, <span class="s1">&#39;ruan&#39;</span>: <span class="o">[</span><span class="s1">&#39;cricket&#39;</span><span class="o">]</span>, <span class="s1">&#39;stefan&#39;</span>: <span class="o">[</span><span class="s1">&#39;rugby&#39;</span>, <span class="s1">&#39;cricket&#39;</span><span class="o">]}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Customize Ubuntu 16 Desktop With Arc Dark Theme]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/11/customize-ubuntu-16-desktop-with-arc-dark-theme/"/>
    <updated>2017-10-11T15:56:10-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/11/customize-ubuntu-16-desktop-with-arc-dark-theme</id>
    <content type="html"><![CDATA[<p><img src="https://i.snag.gy/g1ryLn.jpg" alt="" /></p>

<p>So I was running ApricityOS for quite some time, which is a Arch Distibution. But a couple of hours before PyConZa I was trying to do a update and found that their repositories were reporting 404 errors, and turns out they have stopped their project :( . I quite liked ApricityOS, as it&rsquo;s what you will expect when installing Arch with the basic applications and the numix icon/theme pack.</p>

<p>So I decided to use Ubuntu for a change.</p>

<h2>Customizations:</h2>

<p>For the Operating System, I am Ubuntu 16:</p>

<ul>
<li><a href="https://www.ubuntu.com/download/desktop">Ubuntu 16.04 (Operating System)</a></li>
</ul>


<p>For my theme I am using Arc Dark:</p>

<ul>
<li><a href="https://github.com/horst3180/arc-theme">Arch Teme</a> - <a href="https://askubuntu.com/questions/265471/autoreconf-not-found-error-during-making-qemu-1-4-0/490839">autoconf dependency required</a></li>
</ul>


<p><img src="https://i.snag.gy/u5fP4w.jpg" alt="" /></p>

<p>Moka Icon pack for my Icons:</p>

<ul>
<li><a href="https://snwh.org/moka/download">Moka Icon Themes</a></li>
</ul>


<p><img src="https://i.snag.gy/3JPi9W.jpg?nocache=1507753731895" alt="" /></p>

<p>Terminator for my terminal of choice:</p>

<ul>
<li><a href="http://www.linuxandubuntu.com/home/10-best-linux-terminals-for-ubuntu-and-fedora">Terminator Terminal</a></li>
</ul>


<p><img src="https://i.snag.gy/xqgXMc.jpg" alt="" /></p>

<p>And my config:</p>

<figure class='code'><figcaption><span>~/.config/terminator/config </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>global_config<span class="o">]</span>
</span><span class='line'>  <span class="nv">enabled_plugins</span> <span class="o">=</span> LaunchpadCodeURLHandler, APTURLHandler, LaunchpadBugURLHandler
</span><span class='line'>  <span class="nv">sticky</span> <span class="o">=</span> True
</span><span class='line'>  <span class="nv">window_state</span> <span class="o">=</span> maximise
</span><span class='line'><span class="o">[</span>keybindings<span class="o">]</span>
</span><span class='line'><span class="o">[</span>layouts<span class="o">]</span>
</span><span class='line'>  <span class="o">[[</span>default<span class="o">]]</span>
</span><span class='line'>    <span class="o">[[[</span>child1<span class="o">]]]</span>
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> window0
</span><span class='line'>      <span class="nv">profile</span> <span class="o">=</span> default
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Terminal
</span><span class='line'>    <span class="o">[[[</span>window0<span class="o">]]]</span>
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Window
</span><span class='line'>  <span class="o">[[</span>multi<span class="o">]]</span>
</span><span class='line'>    <span class="nv">foreground_color</span> <span class="o">=</span> <span class="s2">&quot;#ffffff&quot;</span>
</span><span class='line'>    <span class="nv">palette</span> <span class="o">=</span> <span class="s2">&quot;#62b9d6:#cc0000:#4e9a06:#c4a000:#3465a4:#75507b:#06989a:#d3d7cf:#77c529:#ef2929:#8ae234:#fce94f:#729fcf:#ad7fa8:#34e2e2:#eeeeec&quot;</span>
</span><span class='line'>    <span class="o">[[[</span>child0<span class="o">]]]</span>
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 0
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>      <span class="nv">position</span> <span class="o">=</span> 0:25
</span><span class='line'>      <span class="nv">size</span> <span class="o">=</span> 1366, 768
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Window
</span><span class='line'>    <span class="o">[[[</span>child1<span class="o">]]]</span>
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 0
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child0
</span><span class='line'>      <span class="nv">position</span> <span class="o">=</span> 632
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> HPaned
</span><span class='line'>    <span class="o">[[[</span>child2<span class="o">]]]</span>
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 0
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child1
</span><span class='line'>      <span class="nv">position</span> <span class="o">=</span> 354
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> VPaned
</span><span class='line'>    <span class="o">[[[</span>child5<span class="o">]]]</span>
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 1
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child1
</span><span class='line'>      <span class="nv">position</span> <span class="o">=</span> 354
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> VPaned
</span><span class='line'>    <span class="o">[[[</span>terminal3<span class="o">]]]</span>
</span><span class='line'>      <span class="nb">command</span> <span class="o">=</span> top<span class="p">;</span> bash
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 0
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child2
</span><span class='line'>      <span class="nv">profile</span> <span class="o">=</span> default
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Terminal
</span><span class='line'>    <span class="o">[[[</span>terminal4<span class="o">]]]</span>
</span><span class='line'>      <span class="nb">command</span> <span class="o">=</span> uptime<span class="p">;</span> bash
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 1
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child2
</span><span class='line'>      <span class="nv">profile</span> <span class="o">=</span> default
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Terminal
</span><span class='line'>    <span class="o">[[[</span>terminal6<span class="o">]]]</span>
</span><span class='line'>      <span class="nb">command</span> <span class="o">=</span> <span class="nb">cd</span> ~/workspace<span class="p">;</span> bash
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 0
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child5
</span><span class='line'>      <span class="nv">profile</span> <span class="o">=</span> default
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Terminal
</span><span class='line'>    <span class="o">[[[</span>terminal7<span class="o">]]]</span>
</span><span class='line'>      <span class="nb">command</span> <span class="o">=</span> <span class="nb">cd</span> ~/workspace<span class="p">;</span> bash
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 1
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child5
</span><span class='line'>      <span class="nv">profile</span> <span class="o">=</span> default
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Terminal
</span><span class='line'>  <span class="o">[[</span>simples<span class="o">]]</span>
</span><span class='line'>    <span class="o">[[[</span>child0<span class="o">]]]</span>
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 0
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>      <span class="nv">position</span> <span class="o">=</span> 0:25
</span><span class='line'>      <span class="nv">size</span> <span class="o">=</span> 715, 694
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Window
</span><span class='line'>    <span class="o">[[[</span>child1<span class="o">]]]</span>
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 0
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child0
</span><span class='line'>      <span class="nv">position</span> <span class="o">=</span> 348
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> VPaned
</span><span class='line'>    <span class="o">[[[</span>terminal2<span class="o">]]]</span>
</span><span class='line'>      <span class="nb">command</span> <span class="o">=</span> <span class="nb">cd</span> ~/workspace<span class="p">;</span> bash
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 0
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child1
</span><span class='line'>      <span class="nv">profile</span> <span class="o">=</span> default
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Terminal
</span><span class='line'>    <span class="o">[[[</span>terminal3<span class="o">]]]</span>
</span><span class='line'>      <span class="nb">command</span> <span class="o">=</span> <span class="nb">cd</span> ~/workspace<span class="p">;</span> bash
</span><span class='line'>      <span class="nv">order</span> <span class="o">=</span> 1
</span><span class='line'>      <span class="nv">parent</span> <span class="o">=</span> child1
</span><span class='line'>      <span class="nv">profile</span> <span class="o">=</span> default
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> Terminal
</span><span class='line'><span class="o">[</span>plugins<span class="o">]</span>
</span><span class='line'><span class="o">[</span>profiles<span class="o">]</span>
</span><span class='line'>  <span class="o">[[</span>default<span class="o">]]</span>
</span><span class='line'>    <span class="nv">background_image</span> <span class="o">=</span> None
</span><span class='line'>    <span class="nv">icon_bell</span> <span class="o">=</span> False
</span><span class='line'>    <span class="nv">scrollback_infinite</span> <span class="o">=</span> True
</span></code></pre></td></tr></table></div></figure>


<p>And to force color prompts:</p>

<figure class='code'><figcaption><span>~/.bashrc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">force_color_prompt</span><span class="o">=</span>yes
</span></code></pre></td></tr></table></div></figure>


<p>And my Wallpaper:</p>

<ul>
<li><a href="https://www.pixelstalk.net/wp-content/uploads/2016/03/Black-lamborghini-wallpaper-HD.jpg">Lamborghini Wallpaper</a></li>
</ul>


<h2>Other Preferred Applications:</h2>

<ul>
<li><a href="https://www.docker.com/docker-ubuntu">Docker</a> &lt;&ndash; Of course! :D</li>
<li><a href="https://linuxcontainers.org/lxd/getting-started-cli/">LXD</a></li>
<li><a href="https://www.dropbox.com/">Cloud Storage: Dropbox</a></li>
<li><a href="https://www.sublimetext.com/">Text Editor: Sublime Text</a></li>
<li><a href="https://boostnote.io/">Note Taking: Boostnote</a></li>
<li><a href="https://www.nylas.com/nylas-mail/">Mail Client: Nylas</a> and <a href="https://wiki.gnome.org/Apps/Geary">Geary</a></li>
<li><a href="https://www.jetbrains.com/pycharm/">Python IDE: PyCharm</a> (however, I prefer to use VIM :D )</li>
<li><p><a href="https://netbeans.org/">Java IDE: Netbeans</a></p></li>
<li><p>Sysadmin Tools: (htop, netstat, tcpdump, nmap, vnstat, mysql-client, mongo-client, curl, nload, etc)</p></li>
</ul>


<p>I will update this page as I&rsquo;m getting new apps or modifications</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Display PHP Content Through HTML Files]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/11/display-php-content-through-html-files/"/>
    <updated>2017-10-11T02:43:55-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/11/display-php-content-through-html-files</id>
    <content type="html"><![CDATA[<p>While I was working with a root index page which is in <code>HTML</code> that had <code>PHP</code> content in, it did not render all of the <code>PHP</code> and some content was displayed as text, instead of rendered.</p>

<h2>The Issue:</h2>

<p>Some <code>PHP</code> content not rendered, as I am seeing this at the top of the page as plain text:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="p">;</span> <span class="nx">somePhpFunction</span><span class="p">();</span> <span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>My Nginx Config:</h2>

<figure class='code'><figcaption><span>nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>http <span class="o">{</span>
</span><span class='line'>    include                     /etc/nginx/mime.types<span class="p">;</span>
</span><span class='line'>    default_type                application/octet-stream<span class="p">;</span>
</span><span class='line'>    sendfile                    on<span class="p">;</span>
</span><span class='line'>    access_log                  /var/log/nginx/access.log<span class="p">;</span>
</span><span class='line'>    keepalive_timeout           3000<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_cache_path /var/cache/nginx/ <span class="nv">levels</span><span class="o">=</span>1:2 <span class="nv">keys_zone</span><span class="o">=</span>nginx_cache:10m <span class="nv">max_size</span><span class="o">=</span>16m <span class="nv">inactive</span><span class="o">=</span>60m<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    server <span class="o">{</span>
</span><span class='line'>        listen                  80<span class="p">;</span>
</span><span class='line'>        root                    /www<span class="p">;</span>
</span><span class='line'>        index                   index.php index.html index.htm<span class="p">;</span>
</span><span class='line'>        server_name             _<span class="p">;</span>
</span><span class='line'>        client_max_body_size    32m<span class="p">;</span>
</span><span class='line'>        error_page              <span class="m">500</span> <span class="m">502</span> <span class="m">503</span> <span class="m">504</span>  /50x.html<span class="p">;</span>
</span><span class='line'>        proxy_cache       nginx_cache<span class="p">;</span>
</span><span class='line'>        add_header        X-Proxy-Cache <span class="s2">&quot;public&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">location</span> <span class="o">=</span> /50x.html <span class="o">{</span>
</span><span class='line'>              root              /var/lib/nginx/html<span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        location ~ <span class="se">\.</span>php<span class="nv">$ </span><span class="o">{</span>
</span><span class='line'>              fastcgi_pass      127.0.0.1:9000<span class="p">;</span>
</span><span class='line'>              fastcgi_index     index.php<span class="p">;</span>
</span><span class='line'>              include           fastcgi.conf<span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The Fix:</h2>

<p>a <code>.htaccess</code> had to be placed in my root directory of the website:</p>

<figure class='code'><figcaption><span>.htaccess</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>AddType application/x-httpd-php .html .htm
</span></code></pre></td></tr></table></div></figure>


<p>After that was in place, all of the <code>PHP</code> was rendered</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sending Mail With SSMTP on Alpine Linux]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/09/sending-mail-with-ssmtp-on-alpine-linux/"/>
    <updated>2017-10-09T16:36:35-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/09/sending-mail-with-ssmtp-on-alpine-linux</id>
    <content type="html"><![CDATA[<p>Quick Post on how to use ssmtp on Alpine Linux to Send Mail:</p>

<h2>Update and Install SSMTP</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apk update
</span><span class='line'><span class="nv">$ </span>apk add ssmtp
</span></code></pre></td></tr></table></div></figure>


<h2>Configure SSMTP</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; /etc/ssmtp/ssmtp.conf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">root=postmaster</span>
</span><span class='line'><span class="s">mailhub=mail.domain.com:25</span>
</span><span class='line'><span class="s">hostname=`hostname`</span>
</span><span class='line'><span class="s">FromLineOverride=YES</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Mail Content</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; mail.txt <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">To: recipient@domain.com</span>
</span><span class='line'><span class="s">From: sender@domain.com</span>
</span><span class='line'><span class="s">Subject: Mail with SSMTP</span>
</span><span class='line'>
</span><span class='line'><span class="s">Hello, this is a test mail.</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing Mail Delivery</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssmtp recipient@domain.com &lt; file.txt
</span></code></pre></td></tr></table></div></figure>


<h2>Related:</h2>

<ul>
<li><a href="https://support.cloud.engineyard.com/hc/en-us/articles/205407478-Set-Up-SSMTP-for-Mail-Relay-to-AuthSMTP">Using Gmail as a Relay Host</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Backup and Restore Mutliple Collections From a Database With MongoDB]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/03/backup-and-restore-mutliple-collections-from-a-database-with-mongodb/"/>
    <updated>2017-10-03T16:42:34-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/03/backup-and-restore-mutliple-collections-from-a-database-with-mongodb</id>
    <content type="html"><![CDATA[<p>From a previous post we&rsquo;ve  <a href="http://blog.ruanbekker.com/blog/2017/09/02/setup-a-3-node-mongodb-replica-set-on-ubuntu-16/">Setup a MongoDB Cluster</a>, and in this post we will go through the steps of backing up a database and restoring it to another mongodb cluster.</p>

<p><a href="http://mlab.com/">MLab</a> offers a free Shared MongoDB Hosted Service with a limitation of 500MB, which I will be using to restore my data from my own hosted cluster to the free MLab service.</p>

<h2>Create the MongoDB Backup</h2>

<p>First we will need to create our backup path, and then backup our database, in my case, I am backing up my <code>rocketchat</code> database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /opt/backups/mongodb
</span><span class='line'><span class="nv">$ </span>mongodump --host mongodb.example.com --port <span class="m">27017</span> -u &lt;mongouser&gt; --authenticationDatabase &lt;authdb&gt; --db rocketchat --out /opt/backups/mongodb/
</span></code></pre></td></tr></table></div></figure>


<p>Change into the backup directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /opt/backups/mongodb/rocketchat/
</span></code></pre></td></tr></table></div></figure>


<p>You will find the <code>bson</code> and <code>json metadata</code> files for each collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls -l <span class="p">|</span> awk <span class="s1">&#39;{print $9}&#39;</span> <span class="p">|</span> head -9
</span><span class='line'>custom_emoji.chunks.bson
</span><span class='line'>custom_emoji.chunks.metadata.json
</span><span class='line'>custom_emoji.files.bson
</span><span class='line'>custom_emoji.files.metadata.json
</span><span class='line'>instances.bson
</span><span class='line'>instances.metadata.json
</span><span class='line'>meteor_accounts_loginServiceConfiguration.bson
</span><span class='line'>meteor_accounts_loginServiceConfiguration.metadata.json
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h2>Restore MongoDB Database</h2>

<p>We will need to restore all the collections to our new mongodb service, I have created a bash script (<code>restore-mongodb.sh</code>) that will restore each collection to our <code>rocketchat</code> database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="nv">mongo_user</span><span class="o">=</span>&lt;mongouser&gt;
</span><span class='line'><span class="nv">mongo_pass</span><span class="o">=</span>&lt;mongopass&gt;
</span><span class='line'>
</span><span class='line'><span class="k">for</span> file in <span class="sb">`</span>ls <span class="p">|</span> grep bson<span class="sb">`</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>    <span class="k">for</span> collection in <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$file</span> <span class="p">|</span> sed <span class="s1">&#39;s/.bson//g&#39;</span><span class="sb">`</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>    mongorestore --host mymongoid.mlab.com --port <span class="m">12345</span> -u <span class="nv">$mongo_user</span> -p <span class="nv">$mongo_pass</span> -d rocketchat -c <span class="nv">$collection</span> <span class="nv">$file</span>
</span><span class='line'>    sleep 2
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>Change the permissions of your script to make it executable and execute the script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x restore-mongodb.sh
</span><span class='line'><span class="nv">$ </span>./restore-mongodb.sh
</span><span class='line'>
</span><span class='line'>2017-10-03T22:05:39.138+0200    checking <span class="k">for</span> collection data in custom_emoji.chunks.bson
</span><span class='line'>2017-10-03T22:05:39.159+0200    reading metadata <span class="k">for</span> rocketchat.custom_emoji.chunks from custom_emoji.chunks.metadata.json
</span><span class='line'>2017-10-03T22:05:39.211+0200    restoring rocketchat.custom_emoji.chunks from custom_emoji.chunks.bson
</span><span class='line'>2017-10-03T22:05:39.900+0200    restoring indexes <span class="k">for</span> collection rocketchat.custom_emoji.chunks from metadata
</span><span class='line'>2017-10-03T22:05:39.922+0200    finished restoring rocketchat.custom_emoji.chunks <span class="o">(</span><span class="m">20</span> documents<span class="o">)</span>
</span><span class='line'>2017-10-03T22:05:39.922+0200    <span class="k">done</span>
</span><span class='line'>2017-10-03T22:05:42.188+0200    checking <span class="k">for</span> collection data in custom_emoji.files.bson
</span><span class='line'>2017-10-03T22:05:42.231+0200    reading metadata <span class="k">for</span> rocketchat.custom_emoji.files from custom_emoji.files.metadata.json
</span><span class='line'>2017-10-03T22:05:42.252+0200    restoring rocketchat.custom_emoji.files from custom_emoji.files.bson
</span><span class='line'>2017-10-03T22:05:42.623+0200    restoring indexes <span class="k">for</span> collection rocketchat.custom_emoji.files from metadata
</span><span class='line'>2017-10-03T22:05:42.645+0200    finished restoring rocketchat.custom_emoji.files <span class="o">(</span><span class="m">20</span> documents<span class="o">)</span>
</span><span class='line'>2017-10-03T22:05:42.645+0200    <span class="k">done</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h2>Checkout the New MongoDB Database:</h2>

<p>Once the restore has been done, logon to your new mongodb database and have a look at the collections in the database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mongo mymongoid.mlab.com:12345/rocketchat -u &lt;mongouser&gt; -p
</span><span class='line'>MongoDB shell version v3.4.7
</span><span class='line'>Enter password:
</span><span class='line'>connecting to: mongodb://mymongoid.mlab.com:12345/rocketchat
</span><span class='line'>MongoDB server version: 3.4.9
</span><span class='line'>
</span><span class='line'>rs-mymongoid:PRIMARY&gt; show collections
</span><span class='line'>_raix_push_app_tokens
</span><span class='line'>_raix_push_notifications
</span><span class='line'>custom_emoji.chunks
</span><span class='line'>custom_emoji.files
</span><span class='line'>instances
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://docs.mongodb.com/manual/reference/program/mongodump/">https://docs.mongodb.com/manual/reference/program/mongodump/</a></li>
<li><a href="https://docs.mongodb.com/manual/reference/program/mongorestore/">https://docs.mongodb.com/manual/reference/program/mongorestore/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Creating a Nodejs Hostname App With Docker Stacks on Swarm]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/24/creating-a-nodejs-hostname-app-with-docker-stacks-on-swarm/"/>
    <updated>2017-09-24T17:52:51-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/24/creating-a-nodejs-hostname-app-with-docker-stacks-on-swarm</id>
    <content type="html"><![CDATA[<p>Create a Nodejs Application that responds GET requests with its Hostname.</p>

<p>Our nodejs application will sit beind a HAProxy Load Balancer, we are mounting the <code>docker.sock</code> from the host to the container, so as we scale our web application, our load balancer is aware of the changes, and scales as we scale our web application.</p>

<h2>Creating the Application:</h2>

<p>Our nodejs application:</p>

<figure class='code'><figcaption><span>app.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">os</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/html&#39;</span><span class="p">});</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="err">`</span><span class="nx">My</span> <span class="nx">Hostname</span><span class="o">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">os</span><span class="p">.</span><span class="nx">hostname</span><span class="p">()}</span><span class="err">\</span><span class="nx">n</span><span class="err">`</span><span class="p">);</span>
</span><span class='line'><span class="p">}).</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our Dockerfile:</p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'><span class="k">FROM</span> node:alpine
</span><span class='line'><span class="k">ADD</span> app.js /app.js
</span><span class='line'><span class="k">CMD</span> <span class="o">[</span><span class="s2">&quot;node&quot;</span>, <span class="s2">&quot;/app.js&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Build and Push to your registry, or you could use my image on Dockerhub: <a href="https://hub.docker.com/r/rbekker87/node-containername/">hub.docker.com/r/rbekker87/node-containername</a></p>

<figure class='code'><figcaption><span>Build and Push</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker login
</span><span class='line'><span class="nv">$ </span>docker build -t &lt;username&gt;/&lt;repo&gt;:&lt;tag&gt; .
</span><span class='line'><span class="nv">$ </span>docker push  &lt;username&gt;/&lt;repo&gt;:&lt;tag&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the Compose file</h2>

<p>Create the compose file that will define our services:</p>

<figure class='code'><figcaption><span>docker-compose.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>version: <span class="s1">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  node-app:
</span><span class='line'>    image: rbekker87/node-containername
</span><span class='line'>    networks:
</span><span class='line'>      - nodenet
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">SERVICE_PORTS</span><span class="o">=</span>8080
</span><span class='line'>    deploy:
</span><span class='line'>      replicas: 20
</span><span class='line'>      update_config:
</span><span class='line'>        parallelism: 5
</span><span class='line'>        delay: 10s
</span><span class='line'>      restart_policy:
</span><span class='line'>        condition: on-failure
</span><span class='line'>        max_attempts: 3
</span><span class='line'>        window: 120s
</span><span class='line'>
</span><span class='line'>  loadbalancer:
</span><span class='line'>    image: dockercloud/haproxy:latest
</span><span class='line'>    depends_on:
</span><span class='line'>      - node-app
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">BALANCE</span><span class="o">=</span>leastconn
</span><span class='line'>    volumes:
</span><span class='line'>      - /var/run/docker.sock:/var/run/docker.sock
</span><span class='line'>    ports:
</span><span class='line'>      - 80:80
</span><span class='line'>    networks:
</span><span class='line'>      - nodenet
</span><span class='line'>    deploy:
</span><span class='line'>      placement:
</span><span class='line'>        constraints: <span class="o">[</span>node.role <span class="o">==</span> manager<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  nodenet:
</span><span class='line'>    driver: overlay
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Stack:</h2>

<p>Deploy the Stack by specifying the compose file and name of our stack:</p>

<figure class='code'><figcaption><span>Deploy our Stack</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml node
</span></code></pre></td></tr></table></div></figure>


<p>List the Services in the Stack:</p>

<figure class='code'><figcaption><span>List Services in our Stack</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack ls
</span><span class='line'>NAME                SERVICES
</span><span class='line'>node                2
</span></code></pre></td></tr></table></div></figure>


<p>List the Tasks in the Stack:</p>

<figure class='code'><figcaption><span>Tasks in our Stack</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack ps node
</span><span class='line'>ID                  NAME                  IMAGE                                 NODE     DESIRED STATE       CURRENT STATE            ERROR               PORTS
</span><span class='line'>l5ryfaedzzaq        node_loadbalancer.1   dockercloud/haproxy:latest            dsm-01   Running             Running <span class="m">40</span> minutes ago
</span><span class='line'>c8nrrcvek79h        node_node-app.5       rbekker87/node-containername:latest   dsm-01   Running             Running <span class="m">40</span> minutes ago
</span><span class='line'>dqii18b2q5nn        node_node-app.10      rbekker87/node-containername:latest   dsm-01   Running             Running <span class="m">40</span> minutes ago
</span><span class='line'>vkpw2rugy0ah        node_node-app.11      rbekker87/node-containername:latest   dsm-01   Running             Running <span class="m">40</span> minutes ago
</span><span class='line'>mm88nvnvy5lg        node_node-app.12      rbekker87/node-containername:latest   dsm-01   Running             Running <span class="m">40</span> minutes ago
</span><span class='line'>oyx8rfqc1xl2        node_node-app.16      rbekker87/node-containername:latest   dsm-01   Running             Running <span class="m">41</span> minutes ago
</span></code></pre></td></tr></table></div></figure>


<h2>Test out our Application</h2>

<p>Test out the Service:</p>

<figure class='code'><figcaption><span>GET Requests</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1/
</span><span class='line'>My Hostname: a6e34246e73b
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1/
</span><span class='line'>My Hostname: 5de71278be38
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1/
</span><span class='line'>My Hostname: e0b7316fdd51
</span></code></pre></td></tr></table></div></figure>


<h2>Scaling Out:</h2>

<p>Scale our Application out to 30 replica&rsquo;s</p>

<figure class='code'><figcaption><span>Scaling Up</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service scale node-app<span class="o">=</span>30
</span></code></pre></td></tr></table></div></figure>


<p>Scale our Application down to 10 replica&rsquo;s</p>

<figure class='code'><figcaption><span>Scaling Down</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service scale node-app<span class="o">=</span>10
</span></code></pre></td></tr></table></div></figure>


<h2>Cleanup</h2>

<p>Remove the Stack:</p>

<figure class='code'><figcaption><span>Delete the Stack</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack rm node
</span><span class='line'>Removing service node_loadbalancer
</span><span class='line'>Removing service node_node-app
</span><span class='line'>Removing network node_nodenet
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://github.com/ruanbekker/docker-node-containername">https://github.com/ruanbekker/docker-node-containername</a></li>
<li><a href="https://hub.docker.com/r/rbekker87/node-containername/">https://hub.docker.com/r/rbekker87/node-containername/</a></li>
<li><a href="https://medium.com/@nirgn/load-balancing-applications-with-haproxy-and-docker-d719b7c5b231">Resource 1</a> + <a href="http://anokun7.github.io/microservices-demo/">Resource 2</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Create a 3 Node Elasticsearch Stack With HAProxy on Docker Swarm]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/24/create-a-3-node-elasticsearch-stack-with-haproxy-on-docker-swarm/"/>
    <updated>2017-09-24T15:40:19-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/24/create-a-3-node-elasticsearch-stack-with-haproxy-on-docker-swarm</id>
    <content type="html"><![CDATA[<p>Tried out creating a 3 node elasticsearch stack on docker swarm using docker-compose, that sits behind a haproxy service.</p>

<h2>Environment:</h2>

<p>Images:</p>

<ul>
<li><a href="https://hub.docker.com/r/dockercloud/haproxy/">dockercloud/haproxy</a></li>
<li><a href="https://github.com/ruanbekker/docker-elasticsearch">rbekker87/elasticsearch:master-5.6-alpine</a></li>
</ul>


<p>Stack:</p>

<ul>
<li>1 x haproxy</li>
<li>1 x elasticsearch master (haproxy wont send requests to this one)</li>
<li>2 x elasticsearch master/data</li>
<li>1 x esnet overlay network</li>
</ul>


<h2>Defining our Stack</h2>

<p>First we will create our compose file, which we will call <code>es-compose.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">es-master</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbekker87/elasticsearch:master-5.6-alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">esnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">es-data-1</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbekker87/elasticsearch:master-5.6-alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">SERVICE_PORTS=9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">esnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">es-data-2</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbekker87/elasticsearch:master-5.6-alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">SERVICE_PORTS=9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">esnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">loadbalancer</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dockercloud/haproxy:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">es-data-1</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">es-data-2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">BALANCE=leastconn</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">9200:80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">esnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">placement</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">node.role == manager</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">esnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">overlay</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above compose file defines that we want a overlay network, which we will associate with all our services, 3 elasticsearch services, haproxy service which will expose port 9200, then from haproxy it has a container port of 80, which sends to the backend <code>SERVICE_PORTS</code> of each elasticsearch service.</p>

<p>We have only defined <code>SERVICE_PORTS=9200</code> on our es-data services, as I just want to proxy client connections to them.</p>

<h2>Creating our Elasticsearch Stack</h2>

<p>Now that we have our compose file ready, let&rsquo;s create our stack using <code>docker stack deploy</code>:</p>

<figure class='code'><figcaption><span>Create the Stack</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c es-compose.yml analytics
</span><span class='line'>
</span><span class='line'>Creating network analytics_esnet
</span><span class='line'>Creating service analytics_loadbalancer
</span><span class='line'>Creating service analytics_es-master
</span><span class='line'>Creating service analytics_es-data-1
</span><span class='line'>Creating service analytics_es-data-2
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s have a look at our stack:</p>

<figure class='code'><figcaption><span>Docker Stack Status </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack ps analytics
</span><span class='line'>ID                  NAME                       IMAGE                                       NODE                  DESIRED STATE       CURRENT STATE            ERROR               PORTS
</span><span class='line'>4t3ukxl2kch3        analytics_loadbalancer.1   dockercloud/haproxy:latest                  scw-swarm-master-01   Running             Running <span class="m">27</span> seconds ago
</span><span class='line'>jgbxtgqkg9jp        analytics_es-data-2.1      rbekker87/elasticsearch:master-5.6-alpine   scw-swarm-master-01   Running             Running <span class="m">33</span> seconds ago
</span><span class='line'>x5cq6pm7u7mn        analytics_es-data-1.1      rbekker87/elasticsearch:master-5.6-alpine   scw-swarm-master-01   Running             Running <span class="m">36</span> seconds ago
</span><span class='line'>5v22w1hvtdvm        analytics_es-master.1      rbekker87/elasticsearch:master-5.6-alpine   scw-swarm-master-01   Running             Running <span class="m">38</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>View the logs of our haproxy service:</p>

<figure class='code'><figcaption><span>HAProxy Service Logs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service logs -f analytics_loadbalancer
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:dockercloud/haproxy 1.6.7 is running outside Docker Cloud
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:Haproxy is running in SwarmMode, loading HAProxy definition through docker api
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:dockercloud/haproxy PID: 7
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:<span class="o">=</span>&gt; Add task: Initial start - Swarm Mode
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:<span class="o">=</span>&gt; Executing task: Initial start - Swarm Mode
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:<span class="o">==========</span><span class="nv">BEGIN</span><span class="o">==========</span>
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:Linked service: analytics_es-data-1, analytics_es-data-2, analytics_es-master
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:Linked container: analytics_es-data-1.1.u641c5bq5vkjklk8sb1scnnlc, analytics_es-data-2.1.ic9an6bzj6aejs0lx0vzfpia6, analytics_es-master.1.h4erlgwzit509p0zehzmozy3u
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:HAProxy configuration:
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> global
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   log 127.0.0.1 local0
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   log 127.0.0.1 local1 notice
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   log-send-hostname
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   maxconn 4096
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   pidfile /var/run/haproxy.pid
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   user haproxy
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   group haproxy
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   daemon
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   stats socket /var/run/haproxy.stats level admin
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   ssl-default-bind-options no-sslv3
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   ssl-default-bind-ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:AES128-GCM-SHA256:AES128-SHA256:AES128-SHA:AES256-GCM-SHA384:AES256-SHA256:AES256-SHA:DHE-DSS-AES128-SHA:DES-CBC3-SHA
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> defaults
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   balance leastconn
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   log global
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   mode http
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   option redispatch
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   option httplog
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   option dontlognull
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   option forwardfor
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   timeout connect 5000
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   timeout client 50000
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   timeout server 50000
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> listen stats
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   <span class="nb">bind</span> :1936
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   mode http
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   stats <span class="nb">enable</span>
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   timeout connect 10s
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   timeout client 1m
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   timeout server 1m
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   stats hide-version
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   stats realm Haproxy<span class="se">\ </span>Statistics
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   stats uri /
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   stats auth stats:stats
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> frontend default_port_80
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   <span class="nb">bind</span> :80
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   reqadd X-Forwarded-Proto:<span class="se">\ </span>http
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   maxconn 4096
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   default_backend default_service
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> backend default_service
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   server analytics_es-data-1.1.u641c5bq5vkjklk8sb1scnnlc 10.0.7.5:9200 check inter <span class="m">2000</span> rise <span class="m">2</span> fall 3
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span>   server analytics_es-data-2.1.ic9an6bzj6aejs0lx0vzfpia6 10.0.7.7:9200 check inter <span class="m">2000</span> rise <span class="m">2</span> fall 3
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:Launching HAProxy
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:HAProxy has been launched<span class="o">(</span>PID: 10<span class="o">)</span>
</span><span class='line'>analytics_loadbalancer.1.lcpgiz0ooeas@scw-swarm-master-01    <span class="p">|</span> INFO:haproxy:<span class="o">===========</span><span class="nv">END</span><span class="o">===========</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing Elasticsearch:</h2>

<p>Do a GET request on our HAProxy&rsquo;s Expose port: 9200</p>

<figure class='code'><figcaption><span>Test Elasticsearch on port 9200</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1:9200
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;5306a0c2ee24&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;cluster_name&quot;</span> : <span class="s2">&quot;es-cluster&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;cluster_uuid&quot;</span> : <span class="s2">&quot;FUJmMekFQVq6zXofPCin2A&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;version&quot;</span> : <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;number&quot;</span> : <span class="s2">&quot;5.6.0&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;build_hash&quot;</span> : <span class="s2">&quot;781a835&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;build_date&quot;</span> : <span class="s2">&quot;2017-09-07T03:09:58.087Z&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;build_snapshot&quot;</span> : <span class="nb">false</span>,
</span><span class='line'>    <span class="s2">&quot;lucene_version&quot;</span> : <span class="s2">&quot;6.6.0&quot;</span>
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="s2">&quot;tagline&quot;</span> : <span class="s2">&quot;You Know, for Search&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Have a look at the <code>/_cat/nodes</code> API:</p>

<figure class='code'><figcaption><span>Get the Node Info</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span> curl -XGET http://127.0.0.1:9200/_cat/nodes?v
</span><span class='line'>ip       heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>10.0.7.6           <span class="m">28</span>          <span class="m">84</span>  <span class="m">14</span>    3.09    2.28     1.49 mdi       -      56c1b0aebc5f
</span><span class='line'>10.0.7.2           <span class="m">27</span>          <span class="m">84</span>  <span class="m">15</span>    3.09    2.28     1.49 mdi       *      572c68bca904
</span><span class='line'>10.0.7.4           <span class="m">29</span>          <span class="m">84</span>  <span class="m">15</span>    3.09    2.28     1.49 mdi       -      5306a0c2ee24
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Simple Program With C Language on Linux]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/24/simple-program-with-c-language-on-linux/"/>
    <updated>2017-09-24T06:41:58-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/24/simple-program-with-c-language-on-linux</id>
    <content type="html"><![CDATA[<p>Today the idea popped up on how to write a Simple &ldquo;Hello World&rdquo; Application using C Programming Language, as I just wanted to see how it works.</p>

<h2>Requirements:</h2>

<p>You will need the <code>gcc</code> package to compile the program:</p>

<figure class='code'><figcaption><span>RHEL</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>yum install gcc -y
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Debian</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install gcc -y
</span></code></pre></td></tr></table></div></figure>


<h2>Writing our first Program:</h2>

<p>We will create a app that just prints out a static defined value:</p>

<p>Create any file with a <code>.c</code> extension, in my case it will be <code>app.c</code>:</p>

<figure class='code'><figcaption><span>app.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello, World</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now compile <code>app.c</code> with <code>gcc</code> and specify the output path of your app with <code>-o &lt;app-name&gt;</code></p>

<figure class='code'><figcaption><span>app.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="n">gcc</span> <span class="o">-</span><span class="n">o</span> <span class="n">app</span> <span class="n">app</span><span class="p">.</span><span class="n">c</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing our App:</h2>

<p>You will see that there is a executable file with the name that you have specified as the output:</p>

<figure class='code'><figcaption><span>app.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">app</span>
</span><span class='line'><span class="n">Hello</span><span class="p">,</span> <span class="n">World</span>
</span></code></pre></td></tr></table></div></figure>


<p>Really basic, but quite cool.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using the AWS CLI Tools to Grab CloudWatch Metrics for Elasticsearch]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/22/using-the-aws-cli-tools-to-grab-cloudwatch-metrics-for-elasticsearch/"/>
    <updated>2017-09-22T18:06:23-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/22/using-the-aws-cli-tools-to-grab-cloudwatch-metrics-for-elasticsearch</id>
    <content type="html"><![CDATA[<p>Using the AWS CLI Tools to get CloudWatch Metrics for Elasticsearch.</p>

<h2>Elasticsearch:</h2>

<p>List the JVM Memory Pressure Metric:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws cloudwatch list-metrics --namespace AWS/ES --metric-name JVMMemoryPressure
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;Metrics&quot;</span>: <span class="o">[</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Namespace&quot;</span>: <span class="s2">&quot;AWS/ES&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Dimensions&quot;</span>: <span class="o">[</span>
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;DomainName&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Value&quot;</span>: <span class="s2">&quot;elasticsearch-cluster&quot;</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;ClientId&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;Value&quot;</span>: <span class="s2">&quot;123456789012&quot;</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">]</span>,
</span><span class='line'>            <span class="s2">&quot;MetricName&quot;</span>: <span class="s2">&quot;JVMMemoryPressure&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Metric: JVMMemoryPressure</h2>

<p>Getting Metrics for JVMMemoryPressure, every 10 Minutes for Max Statistic:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws cloudwatch get-metric-statistics --namespace AWS/ES --dimensions <span class="nv">Name</span><span class="o">=</span>DomainName,Value<span class="o">=</span>elasticsearch-cluster <span class="nv">Name</span><span class="o">=</span>ClientId,Value<span class="o">=</span><span class="m">123456789012</span> --metric-name JVMMemoryPressure --start-time 2017-09-08T04:00:00 --end-time 2017-09-08T05:00:00 --period <span class="m">600</span> --statistics Maximum
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;Datapoints&quot;</span>: <span class="o">[</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:40:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 58.7,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Percent&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:00:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 58.5,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Percent&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:30:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 58.7,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Percent&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:20:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 58.5,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Percent&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:50:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 58.7,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Percent&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:10:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 58.5,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Percent&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>,
</span><span class='line'>    <span class="s2">&quot;Label&quot;</span>: <span class="s2">&quot;JVMMemoryPressure&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Metric: WriteIOPS</h2>

<p>Getting Metrics for WriteIOPS, Every 10 Minutes for Max Statistic:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws cloudwatch get-metric-statistics --namespace AWS/ES --dimensions <span class="nv">Name</span><span class="o">=</span>DomainName,Value<span class="o">=</span>elasticsearch-cluster <span class="nv">Name</span><span class="o">=</span>ClientId,Value<span class="o">=</span><span class="m">123456789012</span> --metric-name WriteIOPS --start-time 2017-09-08T04:00:00 --end-time 2017-09-08T05:00:00 --period <span class="m">600</span> --statistics Maximum
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;Datapoints&quot;</span>: <span class="o">[</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:30:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 0.5266666666666666,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Count/Second&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:00:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 0.0,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Count/Second&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:40:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 0.09666666666666666,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Count/Second&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:10:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 0.0,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Count/Second&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:50:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 0.07,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Count/Second&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-08T04:20:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Maximum&quot;</span>: 0.0,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Count/Second&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>,
</span><span class='line'>    <span class="s2">&quot;Label&quot;</span>: <span class="s2">&quot;WriteIOPS&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Metric: FreeStorageSpace</h2>

<p>Getting Metrics for FreeStorageSpace in Megabytes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws cloudwatch get-metric-statistics --namespace AWS/ES --dimensions <span class="nv">Name</span><span class="o">=</span>DomainName,Value<span class="o">=</span>elasticsearch-cluster <span class="nv">Name</span><span class="o">=</span>ClientId,Value<span class="o">=</span><span class="m">123456789012</span> --metric-name FreeStorageSpace --start-time 2017-09-11T05:00:00 --end-time 2017-09-11T06:00:00 --period <span class="m">600</span> --statistics Minimum --unit Megabytes
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;Datapoints&quot;</span>: <span class="o">[</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-11T05:50:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Minimum&quot;</span>: 25510.438,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Megabytes&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-11T05:10:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Minimum&quot;</span>: 25573.032,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Megabytes&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-11T05:20:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Minimum&quot;</span>: 25554.051,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Megabytes&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-11T05:30:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Minimum&quot;</span>: 25540.957,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Megabytes&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-11T05:40:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Minimum&quot;</span>: 25525.473,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Megabytes&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Timestamp&quot;</span>: <span class="s2">&quot;2017-09-11T05:00:00Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Minimum&quot;</span>: 25584.383,
</span><span class='line'>            <span class="s2">&quot;Unit&quot;</span>: <span class="s2">&quot;Megabytes&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>,
</span><span class='line'>    <span class="s2">&quot;Label&quot;</span>: <span class="s2">&quot;FreeStorageSpace&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using the Python Sys Library to Read Data From Stdin]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/18/using-the-python-sys-library-to-read-data-from-stdin/"/>
    <updated>2017-09-18T11:42:01-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/18/using-the-python-sys-library-to-read-data-from-stdin</id>
    <content type="html"><![CDATA[<p>Using Python&rsquo;s <code>sys</code> library to read data from <code>stdin</code>.</p>

<p>In this basic example we will strip our input, delimited by the comma character, add it to a list, and print it out</p>

<h2>Python: Read Data from Standard Input</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'>
</span><span class='line'><span class="n">mylist</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'><span class="n">data_input</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'><span class="n">destroy_newline</span> <span class="o">=</span> <span class="n">data_input</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">mylist</span> <span class="o">=</span> <span class="n">destroy_newline</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;Stripping each word and adding it to &#39;mylist&#39;&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;Found: {} words in &#39;mylist&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)))</span>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mylist</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Word: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will echo three words and pipe it into our python script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;one, two, three&quot;</span> <span class="p">|</span> python basic-stdin.py
</span><span class='line'>Stripping each word and adding it to <span class="s1">&#39;mylist&#39;</span>
</span><span class='line'>Found: <span class="m">3</span> words in <span class="s1">&#39;mylist&#39;</span>
</span><span class='line'>Word: one
</span><span class='line'>Word: two
</span><span class='line'>Word: three
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a Postfix Relay Server That Uses SES to Relay Outbound Mail]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/16/setup-a-postfix-relay-server-that-uses-ses-to-relay-outbound-mail/"/>
    <updated>2017-09-16T18:01:49-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/16/setup-a-postfix-relay-server-that-uses-ses-to-relay-outbound-mail</id>
    <content type="html"><![CDATA[<p>We will setup a Postfix Relay Servcer which our clients will use to send out mail, the Postfix server will use Amazon&rsquo;s SES Service to send out mail, which we will configure as a relay host in Postfix.</p>

<h2>Setup EC2 Instance to Relay through AWS SES:</h2>

<p>Install Postfix and SASL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install postfix mailutils libsasl2-2 sasl2-bin libsasl2-modules -y
</span></code></pre></td></tr></table></div></figure>


<p>Section we need to configure in <code>/etc/nginx/main.cf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">relayhost</span> <span class="o">=</span> <span class="o">[</span>email-smtp.eu-west-1.amazonaws.com<span class="o">]</span>:587
</span><span class='line'><span class="nv">smtp_use_tls</span> <span class="o">=</span> yes
</span><span class='line'><span class="nv">smtp_sasl_auth_enable</span> <span class="o">=</span> yes
</span><span class='line'><span class="nv">smtp_sasl_security_options</span> <span class="o">=</span>
</span><span class='line'><span class="nv">smtp_sasl_password_maps</span> <span class="o">=</span> <span class="nb">hash</span>:/etc/postfix/sasl_passwd
</span><span class='line'><span class="nv">smtp_tls_CAfile</span> <span class="o">=</span> /etc/ssl/certs/ca-certificates.crt
</span></code></pre></td></tr></table></div></figure>


<p>Populate SASL Passwd:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/postfix/sasl_passwd
</span><span class='line'><span class="o">[</span>email-smtp.eu-west-1.amazonaws.com<span class="o">]</span>:587    AKIAABCDEFGHIJKLM:SomeRandomSecretString
</span></code></pre></td></tr></table></div></figure>


<p>Postmap the changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>postmap /etc/postfix/sasl_passwd
</span></code></pre></td></tr></table></div></figure>


<p>Restart Postfix:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo /etc/init.d/postfix restart
</span></code></pre></td></tr></table></div></figure>


<p>Test the Mail Flow:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo test</span> <span class="p">|</span> mail -r ruan@ruanbekker.com -s <span class="s1">&#39;ses test mail &#39;</span> ruan@ruanbekker.com <span class="o">&amp;&amp;</span> tail -f /var/log/mail.log
</span><span class='line'>
</span><span class='line'>Jul <span class="m">18</span> 11:29:06 ip-10-1-4-250 postfix/smtp<span class="o">[</span>5056<span class="o">]</span>: 9FDCB469AA: <span class="nv">to</span><span class="o">=</span>&lt;ruan@ruanbekker.com&gt;, <span class="nv">relay</span><span class="o">=</span>email-smtp.eu-west-1.amazonaws.com<span class="o">[</span>52.10.20.30<span class="o">]</span>:587, <span class="nv">delay</span><span class="o">=</span>0.29, <span class="nv">delays</span><span class="o">=</span>0.02/0.03/0.12/0.13, <span class="nv">dsn</span><span class="o">=</span>2.0.0, <span class="nv">status</span><span class="o">=</span>sent <span class="o">(</span><span class="m">250</span> Ok 0234567d557572f2-76f56252-0a00-4d94-af87-38bd213914d2-000000<span class="o">)</span>
</span><span class='line'>Jul <span class="m">18</span> 11:29:06 ip-10-1-4-250 postfix/qmgr<span class="o">[</span>4392<span class="o">]</span>: 9FDCB469AA: removed
</span></code></pre></td></tr></table></div></figure>


<p>If your output looks more or less like the snippet from above, your mail should be working fine.</p>

<center>
<script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Buy Me a Coffee', '#46b798', 'A6423ZIQ');kofiwidget2.draw();</script> 
</center>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Nginx Reverse Proxy for Elasticsearch and Kibana 5 on AWS]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/16/nginx-reverse-proxy-for-elasticsearch-and-kibana-5-on-aws/"/>
    <updated>2017-09-16T17:24:32-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/16/nginx-reverse-proxy-for-elasticsearch-and-kibana-5-on-aws</id>
    <content type="html"><![CDATA[<p>As up untill today, there&rsquo;s currently no VPC Support for Amazon&rsquo;s Elasticsearch Service.</p>

<p>So for scenarios where you would like to allow private network traffic to Elasticsearch is impossible straight out of the box as Amazon&rsquo;s Elasticsearch Services, only sees Public Internet Traffic.</p>

<p>We will setup 2 configs, one for Kibana and one for Elasticsearch, each one having its own FQDN:</p>

<ul>
<li>Kibana: <code>http://kibana.domain.com</code></li>
<li>Elasticsearch: <code>http://elasticsearch.domain.com</code></li>
</ul>


<h2>Workaround:</h2>

<p>There&rsquo;s a couple of workarounds, which includes:</p>

<ul>
<li>Nginx Reverse Proxy</li>
<li>NAT Gateway</li>
<li>Allow IAM Users/Roles</li>
</ul>


<p>Today we will tackle the Nginx Reverse Proxy Route.</p>

<p>The benefit of this, would be to associate an EIP to the Nginx EC2 Instnace, then whitelist your EIP with Elasticsearch, so the only traffic that will be accepted will be the traffic that is coming from the Nginx Instance. We will also apply an additional layer of security, in this case we will use HTTP Basic Authentication, then also authorize network sources on a Security Group level.</p>

<h2>Installing Nginx:</h2>

<p>In this case I am using Ubuntu 16.04, so we will need to install <code>nginx</code> and <code>apache2-utils</code> for creating the Basic HTTP Auth accounts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install nginx apache2-utils -y
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Nginx:</h2>

<p>Our main config: <code>/etc/nginx/nginx.conf</code>:</p>

<figure class='code'><figcaption><span>/etc/nginx/nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>user www-data<span class="p">;</span>
</span><span class='line'>worker_processes auto<span class="p">;</span>
</span><span class='line'>pid /run/nginx.pid<span class="p">;</span>
</span><span class='line'>error_log /var/log/nginx/error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>  worker_connections 1024<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Basic Settings</span>
</span><span class='line'>  sendfile on<span class="p">;</span>
</span><span class='line'>  tcp_nopush on<span class="p">;</span>
</span><span class='line'>  tcp_nodelay on<span class="p">;</span>
</span><span class='line'>  keepalive_timeout 65<span class="p">;</span>
</span><span class='line'>  types_hash_max_size 2048<span class="p">;</span>
</span><span class='line'>  server_names_hash_bucket_size 128<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  include /etc/nginx/mime.types<span class="p">;</span>
</span><span class='line'>  default_type application/octet-stream<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Logging Settings</span>
</span><span class='line'>        log_format  main  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  access_log /var/log/nginx/access.log main<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Gzip Settings</span>
</span><span class='line'>  gzip on<span class="p">;</span>
</span><span class='line'>  gzip_disable <span class="s2">&quot;msie6&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Elasticsearch and Kibana Configs</span>
</span><span class='line'>  include /etc/nginx/conf.d/elasticsearch.conf<span class="p">;</span>
</span><span class='line'>  include /etc/nginx/conf.d/kibana.conf<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>/etc/nginx/conf.d/elasticsearch.conf</code> configuration:</p>

<figure class='code'><figcaption><span>/etc/nginx/conf.d/elasticsearch.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  listen 80<span class="p">;</span>
</span><span class='line'>  server_name elasticsearch.domain.com<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># error logging</span>
</span><span class='line'>  error_log /var/log/nginx/elasticsearch_error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># authentication: elasticsearch</span>
</span><span class='line'>  auth_basic <span class="s2">&quot;Elasticsearch Auth&quot;</span><span class="p">;</span>
</span><span class='line'>  auth_basic_user_file /etc/nginx/.secrets_elasticsearch<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  location / <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Host https://search-elasticsearch-name.eu-west-1.es.amazonaws.com<span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP &lt;ELASTIC-IP&gt;<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Authorization <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass https://search-elasticsearch-name.eu-west-1.es.amazonaws.com/<span class="p">;</span>
</span><span class='line'>    proxy_redirect https://search-elasticsearch-name.eu-west-1.es.amazonaws.com/ http://&lt;ELASTIC-IP&gt;/<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># ELB Health Checks</span>
</span><span class='line'>  location /status <span class="o">{</span>
</span><span class='line'>    root /usr/share/nginx/html/<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>/etc/nginx/conf.d/kibana.conf</code> configuration:</p>

<figure class='code'><figcaption><span>/etc/nginx/conf.d/kibana.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  listen 80<span class="p">;</span>
</span><span class='line'>  server_name kibana.domain.com<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># error logging</span>
</span><span class='line'>  error_log /var/log/nginx/kibana_error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># authentication: kibana</span>
</span><span class='line'>  auth_basic <span class="s2">&quot;Kibana Auth&quot;</span><span class="p">;</span>
</span><span class='line'>  auth_basic_user_file /etc/nginx/.secrets_kibana<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  location / <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Host https://search.elasticsearch-name.eu-west-1.es.amazonaws.com<span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP &lt;ELASTIC-IP&gt;<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Authorization <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass https://search.elasticsearch-name.eu-west-1.es.amazonaws.com/_plugin/kibana/<span class="p">;</span>
</span><span class='line'>    proxy_redirect https://search.elasticsearch-name.eu-west-1.es.amazonaws.com/_plugin/kibana/ http://&lt;ELASTIC-IP&gt;/kibana/<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      location ~ <span class="o">(</span>/app/kibana<span class="p">|</span>/app/timelion<span class="p">|</span>/bundles<span class="p">|</span>/es_admin<span class="p">|</span>/plugins<span class="p">|</span>/api<span class="p">|</span>/ui<span class="p">|</span>/elasticsearch<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         proxy_pass              https://search.elasticsearch-name.eu-west-1.es.amazonaws.com<span class="p">;</span>
</span><span class='line'>         proxy_set_header        Host <span class="nv">$host</span><span class="p">;</span>
</span><span class='line'>         proxy_set_header        X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>         proxy_set_header        X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>         proxy_set_header        X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>         proxy_set_header        X-Forwarded-Host <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>         proxy_set_header      Authorization  <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you have replaced the elasticsearch endpoint and your EPI values, we can go ahead and create the auth accounts.</p>

<h2>Create User Accounts for HTTP Basic Auth</h2>

<p>Create the 2 accounts for authentication on kibana and elasticsearch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>htpasswd -c /etc/nginx/.secrets_elasticsearch elasticsearch-admin
</span><span class='line'><span class="nv">$ </span>htpasswd -c /etc/nginx/.secrets_kibana kibana-admin
</span></code></pre></td></tr></table></div></figure>


<h2>Restart Nginx:</h2>

<p>Restart and enable Nginx on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>nginx
</span><span class='line'><span class="nv">$ </span>systemctl restart nginx
</span></code></pre></td></tr></table></div></figure>


<p>Once your Nginx Service is running, you should be able to access Kibana and Elasticsearch using the credentials that you created.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://www.nginx.com/blog/tcp-load-balancing-udp-load-balancing-nginx-tips-tricks/">https://www.nginx.com/blog/tcp-load-balancing-udp-load-balancing-nginx-tips-tricks/</a></li>
<li><a href="https://www.elastic.co/blog/playing-http-tricks-nginx">https://www.elastic.co/blog/playing-http-tricks-nginx</a></li>
<li><a href="https://sysadmins.co.za/aws-access-kibana-5-behind-elb-via-nginx-reverse-proxy-on-custom-dns/">https://sysadmins.co.za/aws-access-kibana-5-behind-elb-via-nginx-reverse-proxy-on-custom-dns/</a></li>
</ul>


<center>
<script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Buy Me a Coffee', '#46b798', 'A6423ZIQ');kofiwidget2.draw();</script> 
</center>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AWS: IAM S3 Policy for Cyberduck to Allow Listing Buckets and Access to One Bucket]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/15/aws-iam-s3-policy-for-cyberduck-to-allow-listing-buckets-and-access-to-one-bucket/"/>
    <updated>2017-09-15T11:18:17-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/15/aws-iam-s3-policy-for-cyberduck-to-allow-listing-buckets-and-access-to-one-bucket</id>
    <content type="html"><![CDATA[<p>When using Cyberduck to access S3, and a account has restrictive policies, you may find error <code>Listing Directory: /</code> failed.</p>

<p>If you have restrictive IAM Policies in your account, this may be due to the fact that <code>S3:ListMyBuckets</code> is not allowed.</p>

<p>In this post we want to allow a user to list all buckets, so that Cyberduck can do the initial list after configuration / launch, and we would like to give the user access to their designated bucket.</p>

<h2>Creating the IAM Policy:</h2>

<p>We will create this IAM Policy and associate the policy to the user&rsquo;s account:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;Stmt1480515305000&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;s3:ListAllMyBuckets&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;s3:GetBucketLocation&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;arn:aws:s3:::*&quot;</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;Stmt1480515305002&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;s3:List*&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;s3:PutObject&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;s3:DeleteObject&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;arn:aws:s3:::allowed-bucket&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;arn:aws:s3:::allowed-bucket/*&quot;</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So here we should be able to list the buckets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile cyberduck s3 ls /
</span><span class='line'>2017-06-08 08:27:01 allowed-bucket
</span><span class='line'>2017-05-21 13:39:21 private-bucket
</span><span class='line'>2016-12-21 08:23:45 confidential-bucket
</span><span class='line'>2017-08-10 14:18:19 <span class="nb">test</span>-bucket
</span><span class='line'>2016-08-03 12:38:29 datalake-bucket
</span></code></pre></td></tr></table></div></figure>


<p>Able to list inside the bucket, as well as Get, Put etc.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile cyberduck s3 ls allowed-bucket/
</span><span class='line'>                           PRE data/
</span></code></pre></td></tr></table></div></figure>


<p>Unable to list the buckets content which is expected, as we did not mention in the policy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile cyberduck s3 ls confidential-bucket/
</span><span class='line'>
</span><span class='line'>An error occurred <span class="o">(</span>AccessDenied<span class="o">)</span> when calling the ListObjects operation: Access Denied
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://aws.amazon.com/blogs/security/writing-iam-policies-how-to-grant-access-to-an-amazon-s3-bucket/">https://aws.amazon.com/blogs/security/writing-iam-policies-how-to-grant-access-to-an-amazon-s3-bucket/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Python for Image Analysis With Amazons Rekognition Service]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/11/using-python-for-image-analysis-with-amazons-rekognition-service/"/>
    <updated>2017-09-11T10:20:28-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/11/using-python-for-image-analysis-with-amazons-rekognition-service</id>
    <content type="html"><![CDATA[<p>Amazon&rsquo;s Rekognition Service, which falls under their Artificial Intelligence tier, makes it easy to add image analysis to your applications.</p>

<p>Today we will use Rekognition to analyze an image, to determine the percentage of detection that the service analyzes. We will be using the Python SDK to do this.</p>

<h2>Getting a Random Image:</h2>

<p>So, I got this drunk guy on the couch, which I thought we could use to analyze.</p>

<p>Image Used:
- <a href="http://imgur.com/a/CHnSu">http://imgur.com/a/CHnSu</a></p>

<blockquote class="imgur-embed-pub" lang="en" data-id="a/CHnSu"><a href="//imgur.com/CHnSu"></a></blockquote>


<script async src="//s.imgur.com/min/embed.js" charset="utf-8"></script>


<h2>Our Python Code:</h2>

<p>Our code will use boto3 to use rekognition from Amazon Web Services, detects the image, and prints out the values.</p>

<p>Note that I am not specifying any credentials, as my credentials is configured in my local credential provider, where boto will pick it up from.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'>
</span><span class='line'><span class="n">BUCKET</span> <span class="o">=</span> <span class="s">&quot;rekognition-bucket&quot;</span>
</span><span class='line'><span class="n">KEY</span> <span class="o">=</span> <span class="s">&quot;images/image-02.jpg&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">detect_labels</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">max_labels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_confidence</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s">&quot;eu-west-1&quot;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&quot;aws&quot;</span><span class="p">):</span>
</span><span class='line'>    <span class="n">rekognition</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&quot;rekognition&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">rekognition</span><span class="o">.</span><span class="n">detect_labels</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Image</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;S3Object&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;Bucket&quot;</span><span class="p">:</span> <span class="n">BUCKET</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;Name&quot;</span><span class="p">:</span> <span class="n">KEY</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">MaxLabels</span><span class="o">=</span><span class="n">max_labels</span><span class="p">,</span>
</span><span class='line'>        <span class="n">MinConfidence</span><span class="o">=</span><span class="n">min_confidence</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;Labels&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">detect_labels</span><span class="p">(</span><span class="n">BUCKET</span><span class="p">,</span> <span class="n">KEY</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;{Name} - {Confidence}%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">label</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Running the App:</h2>

<p>Running our Python App, will result in the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python rekog.py
</span><span class='line'>People - 98.9893875122%
</span><span class='line'>Person - 98.9893951416%
</span><span class='line'>Human - 98.9505844116%
</span><span class='line'>Alcohol - 98.573425293%
</span><span class='line'>Beer - 98.573425293%
</span><span class='line'>Beer Bottle - 98.573425293%
</span><span class='line'>Beverage - 98.573425293%
</span><span class='line'>Bottle - 98.573425293%
</span><span class='line'>Drink - 98.573425293%
</span><span class='line'>Couch - 98.4713821411%
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://aws.amazon.com/rekognition/">https://aws.amazon.com/rekognition/</a></li>
<li><a href="https://gist.github.com/alexcasalboni/0f21a1889f09760f8981b643326730ff">https://gist.github.com/alexcasalboni/0f21a1889f09760f8981b643326730ff</a></li>
</ul>


<center>
        <script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Buy Me a Coffee', '#46b798', 'A6423ZIQ');kofiwidget2.draw();</script>
</center>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup RocketChat on Docker Swarm]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/10/setup-rocketchat-on-docker-swarm/"/>
    <updated>2017-09-10T18:45:12-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/10/setup-rocketchat-on-docker-swarm</id>
    <content type="html"><![CDATA[<p>Rocket Chat, a Self Hosted Alternative, which is very similar to Slack.</p>

<p>We will setup a RocketChat Server which is hosted on Docker Swarm. In future posts, I will also go through the steps on working with the API, Custom Emoji&rsquo;s etc.</p>

<h2>Requirements:</h2>

<p>RocketChat uses MongoDB as its Database, we will keep the database outside of our swarm, if you don&rsquo;t already have a MongoDB Server in place, follow the <a href="http://blog.ruanbekker.com/blog/2017/09/02/setup-a-3-node-mongodb-replica-set-on-ubuntu-16/">Setup a 3 Node MongoDB</a> post to get that sorted.</p>

<p>Another requirement is to have docker swarm running, alternatively, you can also follow <a href="https://rocket.chat/docs/installation/">RocketChat&rsquo;s Documentation</a> if you prefer setting it up elsewhere.</p>

<h2>Setup Rocket Chat</h2>

<p>We will assume MongoDB is accessible via <code>mongodb.domain.com</code> on port <code>27017</code>, with a username and password.</p>

<p>Creating the RocketChat service and associate it to our <code>appnet</code> overlay network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker service create --name rocketchat <span class="se">\</span>
</span><span class='line'>--replicas <span class="m">1</span> <span class="se">\</span>
</span><span class='line'>--network appnet <span class="se">\</span>
</span><span class='line'>--env <span class="nv">DEPLOY_METHOD</span><span class="o">=</span>docker <span class="se">\</span>
</span><span class='line'>--env <span class="nv">NODE_ENV</span><span class="o">=</span>production <span class="se">\</span>
</span><span class='line'>--env <span class="nv">PORT</span><span class="o">=</span><span class="m">3000</span> <span class="se">\</span>
</span><span class='line'>--env <span class="nv">MONGO_URL</span><span class="o">=</span><span class="s2">&quot;mongodb://mongoadmin:mongopass@mongodb.domain.com:27017/rocketchat?authSource=admin&quot;</span> <span class="se">\</span>
</span><span class='line'>--env <span class="nv">ROOT_URL</span><span class="o">=</span>http://rocketchat.domain.com <span class="se">\</span>
</span><span class='line'>--env <span class="nv">ADMIN_USERNAME</span><span class="o">=</span>myadmin <span class="se">\</span>
</span><span class='line'>--env <span class="nv">ADMIN_PASS</span><span class="o">=</span>secret <span class="se">\</span>
</span><span class='line'>--env <span class="nv">ADMIN_EMAIL</span><span class="o">=</span>mail@domain.com <span class="se">\</span>
</span><span class='line'>--env <span class="nv">Accounts_AvatarStorePath</span><span class="o">=</span>/app/uploads <span class="se">\</span>
</span><span class='line'>--secret rocketchat_secret <span class="se">\</span>
</span><span class='line'>rocketchat/rocket.chat
</span></code></pre></td></tr></table></div></figure>


<h2>View the RocketChat Service Logs</h2>

<p>Lets monitor the docker service logs for our rocketchat service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service logs -f rocketchat
</span><span class='line'>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> Using GridFS <span class="k">for</span> custom sounds storage
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> Using GridFS <span class="k">for</span> custom emoji storage
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> ufs: temp directory created at <span class="s2">&quot;/tmp/ufs&quot;</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> System startup
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> +--------------------------------------------------------------+
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>                        SERVER RUNNING                        <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> +--------------------------------------------------------------+
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>                                                              <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>  Rocket.Chat Version: 0.58.2                                 <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>       NodeJS Version: 4.8.4 - x64                            <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>             Platform: linux                                  <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>         Process Port: <span class="m">3000</span>                                   <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>             Site URL: http://rocketchat.domain.com           <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>     ReplicaSet OpLog: Disabled                               <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>          Commit Hash: 988103d449                             <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>        Commit Branch: HEAD                                   <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> <span class="p">|</span>                                                              <span class="p">|</span>
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> +--------------------------------------------------------------+
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> Inserting admin user:
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> Name: Administrator
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> Email: mail@domain.com
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> Username: myadmin
</span><span class='line'>rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    <span class="p">|</span> Password: secret
</span></code></pre></td></tr></table></div></figure>


<p>Now you should be able to access Rocket Chat on the <code>ROOT_URL</code> that you have specified.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://rocket.chat/docs/installation/">https://rocket.chat/docs/installation/</a></li>
<li><a href="https://github.com/RocketChat/Docker.Official.Image">https://github.com/RocketChat/Docker.Official.Image</a></li>
<li><a href="https://rocket.chat/docs/installation/docker-containers">https://rocket.chat/docs/installation/docker-containers</a></li>
</ul>


<center>
        <script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Buy Me a Coffee', '#46b798', 'A6423ZIQ');kofiwidget2.draw();</script>
</center>



]]></content>
  </entry>
  
</feed>
