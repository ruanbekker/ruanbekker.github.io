<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Ruan Bekker's Blog]]></title>
  <link href="http://blog.ruanbekker.com/atom.xml" rel="self"/>
  <link href="http://blog.ruanbekker.com/"/>
  <updated>2019-04-04T18:00:59-04:00</updated>
  <id>http://blog.ruanbekker.com/</id>
  <author>
    <name><![CDATA[Ruan]]></name>
    <email><![CDATA[ruan@ruanbekker.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Self Hosted Git and CICD Platform With Gitea and Drone on Docker]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/04/04/self-hosted-git-and-cicd-platform-with-gitea-and-drone-on-docker/"/>
    <updated>2019-04-04T17:57:16-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/04/04/self-hosted-git-and-cicd-platform-with-gitea-and-drone-on-docker</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/55591102-f57c7100-5734-11e9-96cf-8a60d091a769.png" alt="" /></p>

<p>Both gitea and drone is built on golang runs on multiple platforms including a raspberry pi and its super lightweight. Oh yes, and its awesome!</p>

<p>In this tutorial we will see how we can implement our own git service and cicd platform by setting up gitea and drone on docker and commit a python flask application to gitea and build a pipeline on drone.</p>

<h2>Some definition</h2>

<p><strong>Gitea</strong>: will be your self hosted git server</p>

<p><strong>Drone Server</strong>: will be server being responsible for the web service, repositories, secrets, users, etc.</p>

<p><strong>Drone Agent</strong>: will be the workers that runs your builds, jobs etc.</p>

<h2>Server Confguration</h2>

<p>We will change our host&rsquo;s ssh port to something else as our git server&rsquo;s ssh method will be listening on port 22 and we would like to add our ssh key to gitea so that we can commit to our git server via ssh.</p>

<p>Change your server&rsquo;s ssh port to 2222, by opening <code>/etc/ssh/sshd_config</code> and edit the port to <code>2222</code> then restart sshd with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ /etc/init.d/sshd restart</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Your ssh connection will still be established, but you can exit and ssh to your server by specifying the new port:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -p 2222 user@host</span></code></pre></td></tr></table></div></figure>


<h2>Pre-Requirements</h2>

<p>Make sure you have <a href="https://docs.docker.com/install/">docker and docker-compose</a> installed</p>

<h2>Deploy Gitea and Drone</h2>

<p>Below is the docker-compose file for our deployment. Note that we are running a postgres database which gitea will be configured on, you can also use other databases like mysql, sqlite etc. Visit their <a href="https://docs.gitea.io/en-us/">documentation</a> for more info.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;2&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">gitea-app</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gitea/gitea:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gitea-app</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">USER_UID=1000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">USER_GID=1000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ROOT_URL=http://gitea:3000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">SSH_DOMAIN=mydomain.com</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./volumes/gitea_app:/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;3000:3000&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;22:22&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">gitea-db</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres:alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gitea-db</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">5440:5432</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./volumes/gitea_db:/var/lib/postgresql/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_USER=postgres</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_PASSWORD=postgres</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_DB=gitea</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">drone-server</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">drone/drone:0.8</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">drone-server</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">80:8000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">9000</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./volumes/drone:/var/lib/drone/</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">gitea</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_OPEN=true</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_HOST=http://drone-server:8000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_GITEA=true</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_GITEA_URL=http://gitea:3000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_SECRET=secret</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_NETWORK=appnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">drone-agent</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">drone/agent:0.8</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">drone-agent</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">agent</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">drone-server</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_SERVER=drone-server:9000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_SECRET=secret</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">gitea-app</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">gitea-db</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">appnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the volumes path:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ mkdir volumes</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the external network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker network create appnet</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some key configuration,</p>

<p>Our <code>SSH_DOMAIN</code> will be the domain that gets used for things like cloning a repository. When you register your gitea account, you will use the same credentials to logon to drone.</p>

<p>Deploy your stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker-compose up -d</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Register on Gitea</h2>

<p>When your deployment is done, access your gitea server which should be available on <code>http://your-docker-ip:3000/</code> complete the registration, if you decide to go with postgres your username/password will be <code>postgres</code> and your host will be <code>gitea-db:5432</code>.</p>

<p>Make sure to complete the administrator account to get your admin credentials.</p>

<h2>Setup SSH Key and Repo</h2>

<p>Generate a ssh key that you will use for communicating to git over ssh. If you have already have an ssh key you can skip this step.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa
</span><span class='line'><span class="c"># use the defaults</span>
</span></code></pre></td></tr></table></div></figure>


<p>Login on gitea, once you are logged in, head over to profile / settings / ssh keys: <code>http://your-docker-ip:3000/user/settings/keys</code>.</p>

<p>Add a new ssh key, go back to your terminal and copy the public key which we will provide to gitea:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat ~/.ssh/id_rsa.pub
</span><span class='line'>&lt;copy the contents to your clipboard&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Paste your public key and provide a descriptive title.</p>

<p>Head back to your dashboard and create your first repository:</p>

<p><img width="1277" alt="image" src="https://user-images.githubusercontent.com/567298/55589336-49388b80-5730-11e9-8ae5-2589fea7e2b2.png"></p>

<p>It should look more or less like this:</p>

<p><img width="1007" alt="image" src="https://user-images.githubusercontent.com/567298/55589473-9583cb80-5730-11e9-8124-3bdedc221a70.png"></p>

<h2>Enable Repo on Drone</h2>

<p>Head over to drone and select the repositores on the right hand side <a href="http://">http://</a><your-docker-ip>:80/account/repos and enable your repository by toggline the selector, it should look more or less like this:</p>

<p><img width="1275" alt="image" src="https://user-images.githubusercontent.com/567298/55589614-f3b0ae80-5730-11e9-9358-54a6be611198.png"></p>

<p>Once its enabled head back to gitea.</p>

<h2>Clone the repository</h2>

<p>On your repository select ssh and copy the ssh link for your repository:</p>

<p><img width="974" alt="image" src="https://user-images.githubusercontent.com/567298/55589710-3b373a80-5731-11e9-956b-c921c42e6a2d.png"></p>

<p>Then from your terminal add your private ssh key to your ssh agent and clone the repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">eval</span> <span class="k">$(</span>ssh-agent<span class="k">)</span>
</span><span class='line'><span class="nv">$ </span>ssh-add ~/.ssh/id_rsa
</span><span class='line'><span class="nv">$ </span>git clone git@your-docker-ip:your-user/your-repo.git
</span></code></pre></td></tr></table></div></figure>


<h2>Add Example Python Flask app to git</h2>

<p>I will use a basic python flask application with some tests.</p>

<p>Let&rsquo;s first add our pipeline definition for drone, so that drone understands how the pipeline should be run when gitea receives a commit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>touch .drone.yml
</span></code></pre></td></tr></table></div></figure>


<p>Our pipeline:</p>

<figure class='code'><figcaption><span>.drone.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">pipeline</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">python:3.5.1-alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">commands</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip install --upgrade pip setuptools wheel</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip wheel -r requirements.txt --wheel-dir=wheeldir --find-links=wheeldir</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip install --no-index --find-links=wheeldir -r requirements.txt</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">flake8 app</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir -p coverage</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nosetests -v tests/</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lets add that to git:</p>

<figure class='code'><figcaption><span>.drone.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ git add .drone.yml</span>
</span><span class='line'><span class="l-Scalar-Plain">$ git commit -m &quot;initial add of our pipeline&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">$ git push origin master</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our drone file should be in git, now our requirements dependency file for python:</p>

<figure class='code'><figcaption><span>requirements.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>flask
</span><span class='line'>nose
</span><span class='line'>flake8
</span></code></pre></td></tr></table></div></figure>


<p>Our blank file to make our application a module:</p>

<figure class='code'><figcaption><span>requirements.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir app
</span><span class='line'><span class="nv">$ </span>touch app/__init__.py
</span></code></pre></td></tr></table></div></figure>


<p>And our flask app:</p>

<figure class='code'><figcaption><span>app/app.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;Hello, World!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our tests directory and our python init file:</p>

<figure class='code'><figcaption><span>app/app.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">mkdir</span> <span class="n">tests</span>
</span><span class='line'><span class="err">$</span> <span class="n">touch</span> <span class="n">tests</span><span class="o">/</span><span class="n">__init__</span><span class="o">.</span><span class="n">py</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have all our files ready, commit and push to git:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git add .
</span><span class='line'><span class="nv">$ </span>git commit -m <span class="s2">&quot;add python app&quot;</span>
</span><span class='line'><span class="nv">$ </span>git push origin master
</span></code></pre></td></tr></table></div></figure>


<h2>Look at Drone Running</h2>

<p>Head over to drone and look at the builds, you should see your build running at <code>http://&lt;docker-ip&gt;:80/&lt;user&gt;/&lt;repo-name&gt;</code>:</p>

<p><img width="1269" alt="image" src="https://user-images.githubusercontent.com/567298/55590369-f8766200-5732-11e9-82fb-2bda2c8ad40a.png"></p>

<p>If everything ran as expected you should see that it passed.</p>

<h2>Build Status Badges</h2>

<p>You can also include the build status badges from drone which will look like:</p>

<p><img width="1032" alt="image" src="https://user-images.githubusercontent.com/567298/55590552-82bec600-5733-11e9-91f2-a65c5a94fac5.png"></p>

<p>You can use the drone api: <code>http://drone-ip:80/api/badges/&lt;your-user&gt;/&lt;your-repo&gt;/status.svg</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>!<span class="o">[</span>Build Status<span class="o">](</span>http://your-ip/api/badges/your-user/your-repo/status.svg<span class="o">)</span>
</span><span class='line'><span class="o">[</span>!<span class="o">[](</span>https://images.microbadger.com/badges/image/gitea/gitea.svg<span class="o">)](</span>https://microbadger.com/images/gitea/gitea <span class="s2">&quot;Get your own image badge on microbadger.com&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">[</span>!<span class="o">[</span>GitHub release<span class="o">](</span>https://img.shields.io/github/release/go-gitea/gitea.svg<span class="o">)](</span>https://github.com/go-gitea/gitea/releases/latest<span class="o">)</span>
</span><span class='line'><span class="o">[</span>!<span class="o">[</span>Help Contribute to Open Source<span class="o">](</span>https://www.codetriage.com/go-gitea/gitea/badges/users.svg<span class="o">)](</span>https://www.codetriage.com/go-gitea/gitea<span class="o">)</span>
</span><span class='line'><span class="o">[</span>!<span class="o">[</span>Become a backer/sponsor of gitea<span class="o">](</span>https://opencollective.com/gitea/tiers/backer/badge.svg?label<span class="o">=</span>backer<span class="p">&amp;</span><span class="nv">color</span><span class="o">=</span>brightgreen<span class="o">)](</span>https://opencollective.com/gitea<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Overall gitea and drone is really amazing and quite impressed with it, especially from the low memory footprint and that its so easy to work with.</p>

<h2>Resources</h2>

<p>Have a look at this for more resources:</p>

<p><strong>Docs:</strong></p>

<ul>
<li><a href="https://github.com/drone/drone">https://github.com/drone/drone</a></li>
<li><a href="http://plugins.drone.io/drone-plugins/drone-docker/">http://plugins.drone.io/drone-plugins/drone-docker/</a></li>
<li><a href="https://docs.drone.io/reference/server/drone-user-create/">https://docs.drone.io/reference/server/drone-user-create/</a></li>
<li><a href="https://docs.gitea.io/en-us/install-with-docker/">https://docs.gitea.io/en-us/install-with-docker/</a></li>
</ul>


<p><strong>Examples:</strong></p>

<ul>
<li><a href="https://hackernoon.com/build-your-own-ci-cd-pipeline-with-drone-e43d7190989b">https://hackernoon.com/build-your-own-ci-cd-pipeline-with-drone-e43d7190989b</a></li>
<li><a href="https://github.com/drone-demos/drone-with-python">https://github.com/drone-demos/drone-with-python</a></li>
<li><a href="https://github.com/drone/awesome-drone">https://github.com/drone/awesome-drone</a></li>
<li><a href="https://github.com/juliantellez/drone-ci-pipeline">https://github.com/juliantellez/drone-ci-pipeline</a></li>
<li><a href="https://github.com/sguter90/docker-compose-gitea">https://github.com/sguter90/docker-compose-gitea</a></li>
<li><a href="https://gist.github.com/joffilyfe/1a99250cb74bb75e29cbe8d6ca8ceedb">https://gist.github.com/joffilyfe/1a99250cb74bb75e29cbe8d6ca8ceedb</a></li>
<li><a href="https://florian-latifi.at/2018/02/21/using-drone-to-build-and-deploy-a-jekyll-site/">https://florian-latifi.at/2018/02/21/using-drone-to-build-and-deploy-a-jekyll-site/</a></li>
<li><a href="https://angristan.xyz/host-your-own-ci-cd-server-with-drone/">https://angristan.xyz/host-your-own-ci-cd-server-with-drone/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Build Small Golang Docker Containers]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/04/03/build-small-golang-docker-containers/"/>
    <updated>2019-04-03T08:24:08-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/04/03/build-small-golang-docker-containers</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/55478306-aabb0600-561b-11e9-9cc6-730fadb4beeb.png" alt="" /></p>

<p>In this tutorial I will show you how to build really small docker containers for golang applications. And I mean the difference between 310MB down to 2MB</p>

<h2>But Alpine..</h2>

<p>So we thinking lets go with alpine right? Yeah sure lets build a small, app running on go with alpine.</p>

<p>Our application code:</p>

<figure class='code'><figcaption><span>app.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;math/rand&quot;</span>
</span><span class='line'>  <span class="s">&quot;time&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">lekkewords</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;dog&quot;</span><span class="p">,</span> <span class="s">&quot;cat&quot;</span><span class="p">,</span> <span class="s">&quot;fish&quot;</span><span class="p">,</span> <span class="s">&quot;giraffe&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;moo&quot;</span><span class="p">,</span> <span class="s">&quot;spider&quot;</span><span class="p">,</span> <span class="s">&quot;lion&quot;</span><span class="p">,</span> <span class="s">&quot;apple&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;tree&quot;</span><span class="p">,</span> <span class="s">&quot;moon&quot;</span><span class="p">,</span> <span class="s">&quot;snake&quot;</span><span class="p">,</span> <span class="s">&quot;mountain lion&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;trooper&quot;</span><span class="p">,</span> <span class="s">&quot;burger&quot;</span><span class="p">,</span> <span class="s">&quot;nasa&quot;</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">rand</span><span class="p">.</span><span class="nx">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">())</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">zelength</span> <span class="kt">int</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">lekkewords</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">indexnum</span> <span class="kt">int</span> <span class="p">=</span> <span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nx">zelength</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">word</span> <span class="o">:=</span> <span class="nx">lekkewords</span><span class="p">[</span><span class="nx">indexnum</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Number of words:&quot;</span><span class="p">,</span> <span class="nx">zelength</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Selected index number:&quot;</span><span class="p">,</span> <span class="nx">indexnum</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Selected word is:&quot;</span><span class="p">,</span> <span class="nx">word</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our Dockerfile:</p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'><span class="k">FROM</span> golang:alpine
</span><span class='line'>
</span><span class='line'><span class="k">WORKDIR</span> <span class="nv">$GOPATH</span>/src/mylekkepackage/mylekkeapp/
</span><span class='line'>COPY app.go .
</span><span class='line'><span class="k">RUN</span> go build -o /go/app
</span><span class='line'>
</span><span class='line'><span class="k">CMD</span> <span class="o">[</span><span class="s2">&quot;/go/app&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s package our app to an image:</p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'>❯ docker build -t mygolangapp:using-alpine .
</span></code></pre></td></tr></table></div></figure>


<p>Inspect the size of our image, as you can see it being <strong>310MB</strong></p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'>❯ docker images <span class="s2">&quot;mygolangapp:*&quot;</span>
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE
</span><span class='line'>mygolangapp         using-alpine        eea1d7bde218        About a minute ago   310MB
</span></code></pre></td></tr></table></div></figure>


<p>Just make sure it actually works:</p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'>❯ docker run mygolangapp:using-alpine
</span><span class='line'>Number of words: <span class="m">16</span>
</span><span class='line'>Selected index number: <span class="m">11</span>
</span><span class='line'>Selected word is: mountain lion
</span></code></pre></td></tr></table></div></figure>


<p>But for something just returning random selected text, 310MB is a bit crazy.</p>

<h2>Multi Stage Builds</h2>

<p>As Go binaries are self-contained, we can make use of docker&rsquo;s multi stage builds, where we can build our application on alpine and use the binary on a scratch image:</p>

<p>Our multi stage Dockerfile:</p>

<figure class='code'><figcaption><span>Dockerfile.mult</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'><span class="k">FROM</span> golang:alpine AS builder
</span><span class='line'>
</span><span class='line'><span class="k">WORKDIR</span> <span class="nv">$GOPATH</span>/src/mylekkepackage/mylekkeapp/
</span><span class='line'>COPY app.go .
</span><span class='line'><span class="k">RUN</span> go build -o /go/app
</span><span class='line'>
</span><span class='line'><span class="k">FROM</span> scratch
</span><span class='line'>
</span><span class='line'>COPY --from<span class="o">=</span>builder /go/app /go/app
</span><span class='line'>
</span><span class='line'><span class="k">CMD</span> <span class="o">[</span><span class="s2">&quot;/go/app&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Build it:</p>

<figure class='code'><figcaption><span>Dockerfile.mult</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'>❯ docker build -t mygolangapp:using-multistage -f Dockerfile.multi .
</span></code></pre></td></tr></table></div></figure>


<p>Notice that the image is only <strong>2.01MB</strong>, say w000t!</p>

<figure class='code'><figcaption><span>Dockerfile.mult</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'>❯ docker images <span class="s2">&quot;mygolangapp:*&quot;</span>
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>mygolangapp         using-multistage    31474c61ba5b        <span class="m">15</span> seconds ago      2.01MB
</span><span class='line'>mygolangapp         using-alpine        eea1d7bde218        <span class="m">2</span> minutes ago       310MB
</span></code></pre></td></tr></table></div></figure>


<p>Run the app:</p>

<figure class='code'><figcaption><span>Dockerfile.mult</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'>❯ docker run mygolangapp:using-multistage
</span><span class='line'>Number of words: <span class="m">16</span>
</span><span class='line'>Selected index number: <span class="m">5</span>
</span><span class='line'>Selected word is: spider
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p>Source code for this demonstration can be found at <a href="https://github.com/ruanbekker/golang-build-small-images">github.com/ruanbekker/golang-build-small-images</a></p>

<p><img src="https://user-images.githubusercontent.com/567298/55478904-236e9200-561d-11e9-9382-f31b25a9ae03.png" alt="" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Secure Your Elasticsearch Cluster With Basic Auth Using Nginx and SSL From Letsencrypt]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/04/02/secure-your-elasticsearch-cluster-with-basic-auth-using-nginx/"/>
    <updated>2019-04-02T14:55:58-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/04/02/secure-your-elasticsearch-cluster-with-basic-auth-using-nginx</id>
    <content type="html"><![CDATA[<p>In this tutorial we will setup a reverse proxy using nginx to translate and load balance traffic through to our elasticsearch nodes. We will also protect our elasticsearch cluster with basic auth and use letsencrypt to retrieve free ssl certificates.</p>

<p>We want to allow certain requests to be bypassed from authentication such as getting status from the cluster and certain requests we want to enforce authentication, such as indexing and deleting data.</p>

<h2>Install Nginx:</h2>

<p>Install nginx and the dependency package to create basic auth:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install nginx apache2-utils -y
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Nginx for Reverse Proxy</h2>

<p>We want to access our nginx proxy on port 80: <code>0.0.0.0:80</code> and the requests should be proxied through to elasticsearch private addresses: <code>10.0.0.10:9200</code> and <code>10.0.0.11:9200</code>. Traffic will be load balanced between our 2 nodes.</p>

<p>Edit the main nginx configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim /etc/nginx/nginx.conf
</span></code></pre></td></tr></table></div></figure>


<p>and populate the information as shown below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>user www-data<span class="p">;</span>
</span><span class='line'>worker_processes auto<span class="p">;</span>
</span><span class='line'>pid /run/nginx.pid<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>  worker_connections 1024<span class="p">;</span>
</span><span class='line'>  <span class="c"># multi_accept on;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># basic Settings</span>
</span><span class='line'>  sendfile on<span class="p">;</span>
</span><span class='line'>  tcp_nopush on<span class="p">;</span>
</span><span class='line'>  tcp_nodelay on<span class="p">;</span>
</span><span class='line'>  keepalive_timeout 65<span class="p">;</span>
</span><span class='line'>  types_hash_max_size 2048<span class="p">;</span>
</span><span class='line'>  include /etc/nginx/mime.types<span class="p">;</span>
</span><span class='line'>  default_type application/octet-stream<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># ssl settings</span>
</span><span class='line'>  ssl_protocols TLSv1 TLSv1.1 TLSv1.2<span class="p">;</span>
</span><span class='line'>  ssl_prefer_server_ciphers on<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># logging settings</span>
</span><span class='line'>  access_log /var/log/nginx/access.log<span class="p">;</span>
</span><span class='line'>  error_log /var/log/nginx/error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># gzip settings</span>
</span><span class='line'>  gzip on<span class="p">;</span>
</span><span class='line'>  gzip_disable <span class="s2">&quot;msie6&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># virtual host configs</span>
</span><span class='line'>  include /etc/nginx/conf.d/*.conf<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, edit the virtual host config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim /etc/nginx/conf.d/elasticsearch.conf
</span></code></pre></td></tr></table></div></figure>


<p>And populate the following config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># https://gist.github.com/sahilsk/b16cb51387847e6c3329</span>
</span><span class='line'>
</span><span class='line'>upstream elasticsearch <span class="o">{</span>
</span><span class='line'>    <span class="c"># define your es nodes</span>
</span><span class='line'>    server 10.0.0.10:9200<span class="p">;</span>
</span><span class='line'>    server 10.0.0.11:9200<span class="p">;</span>
</span><span class='line'>    <span class="c"># persistent http connections</span>
</span><span class='line'>    <span class="c"># https://www.elastic.co/blog/playing-http-tricks-nginx</span>
</span><span class='line'>    keepalive 15<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>  listen 80<span class="p">;</span>
</span><span class='line'>  server_name elasticsearch.domain.com<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  auth_basic <span class="s2">&quot;server auth&quot;</span><span class="p">;</span>
</span><span class='line'>  auth_basic_user_file /etc/nginx/passwords<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  location / <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># deny node shutdown api</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="nv">$request_filename</span> ~ <span class="s2">&quot;_shutdown&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> 403<span class="p">;</span>
</span><span class='line'>      <span class="nb">break</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">location</span> <span class="o">=</span> / <span class="o">{</span>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;off&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location ~* ^<span class="o">(</span>/_cluster/health<span class="p">|</span>/_cat/health<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;off&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set your username and password to protect your endpoint:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>htpasswd -c /etc/nginx/passwords admin
</span></code></pre></td></tr></table></div></figure>


<p>Enable nginx on boot and restart the process:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>nginx
</span><span class='line'><span class="nv">$ </span>systemctl restart nginx
</span></code></pre></td></tr></table></div></figure>


<h2>Test it</h2>

<p>Now make requests to elasticsearch via your nginx reverse proxy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s1">&#39;admin:admin&#39;</span> http://myproxy.domain.com/_cat/indices?v
</span><span class='line'>health status index       uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   first-index 1o6yM7tCSqagqoeihKM7_g   <span class="m">5</span>   <span class="m">1</span>          <span class="m">3</span>            <span class="m">0</span>     40.6kb         20.3kb
</span></code></pre></td></tr></table></div></figure>


<h2>Letsencrypt SSL Certificates</h2>

<p>Add free SSL Certificates to your reverse proxy. Install certbot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt-get update
</span><span class='line'><span class="nv">$ </span>apt-get install software-properties-common -y
</span><span class='line'><span class="nv">$ </span>add-apt-repository universe
</span><span class='line'><span class="nv">$ </span>add-apt-repository ppa:certbot/certbot
</span><span class='line'><span class="nv">$ </span>apt-get update
</span><span class='line'><span class="nv">$ </span>apt-get install certbot python-certbot-nginx -y
</span></code></pre></td></tr></table></div></figure>


<p>Request a Certificate for your domain:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>certbot --manual certonly -d myproxy.domain.com -m my@email.com --preferred-challenges dns --agree-tos
</span><span class='line'>
</span><span class='line'>Obtaining a new certificate
</span><span class='line'>Performing the following challenges:
</span><span class='line'>dns-01 challenge <span class="k">for</span> myproxy.domain.com
</span></code></pre></td></tr></table></div></figure>


<p>You will be prompted to make a dns change, since we requested the dns challenge. While this screen is here, we can go our dns provider and make the TXT record change as shown below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Please deploy a DNS TXT record under the name
</span><span class='line'>_acme-challenge.myproxy.domain.com with the following value:
</span><span class='line'>
</span><span class='line'>xLP4y_YJvdAK7_aZMJ50gkudTDeIC3rX0x83aNJctGw
</span><span class='line'>
</span><span class='line'>Before continuing, verify the record is deployed.
</span><span class='line'>Press Enter to Continue
</span><span class='line'>Waiting <span class="k">for</span> verification...
</span><span class='line'>Cleaning up challenges
</span><span class='line'>
</span><span class='line'>IMPORTANT NOTES:
</span><span class='line'> - Congratulations! Your certificate and chain have been saved at:
</span><span class='line'>   /etc/letsencrypt/live/myproxy.domain.com/fullchain.pem
</span><span class='line'>   Your key file has been saved at:
</span><span class='line'>   /etc/letsencrypt/live/myproxy.domain.com/privkey.pem
</span><span class='line'>   Your cert will expire on 2019-07-01. To obtain a new or tweaked
</span><span class='line'>   version of this certificate in the future, simply run certbot
</span><span class='line'>   again. To non-interactively renew *all* of your certificates, run
</span><span class='line'>   <span class="s2">&quot;certbot renew&quot;</span>
</span><span class='line'> - If you like Certbot, please consider supporting our work by:
</span><span class='line'>
</span><span class='line'>   Donating to ISRG / Let<span class="err">&#39;</span>s Encrypt:   https://letsencrypt.org/donate
</span><span class='line'>   Donating to EFF:                    https://eff.org/donate-le
</span></code></pre></td></tr></table></div></figure>


<h2>Update Nginx Config</h2>

<p>Now that we have our ssl certificates, we need to update our nginx config to enable ssl, redirect http to https and point the ssl certificates and ssl private keys to the certificates that we retrieved from letsencrypt.</p>

<p>Open up the virtual host nginx configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim /etc/nginx/conf.d/elasticsearch.conf
</span></code></pre></td></tr></table></div></figure>


<p>Update the config like the one below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>upstream elasticsearch <span class="o">{</span>
</span><span class='line'>    server 10.0.0.10:9200<span class="p">;</span>
</span><span class='line'>    server 10.0.0.11:9200<span class="p">;</span>
</span><span class='line'>    keepalive 15<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>  listen 80<span class="p">;</span>
</span><span class='line'>  server_name myproxy.domain.com<span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="m">301</span> https://<span class="nv">$host$request_uri</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>  listen <span class="m">443</span> ssl<span class="p">;</span>
</span><span class='line'>  server_name myproxy.domain.com<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  ssl_certificate /etc/letsencrypt/live/myproxy.domain.com/fullchain.pem<span class="p">;</span>
</span><span class='line'>  ssl_certificate_key /etc/letsencrypt/live/myproxy.domain.com/privkey.pem<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  auth_basic <span class="s2">&quot;server auth&quot;</span><span class="p">;</span>
</span><span class='line'>  auth_basic_user_file /etc/nginx/passwords<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  location ^~ /.well-known/acme-challenge/ <span class="o">{</span>
</span><span class='line'>    auth_basic off<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location / <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># deny node shutdown api</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="nv">$request_filename</span> ~ <span class="s2">&quot;_shutdown&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> 403<span class="p">;</span>
</span><span class='line'>      <span class="nb">break</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">location</span> <span class="o">=</span> / <span class="o">{</span>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;off&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location ~* ^<span class="o">(</span>/_cluster/health<span class="p">|</span>/_cat/health<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;off&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Restart the nginx process:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl restart nginx
</span></code></pre></td></tr></table></div></figure>


<h2>Test the Nginx Proxy with SSL</h2>

<p>Test the proxy with HTTP so that we can see that our nginx config redirects us to <a href="HTTPS:">HTTPS:</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -iL -u <span class="s1">&#39;admin:admin&#39;</span> http://myproxy.domain.com/_cat/nodes?v
</span><span class='line'>HTTP/1.1 <span class="m">301</span> Moved Permanently
</span><span class='line'>Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span><span class='line'>Date: Tue, <span class="m">02</span> Apr <span class="m">2019</span> 21:40:09 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 194
</span><span class='line'>Connection: keep-alive
</span><span class='line'>Location: https://myproxy.domain.com/_cat/nodes?v
</span><span class='line'>
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span><span class='line'>Date: Tue, <span class="m">02</span> Apr <span class="m">2019</span> 21:40:10 GMT
</span><span class='line'>Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
</span><span class='line'>Content-Length: 276
</span><span class='line'>Connection: keep-alive
</span><span class='line'>
</span><span class='line'>ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>10.0.0.10               <span class="m">40</span>          <span class="m">97</span>   <span class="m">3</span>    0.15    0.10     0.08 mdi       -      Lq9P7eP
</span><span class='line'>10.0.0.11               <span class="m">44</span>          <span class="m">96</span>   <span class="m">3</span>    0.21    0.10     0.09 mdi       *      F5edOwK
</span></code></pre></td></tr></table></div></figure>


<p>Test the proxy with <a href="HTTPS:">HTTPS:</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i -u <span class="s1">&#39;admin:admin&#39;</span> https://myproxy.domain.com/_cat/nodes?v
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span><span class='line'>Date: Tue, <span class="m">02</span> Apr <span class="m">2019</span> 21:40:22 GMT
</span><span class='line'>Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
</span><span class='line'>Content-Length: 276
</span><span class='line'>Connection: keep-alive
</span><span class='line'>
</span><span class='line'>ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>10.0.0.10               <span class="m">44</span>          <span class="m">96</span>   <span class="m">4</span>    0.18    0.10     0.09 mdi       *      F5edOwK
</span><span class='line'>10.0.0.11               <span class="m">39</span>          <span class="m">97</span>   <span class="m">5</span>    0.13    0.09     0.08 mdi       -      Lq9P7eP
</span></code></pre></td></tr></table></div></figure>


<p>Setup a cronjob to auto renew the certificates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>crontab -e
</span></code></pre></td></tr></table></div></figure>


<p>Populate the following line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="m">6</span> 1,13 * * * /usr/bin/certbot renew --post-hook <span class="s2">&quot;systemctl restart nginx&quot;</span> --quiet
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://certbot.eff.org/lets-encrypt/ubuntuxenial-nginx.html">https://certbot.eff.org/lets-encrypt/ubuntuxenial-nginx.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup Kibana Dashboards for Nginx Log Data to Understand the Behavior]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/04/02/setup-kibana-dashboards-for-nginx-log-data-to-understand-the-behavior/"/>
    <updated>2019-04-02T12:34:18-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/04/02/setup-kibana-dashboards-for-nginx-log-data-to-understand-the-behavior</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/55418811-b8b54c00-5573-11e9-810d-d244d27c4fb3.png" alt="kibana" /></p>

<p>In this tutorial we will setup a Basic Kibana Dashboard for a Web Server that is running a Blog on Nginx.</p>

<h2>What do we want to achieve?</h2>

<p>We will setup common visualizations to give us an idea on how our blog/website is doing.</p>

<p>In some situations we need to create visualizations to understand the behavior of our log data in order to answer these type of questions:</p>

<table>
<thead>
<tr>
<th> <strong>Number</strong> </th>
<th> <strong>Scenario</strong>                                                         </th>
</tr>
</thead>
<tbody>
<tr>
<td> 1          </td>
<td> Geographical map to see where people are connecting from             </td>
</tr>
<tr>
<td> 2          </td>
<td> Piechart that represents the percentage of cities accessing my blog  </td>
</tr>
<tr>
<td> 3          </td>
<td> Top 10 Most Accessed Pages                                           </td>
</tr>
<tr>
<td> 4          </td>
<td> Top 5 HTTP Status Codes                                              </td>
</tr>
<tr>
<td> 5          </td>
<td> Top 10 Pages that returned 404 Responses                             </td>
</tr>
<tr>
<td> 6          </td>
<td> The Top 10 User Agents                                               </td>
</tr>
<tr>
<td> 7          </td>
<td> Timeseries: Status Codes Over Time                                   </td>
</tr>
<tr>
<td> 8          </td>
<td> Timeseries: Successfull Website Hits over time                       </td>
</tr>
<tr>
<td> 9          </td>
<td> Counter with Website Hits                                            </td>
</tr>
<tr>
<td> 10         </td>
<td> Average Bytes Returned                                               </td>
</tr>
<tr>
<td> 11         </td>
<td> Tag Cloud with the City Names that Accessed my Blog                  </td>
</tr>
</tbody>
</table>


<h2>Pre-Requirements</h2>

<p>I am consuming my nginx access logs with filebeat and shipping them to elasticsearch. You can check out <a href="https://blog.ruanbekker.com/blog/2019/03/27/ship-your-logs-to-elasticsearch-with-filebeat/">this blogpost</a> to set that up.</p>

<p>The GeoIP Processor plugin is installed on elasticsearch to enrich our data with geographical information. You can check out <a href="https://blog.ruanbekker.com/blog/2018/09/12/using-the-geoip-processor-plugin-with-elasticsearch-to-enrich-your-location-based-data/">this blogpost</a> to setup geoip.</p>

<p>You can setup <a href="https://blog.ruanbekker.com/blog/2018/04/29/running-a-3-node-elasticsearch-cluster-with-docker-compose-on-your-laptop-for-testing/">Kibana and Elasticsearch on Docker</a> or setup a <a href="https://blog.ruanbekker.com/blog/2019/04/02/setup-a-5-node-highly-available-elasticsearch-cluster/">5 Node Elasticsearch Cluster</a></p>

<h2>Setup Kibana Visulizations</h2>

<p>Head over to Kibana, make sure that you have added the <code>filebeat-*</code> index patterns. If not, head over to Management -> Index Patterns -> Create Index -> Enter filebeat-* as you Index Pattern, select Next, select your @timestamp as your timestamp field, select create.</p>

<p>Now from the visualization section we will add 11 Visualizations. Everytime that you create a visualization, make sure that you select filebeat as your pattern (thats if you are using filebeat).</p>

<p>When configuring your visualization it will look like the configuration box from below:</p>

<p><img width="337" alt="image" src="https://user-images.githubusercontent.com/567298/55053831-1aeaea00-5066-11e9-93cf-edfd2ac98e44.png"></p>

<h2>Geomap: Map to see where people are connecting from</h2>

<p><img width="728" alt="kibana geomap" src="https://user-images.githubusercontent.com/567298/55258476-9cf83000-526b-11e9-8560-014098c435ee.png"></p>

<p>Select New Visualization: Coordinate Map</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics, Value: Count. 
</span><span class='line'>     Buckets, Geo Coordinates, Aggregation: Geohash, 
</span><span class='line'>     Field: nginx.access.geoip.location. </span></code></pre></td></tr></table></div></figure>


<p>Save the visualization, in my case Nginx:GeoMap:Filebeat</p>

<h2>Piechart: Cities</h2>

<p>This can give us a quick overview on the percentage of people interested in our website grouped per city.</p>

<p><img width="688" alt="image" src="https://user-images.githubusercontent.com/567298/55258529-c44efd00-526b-11e9-900a-e93ed7eed11e.png"></p>

<p>Select New Visualization, Pie</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> -&gt; Metrics: Slice Size, Aggregation: Count
</span><span class='line'> -&gt; Buckets: Split Slices, 
</span><span class='line'>    Aggregation: Terms, Field: nginx.access.geoip.city_name, 
</span><span class='line'>    Order by: metric: count, 
</span><span class='line'>    Order: Descending, Size: 20</span></code></pre></td></tr></table></div></figure>


<p>Save Visualization.</p>

<h2>Top 10 Accessed Pages</h2>

<p>Great for seeing which page is popular, and Kibana makes it easy to see which page is doing good over a specific time.</p>

<p><img width="750" alt="image" src="https://user-images.githubusercontent.com/567298/55258583-f2ccd800-526b-11e9-98b8-4f1da917cb52.png"></p>

<p>New Visualization: Vertical</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: X-Axis, Aggregation: Terms, 
</span><span class='line'>     Field: nginx.access.url, 
</span><span class='line'>     Ordery by: Metric count, 
</span><span class='line'>     Order: Descending, Size 10</span></code></pre></td></tr></table></div></figure>


<p>I would like to remove <code>/rss</code> and <code>/</code> from my results, so in the search box:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NOT (nginx.access.url:"/" OR nginx.access.url:"/rss/" OR nginx.access.url:"/subscribe/" OR nginx.access.url:*.txt)</span></code></pre></td></tr></table></div></figure>


<p>Save Visualization.</p>

<h2>Top 5 HTTP Status Codes</h2>

<p>A Grouping of Status Codes (You should see more 200&rsquo;s) but its quick to identify when 404&rsquo;s spike etc.</p>

<p><img width="692" alt="image" src="https://user-images.githubusercontent.com/567298/55258695-44756280-526c-11e9-887c-bd58e9b25750.png"></p>

<p>Select new visualization: Vertical Bar</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: X-Axis, Aggregation: Terms, 
</span><span class='line'>     Field: nginx.access.response_code, 
</span><span class='line'>     Ordery by: Metric count, 
</span><span class='line'>     Order: Descending, Size 5</span></code></pre></td></tr></table></div></figure>


<p>Save Visualization</p>

<h2>Top 404 Pages</h2>

<p>So when people are requesting pages that does not exist, it could most probably be bots trying to attack your site, or trying to gain access etc. This is a great view to see which ones are they trying and then you can handle it from there.</p>

<p><img width="699" alt="image" src="https://user-images.githubusercontent.com/567298/55259089-5b688480-526d-11e9-963d-936a61285507.png"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: X-Axis, Aggregation: Terms, 
</span><span class='line'>     Terms, Field: nginx.access.url, 
</span><span class='line'>     Order by: Metric count, 
</span><span class='line'>     Order: Descending, Size 20</span></code></pre></td></tr></table></div></figure>


<h2>Top 10 User Agents</h2>

<p>Some insights to see the top 10 browsers.</p>

<p><img width="611" alt="image" src="https://user-images.githubusercontent.com/567298/55258763-74246a80-526c-11e9-9873-da2766e4a518.png"></p>

<p>New Visualization: Data Table</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: Split Rows, 
</span><span class='line'>     Aggregation: Terms, 
</span><span class='line'>     Field: nginx.access.user_agent.name, 
</span><span class='line'>     Ordery by: Metric count, 
</span><span class='line'>     Order: Descending, Size 10</span></code></pre></td></tr></table></div></figure>


<p>Save Visualization</p>

<h2>Timeseries: Status Codes over Time</h2>

<p>With timeseries data its great to see when there was a spike in status codes, when you identify the time, you can further investigate why that happened.</p>

<p>New Visualization: Timelion</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(index=filebeat*, timefield='@timestamp', q=nginx.access.response_code:200).label('OK'), .es(index=filebeat*, timefield='@timestamp', q=nginx.access.response_code:404).label('Page Not Found')</span></code></pre></td></tr></table></div></figure>


<h2>Timeseries: Successfull Website Hits over Time</h2>

<p>This is a good view to see how your website is serving traffic over time.</p>

<p><img width="734" alt="image" src="https://user-images.githubusercontent.com/567298/55258920-eac16800-526c-11e9-85ca-5ebff8978b2b.png"></p>

<p>New Visualization: Timelion</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(index=filebeat*, timefield='@timestamp', q=nginx.access.response_code:200).label('200')</span></code></pre></td></tr></table></div></figure>


<h2>Count Metric: Website Hits</h2>

<p>A counter to see the number of website hits over time.</p>

<p><img width="606" alt="image" src="https://user-images.githubusercontent.com/567298/55258980-17757f80-526d-11e9-8664-91afda3db62c.png"></p>

<p>New Visualization: Metric</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Search Query: fields.blog_name:sysadmins AND nginx.access.response_code:200
</span><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count</span></code></pre></td></tr></table></div></figure>


<h2>Average Bytes Transferred</h2>

<p>Line chart with the amount of bandwidth being transferred.</p>

<p><img width="677" alt="image" src="https://user-images.githubusercontent.com/567298/55259036-3c69f280-526d-11e9-90fe-0853d2c0313d.png"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>New Visualization: Line
</span><span class='line'>
</span><span class='line'>-&gt; Metrics: Y-Axis, Aggregation: Average, Field: nginx.access.body_sent.bytes
</span><span class='line'>-&gt; Buckets: X-Axis, Aggregation: Date Histogram, Field: @timestamp</span></code></pre></td></tr></table></div></figure>


<h2>Tag Cloud with Most Popular Cities</h2>

<p>I&rsquo;ve used cities here, but its a nice looking visualization to group the most accessed fields. With server logs you can use this for the usernames failed in ssh attempts for example.</p>

<p><img width="646" alt="image" src="https://user-images.githubusercontent.com/567298/55259343-14c75a00-526e-11e9-88dd-7c3a3f396280.png"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Tag size, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: Tags, 
</span><span class='line'>     Aggregation: Terms, 
</span><span class='line'>     Field: nginx.access.geoip.city_name, 
</span><span class='line'>     Ordery by: Metric count, 
</span><span class='line'>     Order: Descending, Size 10</span></code></pre></td></tr></table></div></figure>


<h2>Create the Dashboard</h2>

<p>Now that we have all our visualizations, lets build the dashboard that hosts all our visualizations.</p>

<p>Select Dashboard -> Create New Dashboard -> Add -> Select your visualizations -> Reorder and Save</p>

<p>The visualizations in my dashboard looks like this:</p>

<p><img width="1266" alt="image" src="https://user-images.githubusercontent.com/567298/55418811-b8b54c00-5573-11e9-810d-d244d27c4fb3.png"></p>

<p>This is a basic dashboard but its just enough so that you can get your hands dirty and build some awesome visualizations.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a 5 Node Highly Available Elasticsearch Cluster]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/04/02/setup-a-5-node-highly-available-elasticsearch-cluster/"/>
    <updated>2019-04-02T05:05:19-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/04/02/setup-a-5-node-highly-available-elasticsearch-cluster</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/53352581-b3892f80-392b-11e9-9532-5db5cbfc8f1c.jpg" alt="elasticsearch" /></p>

<p>This is post 1 of my big collection of <strong><a href="https://blog.ruanbekker.com/blog/categories/elasticsearch-tutorials">elasticsearch-tutorials</a></strong> which includes, setup, index, management, searching, etc. More details at the bottom.</p>

<p>In this tutorial we will setup a <strong>5 node highly available elasticsearch cluster</strong> that will consist of 3 Elasticsearch Master Nodes and 2 Elasticsearch Data Nodes.</p>

<blockquote><p>&ldquo;Three master nodes is the way to start, but only if you&rsquo;re building a full cluster, which at minimum is 3 master nodes plus at least 2 data nodes.&rdquo;
 - <a href="https://discuss.elastic.co/t/should-dedicated-master-nodes-and-data-nodes-be-considered-separately/75093/14">https://discuss.elastic.co/t/should-dedicated-master-nodes-and-data-nodes-be-considered-separately/75093/14</a></p></blockquote>

<h2>The Overview:</h2>

<p>In short the responsibilites of the node types:</p>

<p><strong>Master Nodes</strong>: Master nodes are responsible for Cluster related tasks, creating / deleting indexes, tracking of nodes, allocate shards to nodes, etc.</p>

<p><strong>Data Nodes</strong>: Data nodes are responsible for hosting the actual shards that has the indexed data also handles data related operations like CRUD, search, and aggregations.</p>

<p>For more concepts of Elasticsearch, have a look at their <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-concepts.html">basic-concepts</a> documentation.</p>

<p>Our Inventory will consist of:</p>

<p><strong>Master Nodes:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Hostname: es-master-1, Private IP: 172.31.0.77
</span><span class='line'>Hostname: es-master-2, Private IP: 172.31.0.45
</span><span class='line'>Hostname: es-master-3, Private IP: 172.31.1.31</span></code></pre></td></tr></table></div></figure>


<p><strong>Data Nodes:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Hostname: es-data-1, Private IP:172.31.2.30
</span><span class='line'>Hostname: es-data-2, Private IP:172.31.0.83</span></code></pre></td></tr></table></div></figure>


<p><strong>Reserved Volumes</strong> for Data Nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>es-data-1: 10GB assigned to /dev/vdb
</span><span class='line'>es-data-2: 10GB assigned to /dev/vdb</span></code></pre></td></tr></table></div></figure>


<p><strong>Authentication:</strong></p>

<p>Note that I have configured the bind address for elasticsearch to <code>0.0.0.0</code> using <code>network.host: 0.0.0.0</code> for this demonstration, but this means that if your server has a public ip address with no firewall rules or no auth, that anyone will be able to interact with your cluster.</p>

<p>This address will also be reachable for all nodes to see each other.</p>

<p>It&rsquo;s advisable do protect your endpoint, either with <a href="https://blog.ruanbekker.com/blog/2017/08/31/secure-your-access-to-kibana-5-and-elasticsearch-5-with-nginx-for-aws/">basic auth using nginx</a> which can be found in the embedded link, or using firewall rules to protect communication from the outside (depending on your setup)</p>

<h2>Setup the Elasticsearch Master Nodes</h2>

<p>The setup below how to provision a elasticsearch master node. Repeat this on node: <code>es-master-1</code>, <code>es-master-2</code>, <code>es-master-3</code></p>

<p>Set your hosts file for name resolution (if you don&rsquo;t have private dns in place):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/hosts &lt;&lt; EOF
</span><span class='line'>127.0.0.1 localhost
</span><span class='line'>172.31.0.77 es-master-1
</span><span class='line'>172.31.0.45 es-master-2
</span><span class='line'>172.31.1.31 es-master-3
</span><span class='line'>172.31.2.30 es-data-1
</span><span class='line'>172.31.0.83 es-data-2
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Get the elasticsearch repositories, install the java development kit dependency and install elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt upgrade -y
</span><span class='line'>$ apt install software-properties-common python-software-properties apt-transport-https -y
</span><span class='line'>$ wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
</span><span class='line'>$ echo "deb https://artifacts.elastic.co/packages/6.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list
</span><span class='line'>$ apt update
</span><span class='line'>$ apt install default-jdk -y
</span><span class='line'>$ apt install elasticsearch -y</span></code></pre></td></tr></table></div></figure>


<p>The elasticsearch config, before we get to the full example config, I just want to show a snippet of how you could split up logs and data.</p>

<p>Note that you can seperate your logging between data/logs like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># example of log splitting:
</span><span class='line'>...
</span><span class='line'>path:
</span><span class='line'>  logs: /var/log/elasticsearch
</span><span class='line'>  data: /var/data/elasticsearch
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Also, your data can be divided between paths:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># example of data paths:
</span><span class='line'>...
</span><span class='line'>path:
</span><span class='line'>  data:
</span><span class='line'>    - /mnt/elasticsearch_1
</span><span class='line'>    - /mnt/elasticsearch_2
</span><span class='line'>    - /mnt/elasticsearch_3
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Bootstrap the elasticsearch config with a cluster name (all the nodes should have the same cluster name), set the nodes as master <code>node.master: true</code> disable the <code>node.data</code> and specify that the cluster should at least have a minimum of 2 master nodes before it stops. This is used to prevent split brain.</p>

<p>To avoid a split brain, this setting should be set to a quorum of master-eligible nodes:
<code>(master_eligible_nodes / 2) + 1</code></p>

<p>The full example config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/elasticsearch/elasticsearch.yml &lt;&lt; EOF
</span><span class='line'>cluster.name: es-cluster
</span><span class='line'>node.name: \${HOSTNAME}
</span><span class='line'>node.master: true
</span><span class='line'>node.data: false
</span><span class='line'>path.logs: /var/log/elasticsearch
</span><span class='line'>bootstrap.memory_lock: true
</span><span class='line'>network.host: 0.0.0.0
</span><span class='line'>discovery.zen.minimum_master_nodes: 2
</span><span class='line'>discovery.zen.ping.unicast.hosts: ["es-master-1", "es-master-2", "es-master-3"]
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Important settings for your elasticsearch cluster is described on their <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html">docs</a>:</p>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-configuration-memory.html">Disable swapping</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/file-descriptors.html">Increase file descriptors</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html">Ensure sufficient virtual memory</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/max-number-of-threads.html">Ensure sufficient threads</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/networkaddress-cache-ttl.html">JVM DNS cache settings</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/executable-jna-tmpdir.html">Temporary directory not mounted with noexec</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/default/elasticsearch &lt;&lt; EOF
</span><span class='line'>ES_STARTUP_SLEEP_TIME=5
</span><span class='line'>MAX_OPEN_FILES=65536
</span><span class='line'>MAX_LOCKED_MEMORY=unlimited
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Ensure that pages are not swapped out to disk by requesting the JVM to lock the heap in memory by setting <code>LimitMEMLOCK=infinity</code>. Set the maxiumim file descriptor number for this process: <code>LimitNOFILE</code> and increase the number of threads using <code>LimitNPROC</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /usr/lib/systemd/system/elasticsearch.service
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>LimitMEMLOCK=infinity
</span><span class='line'>LimitNOFILE=65535
</span><span class='line'>LimitNPROC=4096
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Increase the limit on the number of open files descriptors to user elasticsearch of 65536 or higher</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/security/limits.conf &lt;&lt; EOF
</span><span class='line'>elasticsearch soft memlock unlimited
</span><span class='line'>elasticsearch hard memlock unlimited
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Increase the value of the mmap counts as elasticsearch uses mmapfs directory to store its indices:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -w vm.max_map_count=262144</span></code></pre></td></tr></table></div></figure>


<p>For a permanent setting, update <code>vm.max_map_count</code> in <code>/etc/sysctl.conf</code> and run</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -p /etc/sysctl.conf </span></code></pre></td></tr></table></div></figure>


<p>Prepare the directories and set the ownership to elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /usr/share/elasticsearch/data
</span><span class='line'>$ chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data</span></code></pre></td></tr></table></div></figure>


<p>Reload the systemd daemon, enable and start elasticsearch</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl enable elasticsearch
</span><span class='line'>$ systemctl restart elasticsearch</span></code></pre></td></tr></table></div></figure>


<p>Once all 3 elasticsearch masters has been started, verify that they are listening: <code>netstat -tulpn | grep 9200</code> then look at the cluster health:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cluster/health?pretty
</span><span class='line'>{
</span><span class='line'>  "cluster_name" : "es-cluster",
</span><span class='line'>  "status" : "green",
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "number_of_nodes" : 3,
</span><span class='line'>  "number_of_data_nodes" : 0,
</span><span class='line'>  "active_primary_shards" : 0,
</span><span class='line'>  "active_shards" : 0,
</span><span class='line'>  "relocating_shards" : 0,
</span><span class='line'>  "initializing_shards" : 0,
</span><span class='line'>  "unassigned_shards" : 0,
</span><span class='line'>  "delayed_unassigned_shards" : 0,
</span><span class='line'>  "number_of_pending_tasks" : 0,
</span><span class='line'>  "number_of_in_flight_fetch" : 0,
</span><span class='line'>  "task_max_waiting_in_queue_millis" : 0,
</span><span class='line'>  "active_shards_percent_as_number" : 100.0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Have a look at the nodes, you will see that the node.role for now shows <code>mi</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/nodes?v
</span><span class='line'>ip          heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>10.163.68.8           11          80  18    0.28    0.14     0.09 mi        -      es-master-2
</span><span class='line'>10.163.68.5           14          80  14    0.27    0.18     0.11 mi        *      es-master-1
</span><span class='line'>10.163.68.4           15          79   6    0.62    0.47     0.18 mi        -      es-master-3</span></code></pre></td></tr></table></div></figure>


<h2>Setup the Elasticsearch Data Nodes</h2>

<p>Now that we have our 3 elasticsearch master nodes running, its time to provision the 2 elasticsearch data nodes. This setup needs to be repeated on both <code>es-data-1</code> and <code>es-data-2</code>.</p>

<p>Configure the hosts file for name resolution:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/hosts &lt;&lt; EOF
</span><span class='line'>127.0.0.1 localhost
</span><span class='line'>172.31.0.77 es-master-1
</span><span class='line'>172.31.0.45 es-master-2
</span><span class='line'>172.31.1.31 es-master-3
</span><span class='line'>172.31.2.30 es-data-1
</span><span class='line'>172.31.0.83 es-data-2
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Get the elasticsearch repositories, install the java development kit dependency and install elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt upgrade -y
</span><span class='line'>$ apt install software-properties-common python-software-properties apt-transport-https -y
</span><span class='line'>$ wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
</span><span class='line'>$ echo "deb https://artifacts.elastic.co/packages/6.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list
</span><span class='line'>$ apt update
</span><span class='line'>$ apt install default-jdk -y
</span><span class='line'>$ apt install elasticsearch -y</span></code></pre></td></tr></table></div></figure>


<p>Since we attached an extra disk to our data nodes, verify that you can see the disk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ lsblk
</span><span class='line'>NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
</span><span class='line'>vda    253:0    0  25G  0 disk
</span><span class='line'>└─vda1 253:1    0  25G  0 part /
</span><span class='line'>vdb    253:16   0  10G  0 disk             &lt;----</span></code></pre></td></tr></table></div></figure>


<p>Provision the block device with xfs or anything else that you prefer, create the directory where elasticsearch data will reside, change the ownership that elasticsearch has permission to write/read, set the device on startup and mount the disk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkfs.xfs /dev/vdb
</span><span class='line'>$ mkdir /data
</span><span class='line'>$ mkdir /data/nodes
</span><span class='line'>$ chown -R elasticsearch:elasticsearch /data
</span><span class='line'>$ chown -R elasticsearch:elasticsearch /data/nodes
</span><span class='line'>$ echo '/dev/vdb /data xfs defaults 0 0' &gt;&gt; /etc/fstab
</span><span class='line'>$ mount -a</span></code></pre></td></tr></table></div></figure>


<p>Verify that the disk is mounted:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>udev            994M     0  994M   0% /dev
</span><span class='line'>tmpfs           201M  3.1M  197M   2% /run
</span><span class='line'>/dev/vda1        25G  1.8G   23G   8% /
</span><span class='line'>/dev/vdb         10G   33M   10G   1% /data</span></code></pre></td></tr></table></div></figure>


<p>Bootstrap the elasticsearch config with a cluster name, set the <code>node.name</code> to an identifier, in this case I will use the servers hostname, set the <code>node.master</code> to false as this will be data nodes, also enable these nodes as data nodes: <code>node.data: true</code>, configure the <code>path.data: /data</code> to the path that we configured, etc:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/elasticsearch/elasticsearch.yml &lt;&lt; EOF
</span><span class='line'>cluster.name: es-cluster
</span><span class='line'>node.name: \${HOSTNAME}
</span><span class='line'>node.master: false
</span><span class='line'>node.data: true
</span><span class='line'>path.data: /data
</span><span class='line'>path.logs: /var/log/elasticsearch
</span><span class='line'>bootstrap.memory_lock: true
</span><span class='line'>network.host: 0.0.0.0
</span><span class='line'>discovery.zen.minimum_master_nodes: 2
</span><span class='line'>discovery.zen.ping.unicast.hosts: ["es-master-1", "es-master-2", "es-master-3"]
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Set a couple of important settings for your elasticsearch cluster is described on their <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html">docs</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/default/elasticsearch &lt;&lt; EOF
</span><span class='line'>ES_STARTUP_SLEEP_TIME=5
</span><span class='line'>MAX_OPEN_FILES=65536
</span><span class='line'>MAX_LOCKED_MEMORY=unlimited
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Disable swapping, increase the file descriptors and increase the maximum number of threads:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /usr/lib/systemd/system/elasticsearch.service
</span><span class='line'>[Service]
</span><span class='line'>LimitMEMLOCK=infinity
</span><span class='line'>LimitNOFILE=65535
</span><span class='line'>LimitNPROC=4096</span></code></pre></td></tr></table></div></figure>


<p>Also update them via limits.conf:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/security/limits.conf &lt;&lt; EOF
</span><span class='line'>elasticsearch soft memlock unlimited
</span><span class='line'>elasticsearch hard memlock unlimited
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Reload the systemd daemon, enable and start elasticsearch. Allow it to start and check if the ports are listening with <code>netstat -tulpn | grep 9200</code>, then:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl enable elasticsearch
</span><span class='line'>$ systemctl restart elasticsearch</span></code></pre></td></tr></table></div></figure>


<p>Verify that everything works as expected, look at the cluster health and look at the status and number of nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cluster/health?pretty
</span><span class='line'>{
</span><span class='line'>  "cluster_name" : "es-cluster",
</span><span class='line'>  "status" : "green",
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "number_of_nodes" : 5,
</span><span class='line'>  "number_of_data_nodes" : 2,
</span><span class='line'>  "active_primary_shards" : 0,
</span><span class='line'>  "active_shards" : 0,
</span><span class='line'>  "relocating_shards" : 0,
</span><span class='line'>  "initializing_shards" : 0,
</span><span class='line'>  "unassigned_shards" : 0,
</span><span class='line'>  "delayed_unassigned_shards" : 0,
</span><span class='line'>  "number_of_pending_tasks" : 0,
</span><span class='line'>  "number_of_in_flight_fetch" : 0,
</span><span class='line'>  "task_max_waiting_in_queue_millis" : 0,
</span><span class='line'>  "active_shards_percent_as_number" : 100.0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Look at the nodes api and you will see that we now have the extra 2 nodes showing up on <code>node.role</code> as <code>di</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/nodes?v
</span><span class='line'>ip           heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>10.163.68.7             9          96   6    0.12    0.11     0.03 di        -      es-data-2
</span><span class='line'>10.163.68.5            10          80   2    0.20    0.09     0.08 mi        *      es-master-1
</span><span class='line'>10.163.68.11           12          96   9    0.12    0.09     0.03 di        -      es-data-1
</span><span class='line'>10.163.68.4            10          79   0    0.00    0.12     0.11 mi        -      es-master-3
</span><span class='line'>10.163.68.8            12          79   1    0.05    0.06     0.07 mi        -      es-master-2</span></code></pre></td></tr></table></div></figure>


<h2>Interact with Elasticsearch</h2>

<p>Let&rsquo;s interact with elasticsearch, the overview:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200
</span><span class='line'>{
</span><span class='line'>  "name" : "es-data-1",
</span><span class='line'>  "cluster_name" : "es-cluster",
</span><span class='line'>  "cluster_uuid" : "5BLs4sxsSEK-4OxlGnmlmw",
</span><span class='line'>  "version" : {
</span><span class='line'>    "number" : "6.7.0",
</span><span class='line'>    "build_flavor" : "default",
</span><span class='line'>    "build_type" : "deb",
</span><span class='line'>    "build_hash" : "8453f77",
</span><span class='line'>    "build_date" : "2019-03-21T15:32:29.844721Z",
</span><span class='line'>    "build_snapshot" : false,
</span><span class='line'>    "lucene_version" : "7.7.0",
</span><span class='line'>    "minimum_wire_compatibility_version" : "5.6.0",
</span><span class='line'>    "minimum_index_compatibility_version" : "5.0.0"
</span><span class='line'>  },
</span><span class='line'>  "tagline" : "You Know, for Search"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s look at the Health API:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/health?v
</span><span class='line'>epoch      timestamp cluster    status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent
</span><span class='line'>1554154652 21:37:32  es-cluster green           5         2     10   5    0    0        0             0                  -                100.0%</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s ingest some data into elasticsearch, we will create an index named <code>first-index</code> with some dummy data about people, username, name, surname, location and hobbies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://127.0.0.1:9200/first-index/docs/ -d '{"username": "mikes", "name": "mike", "surname": "steyn", "location": {"country": "south africa", "city": "cape town"}, "hobbies": ["sport", "coffee"]}'
</span><span class='line'>
</span><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://127.0.0.1:9200/first-index/docs/ -d '{"username": "clarissas", "name": "clarissa", "surname": "smith", "location": {"country": "ireland", "city": "dublin"}, "hobbies": ["shopping", "reading", "chess"]}'
</span><span class='line'>
</span><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://127.0.0.1:9200/first-index/docs/ -d '{"username": "franka", "name": "frank", "surname": "adams", "location": {"country": "new zealand", "city": "auckland"}, "hobbies": ["programming", "swimming", "rugby"]}'</span></code></pre></td></tr></table></div></figure>


<p>Now that we ingested our data into elasticsearch, lets have a look at the Indices API, where the number of documents, size etc should reflect:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/indices?v
</span><span class='line'>health status index       uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   first-index 1o6yM7tCSqagqoeihKM7_g   5   1          3            0     40.6kb         20.3kb</span></code></pre></td></tr></table></div></figure>


<p>Now lets request a search, which will give you by default 10 returned documents:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/first-index/_search?pretty
</span><span class='line'>{
</span><span class='line'>  "took" : 116,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 3,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "first-index",
</span><span class='line'>        "_type" : "docs",
</span><span class='line'>        "_id" : "-NTO2mkB8pugP4aC2jtZ",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "username" : "mikes",
</span><span class='line'>          "name" : "mike",
</span><span class='line'>          "surname" : "steyn",
</span><span class='line'>          "location" : {
</span><span class='line'>            "country" : "south africa",
</span><span class='line'>            "city" : "cape town"
</span><span class='line'>          },
</span><span class='line'>          "hobbies" : [
</span><span class='line'>            "sport",
</span><span class='line'>            "coffee"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "_index" : "first-index",
</span><span class='line'>        "_type" : "docs",
</span><span class='line'>        "_id" : "-tTR2mkB8pugP4aCAzvG",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "username" : "franka",
</span><span class='line'>          "name" : "frank",
</span><span class='line'>          "surname" : "adams",
</span><span class='line'>          "location" : {
</span><span class='line'>            "country" : "new zealand",
</span><span class='line'>            "city" : "auckland"
</span><span class='line'>          },
</span><span class='line'>          "hobbies" : [
</span><span class='line'>            "programming",
</span><span class='line'>            "swimming",
</span><span class='line'>            "rugby"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "_index" : "first-index",
</span><span class='line'>        "_type" : "docs",
</span><span class='line'>        "_id" : "-dTP2mkB8pugP4aC1ztI",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "username" : "clarissas",
</span><span class='line'>          "name" : "clarissa",
</span><span class='line'>          "surname" : "smith",
</span><span class='line'>          "location" : {
</span><span class='line'>            "country" : "ireland",
</span><span class='line'>            "city" : "dublin"
</span><span class='line'>          },
</span><span class='line'>          "hobbies" : [
</span><span class='line'>            "shopping",
</span><span class='line'>            "reading",
</span><span class='line'>            "chess"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s have a look at our shards using the Shards API, you will also see where each document is assigned to a specific shard, and also if its a primary or replica shard:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/shards?v
</span><span class='line'>index       shard prirep state   docs store ip           node
</span><span class='line'>first-index 4     p      STARTED    0  230b 10.163.68.7  es-data-2
</span><span class='line'>first-index 4     r      STARTED    0  230b 10.163.68.11 es-data-1
</span><span class='line'>first-index 2     p      STARTED    0  230b 10.163.68.7  es-data-2
</span><span class='line'>first-index 2     r      STARTED    0  230b 10.163.68.11 es-data-1
</span><span class='line'>first-index 3     r      STARTED    1 6.6kb 10.163.68.7  es-data-2
</span><span class='line'>first-index 3     p      STARTED    1 6.6kb 10.163.68.11 es-data-1
</span><span class='line'>first-index 1     r      STARTED    2  13kb 10.163.68.7  es-data-2
</span><span class='line'>first-index 1     p      STARTED    2  13kb 10.163.68.11 es-data-1
</span><span class='line'>first-index 0     p      STARTED    0  230b 10.163.68.7  es-data-2
</span><span class='line'>first-index 0     r      STARTED    0  230b 10.163.68.11 es-data-1</span></code></pre></td></tr></table></div></figure>


<p>Then we can also use the Allocation API to see the size of our indices, disk space per node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/allocation?v
</span><span class='line'>shards disk.indices disk.used disk.avail disk.total disk.percent host         ip           node
</span><span class='line'>     5       20.3kb    32.4mb      9.9gb      9.9gb            0 10.163.68.11 10.163.68.11 es-data-1
</span><span class='line'>     5       20.3kb    32.4mb      9.9gb      9.9gb            0 10.163.68.7  10.163.68.7  es-data-2</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s search for anyone with the surname <code>smith</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s http://127.0.0.1:9200/first-index/_search?q=surname=smith | jq .
</span><span class='line'>{
</span><span class='line'>  "took": 22,
</span><span class='line'>  "timed_out": false,
</span><span class='line'>  "_shards": {
</span><span class='line'>    "total": 5,
</span><span class='line'>    "successful": 5,
</span><span class='line'>    "skipped": 0,
</span><span class='line'>    "failed": 0
</span><span class='line'>  },
</span><span class='line'>  "hits": {
</span><span class='line'>    "total": 1,
</span><span class='line'>    "max_score": 0.2876821,
</span><span class='line'>    "hits": [
</span><span class='line'>      {
</span><span class='line'>        "_index": "first-index",
</span><span class='line'>        "_type": "docs",
</span><span class='line'>        "_id": "-dTP2mkB8pugP4aC1ztI",
</span><span class='line'>        "_score": 0.2876821,
</span><span class='line'>        "_source": {
</span><span class='line'>          "username": "clarissas",
</span><span class='line'>          "name": "clarissa",
</span><span class='line'>          "surname": "smith",
</span><span class='line'>          "location": {
</span><span class='line'>            "country": "ireland",
</span><span class='line'>            "city": "dublin"
</span><span class='line'>          },
</span><span class='line'>          "hobbies": [
</span><span class='line'>            "shopping",
</span><span class='line'>            "reading",
</span><span class='line'>            "chess"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s search for anyone with <code>rugby</code> as one of their hobbies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s http://127.0.0.1:9200/first-index/_search?q=hobbies=rugby | jq .
</span><span class='line'>{
</span><span class='line'>  "took": 23,
</span><span class='line'>  "timed_out": false,
</span><span class='line'>  "_shards": {
</span><span class='line'>    "total": 5,
</span><span class='line'>    "successful": 5,
</span><span class='line'>    "skipped": 0,
</span><span class='line'>    "failed": 0
</span><span class='line'>  },
</span><span class='line'>  "hits": {
</span><span class='line'>    "total": 1,
</span><span class='line'>    "max_score": 0.64072424,
</span><span class='line'>    "hits": [
</span><span class='line'>      {
</span><span class='line'>        "_index": "first-index",
</span><span class='line'>        "_type": "docs",
</span><span class='line'>        "_id": "-tTR2mkB8pugP4aCAzvG",
</span><span class='line'>        "_score": 0.64072424,
</span><span class='line'>        "_source": {
</span><span class='line'>          "username": "franka",
</span><span class='line'>          "name": "frank",
</span><span class='line'>          "surname": "adams",
</span><span class='line'>          "location": {
</span><span class='line'>            "country": "new zealand",
</span><span class='line'>            "city": "auckland"
</span><span class='line'>          },
</span><span class='line'>          "hobbies": [
</span><span class='line'>            "programming",
</span><span class='line'>            "swimming",
</span><span class='line'>            "rugby"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>More on Elasticsearch</h2>

<p>I am planning to write up <strong>elasticsearch</strong> articles on the following topics:</p>

<ul>
<li><a href="">Setting up a 5 Node HA Elasticsearch Cluster</a></li>
<li>Indexes / Replicas</li>
<li>Search Queries</li>
<li>Delete Queries</li>
<li>Elasticsearch Snapshots and Restores on S3</li>
<li>Mapping Templates</li>
<li>Resizing Index Shards</li>
<li>Dealing with Old Timeseries Data</li>
<li>Elasticsearch Percentiles</li>
<li>Managing Yellow and Red Status Clusters</li>
<li>Managing High JVM Memory Pressure</li>
<li>and more</li>
</ul>


<p>As I finish up the writing of these posts they will be published under the <a href="https://blog.ruanbekker.com/blog/categories/elasticsearch-tutorials">#elasticsearch-tutorials</a> category on my blog and for any other elasticsearch tutorials, you can find them under the <a href="https://blog.ruanbekker.com/blog/categories/elasticsearch">#elasticsearch</a> category.</p>

<p>Oke byyyyyye :D</p>

<h2>Resources</h2>

<ul>
<li><a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch Docs</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Snippet: Create Custom CloudWatch Metrics With Python]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/28/snippet-create-custom-cloudwatch-metrics-with-python/"/>
    <updated>2019-03-28T08:05:28-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/28/snippet-create-custom-cloudwatch-metrics-with-python</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/53865781-a984c200-3ff8-11e9-9ffa-ccad62ac08f6.png" alt="" /></p>

<p>A quick post on how create custom CloudWatch Metrics using Python on AWS.</p>

<p>After you produced the metrics into CloudWatch, you will be able to see them when navigating to:</p>

<ul>
<li>CloudWatch / Metrics / Custom Namespaces / statusdash/ec2client</li>
</ul>


<p>When selecting:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Select Metric: SomeKey1, SomeKey2
</span><span class='line'>Select MetricName HttpResponseTime</span></code></pre></td></tr></table></div></figure>


<p>And should look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/53865426-d4224b00-3ff7-11e9-8bd5-bd04dfdd9f43.png" alt="" /></p>

<h2>The Script:</h2>

<p>The python script that will be using boto3 to talk to AWS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="n">cloudwatch</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;cloudwatch&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">cloudwatch</span><span class="o">.</span><span class="n">put_metric_data</span><span class="p">(</span>
</span><span class='line'><span class="n">MetricData</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;MetricName&#39;</span><span class="p">:</span> <span class="s">&#39;HttpResponseTime&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;Dimensions&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="s">&#39;Server&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="s">&#39;app.example.com&#39;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="s">&#39;Client&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="s">&#39;Client-ABC&#39;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="s">&#39;Unit&#39;</span><span class="p">:</span> <span class="s">&#39;Milliseconds&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">],</span>
</span><span class='line'><span class="n">Namespace</span> <span class="o">=</span> <span class="s">&#39;statusdash/ec2client&#39;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">response</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<p><a href="https://stackify.com/custom-metrics-aws-lambda/">https://stackify.com/custom-metrics-aws-lambda/</a>
<a href="https://www.syntouch.nl/custom-cloudwatch-metrics-in-python-yes-we-can/">https://www.syntouch.nl/custom-cloudwatch-metrics-in-python-yes-we-can/</a> &lt;- psutil
<a href="https://aws.amazon.com/blogs/devops/new-how-to-better-monitor-your-custom-application-metrics-using-amazon-cloudwatch-agent/">https://aws.amazon.com/blogs/devops/new-how-to-better-monitor-your-custom-application-metrics-using-amazon-cloudwatch-agent/</a>
<a href="https://medium.com/@mrdoro/aws-lambda-as-the-website-monitoring-tool-184b09202ae2">https://medium.com/@mrdoro/aws-lambda-as-the-website-monitoring-tool-184b09202ae2</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Concourse Pipeline to Build a Docker Image Automatically on Git Commit]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/27/concourse-pipeline-to-build-a-docker-image-automatically-on-git-commit/"/>
    <updated>2019-03-27T17:50:54-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/27/concourse-pipeline-to-build-a-docker-image-automatically-on-git-commit</id>
    <content type="html"><![CDATA[<p><img src="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495" alt="" /></p>

<p>In this tutorial we will build a ci pipeline using concourse to build and push a image to dockerhub automatically, whenever a new git commit is made to the master branch.</p>

<h2>Our Project Setup</h2>

<p>Our Directory Tree:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>find .
</span><span class='line'>./Dockerfile
</span><span class='line'>./ci
</span><span class='line'>./ci/pipeline.yml
</span><span class='line'>./README.md
</span><span class='line'>./docker-tunnel
</span></code></pre></td></tr></table></div></figure>


<p>The project used in this example is not important, but you can check it out at <a href="https://github.com/ruanbekker/docker-remote-tunnel">https://github.com/ruanbekker/docker-remote-tunnel</a></p>

<h2>Our Pipeline</h2>

<p>A visual to see how the pipeline will look like in concourse:</p>

<p><img src="https://user-images.githubusercontent.com/567298/55114996-1832d800-50ec-11e9-85ef-bc283711fbde.png" alt="" /></p>

<p>Our pipeline definition will consist of 3 resources, <code>github repo</code>, <code>dockerhub image</code> and a <code>slack resource</code> to inform use whether a build has completed.</p>

<p>Then we are specifying that the job should be triggered on a git commit for the master branch, build and push to our dockerhub repo.</p>

<p>Our pipeline definition <code>ci/pipeline.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git</span>
</span><span class='line'>  <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">uri</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git@github.com:ruanbekker/docker-remote-tunnel.git</span>
</span><span class='line'>    <span class="l-Scalar-Plain">branch</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">master</span>
</span><span class='line'>    <span class="l-Scalar-Plain">private_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">((github_private_key))</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-remote-tunnel-image</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>  <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ruanbekker/docker-remote-tunnel</span>
</span><span class='line'>    <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>    <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">((dockerhub_user))</span>
</span><span class='line'>    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">((dockerhub_password))</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-notification</span>
</span><span class='line'>  <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">((slack_notification_url))</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource_types</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-notification</span>
</span><span class='line'>    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>    <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cfcommunity/slack-notification-resource</span>
</span><span class='line'>      <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1.3.0</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">build-cached-image</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">get</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>    <span class="l-Scalar-Plain">trigger</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">build-cached-image-workspace</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbekker87/build-tools</span>
</span><span class='line'>
</span><span class='line'>      <span class="l-Scalar-Plain">outputs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">workspace</span>
</span><span class='line'>      <span class="l-Scalar-Plain">inputs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/bin/sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">-c</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">output_dir=workspace</span>
</span><span class='line'>
</span><span class='line'>          <span class="no">cat &lt;&lt; EOF &gt; &quot;${output_dir}/Dockerfile&quot;</span>
</span><span class='line'>          <span class="no">FROM alpine</span>
</span><span class='line'>
</span><span class='line'>          <span class="no">ADD git-repo /tmp/git-repo</span>
</span><span class='line'>          <span class="no">RUN mv /tmp/git-repo/docker-tunnel /usr/bin/docker-tunnel</span>
</span><span class='line'>          <span class="no">RUN apk --no-cache add screen docker openssl openssh-client apache2-utils</span>
</span><span class='line'>          <span class="no">RUN /usr/bin/docker-tunnel -h</span>
</span><span class='line'>          <span class="no">RUN rm -rf /tmp/git-repo</span>
</span><span class='line'>          <span class="no">EOF</span>
</span><span class='line'>
</span><span class='line'>          <span class="no">cp -R ./git-repo &quot;${output_dir}/git-repo&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-remote-tunnel-image</span>
</span><span class='line'>    <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">workspace</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">on_failure</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>      <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">channel</span><span class="p-Indicator">:</span> <span class="s">&#39;#system_events&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;concourse&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">icon_emoji</span><span class="p-Indicator">:</span> <span class="s">&#39;:concourse:&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="l-Scalar-Plain">text</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>            <span class="no">*$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* ($BUILD_NAME) FAILED to build image</span>
</span><span class='line'>            <span class="no">https://ci.domain.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME</span>
</span><span class='line'>    <span class="l-Scalar-Plain">on_success</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>      <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">channel</span><span class="p-Indicator">:</span> <span class="s">&#39;#system_events&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;concourse&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">icon_emoji</span><span class="p-Indicator">:</span> <span class="s">&#39;:concourse:&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="l-Scalar-Plain">text</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>            <span class="no">*$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* ($BUILD_NAME) SUCCESS - Image has been published</span>
</span><span class='line'>            <span class="no">https://ci.domain.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">get</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-remote-tunnel-image</span>
</span><span class='line'>    <span class="l-Scalar-Plain">passed</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">build-cached-image</span><span class="p-Indicator">]</span>
</span><span class='line'>    <span class="l-Scalar-Plain">trigger</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">get</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>    <span class="l-Scalar-Plain">passed</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">build-cached-image</span><span class="p-Indicator">]</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">run-tests</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-remote-tunnel-image</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">inputs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">dir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/usr/bin/docker-tunnel</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--help</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">on_failure</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>      <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">channel</span><span class="p-Indicator">:</span> <span class="s">&#39;#system_events&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;concourse&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">icon_emoji</span><span class="p-Indicator">:</span> <span class="s">&#39;:concourse:&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="l-Scalar-Plain">text</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>            <span class="no">*$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* ($BUILD_NAME) FAILED - Testing image failure</span>
</span><span class='line'>            <span class="no">https://ci.domain.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME</span>
</span><span class='line'>    <span class="l-Scalar-Plain">on_success</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>      <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">channel</span><span class="p-Indicator">:</span> <span class="s">&#39;#system_events&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;concourse&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">icon_emoji</span><span class="p-Indicator">:</span> <span class="s">&#39;:concourse:&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="l-Scalar-Plain">text</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>            <span class="no">*$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* ($BUILD_NAME) SUCCESS - Testing image Succeeded</span>
</span><span class='line'>            <span class="no">https://ci.domain.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that our secret information is templatized and saved in our local <code>credentials.yml</code> which should never be stored in version control:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">slack_notification_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://api.slack.com/aaa/bbb/ccc</span>
</span><span class='line'><span class="l-Scalar-Plain">dockerhub_user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myuser</span>
</span><span class='line'><span class="l-Scalar-Plain">dockerhub_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mypasswd</span>
</span><span class='line'><span class="l-Scalar-Plain">github_private_key</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
</span><span class='line'>        <span class="no">-----BEGIN RSA PRIVATE KEY-----</span>
</span><span class='line'>        <span class="no">some-secret-data</span>
</span><span class='line'>        <span class="no">-----END RSA PRIVATE KEY------</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Set the Pipeline:</h2>

<p>Now that we have our pipeline definition, credentials and application code (stored in version control), go ahead and set the pipeline, which will save the pipeline configuration in concourse:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># pipeline name: my-docker-app-pipeline</span>
</span><span class='line'><span class="nv">$ </span>fly -t scw sp -n main -c pipeline.yml -p my-docker-app-pipeline -l credentials.yml
</span></code></pre></td></tr></table></div></figure>


<p>Now the pipeline is saved on concourse but in a paused state, go ahead and unpause the pipeline:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t scw up -p my-docker-app-pipeline
</span></code></pre></td></tr></table></div></figure>


<h2>Test your Pipeline</h2>

<p>Make a commit to master and head over to concourse and look at it go:</p>

<p><img src="https://user-images.githubusercontent.com/567298/55116018-a5772c00-50ee-11e9-861e-a5ddc74550e2.png" alt="" /></p>

<p>Thanks for reading, make sure to check out my other posts on <a href="https://blog.ruanbekker.com/blog/categories/concourse">#concourse</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ship Your Logs to Elasticsearch With Filebeat]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/27/ship-your-logs-to-elasticsearch-with-filebeat/"/>
    <updated>2019-03-27T10:52:21-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/27/ship-your-logs-to-elasticsearch-with-filebeat</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/55086561-4b0baa80-50b1-11e9-8062-a9e6de5ab56a.png" alt="" /></p>

<p><strong><a href="https://www.elastic.co/guide/en/beats/filebeat/6.7/filebeat-overview.html">Filebeat</a></strong> by Elastic is a lightweight log shipper, that ships your logs to Elastic products such as Elasticsearch and Logstash. Filbeat monitors the logfiles from the given configuration and ships the to the locations that is specified.</p>

<h2>Filebeat Overview</h2>

<p>Filebeat runs as agents, monitors your logs and ships them in response of events, or whenever the logfile receives data.</p>

<p>Below is a overview (credit: elastic.co) how Filebeat works</p>

<p><img src="https://user-images.githubusercontent.com/567298/55086346-e18b9c00-50b0-11e9-8eac-ea4880cb1aff.png" alt="" /></p>

<h2>Installing Filebeat</h2>

<p>Let&rsquo;s go ahead and install Filebeat. I will be using version 6.7 as that will be the same version that I am running on my Elasticsearch. To check the version of your elasticsearch cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://127.0.0.1:9200/_cluster/health?pretty <span class="c"># i have es running locally</span>
</span></code></pre></td></tr></table></div></figure>


<p>Install the dependencies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install wget apt-transport-https -y
</span></code></pre></td></tr></table></div></figure>


<p>Get the public signing key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch <span class="p">|</span> sudo apt-key add -
</span></code></pre></td></tr></table></div></figure>


<p>Get the repository definition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;deb https://artifacts.elastic.co/packages/6.x/apt stable main&quot;</span> <span class="p">|</span> tee -a /etc/apt/sources.list.d/elastic-6.x.list
</span></code></pre></td></tr></table></div></figure>


<p>Update the repositories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span></code></pre></td></tr></table></div></figure>


<p>Install Filebeat and enable the service on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install filebeat -y
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>filebeat
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Filebeat</h2>

<p>Let&rsquo;s configure our main configuration in filebeat, to specify our location where the data should be shipped to (in this case elasticsearch) and I will also like to set some extra fields that will apply to this specific server.</p>

<p>Open up <code>/etc/filebeat/filebeat.yml</code> and edit the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">filebeat.inputs</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">log</span>
</span><span class='line'>  <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>  <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/log/nginx/*.log</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">filebeat.config.modules</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">${path.config}/modules.d/*.yml</span>
</span><span class='line'>  <span class="l-Scalar-Plain">reload.enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">setup.template.settings</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">index.number_of_shards</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">fields</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">blog_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sysadmins</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webserver</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cloud_provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">setup.kibana</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="s">&quot;http://localhost:5601&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&quot;elastic&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&quot;changeme&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">output.elasticsearch</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;localhost:9200&quot;</span><span class="p-Indicator">]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="s">&quot;http&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&quot;elastic&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&quot;changeme&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Above, just setting my path to nginx access logs, some extra fields, including that it shoulds seed kibana with example visualizations and the output configuration of elasticsearch.</p>

<h2>Filebeat Modules</h2>

<p>Filebeat comes with modules that has context on specific applications like nginx, mysql etc. Lets enable system (syslog, auth, etc) and nginx for our web server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>filebeat modules <span class="nb">enable </span>system
</span><span class='line'><span class="nv">$ </span>filebeat modules <span class="nb">enable </span>nginx
</span></code></pre></td></tr></table></div></figure>


<p>Example of my <code>/etc/filebeat/modules.d/system.yml</code> configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">system</span>
</span><span class='line'>  <span class="l-Scalar-Plain">syslog</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var.paths</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;/var/log/syslog&quot;</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">auth</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var.paths</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;/var/log/auth.log&quot;</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Example of my <code>/etc/filebeat/modules.d/nginx.yml</code> configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>  <span class="l-Scalar-Plain">access</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var.paths</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;/var/log/nginx/access.log&quot;</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">error</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var.paths</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;/var/log/nginx/error.log&quot;</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now setup the <a href="https://www.elastic.co/guide/en/beats/filebeat/6.7/filebeat-template.html">templates</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>filebeat setup
</span></code></pre></td></tr></table></div></figure>


<p>Then restart filebeat:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/etc/init.d/filebeat restart
</span></code></pre></td></tr></table></div></figure>


<p>You can have a look at the logs, should you need to debug:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tail -f /var/log/filebeat/filebeat
</span></code></pre></td></tr></table></div></figure>


<p>Your data should now be shipped to elasticsearch, by default under the <code>filebeat-YYYY.mm.dd</code> index pattern.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl <span class="s1">&#39;http://127.0.0.1:9200/_cat/indices/filebeat*?v&#39;</span>
</span><span class='line'>health status index                     uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   filebeat-6.7.1-2019.03.27 CBdV7adjRKypN1wguwuHDA   <span class="m">3</span>   <span class="m">1</span>     <span class="m">453220</span>            <span class="m">0</span>    230.2mb        115.9mb
</span></code></pre></td></tr></table></div></figure>


<h2>Kibana</h2>

<p>You can head over to Kibana at <a href="http://localhost:5601">http://localhost:5601</a> (in this case) to visualize the data that is ingested into your filebeat index. I will write a tutorial on how to graph up most common dashboards later this week.</p>

<p>Thats it for now :D</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/guide/en/beats/filebeat/6.7/index.html">https://www.elastic.co/guide/en/beats/filebeat/6.7/index.html</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Deploy a Docker Swarm Cluster on Scaleway With Terraform]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/21/how-to-deploy-a-docker-swarm-cluster-on-scaleway-with-terraform/"/>
    <updated>2019-03-21T02:15:07-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/21/how-to-deploy-a-docker-swarm-cluster-on-scaleway-with-terraform</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/54737111-09fa2e80-4bb7-11e9-97f4-a94a31fc9a3a.png" alt="" /></p>

<p>We will deploy a 3 node docker swarm cluster with terraform on scaleway. I have used the base source code from <a href="https://github.com/stefanprodan/scaleway-swarm-terraform">this</a> repository but tweaked the configuration to my needs.</p>

<h2>Pre-Requisites</h2>

<p>Ensure terraform and jq is instaled:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install terraform
</span><span class='line'><span class="nv">$ </span>brew install jq
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform</h2>

<p>You can have a look at the linked source at the top for the source code, but below I will provide each file that will make up our terraform deployment.</p>

<p>Ource <code>main.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>provider <span class="s2">&quot;scaleway&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">region</span> <span class="o">=</span> <span class="s2">&quot;${var.region}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;scaleway_bootscript&quot;</span> <span class="s2">&quot;debian&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">architecture</span> <span class="o">=</span> <span class="s2">&quot;x86_64&quot;</span>
</span><span class='line'>  <span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;x86_64 mainline 4.15.11 rev1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;scaleway_image&quot;</span> <span class="s2">&quot;debian_stretch&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">architecture</span> <span class="o">=</span> <span class="s2">&quot;x86_64&quot;</span>
</span><span class='line'>  <span class="nv">name</span>         <span class="o">=</span> <span class="s2">&quot;Debian Stretch&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;template_file&quot;</span> <span class="s2">&quot;docker_conf&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">template</span> <span class="o">=</span> <span class="s2">&quot;${file(&quot;</span>conf/docker.tpl<span class="s2">&quot;)}&quot;</span>
</span><span class='line'>
</span><span class='line'>  vars <span class="o">{</span>
</span><span class='line'>    <span class="nv">ip</span> <span class="o">=</span> <span class="s2">&quot;${var.docker_api_ip}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>outputs.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>output <span class="s2">&quot;swarm_manager_public_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;swarm_manager_private_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_server.swarm_manager.0.private_ip}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;swarm_workers_public_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${concat(scaleway_server.swarm_worker.*.name, scaleway_server.swarm_worker.*.public_ip)}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;swarm_workers_private_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${concat(scaleway_server.swarm_worker.*.name, scaleway_server.swarm_worker.*.private_ip)}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;workspace&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${terraform.workspace}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>security-groups.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;scaleway_security_group&quot;</span> <span class="s2">&quot;swarm_managers&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>        <span class="o">=</span> <span class="s2">&quot;swarm_managers&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;Allow HTTP/S and SSH traffic&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;ssh_accept&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 22
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;http_accept&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 80
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;https_accept&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 443
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group&quot;</span> <span class="s2">&quot;swarm_workers&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>        <span class="o">=</span> <span class="s2">&quot;swarm_workers&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;Allow SSH traffic&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;ssh_accept_workers&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_workers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 22
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>variables.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>variable <span class="s2">&quot;docker_version&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;18.06.3~ce~3-0~debian&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;region&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;ams1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;manager_instance_type&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;START1-M&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;worker_instance_type&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;START1-M&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;worker_instance_count&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> 2
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;docker_api_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>managers.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;scaleway_ip&quot;</span> <span class="s2">&quot;swarm_manager_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span> <span class="o">=</span> 1
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_server&quot;</span> <span class="s2">&quot;swarm_manager&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>          <span class="o">=</span> 1
</span><span class='line'>  <span class="nv">name</span>           <span class="o">=</span> <span class="s2">&quot;${terraform.workspace}-manager-${count.index + 1}&quot;</span>
</span><span class='line'>  <span class="nv">image</span>          <span class="o">=</span> <span class="s2">&quot;${data.scaleway_image.debian_stretch.id}&quot;</span>
</span><span class='line'>  <span class="nb">type</span>           <span class="o">=</span> <span class="s2">&quot;${var.manager_instance_type}&quot;</span>
</span><span class='line'>  <span class="nv">bootscript</span>     <span class="o">=</span> <span class="s2">&quot;${data.scaleway_bootscript.debian.id}&quot;</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>  <span class="nv">public_ip</span>      <span class="o">=</span> <span class="s2">&quot;${element(scaleway_ip.swarm_manager_ip.*.ip, count.index)}&quot;</span>
</span><span class='line'>
</span><span class='line'>  volume <span class="o">{</span>
</span><span class='line'>    <span class="nv">size_in_gb</span> <span class="o">=</span> 50
</span><span class='line'>    <span class="nb">type</span>       <span class="o">=</span> <span class="s2">&quot;l_ssd&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">script</span> <span class="o">=</span> <span class="s2">&quot;scripts/mount-disk.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  connection <span class="o">{</span>
</span><span class='line'>    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>    <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="nv">private_key</span> <span class="o">=</span> <span class="s2">&quot;${file(&quot;</span>~/.ssh/id_rsa<span class="s2">&quot;)}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;mkdir -p /etc/systemd/system/docker.service.d&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">content</span>     <span class="o">=</span> <span class="s2">&quot;${data.template_file.docker_conf.rendered}&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/etc/systemd/system/docker.service.d/docker.conf&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/install-docker-ce.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/install-docker-ce.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/local-persist-plugin.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/install-docker-ce.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/install-docker-ce.sh ${var.docker_version}&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;docker swarm init --advertise-addr ${self.private_ip}&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/local-persist-plugin.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>workers.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;scaleway_ip&quot;</span> <span class="s2">&quot;swarm_worker_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span> <span class="o">=</span> <span class="s2">&quot;${var.worker_instance_count}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_server&quot;</span> <span class="s2">&quot;swarm_worker&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>          <span class="o">=</span> <span class="s2">&quot;${var.worker_instance_count}&quot;</span>
</span><span class='line'>  <span class="nv">name</span>           <span class="o">=</span> <span class="s2">&quot;${terraform.workspace}-worker-${count.index + 1}&quot;</span>
</span><span class='line'>  <span class="nv">image</span>          <span class="o">=</span> <span class="s2">&quot;${data.scaleway_image.debian_stretch.id}&quot;</span>
</span><span class='line'>  <span class="nb">type</span>           <span class="o">=</span> <span class="s2">&quot;${var.worker_instance_type}&quot;</span>
</span><span class='line'>  <span class="nv">bootscript</span>     <span class="o">=</span> <span class="s2">&quot;${data.scaleway_bootscript.debian.id}&quot;</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_workers.id}&quot;</span>
</span><span class='line'>  <span class="nv">public_ip</span>      <span class="o">=</span> <span class="s2">&quot;${element(scaleway_ip.swarm_worker_ip.*.ip, count.index)}&quot;</span>
</span><span class='line'>
</span><span class='line'>  volume <span class="o">{</span>
</span><span class='line'>    <span class="nv">size_in_gb</span> <span class="o">=</span> 50
</span><span class='line'>    <span class="nb">type</span>       <span class="o">=</span> <span class="s2">&quot;l_ssd&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">script</span> <span class="o">=</span> <span class="s2">&quot;scripts/mount-disk.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  connection <span class="o">{</span>
</span><span class='line'>    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>    <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="nv">private_key</span> <span class="o">=</span> <span class="s2">&quot;${file(&quot;</span>~/.ssh/id_rsa<span class="s2">&quot;)}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;mkdir -p /etc/systemd/system/docker.service.d&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">content</span>     <span class="o">=</span> <span class="s2">&quot;${data.template_file.docker_conf.rendered}&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/etc/systemd/system/docker.service.d/docker.conf&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/install-docker-ce.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/install-docker-ce.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/local-persist-plugin.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/install-docker-ce.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/install-docker-ce.sh ${var.docker_version}&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;docker swarm join --token ${data.external.swarm_tokens.result.worker} ${scaleway_server.swarm_manager.0.private_ip}:2377&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/local-persist-plugin.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">when</span> <span class="o">=</span> <span class="s2">&quot;destroy&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;docker node update --availability drain ${self.name}&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">on_failure</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>
</span><span class='line'>
</span><span class='line'>    connection <span class="o">{</span>
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>      <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>      <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">when</span> <span class="o">=</span> <span class="s2">&quot;destroy&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;docker swarm leave&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">on_failure</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">when</span> <span class="o">=</span> <span class="s2">&quot;destroy&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;docker node rm --force ${self.name}&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">on_failure</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>
</span><span class='line'>
</span><span class='line'>    connection <span class="o">{</span>
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>      <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>      <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;external&quot;</span> <span class="s2">&quot;swarm_tokens&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">program</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;./scripts/fetch-tokens.sh&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">query</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">depends_on</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;scaleway_server.swarm_manager&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our config for the docker daemon: <code>conf/docker.tpl</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/dockerd -H fd:// <span class="se">\</span>
</span><span class='line'>  -H tcp://<span class="k">${</span><span class="nv">ip</span><span class="k">}</span>:2375 <span class="se">\</span>
</span><span class='line'>  --storage-driver<span class="o">=</span>overlay2 <span class="se">\</span>
</span><span class='line'>  --dns 8.8.4.4 --dns 8.8.8.8 <span class="se">\</span>
</span><span class='line'>  --log-driver json-file <span class="se">\</span>
</span><span class='line'>  --log-opt max-size<span class="o">=</span>50m --log-opt max-file<span class="o">=</span><span class="m">10</span> <span class="se">\</span>
</span><span class='line'>  --experimental<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class='line'>  --metrics-addr 172.17.0.1:9323
</span></code></pre></td></tr></table></div></figure>


<p>Our script to mount our additional disk: <code>scripts/mount-disk.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>apt update
</span><span class='line'>apt install xfsprogs attr -y
</span><span class='line'>mkfs -t xfs /dev/vdb
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;/dev/vdb /mnt xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab
</span><span class='line'>mount -a
</span></code></pre></td></tr></table></div></figure>


<p>Our script to install docker: <code>scripts/install-docker-ce.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="nv">DOCKER_VERSION</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get -qq update
</span><span class='line'>apt-get -qq install apt-transport-https ca-certificates curl software-properties-common
</span><span class='line'>curl -fsSL https://download.docker.com/linux/debian/gpg <span class="p">|</span> sudo apt-key add -
</span><span class='line'>add-apt-repository <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable&quot;</span>
</span><span class='line'>
</span><span class='line'>apt-get -q update -y
</span><span class='line'>apt-get -q install -y docker-ce<span class="o">=</span><span class="nv">$DOCKER_VERSION</span> containerd.io
</span></code></pre></td></tr></table></div></figure>


<p>Our script that retrieves the swarm tokens: <code>scripts/fetch-tokens.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Processing JSON in shell scripts</span>
</span><span class='line'><span class="c"># https://www.terraform.io/docs/providers/external/data_source.html#processing-json-in-shell-scripts</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="c"># Extract &quot;host&quot; argument from the input into HOST shell variable</span>
</span><span class='line'><span class="nb">eval</span> <span class="s2">&quot;$(jq -r &#39;@sh &quot;</span><span class="nv">HOST</span><span class="o">=</span><span class="se">\(</span>.host<span class="o">)</span><span class="s2">&quot;&#39;)&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">MANAGER</span><span class="o">=</span><span class="k">$(</span>ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null root@<span class="nv">$HOST</span> docker swarm join-token manager -q<span class="k">)</span>
</span><span class='line'><span class="nv">WORKER</span><span class="o">=</span><span class="k">$(</span>ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null root@<span class="nv">$HOST</span> docker swarm join-token worker -q<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># produce a json object containing the tokens</span>
</span><span class='line'>jq -n --arg manager <span class="s2">&quot;$MANAGER&quot;</span> --arg worker <span class="s2">&quot;$WORKER&quot;</span> <span class="s1">&#39;{&quot;manager&quot;:$manager,&quot;worker&quot;:$worker}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our script to install the <a href="https://github.com/CWSpear/local-persist">local-persist docker volume</a> plugin: <code>scripts/local-persist-plugin.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>curl -fsSL https://raw.githubusercontent.com/CWSpear/local-persist/master/scripts/install.sh <span class="p">|</span> bash
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy your Swarm</h2>

<p>Note that we will be deploying 3x SMART1-M servers with Debian Stretch. At this moment the image id is the one of debian stretch but may change in the future. If you want to change the distro, update the install script, and the terraform files.</p>

<p><a href="https://www.scaleway.com/docs/generate-an-api-token/">Generate API Token on Scaleway</a> then export it to your current shell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">SCALEWAY_ORGANIZATION</span><span class="o">=</span><span class="s2">&quot;&lt;organization-id&gt;&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">SCALEWAY_TOKEN</span><span class="o">=</span><span class="s2">&quot;&lt;secret&gt;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure that your ssh private key is the intended one as in the config, in my example: <code>~/.ssh/id_rsa</code> and that they are allowed in your servers <code>authorized_keys</code> file</p>

<p>Create a new workspace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform new workspace swarm
</span></code></pre></td></tr></table></div></figure>


<p>Pull down the providers and initialize:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Deploy!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform apply
</span><span class='line'>...
</span><span class='line'>...
</span><span class='line'>scaleway_server.swarm_worker<span class="o">[</span>0<span class="o">]</span>: Creation <span class="nb">complete </span>after 4m55s <span class="o">(</span>ID: xx-xx-xx-xx-xx<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Apply <span class="nb">complete</span>! Resources: <span class="m">14</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span><span class='line'>Outputs:
</span><span class='line'>
</span><span class='line'><span class="nv">swarm_manager_private_ip</span> <span class="o">=</span> 10.21.x.x
</span><span class='line'><span class="nv">swarm_manager_public_ip</span> <span class="o">=</span> 51.xx.xx.xx
</span><span class='line'><span class="nv">swarm_workers_private_ip</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    swarm-worker-1,
</span><span class='line'>    swarm-worker-2,
</span><span class='line'>    10.20.xx.xx,
</span><span class='line'>    10.20.xx.xx,
</span><span class='line'><span class="o">]</span>
</span><span class='line'><span class="nv">swarm_workers_public_ip</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    swarm-worker-1,
</span><span class='line'>    swarm-worker-2,
</span><span class='line'>    51.xx.xx.xx,
</span><span class='line'>    51.xx.xx.xx,
</span><span class='line'><span class="o">]</span>
</span><span class='line'><span class="nv">workspace</span> <span class="o">=</span> swarm
</span></code></pre></td></tr></table></div></figure>


<p>Once your deployment is done you will be prompted with the public/private ip addresses of your nodes as seen above, you can also manually retrieve them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform terraform output
</span></code></pre></td></tr></table></div></figure>


<p>Or for a specific node, such as the manager:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform terraform output swarm-manager
</span><span class='line'>51.xx.xx.xx
</span></code></pre></td></tr></table></div></figure>


<p>Go ahead and ssh to your manager nodes and list the swarm nodes, boom, easy right.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker node ls
</span><span class='line'>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
</span><span class='line'>2696o0vrt93x8qf2gblbfc8pf *   swarm-manager       Ready               Active              Leader              18.09.3
</span><span class='line'>72ava7rrp2acnyadisg52n7ym     swarm-worker-1      Ready               Active                                  18.09.3
</span><span class='line'>sy2otqn20qe9jc2v9io3a21jm     swarm-worker-2      Ready               Active                                  18.09.3
</span></code></pre></td></tr></table></div></figure>


<p>When you want to destroy the environment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform destroy -force
</span></code></pre></td></tr></table></div></figure>


<h2>References:</h2>

<p>Big thanks goes to <a href="https://github.com/stefanprodan">@stefanprodan</a></p>

<ul>
<li><a href="https://www.terraform.io/docs/index.html">https://www.terraform.io/docs/index.html</a></li>
<li><a href="https://docs.docker.com/engine/swarm/">https://docs.docker.com/engine/swarm/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Deploy Scaleway Servers via the API in Python]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/20/deploy-scaleway-servers-via-the-api-in-python/"/>
    <updated>2019-03-20T19:04:00-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/20/deploy-scaleway-servers-via-the-api-in-python</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/54725016-2e81e680-4b76-11e9-9e69-ffe4cd470bb7.jpg" alt="" /></p>

<p>A quick post on how to deploy Scaleway Servers via their API using Python.</p>

<h2>API Documentation</h2>

<p>Scaleway has great <a href="https://developer.scaleway.com/#servers-servers">API Documentation</a> available, so for deeper info have a look at the link provided.</p>

<h2>Python</h2>

<p>Our python script has a function <code>create_server</code> that expects a server name, server size, the tag and the linux distribution:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="n">SCW_API_KEY</span> <span class="o">=</span> <span class="s">&quot;&lt;your-api-key&gt;&quot;</span>
</span><span class='line'><span class="n">SCW_OGRA_ID</span> <span class="o">=</span> <span class="s">&quot;&lt;your-organization-id&gt;&quot;</span>
</span><span class='line'><span class="n">SCW_REGION</span> <span class="o">=</span> <span class="s">&quot;ams1&quot;</span>
</span><span class='line'><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">=</span> <span class="s">&quot;https://cp-{region}.scaleway.com/{resource}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">SCW_REGION</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s">&#39;servers&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">SCW_VOLUME_API_URL</span> <span class="o">=</span> <span class="s">&quot;https://cp-{region}.scaleway.com/{resource}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">SCW_REGION</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s">&#39;volumes&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">SCW_HEADERS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;X-Auth-Token&quot;</span><span class="p">:</span> <span class="n">SCW_API_KEY</span><span class="p">,</span> <span class="s">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s">&quot;application/json&quot;</span><span class="p">}</span>
</span><span class='line'><span class="n">SCW_IMAGES</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;ubuntu/18&quot;</span><span class="p">:</span> <span class="s">&quot;6a601340-19c1-4ca7-9c1c-0704bcc9f5fe&quot;</span><span class="p">,</span> <span class="s">&quot;debian/stretch&quot;</span><span class="p">:</span> <span class="s">&quot;710ff1fa-0d16-4f8f-93ac-0647c44fa21d&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="n">server_id</span><span class="p">):</span>
</span><span class='line'>  <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>  <span class="n">state</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">state</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">create_server</span><span class="p">(</span><span class="n">instance_name</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">instance_tag</span><span class="p">,</span> <span class="n">os_distro</span><span class="p">):</span>
</span><span class='line'>  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">compute_payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">instance_name</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;image&quot;</span><span class="p">:</span> <span class="n">SCW_IMAGES</span><span class="p">[</span><span class="n">os_distro</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;commercial_type&quot;</span><span class="p">:</span> <span class="n">instance_type</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">instance_tag</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;organization&quot;</span><span class="p">:</span> <span class="n">SCW_OGRA_ID</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;creating server&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">r_create</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">compute_payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>  <span class="n">server_id</span> <span class="o">=</span> <span class="n">r_create</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">&quot;server&quot;</span><span class="p">][</span><span class="s">&quot;id&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">action_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;poweron&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="n">r_start</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server_id</span> <span class="o">+</span> <span class="s">&quot;/action&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">action_payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>  <span class="n">r_describe</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">server_state</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">server_id</span><span class="p">)[</span><span class="s">&#39;server&#39;</span><span class="p">][</span><span class="s">&#39;state&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="k">while</span> <span class="n">server_state</span> <span class="o">!=</span> <span class="s">&quot;running&quot;</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
</span><span class='line'>      <span class="n">r_delete</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">action_payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">{</span><span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;task timed out while waiting for server to boot&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;waiting for server to become ready&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>    <span class="n">server_state</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">server_id</span><span class="p">)[</span><span class="s">&#39;server&#39;</span><span class="p">][</span><span class="s">&#39;state&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>  <span class="n">resp</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">server_id</span><span class="p">)[</span><span class="s">&quot;server&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;hostname&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;instance_type&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;commercial_type&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;public_ip&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;public_ip&quot;</span><span class="p">][</span><span class="s">&quot;address&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;private_ip&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;private_ip&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;state&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">output</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">create_server</span><span class="p">(</span><span class="s">&quot;swarm-manager&quot;</span><span class="p">,</span> <span class="s">&quot;START1-M&quot;</span><span class="p">,</span> <span class="s">&quot;swarm&quot;</span><span class="p">,</span> <span class="s">&quot;ubuntu/18&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploying a server with the hostname: swarm-manager, instance-size: START1-M, tag: swarm and os distribution: ubuntu/18:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python scw.py
</span><span class='line'>creating server
</span><span class='line'>waiting <span class="k">for</span> server to become ready
</span><span class='line'>waiting <span class="k">for</span> server to become ready
</span><span class='line'>waiting <span class="k">for</span> server to become ready
</span><span class='line'><span class="o">{</span><span class="s1">&#39;status&#39;</span>: u<span class="s1">&#39;running&#39;</span>, <span class="s1">&#39;hostname&#39;</span>: u<span class="s1">&#39;swarm-manager&#39;</span>, <span class="s1">&#39;public_ip&#39;</span>: u<span class="s1">&#39;51.x.x.x&#39;</span>, <span class="s1">&#39;instance_type&#39;</span>: u<span class="s1">&#39;START1-M&#39;</span>, <span class="s1">&#39;private_ip&#39;</span>: u<span class="s1">&#39;10.x.x.x&#39;</span>, <span class="s1">&#39;id&#39;</span>: u<span class="s1">&#39;xx-xx-xx-xx-xx&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For more info on <a href="https://www.scaleway.com">Scaleway</a> please do check them out: <a href="https://www.scaleway.com">https://www.scaleway.com</a>}</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup NRPE Client and Server for Monitoring Remote Services in Nagios]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/18/setup-nrpe-client-and-server-for-monitoring-remote-services-in-nagios/"/>
    <updated>2019-03-18T12:49:59-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/18/setup-nrpe-client-and-server-for-monitoring-remote-services-in-nagios</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/54547916-65f26680-49af-11e9-8d42-e27c57ef8e2e.png" alt="" /></p>

<p>If you have not setup the <a href="https://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/">Nagios Server</a> have a look at that link to setup the Nagios server.</p>

<h2>Nagios NRPE</h2>

<p>Nagios Remote Plugin Executor (NRPE) allows you to remotely execute Nagios plugins on other linux systems. This allows you to monitor remote machine metrics (disk usage, CPU, local listening services, etc.).</p>

<p>NRPE has 2 sections:</p>

<ul>
<li>The nagios server side.</li>
<li>The client side.</li>
</ul>


<p>For nagios to execute remote plugins, the client configuration needs to allow the nrpe server which will be nagios.</p>

<p>Download, extract, configure and install NRPE server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget 'https://github.com/NagiosEnterprises/nrpe/releases/download/nrpe-3.2.1/nrpe-3.2.1.tar.gz'
</span><span class='line'>$ tar -xvf nrpe-3.2.1.tar.gz
</span><span class='line'>$ cd nrpe-3.2.1
</span><span class='line'>$ ./configure --enable-command-args --with-nagios-user=nagios --with-nagios-group=nagcmd --with-ssl=/usr/bin/openssl --with-ssl-lib=/usr/lib/x86_64-linux-gnu
</span><span class='line'>$ make all
</span><span class='line'>$ make install
</span><span class='line'>$ make install-init
</span><span class='line'>$ make install-config
</span><span class='line'>$ systemctl enable nrpe.service</span></code></pre></td></tr></table></div></figure>


<p>Installing NRPE on the client side:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt install nagios-nrpe-server -y
</span><span class='line'>$ systemctl enable nagios-nrpe-server
</span><span class='line'>$ systemctl start nagios-nrpe-server</span></code></pre></td></tr></table></div></figure>


<p>Allow your nagios server ip in <code>/etc/nagios/nrpe.cfg</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>allowed_hosts=nagios.ip.in.here</span></code></pre></td></tr></table></div></figure>


<p>Restart NRPE on the client:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart nagios-nrpe-server</span></code></pre></td></tr></table></div></figure>


<p>Ensure that the <code>check_nrpe</code> plugin is configured and available in the commands.cfg configuration for the nagios server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/objects/commands.cfg
</span><span class='line'>
</span><span class='line'>define command {
</span><span class='line'>    command_name check_nrpe
</span><span class='line'>    command_line $USER1$/check_nrpe -H $HOSTADDRESS$ -c $ARG1$
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Check <a href="">this</a> out how to create a python nrpe nagios plugin to check disk space on the client host</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Monitor Your First Host and Services With Nagios]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/18/monitor-your-first-host-and-services-with-nagios/"/>
    <updated>2019-03-18T12:49:23-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/18/monitor-your-first-host-and-services-with-nagios</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/54547916-65f26680-49af-11e9-8d42-e27c57ef8e2e.png" alt="" /></p>

<p>If you have not setup the <a href="https://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/">Nagios Server</a> have a look at that link to setup the Nagios server.</p>

<h2>Configure Nagios to Monitor our first Host</h2>

<p>I like to setup an isolated path for my custom host/service configigurations. First we will declare the configuration path for our servers.</p>

<p>Open up: <code>/usr/local/nagios/etc/nagios.cfg</code> and add a new cfg_dir:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cfg_dir=/usr/local/nagios/etc/servers</span></code></pre></td></tr></table></div></figure>


<p>Now, create the directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /usr/local/nagios/etc/servers</span></code></pre></td></tr></table></div></figure>


<p>Configure your email address for notifications in <code>/usr/local/nagios/etc/objects/contacts.cfg</code> and configure:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>email     youremail@yourdomain.com;</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say we want to configure a web server named web01 that sits at the location 10.10.10.10:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/servers/webservers.cfg</span></code></pre></td></tr></table></div></figure>


<p>First we define our host configuration:</p>

<ol>
<li>We are using the <code>linux-server</code> template that is defined in <code>/usr/local/nagios/etc/objects/templates.cfg</code></li>
<li>We set the hostname, alias and address as well as notification prediods</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define host {
</span><span class='line'>    use                      linux-server
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    alias                    WEB01
</span><span class='line'>    address                  10.10.10.10
</span><span class='line'>    max_check_attempts       5
</span><span class='line'>    check_period             24x7
</span><span class='line'>    notification_interval    30
</span><span class='line'>    notification_period      24x7
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>While you have the config open, we want to define the services that we would like to monitor, and associate the services to the host that we defined.</p>

<p>In this example, we want to ping the server and check port tcp 22 and 80. Ensure that your web server is allowing the mentioned ports from the nagios server ip.</p>

<p>In the config, we are declaring the following:</p>

<ol>
<li>Use the <code>generic-service</code> template</li>
<li>Map the hostname which the service should be associated to</li>
<li>The description that you will see in nagios</li>
<li>Use the check_ping / check_ssh / check_http plugin and set the thresholds for ok, warning, critical</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define service {
</span><span class='line'>    use                    generic-service
</span><span class='line'>    host_name              WEB01
</span><span class='line'>    service_description    PING
</span><span class='line'>    check_command          check_ping!100.0,20%!500.0,60%
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                      generic-service
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    service_description      SSH
</span><span class='line'>    check_command            check_ssh
</span><span class='line'>    notifications_enabled    1
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                      generic-service
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    service_description      HTTP
</span><span class='line'>    check_command            check_http
</span><span class='line'>    notifications_enabled    1
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Save the config, test the config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios</span></code></pre></td></tr></table></div></figure>


<p>If you don&rsquo;t see any errors, go ahead and restart to apply the configs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart nagios
</span><span class='line'>$ systemctl restart apache2</span></code></pre></td></tr></table></div></figure>


<p>Head over to nagios user interface at <a href="http://nagios-ip/nagios">http://nagios-ip/nagios</a> and you should see that the services are scheduled to be checked and should be reflecting in a minute or two.</p>

<h2>Up Next</h2>

<p>Next up, <a href="https://blog.ruanbekker.com/blog/2019/03/18/setup-nrpe-client-and-server-for-monitoring-remote-services-in-nagios/">Setup the NRPE Server and Client</a> to monitor remote systems using the nrpe plugin.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Setup the NagiosGraph Plugin on Nagios Monitoring Server]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/18/how-to-setup-the-nagiosgraph-plugin-on-nagios-monitoring-server/"/>
    <updated>2019-03-18T12:27:11-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/18/how-to-setup-the-nagiosgraph-plugin-on-nagios-monitoring-server</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/54547916-65f26680-49af-11e9-8d42-e27c57ef8e2e.png" alt="" /></p>

<p>If you have not setup the <a href="https://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/">Nagios Server</a> have a look at that link to setup the Nagios server.</p>

<h2>NagiosGraph</h2>

<p>In this post we will setup the nagiosgraph plugin to graph performance data of our monitored host and services.</p>

<h2>Download and Install</h2>

<p>Download the nagiosgraph plugin and extract:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget 'https://downloads.sourceforge.net/project/nagiosgraph/nagiosgraph/1.5.2/nagiosgraph-1.5.2.tar.gz' -O nagiosgraph-1.5.2.tar.gz
</span><span class='line'>$ tar -xvf nagiosgraph-1.5.2.tar.gz</span></code></pre></td></tr></table></div></figure>


<p>Install dependencies and install the nagiosgraph plugin:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install libnet-snmp-perl libsensors4 libsnmp-base libtalloc2 libtdb1 libwbclient0  snmp whois mrtg  libcgi-pm-perl librrds-perl libgd-perl libnagios-object-perl nagios-plugins-contrib
</span><span class='line'>$ ./install.pl --check-prereq
</span><span class='line'>$ ./install.pl --layout standalone --prefix /usr/local/nagiosgraph
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Destination directory (prefix)? [/usr/local/nagiosgraph]
</span><span class='line'>Location of configuration files (etc-dir)? [/usr/local/nagiosgraph/etc]
</span><span class='line'>Location of executables? [/usr/local/nagiosgraph/bin]
</span><span class='line'>Location of CGI scripts? [/usr/local/nagiosgraph/cgi]
</span><span class='line'>Location of documentation (doc-dir)? [/usr/local/nagiosgraph/doc]
</span><span class='line'>Location of examples? [/usr/local/nagiosgraph/examples]
</span><span class='line'>Location of CSS and JavaScript files? [/usr/local/nagiosgraph/share]
</span><span class='line'>Location of utilities? [/usr/local/nagiosgraph/util]
</span><span class='line'>Location of state files (var-dir)? [/usr/local/nagiosgraph/var]
</span><span class='line'>Location of RRD files? [/usr/local/nagiosgraph/var/rrd]
</span><span class='line'>Location of log files (log-dir)? [/usr/local/nagiosgraph/var/log]
</span><span class='line'>Path of log file? [/usr/local/nagiosgraph/var/log/nagiosgraph.log]
</span><span class='line'>Path of CGI log file? [/usr/local/nagiosgraph/var/log/nagiosgraph-cgi.log]
</span><span class='line'>Base URL? [/nagiosgraph]
</span><span class='line'>URL of CGI scripts? [/nagiosgraph/cgi-bin]
</span><span class='line'>URL of CSS file? [/nagiosgraph/nagiosgraph.css]
</span><span class='line'>URL of JavaScript file? [/nagiosgraph/nagiosgraph.js]
</span><span class='line'>URL of Nagios CGI scripts? [/nagios/cgi-bin]
</span><span class='line'>Path of Nagios performance data file? [/tmp/perfdata.log]
</span><span class='line'>username or userid of Nagios user? [nagios]
</span><span class='line'>username or userid of web server user? [www-data]
</span><span class='line'>Modify the Nagios configuration? [n] y
</span><span class='line'>Path of Nagios configuration file? [/usr/local/nagios/etc/nagios.cfg]
</span><span class='line'>Path of Nagios commands file? [/usr/local/nagios/etc/objects/commands.cfg]
</span><span class='line'>Modify the Apache configuration? [n] y
</span><span class='line'>Path of Apache configuration directory? /etc/apache2/sites-enabled
</span></code></pre></td></tr></table></div></figure>


<p>Ensure that your nagiosgraph configuration under apache: <code>/etc/apache2/sites-enabled/nagiosgraph.conf</code> has the following config (might be standard)</p>

<p><img src="https://user-images.githubusercontent.com/567298/54547000-946f4200-49ad-11e9-933e-b0e8b19bf014.png" alt="" /></p>

<p>Ensure the following configuration is set under nagios main config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/nagios.cfg
</span><span class='line'>
</span><span class='line'>process_performance_data=1 
</span><span class='line'>service_perfdata_file=/usr/local/nagios/var/service-perfdata.log 
</span><span class='line'>service_perfdata_file_template=$LASTSERVICECHECK$||$HOSTNAME$||$SERVICEDESC$||$SERVICEOUTPUT$||$SERVICEPERFDATA$ 
</span><span class='line'>service_perfdata_file_mode=a 
</span><span class='line'>service_perfdata_file_processing_interval=30 
</span><span class='line'>service_perfdata_file_processing_command=process-service-perfdata-for-nagiosgraph</span></code></pre></td></tr></table></div></figure>


<p>Ensure that we have the following commands in place for nagiosgraph:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/objects/commands.cfg
</span><span class='line'>
</span><span class='line'>define command {
</span><span class='line'>  command_name process-service-perfdata-for-nagiosgraph
</span><span class='line'>  command_line /usr/local/nagiosgraph/bin/insert.pl
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Create the template <code>graphed-service</code>, this will be mapped to each service that needs to be graphed in nagiosgraph:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/objects/templates.cfg
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>      name              graphed-service
</span><span class='line'>      action_url        /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$' onMouseOver='showGraphPopup(this)' onMouseOut='hideGraphPopup()' rel='/nagiosgraph/cgi-bin/showgraph.cgi?host=$HOSTNAME$&service=$SERVICEDESC$&period=week&rrdopts=-w+450+-j
</span><span class='line'>      register        0
</span><span class='line'>      }</span></code></pre></td></tr></table></div></figure>


<p>Next configure the services that needs to be graphed on nagios graph. Note, we only need to append the service template that we defined in our template configuration from above:</p>

<p>Note, if you have not checked out <a href="https://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/">Nagios Server Setup</a> post, in that post the inital configuration of the below config is explained.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/servers/vpn.cfg
</span><span class='line'>
</span><span class='line'>define host {
</span><span class='line'>    use                      linux-server
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    alias                    WEB01
</span><span class='line'>    address                  10.10.10.10
</span><span class='line'>    max_check_attempts       5
</span><span class='line'>    check_period             24x7
</span><span class='line'>    notification_interval    30
</span><span class='line'>    notification_period      24x7
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                    generic-service,graphed-service
</span><span class='line'>    host_name              WEB01
</span><span class='line'>    service_description    PING
</span><span class='line'>    check_command          check_ping!100.0,20%!500.0,60%
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                      generic-service,graphed-service
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    service_description      SSH
</span><span class='line'>    check_command            check_ssh
</span><span class='line'>    notifications_enabled    1
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                      generic-service,graphed-service
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    service_description      HTTP
</span><span class='line'>    check_command            check_http
</span><span class='line'>    notifications_enabled    1
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Test the nagios config and restart if there are no warnings:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
</span><span class='line'>$ systemctl restart nagios
</span><span class='line'>$ systemctl restart apache2</span></code></pre></td></tr></table></div></figure>


<p>Access your nagios server at <a href="http://nagios-ip/nagios">http://nagios-ip/nagios</a> and you will find that the graph icon next to the service will open the graph in a new tab, like the screenshot below:</p>

<p><img src="https://user-images.githubusercontent.com/567298/54546912-5d992c00-49ad-11e9-8a7a-331578d20f5b.png" alt="" /></p>

<h2>Up Next</h2>

<p>Next, <a href="https://blog.ruanbekker.com/blog/2019/03/18/monitor-your-first-host-and-services-with-nagios/">Monitor your first Server with Nagios</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Setup a Nagios Monitoring Server]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/"/>
    <updated>2019-03-13T17:53:42-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/54547916-65f26680-49af-11e9-8d42-e27c57ef8e2e.png" alt="" /></p>

<p>Good old nagios! Nagios is a great Open Source Monitoring Server that monitors your servers and services/applications that is hosted on top of them, and has the ability to notify in the event when they go down.</p>

<p>I&rsquo;ve been using Nagios for the last 7 years and worked for 3 business that chose Nagios as their preferred server monitoring solution.</p>

<p>All <a href="https://blog.ruanbekker.com/blog/categories/nagios/">Nagios</a> related posts are grouped under the <a href="https://blog.ruanbekker.com/blog/categories/nagios/">#nagios</a> category.</p>

<h2>What we are doing today</h2>

<p>Today we will setup a Nagios server and its plugins. The plugins helps to check different endpoints, such as custom tcp checks, ssh, snmp etc.</p>

<p>In this nagios tutorial series, I will publish a couple of post which will include:</p>

<ul>
<li>Setup the Nagios Server and its Plugins - this post</li>
<li>Setup the NRPE Server and NRPE Client Server (this is nice for local ports or custom checks)</li>
<li>Setup Nagiosgraph (Graph performance data and add it as extra host configuration)</li>
<li>Setup a custom Bash and Python Nagios Plugin for Custom Checks</li>
<li>Setup a Telegram / Slack Plugin</li>
</ul>


<h2>Installing Dependencies:</h2>

<p>Go ahead and install all the dependencies needed by nagios and add the nagios user and group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>apt install build-essential libgd-dev openssl libssl-dev unzip apache2 -y
</span><span class='line'><span class="nv">$ </span>apt install autoconf gcc libc6 make wget unzip apache2 php libapache2-mod-php7.2 libgd-dev
</span><span class='line'><span class="nv">$ </span>apt install libmcrypt-dev libssl-dev bc gawk dc build-essential libnet-snmp-perl gettext
</span><span class='line'><span class="nv">$ </span>apt install libcarp-clan-perl rrdtool php-rrd libssl1.0-dev
</span><span class='line'><span class="nv">$ </span>useradd nagios
</span><span class='line'><span class="nv">$ </span>groupadd nagcmd
</span><span class='line'><span class="nv">$ </span>usermod -a -G nagcmd nagios
</span></code></pre></td></tr></table></div></figure>


<h2>Install Nagios</h2>

<p>Download the nagios tarball from their website, have a look at <a href="https://www.nagios.org/downloads/">https://www.nagios.org/downloads/</a> for the latest version.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget -O nagios.tar.gz <span class="s1">&#39;https://assets.nagios.com/downloads/nagioscore/releases/nagios-4.4.3.tar.gz?__hstc=118811158.7bdae752f04b6d927ddf150ae1ce5c71.1552389135285.1552394646569.1552410974898.3&amp;__hssc=118811158.1.1552410974898&amp;__hsfp=2323916385#_ga=2.246938692.1332751653.1552389134-913645931.1552389134&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Extract the archive:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tar xpf nagios*.tar.gz
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>nagios-4.4.3/
</span></code></pre></td></tr></table></div></figure>


<p>Configure with nagios user and nagcmd group, install and change the ownership of the generated data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./configure --with-nagios-group<span class="o">=</span>nagios --with-command-group<span class="o">=</span>nagcmd
</span><span class='line'><span class="nv">$ </span>make -j4 all
</span><span class='line'><span class="nv">$ </span>make install
</span><span class='line'><span class="nv">$ </span>make install-commandmode
</span><span class='line'><span class="nv">$ </span>make install-init
</span><span class='line'><span class="nv">$ </span>make install-config
</span><span class='line'><span class="nv">$ </span>/usr/bin/install -c -m <span class="m">644</span> sample-config/httpd.conf /etc/apache2/sites-available/nagios.conf
</span><span class='line'><span class="nv">$ </span>usermod -a -G nagcmd www-data
</span></code></pre></td></tr></table></div></figure>


<h2>Install Nagios Plugins</h2>

<p>Get the nagios plugins tarball, extract and install:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget nagios-plugins.tar.gz <span class="s1">&#39;https://nagios-plugins.org/download/nagios-plugins-2.2.1.tar.gz#_ga=2.250909126.1332751653.1552389134-913645931.1552389134&#39;</span>
</span><span class='line'><span class="nv">$ </span>tar xpf nagios-plugins*.tar.gz
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>nagios-plugins-2.2.1
</span><span class='line'><span class="nv">$ </span>./configure --with-nagios-user<span class="o">=</span>nagios --with-nagios-group<span class="o">=</span>nagcmd --with-openssl
</span><span class='line'><span class="nv">$ </span>make -j4
</span><span class='line'><span class="nv">$ </span>make install
</span></code></pre></td></tr></table></div></figure>


<h2>Access Nagios</h2>

<p>Enable apache modules:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>a2enmod rewrite
</span><span class='line'><span class="nv">$ </span>a2enmod cgi
</span></code></pre></td></tr></table></div></figure>


<p>Setup basic auth for logging onto nagios:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>htpasswd -c /usr/local/nagios/etc/htpasswd.users nagiosadmin
</span></code></pre></td></tr></table></div></figure>


<p>Setup a symlink for apache&rsquo;s nagios configuration</p>

<p>The configuration for the above will look more or less like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/apache2/sites-enabled/nagios.conf
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>         Require all granted
</span><span class='line'>         AuthName <span class="s2">&quot;Nagios Access&quot;</span>
</span><span class='line'>         AuthType Basic
</span><span class='line'>         AuthUserFile /usr/local/nagios/etc/htpasswd.users
</span><span class='line'>         Require valid-user
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Create the systemd unit file for nagios <code>/etc/systemd/system/nagios.service</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Nagios
</span><span class='line'><span class="nv">BindTo</span><span class="o">=</span>network.target
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">Type</span><span class="o">=</span>simple
</span><span class='line'><span class="nv">User</span><span class="o">=</span>nagios
</span><span class='line'><span class="nv">Group</span><span class="o">=</span>nagcmd
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/local/nagios/bin/nagios /usr/local/nagios/etc/nagios.cfg
</span></code></pre></td></tr></table></div></figure>


<p>Reload the daemon:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl daemon-reload
</span></code></pre></td></tr></table></div></figure>


<p>Enable the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable</span> /etc/systemd/system/nagios.service
</span></code></pre></td></tr></table></div></figure>


<p>Ensure nagios is started:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl restart nagios
</span><span class='line'><span class="nv">$ </span>systemctl restart apache2
</span></code></pre></td></tr></table></div></figure>


<p>Access nagios on <a href="http://nagios-ip/nagios">http://nagios-ip/nagios</a> with the credentials that you configured earlier.</p>

<h2>Up Next</h2>

<p>In the next posts I will cover the following:</p>

<ol>
<li><a href="https://blog.ruanbekker.com/blog/2019/03/18/how-to-setup-the-nagiosgraph-plugin-on-nagios-monitoring-server/">Setup NagiosGraph for monitoring performance data</a></li>
<li>Show you how to create a custom nagios plugin in python</li>
<li>Create a Custom Notification service to send notifications to Telegram (or any API)</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a Reverse Proxy on Nginx for Your Backend Applications]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/09/setup-a-reverse-proxy-on-nginx-for-your-backend-applications/"/>
    <updated>2019-03-09T17:50:32-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/09/setup-a-reverse-proxy-on-nginx-for-your-backend-applications</id>
    <content type="html"><![CDATA[<p><img src="https://www.nginx.com/wp-content/uploads/2018/08/NGINX-logo-rgb-large.png" alt="" /></p>

<p>Nginx is a great product! And today we will use nginx to setup a http reverse proxy to access our backend applications.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299";
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>Our Setup</h2>

<p>We will have a flask backend application listening on <code>127.0.0.1:5000</code> and our nginx reverse proxy will listen on <code>0.0.0.0:80</code> which will proxy requests through to our flask upstream.</p>

<h2>Our Backend Application</h2>

<p>Our Flask application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from flask import Flask
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>
</span><span class='line'>@app.route('/')
</span><span class='line'>def index():
</span><span class='line'>    return 'Hello'
</span><span class='line'>
</span><span class='line'>if __name__ == '__main__':
</span><span class='line'>    app.run(host='127.0.0.1', port=5000)</span></code></pre></td></tr></table></div></figure>


<h2>Nginx</h2>

<p>Install nginx:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install nginx -y
</span></code></pre></td></tr></table></div></figure>


<p>Our main nginx configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># /etc/nginx/nginx.conf</span>
</span><span class='line'>user www-data<span class="p">;</span>
</span><span class='line'>worker_processes auto<span class="p">;</span>
</span><span class='line'>pid /run/nginx.pid<span class="p">;</span>
</span><span class='line'>include /etc/nginx/modules-enabled/*.conf<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>    worker_connections 768<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>    sendfile on<span class="p">;</span>
</span><span class='line'>    tcp_nopush on<span class="p">;</span>
</span><span class='line'>    tcp_nodelay on<span class="p">;</span>
</span><span class='line'>    keepalive_timeout 65<span class="p">;</span>
</span><span class='line'>    types_hash_max_size 2048<span class="p">;</span>
</span><span class='line'>    server_names_hash_bucket_size 64<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    include /etc/nginx/mime.types<span class="p">;</span>
</span><span class='line'>    default_type application/octet-stream<span class="p">;</span>
</span><span class='line'>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2<span class="p">;</span> <span class="c"># Dropping SSLv3, ref: POODLE</span>
</span><span class='line'>    ssl_prefer_server_ciphers on<span class="p">;</span>
</span><span class='line'>    access_log /var/log/nginx/access.log<span class="p">;</span>
</span><span class='line'>    error_log /var/log/nginx/error.log<span class="p">;</span>
</span><span class='line'>    gzip on<span class="p">;</span>
</span><span class='line'>    gzip_disable <span class="s2">&quot;msie6&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    include /etc/nginx/conf.d/backend-*.conf<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our application&rsquo;s configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># /etc/nginx/conf.d/backend-flask.conf</span>
</span><span class='line'>upstream backend_flask <span class="o">{</span>
</span><span class='line'>    server 127.0.0.1:5000<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>    listen <span class="m">80</span> default_server<span class="p">;</span>
</span><span class='line'>    listen <span class="o">[</span>::<span class="o">]</span>:80<span class="p">;</span>
</span><span class='line'>    server_name _<span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>    location / <span class="o">{</span>
</span><span class='line'>        include proxy_params<span class="p">;</span>
</span><span class='line'>        proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>        proxy_read_timeout 90<span class="p">;</span>
</span><span class='line'>        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        proxy_set_header Upgrade <span class="nv">$http_upgrade</span><span class="p">;</span>
</span><span class='line'>        proxy_set_header Connection <span class="s2">&quot;upgrade&quot;</span><span class="p">;</span>
</span><span class='line'>        proxy_pass http://backend_flask<span class="p">;</span>
</span><span class='line'>        proxy_buffering off<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Restart nginx and enable nginx on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl restart nginx
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>nginx
</span></code></pre></td></tr></table></div></figure>


<h2>Test your Application:</h2>

<p>Access your server on port 80 and you should receive the response from your flask application:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://nginx-public-ip:80/
</span><span class='line'>Hello
</span></code></pre></td></tr></table></div></figure>


<h2>Resoures</h2>

<ul>
<li><a href="https://itnext.io/step-over-nginx-buffer-issue-94a498bedb82">https://itnext.io/step-over-nginx-buffer-issue-94a498bedb82</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Create Users Databases and Granting Access for Users on PostgreSQL]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/06/create-users-databases-and-granting-access-for-users-on-postgresql/"/>
    <updated>2019-03-06T16:28:25-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/06/create-users-databases-and-granting-access-for-users-on-postgresql</id>
    <content type="html"><![CDATA[<p>Short tutorial on how to create databases on postgresql, creating users and granting permissions so that the users has access to the created database.</p>

<h2>Create and Apply Permissions</h2>

<p>Logon to postgresL</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo -u postgres psql
</span><span class='line'><span class="nv">psql</span><span class="o">=</span>&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Create the database <code>mydb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">psql</span><span class="o">=&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">mydb</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the user <code>dba</code> and assign a password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">psql</span><span class="o">=&gt;</span> <span class="k">create</span> <span class="k">user</span> <span class="n">concourse</span> <span class="k">with</span> <span class="k">encrypted</span> <span class="n">password</span> <span class="s1">&#39;sekretpw&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Grant all privileges for the user on the database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">psql</span><span class="o">=&gt;</span> <span class="k">grant</span> <span class="k">all</span> <span class="k">privileges</span> <span class="k">on</span> <span class="k">database</span> <span class="n">concourse1</span> <span class="k">to</span> <span class="n">concourse</span><span class="p">;</span>
</span><span class='line'><span class="n">psql</span><span class="o">=&gt;</span> <span class="err">\</span><span class="n">q</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Allowing Remote Conenctions</h2>

<p>If you want to allow remote connections, you would first need to change the config that the server listens on all interfaces:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># /etc/postgresql/10/main/postgresql.conf </span>
</span><span class='line'><span class="nv">listen_addresses</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We also the need to update the trust relationship, in this case we will only want one user to access one database from any source:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># /etc/postgresql/10/main/pg_hba.conf</span>
</span><span class='line'><span class="c"># TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
</span><span class='line'>hostnossl mydb        dba     0.0.0.0/0       trust
</span></code></pre></td></tr></table></div></figure>


<p>After the config is in place, restart the server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/etc/init.d/postgresql restart
</span></code></pre></td></tr></table></div></figure>


<h2>PostgreSQL Client</h2>

<p>From a remote source, test the connection to your server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>psql --host postgres.example.com --username dba --dbname mydb --password
</span><span class='line'>Password:
</span><span class='line'>psql <span class="o">(</span>11.1, server 10.5 <span class="o">(</span>Ubuntu 10.5-1.pgdg16.04+1<span class="o">))</span>
</span><span class='line'>Type <span class="s2">&quot;help&quot;</span> <span class="k">for</span> help.
</span><span class='line'>
</span><span class='line'><span class="nv">mydb</span><span class="o">=</span>&gt;
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a 3 Node Replicated Storage Volume With GlusterFS]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/05/setup-a-3-node-replicated-storage-volume-with-glusterfs/"/>
    <updated>2019-03-05T14:01:37-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/05/setup-a-3-node-replicated-storage-volume-with-glusterfs</id>
    <content type="html"><![CDATA[<p><img src="https://access.redhat.com/documentation/en-US/Red_Hat_Storage/2.1/html/Administration_Guide/images/Replicated_Volume.png" alt="" /></p>

<p>In one of my earlier posts on <a href="https://sysadmins.co.za/tag/glusterfs">GlusterFS</a>, we went through the steps on how to setup a <a href="https://sysadmins.co.za/setup-a-distributed-storage-volume-with-glusterfs/">Distributed Storage Volume</a>, where the end result was to have scalable storage, where size was the requirement.</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>


<p><p></p>

<h2>What will we be doing today with GlusterFS?</h2>

<p>Today, we will be going through the steps on how to setup a Replicated Storage Volume with GlusterFS, where we will have 3 GlusterFS Nodes, and using the replication factor of 3.</p>

<p><strong>Replication Factor of 3:</strong></p>

<p>In other words, having 3 copies of our data and in our case, since we will have 3 nodes in our cluster, a copy of our data will reside on each node.</p>

<p><strong>What about Split-Brain:</strong></p>

<p>In Clustering, we get the term Split-Brain, where a node dies or leaves the cluster, the cluster reforms itself with the available nodes and then during this reformation, instead of the remaining nodes staying with the same cluster, 2 subset of cluster are created, and they are not aware of each other, which causes data corruption, here&rsquo;s a great resource on <a href="http://techthoughts.typepad.com/managing_computers/2007/10/split-brain-quo.html">Split-Brain</a></p>

<p>To prevent Split-Brain in GlusterFS, we can setup a <a href="https://gluster.readthedocs.io/en/latest/Administrator%20Guide/arbiter-volumes-and-quorum/">Arbiter Volume</a>. In a Replica Count of 3 and Arbiter count of 1: 2 Nodes will hold the replicated data, and the 1 Node which will be the Arbiter node, will only host the file/directory names and metadata but not any data. I will write up an <a href="">article</a> on this in the future.</p>

<h2>Getting Started:</h2>

<p>Let&rsquo;s get started on setting up a 3 Node Replicated GlusterFS. Each node will have an additional drive that is 50GB in size, which will be part of our GlusterFS Replicated Volume. I will also be using Ubuntu 16.04 as my linux distro.</p>

<p><strong>Preparing DNS Resolution:</strong></p>

<p>I will install GlusterFS on each node, and in my setup I have the following DNS entries:</p>

<ul>
<li>gfs01 (10.0.0.2)</li>
<li>gfs02 (10.0.0.3)</li>
<li>gfs03 (10.0.0.4)</li>
</ul>


<p><strong>Preparing our Secondary Drives:</strong></p>

<p>I will be formatting my drives with <code>XFS</code>. Listing our block volumes:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsblk
</span><span class='line'>NAME MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span><span class='line'>vdb  253:16   <span class="m">0</span> 46.6G  <span class="m">0</span> disk
</span><span class='line'>vda  253:0    <span class="m">0</span> 18.6G  <span class="m">0</span> disk /
</span></code></pre></td></tr></table></div></figure></p>

<p>Creating the FileSystem with XFS, which we will be running on each node:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkfs.xfs /dev/vdb
</span></code></pre></td></tr></table></div></figure></p>

<p>Then creating the directories where our bricks will reside, and also add an entry to our <code>/etc/fstab</code> so that our disk gets mounted when the operating system boots:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># node: gfs01</span>
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/1 -p
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/dev/vdb /gluster/bricks/1 xfs defaults 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/1/brick
</span><span class='line'>
</span><span class='line'><span class="c"># node: gfs02</span>
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/2 -p
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/dev/vdb /gluster/bricks/2 xfs defaults 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/2/brick
</span><span class='line'>
</span><span class='line'><span class="c"># node: gfs03</span>
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/3 -p
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/dev/vdb /gluster/bricks/3 xfs defaults 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/3/brick
</span></code></pre></td></tr></table></div></figure></p>

<p>After this has been done, we should see that the disks are mounted, for example on node: <code>gfs01</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/vda         18G  909M   17G   3% /
</span><span class='line'>/dev/vdb         47G   80M   47G   1% /gluster/bricks/1
</span></code></pre></td></tr></table></div></figure></p>

<h2>Installing GlusterFS on Each Node:</h2>

<p>Installing GlusterFS, repeat this on all 3 Nodes:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install xfsprogs attr glusterfs-server glusterfs-common glusterfs-client -y
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>glusterfs-server
</span></code></pre></td></tr></table></div></figure></p>

<p>In order to add the nodes to the trusted storage pool, we will have to add them by using <code>gluster peer probe</code>. Make sure that you can resolve the hostnames to the designated IP Addresses, and that traffic is allowed.</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster peer probe gfs01
</span><span class='line'><span class="nv">$ </span>gluster peer probe gfs02
</span><span class='line'><span class="nv">$ </span>gluster peer probe gfs03
</span></code></pre></td></tr></table></div></figure></p>

<p>Now that we have added our nodes to our trusted storage pool, lets verify that by listing our pool:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster pool list
</span><span class='line'>UUID                                    Hostname                State
</span><span class='line'>f63d0e77-9602-4024-8945-5a7f7332bf89    gfs02                   Connected
</span><span class='line'>2d4ac6c1-0611-4e2e-b4af-9e4aa8c1556d    gfs03                   Connected
</span><span class='line'>6a604cd9-9a9c-406d-b1b7-69caf166a20e    localhost               Connected
</span></code></pre></td></tr></table></div></figure></p>

<p>Great! All looks good.</p>

<h2>Create the Replicated GlusterFS Volume:</h2>

<p>Let&rsquo;s create our Replicated GlusterFS Volume, named <code>gfs</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume create gfs <span class="se">\</span>
</span><span class='line'>  replica <span class="m">3</span> <span class="se">\</span>
</span><span class='line'>  gfs01:/gluster/bricks/1/brick <span class="se">\</span>
</span><span class='line'>  gfs02:/gluster/bricks/2/brick <span class="se">\</span>
</span><span class='line'>  gfs03:/gluster/bricks/2/brick
</span><span class='line'>
</span><span class='line'>volume create: gfs: success: please start the volume to access data
</span></code></pre></td></tr></table></div></figure></p>

<p>Now that our volume is created, lets list it to verify that it is created:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume list
</span><span class='line'>gfs
</span></code></pre></td></tr></table></div></figure></p>

<p>Now, start the volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume start gfs
</span><span class='line'>volume start: gfs: success
</span></code></pre></td></tr></table></div></figure></p>

<p>View the status of our volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume status gfs
</span><span class='line'>Status of volume: gfs
</span><span class='line'>Gluster process                             TCP Port  RDMA Port  Online  Pid
</span><span class='line'>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
</span><span class='line'>Brick gfs01:/gluster/bricks/1/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       6450
</span><span class='line'>Brick gfs02:/gluster/bricks/2/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       3460
</span><span class='line'>Brick gfs03:/gluster/bricks/3/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       3309
</span></code></pre></td></tr></table></div></figure></p>

<p>Next, view the volume inforation:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume info gfs
</span><span class='line'>
</span><span class='line'>Volume Name: gfs
</span><span class='line'>Type: Replicate
</span><span class='line'>Volume ID: 6f827df4-6df5-4c25-99ee-8d1a055d30f0
</span><span class='line'>Status: Started
</span><span class='line'>Number of Bricks: <span class="m">1</span> x <span class="nv">3</span> <span class="o">=</span> 3
</span><span class='line'>Transport-type: tcp
</span><span class='line'>Bricks:
</span><span class='line'>Brick1: gfs01:/gluster/bricks/1/brick
</span><span class='line'>Brick2: gfs02:/gluster/bricks/2/brick
</span><span class='line'>Brick3: gfs03:/gluster/bricks/3/brick
</span></code></pre></td></tr></table></div></figure></p>

<h2>Security:</h2>

<p>From a GlusterFS level, it will allow clients to connect by default. To authorize these 3 nodes to connect to the GlusterFS Volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume <span class="nb">set </span>gfs auth.allow 10.0.0.2,10.0.0.3,10.0.0.4
</span></code></pre></td></tr></table></div></figure></p>

<p>Then if you would like to remove this rule:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume <span class="nb">set </span>gfs auth.allow *
</span></code></pre></td></tr></table></div></figure></p>

<h2>Mount the GlusterFS Volume to the Host:</h2>

<p>Mount the GlusterFS Volume to each node, so we will have to mount it to each node, and also append it to our <code>/etc/fstab</code> file so that it mounts on boot:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;localhost:/gfs /mnt glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount.glusterfs localhost:/gfs /mnt
</span></code></pre></td></tr></table></div></figure></p>

<p><strong>Verify the Mounted Volume:</strong></p>

<p>Check the mounted disks, and you will find that the Replicated GlusterFS Volume is mounted on our <code>/mnt</code> partition.</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/vda         18G  909M   17G   3% /
</span><span class='line'>/dev/vdb         47G   80M   47G   1% /gluster/bricks/1
</span><span class='line'>localhost:/gfs   47G   80M   47G   1% /mnt
</span></code></pre></td></tr></table></div></figure></p>

<p>You will note that GlusterFS Volume has a total size of 47GB usable space, which is the same size as one of our disks, but that is because we have a replicated volume with a replication factor of 3:  <code>(47 * 3 / 3)</code></p>

<p>Now we have a Storage Volume which has 3 Replicas, one copy on each node, which allows us Data Durability on our Storage.</p>

<p><p></p>

<p><center><script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init(&lsquo;Buy Me a Coffee&rsquo;, &lsquo;#46b798&rsquo;, &lsquo;A6423ZIQ&rsquo;);kofiwidget2.draw();</script></center></p>

<p><p></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Container Persistent Storage for Docker Swarm Using a GlusterFS Volume Plugin]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/05/container-persistent-storage-for-docker-swarm-using-a-glusterfs-volume-plugin/"/>
    <updated>2019-03-05T13:18:30-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/05/container-persistent-storage-for-docker-swarm-using-a-glusterfs-volume-plugin</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg" alt="" /></p>

<p>From one of my previous posts I demonstrated how to provide persistent storage for your containers by using a <a href="https://blog.ruanbekker.com/blog/2018/02/16/guide-to-setup-docker-convoy-volume-driver-for-docker-swarm-with-nfs/">Convoy NFS Plugin</a>.</p>

<p>I&rsquo;ve stumbled upon one AWESOME GlusterFS Volume Plugin for Docker by <a href="https://github.com/trajano/docker-volume-plugins/tree/master/glusterfs-volume-plugin">@trajano</a>, please have a look at his repository. I&rsquo;ve been waiting for some time for one solid glusterfs volume plugin, and it works great.</p>

<h2>What we will be doing today</h2>

<p>We will setup a 3 node replicated glusterfs volume and show how easy it is to install the volume plugin and then demonstrate how storage from our swarms containers are persisted.</p>

<p>Our servers that we will be using will have the private ip&rsquo;s as shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>10.22.125.101
</span><span class='line'>10.22.125.102
</span><span class='line'>10.22.125.103</span></code></pre></td></tr></table></div></figure>


<h2>Setup GlusterFS</h2>

<p>Have a look at <a href="https://blog.ruanbekker.com/blog/2019/03/05/setup-a-3-node-replicated-storage-volume-with-glusterfs/?referral=github.com">this</a> post to setup the glusterfs volume.</p>

<h2>Install the GlusterFS Volume Plugin</h2>

<p>Below I&rsquo;m installing the plugin and setting the alias name as <code>glusterfs</code>, granting all permissions and keeping the plugin in a disabled state.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker plugin install --alias glusterfs trajano/glusterfs-volume-plugin --grant-all-permissions --disable
</span></code></pre></td></tr></table></div></figure>


<p>Set the glusterfs servers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker plugin <span class="nb">set </span>glusterfs <span class="nv">SERVERS</span><span class="o">=</span>10.22.125.101,10.22.125.102,10.22.125.103
</span></code></pre></td></tr></table></div></figure>


<p>Enable the glusterfs plugin:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker plugin <span class="nb">enable </span>glusterfs
</span></code></pre></td></tr></table></div></figure>


<h2>Create a Service in Docker Swarm</h2>

<p>Deploy a sample service on docker swarm with a volume backed by glusterfs. Note that my glusterfs volume is called <code>gfs</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.4&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">foo</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ping localhost</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">net</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">vol1:/tmp</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">net</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">overlay</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vol1</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">glusterfs</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;gfs/vol1&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml <span class="nb">test</span>
</span><span class='line'>Creating service test_foo
</span></code></pre></td></tr></table></div></figure>


<p>Have a look on which node is your container running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ps test_foo
</span><span class='line'>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
</span><span class='line'>jfwzb7yxnrxx        test_foo.1          alpine:latest       swarm-worker-1      Running             Running <span class="m">37</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>Now jump to the <code>swarm-worker-1</code> node and verify that the container is running on that node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker ps
</span><span class='line'>CONTAINER ID        IMAGE                                          COMMAND                  CREATED             STATUS                  PORTS               NAMES
</span><span class='line'>d469f341d836        alpine:latest                                  <span class="s2">&quot;ping localhost&quot;</span>           <span class="m">59</span> seconds ago      Up <span class="m">57</span> seconds                               test_foo.1.jfwzb7yxnrxxnd0qxtcjex8lu
</span></code></pre></td></tr></table></div></figure>


<p>Now since the container is running on this node, we will also see that the volume defined in our task configuration will also be present:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker volume ls
</span><span class='line'>DRIVER                       VOLUME NAME
</span><span class='line'>glusterfs:latest             gfs/vol1
</span></code></pre></td></tr></table></div></figure>


<p>Exec into the container and look at the disk layout:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it d469f341d836 sh
</span><span class='line'>/ <span class="c"># df -h</span>
</span><span class='line'>Filesystem                Size      Used Available Use% Mounted on
</span><span class='line'>overlay                  45.6G      3.2G     40.0G   7% /
</span><span class='line'>10.22.125.101:gfs/vol1   45.6G      3.3G     40.0G   8% /tmp
</span></code></pre></td></tr></table></div></figure>


<p>While you are in the container, write the hostname&rsquo;s value into a file which is mapped to the glusterfs volume:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$HOSTNAME</span> &gt; /tmp/data.txt
</span><span class='line'><span class="nv">$ </span>cat /tmp/data.txt
</span><span class='line'>d469f341d836
</span></code></pre></td></tr></table></div></figure>


<h2>Testing Data Persistence</h2>

<p>Time to test the data persistence. Scale the service to 3 replicas, then hop onto a new node where a replica resides and check if the data was persisted.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service scale <span class="nv">test_foo</span><span class="o">=</span>3
</span><span class='line'>test_foo scaled to 3
</span><span class='line'>overall progress: <span class="m">3</span> out of <span class="m">3</span> tasks
</span><span class='line'>1/3: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
</span><span class='line'>2/3: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
</span><span class='line'>3/3: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
</span><span class='line'>verify: Service converged
</span></code></pre></td></tr></table></div></figure>


<p>Check where the containers are running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ps test_foo
</span><span class='line'>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
</span><span class='line'>jfwzb7yxnrxx        test_foo.1          alpine:latest       swarm-worker-1      Running             Running <span class="m">2</span> minutes ago
</span><span class='line'>mdsg6c5b2nqb        test_foo.2          alpine:latest       swarm-worker-3      Running             Running <span class="m">15</span> seconds ago
</span><span class='line'>iybat57t4lha        test_foo.3          alpine:latest       swarm-worker-2      Running             Running <span class="m">15</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>Hop onto the <code>swarm-worker-2</code> node and check if the data is persisted from our previous write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it 4228529aba29 sh
</span><span class='line'><span class="nv">$ </span>cat /tmp/data.txt
</span><span class='line'>d469f341d836
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s append data to that file, then delete the stack and recreate to test if the data is still persisted:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$HOSTNAME</span> &gt;&gt; /tmp/data.txt
</span><span class='line'><span class="nv">$ </span>cat /tmp/data.txt
</span><span class='line'>d469f341d836
</span><span class='line'>4228529aba29
</span></code></pre></td></tr></table></div></figure>


<p>On the manager delete the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack rm <span class="nb">test</span>
</span><span class='line'>Removing service test_foo
</span></code></pre></td></tr></table></div></figure>


<p>The deploy the stack again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml <span class="nb">test</span>
</span><span class='line'>Creating service test_foo
</span></code></pre></td></tr></table></div></figure>


<p>Check where the container is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ps test_foo
</span><span class='line'>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS
</span><span class='line'>9d6z02m123jk        test_foo.1          alpine:latest       swarm-worker-1      Running             Running <span class="m">2</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>Exec into the container and read the data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it 3008b1e1bba1 cat /tmp/data.txt
</span><span class='line'>d469f341d836
</span><span class='line'>4228529aba29
</span></code></pre></td></tr></table></div></figure>


<p>And as you can see the data is persisted.</p>

<h2>Resources</h2>

<p>Please have a look and star <a href="https://github.com/trajano/docker-volume-plugins">@trajano&rsquo;s</a> repository:</p>

<ul>
<li><a href="https://github.com/trajano/docker-volume-plugins">https://github.com/trajano/docker-volume-plugins</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a Distributed Storage Volume With GlusterFS]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/03/04/setup-a-distributed-storage-volume-with-glusterfs/"/>
    <updated>2019-03-04T15:32:53-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/03/04/setup-a-distributed-storage-volume-with-glusterfs</id>
    <content type="html"><![CDATA[<p><img src="https://glusterdocs-beta.readthedocs.io/en/latest/_images/dist-volume.png" alt="" /></p>

<p>GlusterFS is a Awesome Scalable Networked Filesystem, which makes it Easy to Create Large and Scalable Storage Solutions on Commodity Hardware.</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>


<p><p></p>

<p><strong>Basic Concepts of GlusterFS:</strong></p>

<p>Brick:
* In GlusterFS, a brick is the basic unit of storage, represented by a directory on the server in the trusted storage pool.</p>

<p>Gluster Volume:
* A Gluster volume is a Logical Collection of Bricks.</p>

<p>Distributed Filesystem:
* The concept is to enable multiple clients to concurrently access data which is spread across multple servers in a trusted storage pool. This is also a great solution to prevent data corruption, enable highly available storage systems, etc.</p>

<p><a href="http://gluster.readthedocs.io/en/latest/Administrator%20Guide/glossary/">More concepts</a> can be retrieved from their documentation.</p>

<h2>Different GlusterFS Volume Types:</h2>

<p>With GlusterFS you can create the following types of Gluster Volumes:</p>

<ul>
<li>Distributed Volumes: (Ideal for Scalable Storage, No Data Redundancy)</li>
<li>Replicated Volumes: (Better reliability and data redundancy)</li>
<li>Distributed-Replicated Volumes: (HA of Data due to Redundancy and Scaling Storage)</li>
<li><a href="http://gluster.readthedocs.io/en/latest/Quick-Start-Guide/Architecture/">More detail</a> on GlusterFS Architecture</li>
</ul>


<h2>Setup a Distributed Gluster Volume:</h2>

<p>In this guide we will setup a 3 Node Distributed GlusterFS Volume on Ubuntu 16.04.</p>

<p>For this use case we would like to achieve a storage solution to scale the size of our storage, and not really worried about redundancy as, with a Distributed Setup we can increase the size of our volume, the more bricks we add to our GlusterFS Volume.</p>

<h2>Setup: Our Environment</h2>

<p>Each node has 2 disks, <code>/dev/xvda</code> for the Operating System wich is 20GB and <code>/dev/xvdb</code> which has 100GB. After we have created our GlusterFS Volume, we will have a Gluster Volume of 300GB.</p>

<p>Having a look at our disks:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsblk
</span><span class='line'>NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span><span class='line'>xvda    202:0    <span class="m">0</span>   20G  <span class="m">0</span> disk
</span><span class='line'>└─xvda1 202:1    <span class="m">0</span>   20G  <span class="m">0</span> part /
</span><span class='line'>xvdb    202:16   <span class="m">0</span>  100G  <span class="m">0</span> disk
</span></code></pre></td></tr></table></div></figure></p>

<p>If you don&rsquo;t have DNS setup for your nodes, you can use your /etc/hosts file for all 3 nodes, which I will be using in this demonstration:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/hosts
</span><span class='line'>172.31.13.226   gluster-node-1
</span><span class='line'>172.31.9.7      gluster-node-2
</span><span class='line'>172.31.15.34    gluster-node-3
</span><span class='line'>127.0.0.1       localhost
</span></code></pre></td></tr></table></div></figure></p>

<h2>Install GlusterFS from the Package Manager:</h2>

<p>Note that all the steps below needs to be performed on all 3 nodes, unless specified otherwise:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install xfsprogs attr glusterfs-server glusterfs-client glusterfs-common -y
</span></code></pre></td></tr></table></div></figure></p>

<h2>Format and Prepare the Gluster Disks:</h2>

<p>We will create a XFS Filesystem for our 100GB disk, create the directory path where we will mount our disk onto, and also load it into <code>/etc/fstab</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkfs.xfs /dev/xvdb
</span><span class='line'><span class="nv">$ </span>mkdir /gluster
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/dev/xvdb /gluster xfs defaults 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span></code></pre></td></tr></table></div></figure></p>

<p>After we mounted the disk, we should see that our disk is mounted to <code>/gluster</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/xvda1       20G  1.2G   19G   7% /
</span><span class='line'>/dev/xvdb       100G   33M  100G   1% /gluster
</span></code></pre></td></tr></table></div></figure></p>

<p>After our disk is mounted, we can proceed by creating the brick directory on our disk that we mounted, from the step above:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /gluster/brick
</span></code></pre></td></tr></table></div></figure></p>

<h2>Start GlusterFS Service:</h2>

<p>Enable GlusterFS on startup, start the service and make sure that the service is running:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>glusterfs-server
</span><span class='line'><span class="nv">$ </span>systemctl restart glusterfs-server
</span><span class='line'><span class="nv">$ </span>systemctl is-active glusterfs-server
</span><span class='line'>active
</span></code></pre></td></tr></table></div></figure></p>

<h2>Discover All the Nodes for our Cluster:</h2>

<p>The following will only be done on one of the nodes. First we need to discover our other nodes.</p>

<p>The node that you are currently on, will be discovered by default and only needs the other 2 nodes to be discovered:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster peer probe gluster-node-2
</span><span class='line'><span class="nv">$ </span>gluster peer probe gluster-node-3
</span></code></pre></td></tr></table></div></figure></p>

<p>Let&rsquo;s verify this by listing all the nodes in our cluster:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster pool list
</span><span class='line'>UUID                                    Hostname        State
</span><span class='line'>6e02731c-6472-4ea4-bd48-d5dd87150e8b    gluster-node-2  Connected
</span><span class='line'>9d4c2605-57ba-49e2-b5da-a970448dc886    gluster-node-3  Connected
</span><span class='line'>608f027e-e953-413b-b370-ce84050a83c9    localhost       Connected
</span></code></pre></td></tr></table></div></figure></p>

<h2>Create the Distributed GlusterFS Volume:</h2>

<p>We will create a Distributed GlusterFS Volume across 3 nodes, and we will name the volume <code>gfs</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume create gfs <span class="se">\</span>
</span><span class='line'>  gluster-node-1:/gluster/brick <span class="se">\</span>
</span><span class='line'>  gluster-node-2:/gluster/brick <span class="se">\</span>
</span><span class='line'>  gluster-node-3:/gluster/brick
</span><span class='line'>
</span><span class='line'>volume create: gfs: success: please start the volume to access data
</span></code></pre></td></tr></table></div></figure></p>

<h2>Start the GlusterFS Volume:</h2>

<p>Now start the <code>gfs</code> GlusterFS Volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume start gfs
</span><span class='line'>volume start: gfs: success
</span></code></pre></td></tr></table></div></figure></p>

<p>To get information about the volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume info gfs
</span><span class='line'>
</span><span class='line'>Volume Name: gfs
</span><span class='line'>Type: Distribute
</span><span class='line'>Volume ID: c08bc2e8-59b3-49e7-bc17-d4bc8d99a92f
</span><span class='line'>Status: Started
</span><span class='line'>Number of Bricks: 3
</span><span class='line'>Transport-type: tcp
</span><span class='line'>Bricks:
</span><span class='line'>Brick1: gluster-node-1:/gluster/brick
</span><span class='line'>Brick2: gluster-node-2:/gluster/brick
</span><span class='line'>Brick3: gluster-node-3:/gluster/brick
</span><span class='line'>Options Reconfigured:
</span><span class='line'>performance.readdir-ahead: on
</span></code></pre></td></tr></table></div></figure></p>

<p>Status information about our Volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume status
</span><span class='line'>
</span><span class='line'>Status of volume: gfs
</span><span class='line'>Gluster process                             TCP Port  RDMA Port  Online  Pid
</span><span class='line'>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
</span><span class='line'>Brick gluster-node-1:/gluster/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       7139
</span><span class='line'>Brick gluster-node-2:/gluster/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       7027
</span><span class='line'>Brick gluster-node-3:/gluster/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       7099
</span><span class='line'>NFS Server on localhost                     <span class="m">2049</span>      <span class="m">0</span>          Y       7158
</span><span class='line'>NFS Server on gluster-node-2                <span class="m">2049</span>      <span class="m">0</span>          Y       7046
</span><span class='line'>NFS Server on gluster-node-3                <span class="m">2049</span>      <span class="m">0</span>          Y       7118
</span><span class='line'>
</span><span class='line'>Task Status of Volume gfs
</span><span class='line'>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
</span><span class='line'>There are no active volume tasks
</span></code></pre></td></tr></table></div></figure></p>

<h2>Mounting our GlusterFS Volume:</h2>

<p>On all the clients, in this case our 3 nodes, load the mount information into <code>/etc/fstab</code> and then mount the GlusterFS Volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;localhost:/gfs /mnt glusterfs defaults,_netdev,backupvolfile-server=gluster-node-1 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span></code></pre></td></tr></table></div></figure></p>

<p>Now that the volume is mounted, have a look at your disk info, and you will find that you have a <code>300GB</code> GlusterFS Volume mounted:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/xvda1       20G  1.3G   19G   7% /
</span><span class='line'>/dev/xvdb       100G   33M  100G   1% /gluster
</span><span class='line'>localhost:/gfs  300G   98M  300G   1% /mnt
</span></code></pre></td></tr></table></div></figure></p>

<p>As mentioned before, this is most probably for a scenario where you would like to achieve a high storage size and not really concerned about data availability.</p>

<p>In the next couple of weeks I will also go through the Replicated, Distributed-Replicated and <a href="https://gluster.readthedocs.io/en/latest/Administrator%20Guide/Gluster%20On%20ZFS/">GlusterFS with ZFS</a> setups.</p>

<h2>Resources:</h2>

<ul>
<li><a href="http://gluster.readthedocs.io/en/latest/Quick-Start-Guide/Terminologies/">GlusterFS Terminologies</a></li>
<li><a href="http://gluster.readthedocs.io/en/latest/Quick-Start-Guide/Architecture/">GlusterFS Architecture</a></li>
<li><a href="http://gluster.readthedocs.io/en/latest/Administrator%20Guide/Gluster%20On%20ZFS/">GlusterFS with ZFS</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Use Swarm Managed Configs in Docker Swarm to Store Your Application Configs]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/02/28/use-swarm-managed-configs-in-docker-swarm-to-store-your-application-configs/"/>
    <updated>2019-02-28T09:48:28-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/02/28/use-swarm-managed-configs-in-docker-swarm-to-store-your-application-configs</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg" alt="" /></p>

<p>Docker version 17.06 introduced Swarm Service Configs, which allows you to store data like configuration files, note that this is for non-sensitive information.</p>

<p>In this tutorial we will store the data of our <code>index.html</code> in a service config, then attach the config to our service.</p>

<h2>Creating the Config</h2>

<p>Create the <code>index.html</code> file and store it as a config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; index.html <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">&lt;html&gt;</span>
</span><span class='line'><span class="s">  &lt;body&gt;</span>
</span><span class='line'><span class="s">    Hello, World!</span>
</span><span class='line'><span class="s">  &lt;/body&gt;</span>
</span><span class='line'><span class="s">&lt;/html&gt;</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Store the config as <code>nginx_root_doc</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker config create nginx_root_doc index.html
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Service</h2>

<p>Create the swarm service and associate the config with the service and set the target path where the config will reside:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service create --name web <span class="se">\</span>
</span><span class='line'>  --config <span class="nb">source</span><span class="o">=</span>nginx_root_doc,target<span class="o">=</span>/usr/share/nginx/html/index.html <span class="se">\</span>
</span><span class='line'>  --publish 8080:80 nginx:alpine
</span></code></pre></td></tr></table></div></figure>


<p>Once the service is up, test it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i http://localhost:8080/
</span><span class='line'>&lt;html&gt;
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.15.9
</span><span class='line'>Date: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:00:19 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 52
</span><span class='line'>Last-Modified: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 11:59:37 GMT
</span><span class='line'>Connection: keep-alive
</span><span class='line'>ETag: <span class="s2">&quot;5c77cd29-34&quot;</span>
</span><span class='line'>Accept-Ranges: bytes
</span><span class='line'>
</span><span class='line'>&lt;html&gt;
</span><span class='line'>  &lt;body&gt;
</span><span class='line'>    Hello, World!
</span><span class='line'>  &lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Delete the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service rm web
</span></code></pre></td></tr></table></div></figure>


<p>Delete the config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker config rm nginx_root_doc
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Service using Compose:</h2>

<p>Doing the same with a docker-compose file, will look like the following. The first example will be where we will explicitly define our path of our secret, and will create on deploy time. Our compose file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">web</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx:alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">net</span>
</span><span class='line'>    <span class="l-Scalar-Plain">configs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx_root_doc</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/share/nginx/html/index.html</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">configs</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">nginx_root_doc</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./index.html</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">net</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">overlay</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploying our stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml apps
</span><span class='line'>Creating network apps_net
</span><span class='line'>Creating config apps_nginx_root_doc
</span><span class='line'>Creating service apps_web
</span></code></pre></td></tr></table></div></figure>


<p>Testing our our service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i http://localhost:8080/
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.15.9
</span><span class='line'>Date: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:20:52 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 56
</span><span class='line'>Last-Modified: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:20:47 GMT
</span><span class='line'>Connection: keep-alive
</span><span class='line'>ETag: <span class="s2">&quot;5c77d21f-38&quot;</span>
</span><span class='line'>Accept-Ranges: bytes
</span><span class='line'>
</span><span class='line'>&lt;html&gt;
</span><span class='line'>  &lt;body&gt;
</span><span class='line'>    Hello, World!
</span><span class='line'>  &lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Note, that configs cant be updated, if you want to rotate a config you will create a new config and update the target in your task definition to point to your new config.</p>

<p>Delete the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack rm apps
</span><span class='line'>Removing service apps_web
</span><span class='line'>Removing config apps_nginx_root_doc
</span><span class='line'>Removing network apps_net
</span></code></pre></td></tr></table></div></figure>


<p>Another example will be to point to a external config which already exists in swarm. The only change will be that we need to set the config as a external type.</p>

<p>Create the config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker config create nginx_root_doc index.html
</span></code></pre></td></tr></table></div></figure>


<p>Now that the config exists, create this compose file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.3&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">web</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx:alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">net</span>
</span><span class='line'>    <span class="l-Scalar-Plain">configs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx_root_doc</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/share/nginx/html/index.html</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">configs</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">nginx_root_doc</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">net</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">overlay</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml apps
</span><span class='line'>Creating network apps_net
</span><span class='line'>Creating service apps_web
</span></code></pre></td></tr></table></div></figure>


<p>Then testing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i http://localhost:8080/
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.15.9
</span><span class='line'>Date: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:28:11 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 56
</span><span class='line'>Last-Modified: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:28:09 GMT
</span><span class='line'>Connection: keep-alive
</span><span class='line'>ETag: <span class="s2">&quot;5c77d3d9-38&quot;</span>
</span><span class='line'>Accept-Ranges: bytes
</span><span class='line'>
</span><span class='line'>&lt;html&gt;
</span><span class='line'>  &lt;body&gt;
</span><span class='line'>    Hello, World!
</span><span class='line'>  &lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<p>For more information on docker swarm configs have a look at <a href="https://docs.docker.com/engine/swarm/configs/#example-rotate-a-config">docker&rsquo;s documentation</a></p>
]]></content>
  </entry>
  
</feed>
