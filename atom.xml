<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Ruan Bekker's Blog]]></title>
  <link href="https://blog.ruanbekker.com/atom.xml" rel="self"/>
  <link href="https://blog.ruanbekker.com/"/>
  <updated>2022-02-08T05:19:35-05:00</updated>
  <id>https://blog.ruanbekker.com/</id>
  <author>
    <name><![CDATA[Ruan]]></name>
    <email><![CDATA[ruan@ruanbekker.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Blockchain Basics]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/12/05/blockchain-basics/"/>
    <updated>2021-12-05T08:12:10-05:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/12/05/blockchain-basics</id>
    <content type="html"><![CDATA[<p>In this tutorial, we will cover the <strong>basics of blockchain</strong> and why you would want to run a full-node such as bitcoin, ethereum, etc.</p>

<h2>Blockchain Basics</h2>

<p>Before we start setting up our bitcoin full-node, we first need to get through some blockchain basics, if you already aware of it, you can skip the the setup section of this post.</p>

<h2>Block</h2>

<p>Transaction data is <strong>permanently recorded</strong> into files called <strong>blocks</strong>. You can think of it as a <strong>transaction ledger</strong>. Blocks are organised into a linear sequence over time.</p>

<p>New transactions are <strong>constantly being processed</strong> by <strong>miners</strong> into new blocks which are added to the <strong>end of the chain</strong>. As blocks are buried deeper and deeper into the blockchain they <strong>become harder</strong> and harder to change or remove, this gives rise of <strong><a href="https://en.bitcoin.it/wiki/Irreversible_Transactions">Bitcoin&rsquo;s Irreversible Transactions</a></strong>.</p>

<p>The first block added to the blockchain is referred to as the <strong><a href="https://en.bitcoin.it/wiki/Genesis_block">genesis block</a></strong></p>

<h2>Blockchain</h2>

<p>A blockchain is a transaction database shared by <strong>all nodes participating</strong> in a system based on the bitcoin protocol. A <strong>full copy</strong> of a currency&rsquo;s blockchain contains <strong>every</strong> transaction ever executed in the currency. With this information, one can find out how much value belonged to each address at any point in history.</p>

<p>Every block contains a hash of the previous block. This has the effect of creating a chain of blocks from the genesis block to the current block. <strong>Each block</strong> is guaranteed to come after the <strong>previous block</strong> chronologically because the previous block&rsquo;s hash would otherwise not be known. Each block is also computationally impractical to modify once it has been in the chain for a while because every block after it would also have to be regenerated. <strong>These properties are what make bitcoins transactions irreversible</strong>. The blockchain is the main innovation of Bitcoin.</p>

<h2>Mining</h2>

<p>Mining is the <strong>process</strong> of <strong>adding transaction records</strong> to bitcoin&rsquo;s public ledger of past transactions. The term &ldquo;mining rig&rdquo; is referred to where as a single computer system that performs the necessary computations for &ldquo;mining&rdquo;.</p>

<p>The blockchain serves to confirm transactions to the rest of the network as having taken place. Bitcoin nodes use the blockchain to <strong>distinguish legitimate Bitcoin transactions</strong> from attempts to re-spend coins that have already been spent elsewhere.</p>

<h2>Node</h2>

<p>Any <strong>computer</strong> that connects to the <strong>bitcoin network</strong> is called a <strong>node</strong>. Nodes that fully verify all of the rules of bitcoin are called full nodes. The most popular software implementation of full nodes is called bitcoin-core, its releases can be found on their <strong><a href="https://github.com/bitcoin/bitcoin/releases">github page</a></strong></p>

<h2>What is a Full Node</h2>

<p>A full node is a node (computer system with bitcoin-core running on it) which <strong>downloads every block and transaction</strong> and check them against <strong>bitcoin&rsquo;s consensus rules</strong>. which fully validates transactions and blocks. Almost all full nodes also help the network by accepting transactions and blocks from other full nodes, validating those transactions and blocks, and then relaying them to further full nodes.</p>

<p>Some <strong>examples</strong> of <strong>consensus rules</strong>:</p>

<ul>
<li>Blocks may only <a href="https://en.bitcoin.it/wiki/Controlled_supply">create</a> a certain number of bitcoins. (Currently 6.25 BTC per block.)</li>
<li>Transactions must have correct signatures for the bitcoins being spent.</li>
<li>Transactions/blocks must be in the correct data format.</li>
<li>Within a single <a href="https://en.bitcoin.it/wiki/Block_chain">blockchain</a>, a transaction output cannot be double-spent.</li>
</ul>


<p>At minimum, a full node must download every transaction that has ever taken place, all new transactions, and all block headers. Additionally, full nodes must store information about every unspent transaction output until it is spent.</p>

<p>By default full nodes are inefficient in that they download each new transaction at least twice, and they store the entire block chain (more than 165 GB as of 20180214) forever, even though only the unspent transaction outputs (&lt;2 GB) are required. Performance can improved by enabling <a href="https://bitcointalk.org/index.php?topic=1377345.0">-blocksonly</a> mode and enabling <a href="https://bitcoin.org/en/release/v0.12.0#wallet-pruning">pruning</a></p>

<h2>Archival Nodes</h2>

<p>A subset of full nodes also <strong>accept incoming connections</strong> and <strong>upload old blocks</strong> to other peers on the network. This happens if the software is run with -listen=1 as is default.</p>

<p>Contrary to some popular misconceptions, being an archival node is not necessary to being a full node. If a user&rsquo;s bandwidth is constrained then they can use -listen=0, if their disk space is constrained they can use pruning, all the while still being a fully-validating node that enforces bitcoin&rsquo;s consensus rules and contributing to bitcoin&rsquo;s overall security.</p>

<p>Most information was referenced from <strong><a href="https://en.bitcoin.it/wiki/Full_node">this</a></strong> wiki.</p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Run a GETH Ethereum Light Node]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/12/05/run-a-geth-ethereum-light-node/"/>
    <updated>2021-12-05T04:14:11-05:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/12/05/run-a-geth-ethereum-light-node</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/144747750-e0a6f000-fc60-4422-b9bc-7b1b6549cbe4.png" alt="ethereum" /></p>

<p>In this tutorial we will install the Geth implementation of <a href="https://ethereum.org/en/">Ethereum</a> on Linux and we will be using the <a href="https://ethereum.org/en/developers/docs/nodes-and-clients/#light-node">light sync mode</a> which will get you up and running in minutes, which only downloads a couple of GBs.</p>

<p>Once we have our node setup we will be using the API and Web3 to interact with our ethereum node.</p>

<p>To understand the basics of blockchain better, you can read my post:
- <a href="https://blog.ruanbekker.com/blog/2021/12/05/blockchain-basics/">The Basics of Blockchain</a></p>

<h2>Environment Setup</h2>

<p>We require go to be installed on our server, so from golang&rsquo;s <a href="https://golang.org/dl/">releases</a> page get the latest version of Go and extract it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /tmp
</span><span class='line'>wget https://go.dev/dl/go1.17.4.linux-amd64.tar.gz
</span><span class='line'>sudo tar -C /usr/local -xzf go1.17.4.linux-amd64.tar.gz
</span></code></pre></td></tr></table></div></figure>


<p>Setup environment for Go in <code>/etc/profile.d/go.sh</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">GOROOT</span><span class="o">=</span>/usr/local/go
</span><span class='line'><span class="nb">export </span><span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/go
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$GOROOT</span>/bin
</span></code></pre></td></tr></table></div></figure>


<p>While you are in your session, source the file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">source</span> /etc/profile.d/go.sh
</span></code></pre></td></tr></table></div></figure>


<p>And verify that Go is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>go version
</span><span class='line'>go version go1.17.4 linux/amd64
</span></code></pre></td></tr></table></div></figure>


<h2>Download Geth</h2>

<p>From the geth <a href="https://geth.ethereum.org/downloads/">releases</a> page, get the latest version, extract and setup a symlink to the latest version:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /tmp
</span><span class='line'>wget https://gethstore.blob.core.windows.net/builds/geth-linux-amd64-1.10.13-7a0c19f8.tar.gz
</span><span class='line'>tar -xvf geth-linux-amd64-1.10.13-7a0c19f8.tar.gz
</span><span class='line'>sudo mkdir -p /usr/local/geth/1.10.13/bin
</span><span class='line'>sudo mv geth-linux-amd64-1.10.13-7a0c19f8/geth /usr/local/geth/1.10.13/bin/geth
</span><span class='line'>sudo ln -s /usr/local/geth/1.10.13 /usr/local/geth/current
</span></code></pre></td></tr></table></div></figure>


<p>Setup the environment for geth on <code>/etc/profile.d/geth.sh</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:/usr/local/geth/current/bin
</span></code></pre></td></tr></table></div></figure>


<p>Then source the file while you are still in your session:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">source</span> /etc/profile.d/geth.sh
</span></code></pre></td></tr></table></div></figure>


<p>You should be able to verify that geth is installed by running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>geth version
</span><span class='line'>Geth
</span><span class='line'>Version: 1.10.13-stable
</span><span class='line'>Git Commit: eae3b1946a276ac099e0018fc792d9e8c3bfda6d
</span><span class='line'>Git Commit Date: 20210929
</span><span class='line'>Architecture: amd64
</span><span class='line'>Go Version: go1.17
</span><span class='line'>Operating System: linux
</span><span class='line'><span class="nv">GOPATH</span><span class="o">=</span>/home/ubuntu/go
</span><span class='line'><span class="nv">GOROOT</span><span class="o">=</span>/usr/local/go
</span></code></pre></td></tr></table></div></figure>


<h2>Setup Geth</h2>

<p>Create the data directory for geth and change the ownership of the directory to our user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo mkdir -p /blockchain/ethereum/data
</span><span class='line'>sudo chown -R ubuntu:ubuntu /blockchain/ethereum
</span></code></pre></td></tr></table></div></figure>


<p>Run geth in the foreground to test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>geth --ropsten <span class="se">\</span>
</span><span class='line'>  --datadir /blockchain/ethereum/data --datadir.minfreedisk <span class="m">1024</span> <span class="se">\</span>
</span><span class='line'>  --cache <span class="m">128</span> --syncmode <span class="s2">&quot;light&quot;</span> <span class="se">\</span>
</span><span class='line'>  --http --http.addr 0.0.0.0 --http.port <span class="m">8545</span> <span class="se">\</span>
</span><span class='line'>  --metrics --metrics.addr 0.0.0.0 --metrics.port 6060
</span></code></pre></td></tr></table></div></figure>


<p>If everything goes okay, you can stop the process, and remove the ropsten testnet blockchain and state databases:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>geth --ropsten removedb
</span></code></pre></td></tr></table></div></figure>


<p>Create the systemd unit file in <code>/etc/systemd/system/geth.service</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Geth Node
</span><span class='line'><span class="nv">After</span><span class="o">=</span>network.target auditd.service
</span><span class='line'><span class="nv">Wants</span><span class="o">=</span>network.target
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">WorkingDirectory</span><span class="o">=</span>/home/ubuntu
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/local/geth/current/bin/geth <span class="se">\</span>
</span><span class='line'>  --ropsten <span class="se">\</span>
</span><span class='line'>  --datadir /blockchain/ethereum/data <span class="se">\</span>
</span><span class='line'>  --datadir.minfreedisk <span class="m">1024</span> <span class="se">\</span>
</span><span class='line'>  --cache <span class="m">128</span> <span class="se">\</span>
</span><span class='line'>  --syncmode <span class="s2">&quot;light&quot;</span> <span class="se">\</span>
</span><span class='line'>  --http --http.addr 0.0.0.0 --http.port <span class="m">8545</span> <span class="se">\</span>
</span><span class='line'>  --http.api <span class="s2">&quot;admin,db,debug,eth,miner,net,personal,txpool,web3&quot;</span> <span class="se">\</span>
</span><span class='line'>  --http.corsdomain <span class="s2">&quot;*&quot;</span> <span class="se">\</span>
</span><span class='line'>  --metrics --metrics.addr 0.0.0.0 --metrics.port <span class="m">6060</span> <span class="se">\</span>
</span><span class='line'>  --whitelist <span class="nv">10920274</span><span class="o">=</span>0xfd652086d220d506ae5b7cb80fde97d2f3f7028d346cc7d9d384a83d3d638532
</span><span class='line'><span class="nv">User</span><span class="o">=</span>ubuntu
</span><span class='line'><span class="nv">Group</span><span class="o">=</span>ubuntu
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>on-failure
</span><span class='line'><span class="nv">RestartSec</span><span class="o">=</span>120s
</span><span class='line'><span class="nv">KillMode</span><span class="o">=</span>process
</span><span class='line'><span class="nv">KillSignal</span><span class="o">=</span>SIGINT
</span><span class='line'><span class="nv">TimeoutStopSec</span><span class="o">=</span>600
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span><span class='line'><span class="nv">Alias</span><span class="o">=</span>geth.service
</span></code></pre></td></tr></table></div></figure>


<p>The values such as <code>--whitelist</code> can be retrieved from <a href="https://github.com/ethereum/go-ethereum/issues/23546">this issue</a> or <a href="https://www.linkedin.com/pulse/how-mine-ropsten-testnet-ether-keir-finlow-bates/">this post</a> and extracted from the post:</p>

<blockquote><p>&ldquo;due to the London upgrade you&rsquo;ll probably end up on the chain that isn&rsquo;t tracked by Etherscan and Metamask. To ensure you only retrieve blocks from peers on that chain, include the following string in your geth start command&rdquo;</p></blockquote>

<p>Since we created a new systemd unit file, reload the systemd daemon:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo systemctl daemon-reload
</span></code></pre></td></tr></table></div></figure>


<p>Enable and start geth:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo systemctl <span class="nb">enable </span>geth
</span><span class='line'>sudo systemctl restart geth
</span></code></pre></td></tr></table></div></figure>


<p>You can tail the logs to ensure everything runs as it should:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo journalctl -fu geth
</span></code></pre></td></tr></table></div></figure>


<h2>API</h2>

<p>Following the <a href="https://eth.wiki/json-rpc/API">JSON-RPC</a> documentation, create your account:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -XPOST http://localhost:8545/ -d <span class="s1">&#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;personal_newAccount&quot;,&quot;params&quot;:[&quot;password&quot;],&quot;id&quot;:1}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The response should provide your ropsten testnet address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="s2">&quot;0x2b1718cdf7dbcc381267ccf43d320c6e194d6aa8&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can list all our ethereum addresses by calling the <a href="https://eth.wiki/json-rpc/API#eth_accounts">eth_accounts</a> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -XPOST http://localhost:8545/ -d <span class="s1">&#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_accounts&quot;,&quot;params&quot;:[],&quot;id&quot;:1}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can then check our balance with <a href="https://eth.wiki/json-rpc/API#eth_getbalance">eth_getbalance</a>, where we pass the ethereum address which is in hex format, followed by the block number, but we will use &ldquo;latest&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -XPOST http://localhost:8545/ -d <span class="s1">&#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_getBalance&quot;,&quot;params&quot;:[&quot;0x2b1718cdf7dbcc381267ccf43d320c6e194d6aa8&quot;, &quot;latest&quot;],&quot;id&quot;:1}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can use the following faucets to send testnet funds to your account:
- <a href="https://faucet.dimensions.network/">https://faucet.dimensions.network/</a>
- <a href="https://faucet.ropsten.be/">https://faucet.ropsten.be/</a></p>

<p>After sending funds to your account, we can check our balance again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -XPOST http://localhost:8545/ -d <span class="s1">&#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_getBalance&quot;,&quot;params&quot;:[&quot;0x2b1718cdf7dbcc381267ccf43d320c6e194d6aa8&quot;, &quot;latest&quot;],&quot;id&quot;:1}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And our balances should reflect in our account:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="s2">&quot;0x429d069189e0000&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hexadecimal and Wei</h2>

<p>As you can notice the value of our balance for our ethereum address is in hexadecimal format, we can convert it to decimal format:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="k">$((</span><span class="m">0</span>x429d069189e0000<span class="k">))</span>
</span><span class='line'>300000000000000000
</span></code></pre></td></tr></table></div></figure>


<p>We can use python to convert to decimal using the int() function, by passing the hexadecimal value and pass its base to convert it into an integer, the base for hexadecimal is 16:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="s">&#39;0x429d069189e0000&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
</span><span class='line'><span class="mi">300000000000000000</span>
</span></code></pre></td></tr></table></div></figure>


<p>The decimal value that was returned is the value in <a href="https://www.investopedia.com/terms/w/wei.asp">Wei</a>, and the value of 1 ETH equals to 1,000,000,000,000,000,000 Wei.</p>

<p>Using <a href="https://gwei.io/">gwei.io</a> the conversions from 1 ETH are:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Wei</span><span class="p">:</span> <span class="mi">1000000000000000000</span>
</span><span class='line'><span class="n">Kwei</span><span class="p">:</span> <span class="mi">1000000000000000</span>
</span><span class='line'><span class="n">Mwei</span><span class="p">:</span> <span class="mi">1000000000000</span>
</span><span class='line'><span class="n">Gwei</span><span class="p">:</span> <span class="mi">1000000000</span>
</span><span class='line'><span class="n">Twei</span><span class="p">:</span> <span class="mi">1000000</span>
</span><span class='line'><span class="n">Pwei</span><span class="p">:</span> <span class="mi">1000</span>
</span><span class='line'><span class="n">ETH</span><span class="p">:</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>So now we can convert our balance from wei to ethereum:</p>

<ul>
<li><code>your_balance_in_wei / unit_value_of_wei</code></li>
<li><code>300000000000000000 / 1000000000000000000</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">python3</span> <span class="o">-</span><span class="n">c</span> <span class="s">&quot;print(300000000000000000 / 1000000000000000000)&quot;</span>
</span><span class='line'><span class="mf">0.3</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can use <a href="https://eth-converter.com/">this</a> converter to make sure my math is correct</p>

<p>To get the current gas price in wei</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -XPOST http://localhost:8545/ -d <span class="s1">&#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;eth_gasPrice&quot;,&quot;params&quot;:[],&quot;id&quot;:1}&#39;</span><span class="o">{</span><span class="s2">&quot;jsonrpc&quot;</span>:<span class="s2">&quot;2.0&quot;</span>,<span class="s2">&quot;id&quot;</span>:1,<span class="s2">&quot;result&quot;</span>:<span class="s2">&quot;0x73a20d04&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>CLI - <a href="https://geth.ethereum.org/docs/interface/managing-your-accounts">Accounts</a></h2>

<p>Create a password in <code>/tmp/pass</code> then:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>geth --datadir /blockchain/ethereum/data --keystore /blockchain/ethereum/data/keystore account new --password /tmp/.pass
</span><span class='line'>
</span><span class='line'>Your new key was generated
</span><span class='line'>
</span><span class='line'>Public address of the key:   0x5814D945EC909eb1307be4F133AaAB3dEF3572f0
</span><span class='line'>Path of the secret key file: /blockchain/ethereum/data/keystore/UTC--2021-10-06T15-43-23.679655564Z--5814d945ec909eb1307be4f133aaab3def3572f0
</span><span class='line'>
</span><span class='line'>- You can share your public address with anyone. Others need it to interact with you.
</span><span class='line'>- You must NEVER share the secret key with anyone! The key controls access to your funds!
</span><span class='line'>- You must BACKUP your key file! Without the key, it<span class="s1">&#39;s impossible to access account funds!</span>
</span><span class='line'><span class="s1">- You must REMEMBER your password! Without the password, it&#39;</span>s impossible to decrypt the key!
</span></code></pre></td></tr></table></div></figure>


<p>Then when you attach your console session, you will be able to see the address that we created:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>geth attach /blockchain/ethereum/data/geth.ipc
</span><span class='line'>&gt; eth.accounts<span class="o">[</span>0<span class="o">]</span>
</span><span class='line'><span class="s2">&quot;0x5814d945ec909eb1307be4f133aaab3def3572f0&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>CLI - Attach</h2>

<p>Run the geth console:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>geth attach /blockchain/ethereum/data/geth.ipc
</span><span class='line'>Welcome to the Geth JavaScript console!
</span><span class='line'>
</span><span class='line'>instance: Geth/v1.10.13-stable-eae3b194/linux-amd64/go1.17
</span><span class='line'>at block: <span class="m">11173667</span> <span class="o">(</span>Wed Oct <span class="m">06</span> <span class="m">2021</span> 08:00:44 GMT+0200 <span class="o">(</span>SAST<span class="o">))</span>
</span><span class='line'> datadir: /blockchain/ethereum/data
</span><span class='line'> modules: admin:1.0 debug:1.0 eth:1.0 ethash:1.0 les:1.0 net:1.0 personal:1.0 rpc:1.0 txpool:1.0 vflux:1.0 web3:1.0
</span><span class='line'>
</span><span class='line'>To <span class="nb">exit</span>, press ctrl-d or <span class="nb">type exit</span>
</span><span class='line'>&gt;
</span></code></pre></td></tr></table></div></figure>


<p>We can run <code>net</code> to show us the peercounts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; net
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  listening: <span class="nb">true</span>,
</span><span class='line'>  peerCount: 1,
</span><span class='line'>  version: <span class="s2">&quot;3&quot;</span>,
</span><span class='line'>  getListening: <span class="k">function</span><span class="o">(</span>callback<span class="o">)</span>,
</span><span class='line'>  getPeerCount: <span class="k">function</span><span class="o">(</span>callback<span class="o">)</span>,
</span><span class='line'>  getVersion: <span class="k">function</span><span class="o">(</span>callback<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or if we just want to access the peerCount value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; net.peerCount
</span><span class='line'>1
</span></code></pre></td></tr></table></div></figure>


<p>To view the peers thats connected:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; admin.peers
</span><span class='line'><span class="o">[{</span>
</span><span class='line'>    caps: <span class="o">[</span><span class="s2">&quot;eth/66&quot;</span>, <span class="s2">&quot;les/2&quot;</span>, <span class="s2">&quot;les/3&quot;</span>, <span class="s2">&quot;les/4&quot;</span>, <span class="s2">&quot;snap/1&quot;</span><span class="o">]</span>,
</span><span class='line'>    enode: <span class="s2">&quot;enode://3b76ec5359e59048721de8b6ff97a064ea280233d37433222ce7efcdac700c987326734983c9b65f8f1914c40e1efd6b43999912a3bca208fcbb540a678db110@93.75.22.22:30308&quot;</span>,
</span><span class='line'>    enr: <span class="s2">&quot;enr:-KO4QD2mp_FKB4ZDpfOAD_ziVnMXo1Mcd-FQl9Abj__EJKr9As6UE0frpdaiOnWjqzuGLGaabaAkG7e2CvfY8LulI9ENg2V0aMfGhHEZtrOAgmlkgnY0gmlwhF1LFhaDbGVzwQGJc2VjcDI1NmsxoQI7duxTWeWQSHId6Lb_l6Bk6igCM9N0MyIs5-_NrHAMmIRzbmFwwIN0Y3CCdmSDdWRwgnZk&quot;</span>,
</span><span class='line'>    id: <span class="s2">&quot;a95433e1bcbcc64f5d1ad8bd2535557d1f5ed2191a760f704d42a925656bb8de&quot;</span>,
</span><span class='line'>    name: <span class="s2">&quot;Geth/v1.10.9-stable-eae3b194/linux-amd64/go1.17&quot;</span>,
</span><span class='line'>    network: <span class="o">{</span>
</span><span class='line'>      inbound: <span class="nb">false</span>,
</span><span class='line'>      localAddress: <span class="s2">&quot;192.168.0.120:55166&quot;</span>,
</span><span class='line'>      remoteAddress: <span class="s2">&quot;93.75.22.22:30308&quot;</span>,
</span><span class='line'>      static: <span class="nb">false</span>,
</span><span class='line'>      trusted: <span class="nb">false</span>
</span><span class='line'>    <span class="o">}</span>,
</span><span class='line'>    protocols: <span class="o">{</span>
</span><span class='line'>      les: <span class="o">{</span>
</span><span class='line'>        difficulty: 35015228630523840,
</span><span class='line'>        head: <span class="s2">&quot;1aa1db0e6810f504f1542e8c3c49cecf17b0c3246b41f45bede42723d22b7c0c&quot;</span>,
</span><span class='line'>        version: 4
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check if the node is syncing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.syncing
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  currentBlock: 11176044,
</span><span class='line'>  highestBlock: 11176158,
</span><span class='line'>  knownStates: 40043719,
</span><span class='line'>  pulledStates: 39904521,
</span><span class='line'>  startingBlock: 0
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can view our accounts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.accounts
</span><span class='line'><span class="o">[</span><span class="s2">&quot;0x2b1718cdf7dbcc381267ccf43d320c6e194d6aa8&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>And get the balance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.getBalance<span class="o">(</span>eth.accounts<span class="o">[</span>0<span class="o">])</span>
</span><span class='line'>300000000000000000
</span></code></pre></td></tr></table></div></figure>


<h2>CLI - SendTransaction</h2>

<p>The account that will be receiving the funds (host-a):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>geth attach /blockchain/ethereum/data/geth.ipc
</span><span class='line'>&gt; eth.accounts<span class="o">[</span>0<span class="o">]</span>
</span><span class='line'><span class="s2">&quot;0x2b1718cdf7dbcc381267ccf43d320c6e194d6aa8&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s current balance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.getBalance<span class="o">(</span>eth.accounts<span class="o">[</span>0<span class="o">])</span>
</span><span class='line'>20485608293038927543
</span></code></pre></td></tr></table></div></figure>


<p>On the account that we will be sending from (host-b):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>geth attach /blockchain/ethereum/data/geth.ipc
</span><span class='line'>&gt; eth.accounts<span class="o">[</span>0<span class="o">]</span>
</span><span class='line'><span class="s2">&quot;0xd490fb53c0e7d3c80153112a4bd135e2cf897282&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s current balance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.getBalance<span class="o">(</span>eth.accounts<span class="o">[</span>0<span class="o">])</span>
</span><span class='line'>2001712477998186788
</span></code></pre></td></tr></table></div></figure>


<p>When we attempt to send 1ETH to the recipient address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.sendTransaction<span class="o">({</span>from: <span class="s2">&quot;0xd490fb53c0e7d3c80153112a4bd135e2cf897282&quot;</span>, to: <span class="s2">&quot;0x2b1718cdf7dbcc381267ccf43d320c6e194d6aa8&quot;</span>, value: <span class="s2">&quot;1000000000000000000&quot;</span><span class="o">})</span>
</span><span class='line'>Error: authentication needed: password or unlock
</span><span class='line'>  at web3.js:6357:37<span class="o">(</span>47<span class="o">)</span>
</span><span class='line'>  at web3.js:5091:62<span class="o">(</span>37<span class="o">)</span>
</span><span class='line'>  at &lt;<span class="nb">eval</span>&gt;:1:20<span class="o">(</span>10<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will notice that we need to unlock our account first:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; web3.personal.unlockAccount<span class="o">(</span>web3.personal.listAccounts<span class="o">[</span>0<span class="o">]</span>, null, 60<span class="o">)</span>
</span><span class='line'>Unlock account 0xd490fb53c0e7d3c80153112a4bd135e2cf897282
</span><span class='line'>Passphrase:
</span><span class='line'><span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can send the transaction:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.sendTransaction<span class="o">({</span>from: <span class="s2">&quot;0xd490fb53c0e7d3c80153112a4bd135e2cf897282&quot;</span>, to: <span class="s2">&quot;0x2b1718cdf7dbcc381267ccf43d320c6e194d6aa8&quot;</span>, value: <span class="s2">&quot;1000000000000000000&quot;</span><span class="o">})</span>
</span><span class='line'><span class="s2">&quot;0x4bffabf28b71e6f83a48f0accb850b232dc3f482e30d942be3a2eb53d639d4bd&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the transaction id can be looked up on the ropsten blockexplorer:
- <a href="https://ropsten.etherscan.io/tx/0x4bffabf28b71e6f83a48f0accb850b232dc3f482e30d942be3a2eb53d639d4bd">https://ropsten.etherscan.io/tx/0x4bffabf28b71e6f83a48f0accb850b232dc3f482e30d942be3a2eb53d639d4bd</a></p>

<p>And after the confirmations has been confirmed, we can see in our receiving account, we received the funds:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.getBalance<span class="o">(</span>eth.accounts<span class="o">[</span>0<span class="o">])</span>
</span><span class='line'>21485608293038927543
</span></code></pre></td></tr></table></div></figure>


<h2>Web3</h2>

<p>Run a python environment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker run -it python:3.8.5-slim bash
</span></code></pre></td></tr></table></div></figure>


<p>Install dependencies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>apt update
</span><span class='line'>apt install python3-dev gcc -y
</span><span class='line'>pip install web3<span class="o">[</span>tester<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The examples I will be following was extracted from the documentation:
- <a href="https://ethereum.org/ml/developers/tutorials/a-developers-guide-to-ethereum-part-one/">https://ethereum.org/ml/developers/tutorials/a-developers-guide-to-ethereum-part-one/</a></p>

<p>Instantiate a client and connect to your geth node, [this documentation] provides different methods of connecting, but I will be using the <code>HTTPProvider</code> to connect over the network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">web3</span> <span class="kn">import</span> <span class="n">Web3</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="s">&#39;http://192.168.0.120:8545&#39;</span><span class="p">))</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">w3</span><span class="o">.</span><span class="n">isConnected</span><span class="p">()</span>
</span><span class='line'><span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<p>List the accounts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python3'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">accounts</span>
</span><span class='line'><span class="p">[</span><span class="s">&#39;0x2b1718CdF7dBcc381267CCF43D320C6e194D6aa8&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Get the balance in Wei:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python3'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">account</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span class='line'><span class="mi">300000000000000000</span>
</span></code></pre></td></tr></table></div></figure>


<p>Convert from Wei to ETH:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">balance_wei</span> <span class="o">=</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">w3</span><span class="o">.</span><span class="n">fromWei</span><span class="p">(</span><span class="n">balance_wei</span><span class="p">,</span> <span class="s">&#39;ether&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;0.3&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Get the information about the latest block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="s">&#39;latest&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">AttributeDict</span><span class="p">({</span><span class="s">&#39;baseFeePerGas&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&#39;difficulty&#39;</span><span class="p">:</span> <span class="mi">2073277081</span><span class="p">,</span> <span class="s">&#39;extraData&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x63732e7064782e65647520676574682076312e31302e38&#39;</span><span class="p">),</span> <span class="s">&#39;gasLimit&#39;</span><span class="p">:</span> <span class="mi">8000000</span><span class="p">,</span> <span class="s">&#39;gasUsed&#39;</span><span class="p">:</span> <span class="mi">3361330</span><span class="p">,</span> <span class="s">&#39;hash&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0xd06a7a734413bcffa4d56617b7efb9ebd8e684c5fcc7fd4f3ec85b8b809b1a0b&#39;</span><span class="p">),</span> <span class="s">&#39;logsBloom&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x00000004080000000001000000000000000000000000000000000000000000860000000000000400000000010000000000000000001000000000000080240000000000000000000000000018000000000000000000040000000000000000000002000000020000000000000000000800000000000000200000000010000000800000000000000002000000020000000040000000000000000001000000000000020800000000000000000000000000000000000000000000000000000000800000004002008000000001000000800000000000000000000000000000000062004010202800004000000000000000000000000040000000000002200000000000&#39;</span><span class="p">),</span> <span class="s">&#39;miner&#39;</span><span class="p">:</span> <span class="s">&#39;0xe9e7034AeD5CE7f5b0D281CFE347B8a5c2c53504&#39;</span><span class="p">,</span> <span class="s">&#39;mixHash&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x42641ef2d13826f9cb070516f81515464af9c5c0a36edaa7c250fec62d18a193&#39;</span><span class="p">),</span> <span class="s">&#39;nonce&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x670ce792aed73895&#39;</span><span class="p">),</span> <span class="s">&#39;number&#39;</span><span class="p">:</span> <span class="mi">11173874</span><span class="p">,</span> <span class="s">&#39;parentHash&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0xe26e265b264e5158a46ee213d39150d90b532db061497027f35ad36e98458895&#39;</span><span class="p">),</span> <span class="s">&#39;receiptsRoot&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x08c15b7365caa993a3047a3093ae641d5b97c51aff058952ab48a56bdee9240b&#39;</span><span class="p">),</span> <span class="s">&#39;sha3Uncles&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347&#39;</span><span class="p">),</span> <span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="mi">16130</span><span class="p">,</span> <span class="s">&#39;stateRoot&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x9e2d99e11b4c71b93f14a563a87945c0ed89e577eefc860a7909bd6f3b8e669f&#39;</span><span class="p">),</span> <span class="s">&#39;timestamp&#39;</span><span class="p">:</span> <span class="mi">1633502988</span><span class="p">,</span> <span class="s">&#39;totalDifficulty&#39;</span><span class="p">:</span> <span class="mi">35015626783987398</span><span class="p">,</span> <span class="s">&#39;transactions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x9013555031ca4510e619968814b75ff428c595488c46a387a6b57774313f4686&#39;</span><span class="p">),</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x899f3dfa8cc0ce7eac397500a014dd624d50c0024e112fa3989403da5669b838&#39;</span><span class="p">),</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0xf0c08c7e6849be5d23e0c603b405012a1baa4252884f8efac3244d3ed77b8622&#39;</span><span class="p">),</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0xb6e03e10e0d6ced0a791f3a9474d760d7248301dc489c5b191aa82b1ef23e677&#39;</span><span class="p">),</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0xb424a4da501df145346027c9c839ae9bf9a25f3672bf13fe097c39f46eda5028&#39;</span><span class="p">),</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0xcb74ac5580485542ca532f5dc46798b84cb26d34ebc127871d6e2ffead6c32c7&#39;</span><span class="p">),</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0xb61cf0eb92798885e4a6309d228e8a31e892e4353810593ba14a2737c1fcd53a&#39;</span><span class="p">),</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x20b27640c1b674be98d3051fac5dcf5ae50d5b7e957defc2336f07b99053fb2c&#39;</span><span class="p">),</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x2929a7384e5b47c4e414142623911a2deca95996e761bc10ccedf607342156af&#39;</span><span class="p">),</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x698af438f73bf384b7c35d4448c0e098d7744b4ce58327dc258a3d5706421c7e&#39;</span><span class="p">)],</span> <span class="s">&#39;transactionsRoot&#39;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s">&#39;0x33cca53eabc2aed8cb0c8a5a7b771b9f14fd2e2aa2561195250411f0714ec768&#39;</span><span class="p">),</span> <span class="s">&#39;uncles&#39;</span><span class="p">:</span> <span class="p">[]})</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Mining</h2>

<p>Note: <code>Light clients do not support mining</code></p>

<p>From another node, im running the fast sync mode on ropsten:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">--</span><span class="n">syncmode</span> <span class="s">&quot;fast&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><a href="https://geth.ethereum.org/docs/interface/mining">https://geth.ethereum.org/docs/interface/mining</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.hashrate
</span><span class='line'>43949
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; eth.coinbase
</span><span class='line'><span class="s2">&quot;0x2b1718cdf7dbcc381267ccf43d320c6e194d6aa8&quot;</span>
</span><span class='line'>&gt; eth.getBalance<span class="o">(</span>eth.coinbase<span class="o">)</span>.toNumber<span class="o">()</span><span class="p">;</span>
</span><span class='line'>145000000000000000000
</span></code></pre></td></tr></table></div></figure>


<h2>Delete Data</h2>

<p>If we look at a fully synced ropsten &ldquo;fast&rdquo; node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>du -h /blockchain/ethereum/
</span><span class='line'>4.0K  /blockchain/ethereum/data/keystore
</span><span class='line'>856K  /blockchain/ethereum/data/geth/triecache
</span><span class='line'>58G   /blockchain/ethereum/data/geth/chaindata/ancient
</span><span class='line'>69G   /blockchain/ethereum/data/geth/chaindata
</span><span class='line'>2.2M  /blockchain/ethereum/data/geth/nodes
</span><span class='line'>188M  /blockchain/ethereum/data/geth/ethash
</span><span class='line'>69G   /blockchain/ethereum/data/geth
</span><span class='line'>69G   /blockchain/ethereum/data
</span><span class='line'>69G   /blockchain/ethereum/
</span></code></pre></td></tr></table></div></figure>


<p>Remove the data with <code>removedb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>geth --datadir /blockchain/ethereum/data removedb
</span><span class='line'>INFO <span class="o">[</span>10-06<span class="p">|</span>20:01:52.061<span class="o">]</span> Maximum peer count                       <span class="nv">ETH</span><span class="o">=</span><span class="m">50</span> <span class="nv">LES</span><span class="o">=</span><span class="m">0</span> <span class="nv">total</span><span class="o">=</span>50
</span><span class='line'>INFO <span class="o">[</span>10-06<span class="p">|</span>20:01:52.061<span class="o">]</span> Smartcard socket not found, disabling    <span class="nv">err</span><span class="o">=</span><span class="s2">&quot;stat /run/pcscd/pcscd.comm: no such file or directory&quot;</span>
</span><span class='line'>INFO <span class="o">[</span>10-06<span class="p">|</span>20:01:52.062<span class="o">]</span> Set global gas cap                       <span class="nv">cap</span><span class="o">=</span>50,000,000
</span><span class='line'>Remove full node state database <span class="o">(</span>/blockchain/ethereum/data/geth/chaindata<span class="o">)</span>? <span class="o">[</span>y/n<span class="o">]</span> y
</span><span class='line'>Remove full node state database <span class="o">(</span>/blockchain/ethereum/data/geth/chaindata<span class="o">)</span>? <span class="o">[</span>y/n<span class="o">]</span> y
</span><span class='line'>INFO <span class="o">[</span>10-06<span class="p">|</span>20:01:57.141<span class="o">]</span> Database successfully deleted            <span class="nv">path</span><span class="o">=</span>/blockchain/ethereum/data/geth/chaindata <span class="nv">elapsed</span><span class="o">=</span>2.482s
</span><span class='line'>Remove full node ancient database <span class="o">(</span>/blockchain/ethereum/data/geth/chaindata/ancient<span class="o">)</span>? <span class="o">[</span>y/n<span class="o">]</span> y
</span><span class='line'>Remove full node ancient database <span class="o">(</span>/blockchain/ethereum/data/geth/chaindata/ancient<span class="o">)</span>? <span class="o">[</span>y/n<span class="o">]</span> y
</span><span class='line'>INFO <span class="o">[</span>10-06<span class="p">|</span>20:02:05.645<span class="o">]</span> Database successfully deleted            <span class="nv">path</span><span class="o">=</span>/blockchain/ethereum/data/geth/chaindata/ancient <span class="nv">elapsed</span><span class="o">=</span>589.737ms
</span><span class='line'>INFO <span class="o">[</span>10-06<span class="p">|</span>20:02:05.645<span class="o">]</span> Light node database missing              <span class="nv">path</span><span class="o">=</span>/blockchain/ethereum/data/geth/lightchaindata
</span></code></pre></td></tr></table></div></figure>


<p>Now when we list the data directory, we can see the data was removed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>du -h /blockchain/ethereum/
</span><span class='line'>8.0K  /blockchain/ethereum/data/keystore
</span><span class='line'>868K  /blockchain/ethereum/data/geth/triecache
</span><span class='line'>4.0K  /blockchain/ethereum/data/geth/chaindata/ancient
</span><span class='line'>180K  /blockchain/ethereum/data/geth/chaindata
</span><span class='line'>1.4M  /blockchain/ethereum/data/geth/nodes
</span><span class='line'>188M  /blockchain/ethereum/data/geth/ethash
</span><span class='line'>190M  /blockchain/ethereum/data/geth
</span><span class='line'>190M  /blockchain/ethereum/data
</span><span class='line'>190M  /blockchain/ethereum/
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<ul>
<li><a href="https://ethereum.org/ml/developers/tutorials/a-developers-guide-to-ethereum-part-one/">Use web3 in python</a></li>
<li><a href="https://www.linkedin.com/pulse/how-mine-ropsten-testnet-ether-keir-finlow-bates">How to mine ropsten testnet</a></li>
<li><a href="https://documenter.getpostman.com/view/4117254/ethereum-json-rpc/RVu7CT5J">Ethereum JSON RPC on Postman</a></li>
<li><a href="https://eth.wiki/json-rpc/API#personal_newAccount">ETH WIki - JSON RPC</a></li>
<li><a href="https://gist.github.com/swaldman/e58a866eafc4ff043c4099e394901a1e">https://gist.github.com/swaldman/e58a866eafc4ff043c4099e394901a1e</a></li>
<li><a href="https://ethereum.org/en/developers/tutorials/run-node-raspberry-pi/">Run Geth on a Raspberry Pi - ethereum.org</a></li>
</ul>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Run Docker Containers With Terraform]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/11/23/run-docker-containers-with-terraform/"/>
    <updated>2021-11-23T11:06:03-05:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/11/23/run-docker-containers-with-terraform</id>
    <content type="html"><![CDATA[<p>In this post I will demonstrate how to use the terraform <a href="https://registry.terraform.io/providers/kreuzwerker/docker/latest/docs/resources/container">docker_container</a> resource from the <a href="https://github.com/kreuzwerker/terraform-provider-docker">docker provider</a> to run two docker containers, traefik and nginx and use the random provider to generate a random url for us.</p>

<h2>Pre-Requisites</h2>

<p>You will require <a href="https://www.terraform.io/downloads.html">terraform</a> and <a href="https://docs.docker.com/get-docker/">docker</a> to be installed.</p>

<h2>Project Structure</h2>

<p>The source code for this post is available on my github repository, but the project structure will look like the following:</p>

<p><img src="https://user-images.githubusercontent.com/567298/143061769-c619e7eb-c5b1-42bc-9fa4-ed59c15448fa.png" alt="image" /></p>

<p>Our <code>providers.tf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>terraform {
</span><span class='line'>  required_providers {
</span><span class='line'>    docker = {
</span><span class='line'>      source  = "kreuzwerker/docker"
</span><span class='line'>      version = "2.15.0"
</span><span class='line'>    }
</span><span class='line'>    random = {
</span><span class='line'>      version = "~&gt; 3.0"
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>provider "docker" {
</span><span class='line'>  host = "unix:///var/run/docker.sock"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>provider "random" {}</span></code></pre></td></tr></table></div></figure>


<p>Our <code>variables.tf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>variable "domain" {
</span><span class='line'>  type    = string
</span><span class='line'>  default = "localdns.xyz"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Our <code>outputs.tf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>output "nginx_container_name" {
</span><span class='line'>  value = docker_container.nginx.name
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>output "traefik_container_name" {
</span><span class='line'>  value = docker_container.traefik.name
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>output "traefik_url" {
</span><span class='line'>  value = "http://traefik.${var.domain}/"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>output "nginx_url" {
</span><span class='line'>  value = "http://www.${random_string.nginx.result}.${var.domain}/"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Our <code>main.tf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "random_string" "nginx" {
</span><span class='line'>  length  = 8
</span><span class='line'>  upper   = false
</span><span class='line'>  special = false
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "docker_image" "nginx" {
</span><span class='line'>  name = "nginx:stable-alpine"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "docker_image" "traefik" {
</span><span class='line'>  name = "traefik:1.7.14"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "docker_network" "nginx" {
</span><span class='line'>  name   = "docknet"
</span><span class='line'>  driver = "bridge"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "docker_container" "traefik" {
</span><span class='line'>  name  = "traefik"
</span><span class='line'>  image = docker_image.traefik.name
</span><span class='line'>
</span><span class='line'>  networks_advanced {
</span><span class='line'>    name    = docker_network.nginx.name
</span><span class='line'>    aliases = ["docknet"]
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  restart = "unless-stopped"
</span><span class='line'>  destroy_grace_seconds = 30
</span><span class='line'>  must_run = true
</span><span class='line'>  memory = 256
</span><span class='line'>
</span><span class='line'>  volumes {
</span><span class='line'>    host_path      = "/var/run/docker.sock"
</span><span class='line'>    container_path = "/var/run/docker.sock"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  command = [
</span><span class='line'>    "--api",
</span><span class='line'>    "--docker",
</span><span class='line'>    "--docker.watch",
</span><span class='line'>    "--entrypoints=Name:http Address::80",
</span><span class='line'>    "--logLevel=INFO"
</span><span class='line'>  ]
</span><span class='line'>
</span><span class='line'>  ports {
</span><span class='line'>    internal = 80
</span><span class='line'>    external = 80
</span><span class='line'>    ip       = "0.0.0.0"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  labels {
</span><span class='line'>    label = "traefik.enable"
</span><span class='line'>    value = true
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  labels {
</span><span class='line'>    label = "traefik.docker.network"
</span><span class='line'>    value = "docknet"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  labels {
</span><span class='line'>    label = "traefik.frontend.rule"
</span><span class='line'>    value = "Host:traefik.${var.domain}"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  labels {
</span><span class='line'>    label = "traefik.port"
</span><span class='line'>    value = 8080
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "docker_container" "nginx" {
</span><span class='line'>  name  = "nginx"
</span><span class='line'>  image = docker_image.nginx.name
</span><span class='line'>
</span><span class='line'>  networks_advanced {
</span><span class='line'>    name    = docker_network.nginx.name
</span><span class='line'>    aliases = ["docknet"]
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  restart = "unless-stopped"
</span><span class='line'>  destroy_grace_seconds = 30
</span><span class='line'>  must_run = true
</span><span class='line'>  memory = 256
</span><span class='line'>
</span><span class='line'>  volumes {
</span><span class='line'>    host_path      = "/Users/ruan/personal/terraform-playground/docker-containers/html"
</span><span class='line'>    container_path = "/usr/share/nginx/html"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  volumes {
</span><span class='line'>    host_path      = "/Users/ruan/personal/terraform-playground/docker-containers/configs/nginx.conf"
</span><span class='line'>    container_path = "/etc/nginx/nginx.conf"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  volumes {
</span><span class='line'>    host_path      = "/Users/ruan/personal/terraform-playground/docker-containers/configs/app.conf"
</span><span class='line'>    container_path = "/etc/nginx/conf.d/app.conf"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  env = [
</span><span class='line'>    "PUID=501",
</span><span class='line'>    "PGID=20"
</span><span class='line'>  ]
</span><span class='line'>
</span><span class='line'>  labels {
</span><span class='line'>    label = "traefik.enable"
</span><span class='line'>    value = true
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  labels {
</span><span class='line'>    label = "traefik.docker.network"
</span><span class='line'>    value = "docknet"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  labels {
</span><span class='line'>    label = "traefik.frontend.rule"
</span><span class='line'>    value = "Host:www.${random_string.nginx.result}.${var.domain}"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  labels {
</span><span class='line'>    label = "traefik.port"
</span><span class='line'>    value = 80
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  depends_on = [
</span><span class='line'>    docker_container.traefik,
</span><span class='line'>    random_string.nginx
</span><span class='line'>  ]
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Our <code>html/index.html</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!doctype html&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;title&gt;</span>Welcome<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c">&lt;!-- Fonts --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;https://fonts.googleapis.com/css?family=Nunito:200,600&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c">&lt;!-- Styles --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;style&gt;</span>
</span><span class='line'>            <span class="nt">html</span><span class="o">,</span> <span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">background-color</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
</span><span class='line'>                <span class="k">color</span><span class="o">:</span> <span class="m">#636b6f</span><span class="p">;</span>
</span><span class='line'>                <span class="k">font-family</span><span class="o">:</span> <span class="s1">&#39;Nunito&#39;</span><span class="o">,</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>                <span class="k">font-weight</span><span class="o">:</span> <span class="m">200</span><span class="p">;</span>
</span><span class='line'>                <span class="k">height</span><span class="o">:</span> <span class="m">100</span><span class="n">vh</span><span class="p">;</span>
</span><span class='line'>                <span class="k">margin</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nc">.full-height</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">height</span><span class="o">:</span> <span class="m">100</span><span class="n">vh</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nc">.flex-center</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">align</span><span class="o">-</span><span class="n">items</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>                <span class="k">display</span><span class="o">:</span> <span class="n">flex</span><span class="p">;</span>
</span><span class='line'>                <span class="k">justify</span><span class="o">-</span><span class="k">content</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nc">.position-ref</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">position</span><span class="o">:</span> <span class="k">relative</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nc">.top-right</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
</span><span class='line'>                <span class="k">right</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>                <span class="k">top</span><span class="o">:</span> <span class="m">18px</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nc">.content</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nc">.title</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">font-size</span><span class="o">:</span> <span class="m">84px</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nc">.links</span> <span class="o">&gt;</span> <span class="nt">a</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">color</span><span class="o">:</span> <span class="m">#636b6f</span><span class="p">;</span>
</span><span class='line'>                <span class="k">padding</span><span class="o">:</span> <span class="m">0</span> <span class="m">25px</span><span class="p">;</span>
</span><span class='line'>                <span class="k">font-size</span><span class="o">:</span> <span class="m">13px</span><span class="p">;</span>
</span><span class='line'>                <span class="k">font-weight</span><span class="o">:</span> <span class="m">600</span><span class="p">;</span>
</span><span class='line'>                <span class="k">letter-spacing</span><span class="o">:</span> <span class="o">.</span><span class="m">1</span><span class="n">rem</span><span class="p">;</span>
</span><span class='line'>                <span class="k">text-decoration</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
</span><span class='line'>                <span class="k">text-transform</span><span class="o">:</span> <span class="k">uppercase</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nc">.m-b-md</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">30px</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;flex-center position-ref full-height&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;title m-b-md&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                    Welcome
</span><span class='line'>                <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;links&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;https://ruan.dev&quot;</span> <span class="na">target=</span><span class="s">&quot;_blank&quot;</span><span class="nt">&gt;</span>About Me<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>configs/nginx.conf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>user  nginx;
</span><span class='line'>worker_processes  auto;
</span><span class='line'>error_log  /var/log/nginx/error.log notice;
</span><span class='line'>pid        /var/run/nginx.pid;
</span><span class='line'>
</span><span class='line'>events {
</span><span class='line'>    worker_connections  1024;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>http {
</span><span class='line'>    include       /etc/nginx/mime.types;
</span><span class='line'>    default_type  application/octet-stream;
</span><span class='line'>
</span><span class='line'>    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
</span><span class='line'>                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
</span><span class='line'>                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;
</span><span class='line'>
</span><span class='line'>    access_log  /var/log/nginx/access.log  main;
</span><span class='line'>    sendfile        on;
</span><span class='line'>    keepalive_timeout  65;
</span><span class='line'>
</span><span class='line'>    include /etc/nginx/conf.d/app.conf;
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>And lastly, our <code>configs/app.conf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>server {
</span><span class='line'>  listen 80;
</span><span class='line'>  server_name _;
</span><span class='line'>
</span><span class='line'>  location / {
</span><span class='line'>    root   /usr/share/nginx/html;
</span><span class='line'>    index  index.html;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  location /healthz {
</span><span class='line'>    return 200 &#39;up&#39;;
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h2>Deployment</h2>

<p>Once everything is in place, or if you want to clone my repository, you can do that by:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>git clone https://github.com/ruanbekker/terraform-docker-container-example
</span><span class='line'>cd terraform-docker-container-example
</span></code></pre></td></tr></table></div></figure>


<p>Then we can initialize terraform by fetching the required plugins:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Once that completes we can run a plan:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>terraform plan
</span></code></pre></td></tr></table></div></figure>


<p>And that should output something more or less like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with
</span><span class='line'>the following symbols:
</span><span class='line'>  + create
</span><span class='line'>
</span><span class='line'>Terraform will perform the following actions:
</span><span class='line'>
</span><span class='line'>  # docker_container.nginx will be created
</span><span class='line'>  + resource &quot;docker_container&quot; &quot;nginx&quot; {
</span><span class='line'>      + attach                = false
</span><span class='line'>      + bridge                = (known after apply)
</span><span class='line'>      + command               = (known after apply)
</span><span class='line'>      + container_logs        = (known after apply)
</span><span class='line'>      + destroy_grace_seconds = 30
</span><span class='line'>      + entrypoint            = (known after apply)
</span><span class='line'>      + env                   = [
</span><span class='line'>          + &quot;PGID=20&quot;,
</span><span class='line'>          + &quot;PUID=501&quot;,
</span><span class='line'>        ]
</span><span class='line'>      + exit_code             = (known after apply)
</span><span class='line'>      + gateway               = (known after apply)
</span><span class='line'>      + hostname              = (known after apply)
</span><span class='line'>      + id                    = (known after apply)
</span><span class='line'>      + image                 = &quot;nginx:stable-alpine&quot;
</span><span class='line'>      + init                  = (known after apply)
</span><span class='line'>      + ip_address            = (known after apply)
</span><span class='line'>      + ip_prefix_length      = (known after apply)
</span><span class='line'>      + ipc_mode              = (known after apply)
</span><span class='line'>      + log_driver            = &quot;json-file&quot;
</span><span class='line'>      + logs                  = false
</span><span class='line'>      + memory                = 256
</span><span class='line'>      + must_run              = true
</span><span class='line'>      + name                  = &quot;nginx&quot;
</span><span class='line'>      + network_data          = (known after apply)
</span><span class='line'>      + read_only             = false
</span><span class='line'>      + remove_volumes        = true
</span><span class='line'>      + restart               = &quot;unless-stopped&quot;
</span><span class='line'>      + rm                    = false
</span><span class='line'>      + security_opts         = (known after apply)
</span><span class='line'>      + shm_size              = (known after apply)
</span><span class='line'>      + start                 = true
</span><span class='line'>      + stdin_open            = false
</span><span class='line'>      + tty                   = false
</span><span class='line'>
</span><span class='line'>      + healthcheck {
</span><span class='line'>          + interval     = (known after apply)
</span><span class='line'>          + retries      = (known after apply)
</span><span class='line'>          + start_period = (known after apply)
</span><span class='line'>          + test         = (known after apply)
</span><span class='line'>          + timeout      = (known after apply)
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>      + labels {
</span><span class='line'>          + label = &quot;traefik.docker.network&quot;
</span><span class='line'>          + value = &quot;docknet&quot;
</span><span class='line'>        }
</span><span class='line'>      + labels {
</span><span class='line'>          + label = &quot;traefik.enable&quot;
</span><span class='line'>          + value = &quot;true&quot;
</span><span class='line'>        }
</span><span class='line'>      + labels {
</span><span class='line'>          + label = &quot;traefik.frontend.rule&quot;
</span><span class='line'>          + value = (known after apply)
</span><span class='line'>        }
</span><span class='line'>      + labels {
</span><span class='line'>          + label = &quot;traefik.port&quot;
</span><span class='line'>          + value = &quot;80&quot;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>      + networks_advanced {
</span><span class='line'>          + aliases = [
</span><span class='line'>              + &quot;docknet&quot;,
</span><span class='line'>            ]
</span><span class='line'>          + name    = &quot;docknet&quot;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>      + volumes {
</span><span class='line'>          + container_path = &quot;/etc/nginx/conf.d/app.conf&quot;
</span><span class='line'>          + host_path      = &quot;/Users/ruan/personal/terraform-playground/docker-containers/configs/app.conf&quot;
</span><span class='line'>        }
</span><span class='line'>      + volumes {
</span><span class='line'>          + container_path = &quot;/etc/nginx/nginx.conf&quot;
</span><span class='line'>          + host_path      = &quot;/Users/ruan/personal/terraform-playground/docker-containers/configs/nginx.conf&quot;
</span><span class='line'>        }
</span><span class='line'>      + volumes {
</span><span class='line'>          + container_path = &quot;/usr/share/nginx/html&quot;
</span><span class='line'>          + host_path      = &quot;/Users/ruan/personal/terraform-playground/docker-containers/html&quot;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>  # docker_container.traefik will be created
</span><span class='line'>  + resource &quot;docker_container&quot; &quot;traefik&quot; {
</span><span class='line'>      + attach                = false
</span><span class='line'>      + bridge                = (known after apply)
</span><span class='line'>      + command               = [
</span><span class='line'>          + &quot;--api&quot;,
</span><span class='line'>          + &quot;--docker&quot;,
</span><span class='line'>          + &quot;--docker.watch&quot;,
</span><span class='line'>          + &quot;--entrypoints=Name:http Address::80&quot;,
</span><span class='line'>          + &quot;--logLevel=INFO&quot;,
</span><span class='line'>        ]
</span><span class='line'>      + container_logs        = (known after apply)
</span><span class='line'>      + destroy_grace_seconds = 30
</span><span class='line'>      + entrypoint            = (known after apply)
</span><span class='line'>      + env                   = (known after apply)
</span><span class='line'>      + exit_code             = (known after apply)
</span><span class='line'>      + gateway               = (known after apply)
</span><span class='line'>      + hostname              = (known after apply)
</span><span class='line'>      + id                    = (known after apply)
</span><span class='line'>      + image                 = &quot;traefik:1.7.14&quot;
</span><span class='line'>      + init                  = (known after apply)
</span><span class='line'>      + ip_address            = (known after apply)
</span><span class='line'>      + ip_prefix_length      = (known after apply)
</span><span class='line'>      + ipc_mode              = (known after apply)
</span><span class='line'>      + log_driver            = &quot;json-file&quot;
</span><span class='line'>      + logs                  = false
</span><span class='line'>      + memory                = 256
</span><span class='line'>      + must_run              = true
</span><span class='line'>      + name                  = &quot;traefik&quot;
</span><span class='line'>      + network_data          = (known after apply)
</span><span class='line'>      + read_only             = false
</span><span class='line'>      + remove_volumes        = true
</span><span class='line'>      + restart               = &quot;unless-stopped&quot;
</span><span class='line'>      + rm                    = false
</span><span class='line'>      + security_opts         = (known after apply)
</span><span class='line'>      + shm_size              = (known after apply)
</span><span class='line'>      + start                 = true
</span><span class='line'>      + stdin_open            = false
</span><span class='line'>      + tty                   = false
</span><span class='line'>
</span><span class='line'>      + healthcheck {
</span><span class='line'>          + interval     = (known after apply)
</span><span class='line'>          + retries      = (known after apply)
</span><span class='line'>          + start_period = (known after apply)
</span><span class='line'>          + test         = (known after apply)
</span><span class='line'>          + timeout      = (known after apply)
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>      + labels {
</span><span class='line'>          + label = &quot;traefik.docker.network&quot;
</span><span class='line'>          + value = &quot;docknet&quot;
</span><span class='line'>        }
</span><span class='line'>      + labels {
</span><span class='line'>          + label = &quot;traefik.enable&quot;
</span><span class='line'>          + value = &quot;true&quot;
</span><span class='line'>        }
</span><span class='line'>      + labels {
</span><span class='line'>          + label = &quot;traefik.frontend.rule&quot;
</span><span class='line'>          + value = &quot;Host:traefik.localdns.xyz&quot;
</span><span class='line'>        }
</span><span class='line'>      + labels {
</span><span class='line'>          + label = &quot;traefik.port&quot;
</span><span class='line'>          + value = &quot;8080&quot;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>      + networks_advanced {
</span><span class='line'>          + aliases = [
</span><span class='line'>              + &quot;docknet&quot;,
</span><span class='line'>            ]
</span><span class='line'>          + name    = &quot;docknet&quot;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>      + ports {
</span><span class='line'>          + external = 80
</span><span class='line'>          + internal = 80
</span><span class='line'>          + ip       = &quot;0.0.0.0&quot;
</span><span class='line'>          + protocol = &quot;tcp&quot;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>      + volumes {
</span><span class='line'>          + container_path = &quot;/var/run/docker.sock&quot;
</span><span class='line'>          + host_path      = &quot;/var/run/docker.sock&quot;
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>  # docker_image.nginx will be created
</span><span class='line'>  + resource &quot;docker_image&quot; &quot;nginx&quot; {
</span><span class='line'>      + id          = (known after apply)
</span><span class='line'>      + latest      = (known after apply)
</span><span class='line'>      + name        = &quot;nginx:stable-alpine&quot;
</span><span class='line'>      + output      = (known after apply)
</span><span class='line'>      + repo_digest = (known after apply)
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>  # docker_image.traefik will be created
</span><span class='line'>  + resource &quot;docker_image&quot; &quot;traefik&quot; {
</span><span class='line'>      + id          = (known after apply)
</span><span class='line'>      + latest      = (known after apply)
</span><span class='line'>      + name        = &quot;traefik:1.7.14&quot;
</span><span class='line'>      + output      = (known after apply)
</span><span class='line'>      + repo_digest = (known after apply)
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>  # docker_network.nginx will be created
</span><span class='line'>  + resource &quot;docker_network&quot; &quot;nginx&quot; {
</span><span class='line'>      + driver      = &quot;bridge&quot;
</span><span class='line'>      + id          = (known after apply)
</span><span class='line'>      + internal    = (known after apply)
</span><span class='line'>      + ipam_driver = &quot;default&quot;
</span><span class='line'>      + name        = &quot;docknet&quot;
</span><span class='line'>      + options     = (known after apply)
</span><span class='line'>      + scope       = (known after apply)
</span><span class='line'>
</span><span class='line'>      + ipam_config {
</span><span class='line'>          + aux_address = (known after apply)
</span><span class='line'>          + gateway     = (known after apply)
</span><span class='line'>          + ip_range    = (known after apply)
</span><span class='line'>          + subnet      = (known after apply)
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>  # random_string.nginx will be created
</span><span class='line'>  + resource &quot;random_string&quot; &quot;nginx&quot; {
</span><span class='line'>      + id          = (known after apply)
</span><span class='line'>      + length      = 8
</span><span class='line'>      + lower       = true
</span><span class='line'>      + min_lower   = 0
</span><span class='line'>      + min_numeric = 0
</span><span class='line'>      + min_special = 0
</span><span class='line'>      + min_upper   = 0
</span><span class='line'>      + number      = true
</span><span class='line'>      + result      = (known after apply)
</span><span class='line'>      + special     = false
</span><span class='line'>      + upper       = false
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>Plan: 6 to add, 0 to change, 0 to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + nginx_container_name   = &quot;nginx&quot;
</span><span class='line'>  + nginx_url              = (known after apply)
</span><span class='line'>  + traefik_container_name = &quot;traefik&quot;
</span><span class='line'>  + traefik_url            = &quot;http://traefik.localdns.xyz/&quot;
</span></code></pre></td></tr></table></div></figure>


<p>Which we can see will create 2 containers, traefik and then nginx, map the configs and html in place and also sets the traefik hostname in the labels for our respective containers so that we can reach them via the specific host headers.</p>

<p>The we can deploy our containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>terraform apply -auto-approve
</span></code></pre></td></tr></table></div></figure>


<p>Which will provide us the output detail defined from our <code>outputs.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>Apply complete! Resources: 6 added, 0 changed, 0 destroyed.
</span><span class='line'>
</span><span class='line'>Outputs:
</span><span class='line'>
</span><span class='line'>nginx_container_name = &quot;nginx&quot;
</span><span class='line'>nginx_url = &quot;http://www.5igjdfq9.localdns.xyz/&quot;
</span><span class='line'>traefik_container_name = &quot;traefik&quot;
</span><span class='line'>traefik_url = &quot;http://traefik.localdns.xyz/&quot;
</span></code></pre></td></tr></table></div></figure>


<h2>Access our Containers</h2>

<p>We can access our Traefik Dashboard on <a href="http://traefik.localdns.xyz">http://traefik.localdns.xyz</a> and should look something like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/143064031-23e9dbe4-522b-4f11-96f9-f30a2104ee44.png" alt="image" /></p>

<p>And when we access our Nginx container on <a href="http://www.5igjdfq9.localdns.xyz">http://www.5igjdfq9.localdns.xyz</a> it should look more or less like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/143064228-88107b75-31fc-41eb-aee0-f26ff976c42a.png" alt="image" /></p>

<p>Running a <code>docker ps</code> will show our running containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>docker ps
</span><span class='line'>CONTAINER ID   IMAGE                  COMMAND                  CREATED         STATUS                PORTS                NAMES
</span><span class='line'>e45158ae8cba   nginx:stable-alpine    &quot;/docker-entrypoint   3 minutes ago   Up 3 minutes          80/tcp               nginx
</span><span class='line'>ebdbe42a0fcb   traefik:1.7.14         &quot;/traefik --api       3 minutes ago   Up 3 minutes          0.0.0.0:80-&gt;80/tcp   traefik
</span></code></pre></td></tr></table></div></figure>


<h2>Cleanup</h2>

<p>We can delete our containers by running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>terraform destroy -auto-approve
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup Traefik Version 2 on Docker]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/11/03/setup-traefik-version-2-on-docker/"/>
    <updated>2021-11-03T01:20:27-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/11/03/setup-traefik-version-2-on-docker</id>
    <content type="html"><![CDATA[<p>In this tutorial we will be setting up <a href="https://traefik.io">Traefik </a> v2 as our reverse proxy with port 80 and 443 enabled, and then hook up a example application behind the application load balancer, and route incoiming requests via host headers.</p>

<h2>What is Traefik</h2>

<p>Traefik is a modern HTTP reverse proxy and load balancer that makes deploying microservices super easy by making use of docker labels to route your traffic based on host headers, path prefixes etc. Please check out <a href="https://doc.traefik.io/traefik/">their website</a> to find out more about them.</p>

<h2>Use Case</h2>

<p>In our example we want to route traefik from <code>http://app.selfhosted.co.za</code> to hit our proxy on port 80, then we want traefik to redirect port 80 to the 443 port configured on the proxy which is configured with letsencrypt and reverse proxy the connection to our application.</p>

<p>The application is being configured via docker labels, which we will get into later.</p>

<h2>Our Environment</h2>

<p>I will be using the domain <code>selfhosted.co.za</code>, so if you are following along, you can just replace this domain with yours.</p>

<p>For this demonstration I have spun up a VM at <a href="https://civo.com">Civo</a> as you can see below:</p>

<p><img src="https://user-images.githubusercontent.com/567298/125192278-5023a200-e247-11eb-97c6-cebd65f22f07.png" alt="image" /></p>

<p>From the provided public IP address, we will be creating a DNS A record for our domain, and then create a wildcard entry to CNAME to our initial dns name:</p>

<p><img src="https://user-images.githubusercontent.com/567298/125192297-6b8ead00-e247-11eb-9c01-740557838a12.png" alt="image" /></p>

<p>You might not want to point all the subdomains to that entry, but to simplify things, every application that needs to be routed via traefik, I can manage from a traefik config level, since my dns is already pointing to the public ip where traefik is running on.</p>

<p>So if I spin up a new container, lets say <code>bitwarden</code>, I can just set <code>bitwarden.selfhosted.co.za</code> in the labels of that container and due to the dns already pointing to traefik, traefik will route the connection to the correct container.</p>

<h2>Pre-Requisites</h2>

<p>In order to follow along you will need <a href="https://docs.docker.com/get-docker/">docker</a> and <a href="https://docs.docker.com/compose/install/">docker-compose</a> to be installed, and can be validated using:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker -v
</span><span class='line'>Docker version 20.10.7, build f0df350
</span><span class='line'>
</span><span class='line'>docker-compose -v
</span><span class='line'>docker-compose version 1.28.6, build 5db8d86f</span></code></pre></td></tr></table></div></figure>


<h2>Traefik on Docker</h2>

<p>We will have one <code>docker-compose.yml</code> file which has the proxy and the example application. Be sure to change the following to suite your environment:
- <code>traefik.http.routers.api.rule=Host()'</code>
- <code>--certificatesResolvers.letsencrypt.acme.email=youremail@yourdomain.net</code></p>

<p>The compose:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.8&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">traefik</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">traefik:2.4</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">traefik</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./traefik/acme.json:/acme.json</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docknet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.enable=true&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.api.rule=Host(`traefik.selfhosted.co.za`)&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.api.entrypoints=https&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.api.service=api@internal&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.api.tls=true&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.api.tls.certresolver=letsencrypt&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">80:80</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">443:443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--api&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--providers.docker=true&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--providers.docker.exposedByDefault=false&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--entrypoints.http=true&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--entrypoints.http.address=:80&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--entrypoints.http.http.redirections.entrypoint.to=https&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--entrypoints.http.http.redirections.entrypoint.scheme=https&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--entrypoints.https=true&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--entrypoints.https.address=:443&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--certificatesResolvers.letsencrypt.acme.email=youremail@yourdomain.net&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--certificatesResolvers.letsencrypt.acme.storage=acme.json&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--certificatesResolvers.letsencrypt.acme.httpChallenge.entryPoint=http&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--log=true&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--log.level=INFO&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">webapp</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">traefik/whoami</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docknet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.enable=true&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.rule=Host(`app.selfhosted.co.za`)&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.entrypoints=https&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.tls=true&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.tls.certresolver=letsencrypt&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.service=webappservice&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.services.webappservice.loadbalancer.server.port=80&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">docknet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docknet</span>
</span></code></pre></td></tr></table></div></figure>


<p>Prepare the <code>./traefik/acme.json</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">mkdir traefik</span>
</span><span class='line'><span class="l-Scalar-Plain">touch traefik/acme.json</span>
</span><span class='line'><span class="l-Scalar-Plain">chmod 600 traefik/acme.json</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see in order to wire a application onto the proxy we need the following labels:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&#39;traefik.enable=true&#39;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.rule=Host(`app.selfhosted.co.za`)&#39;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.entrypoints=https&#39;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.tls=true&#39;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.tls.certresolver=letsencrypt&#39;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.routers.webapp.service=webappservice&#39;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&#39;traefik.http.services.webappservice.loadbalancer.server.port=80&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now boot our stack using docker-compose:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>


<p>You can follow the logs to ensure everything works as expected:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose logs -f
</span><span class='line'>Attaching to webapp, traefik
</span><span class='line'>traefik    <span class="p">|</span> <span class="nb">time</span><span class="o">=</span><span class="s2">&quot;2021-07-11T11:02:22Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Configuration loaded from flags.&quot;</span>
</span><span class='line'>traefik    <span class="p">|</span> <span class="nb">time</span><span class="o">=</span><span class="s2">&quot;2021-07-11T11:02:22Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting provider aggregator.ProviderAggregator {}&quot;</span>
</span><span class='line'>traefik    <span class="p">|</span> <span class="nb">time</span><span class="o">=</span><span class="s2">&quot;2021-07-11T11:02:22Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting provider *traefik.Provider {}&quot;</span>
</span><span class='line'>traefik    <span class="p">|</span> <span class="nb">time</span><span class="o">=</span><span class="s2">&quot;2021-07-11T11:02:22Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting provider *docker.Provider {\&quot;watch\&quot;:true,\&quot;endpoint\&quot;:\&quot;unix:///var/run/docker.so                                              ck\&quot;,\&quot;defaultRule\&quot;:\&quot;Host(``)\&quot;,\&quot;swarmModeRefreshSeconds\&quot;:\&quot;15s\&quot;}&quot;</span>
</span><span class='line'>traefik    <span class="p">|</span> <span class="nb">time</span><span class="o">=</span><span class="s2">&quot;2021-07-11T11:02:22Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting provider *acme.ChallengeTLSALPN {\&quot;Timeout\&quot;:4000000000}&quot;</span>
</span><span class='line'>traefik    <span class="p">|</span> <span class="nb">time</span><span class="o">=</span><span class="s2">&quot;2021-07-11T11:02:22Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Starting provider *acme.Provider {\&quot;email\&quot;:\&quot;youremail@domain.com\&quot;,\&quot;caServer\&quot;:\&quot;https://                                              acme-v02.api.letsencrypt.org/directory\&quot;,\&quot;storage\&quot;:\&quot;acme.json\&quot;,\&quot;keyType\&quot;:\&quot;RSA4096\&quot;,\&quot;httpChallenge\&quot;:{\&quot;entryPoint\&quot;:\&quot;http\&quot;},\&quot;ResolverNam                                              e\&quot;:\&quot;letsencrypt\&quot;,\&quot;store\&quot;:{},\&quot;TLSChallengeProvider\&quot;:{\&quot;Timeout\&quot;:4000000000},\&quot;HTTPChallengeProvider\&quot;:{}}&quot;</span>
</span><span class='line'>traefik    <span class="p">|</span> <span class="nb">time</span><span class="o">=</span><span class="s2">&quot;2021-07-11T11:02:22Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Testing certificate renew...&quot;</span> <span class="nv">providerName</span><span class="o">=</span>letsencrypt.acme
</span><span class='line'>traefik    <span class="p">|</span> <span class="nb">time</span><span class="o">=</span><span class="s2">&quot;2021-07-11T11:02:24Z&quot;</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span>Register... <span class="nv">providerName</span><span class="o">=</span>letsencrypt.acme
</span><span class='line'>webapp     <span class="p">|</span> Starting up on port 80
</span></code></pre></td></tr></table></div></figure>


<p>The certificate process might take anything from 5-30s in my experience.</p>

<h2>Test the Application</h2>

<p>Now that our <code>webapp</code> container is running, make a http request using curl against the configured host rule, which is <code>app.selfhosted.co.za</code> on <code>http</code> so that we can validate if traefik is doing a redirect to <code>https</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -IL http://app.selfhosted.co.za:80
</span><span class='line'>
</span><span class='line'>HTTP/1.1 <span class="m">308</span> Permanent Redirect
</span><span class='line'>Location: https://app.selfhosted.co.za/
</span><span class='line'>Date: Sun, <span class="m">11</span> Jul <span class="m">2021</span> 11:05:47 GMT
</span><span class='line'>Content-Length: 18
</span><span class='line'>Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span><span class='line'>
</span><span class='line'>HTTP/2 200
</span><span class='line'>content-type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span><span class='line'>date: Sun, <span class="m">11</span> Jul <span class="m">2021</span> 11:05:47 GMT
</span><span class='line'>content-length: 343
</span></code></pre></td></tr></table></div></figure>


<p>If we access our <code>webapp</code> service in our web browser, we will see the following:</p>

<p><img src="https://user-images.githubusercontent.com/567298/125192768-c1fceb00-e249-11eb-8b67-7347b4d16a8f.png" alt="image" /></p>

<p>We can also validate that the certificate is valid:</p>

<p><img src="https://user-images.githubusercontent.com/567298/125196546-a9490100-e25a-11eb-8e94-0d7af307d2fb.png" alt="image" /></p>

<p>We can also access the traefik dashboard using the configured domain, in this case <code>traefik.selfhosted.co.za</code>, and you should see the pretty traefik dashboard:</p>

<p><img src="https://user-images.githubusercontent.com/567298/125196448-4bb4b480-e25a-11eb-906b-a221d1415f38.png" alt="image" /></p>

<h2>Future Posts</h2>

<p>In future posts I will be using this post as the base setup on getting traefik up and running, and future posts that uses traefik will be tagged under <a href="https://containers.fan/tags/traefik/">#traefik</a>.</p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Nodejs on Linux Using NVM]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/10/11/install-nodejs-on-linux-using-nvm/"/>
    <updated>2021-10-11T19:07:43-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/10/11/install-nodejs-on-linux-using-nvm</id>
    <content type="html"><![CDATA[<p>In this post we will install Nodejs using Node Version Manager (nvm), which allows you to install and use different versions of node via the command line.</p>

<p>For more information on NVM, checkout their <a href="https://github.com/nvm-sh/nvm">github repository</a></p>

<h2>Install</h2>

<p>I will be using a debian based linux distribution, so I first will be updating my package manager&rsquo;s indexes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update
</span></code></pre></td></tr></table></div></figure>


<p>Then I will install NVM using the instructions from <a href="https://github.com/nvm-sh/nvm#installing-and-updating">their</a> repository (always ensure that you are aware what you are installing when you curl, pipe, bash):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh <span class="p">|</span> bash
</span></code></pre></td></tr></table></div></figure>


<h2>Verify</h2>

<p>You can now log out and log back in for your path to be updated, or you can follow the instructions on your terminal to source your session so that your path to nvm is updated:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">NVM_DIR</span><span class="o">=</span><span class="s2">&quot;$HOME/.nvm&quot;</span>
</span><span class='line'><span class="nv">$ </span><span class="o">[</span> -s <span class="s2">&quot;$NVM_DIR/bash_completion&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\.</span> <span class="s2">&quot;$NVM_DIR/bash_completion&quot;</span>
</span><span class='line'><span class="nv">$ </span><span class="o">[</span> -s <span class="s2">&quot;$NVM_DIR/nvm.sh&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\.</span> <span class="s2">&quot;$NVM_DIR/nvm.sh&quot;</span>
</span><span class='line'><span class="nv">$ </span><span class="o">[</span> -s <span class="s2">&quot;$NVM_DIR/bash_completion&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\.</span> <span class="s2">&quot;$NVM_DIR/bash_completion&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you can verify if <code>nvm</code> is in your path:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">command</span> -v nvm
</span><span class='line'>nvm
</span></code></pre></td></tr></table></div></figure>


<h2>Installing a Node Version</h2>

<p>Before we install a specific version of nodejs, let&rsquo;s first look at the LTS versions from the Fermium release:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nvm ls-remote --lts<span class="o">=</span>fermium
</span><span class='line'>       v14.15.0   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.15.1   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.15.2   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.15.3   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.15.4   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.15.5   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.16.0   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.16.1   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.17.0   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.17.1   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.17.2   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.17.3   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.17.4   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.17.5   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.17.6   <span class="o">(</span>LTS: Fermium<span class="o">)</span>
</span><span class='line'>       v14.18.0   <span class="o">(</span>Latest LTS: Fermium<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So I want to install <code>v14.8.0</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nvm install 14.8.0
</span></code></pre></td></tr></table></div></figure>


<p>I also would like to make it my default version of node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nvm <span class="nb">alias </span>default node
</span><span class='line'>default -&gt; node <span class="o">(</span>-&gt; v14.8.0<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Verify Installation</h2>

<p>Now we can verify if <code>npm</code> is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>npm -v
</span><span class='line'>6.14.7
</span></code></pre></td></tr></table></div></figure>


<p>as well as <code>node</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>node -v
</span><span class='line'>v14.8.0
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup TLS and Basic Authentication on Node Exporter for Prometheus]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/10/10/setup-basic-authentication-on-node-exporter-and-prometheus/"/>
    <updated>2021-10-10T16:50:17-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/10/10/setup-basic-authentication-on-node-exporter-and-prometheus</id>
    <content type="html"><![CDATA[<p>I had a public VPS server that I wanted to scrape node-exporter metrics from, but my Prometheus instance was behind a Dynamic IP address, so to allow only my prometheus instance to scrape my Node Exporter instance, was a bit difficult, since the IP keep changing and I had to update my iptables firewall rules.</p>

<p>In this tutorial I will show you how to setup TLS and Basic Authentication on Node Exporter, and how to configure prometheus to pass the auhtentication to successfully scrape the node exporter metrics endpoint.</p>

<h2>Install Node Exporter</h2>

<p>On the node-exporter host, set the environment variables for the version, user and directory path where node exporter will be installed::</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ NODE_EXPORTER_VERSION</span><span class="o">=</span><span class="s2">&quot;1.1.2&quot;</span>
</span><span class='line'><span class="nv">$ NODE_EXPORTER_USER</span><span class="o">=</span><span class="s2">&quot;node_exporter&quot;</span>
</span><span class='line'><span class="nv">$ BIN_DIRECTORY</span><span class="o">=</span><span class="s2">&quot;/usr/local/bin&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Download and place the node-exporter binary in place:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/prometheus/node_exporter/releases/download/v<span class="k">${</span><span class="nv">NODE_EXPORTER_VERSION</span><span class="k">}</span>/node_exporter-<span class="k">${</span><span class="nv">NODE_EXPORTER_VERSION</span><span class="k">}</span>.linux-amd64.tar.gz
</span><span class='line'><span class="nv">$ </span>tar -xf node_exporter-<span class="k">${</span><span class="nv">NODE_EXPORTER_VERSION</span><span class="k">}</span>.linux-amd64.tar.gz
</span><span class='line'><span class="nv">$ </span>cp node_exporter-<span class="k">${</span><span class="nv">NODE_EXPORTER_VERSION</span><span class="k">}</span>.linux-amd64/node_exporter <span class="k">${</span><span class="nv">BIN_DIRECTORY</span><span class="k">}</span>/
</span><span class='line'><span class="nv">$ </span>chown <span class="k">${</span><span class="nv">NODE_EXPORTER_USER</span><span class="k">}</span>:<span class="k">${</span><span class="nv">NODE_EXPORTER_USER</span><span class="k">}</span> <span class="k">${</span><span class="nv">BIN_DIRECTORY</span><span class="k">}</span>/node_exporter
</span><span class='line'><span class="nv">$ </span>rm -rf node_exporter-<span class="k">${</span><span class="nv">NODE_EXPORTER_VERSION</span><span class="k">}</span>.linux-amd64*
</span><span class='line'><span class="nv">$ </span>mkdir /etc/node-exporter
</span></code></pre></td></tr></table></div></figure>


<h2>Configuration</h2>

<p>Create a self-signed cert for node-exporter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>openssl req -new -newkey rsa:2048 -days <span class="m">365</span> -nodes -x509 -keyout node_exporter.key -out node_exporter.crt -subj <span class="s2">&quot;/C=ZA/ST=CT/L=SA/O=VPN/CN=localhost&quot;</span> -addext <span class="s2">&quot;subjectAltName = DNS:localhost&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Move the certs into the directory we created:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mv node_exporter.* /etc/node-exporter/
</span></code></pre></td></tr></table></div></figure>


<p>Install htpasswd so that we can generate a password hash with bcrypt, which will prompt you for a password that we are setting for the prometheus user::</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install apache2-utils
</span><span class='line'><span class="nv">$ </span>htpasswd -nBC <span class="m">10</span> <span class="s2">&quot;&quot;</span> <span class="p">|</span> tr -d <span class="s1">&#39;:\n&#39;</span><span class="p">;</span> <span class="nb">echo</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now populate the config for node-exporter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/node-exporter/config.yml
</span><span class='line'>tls_server_config:
</span><span class='line'>  cert_file: node_exporter.crt
</span><span class='line'>  key_file: node_exporter.key
</span><span class='line'>basic_auth_users:
</span><span class='line'>  prometheus: &lt;the-output-value-of-htpasswd&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Change the ownership of the node exporter directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chown -R <span class="k">${</span><span class="nv">NODE_EXPORTER_USER</span><span class="k">}</span>:<span class="k">${</span><span class="nv">NODE_EXPORTER_USER</span><span class="k">}</span> /etc/node-exporter
</span></code></pre></td></tr></table></div></figure>


<p>Then create the systemd unit file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; /etc/systemd/system/node_exporter.service <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">[Unit]</span>
</span><span class='line'><span class="s">Description=Node Exporter</span>
</span><span class='line'><span class="s">Wants=network-online.target</span>
</span><span class='line'><span class="s">After=network-online.target</span>
</span><span class='line'><span class="s">StartLimitIntervalSec=500</span>
</span><span class='line'><span class="s">StartLimitBurst=5</span>
</span><span class='line'><span class="s">[Service]</span>
</span><span class='line'><span class="s">User=${NODE_EXPORTER_USER}</span>
</span><span class='line'><span class="s">Group=${NODE_EXPORTER_USER}</span>
</span><span class='line'><span class="s">Type=simple</span>
</span><span class='line'><span class="s">Restart=on-failure</span>
</span><span class='line'><span class="s">RestartSec=5s</span>
</span><span class='line'><span class="s">ExecStart=${BIN_DIRECTORY}/node_exporter --web.config=/etc/node-exporter/config.yml</span>
</span><span class='line'><span class="s">[Install]</span>
</span><span class='line'><span class="s">WantedBy=multi-user.target</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reload systemd and start node-exporter</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl daemon-reload
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>node_exporter
</span><span class='line'><span class="nv">$ </span>systemctl restart node_exporter
</span></code></pre></td></tr></table></div></figure>


<h2>Prometheus Config</h2>

<p>Copy the <code>/etc/node-exporter/node_exporter.crt</code> from the node-exporter node to prometheus-node, then in the <code>/etc/prometheus/prometheus.yml</code> config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">scrape_configs</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">job_name</span><span class="p-Indicator">:</span> <span class="s">&#39;node-exporter-tls&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">scheme</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https</span>
</span><span class='line'>    <span class="l-Scalar-Plain">basic_auth</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prometheus</span>
</span><span class='line'>      <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;the-plain-text-password&gt;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">tls_config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">ca_file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">node_exporter.crt</span>
</span><span class='line'>      <span class="l-Scalar-Plain">insecure_skip_verify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">static_configs</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">targets</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;node-exporter-ip:9100&#39;</span><span class="p-Indicator">]</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">instance</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">friendly-instance-name</span>
</span></code></pre></td></tr></table></div></figure>


<p>After you restart prometheus, you should see the metrics in prometheus' tsdb of the node exporter target that we are scraping.</p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Concourse CI v7.4 on Ubuntu Linux]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/10/07/install-concourse-ci-v7-dot-4-on-ubuntu-linux/"/>
    <updated>2021-10-07T19:27:05-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/10/07/install-concourse-ci-v7-dot-4-on-ubuntu-linux</id>
    <content type="html"><![CDATA[<p><img src="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495" alt="" /></p>

<p>Concourse is a Pipeline Based Continious Integration system written in Go</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://concourse-ci.org/">https://concourse-ci.org/</a></li>
<li><a href="https://github.com/concourse/concourse">https://github.com/concourse/concourse</a></li>
<li><a href="https://github.com/starkandwayne/concourse-tutorial">https://github.com/starkandwayne/concourse-tutorial</a></li>
</ul>


<h2>Older Version</h2>

<p>An older version is available:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2021/04/06/install-concourse-ci-v6-on-ubuntu-20-dot-04/">Install Concourse CI V6 on Ubuntu 20.04</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2017/11/07/setup-a-concourse-ci-server-on-ubuntu-16/">Setup Concourse CI v4 on Ubuntu 16.04</a></li>
</ul>


<h2>What is Concourse CI:</h2>

<p>Concourse CI is a Continious Integration Platform. Concourse enables you to construct pipelines with a yaml configuration that can consist out of 3 core concepts, tasks, resources, and jobs that compose them. For more information about this have a look at their <a href="https://concourse.ci/concepts.html">docs</a></p>

<h2>What will we be doing today</h2>

<p>We will setup a Concourse CI Server v6.7.6 (web and worker) on Ubuntu 20.04 and run the traditional <code>Hello, World</code> pipeline</p>

<h2>Setup the Server:</h2>

<p>Concourse needs <code>PostgresSQL</code> server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install postgresql postgresql-contrib -y
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>postgresql
</span></code></pre></td></tr></table></div></figure>


<p>Create the Database and User for Concourse on Postgres:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo -u postgres createuser concourse
</span><span class='line'><span class="nv">$ </span>sudo -u postgres createdb --owner<span class="o">=</span>concourse atc
</span></code></pre></td></tr></table></div></figure>


<p>Download the Concourse Binary:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">CONCOURSE_VERSION</span><span class="o">=</span>7.4.0
</span><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v<span class="k">${</span><span class="nv">CONCOURSE_VERSION</span><span class="k">}</span>/concourse-<span class="k">${</span><span class="nv">CONCOURSE_VERSION</span><span class="k">}</span>-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>tar -xvf concourse-<span class="k">${</span><span class="nv">CONCOURSE_VERSION</span><span class="k">}</span>-linux-amd64.tgz -C /usr/local/
</span><span class='line'><span class="nv">$ </span>rm -rf concourse-*-linux-amd64.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Create the Encryption Keys:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /etc/concourse
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/tsa_host_key -m pem
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/worker_key -m pem
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/session_signing_key -m pem
</span><span class='line'><span class="nv">$ </span>cp /etc/concourse/worker_key.pub /etc/concourse/authorized_worker_keys -m pem
</span></code></pre></td></tr></table></div></figure>


<p>Set the IP Address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">IP_ADDRESS</span><span class="o">=</span><span class="k">$(</span>ifconfig <span class="k">$(</span>route -n <span class="p">|</span> grep <span class="s1">&#39;0.0.0.0&#39;</span> <span class="p">|</span> head -1 <span class="p">|</span> rev <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> rev<span class="k">)</span> <span class="p">|</span> grep -w <span class="s1">&#39;inet&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Web Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; /etc/concourse/web_environment <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/concourse/bin</span>
</span><span class='line'><span class="s">CONCOURSE_ADD_LOCAL_USER=ruan:$(openssl rand -hex 14)</span>
</span><span class='line'><span class="s">CONCOURSE_SESSION_SIGNING_KEY=/etc/concourse/session_signing_key</span>
</span><span class='line'><span class="s">CONCOURSE_TSA_HOST_KEY=/etc/concourse/tsa_host_key</span>
</span><span class='line'><span class="s">CONCOURSE_TSA_AUTHORIZED_KEYS=/etc/concourse/authorized_worker_keys</span>
</span><span class='line'><span class="s">CONCOURSE_POSTGRES_HOST=127.0.0.1</span>
</span><span class='line'><span class="s">CONCOURSE_POSTGRES_USER=concourse</span>
</span><span class='line'><span class="s">CONCOURSE_POSTGRES_PASSWORD=concourse</span>
</span><span class='line'><span class="s">CONCOURSE_POSTGRES_DATABASE=atc</span>
</span><span class='line'><span class="s">CONCOURSE_MAIN_TEAM_LOCAL_USER=ruan</span>
</span><span class='line'><span class="s">CONCOURSE_EXTERNAL_URL=http://$IP_ADDRESS:8080</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Worker Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &gt; /etc/concourse/worker_environment <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/concourse/bin</span>
</span><span class='line'><span class="s">CONCOURSE_WORK_DIR=/var/lib/concourse</span>
</span><span class='line'><span class="s">CONCOURSE_TSA_HOST=127.0.0.1:2222</span>
</span><span class='line'><span class="s">CONCOURSE_TSA_PUBLIC_KEY=/etc/concourse/tsa_host_key.pub</span>
</span><span class='line'><span class="s">CONCOURSE_TSA_WORKER_PRIVATE_KEY=/etc/concourse/worker_key</span>
</span><span class='line'><span class="s">CONCOURSE_GARDEN_DNS_SERVER=8.8.8.8</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a Concourse user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /var/lib/concourse
</span><span class='line'><span class="nv">$ </span>sudo adduser --system --group concourse
</span><span class='line'><span class="nv">$ </span>sudo chown -R concourse:concourse /etc/concourse /var/lib/concourse
</span><span class='line'><span class="nv">$ </span>sudo chmod <span class="m">600</span> /etc/concourse/*_environment
</span></code></pre></td></tr></table></div></figure>


<p>Create SystemD Unit Files, first for the Web Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; /etc/systemd/system/concourse-web.service <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">[Unit]</span>
</span><span class='line'><span class="s">Description=Concourse CI web process (ATC and TSA)</span>
</span><span class='line'><span class="s">After=postgresql.service</span>
</span><span class='line'>
</span><span class='line'><span class="s">[Service]</span>
</span><span class='line'><span class="s">User=concourse</span>
</span><span class='line'><span class="s">Restart=on-failure</span>
</span><span class='line'><span class="s">EnvironmentFile=/etc/concourse/web_environment</span>
</span><span class='line'><span class="s">ExecStart=/usr/local/concourse/bin/concourse web</span>
</span><span class='line'>
</span><span class='line'><span class="s">[Install]</span>
</span><span class='line'><span class="s">WantedBy=multi-user.target</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then the SystemD Unit File for the Worker Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; /etc/systemd/system/concourse-worker.service <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">[Unit]</span>
</span><span class='line'><span class="s">Description=Concourse CI worker process</span>
</span><span class='line'><span class="s">After=concourse-web.service</span>
</span><span class='line'>
</span><span class='line'><span class="s">[Service]</span>
</span><span class='line'><span class="s">User=root</span>
</span><span class='line'><span class="s">Restart=on-failure</span>
</span><span class='line'><span class="s">EnvironmentFile=/etc/concourse/worker_environment</span>
</span><span class='line'><span class="s">ExecStart=/usr/local/concourse/bin/concourse worker</span>
</span><span class='line'>
</span><span class='line'><span class="s">[Install]</span>
</span><span class='line'><span class="s">WantedBy=multi-user.target</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a postgres password for the concourse user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /home/concourse/
</span><span class='line'><span class="nv">$ </span>sudo -u concourse psql atc
</span><span class='line'><span class="nv">atc</span><span class="o">=</span>&gt; ALTER USER concourse WITH PASSWORD <span class="s1">&#39;concourse&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">atc</span><span class="o">=</span>&gt; <span class="se">\q</span>
</span></code></pre></td></tr></table></div></figure>


<p>Start and Enable the Services:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl start concourse-web concourse-worker
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>concourse-web concourse-worker postgresql
</span><span class='line'><span class="nv">$ </span>systemctl status concourse-web concourse-worker
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>systemctl is-active concourse-worker concourse-web
</span><span class='line'>active
</span><span class='line'>active
</span></code></pre></td></tr></table></div></figure>


<p>The listening ports should more or less look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -tulpn
</span><span class='line'>
</span><span class='line'>Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7777          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7788          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:8079          0.0.0.0:*               LISTEN      4525/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      1283/sshd
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:5432          0.0.0.0:*               LISTEN      4047/postgres
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::36159                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::46829                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::2222                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::8080                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      1283/sshd
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:68              0.0.0.0:*                           918/dhclient
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:42165           0.0.0.0:*                           4530/concourse
</span></code></pre></td></tr></table></div></figure>


<p>You can check the logs like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo journalctl -fu concourse-web
</span><span class='line'><span class="nv">$ </span>sudo journalctl -fu concourse-worker
</span></code></pre></td></tr></table></div></figure>


<p>Make a request using the API:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://<span class="k">${</span><span class="nv">IP_ADDRESS</span><span class="k">}</span>:8080/api/v1/info
</span><span class='line'><span class="o">{</span><span class="s2">&quot;version&quot;</span>:<span class="s2">&quot;7.4.0&quot;</span>,<span class="s2">&quot;worker_version&quot;</span>:<span class="s2">&quot;2.3&quot;</span>,<span class="s2">&quot;feature_flags&quot;</span>:<span class="o">{</span><span class="s2">&quot;across_step&quot;</span>:false,<span class="s2">&quot;build_rerun&quot;</span>:false,<span class="s2">&quot;cache_streamed_volumes&quot;</span>:false,<span class="s2">&quot;global_resources&quot;</span>:false,<span class="s2">&quot;pipeline_instances&quot;</span>:false,<span class="s2">&quot;redact_secrets&quot;</span>:false,<span class="s2">&quot;resource_causality&quot;</span>:false<span class="o">}</span>,<span class="s2">&quot;external_url&quot;</span>:<span class="s2">&quot;http://x.x.x.x:8080&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Client Side:</h2>

<p>I will be using a the Fly cli from a Mac, so first we need to download the fly-cli for Mac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">CONCOURSE_VERSION</span><span class="o">=</span>7.4.0
</span><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v<span class="k">${</span><span class="nv">CONCOURSE_VERSION</span><span class="k">}</span>/fly-<span class="k">${</span><span class="nv">CONCOURSE_VERSION</span><span class="k">}</span>-darwin-amd64.tgz
</span><span class='line'><span class="nv">$ </span>tar -xvf fly-<span class="k">${</span><span class="nv">CONCOURSE_VERSION</span><span class="k">}</span>-darwin-amd64.tgz
</span><span class='line'><span class="nv">$ </span>sudo mv fly /usr/local/bin/fly
</span><span class='line'><span class="nv">$ </span>rm -rf fly-<span class="k">${</span><span class="nv">CONCOURSE_VERSION</span><span class="k">}</span>-darwin-amd64.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to setup our Concourse Target by Authenticating against our Concourse Endpoint, lets setup our target with the name <code>ci</code>, and make sure to replace the ip address with the ip of your concourse server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci login -c http://<span class="k">${</span><span class="nv">IP_ADDRESS</span><span class="k">}</span>:8080
</span><span class='line'>logging in to team <span class="s1">&#39;main&#39;</span>
</span><span class='line'>
</span><span class='line'>navigate to the following URL in your browser:
</span><span class='line'>
</span><span class='line'>  http://<span class="k">${</span><span class="nv">IP_ADDRESS</span><span class="k">}</span>:8080/login?fly_port<span class="o">=</span>42181
</span><span class='line'>
</span><span class='line'>or enter token manually <span class="o">(</span>input hidden<span class="o">)</span>:
</span><span class='line'>target saved
</span></code></pre></td></tr></table></div></figure>


<p>Lets list our targets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly targets
</span><span class='line'>name  url                        team  expiry
</span><span class='line'>ci    http://x.x.x.x:8080        main  Wed, <span class="m">08</span> Nov <span class="m">2021</span> 15:32:59 UTC
</span></code></pre></td></tr></table></div></figure>


<p>Listing Registered Workers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>x.x.x.x           <span class="m">0</span>           linux     none  none  running  1.2
</span></code></pre></td></tr></table></div></figure>


<p>Listing Active Containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job            build <span class="c">#  build id  type   name                  attempt</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hello World Pipeline:</h2>

<p>Let&rsquo;s create a basic pipeline, that will print out <code>Hello, World!</code>:</p>

<p>Our <code>hello-world.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-job</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">say-hello</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine</span>
</span><span class='line'>          <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">edge</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/bin/sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">-c</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Hello, World!&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Applying the configuration to our pipeline:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci <span class="nb">set</span>-pipeline -p yeeehaa -c hello-world.yml
</span><span class='line'><span class="nb">jobs</span>:
</span><span class='line'>  job my-job has been added:
</span><span class='line'>    name: my-job
</span><span class='line'>    plan:
</span><span class='line'>    - task: say-hello
</span><span class='line'>      config:
</span><span class='line'>        platform: linux
</span><span class='line'>        image_resource:
</span><span class='line'>          <span class="nb">type</span>: docker-image
</span><span class='line'>          <span class="nb">source</span>:
</span><span class='line'>            repository: alpine
</span><span class='line'>            tag: edge
</span><span class='line'>        run:
</span><span class='line'>          path: /bin/sh
</span><span class='line'>          args:
</span><span class='line'>          - -c
</span><span class='line'>          - <span class="p">|</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'>apply configuration? <span class="o">[</span>yN<span class="o">]</span>: y
</span><span class='line'>pipeline created!
</span><span class='line'>you can view your pipeline here: http://x.x.x.x:8080/teams/main/pipelines/yeeehaa
</span><span class='line'>
</span><span class='line'>the pipeline is currently paused. to unpause, either:
</span><span class='line'>  - run the unpause-pipeline <span class="nb">command</span>
</span><span class='line'>  - click play next to the pipeline in the web ui
</span></code></pre></td></tr></table></div></figure>


<p>We can browse to the WebUI to unpause the pipeline, but since I like to do everything on cli as far as possible, I will unpause the pipeline via cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci unpause-pipeline -p yeeehaa
</span><span class='line'>unpaused <span class="s1">&#39;yeeehaa&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now our Pipeline is unpaused, but since we did not specify any triggers, we need to manually trigger the pipeline to run, you can either via the WebUI, select your pipeline which in this case will be named <code>yeeehaa</code> and then select the job, which will be <code>my-job</code> then hit the <code>+</code> sign, which will trigger the pipeline.</p>

<p>I will be using the cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job
</span><span class='line'>started yeeehaa/my-job <span class="c">#1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Via the WebUI on <code>http://x.x.x.x:8080/teams/main/pipelines/yeeehaa/jobs/my-job/builds/1</code> you should see the <code>Hello, World!</code> output, or via the cli, we also have the option to see the output, so let&rsquo;s trigger it again, but this time passing the <code>--watch</code> flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job --watch
</span><span class='line'>started yeeehaa/my-job <span class="c">#2</span>
</span><span class='line'>
</span><span class='line'>initializing
</span><span class='line'>running /bin/sh -c <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>Hello, World!
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>


<p>Listing our Workers and Containers again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>x.x.x.x            <span class="m">2</span>           linux     none  none  running  1.2
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job         build <span class="c">#  build id  type   name           attempt</span>
</span><span class='line'>46282555-64cd-5h1b-67b8-316486h58eb8  x.x.x.x           yeeehaa      my-job      <span class="m">2</span>        <span class="m">729</span>       task   say-hello      n/a
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Tour With Vagrant and Virtualbox on Mac]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/08/14/a-tour-with-vagrant-and-virtualbox-on-mac/"/>
    <updated>2021-08-14T13:41:32-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/08/14/a-tour-with-vagrant-and-virtualbox-on-mac</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/58658188-37cec280-8320-11e9-90ca-1226b3ccb292.png" alt="vagrant" /></p>

<p><a href="https://www.vagrantup.com/">Vagrant</a>, yet another amazing product from <a href="https://www.hashicorp.com/">Hashicorp</a>.</p>

<p>Vagrant makes it really easy to provision virtual servers for local development (not limited to), which they refer as &ldquo;boxes&rdquo;, that enables developers to run their jobs/tasks/applications in a really easy and fast way. Vagrant utilizes a declarative configuration model, so you can describe which OS you want, bootstrap them with installation instructions as soon as it boots, etc.</p>

<h2>What are we doing today?</h2>

<p>When completing this tutorial, you will have Vagrant and Virtualbox installed on your Mac and should be able to launch a Ubuntu Virtual Server locally with Vagrant and using the Virtualbox provider which will be responsible for running our VM&rsquo;s.</p>

<p>We will also look at different configuration options to configure the VM, bootstrapping software, using the shell, docker and ansible provisioner.</p>

<p>For this demonstration, I am using a Mac OSX, but you can run this on Mac, Windows or Linux. First we will use Homebrew to install Virtualbox, then Vagrant, then we will provision a Ubuntu box and I will also show how to inject shell commands into your Vagrantfile so that you can provision software to your VM, and also forward traffic to a web server from the host to the guest.</p>

<p>If you are looking for a Linux version instead of mac, you can look at this post:
* <a href="https://blog.ruanbekker.com/blog/2019/05/30/use-vagrant-to-setup-a-local-development-environment-on-linux/">Use Vagrant to Setup a Local Development Environment on Linux</a></p>

<h2>Pre-Requisites</h2>

<p>I will be installing Vagrant and Virtualbox with Homebrew, if you do not have homebrew installed, you can install homebrew with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ruby -e <span class="s2">&quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once homebrew is installed, it&rsquo;s a good thing to update the indexes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew update
</span></code></pre></td></tr></table></div></figure>


<h2>Virtualbox</h2>

<p>Install <a href="https://www.virtualbox.org/">VirtualBox</a> using homebrew:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install --cask virtualbox
</span></code></pre></td></tr></table></div></figure>


<h2>Vagrant</h2>

<p>Install <a href="https://www.vagrantup.com/">Vagrant</a> using homebrew:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install --cask vagrant
</span></code></pre></td></tr></table></div></figure>


<p>Install the virtualbox guest additions plugin for vagrant:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant plugin install vagrant-vbguest
</span></code></pre></td></tr></table></div></figure>


<p>If you would like a vagrant manager utility to help you manage your vagrant boxes, you can install <a href="http://www.vagrantmanager.com/">vagrant-manager</a> using homebrew:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install --cask vagrant-manager
</span></code></pre></td></tr></table></div></figure>


<h2>Create your first Vagrant Box</h2>

<p>From <a href="https://app.vagrantup.com/boxes/search">app.vagrantup.com/boxes/search</a> you can search for any box, such as ubuntu, centos, alpine etc and for this demonstration I am going with <a href="https://app.vagrantup.com/ubuntu/boxes/focal64">ubuntu/focal64</a>.</p>

<p>I am creating a new directory for my devbox:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir devbox
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>devbox
</span></code></pre></td></tr></table></div></figure>


<p>Then initialize the Vagrantfile by running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant init ubuntu/focal64
</span></code></pre></td></tr></table></div></figure>


<p>A <code>Vagrantfile</code> has been created in the current working directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat Vagrantfile <span class="p">|</span> grep -v <span class="s2">&quot;#&quot;</span>
</span><span class='line'>
</span><span class='line'>Vagrant.configure<span class="o">(</span><span class="s2">&quot;2&quot;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
</span><span class='line'>  config.vm.box <span class="o">=</span> <span class="s2">&quot;ubuntu/focal64&quot;</span>
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>Boot the VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant up
</span></code></pre></td></tr></table></div></figure>


<p>The box should now be in a started state, and we can verify that by running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant status
</span><span class='line'>Current machine states:
</span><span class='line'>
</span><span class='line'>default                   running <span class="o">(</span>virtualbox<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now SSH to our VM by running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant ssh
</span><span class='line'>vagrant@ubuntu-focal:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Installing Software with Vagrant</h2>

<p>First let&rsquo;s destroy the VM that we created:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant destroy --force
</span></code></pre></td></tr></table></div></figure>


<p>Then edit the <code>Vagrantfile</code> and add the commands that we want to be executed when the VM boots, in our case, installing Nginx:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/focal64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;forwarded_port&quot;</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8080</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="no">SHELL</span>
</span><span class='line'><span class="sh">     apt update</span>
</span><span class='line'><span class="sh">     apt install nginx -y</span>
</span><span class='line'><span class="no">  SHELL</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will also notice that we are forwarding port 8080 from our host, to port 80 on the VM so that we can access the webserver on port 8080 from our laptop. Then boot the VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">vagrant</span> <span class="n">up</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once the VM has booted and installed our software, we should be able to access the index document served by Nginx on our VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -I http://localhost:8080/
</span><span class='line'>
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span><span class='line'>Date: Sat, <span class="m">14</span> Aug <span class="m">2021</span> 18:11:59 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 612
</span><span class='line'>Last-Modified: Sat, <span class="m">14</span> Aug <span class="m">2021</span> 18:11:10 GMT
</span><span class='line'>Connection: keep-alive
</span><span class='line'>ETag: <span class="s2">&quot;6118073e-264&quot;</span>
</span><span class='line'>Accept-Ranges: bytes
</span></code></pre></td></tr></table></div></figure>


<h2>Shared Folders</h2>

<p>Let&rsquo;s say you want to map your local directory to your VM, in a scenario where you want to store your <code>index.html</code> on your laptop and map it to the VM, we can use <code>config.vm.synced_folder</code>.</p>

<p>On our laptop, create a <code>html</code> directory where we will store our <code>index.hml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir html
</span></code></pre></td></tr></table></div></figure>


<p>Now create the content in the <code>index.html</code> under the <code>html</code> directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;Hello, World&quot;</span> &gt; html/index.html
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to make vagrant aware of the folder that we are mapping to the VM, so we need to edit the <code>Vagrantfile</code> and it will now look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/focal64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;forwarded_port&quot;</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8080</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="no">SHELL</span>
</span><span class='line'><span class="sh">     apt update</span>
</span><span class='line'><span class="sh">     apt install nginx -y</span>
</span><span class='line'><span class="no">  SHELL</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/www/html&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To reload the VM with our changes, we use <code>vagrant provision</code> to update our VM when changes to provisioners are made, and <code>vagrant reload</code> when we have config changes such as <code>config.vm.network</code>, but to restart the VM and forcing provisioners to run, we can use the following:</p>

<p>Thanks <a href="https://twitter.com/joshva_jebaraj">@joshva_jebaraj</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant reload --provision
</span></code></pre></td></tr></table></div></figure>


<p>Once the VM is up, we can verify the changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://localhost:8080/
</span><span class='line'>Hello, World
</span></code></pre></td></tr></table></div></figure>


<p>Now we can edit our content locally which is synced to our VM.</p>

<h2>Setting Hostname and Configure Memory</h2>

<p>We can also configure the hostname of our VM and configure the amount of memory that we want to allocate to our VM using:</p>

<ul>
<li><code>config.vm.hostname</code></li>
<li><code>vb.memory</code></li>
</ul>


<p>An example of that will look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/focal64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;mydevbox&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;forwarded_port&quot;</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8080</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="no">SHELL</span>
</span><span class='line'><span class="sh">     apt update</span>
</span><span class='line'><span class="sh">     apt install nginx -y</span>
</span><span class='line'><span class="no">  SHELL</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;html&quot;</span><span class="p">,</span> <span class="s2">&quot;/var/www/html&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">vb</span><span class="o">|</span>
</span><span class='line'>    <span class="n">vb</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="s2">&quot;1024&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>`</p>

<p>In this example our VM&rsquo;s hostname is <code>mydevbox</code> and we assigned 1024MB of memory to our VM.</p>

<h2>Provisioners: Shell</h2>

<p>We can also run scripts from our local directory on our laptop on our VM using the <a href="https://www.vagrantup.com/docs/provisioning/shell">shell provisioner</a>.</p>

<p>First we need to create the script on our local directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat bootstrap.sh
</span><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'><span class="nb">set</span> -x
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;my hostname is $(hostname)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then in our <code>Vagrantfile</code> we inform vagrant to execute the shell script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/focal64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;mydevbox&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:shell</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;bootstrap.sh&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since my VM is already running, I will be doing a <code>reload</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant reload --provision
</span><span class='line'>...
</span><span class='line'><span class="o">==</span>&gt; default: Running provisioner: shell...
</span><span class='line'>    default: Running: /var/folders/04/r10yvb8d5dgfvd167jz5z23w0000gn/T/vagrant-shell20210814-70233-1p9dump.sh
</span><span class='line'>    default: ++ hostname
</span><span class='line'>    default: my hostname is mydevbox
</span><span class='line'>    default: + <span class="nb">echo</span> <span class="s1">&#39;my hostname is mydevbox&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see the shell script from our local directory was executed on our VM, you can use this method to automate installations as well, etc.</p>

<h2>Provisioners: Docker</h2>

<p>Vagrant offers a <a href="https://www.vagrantup.com/docs/provisioning/docker">docker provisioner</a>, and for this example we will be hosting a mysql server using docker container in our VM.</p>

<p>Our <code>Vagrantfile</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/focal64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;mydevbox&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;forwarded_port&quot;</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">3306</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">3306</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;docker&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span>
</span><span class='line'>    <span class="n">d</span><span class="o">.</span><span class="n">run</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="ss">image</span><span class="p">:</span> <span class="s2">&quot;mysql:8.0&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">args</span><span class="p">:</span> <span class="s2">&quot;-p 3306:3306 -e MYSQL_ROOT_PASSWORD=password&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since I don&rsquo;t have port <code>3306</code> listening locally, I have mapped port <code>3306</code> from my laptop to port <code>3306</code> on my VM and I am using the <code>mysql:8.0</code> container image from docker hub and passing the arguments which is specific to the container.</p>

<p>The convenient thing about the docker provisioner, is that it will install docker onto the VM for you.</p>

<p>Once the config has been set in your <code>Vagrantfile</code> do a reload:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant reload --provision
</span><span class='line'>...
</span><span class='line'>    default: /vagrant <span class="o">=</span>&gt; /Users/ruanbekker/workspace/vagrant/devbox
</span><span class='line'><span class="o">==</span>&gt; default: Running provisioner: docker...
</span><span class='line'>    default: Installing Docker onto machine...
</span><span class='line'><span class="o">==</span>&gt; default: Starting Docker containers...
</span><span class='line'><span class="o">==</span>&gt; default: -- Container: mysql
</span></code></pre></td></tr></table></div></figure>


<p>From our laptop we should be able to communicate with our mysql server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>nc -vz localhost 3306
</span><span class='line'>found <span class="m">0</span> associations
</span><span class='line'>found <span class="m">1</span> connections:
</span><span class='line'>     1:   <span class="nv">flags</span><span class="o">=</span>82&lt;CONNECTED,PREFERRED&gt;
</span><span class='line'>  outif lo0
</span><span class='line'>  src 127.0.0.1 port 58745
</span><span class='line'>  dst 127.0.0.1 port 3306
</span><span class='line'>  rank info not available
</span><span class='line'>  TCP aux info available
</span><span class='line'>
</span><span class='line'>Connection to localhost port <span class="m">3306</span> <span class="o">[</span>tcp/mysql<span class="o">]</span> succeeded!
</span></code></pre></td></tr></table></div></figure>


<p>We can also SSH to our VM and verify if the container is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant ssh
</span></code></pre></td></tr></table></div></figure>


<p>And then list the containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span> docker ps
</span><span class='line'>CONTAINER ID   IMAGE       COMMAND                  CREATED         STATUS         PORTS                                                  NAMES
</span><span class='line'>30a843a486ae   mysql:8.0   <span class="err">&quot;</span>docker-entrypoint.sh    <span class="m">2</span> minutes ago   Up <span class="m">2</span> minutes   0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp   mysql
</span></code></pre></td></tr></table></div></figure>


<h2>Provisioners: Ansible</h2>

<p>We can also execute <a href="https://www.ansible.com/">Ansible</a> playbooks on our VM using the <a href="https://www.vagrantup.com/docs/provisioning/ansible">Ansible Provisioner</a>.</p>

<p>Something to note is that we use <code>ansible</code> to execute the playbook on the host, and <code>ansible_local</code> to execute the playbook on the VM.</p>

<p>First we will create our <a href="https://docs.ansible.com/playbooks_best_practices.html#directory-layout">project structure</a> for ansible, so that we have the following in place:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>.
</span><span class='line'>Vagrantfile
</span><span class='line'>provisioning/playbook.yml
</span><span class='line'>provisioning/group_vars/all
</span></code></pre></td></tr></table></div></figure>


<p>Create the <code>provisioning</code> directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir provisioning
</span></code></pre></td></tr></table></div></figure>


<p>Then the content for our <code>provisioning/playbook.yml</code> playbook:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">become</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ensure ntpd is at the latest version</span>
</span><span class='line'>      <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">pkg</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ntp</span>
</span><span class='line'>        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">restart ntpd</span>
</span><span class='line'>  <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">restart ntpd</span>
</span><span class='line'>      <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ntp</span>
</span><span class='line'>        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">restarted</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>provisioning/group_vars/all</code> file that will contain the variables for the all group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">desired_state</span><span class="p-Indicator">:</span> <span class="s">&quot;latest&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our <code>Vagrantfile</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/focal64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;mydevbox&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:ansible</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
</span><span class='line'>    <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;provisioning/playbook.yml&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>When using ansible with vagrant the inventory is <a href="https://www.vagrantup.com/docs/provisioning/ansible_intro#auto-generated-inventory">auto-generated</a> when then inventory is not specified. Vagrant will store the inventory on the host at <code>.vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory</code>.</p>

<p>To execute playbooks with ansible, we need ansible installed on our host machine, for this demonstration I will be using virtualenv and then install ansible using pip:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python3 -m pip install virtualenv
</span><span class='line'><span class="nv">$ </span>virtualenv -p <span class="k">$(</span>which python3<span class="k">)</span> .venv
</span><span class='line'><span class="nv">$ </span><span class="nb">source</span> .venv/bin/activate
</span><span class='line'><span class="nv">$ </span>pip install ansible
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have ansible installed, reload the VM to execute the playbook on our VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant reload --provision
</span><span class='line'>...
</span><span class='line'><span class="o">==</span>&gt; default: Running provisioner: ansible...
</span><span class='line'>    default: Running ansible-playbook...
</span><span class='line'>
</span><span class='line'>PLAY <span class="o">[</span>all<span class="o">]</span> *********************************************************************
</span><span class='line'>
</span><span class='line'>TASK <span class="o">[</span>Gathering Facts<span class="o">]</span> *********************************************************
</span><span class='line'>ok: <span class="o">[</span>default<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>TASK <span class="o">[</span>ensure ntpd is at the latest version<span class="o">]</span> ************************************
</span><span class='line'>ok: <span class="o">[</span>default<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>PLAY RECAP *********************************************************************
</span><span class='line'>default                    : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">skipped</span><span class="o">=</span><span class="m">0</span>    <span class="nv">rescued</span><span class="o">=</span><span class="m">0</span>    <span class="nv">ignored</span><span class="o">=</span>0
</span></code></pre></td></tr></table></div></figure>


<p>Pretty neat right?</p>

<h2>Tear Down</h2>

<p>To destroy the VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant destroy --force
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p>For more information on vagrant, check out their documentation:</p>

<ul>
<li><a href="https://www.vagrantup.com/docs">https://www.vagrantup.com/docs</a></li>
</ul>


<p>On provisioning documentation:</p>

<ul>
<li><a href="https://www.vagrantup.com/docs/provisioning/shell">https://www.vagrantup.com/docs/provisioning/shell</a></li>
<li><a href="https://www.vagrantup.com/docs/provisioning/docker">https://www.vagrantup.com/docs/provisioning/docker</a></li>
<li><a href="https://www.vagrantup.com/docs/provisioning/ansible_intro">https://www.vagrantup.com/docs/provisioning/ansible_intro</a></li>
</ul>


<p>I have a couple of example <code>Vagrantfile</code>s available on my github repository:</p>

<ul>
<li><a href="https://github.com/ruanbekker/vagrantfiles">https://github.com/ruanbekker/vagrantfiles</a></li>
</ul>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Specify Wallet Name in Bitcoin Core Walletnotify]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/08/04/how-to-specify-wallet-name-in-bitcoin-core-walletnotify/"/>
    <updated>2021-08-04T09:41:51-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/08/04/how-to-specify-wallet-name-in-bitcoin-core-walletnotify</id>
    <content type="html"><![CDATA[<p><img src="https://blog.ruanbekker.com/images/ruanbekker-header-photo.png" alt="" /></p>

<p>With bitcoin-core, you get a configuration option called <code>walletnotify</code> which allow you to invoke a command whenever you receive a payment, first confirmation of a payment or send a payment.</p>

<p>You can specify <code>%s</code> as an argument which will be used to parse the transaction id.</p>

<h2>Bitcoind WalletNotify TransactionID Example</h2>

<p>To see what walletnotify does, in my <code>bitcoin.conf</code> I had a basic script to write a entry every time I receive a payment:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.bitcoin/bitcoin.conf
</span><span class='line'>...
</span><span class='line'>walletnotify=/bin/notify.sh %s %w</span></code></pre></td></tr></table></div></figure>


<p>And in my <code>/bin/notify.sh</code> script I have this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env bash
</span><span class='line'>transaction_id=$1
</span><span class='line'>
</span><span class='line'># writing to log
</span><span class='line'>echo "[$(date +%FT%T)] event for txid $transaction_id" &gt;&gt; /var/log/bitcoin-notify.log</span></code></pre></td></tr></table></div></figure>


<p>I have executable permissions for the script:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod +x /bin/notify.sh</span></code></pre></td></tr></table></div></figure>


<p>When a payment was made, my logfile showed the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2021-08-04T12:21:43] event for txid xxxxxx5d92f729ed77xxxxxx2cbccedxxxxa7a03a801xxxxxxx33a41c1xxxxxd2 </span></code></pre></td></tr></table></div></figure>


<h2>Capturing the wallet name in walletnotify</h2>

<p>In bitcoin-core we wave wallets, and in a wallet we have one or more bitcoin addresses, as can be seen below for wallets:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -u "bitcoin:${bpass}" -d '{"jsonrpc": "1.0", "id": "curl", "method": "listwallets", "params": []}' -H 'content-type: text/plain;' http://127.0.0.1:18332/
</span><span class='line'>{"result":["rpi01-main", "rpi01-secondary"],"error":null,"id":"curl"}</span></code></pre></td></tr></table></div></figure>


<p>and to get the addresses for that wallet:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -u "bitcoin:${bpass}" -d '{"jsonrpc": "1.0", "id": "curl", "method": "getaddressesbylabel", "params": [""]}' -H 'content-type: text/plain;' http://127.0.0.1:18332/wallet/rpi01-main
</span><span class='line'>{"result":{"txxxxxmefmcpq98xxxxxxx80gvug2fe97xxxxxx8yv":{"purpose":"receive"}},"error":null,"id":"curl"}</span></code></pre></td></tr></table></div></figure>


<p>I had to figure out how to capture the wallet name as well as the transaction id, as I thought its not possible until I stumbled upon a post which mentioned from bitcoind 0.20:</p>

<blockquote><p>The -walletnotify configuration parameter will now replace any %w in its argument with the name of the wallet generating the notification.</p></blockquote>

<p>Which was merged by this PR:
- <a href="https://github.com/bitcoin/bitcoin/pull/13339">https://github.com/bitcoin/bitcoin/pull/13339</a></p>

<p>So first to verify that bitcoind is newer than mentioned:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/usr/local/bin/bitcoind -version
</span><span class='line'>Bitcoin Core version v0.21.1
</span></code></pre></td></tr></table></div></figure>


<p>Updated the <code>walletnotify</code> config in <code>bitcoin.conf</code> to include <code>%w</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /home/bitcoin/.bitcoin/bitcoin.conf <span class="p">|</span> grep wallet
</span><span class='line'><span class="nv">walletnotify</span><span class="o">=</span>/bin/notify.sh %s %w
</span></code></pre></td></tr></table></div></figure>


<p>Then in the <code>notify.sh</code> script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'><span class="nv">transaction_id</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">wallet_name</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;[$(date +%FT%T)] $transaction_id $wallet_name&quot;</span> &gt;&gt; /var/log/bitcoin-notify.log
</span></code></pre></td></tr></table></div></figure>


<p>And then restart bitcoind:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl restart bitcoind
</span></code></pre></td></tr></table></div></figure>


<p>When a transaction occurred, I could see the transaction id with the corresponding wallet name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tail -f /var/log/bitcoin-notify.log
</span><span class='line'><span class="o">[</span>2021-08-04T12:31:20<span class="o">]</span> fxxxxxxxxxxxxxxxxxxxxxxx2cbcced28ea26fhkxxxxhjn01f33a41c12f8xxx8 rpi01-main
</span></code></pre></td></tr></table></div></figure>


<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[AWS EC2 Linux - Warning: Setlocale: LC_CTYPE: Cannot Change Locale UTF-8]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/08/02/aws-ec2-linux-warning-setlocale-lc-ctype-cannot-change-locale-utf-8/"/>
    <updated>2021-08-02T02:40:53-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/08/02/aws-ec2-linux-warning-setlocale-lc-ctype-cannot-change-locale-utf-8</id>
    <content type="html"><![CDATA[<p>On Amazon Linux EC2 Instances, I noticed the following error when SSH onto them:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-bash: warning: setlocale: LC_CTYPE: cannot change locale (UTF-8): No such file or directory</span></code></pre></td></tr></table></div></figure>


<p>To resolve, add the following to the <code>/etc/environment</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/environment
</span><span class='line'>LANG=en_US.utf-8
</span><span class='line'>LC_ALL=en_US.utf-8</span></code></pre></td></tr></table></div></figure>


<p>Logout and log back in and it should be resolved.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Task Runner With YAML Config Written in Go]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/08/01/task-runner-with-yaml-config-written-in-go/"/>
    <updated>2021-08-01T06:11:54-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/08/01/task-runner-with-yaml-config-written-in-go</id>
    <content type="html"><![CDATA[<p><img src="https://blog.ruanbekker.com/images/ruanbekker-header-photo.png" alt="" /></p>

<p><a href="https://taskfile.dev/">Task</a> (aka Taskfile) is a task runner written in <a href="https://golang.org/">Go</a>, which is similar to GNU Make, but in my opinion is a lot easier to use as you specify your tasks in yaml.</p>

<h2>What to expect</h2>

<p>In this post we will go through a quick demonstration using Task, how to install Task, as well as a couple of basic examples to get you up and running with Task.</p>

<h2>Install</h2>

<p>For mac, installing task::</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install go-task/tap/go-task
</span></code></pre></td></tr></table></div></figure>


<p>For linux, installing task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sh -c <span class="s2">&quot;$(curl --location https://taskfile.dev/install.sh)&quot;</span> -- -d -b /usr/local/bin
</span></code></pre></td></tr></table></div></figure>


<p>Or manual installation for arm as an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">pushd</span> /tmp
</span><span class='line'><span class="nv">$ </span>wget https://github.com/go-task/task/releases/download/v3.7.0/task_linux_arm.tar.gz
</span><span class='line'><span class="nv">$ </span>tar -xvf task_linux_arm.tar.gz
</span><span class='line'><span class="nv">$ </span>sudo mv task /usr/local/bin/task
</span><span class='line'><span class="nv">$ </span>sudo chmod +x /usr/local/bin/task
</span><span class='line'><span class="nv">$ </span><span class="nb">popd</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify that task is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task --version
</span><span class='line'>Task version: v3.7.0
</span></code></pre></td></tr></table></div></figure>


<p>For more information check the installation page:
- <a href="https://taskfile.dev/#/installation">https://taskfile.dev/#/installation</a></p>

<h2>Usage</h2>

<p>Task uses a default config file: <code>Taskfile.yml</code> in the current working directory where you can provide context on what your tasks should do.</p>

<p>To generate a <code>Taskfile.yml</code> with example config, task gives us a <code>--init</code> flag to generate a sample.</p>

<p>For a basic hello-world example, our task <code>helloworld</code> will echo out <code>hello, world!</code>. To generate the sample code, run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>task --init
</span></code></pre></td></tr></table></div></figure>


<p>Then update the config, to the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">desc</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prints out hello world message</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, world!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To demonstrate what the config means:</p>

<ul>
<li><code>tasks</code>: refers to the list of tasks</li>
<li><code>helloworld</code>: is the task name</li>
<li><code>desc</code>: describes the task, useful for listing tasks</li>
<li><code>cmds</code>: the commands that the task will execute</li>
</ul>


<p>To list all our tasks for our taskfile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task --list
</span><span class='line'>task: Available tasks <span class="k">for</span> this project:
</span><span class='line'>* helloworld:     prints out hello world message
</span></code></pre></td></tr></table></div></figure>


<p>Which we call using the application <code>task</code> with the argument of the task name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task helloworld
</span><span class='line'>task: <span class="o">[</span>helloworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;hello, world!&quot;</span>
</span><span class='line'>hello, world!
</span></code></pre></td></tr></table></div></figure>


<p>We can also reduce the output verbosity using <code>silent</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">desc</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prints out hello world message</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, world!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which will result in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task helloworld
</span><span class='line'>hello, world!
</span></code></pre></td></tr></table></div></figure>


<p>For a example using environment variables, we can use it in two ways:</p>

<ul>
<li>per task</li>
<li>globally, across all tasks</li>
</ul>


<p>For using environment variables per task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">WORD</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">world</span>
</span></code></pre></td></tr></table></div></figure>


<p>Results in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task helloworld
</span><span class='line'>task: <span class="o">[</span>helloworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;hello, $WORD!&quot;</span>
</span><span class='line'>hello, world!
</span></code></pre></td></tr></table></div></figure>


<p>For using environment variables globally across all tasks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">WORD</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">world</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">byeworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bye</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running our first task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task helloworld
</span><span class='line'>task: <span class="o">[</span>helloworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;hello, $WORD!&quot;</span>
</span><span class='line'>hello, world!
</span></code></pre></td></tr></table></div></figure>


<p>And running our second task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task byeworld
</span><span class='line'>task: <span class="o">[</span>byeworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>bye, world!
</span></code></pre></td></tr></table></div></figure>


<p>To store your environment variables in a <code>.env</code> file, you can specify it as the following in your <code>Taskfile.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">dotenv</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;.env&#39;</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">byeworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bye</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in your <code>.env</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">WORD=world</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you should see your environment variables referenced from the <code>.env</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ task helloworld</span>
</span><span class='line'><span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">helloworld</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">hello, world!</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can also reference config using <code>vars</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Hello, World!</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">desc</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prints out a message</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case our task name is <code>default</code>, therefore we can only run <code>task</code> without any arguments, as default with be the default task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ task</span>
</span><span class='line'><span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">default</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">echo &quot;Hello, World!&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">Hello, World!</span>
</span></code></pre></td></tr></table></div></figure>


<p>To run both tasks with one command, you can specify dependencies, so if we define a task with zero commands but just dependencies, it will call those tasks and execute them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">WORD</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">world</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">byeworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bye</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">all</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deps</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">helloworld</span><span class="p-Indicator">,</span> <span class="nv">byeworld</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So when we run the <code>all</code> task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task all
</span><span class='line'>task: <span class="o">[</span>helloworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;hello, $WORD!&quot;</span>
</span><span class='line'>hello, world!
</span><span class='line'>task: <span class="o">[</span>byeworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>bye, world!
</span></code></pre></td></tr></table></div></figure>


<p>For more usage examples, have a look at their documentation:
- <a href="https://taskfile.dev/#/usage">https://taskfile.dev/#/usage</a></p>

<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Basic Logging With Python]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/07/31/basic-logging-with-python/"/>
    <updated>2021-07-31T04:17:24-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/07/31/basic-logging-with-python</id>
    <content type="html"><![CDATA[<p><img src="https://blog.ruanbekker.com/images/ruanbekker-header-photo.png" alt="" /></p>

<p>I&rsquo;m trying to force myself to move away from using the <code>print()</code> function as I&rsquo;m pretty much using print all the time to cater for logging, and using the <code>logging</code> package instead.</p>

<p>This is a basic example of using logging in a basic python app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">logging</span>
</span><span class='line'>
</span><span class='line'><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
</span><span class='line'>    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
</span><span class='line'>    <span class="n">format</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%(asctime)s</span><span class="s"> [</span><span class="si">%(levelname)s</span><span class="s">] </span><span class="si">%(name)s</span><span class="s"> </span><span class="si">%(message)s</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
</span><span class='line'>        <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">messagestring</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;info&#39;</span><span class="p">:</span> <span class="s">&#39;info message&#39;</span><span class="p">,</span> <span class="s">&#39;warn&#39;</span><span class="p">:</span> <span class="s">&#39;this is a warning&#39;</span><span class="p">,</span> <span class="s">&#39;err&#39;</span><span class="p">:</span> <span class="s">&#39;this is a error&#39;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;thisapp&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;message: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">messagestring</span><span class="p">[</span><span class="s">&#39;info&#39;</span><span class="p">]))</span>
</span><span class='line'><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;message: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">messagestring</span><span class="p">[</span><span class="s">&#39;warn&#39;</span><span class="p">]))</span>
</span><span class='line'><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;message: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">messagestring</span><span class="p">[</span><span class="s">&#39;err&#39;</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When running this example, this is the output that you will see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python app.py
</span><span class='line'>2021-07-19 13:07:43,647 <span class="o">[</span>INFO<span class="o">]</span> thisapp message: info message
</span><span class='line'>2021-07-19 13:07:43,647 <span class="o">[</span>WARNING<span class="o">]</span> thisapp message: this is a warning
</span><span class='line'>2021-07-19 13:07:43,647 <span class="o">[</span>ERROR<span class="o">]</span> thisapp message: this is a error
</span></code></pre></td></tr></table></div></figure>


<p>More more info on this package, see it&rsquo;s documentation:
- <a href="https://docs.python.org/3/library/logging.html">https://docs.python.org/3/library/logging.html</a></p>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Difference With ECS Task and Execution IAM Roles on AWS]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/07/31/difference-with-ecs-task-and-execution-iam-roles-on-aws/"/>
    <updated>2021-07-31T03:37:34-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/07/31/difference-with-ecs-task-and-execution-iam-roles-on-aws</id>
    <content type="html"><![CDATA[<p><img src="https://blog.ruanbekker.com/images/ruanbekker-header-photo.png" alt="" /></p>

<p>In this post we will look at what the difference is between the <a href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/task-iam-roles.html">AWS ECS Task Execution IAM Role</a> and the <a href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/task-iam-roles.html">IAM Role for Tasks</a> and give a example policy to demonstrate.</p>

<h2>ECS Task Execution Role</h2>

<p>The ECS Execution Role is used by the ecs-agent which runs on ECS and is responsible for:
- Pulling down docker images from ECR
- Fetching the SSM Parameters from SSM for your Task (Secrets and LogConfigurations)
- Writing Logs to CloudWatch</p>

<p>The IAM Role has been configured that the Trusted Identity is ecs so only ECS is allowed to assume credentials from the IAM Policy that is associated to the Role.</p>

<p>The trusted identity in the IAM Role to be ecs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;ecs-tasks.amazonaws.com&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and the policy will look like this more or less for a example service, I am demonstrating my-dev-service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;ecr:GetAuthorizationToken&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;ecr:BatchCheckLayerAvailability&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;ecr:GetDownloadUrlForLayer&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;ecr:BatchGetImage&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;logs:CreateLogStream&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;logs:PutLogEvents&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;SSMGetParameters&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;ssm:GetParameter&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:ssm:eu-west-1:*:parameter/my-service/dev/*&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;KMSDecryptParametersWithKey&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;kms:GetPublicKey&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;kms:Decrypt&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;kms:GenerateDataKey&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;kms:DescribeKey&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the ECS Task Definition the role arn is specified as <code>"executionRoleArn"</code> in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;my-dev-service&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;executionRoleArn&quot;</span><span class="p">:</span><span class="s2">&quot;arn:aws:iam::000000000000:role/ecs-exec-role&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;taskRoleArn&quot;</span><span class="p">:</span><span class="s2">&quot;arn:aws:iam::000000000000:role/ecs-task-role&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;containerDefinitions&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ECS Task Role</h2>

<p>The ECS Task Role is used by the service that is deployed to ECS, so this will be your application requiring access to SQS as an example</p>

<p>Same as before, we set the trusted identity in the IAM Role to be ecs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;ecs-tasks.amazonaws.com&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So only the ECS tasks using the role is allowed to assume credentials from the IAM Role, and the policy associated to the role, can look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;AllowDevSQS&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;sqs:GetQueueUrl&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;sqs:ReceiveMessage&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;sqs:SendMessage&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;sqs:ChangeMessageVisibility&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;arn:aws:sqs:eu-west-1:000000000000:dev-pending-queue&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;arn:aws:sqs:eu-west-1:000000000000:dev-confirmed-queue&quot;</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The role arn will be specified in <code>"taskRoleArn"</code> from the following in the ECS Task Definition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;my-dev-service&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;executionRoleArn&quot;</span><span class="p">:</span><span class="s2">&quot;arn:aws:iam::000000000000:role/ecs-exec-role&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;taskRoleArn&quot;</span><span class="p">:</span><span class="s2">&quot;arn:aws:iam::000000000000:role/ecs-task-role&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;containerDefinitions&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Application Code</h2>

<p>In your application you don’t need to reference any aws access keys as the role will assume credentials for you by the SDK, with python a short example will be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="n">sqs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;sqs&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Java 11 and Maven on Ubuntu Linux]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/07/12/install-java-11-and-maven-on-ubuntu-linux/"/>
    <updated>2021-07-12T02:36:32-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/07/12/install-java-11-and-maven-on-ubuntu-linux</id>
    <content type="html"><![CDATA[<p>In this short tutorial I will show you how to prepare your environment for Java 11 and Maven on Ubuntu for Linux.</p>

<h2>Install</h2>

<p>Update your package manager and install OpenJDK 11:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt update
</span><span class='line'>sudo apt install openjdk-11-jdk -y
</span></code></pre></td></tr></table></div></figure>


<p>Verify that Java is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>java -version
</span><span class='line'>openjdk version <span class="s2">&quot;11.0.11&quot;</span> 2021-04-20
</span><span class='line'>OpenJDK Runtime Environment <span class="o">(</span>build 11.0.11+9-Ubuntu-0ubuntu2.20.04<span class="o">)</span>
</span><span class='line'>OpenJDK 64-Bit Server VM <span class="o">(</span>build 11.0.11+9-Ubuntu-0ubuntu2.20.04, mixed mode, sharing<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once Java is installed, we can install Maven, first switch to the root user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo su
</span></code></pre></td></tr></table></div></figure>


<p>I will be using maven version <code>3.6.2</code>, so adjust accordingly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ MAVEN_HOME</span><span class="o">=</span><span class="s2">&quot;/opt/maven&quot;</span>
</span><span class='line'><span class="nv">$ MAVEN_VERSION</span><span class="o">=</span>3.6.3
</span><span class='line'><span class="nv">$ MAVEN_CONFIG_HOME</span><span class="o">=</span><span class="s2">&quot;/root/.m2&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the directories, then download maven and extract:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p <span class="nv">$MAVEN_HOME</span>
</span><span class='line'><span class="nv">$ </span>curl -LSso /var/tmp/apache-maven-<span class="nv">$MAVEN_VERSION</span>-bin.tar.gz https://apache.org/dist/maven/maven-3/<span class="nv">$MAVEN_VERSION</span>/binaries/apache-maven-<span class="nv">$MAVEN_VERSION</span>-bin.tar.gz
</span><span class='line'><span class="nv">$ </span>tar xzvf /var/tmp/apache-maven-<span class="nv">$MAVEN_VERSION</span>-bin.tar.gz -C <span class="nv">$MAVEN_HOME</span> --strip-components<span class="o">=</span>1
</span><span class='line'><span class="nv">$ </span>rm /var/tmp/apache-maven-<span class="nv">$MAVEN_VERSION</span>-bin.tar.gz
</span><span class='line'><span class="nv">$ </span>update-alternatives --install /usr/bin/mvn mvn /opt/maven/bin/mvn 10000
</span><span class='line'><span class="nv">$ </span>mkdir -p <span class="nv">$MAVEN_CONFIG_HOME</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set the environment variables for maven:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/profile.d/custom.sh
</span><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nb">export </span><span class="nv">MAVEN_HOME</span><span class="o">=</span><span class="s2">&quot;/opt/maven&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">MAVEN_VERSION</span><span class="o">=</span>3.6.3
</span><span class='line'><span class="nb">export </span><span class="nv">MAVEN_CONFIG_HOME</span><span class="o">=</span><span class="s2">&quot;/root/.m2&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then make the file executable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x /etc/profile.d/custom.sh
</span></code></pre></td></tr></table></div></figure>


<p>Verify that maven is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mvn -version
</span><span class='line'>Apache Maven 3.6.3 <span class="o">(</span>cecedd343002696d0abb50b32b541b8a6ba2883f<span class="o">)</span>
</span><span class='line'>Maven home: /opt/maven
</span><span class='line'>Java version: 11.0.11, vendor: Ubuntu, runtime: /usr/lib/jvm/java-11-openjdk-amd64
</span><span class='line'>Default locale: en, platform encoding: UTF-8
</span><span class='line'>OS name: <span class="s2">&quot;linux&quot;</span>, version: <span class="s2">&quot;5.4.0-1041-aws&quot;</span>, arch: <span class="s2">&quot;amd64&quot;</span>, family: <span class="s2">&quot;unix&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a Crypto Digibyte Full Node on Linux]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/05/03/setup-a-crypto-digibyte-full-node-on-linux/"/>
    <updated>2021-05-03T17:14:49-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/05/03/setup-a-crypto-digibyte-full-node-on-linux</id>
    <content type="html"><![CDATA[<p><img src="https://upload.wikimedia.org/wikipedia/en/8/8f/DigiByte_logo.svg" alt="" /></p>

<p>In this tutorial I will show you how to setup a digibyte (DGB) Full Node on Linux and show you how to interact with your wallet and the blockchain.</p>

<h2>What is a Full Node</h2>

<p>By running a Full Node, you contribute by helping to fully validate transactions and blocks. Almost all full nodes also help the network by accepting transactions and blocks from other full nodes, validating those transactions and blocks and then relaying them to other full nodes. Therefore you are contributing to maintaining the consensus of the blockchain.</p>

<h2>Hardware Requirements</h2>

<p>In order to run a full digibyte node you will need a server that is preferrably online 24/7 and that you have an uncapped connection as at the time of writing the digibyte blockchain is about 25GB in size but increases over time. I also used a server with 2vCPU&rsquo;s and 4GB of memory.</p>

<h2>Setup the Pre-Requisites</h2>

<p>First create the user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>useradd -G sudo digibyte -m -s /bin/bash
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;digibyte ALL=(ALL:ALL) NOPASSWD: ALL&quot;</span> <span class="p">|</span> sudo tee /etc/sudoers.d/no-sudo-password-for-digibyte
</span></code></pre></td></tr></table></div></figure>


<p>Create the configuration directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /etc/digibyte /var/lib/digibyte
</span></code></pre></td></tr></table></div></figure>


<p>Create the digibyte configuration file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat <span class="s">&lt;&lt;EOF &gt; /etc/digibyte/digibyte.conf</span>
</span><span class='line'><span class="s">daemon=1</span>
</span><span class='line'><span class="s">maxconnections=300</span>
</span><span class='line'><span class="s">disablewallet=0</span>
</span><span class='line'><span class="s">rpcuser=jsonrpc</span>
</span><span class='line'><span class="s">rpcpassword=$(openssl rand -base64 18)</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Download the Software</h2>

<p>Get the <a href="https://github.com/DigiByte-Core/digibyte/releases">latest</a> release, but at the time of writing v7.17.2 is the latest:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/DigiByte-Core/digibyte/releases/download/v7.17.2/digibyte-7.17.2-x86_64-linux-gnu.tar.gz
</span><span class='line'><span class="nv">$ </span>tar -xf digibyte-7.17.2-x86_64-linux-gnu.tar.gz
</span><span class='line'><span class="nv">$ </span>mv digibyte-7.17.2 /usr/local/digibyte-7.17.2
</span></code></pre></td></tr></table></div></figure>


<p>Then symbolic link the version directory to digibyte:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ln -s /usr/local/digibyte-7.17.2 /usr/local/digibyte
</span></code></pre></td></tr></table></div></figure>


<h2>SystemD</h2>

<p>Create the systemd unit file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat <span class="s">&lt;&lt;EOF &gt; /etc/systemd/system/digibyted.service</span>
</span><span class='line'><span class="s">[Unit]</span>
</span><span class='line'><span class="s">Description=DigiByte&#39;s distributed currency daemon</span>
</span><span class='line'><span class="s">After=network.target</span>
</span><span class='line'>
</span><span class='line'><span class="s">[Service]</span>
</span><span class='line'><span class="s">User=digibyte</span>
</span><span class='line'><span class="s">Group=digibyte</span>
</span><span class='line'>
</span><span class='line'><span class="s">Type=forking</span>
</span><span class='line'><span class="s">PIDFile=/etc/digibyte/digibyted.pid</span>
</span><span class='line'><span class="s">ExecStart=/usr/local/digibyte/bin/digibyted -daemon -pid=/etc/digibyte/digibyted.pid \</span>
</span><span class='line'><span class="s">  -conf=/etc/digibyte/digibyte.conf -datadir=/var/lib/digibyte -deprecatedrpc=accounts </span>
</span><span class='line'>
</span><span class='line'><span class="s">Restart=always</span>
</span><span class='line'><span class="s">PrivateTmp=true</span>
</span><span class='line'><span class="s">TimeoutStopSec=60s</span>
</span><span class='line'><span class="s">TimeoutStartSec=2s</span>
</span><span class='line'><span class="s">StartLimitInterval=120s</span>
</span><span class='line'><span class="s">StartLimitBurst=5</span>
</span><span class='line'>
</span><span class='line'><span class="s">[Install]</span>
</span><span class='line'><span class="s">WantedBy=multi-user.target</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Change the ownerships to digibyte:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chown -R digibyte:digibyte /etc/digibyte /var/lib/digibyte
</span></code></pre></td></tr></table></div></figure>


<p>Enable and start the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>digibyted.service
</span><span class='line'><span class="nv">$ </span>systemctl start digibyted.service
</span></code></pre></td></tr></table></div></figure>


<p>Check the log:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tail -f /var/lib/digibyte/debug.log
</span></code></pre></td></tr></table></div></figure>


<h2>Interact with the Node</h2>

<p>Check the uptime:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;uptime&quot;, &quot;params&quot;: []}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check the wallet address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;getaccountaddress&quot;, &quot;params&quot;: []}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:<span class="s2">&quot;D7ZznMe4NyEkXd6zA6MB3GYXiAURo64hNs&quot;</span>,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Get the account balance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;getbalance&quot;, &quot;params&quot;: []}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:0.00000000,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the digibyte-cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/usr/local/digibyte/bin/digibyte-cli -getinfo
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;version&quot;</span>: 7170200,
</span><span class='line'>  <span class="s2">&quot;protocolversion&quot;</span>: 70017,
</span><span class='line'>  <span class="s2">&quot;walletversion&quot;</span>: 169900,
</span><span class='line'>  <span class="s2">&quot;balance&quot;</span>: 0.00000000,
</span><span class='line'>  <span class="s2">&quot;blocks&quot;</span>: 183019,
</span><span class='line'>  <span class="s2">&quot;timeoffset&quot;</span>: 0,
</span><span class='line'>  <span class="s2">&quot;connections&quot;</span>: 8,
</span><span class='line'>  <span class="s2">&quot;proxy&quot;</span>: <span class="s2">&quot;&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;difficulty&quot;</span>: null,
</span><span class='line'>  <span class="s2">&quot;testnet&quot;</span>: <span class="nb">false</span>,
</span><span class='line'>  <span class="s2">&quot;keypoololdest&quot;</span>: 1619558662,
</span><span class='line'>  <span class="s2">&quot;keypoolsize&quot;</span>: 1000,
</span><span class='line'>  <span class="s2">&quot;paytxfee&quot;</span>: 0.00000000,
</span><span class='line'>  <span class="s2">&quot;relayfee&quot;</span>: 0.00001000,
</span><span class='line'>  <span class="s2">&quot;warnings&quot;</span>: <span class="s2">&quot;&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Making a Transaction to my Wallet</h2>

<p>Let&rsquo;s make a transaction to my wallet node from a crypto currency exchange where I have digibyte, so first to get the wallet address where we would like to deposit the crypto currency:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;getaccountaddress&quot;, &quot;params&quot;: []}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:<span class="s2">&quot;D7ZznMe4NyEkXd6zA6MB3GYXiAURo64hNs&quot;</span>,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>From a exchange where you have DGB, withdraw to the address DN8RMAUz2yHGW1PuuLtiSkiTZARzMJ4L2A which is your wallet on the node (ensure you have enough to cover the transaction fee).</p>

<p>Once the transaction has enough confirmations, have a look at your wallet balance, and you will see the 5 DGB that I sent to my wallet can be seen:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;getbalance&quot;, &quot;params&quot;: [&quot;&quot;]}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:5.00000000,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve setup a software wallet on my pc, and from DGB I selected receive and copied my DGB software wallet address, now I would like to transfer my funds from my node wallet to my software wallet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;:&quot;curl&quot;, &quot;method&quot;: &quot;sendtoaddress&quot;, &quot;params&quot;: [&quot;DTqHG9KA3oQAywq18gpBknxHXHZviyYdvS&quot;, 5.0, &quot;donation&quot;, &quot;happy bday&quot;] }&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:null,<span class="s2">&quot;error&quot;</span>:<span class="o">{</span><span class="s2">&quot;code&quot;</span>:-4,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;Error: This transaction requires a transaction fee of at least 0.0004324&quot;</span><span class="o">}</span>,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see I don&rsquo;t have enough in my nodes wallet to make the transaction, therefore I need to keep the transaction cost in consideration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python3 -c <span class="s1">&#39;print(5.0-0.0004324)&#39;</span>
</span><span class='line'>4.9995676
</span></code></pre></td></tr></table></div></figure>


<p>So let&rsquo;s send <code>4.998</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;:&quot;curl&quot;, &quot;method&quot;: &quot;sendtoaddress&quot;, &quot;params&quot;: [&quot;DTqHG9KA3oQAywq18gpBknxHXHZviyYdvS&quot;, 4.998, &quot;donation&quot;, &quot;happy bday&quot;] }&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:<span class="s2">&quot;260e49b72f17f42f5a6c858e5403e23b5382000650997292e7e79f1535f5c4d0&quot;</span>,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see we are getting back a transaction id which we can use later to check up on. A couple of seconds later I received a notification on my software wallet that my funds were received:</p>

<p><img src="https://user-images.githubusercontent.com/567298/116690769-2aae2880-a9ba-11eb-8735-3fd1f0cc9ece.png" alt="" /></p>

<p>First, using our software wallet&rsquo;s address we can look it up:
- <a href="https://digiexplorer.info/address/DTqHG9KA3oQAywq18gpBknxHXHZviyYdvS">https://digiexplorer.info/address/DTqHG9KA3oQAywq18gpBknxHXHZviyYdvS</a></p>

<p>And it should look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/116691497-29313000-a9bb-11eb-962d-0427a560718a.png" alt="" /></p>

<p>We can also lookup the transaction id:
- <a href="https://digiexplorer.info/tx/260e49b72f17f42f5a6c858e5403e23b5382000650997292e7e79f1535f5c4d0">https://digiexplorer.info/tx/260e49b72f17f42f5a6c858e5403e23b5382000650997292e7e79f1535f5c4d0</a></p>

<p>And it should look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/116691773-9ba21000-a9bb-11eb-978e-58be3a8be045.png" alt="" /></p>

<h2>Resources</h2>

<p>RPC Docs:
- <a href="https://developer.bitcoin.org/reference/rpc/index.html">https://developer.bitcoin.org/reference/rpc/index.html</a>
- <a href="https://chainquery.com/bitcoin-cli">https://chainquery.com/bitcoin-cli</a></p>

<p>Digibyte Config:
- <a href="https://github.com/digibyte/digibyte/blob/master/contrib/debian/examples/digibyte.conf">https://github.com/digibyte/digibyte/blob/master/contrib/debian/examples/digibyte.conf</a></p>

<p>REST Config:
- <a href="https://github.com/digibyte/digibyte/blob/master/doc/REST-interface.md">https://github.com/digibyte/digibyte/blob/master/doc/REST-interface.md</a></p>

<p>Resources:
- <a href="https://digibytewallets.com/">https://digibytewallets.com/</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Install Concourse CI V6 on Ubuntu 20.04]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/04/06/install-concourse-ci-v6-on-ubuntu-20-dot-04/"/>
    <updated>2021-04-06T17:56:38-04:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/04/06/install-concourse-ci-v6-on-ubuntu-20-dot-04</id>
    <content type="html"><![CDATA[<p><img src="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495" alt="" /></p>

<p>Concourse is a Pipeline Based Continious Integration system written in Go</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://concourse-ci.org/">https://concourse-ci.org/</a></li>
<li><a href="https://github.com/concourse/concourse">https://github.com/concourse/concourse</a></li>
<li><a href="https://github.com/starkandwayne/concourse-tutorial">https://github.com/starkandwayne/concourse-tutorial</a></li>
</ul>


<h2>Older Version</h2>

<p>An older version is available:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2017/11/07/setup-a-concourse-ci-server-on-ubuntu-16/">Setup Concourse CI v4 on Ubuntu 16.04</a></li>
</ul>


<h2>What is Concourse CI:</h2>

<p>Concourse CI is a Continious Integration Platform. Concourse enables you to construct pipelines with a yaml configuration that can consist out of 3 core concepts, tasks, resources, and jobs that compose them. For more information about this have a look at their <a href="https://concourse.ci/concepts.html">docs</a></p>

<h2>What will we be doing today</h2>

<p>We will setup a Concourse CI Server v6.7.6 (web and worker) on Ubuntu 20.04 and run the traditional <code>Hello, World</code> pipeline</p>

<h2>Setup the Server:</h2>

<p>Concourse needs <code>PostgresSQL</code> server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install postgresql postgresql-contrib -y
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>postgresql
</span></code></pre></td></tr></table></div></figure>


<p>Create the Database and User for Concourse on Postgres:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo -u postgres createuser concourse
</span><span class='line'><span class="nv">$ </span>sudo -u postgres createdb --owner<span class="o">=</span>concourse atc
</span></code></pre></td></tr></table></div></figure>


<p>Download the Concourse and Fly Cli Binaries:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v6.7.6/concourse-6.7.6-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v6.7.6/fly-6.7.6-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>tar -xvf concourse-6.7.6-linux-amd64.tgz -C /usr/local/
</span><span class='line'><span class="nv">$ </span>tar -xvf fly-6.7.6-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>mv fly /usr/bin/fly
</span><span class='line'><span class="nv">$ </span>rm -rf concourse-6.7.6-linux-amd64.tgz fly-6.7.6-linux-amd64.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Create the Encryption Keys:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /etc/concourse
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/tsa_host_key
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/worker_key
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/session_signing_key
</span><span class='line'><span class="nv">$ </span>cp /etc/concourse/worker_key.pub /etc/concourse/authorized_worker_keys
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Web Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/concourse/web_environment
</span><span class='line'>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/concourse/bin
</span><span class='line'><span class="nv">CONCOURSE_ADD_LOCAL_USER</span><span class="o">=</span>ruan:pass
</span><span class='line'><span class="nv">CONCOURSE_SESSION_SIGNING_KEY</span><span class="o">=</span>/etc/concourse/session_signing_key
</span><span class='line'><span class="nv">CONCOURSE_TSA_HOST_KEY</span><span class="o">=</span>/etc/concourse/tsa_host_key
</span><span class='line'><span class="nv">CONCOURSE_TSA_AUTHORIZED_KEYS</span><span class="o">=</span>/etc/concourse/authorized_worker_keys
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_HOST</span><span class="o">=</span>127.0.0.1
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_USER</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_PASSWORD</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_DATABASE</span><span class="o">=</span>atc
</span><span class='line'><span class="nv">CONCOURSE_MAIN_TEAM_LOCAL_USER</span><span class="o">=</span>ruan
</span><span class='line'><span class="nv">CONCOURSE_EXTERNAL_URL</span><span class="o">=</span>http://10.20.30.40:8080 <span class="c"># replace this with your ip address</span>
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Worker Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/concourse/worker_environment
</span><span class='line'>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/concourse/bin
</span><span class='line'><span class="nv">CONCOURSE_WORK_DIR</span><span class="o">=</span>/var/lib/concourse
</span><span class='line'><span class="nv">CONCOURSE_TSA_HOST</span><span class="o">=</span>127.0.0.1:2222
</span><span class='line'><span class="nv">CONCOURSE_TSA_PUBLIC_KEY</span><span class="o">=</span>/etc/concourse/tsa_host_key.pub
</span><span class='line'><span class="nv">CONCOURSE_TSA_WORKER_PRIVATE_KEY</span><span class="o">=</span>/etc/concourse/worker_key
</span><span class='line'><span class="nv">CONCOURSE_GARDEN_DNS_SERVER</span><span class="o">=</span>8.8.8.8
</span></code></pre></td></tr></table></div></figure>


<p>Create a Concourse user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /var/lib/concourse
</span><span class='line'><span class="nv">$ </span>sudo adduser --system --group concourse
</span><span class='line'><span class="nv">$ </span>sudo chown -R concourse:concourse /etc/concourse /var/lib/concourse
</span><span class='line'><span class="nv">$ </span>sudo chmod <span class="m">600</span> /etc/concourse/*_environment
</span></code></pre></td></tr></table></div></figure>


<p>Create SystemD Unit Files, first for the Web Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/systemd/system/concourse-web.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Concourse CI web process <span class="o">(</span>ATC and TSA<span class="o">)</span>
</span><span class='line'><span class="nv">After</span><span class="o">=</span>postgresql.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">User</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>on-failure
</span><span class='line'><span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/concourse/web_environment
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/concourse web
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></code></pre></td></tr></table></div></figure>


<p>Then the SystemD Unit File for the Worker Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/systemd/system/concourse-worker.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Concourse CI worker process
</span><span class='line'><span class="nv">After</span><span class="o">=</span>concourse-web.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">User</span><span class="o">=</span>root
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>on-failure
</span><span class='line'><span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/concourse/worker_environment
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/concourse worker
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></code></pre></td></tr></table></div></figure>


<p>Create a postgres password for the concourse user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /home/concourse/
</span><span class='line'><span class="nv">$ </span>sudo -u concourse psql atc
</span><span class='line'><span class="nv">atc</span><span class="o">=</span>&gt; ALTER USER concourse WITH PASSWORD <span class="s1">&#39;concourse&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">atc</span><span class="o">=</span>&gt; <span class="se">\q</span>
</span></code></pre></td></tr></table></div></figure>


<p>Start and Enable the Services:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl start concourse-web concourse-worker
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>concourse-web concourse-worker postgresql
</span><span class='line'><span class="nv">$ </span>systemctl status concourse-web concourse-worker
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>systemctl is-active concourse-worker concourse-web
</span><span class='line'>active
</span><span class='line'>active
</span></code></pre></td></tr></table></div></figure>


<p>The listening ports should more or less look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -tulpn
</span><span class='line'>
</span><span class='line'>Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7777          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7788          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:8079          0.0.0.0:*               LISTEN      4525/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      1283/sshd
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:5432          0.0.0.0:*               LISTEN      4047/postgres
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::36159                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::46829                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::2222                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::8080                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      1283/sshd
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:68              0.0.0.0:*                           918/dhclient
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:42165           0.0.0.0:*                           4530/concourse
</span></code></pre></td></tr></table></div></figure>


<h2>Client Side:</h2>

<p>I will be using a the Fly cli from a Mac, so first we need to download the fly-cli for Mac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v6.7.6/fly-6.7.6-darwin-amd64.tgz
</span><span class='line'><span class="nv">$ </span>tar -xvf fly-6.7.6-darwin-amd64.tgz
</span><span class='line'><span class="nv">$ </span>sudo mv fly /usr/local/bin/fly
</span><span class='line'><span class="nv">$ </span>rm -rf fly-6.7.6-darwin-amd64.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to setup our Concourse Target by Authenticating against our Concourse Endpoint, lets setup our target with the name <code>ci</code>, and make sure to replace the ip address with the ip of your concourse server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci login -c http://10.20.30.40:8080
</span><span class='line'>logging in to team <span class="s1">&#39;main&#39;</span>
</span><span class='line'>
</span><span class='line'>navigate to the following URL in your browser:
</span><span class='line'>
</span><span class='line'>  http://10.20.30.40:8080/login?fly_port<span class="o">=</span>42181
</span><span class='line'>
</span><span class='line'>or enter token manually <span class="o">(</span>input hidden<span class="o">)</span>:
</span><span class='line'>target saved
</span></code></pre></td></tr></table></div></figure>


<p>Lets list our targets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly targets
</span><span class='line'>name  url                        team  expiry
</span><span class='line'>ci    http://10.20.30.40:8080    main  Wed, <span class="m">08</span> Nov <span class="m">2021</span> 15:32:59 UTC
</span></code></pre></td></tr></table></div></figure>


<p>Listing Registered Workers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>10.20.30.40       <span class="m">0</span>           linux     none  none  running  1.2
</span></code></pre></td></tr></table></div></figure>


<p>Listing Active Containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job            build <span class="c">#  build id  type   name                  attempt</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hello World Pipeline:</h2>

<p>Let&rsquo;s create a basic pipeline, that will print out <code>Hello, World!</code>:</p>

<p>Our <code>hello-world.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-job</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">say-hello</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine</span>
</span><span class='line'>          <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">edge</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/bin/sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">-c</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Hello, World!&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Applying the configuration to our pipeline:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci <span class="nb">set</span>-pipeline -p yeeehaa -c hello-world.yml
</span><span class='line'><span class="nb">jobs</span>:
</span><span class='line'>  job my-job has been added:
</span><span class='line'>    name: my-job
</span><span class='line'>    plan:
</span><span class='line'>    - task: say-hello
</span><span class='line'>      config:
</span><span class='line'>        platform: linux
</span><span class='line'>        image_resource:
</span><span class='line'>          <span class="nb">type</span>: docker-image
</span><span class='line'>          <span class="nb">source</span>:
</span><span class='line'>            repository: alpine
</span><span class='line'>            tag: edge
</span><span class='line'>        run:
</span><span class='line'>          path: /bin/sh
</span><span class='line'>          args:
</span><span class='line'>          - -c
</span><span class='line'>          - <span class="p">|</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'>apply configuration? <span class="o">[</span>yN<span class="o">]</span>: y
</span><span class='line'>pipeline created!
</span><span class='line'>you can view your pipeline here: http://10.20.30.40:8080/teams/main/pipelines/yeeehaa
</span><span class='line'>
</span><span class='line'>the pipeline is currently paused. to unpause, either:
</span><span class='line'>  - run the unpause-pipeline <span class="nb">command</span>
</span><span class='line'>  - click play next to the pipeline in the web ui
</span></code></pre></td></tr></table></div></figure>


<p>We can browse to the WebUI to unpause the pipeline, but since I like to do everything on cli as far as possible, I will unpause the pipeline via cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci unpause-pipeline -p yeeehaa
</span><span class='line'>unpaused <span class="s1">&#39;yeeehaa&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now our Pipeline is unpaused, but since we did not specify any triggers, we need to manually trigger the pipeline to run, you can either via the WebUI, select your pipeline which in this case will be named <code>yeeehaa</code> and then select the job, which will be <code>my-job</code> then hit the <code>+</code> sign, which will trigger the pipeline.</p>

<p>I will be using the cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job
</span><span class='line'>started yeeehaa/my-job <span class="c">#1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Via the WebUI on <code>http://10.20.30.40:8080/teams/main/pipelines/yeeehaa/jobs/my-job/builds/1</code> you should see the <code>Hello, World!</code> output, or via the cli, we also have the option to see the output, so let&rsquo;s trigger it again, but this time passing the <code>--watch</code> flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job --watch
</span><span class='line'>started yeeehaa/my-job <span class="c">#2</span>
</span><span class='line'>
</span><span class='line'>initializing
</span><span class='line'>running /bin/sh -c <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>Hello, World!
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>


<p>Listing our Workers and Containers again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>10.20.30.40       <span class="m">2</span>           linux     none  none  running  1.2
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job         build <span class="c">#  build id  type   name           attempt</span>
</span><span class='line'>36982955-54fd-4c1b-57b8-216486c58db8  10.20.30.40       yeeehaa      my-job      <span class="m">2</span>        <span class="m">729</span>       task   say-hello      n/a
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Wireguard VPN With Unbound ADS Blocking DNS]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/03/10/wireguard-vpn-with-unbound-ads-blocking-dns/"/>
    <updated>2021-03-10T00:59:51-05:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/03/10/wireguard-vpn-with-unbound-ads-blocking-dns</id>
    <content type="html"><![CDATA[<p>In this tutorial we will setup a Wireguard VPN with Unbound DNS Server with some additional configuration to block ads for any clients using the DNS Server while connected to the VPN.</p>

<p>A massive thank you to <a href="https://github.com/complexorganizations/wireguard-manager/blob/main/wireguard-server.sh">complexorganizations</a> for providing the source where this tuturial is based off.</p>

<h2>Install Packages</h2>

<p>I will be using Debian Buster for this installation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update
</span><span class='line'>$ apt upgrade -y
</span><span class='line'>$ apt update && apt install iptables curl coreutils bc jq sed e2fsprogs -y
</span><span class='line'>$ apt install linux-headers-"$(uname -r)" -y</span></code></pre></td></tr></table></div></figure>


<p>I want to disable IPv6, in my case I had to apply a couple of kernel parameter tweaks:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo net.ipv6.conf.all.disable_ipv6 = 1 &gt; /etc/sysctl.d/70-disable-ipv6.conf
</span><span class='line'>$ echo "net.ipv6.conf.$(ip -4 route ls | grep default | grep -Po '(?&lt;=dev )(\S+)' | head -1).disable_ipv6 = 1" &gt;&gt; /etc/sysctl.d/70-disable-ipv6.conf
</span><span class='line'>$ echo 'net.ipv4.ip_forward = 1' &gt; /etc/sysctl.d/60-enable-ip-forwarding.conf
</span><span class='line'>$ sysctl -p -f /etc/sysctl.d/70-disable-ipv6.conf
</span><span class='line'>$ sysctl -p -f /etc/sysctl.d/60-enable-ip-forwarding.conf</span></code></pre></td></tr></table></div></figure>


<h2>Environment Variables</h2>

<p>A couple of environment variables that we will reference during our installation, tweak where your setup differs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export NPROC=$(nproc)
</span><span class='line'>$ export SERVER_HOST=$(curl -s -4 ifconfig.co)
</span><span class='line'>$ export SERVER_PORT="51820"
</span><span class='line'>$ export MTU_CHOICE="1280"
</span><span class='line'>$ export NAT_CHOICE="25"
</span><span class='line'>$ export IPV4_SUBNET="10.7.0.0/24"
</span><span class='line'>$ export PRIVATE_SUBNET_V4=${IPV4_SUBNET}
</span><span class='line'>$ export GATEWAY_ADDRESS_V4="${PRIVATE_SUBNET_V4::-4}1"
</span><span class='line'>$ export PRIVATE_SUBNET_MASK_V4=$(echo "$PRIVATE_SUBNET_V4" | cut -d "/" -f 2)
</span><span class='line'>$ export CLIENT_DNS="$GATEWAY_ADDRESS_V4"
</span><span class='line'>$ export CLIENT_ALLOWED_IP="0.0.0.0/0"</span></code></pre></td></tr></table></div></figure>


<h2>Unbound Installation</h2>

<p>Download the unbound <code>root.hints</code> file from internic:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl https://www.internic.net/domain/named.cache --create-dirs -o /etc/unbound/root.hints</span></code></pre></td></tr></table></div></figure>


<p>Generate the <code>/etc/unbound/unbound.conf</code> config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "include: \"/etc/unbound/unbound.conf.d/*.conf\"
</span><span class='line'>server:
</span><span class='line'>    num-threads: $NPROC
</span><span class='line'>    verbosity: 1
</span><span class='line'>    root-hints: /etc/unbound/root.hints
</span><span class='line'>    # auto-trust-anchor-file: /var/lib/unbound/root.key
</span><span class='line'>    interface: 0.0.0.0
</span><span class='line'>    interface: ::0
</span><span class='line'>    max-udp-size: 3072
</span><span class='line'>    access-control: 0.0.0.0/0                 refuse
</span><span class='line'>    access-control: $PRIVATE_SUBNET_V4               allow
</span><span class='line'>    access-control: 127.0.0.1                 allow
</span><span class='line'>    private-address: $PRIVATE_SUBNET_V4
</span><span class='line'>    hide-identity: yes
</span><span class='line'>    hide-version: yes
</span><span class='line'>    harden-glue: yes
</span><span class='line'>    harden-dnssec-stripped: yes
</span><span class='line'>    harden-referral-path: yes
</span><span class='line'>    unwanted-reply-threshold: 10000000
</span><span class='line'>    val-log-level: 1
</span><span class='line'>    cache-min-ttl: 1800
</span><span class='line'>    cache-max-ttl: 14400
</span><span class='line'>    prefetch: yes
</span><span class='line'>    qname-minimisation: yes
</span><span class='line'>    prefetch-key: yes
</span><span class='line'>    forward-zone:
</span><span class='line'>        name: \".\"
</span><span class='line'>        forward-addr: 1.1.1.1
</span><span class='line'>        forward-addr: 8.8.8.8" &gt;&gt; /etc/unbound/unbound.conf</span></code></pre></td></tr></table></div></figure>


<p>Download the host entries for all the ad servers which we will block:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/social/hosts -o /tmp/adblocking_hosts</span></code></pre></td></tr></table></div></figure>


<p>Include the ads configuration in <code>/etc/unbound/unbound.d/ads.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "server:" &gt; /etc/unbound/unbound.conf.d/ads.conf
</span><span class='line'>$ cat /etc/unbound/adblocking_hosts | grep '^0\.0\.0\.0' | awk '{print "    local-zone: \""$2"\" redirect\n    local-data: \""$2" A 0.0.0.0\""}' &gt;&gt; /etc/unbound/unbound.conf.d/ads.conf</span></code></pre></td></tr></table></div></figure>


<p>Update the VPN Server&rsquo;s nameserver configuration to unbound:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chattr -i /etc/resolv.conf
</span><span class='line'>$ mv /etc/resolv.conf /etc/resolv.conf.old
</span><span class='line'>$ echo "nameserver 127.0.0.1" &gt;&gt;/etc/resolv.conf
</span><span class='line'>$ chattr +i /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>


<p>Enable and Restart Unbound:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable unbound
</span><span class='line'>$ systemctl restart unbound</span></code></pre></td></tr></table></div></figure>


<p>Test if DNS Resolution works:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ dig google.com</span></code></pre></td></tr></table></div></figure>


<h2>Wireguard Installation</h2>

<p>Include the sources and install wireguard and its dependencies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "deb http://deb.debian.org/debian/ unstable main" &gt;&gt;/etc/apt/sources.list.d/unstable.list
</span><span class='line'>$ echo -e "Package: *\nPin: release a=unstable\nPin-Priority: 90"  &gt;&gt;/etc/apt/preferences.d/limit-unstable
</span><span class='line'>$ apt update
</span><span class='line'>$ apt install wireguard qrencode haveged ifupdown -y</span></code></pre></td></tr></table></div></figure>


<p>Set the environment variables and tweak where you need to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export SERVER_PRIVKEY=$(wg genkey)
</span><span class='line'>$ export SERVER_PUBKEY=$(echo "$SERVER_PRIVKEY" | wg pubkey)
</span><span class='line'>$ export CLIENT_NAME="ruan-pc"
</span><span class='line'>$ export CLIENT_PRIVKEY=$(wg genkey)
</span><span class='line'>$ export CLIENT_PUBKEY=$(echo "$CLIENT_PRIVKEY" | wg pubkey)
</span><span class='line'>$ export CLIENT_ADDRESS_V4="${PRIVATE_SUBNET_V4::-4}3"
</span><span class='line'>$ export PRESHARED_KEY=$(wg genpsk)
</span><span class='line'>$ export WIREGUARD_PUB_NIC="wg0"
</span><span class='line'>$ export PEER_PORT=$(shuf -i1024-65535 -n1)
</span><span class='line'>$ export WG_CONFIG="/etc/wireguard/$WIREGUARD_PUB_NIC.conf"</span></code></pre></td></tr></table></div></figure>


<p>Create the wireguard clients directory and create the config filename:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p /etc/wireguard/clients
</span><span class='line'>$ touch $WG_CONFIG && chmod 600 $WG_CONFIG</span></code></pre></td></tr></table></div></figure>


<p>Create the wireguard server config content and write it to the config file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "# $PRIVATE_SUBNET_V4 $SERVER_HOST:$SERVER_PORT $SERVER_PUBKEY $CLIENT_DNS $MTU_CHOICE $NAT_CHOICE $CLIENT_ALLOWED_IP
</span><span class='line'>[Interface]
</span><span class='line'>Address = $GATEWAY_ADDRESS_V4/$PRIVATE_SUBNET_MASK_V4
</span><span class='line'>ListenPort = $SERVER_PORT
</span><span class='line'>PrivateKey = $SERVER_PRIVKEY
</span><span class='line'>PostUp = iptables -A FORWARD -i $WIREGUARD_PUB_NIC -o $SERVER_PUB_NIC -j ACCEPT; iptables -t nat -A POSTROUTING -o $SERVER_PUB_NIC -j MASQUERADE; iptables -A INPUT -s $PRIVATE_SUBNET_V4 -p udp -m udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
</span><span class='line'>PostDown = iptables -D FORWARD -i $WIREGUARD_PUB_NIC  -o $SERVER_PUB_NIC -j ACCEPT; iptables -t nat -D POSTROUTING -o $SERVER_PUB_NIC -j MASQUERADE; iptables -D INPUT -s $PRIVATE_SUBNET_V4 -p udp -m udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
</span><span class='line'>SaveConfig = false
</span><span class='line'># $CLIENT_NAME start
</span><span class='line'>[Peer]
</span><span class='line'>PublicKey = $CLIENT_PUBKEY
</span><span class='line'>PresharedKey = $PRESHARED_KEY
</span><span class='line'>AllowedIPs = $CLIENT_ADDRESS_V4/32
</span><span class='line'># $CLIENT_NAME end &gt;&gt;" &gt;&gt; $WG_CONFIG</span></code></pre></td></tr></table></div></figure>


<p>Create the client config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "# $CLIENT_NAME
</span><span class='line'>[Interface]
</span><span class='line'>Address = $CLIENT_ADDRESS_V4/$PRIVATE_SUBNET_MASK_V4
</span><span class='line'>DNS = $CLIENT_DNS
</span><span class='line'>ListenPort = $PEER_PORT
</span><span class='line'>MTU = $MTU_CHOICE
</span><span class='line'>PrivateKey = $CLIENT_PRIVKEY
</span><span class='line'>[Peer]
</span><span class='line'>AllowedIPs = $CLIENT_ALLOWED_IP
</span><span class='line'>Endpoint = $SERVER_HOST:$SERVER_PORT
</span><span class='line'>PersistentKeepalive = $NAT_CHOICE
</span><span class='line'>PresharedKey = $PRESHARED_KEY
</span><span class='line'>PublicKey = $SERVER_PUBKEY" &gt;&gt; /etc/wireguard/clients/"$CLIENT_NAME"-$WIREGUARD_PUB_NIC.conf</span></code></pre></td></tr></table></div></figure>


<p>Restart and Enable Wireguard:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable wg-quick@$WIREGUARD_PUB_NIC
</span><span class='line'>$ systemctl restart wg-quick@$WIREGUARD_PUB_NIC</span></code></pre></td></tr></table></div></figure>


<h2>Connect your Client</h2>

<p>Head over to <a href="https://www.wireguard.com/install/">Wireguard.com</a> and install the client of your choice then generate a QR Code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ qrencode -t ansiutf8 -l L &lt;/etc/wireguard/clients/"$CLIENT_NAME"-$WIREGUARD_PUB_NIC.conf</span></code></pre></td></tr></table></div></figure>


<p>Configure your client and connect to the VPN, after the connection has been established you can have a look on the server for connection details with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wg show</span></code></pre></td></tr></table></div></figure>


<p>Once connected head over to a website with ads, such as <a href="https://www.speedtest.net/">https://www.speedtest.net/</a> and you should see no ads.</p>

<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SSH Using AWS SSM Session Manager]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/03/10/ssh-using-aws-ssm-session-manager/"/>
    <updated>2021-03-10T00:52:54-05:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/03/10/ssh-using-aws-ssm-session-manager</id>
    <content type="html"><![CDATA[<p>You can use SSM Session Manager to connect to your EC2 instances, as long as your EC2 instance has the associated IAM Role which includes the AmazonSSMManagedInstanceCore managed policy.</p>

<h2>AWS EC2 Console</h2>

<p>Head over to &ldquo;Connect&rdquo; and select &ldquo;Session Manager&rdquo;:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103775580-e8da2a80-5036-11eb-9e00-0fd9b4d9d467.png" alt="image" /></p>

<p>You should get a shell:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103775597-f2639280-5036-11eb-8101-768f1c81108a.png" alt="image" /></p>

<h2>AWS CLI</h2>

<p>You can also use the CLI:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aws --profile prod ssm start-session --target i-0ebba722b102179b6</span></code></pre></td></tr></table></div></figure>


<p>If you get this error:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103775625-ff808180-5036-11eb-88dc-be8fde3586ad.png" alt="image" /></p>

<p>Head over to:</p>

<p><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html">https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html</a></p>

<p>Install the session manager plugin, for Mac:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip" -o "sessionmanager-bundle.zip"
</span><span class='line'>$ unzip sessionmanager-bundle.zip
</span><span class='line'>$ sudo ./sessionmanager-bundle/install -i /usr/local/sessionmanagerplugin -b /usr/local/bin/session-manager-plugin
</span><span class='line'>$ rm -rf sessionmanager-bundle</span></code></pre></td></tr></table></div></figure>


<p>After installation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aws --profile prod ssm start-session --target i-0ebba722b102179b6
</span><span class='line'>Starting session with SessionId: ruan.bekker-0b07cbbe261885ad3
</span><span class='line'>
</span><span class='line'>sh-4.2$ sudo su - ec2-user
</span><span class='line'>Last login: Wed Jan  6 12:55:03 UTC 2021 on pts/0
</span><span class='line'>[ec2-user@ip-172-31-23-246 ~]$</span></code></pre></td></tr></table></div></figure>


<p>Note: when you are using ssm session manager you don’t require security groups or a direct routable network to your instance.</p>

<h2>Bash Functions FTW</h2>

<p>You can implement this into a bash function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.functions.aws
</span><span class='line'>aws-ssh(){
</span><span class='line'>  instance_name=${1}
</span><span class='line'>  instance_id=$(aws --profile prod ec2 describe-instances --filter "Name=tag:Name,Values=${instance_name}" --query "Reservations[].Instances[?State.Name == 'running'].InstanceId[]" --output text)
</span><span class='line'>  aws --profile prod ssm start-session --target ${instance_id}
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>$ aws-ssh ssm-session-manager-ssh-test2
</span><span class='line'>Starting session with SessionId: ruan.bekker-04daf56c5f3668790
</span><span class='line'>sh-4.2$</span></code></pre></td></tr></table></div></figure>


<p>If you have your own SSH key, you can use this ~/.ssh/config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># AWS SSM Session Manager
</span><span class='line'>Host i-*
</span><span class='line'>    ProxyCommand sh -c "aws --profile prod ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p'"</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -i ~/.ssh/infra.pem ec2-user@i-0ebba722b102179b6
</span><span class='line'>Warning: Permanently added 'i-0ebba722b102179b6' (ECDSA) to the list of known hosts.
</span><span class='line'>Last login: Wed Jan  6 13:04:03 2021
</span><span class='line'>
</span><span class='line'>       __|  __|_  )
</span><span class='line'>       _|  (     /   Amazon Linux 2 AMI
</span><span class='line'>      ___|\___|___|
</span><span class='line'>
</span><span class='line'>https://aws.amazon.com/amazon-linux-2/
</span><span class='line'>[ec2-user@ip-172-31-23-246 ~]$</span></code></pre></td></tr></table></div></figure>


<h2>Related:</h2>

<ul>
<li><a href="https://aws.amazon.com/blogs/mt/amazon-ec2-instance-port-forwarding-with-aws-systems-manager/">https://aws.amazon.com/blogs/mt/amazon-ec2-instance-port-forwarding-with-aws-systems-manager/</a></li>
<li><a href="https://aws.amazon.com/blogs/aws/new-port-forwarding-using-aws-system-manager-sessions-manager/">https://aws.amazon.com/blogs/aws/new-port-forwarding-using-aws-system-manager-sessions-manager/</a></li>
</ul>


<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Bypass the Medium Paywall System]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/03/10/bypass-the-medium-paywall-system/"/>
    <updated>2021-03-10T00:45:54-05:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/03/10/bypass-the-medium-paywall-system</id>
    <content type="html"><![CDATA[<p>Do you like reading stories on medium.com but not a big fan of the paywall system?</p>

<p><img src="https://user-images.githubusercontent.com/567298/108808924-6ab6f080-75b0-11eb-961f-25327551725f.png" alt="image" /></p>

<p>Copy the link, DM yourself on twitter and paste the link:</p>

<p><img src="https://user-images.githubusercontent.com/567298/108809014-9e921600-75b0-11eb-8c01-18da23d43793.png" alt="image" /></p>

<p>Click on the pasted link, and enjoy:</p>

<p><img src="https://user-images.githubusercontent.com/567298/108809056-b2d61300-75b0-11eb-8eeb-38f99118bb17.png" alt="image" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Generate Grafana Loki Log Links From Metric Label Values]]></title>
    <link href="https://blog.ruanbekker.com/blog/2021/03/10/generate-grafana-loki-log-links-from-metric-label-values/"/>
    <updated>2021-03-10T00:34:04-05:00</updated>
    <id>https://blog.ruanbekker.com/blog/2021/03/10/generate-grafana-loki-log-links-from-metric-label-values</id>
    <content type="html"><![CDATA[<p>In this tutorial we will generate Loki Log links from selected dropdown template variables in a Grafana Dashboard.</p>

<h2>Context</h2>

<p>To give more context, we have a Grafana Dashboard with all our services, and when you select that service you see all the metrics of that service, now if you want to see the logs of that service, the selected label values will be parsed to a log link which you can click and it will take you to the Loki Explorer and parse the label values to the log link, so your logql will already be generated for you.</p>

<p>In order to achieve this, our metrics and logs need to share the same labels and label values (environment, container_name) etc.</p>

<h2>Dashboard Variables</h2>

<p>First we have our environment variable:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668240-a6862300-7b79-11eb-85ce-d381edfbe78e.png" alt="image" /></p>

<p>And here we have our service variable:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668438-dc2b0c00-7b79-11eb-9b17-629e9b1716a9.png" alt="image" /></p>

<p>Then for our container_name we have:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668632-05e43300-7b7a-11eb-97a0-8ff81f0c929c.png" alt="image" /></p>

<p>Notice the <code>/^(.*?)-[0-9]/</code> thats just to strip the end, if we remove it it will be:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668778-27451f00-7b7a-11eb-976f-a7d0b473cd1b.png" alt="image" /></p>

<h2>Grafana Dashboard</h2>

<p>Now when we select the environment, service, we get presented with a Loki LogURL:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668970-552a6380-7b7a-11eb-8c72-b284cf0f5eec.png" alt="image" /></p>

<p>If we look at our dashboard links, under the dashboard settings:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109669065-6b382400-7b7a-11eb-8a29-34b492fef327.png" alt="image" /></p>

<p>The Logs Uri is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://grafana.mydomain.com/explore?orgId=1&left=%5B%22now-1h%22,%22now%22,%22Loki%22,%7B%22expr%22:%22%7Bcontainer_name%3D~%5C%22.*$container_name.*%5C%22%7D%22%7D,%7B%22mode%22:%22Logs%22%7D,%7B%22ui%22:%5Btrue,true,true,%22none%22%5D%7D%5D</span></code></pre></td></tr></table></div></figure>


<p>Now when we select our label values from the dropdown for our service and we follow the link we will get:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109669297-a33f6700-7b7a-11eb-8205-f021467af751.png" alt="image" /></p>
]]></content>
  </entry>
  
</feed>
