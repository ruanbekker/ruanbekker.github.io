<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Ruan Bekker's Blog]]></title>
  <link href="http://blog.ruanbekker.com/atom.xml" rel="self"/>
  <link href="http://blog.ruanbekker.com/"/>
  <updated>2019-02-12T15:56:19-05:00</updated>
  <id>http://blog.ruanbekker.com/</id>
  <author>
    <name><![CDATA[Ruan]]></name>
    <email><![CDATA[ruan@ruanbekker.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Concourse Tasks and Inputs Tutorial]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/02/12/concourse-tasks-and-inputs-tutorial/"/>
    <updated>2019-02-12T14:57:27-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/02/12/concourse-tasks-and-inputs-tutorial</id>
    <content type="html"><![CDATA[<p><img src="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495" alt="" /></p>

<p>In this tutorial I will show you how to execute task scripts and using task inputs to have the ability to pass data to concourse for processing.</p>

<p>For my other content on concourse, have a look at the <a href="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495">concourse</a> category.</p>

<h2>Task Inputs</h2>

<p>First, let&rsquo;s run a task on concourse that does not rely on any inputs.</p>

<figure class='code'><figcaption><span>no_inputs.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>  <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span><span class="nv">repository</span><span class="p-Indicator">:</span> <span class="nv">busybox</span><span class="p-Indicator">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">uname</span>
</span><span class='line'><span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;-a&quot;</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running execute with the configuration from above:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci e -c no_inputs.yml
</span><span class='line'>
</span><span class='line'>executing build <span class="m">37</span> at http://10.20.30.40/builds/37
</span><span class='line'>initializing
</span><span class='line'>running uname -a
</span><span class='line'>Linux 2fd4e261-a708-4e15-4a4a-2bc50221a664 4.9.0-8-amd64 <span class="c">#1 SMP Debian 4.9.110-3+deb9u4 (2018-08-21) x86_64 GNU/Linux</span>
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>


<p>As you can see we have executed the command <code>uname -a</code> on one of the containers in Concourse.</p>

<h2>Tasks Inputs: Specify Path</h2>

<p>Now lets say, we have data that needs to be transferred to the container where we are running our tasks. For that we are using inputs.</p>

<p>In this example, we will set the input parameter in our task definition, and override the path with the cli. We will create a couple of files in a folder, then list them in the container where the task is running.</p>

<p>Creating the data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir my-data-folder
</span><span class='line'><span class="nv">$ </span>touch my-data-folder/test1.txt my-data-folder/test2.txt
</span></code></pre></td></tr></table></div></figure>


<p>Our task definition:</p>

<figure class='code'><figcaption><span>inputs_required.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>  <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span><span class="nv">repository</span><span class="p-Indicator">:</span> <span class="nv">busybox</span><span class="p-Indicator">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">inputs</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-input</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ls</span>
</span><span class='line'>  <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;-alR&#39;</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see our input name is called <code>my-input</code> and we will use the cli to map the local folder `my-data-folder`` to the parameter name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci e -c inputs_required.yml -i my-input<span class="o">=</span>./my-data-folder/
</span><span class='line'>
</span><span class='line'>executing build <span class="m">32</span> at http://10.20.30.40/builds/32
</span><span class='line'>initializing
</span><span class='line'>my-input: 262.13 KiB/s 0s
</span><span class='line'>running ls -alR
</span><span class='line'>.:
</span><span class='line'>total 0
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">16</span> Feb <span class="m">10</span> 08:53 .
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">16</span> Feb <span class="m">10</span> 08:53 ..
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">36</span> Feb <span class="m">10</span> 08:53 my-input
</span><span class='line'>
</span><span class='line'>./my-input:
</span><span class='line'>total 0
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">36</span> Feb <span class="m">10</span> 08:53 .
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">16</span> Feb <span class="m">10</span> 08:53 ..
</span><span class='line'>-rw-r--r--    <span class="m">1</span> <span class="m">501</span>      staff            <span class="m">0</span> Feb <span class="m">10</span> 08:52 test1.txt
</span><span class='line'>-rw-r--r--    <span class="m">1</span> <span class="m">501</span>      staff            <span class="m">0</span> Feb <span class="m">10</span> 08:52 test2.txt
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>


<p>As you can see from the above output, the folder was uploaded and placed inside the container where we ran our task.</p>

<h2>Task Inputs: Parent Directory</h2>

<p>Then we can use parent directories. Running a task that relies on the input path which will be our current working directory. Note: the input name should be the same as the current working directory</p>

<p>The input name will be the only thing that differs, which will look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>inputs:
</span><span class='line'>- name: my-data-folder
</span></code></pre></td></tr></table></div></figure>


<p>Running the task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>my-data-folder
</span><span class='line'><span class="nv">$ </span>fly -t ci e -c ../input_parent_dir.yml
</span><span class='line'>
</span><span class='line'>executing build <span class="m">35</span> at http://10.20.30.40/builds/35
</span><span class='line'>initializing
</span><span class='line'>my-data-folder: 395.85 KiB/s 0s
</span><span class='line'>running ls -alR
</span><span class='line'>.:
</span><span class='line'>total 0
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">38</span> Feb <span class="m">10</span> 09:17 .
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">16</span> Feb <span class="m">10</span> 09:17 ..
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">18</span> Feb <span class="m">10</span> 09:17 my-data-folder
</span><span class='line'>
</span><span class='line'>./my-data-folder:
</span><span class='line'>total 0
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">18</span> Feb <span class="m">10</span> 09:17 .
</span><span class='line'>drwxr-xr-x    <span class="m">1</span> root     root            <span class="m">38</span> Feb <span class="m">10</span> 09:17 ..
</span><span class='line'>-rw-r--r--    <span class="m">1</span> <span class="m">501</span>      staff            <span class="m">0</span> Feb <span class="m">10</span> 09:15 test1.txt
</span><span class='line'>-rw-r--r--    <span class="m">1</span> <span class="m">501</span>      staff            <span class="m">0</span> Feb <span class="m">10</span> 09:15 test2.txt
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>


<p>The source code for this can be found at <a href="https://github.com/ruanbekker/concourse-tutorial/tree/master/02-task-inputs">https://github.com/ruanbekker/concourse-tutorial/tree/master/02-task-inputs</a></p>

<h2>Task Scripts:</h2>

<p>In conjunction with inputs, we can let our task configuration reference a script that we want to execute, and using inputs, we can upload the current working directory to concourse, so then the container has context about the data that it needs.</p>

<p>Our task configuration <code>task_show_hostname.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>platform: linux
</span><span class='line'>
</span><span class='line'>image_resource:
</span><span class='line'>  <span class="nb">type</span>: docker-image
</span><span class='line'>  <span class="nb">source</span>: <span class="o">{</span>repository: busybox<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>inputs:
</span><span class='line'>- name: 03-task-scripts
</span><span class='line'>
</span><span class='line'>run:
</span><span class='line'>  path: ./03-task-scripts/task_show_hostname.sh
</span></code></pre></td></tr></table></div></figure>


<p>Our executable script <code>03-task-scripts/task_show_hostname.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="nv">get_hostname</span><span class="o">=</span><span class="k">$(</span>hostname<span class="k">)</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Hostname is: ${get_hostname}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure to apply the executable permissions to the script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x 03-task-scripts/task_show_hostname.sh
</span></code></pre></td></tr></table></div></figure>


<p>With this configuration, it uploads the current working directory to concourse, and the data inside the directory gets placed on the container&rsquo;s working directory: 03-task-scripts, which is the name of the input.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci e -c 03-task-scripts/task_show_hostname.yml
</span><span class='line'>
</span><span class='line'>executing build <span class="m">39</span> at http://10.20.30.40/builds/39
</span><span class='line'>initializing
</span><span class='line'>03-task-scripts: 347.15 KiB/s 0s
</span><span class='line'>running ./03-task-scripts/task_show_hostname.sh
</span><span class='line'>Hostname is: 3ccb3c28-d452-4068-5ea1-101153803d93
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>


<p>The source code for this example can be found at <a href="https://github.com/ruanbekker/concourse-tutorial/tree/master/03-task-scripts">https://github.com/ruanbekker/concourse-tutorial/tree/master/03-task-scripts</a></p>

<p>That&rsquo;s it for Task Inputs and Task Scripts on Concourse, please feel free to have a look at my other content about <a href="http://blog.ruanbekker.com/blog/categories/concourse/">Concourse</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sysadmin Linux Troubleshooting Cheatsheet]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/02/10/sysadmin-linux-troubleshooting-cheatsheet/"/>
    <updated>2019-02-10T14:17:54-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/02/10/sysadmin-linux-troubleshooting-cheatsheet</id>
    <content type="html"><![CDATA[<p>This is a one pager of all the commands I use when I have to troubleshoot problems. This post will be updated as time goes by.</p>

<h2>Curl / Web Response Times</h2>

<p>Template file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat curl-format.txt
</span><span class='line'>time_namelookup:  %<span class="o">{</span>time_namelookup<span class="o">}</span><span class="se">\n</span>
</span><span class='line'>time_connect:  %<span class="o">{</span>time_connect<span class="o">}</span><span class="se">\n</span>
</span><span class='line'>time_appconnect:  %<span class="o">{</span>time_appconnect<span class="o">}</span><span class="se">\n</span>
</span><span class='line'>time_pretransfer:  %<span class="o">{</span>time_pretransfer<span class="o">}</span><span class="se">\n</span>
</span><span class='line'>time_redirect:  %<span class="o">{</span>time_redirect<span class="o">}</span><span class="se">\n</span>
</span><span class='line'>time_starttransfer:  %<span class="o">{</span>time_starttransfer<span class="o">}</span><span class="se">\n</span>
</span><span class='line'>----------<span class="se">\n</span>
</span><span class='line'>time_total:  %<span class="o">{</span>time_total<span class="o">}</span><span class="se">\n</span>
</span></code></pre></td></tr></table></div></figure>


<p>The host header, source addres, destination address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -sk -w <span class="s2">&quot;@curl-format.txt&quot;</span> -o /dev/null -H <span class="s2">&quot;Host: remote-host.mydomain.com&quot;</span> 10.0.2.10 https://10.244.0.240:443 -L
</span><span class='line'>
</span><span class='line'>time_namelookup:  0.012178
</span><span class='line'>time_connect:  0.012225
</span><span class='line'>time_appconnect:  0.062149
</span><span class='line'>time_pretransfer:  0.062175
</span><span class='line'>time_redirect:  0.000172
</span><span class='line'>time_starttransfer:  0.125631
</span><span class='line'>----------
</span><span class='line'>time_total:  0.125849
</span></code></pre></td></tr></table></div></figure>


<h2>MTR / Network Latencies / Packetloss</h2>

<p>No dns, TCP, counts, port, source address, destination address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mtr -n -T -c <span class="m">10</span> --port <span class="m">443</span> 10.2.0.2 10.244.10.5 --report
</span><span class='line'>Start: Sun Feb <span class="m">10</span> 19:04:50 2019
</span><span class='line'>HOST: my-internet-gatewewy         Loss%   Snt   Last   Avg  Best  Wrst StDev
</span><span class='line'>  1.<span class="p">|</span>-- 172.18.110.22              0.0%    <span class="m">10</span>    0.3   0.3   0.3   0.3   0.0
</span><span class='line'>  2.<span class="p">|</span>-- 172.18.110.22              0.0%    <span class="m">10</span>    0.3   0.3   0.3   0.3   0.0
</span><span class='line'>  3.<span class="p">|</span>-- 172.18.110.22              0.0%    <span class="m">10</span>    0.3   0.3   0.3   0.3   0.0
</span></code></pre></td></tr></table></div></figure>


<h2>TCPTraceroute</h2>

<p>No dns, TCP, port, source address, destination address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>traceroute -T -n -p <span class="m">443</span> -s 10.80.4.7 10.2.129.4<span class="p">;</span> <span class="k">done</span>
</span><span class='line'>traceroute to 10.2.129.4 <span class="o">(</span>10.2.129.4<span class="o">)</span>, <span class="m">30</span> hops max, <span class="m">60</span> byte packets
</span><span class='line'> <span class="m">1</span>  10.80.4.1   0.322 ms  0.291 ms  0.224 ms
</span><span class='line'> <span class="m">2</span>  10.2.129.4  179.090 ms  179.022 ms  179.023 ms
</span></code></pre></td></tr></table></div></figure>


<h2>Connection Related:</h2>

<p>Connection flow: <a href="https://askubuntu.com/questions/538443/whats-the-difference-between-port-status-listening-time-wait-close-wait">Thanks to</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Consider two programs attempting a socket connection <span class="o">(</span>call them a and b<span class="o">)</span>. Both <span class="nb">set </span>up sockets and transition to the LISTEN state. Then one program <span class="o">(</span>say a<span class="o">)</span> tries to connect to the other <span class="o">(</span>b<span class="o">)</span>. a sends a request and enters the SYN_SENT state, and b receives the request and enters the SYN_RECV state. When b acknowledges the request, they enter the ESTABLISHED state, and <span class="k">do</span> their business. Now a couple of things can happen:
</span><span class='line'>
</span><span class='line'>    a wishes to close the connection, and enters FIN_WAIT1. b receives the FIN request, sends an ACK <span class="o">(</span><span class="k">then</span> a enters FIN_WAIT2<span class="o">)</span>, enters CLOSE_WAIT, tells a it is closing down and the enters LAST_ACK. Once a acknowledges this <span class="o">(</span>and enters TIME_WAIT<span class="o">)</span>, b enters CLOSE. a waits a bit to see <span class="k">if</span> anythings is left, <span class="k">then</span> enters CLOSE.
</span><span class='line'>    a and b have finished their business and decide to close the connection <span class="o">(</span>simultaneous closing<span class="o">)</span>. When a is in FIN_WAIT, and instead of receiving an ACK from b, it receives a FIN <span class="o">(</span>as b wishes to close it as well<span class="o">)</span>, a enters CLOSING. But there are still some messages to send <span class="o">(</span>the ACK that a is supposed to get <span class="k">for</span> its original FIN<span class="o">)</span>, and once this ACK arrives, a enters TIME_WAIT as usual.
</span></code></pre></td></tr></table></div></figure>


<p>Active Connections:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -n -A  inet <span class="p">|</span> grep -v <span class="s2">&quot;127.0.0.1&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Established Connections:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -nputw <span class="p">|</span> grep ESTABLISHED
</span><span class='line'><span class="nv">$ </span>netstat -antp <span class="p">|</span> grep :3306 <span class="p">|</span> grep ESTABLISHED
</span></code></pre></td></tr></table></div></figure>


<p>Time Wait Connections:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -antp <span class="p">|</span> grep TIME_WAIT
</span></code></pre></td></tr></table></div></figure>


<p>How many connections:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wc -l /proc/net/tcp
</span></code></pre></td></tr></table></div></figure>


<p>Listing Open files per Port:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsof -i:3306
</span></code></pre></td></tr></table></div></figure>


<p>Listing Open files per User:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsof -u glassfish
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<ul>
<li><a href="https://aws.amazon.com/premiumsupport/knowledge-center/troubleshoot-vpn-packet-loss/">AWS: Troubleshoot VPN Latencies</a></li>
<li><a href="https://www.linode.com/docs/networking/diagnostics/diagnosing-network-issues-with-mtr/">Linode: Diagnose Network Issues with MTR</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Port Status Checker Script in C Language]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/02/08/port-status-checker-script-in-c-language/"/>
    <updated>2019-02-08T08:56:11-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/02/08/port-status-checker-script-in-c-language</id>
    <content type="html"><![CDATA[<p>This is a simple script in the C Programming Language to test the port status of a remote address.</p>

<h2>Requirements:</h2>

<p>You will need the gcc package to compile the program:</p>

<p>For RHEL based distro&rsquo;s:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>yum install gcc -y
</span></code></pre></td></tr></table></div></figure>


<p>For Debian based distro&rsquo;s:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install gcc -y
</span></code></pre></td></tr></table></div></figure>


<h2>Check TCP Port Status in C Language:</h2>

<p>Our file: <code>test.c</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/socket.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;netinet/in.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;netdb.h&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">portno</span>     <span class="o">=</span> <span class="mi">443</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span> <span class="o">=</span> <span class="s">&quot;google.com&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">serv_addr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">server</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span><span class="p">(</span><span class="s">&quot;Error opening socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">server</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">hostname</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">server</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;ERROR, no such host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">bzero</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">serv_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_addr</span><span class="p">));</span>
</span><span class='line'>    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>    <span class="n">bcopy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">server</span><span class="o">-&gt;</span><span class="n">h_addr</span><span class="p">,</span>
</span><span class='line'>         <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
</span><span class='line'>         <span class="n">server</span><span class="o">-&gt;</span><span class="n">h_length</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">portno</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">serv_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Port is Closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Port is Open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Compile:</h2>

<p>Compile using gcc:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="n">gcc</span> <span class="o">-</span><span class="n">o</span> <span class="n">test</span> <span class="n">test</span><span class="p">.</span><span class="n">c</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Execute:</h2>

<p>Execute the script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./test
</span><span class='line'>Port is Open
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The AWS CLI Cheatsheet for Bash]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/02/07/the-aws-cli-cheatsheet-for-bash/"/>
    <updated>2019-02-07T03:24:12-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/02/07/the-aws-cli-cheatsheet-for-bash</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/30043398/52399083-cdb9b580-2ac3-11e9-8c8a-79fcb811de18.png" alt="" /></p>

<p>This is a post for all the AWS CLI oneliners that I stumble upon. Note that they will be updated over time.</p>

<h2>RDS</h2>

<p>Describe All RDS DB Instances:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile prod rds describe-db-instances --query <span class="s1">&#39;DBInstances[*].[DBInstanceArn,DBInstanceIdentifier,DBInstanceClass,Endpoint]&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Describe a RDS DB Instance with a dbname:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile prod rds describe-db-instances --query <span class="s1">&#39;DBInstances[?DBInstanceIdentifier==`db-staging`].[DBInstanceArn,DBInstanceIdentifier,DBInstanceClass,Endpoint]&#39;</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span>
</span><span class='line'>        <span class="s2">&quot;arn:aws:rds:eu-west-1:&lt;customer_id&gt;:db:db-staging&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;db-staging&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;db.t2.micro&quot;</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;HostedZoneId&quot;</span>: <span class="s2">&quot;ASKDJSAKDJBA&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Port&quot;</span>: 5432,
</span><span class='line'>            <span class="s2">&quot;Address&quot;</span>: <span class="s2">&quot;db-staging.asdkjahsd.eu-west-1.rds.amazonaws.com&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>List all RDS DB Instances and limit output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile prod rds describe-db-instances --query <span class="s1">&#39;DBInstances[*].[DBInstanceArn,DBInstanceIdentifier,DBInstanceClass,Endpoint]&#39;</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span>
</span><span class='line'>        <span class="s2">&quot;arn:aws:rds:eu-west-1:&lt;customer_id&gt;:db:db-name&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;db-name&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;db.t2.micro&quot;</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;HostedZoneId&quot;</span>: <span class="s2">&quot;ABCDEFGHILKL&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Port&quot;</span>: 5432,
</span><span class='line'>            <span class="s2">&quot;Address&quot;</span>: <span class="s2">&quot;db-name.abcdefg.eu-west-1.rds.amazonaws.com&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>,
</span></code></pre></td></tr></table></div></figure>


<p>List all RDS DB Instances that has backups enabled, and limit output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile prod rds describe-db-instances --query <span class="s1">&#39;DBInstances[?BackupRetentionPeriod&gt;`0`].[DBInstanceArn,DBInstanceIdentifier,DBInstanceClass,Endpoint]&#39;</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span>
</span><span class='line'>        <span class="s2">&quot;arn:aws:rds:eu-west-1:&lt;customer_id&gt;:db:db-name&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;db-name&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;db.t2.micro&quot;</span>,
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;HostedZoneId&quot;</span>: <span class="s2">&quot;ABCDEFGHILKL&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Port&quot;</span>: 5432,
</span><span class='line'>            <span class="s2">&quot;Address&quot;</span>: <span class="s2">&quot;db-name.abcdefg.eu-west-1.rds.amazonaws.com&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>,
</span></code></pre></td></tr></table></div></figure>


<p>Describe DB Snapshots for DB Instance Name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile prod rds describe-db-snapshots --db-instance-identifier db --query <span class="s1">&#39;DBSnapshots[?DBInstanceIdentifier==`db`].[DBInstanceIdentifier,DBSnapshotIdentifier,SnapshotCreateTime,Status]&#39;</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">[</span>
</span><span class='line'>        <span class="s2">&quot;db&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;rds:db-2018-05-16-04-08&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;2018-05-16T04:08:53.696Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;available&quot;</span>
</span><span class='line'>    <span class="o">]</span>,
</span></code></pre></td></tr></table></div></figure>


<p>Events for the last 24 Hours:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile prod rds describe-events --source-identifier <span class="s2">&quot;rds:db-2018-05-16-04-08&quot;</span> --source-type db-snapshot --duration <span class="m">1440</span> --query <span class="s1">&#39;Events[*]&#39;</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;EventCategories&quot;</span>: <span class="o">[</span>
</span><span class='line'>            <span class="s2">&quot;creation&quot;</span>
</span><span class='line'>        <span class="o">]</span>,
</span><span class='line'>        <span class="s2">&quot;SourceType&quot;</span>: <span class="s2">&quot;db-snapshot&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;SourceArn&quot;</span>: <span class="s2">&quot;arn:aws:rds:eu-west-1:&lt;customer_id&gt;:snapshot:rds:db-2018-05-16-04-08&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Date&quot;</span>: <span class="s2">&quot;2018-05-16T04:08:40.264Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Message&quot;</span>: <span class="s2">&quot;Creating automated snapshot&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;SourceIdentifier&quot;</span>: <span class="s2">&quot;rds:db-2018-05-16-04-08&quot;</span>
</span><span class='line'>    <span class="o">}</span>,
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;EventCategories&quot;</span>: <span class="o">[</span>
</span><span class='line'>            <span class="s2">&quot;creation&quot;</span>
</span><span class='line'>        <span class="o">]</span>,
</span><span class='line'>        <span class="s2">&quot;SourceType&quot;</span>: <span class="s2">&quot;db-snapshot&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;SourceArn&quot;</span>: <span class="s2">&quot;arn:aws:rds:eu-west-1:&lt;customer_id&gt;:snapshot:rds:db-2018-05-16-04-08&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Date&quot;</span>: <span class="s2">&quot;2018-05-16T04:32:04.047Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Message&quot;</span>: <span class="s2">&quot;Automated snapshot created&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;SourceIdentifier&quot;</span>: <span class="s2">&quot;rds:db-2018-05-16-04-08&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>List Public RDS Instances:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile prod rds describe-db-instances --query <span class="s1">&#39;DBInstances[?PubliclyAccessible==`true`].[DBInstanceIdentifier,Endpoint.Address]&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">[</span>
</span><span class='line'>    <span class="s2">&quot;name&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;name.abcdef.eu-west-1.rds.amazonaws.com&quot;</span>
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>SSM Parameter Store:</h2>

<p>List all parameters by path:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile prod ssm get-parameters-by-path --path <span class="s1">&#39;/service-a/team-a/my-app-name/&#39;</span> <span class="p">|</span> jq <span class="s1">&#39;.Parameters[]&#39;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.Name&#39;</span>
</span><span class='line'>/service-a/team-a/my-app-name/db_hostname
</span><span class='line'>/service-a/team-a/my-app-name/db_username
</span><span class='line'>/service-a/team-a/my-app-name/db_password
</span></code></pre></td></tr></table></div></figure>


<p>Get a value from a parameter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile prod ssm get-parameters --names <span class="s1">&#39;/service-a/team-a/my-app-name/db_username&#39;</span> --with-decryption <span class="p">|</span> jq <span class="s1">&#39;.Parameters[]&#39;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.Value&#39;</span>
</span><span class='line'>my_db_user
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python Multiprocessing Tutorial]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/02/05/python-multiprocessing-tutorial/"/>
    <updated>2019-02-05T10:05:49-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/02/05/python-multiprocessing-tutorial</id>
    <content type="html"><![CDATA[<p>I stumbled apon a great <a href="https://tutorialedge.net/python/python-multiprocessing-tutorial/">python multiprocessing tutorial</a>, when I was looking into spawning multiple processes in parallel on a Lambda function.</p>

<p>In this example im getting latencies between regions using tcpping, but instead of running them one at a time, I was looking into spawning them in parralel:</p>

<p>(code made static for demonstration)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
</span><span class='line'>
</span><span class='line'><span class="n">region_maps</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&#39;eu-west-1&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;dynamodb&#39;</span><span class="p">:</span> <span class="s">&#39;dynamodb.eu-west-1.amazonaws.com&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&#39;us-east-1&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;dynamodb&#39;</span><span class="p">:</span> <span class="s">&#39;dynamodb.us-east-1.amazonaws.com&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&#39;us-west-1&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;dynamodb&#39;</span><span class="p">:</span> <span class="s">&#39;dynamodb.us-west-1.amazonaws.com&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&#39;us-west-2&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;dynamodb&#39;</span><span class="p">:</span> <span class="s">&#39;dynamodb.us-west-2.amazonaws.com&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="n">target_region</span><span class="p">,</span> <span class="n">target_service</span><span class="p">,</span> <span class="n">target_endpoint</span><span class="p">):</span>
</span><span class='line'>    <span class="n">static_results</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;address&quot;</span><span class="p">:</span> <span class="n">target_endpoint</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;attempts&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;avg&quot;</span><span class="p">:</span> <span class="mf">481.80199999999996</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;max&quot;</span><span class="p">:</span> <span class="mf">816.25</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;min&quot;</span><span class="p">:</span> <span class="mf">312.46</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;port&quot;</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;region&quot;</span><span class="p">:</span> <span class="s">&quot;eu-west-1_{}_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_service</span><span class="p">,</span> <span class="n">target_region</span><span class="p">),</span>
</span><span class='line'>        <span class="s">&quot;regionTo&quot;</span><span class="p">:</span> <span class="n">target_region</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">:</span> <span class="s">&quot;816.25&quot;</span><span class="p">},</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">:</span> <span class="s">&quot;331.50&quot;</span><span class="p">},</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">:</span> <span class="s">&quot;597.22&quot;</span><span class="p">},</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">:</span> <span class="s">&quot;312.46&quot;</span><span class="p">},</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span><span class="s">&quot;time&quot;</span><span class="p">:</span> <span class="s">&quot;351.58&quot;</span><span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="s">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s">&quot;2019-02-05T17:10:32&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">static_results</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">dynamodb_write</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">ddb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;mydynamotable&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ddb_parsed</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">parse_float</span><span class="o">=</span><span class="n">Decimal</span><span class="p">)</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">ddb_parsed</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">spawn_work</span><span class="p">(</span><span class="n">region</span><span class="p">):</span>
</span><span class='line'>    <span class="n">target_region</span> <span class="o">=</span> <span class="n">region</span>
</span><span class='line'>    <span class="n">target_service</span> <span class="o">=</span> <span class="s">&#39;dynamodb&#39;</span>
</span><span class='line'>    <span class="n">target_endpoint</span> <span class="o">=</span> <span class="n">region_maps</span><span class="p">[</span><span class="n">target_region</span><span class="p">][</span><span class="n">target_service</span><span class="p">]</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="n">get_results</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">target_service</span><span class="p">,</span> <span class="n">target_endpoint</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;pid: {}, data: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">data</span><span class="p">))</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">dynamodb_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">pool</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">spawn_work</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="s">&#39;us-east-1&#39;</span><span class="p">,</span> <span class="s">&#39;us-west-1&#39;</span><span class="p">,</span> <span class="s">&#39;us-west-2&#39;</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>When running it locally, I can see that each job ran in its own pid:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python foo.py
</span><span class='line'>pid: 31224, data: <span class="o">{</span><span class="s1">&#39;attempts&#39;</span>: 5, <span class="s1">&#39;min&#39;</span>: 312.46, <span class="s1">&#39;timestamp&#39;</span>: <span class="s1">&#39;2019-02-05T17:10:32&#39;</span>, <span class="s1">&#39;address&#39;</span>: <span class="s1">&#39;dynamodb.eu-west-1.amazonaws.com&#39;</span>, <span class="s1">&#39;max&#39;</span>: 816.25, <span class="s1">&#39;region&#39;</span>: <span class="s1">&#39;eu-west-1_dynamodb_eu-west-1&#39;</span>, <span class="s1">&#39;avg&#39;</span>: 481.80199999999996, <span class="s1">&#39;port&#39;</span>: 443, <span class="s1">&#39;regionTo&#39;</span>: <span class="s1">&#39;eu-west-1&#39;</span>, <span class="s1">&#39;results&#39;</span>: <span class="o">[{</span><span class="s1">&#39;seq&#39;</span>: 1, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;816.25&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 2, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;331.50&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 3, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;597.22&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 4, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;312.46&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 5, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;351.58&#39;</span><span class="o">}]}</span>
</span><span class='line'>
</span><span class='line'>pid: 31225, data: <span class="o">{</span><span class="s1">&#39;attempts&#39;</span>: 5, <span class="s1">&#39;min&#39;</span>: 312.46, <span class="s1">&#39;timestamp&#39;</span>: <span class="s1">&#39;2019-02-05T17:10:32&#39;</span>, <span class="s1">&#39;address&#39;</span>: <span class="s1">&#39;dynamodb.us-east-1.amazonaws.com&#39;</span>, <span class="s1">&#39;max&#39;</span>: 816.25, <span class="s1">&#39;region&#39;</span>: <span class="s1">&#39;eu-west-1_dynamodb_us-east-1&#39;</span>, <span class="s1">&#39;avg&#39;</span>: 481.80199999999996, <span class="s1">&#39;port&#39;</span>: 443, <span class="s1">&#39;regionTo&#39;</span>: <span class="s1">&#39;us-east-1&#39;</span>, <span class="s1">&#39;results&#39;</span>: <span class="o">[{</span><span class="s1">&#39;seq&#39;</span>: 1, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;816.25&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 2, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;331.50&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 3, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;597.22&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 4, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;312.46&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 5, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;351.58&#39;</span><span class="o">}]}</span>
</span><span class='line'>
</span><span class='line'>pid: 31226, data: <span class="o">{</span><span class="s1">&#39;attempts&#39;</span>: 5, <span class="s1">&#39;min&#39;</span>: 312.46, <span class="s1">&#39;timestamp&#39;</span>: <span class="s1">&#39;2019-02-05T17:10:32&#39;</span>, <span class="s1">&#39;address&#39;</span>: <span class="s1">&#39;dynamodb.us-west-1.amazonaws.com&#39;</span>, <span class="s1">&#39;max&#39;</span>: 816.25, <span class="s1">&#39;region&#39;</span>: <span class="s1">&#39;eu-west-1_dynamodb_us-west-1&#39;</span>, <span class="s1">&#39;avg&#39;</span>: 481.80199999999996, <span class="s1">&#39;port&#39;</span>: 443, <span class="s1">&#39;regionTo&#39;</span>: <span class="s1">&#39;us-west-1&#39;</span>, <span class="s1">&#39;results&#39;</span>: <span class="o">[{</span><span class="s1">&#39;seq&#39;</span>: 1, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;816.25&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 2, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;331.50&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 3, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;597.22&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 4, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;312.46&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 5, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;351.58&#39;</span><span class="o">}]}</span>
</span><span class='line'>
</span><span class='line'>pid: 31227, data: <span class="o">{</span><span class="s1">&#39;attempts&#39;</span>: 5, <span class="s1">&#39;min&#39;</span>: 312.46, <span class="s1">&#39;timestamp&#39;</span>: <span class="s1">&#39;2019-02-05T17:10:32&#39;</span>, <span class="s1">&#39;address&#39;</span>: <span class="s1">&#39;dynamodb.us-west-2.amazonaws.com&#39;</span>, <span class="s1">&#39;max&#39;</span>: 816.25, <span class="s1">&#39;region&#39;</span>: <span class="s1">&#39;eu-west-1_dynamodb_us-west-2&#39;</span>, <span class="s1">&#39;avg&#39;</span>: 481.80199999999996, <span class="s1">&#39;port&#39;</span>: 443, <span class="s1">&#39;regionTo&#39;</span>: <span class="s1">&#39;us-west-2&#39;</span>, <span class="s1">&#39;results&#39;</span>: <span class="o">[{</span><span class="s1">&#39;seq&#39;</span>: 1, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;816.25&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 2, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;331.50&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 3, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;597.22&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 4, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;312.46&#39;</span><span class="o">}</span>, <span class="o">{</span><span class="s1">&#39;seq&#39;</span>: 5, <span class="s1">&#39;time&#39;</span>: <span class="s1">&#39;351.58&#39;</span><span class="o">}]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Quite useful! Have a look at the link shared for more examples.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Convert Float to Decimal Data Types for Boto3 DynamoDB Using Python]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/02/05/convert-float-to-decimal-data-types-for-boto3-dynamodb-using-python/"/>
    <updated>2019-02-05T09:45:40-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/02/05/convert-float-to-decimal-data-types-for-boto3-dynamodb-using-python</id>
    <content type="html"><![CDATA[<p>A quick post on a workaround when you need to convert float to decimal types.</p>

<p>One thing I really don&rsquo;t like about the AWS SDK for Python, specifically aimed towards DynamoDB is that Float types are not supported and that you should use Decimal types instead.</p>

<p>For example, my payload below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">data</span>
</span><span class='line'><span class="p">{</span><span class="s">&#39;attempts&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;min&#39;</span><span class="p">:</span> <span class="mf">180.87</span><span class="p">,</span> <span class="s">&#39;timestamp&#39;</span><span class="p">:</span> <span class="s">&#39;2019-02-05T15:48:27&#39;</span><span class="p">,</span> <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">&#39;dynamodb.us-east-1.amazonaws.com&#39;</span><span class="p">,</span> <span class="s">&#39;max&#39;</span><span class="p">:</span> <span class="mf">747.17</span><span class="p">,</span> <span class="s">&#39;region&#39;</span><span class="p">:</span> <span class="s">&#39;eu-west-1_dynamodb&#39;</span><span class="p">,</span> <span class="s">&#39;avg&#39;</span><span class="p">:</span> <span class="mf">311.32599999999996</span><span class="p">,</span> <span class="s">&#39;port&#39;</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span> <span class="s">&#39;regionTo&#39;</span><span class="p">:</span> <span class="s">&#39;us-east-1&#39;</span><span class="p">,</span> <span class="s">&#39;results&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s">&#39;seq&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;747.17&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;seq&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;215.60&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;seq&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;230.67&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;seq&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;180.87&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;seq&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;time&#39;</span><span class="p">:</span> <span class="s">&#39;182.32&#39;</span><span class="p">}]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Trying to write that as an Item to my DynamoDB table and you will be faced with the exception below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">ddb</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'><span class="ne">TypeError</span><span class="p">:</span> <span class="n">Float</span> <span class="n">types</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">supported</span><span class="o">.</span> <span class="n">Use</span> <span class="n">Decimal</span> <span class="n">types</span> <span class="n">instead</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>One way around this is to use <code>parse_float</code> in <code>json.loads()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">ddb_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">parse_float</span><span class="o">=</span><span class="n">Decimal</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">ddb_data</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;max&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;747.17&#39;</span><span class="p">),</span> <span class="s">u&#39;min&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;180.87&#39;</span><span class="p">),</span> <span class="s">u&#39;timestamp&#39;</span><span class="p">:</span> <span class="s">u&#39;2019-02-05T15:48:27&#39;</span><span class="p">,</span> <span class="s">u&#39;region&#39;</span><span class="p">:</span> <span class="s">u&#39;eu-west-1_dynamodb&#39;</span><span class="p">,</span> <span class="s">u&#39;regionTo&#39;</span><span class="p">:</span> <span class="s">u&#39;us-east-1&#39;</span><span class="p">,</span> <span class="s">u&#39;results&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s">u&#39;seq&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">u&#39;time&#39;</span><span class="p">:</span> <span class="s">u&#39;747.17&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">u&#39;seq&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">u&#39;time&#39;</span><span class="p">:</span> <span class="s">u&#39;215.60&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">u&#39;seq&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">u&#39;time&#39;</span><span class="p">:</span> <span class="s">u&#39;230.67&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">u&#39;seq&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">u&#39;time&#39;</span><span class="p">:</span> <span class="s">u&#39;180.87&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">u&#39;seq&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">u&#39;time&#39;</span><span class="p">:</span> <span class="s">u&#39;182.32&#39;</span><span class="p">}],</span> <span class="s">u&#39;attempts&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">u&#39;address&#39;</span><span class="p">:</span> <span class="s">u&#39;dynamodb.us-east-1.amazonaws.com&#39;</span><span class="p">,</span> <span class="s">u&#39;avg&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;311.32599999999996&#39;</span><span class="p">),</span> <span class="s">u&#39;port&#39;</span><span class="p">:</span> <span class="mi">443</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Paginate Through IAM Users on AWS Using Python and Boto3]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/01/29/paginate-through-iam-users-on-aws-using-python-and-boto3/"/>
    <updated>2019-01-29T10:03:24-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/01/29/paginate-through-iam-users-on-aws-using-python-and-boto3</id>
    <content type="html"><![CDATA[<p>When listing AWS IAM Users in Boto3, you will find that not all the users are retrieved. This is because they are paginated.</p>

<p>To do a normal list_users api call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">iam</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;iam&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">iam</span><span class="o">.</span><span class="n">list_users</span><span class="p">()[</span><span class="s">&#39;Users&#39;</span><span class="p">])</span>
</span><span class='line'><span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>


<p>Although I know there&rsquo;s more than 200 users. Therefore we need to paginate through our users:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">iam</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;iam&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">paginator</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s">&#39;list_users&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">all_users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;Users&#39;</span><span class="p">])</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
</span><span class='line'><span class="mi">3</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">)):</span>
</span><span class='line'><span class="o">...</span>     <span class="k">for</span> <span class="n">userobj</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">iteration</span><span class="p">])):</span>
</span><span class='line'><span class="o">...</span>         <span class="n">all_users</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">users</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">userobj</span><span class="p">][</span><span class="s">&#39;UserName&#39;</span><span class="p">]))</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_users</span><span class="p">)</span>
</span><span class='line'><span class="mi">210</span>
</span></code></pre></td></tr></table></div></figure>


<p>For more information on this, have a look at AWS Documentation about <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/paginators.html">Pagination</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a 3 Node Docker Swarm Cluster on Ubuntu 16.04]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/01/10/setup-a-3-node-docker-swarm-cluster-on-ubuntu-16-dot-04/"/>
    <updated>2019-01-10T09:52:07-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/01/10/setup-a-3-node-docker-swarm-cluster-on-ubuntu-16-dot-04</id>
    <content type="html"><![CDATA[<p><img src="http://obj-cache.cloud.ruanbekker.com/docker-logo.png" alt="" /></p>

<p>Docker Swarm is a Clustering and Orchestration Framework for the Docker ecosystem. Have a look at their <a href="https://docs.docker.com/engine/swarm/">official documentation</a> for detailed information.</p>

<p>In this Tutorial we will Setup a 3 Node Docker Swarm Cluster and to Demonstrate How Easy it is to Deploy a Web Application with 2 Replicas from a Docker Image.</p>

<p><br></p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>


<p><br></p>

<h2>Overview of What we will be Doing</h2>

<ul>
<li>Install Docker on 3 Servers with Ubuntu 16.04</li>
<li>Initialize the Swarm and Join the Worker Nodes</li>
<li>Create a Nginx Service with 2 Replicas</li>
<li>Do some Inspection: View some info on the Service</li>
</ul>


<h2>Prerequisites</h2>

<p>3 Fresh Deployed Ubuntu 16.04 Servers. ( 1GB Memory Servers will be good for development )</p>

<h2>What is Docker</h2>

<p>Docker is a Open Source Technology that allows you to create lightweight, isolated, reproducible application instances which is called Containers. Docker is built on top of the LXC technology, so it uses Linux Containers and as mentioned, it&rsquo;s lightweight compared to a traditional VM.</p>

<p>A Container is isolated and uses the Kernel of the Docker host, it also utilizes Kernel features such as cgroups and namespaces in order to make them isolated.</p>

<h2>Installing Docker Community Edition</h2>

<p>Remove any older versions of Docker that might be present and install the dependencies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt remove docker docker-engine -y
</span><span class='line'><span class="nv">$ </span>sudo apt install linux-image-extra-<span class="k">$(</span>uname -r<span class="k">)</span> linux-image-extra-virtual python-setuptools -y
</span><span class='line'><span class="nv">$ </span>sudo apt install apt-transport-https ca-certificates curl software-properties-common -y
</span></code></pre></td></tr></table></div></figure>


<p>Get the needed repository to setup Docker Community Edition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> sudo apt-key add -
</span><span class='line'><span class="nv">$ </span>sudo apt-key fingerprint 0EBFCD88
</span><span class='line'><span class="nv">$ </span>sudo add-apt-repository <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update the repository index and Install Docker Community Edition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update
</span><span class='line'><span class="nv">$ </span>sudo apt install docker-ce -y
</span><span class='line'><span class="nv">$ </span>sudo easy_install pip
</span><span class='line'><span class="nv">$ </span>sudo pip install docker-compose
</span></code></pre></td></tr></table></div></figure>


<p>Enable Docker on Startup and Start the Docker Engine:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>docker
</span><span class='line'><span class="nv">$ </span>sudo systemctl restart docker
</span></code></pre></td></tr></table></div></figure>


<p>If you would like to execute your docker commands without sudo, add your user to the docker group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo usermod -aG docker <span class="k">$(</span>whoami<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Test your Setup by Running a Hello World Container. You will see that if the image is not in the local docker image cache, it will pull the image from docker hub (or the respective docker registry), then once the image is saved locally, docker will then instantiate the container from that image:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run hello-world
</span><span class='line'>Unable to find image <span class="s1">&#39;hello-world:latest&#39;</span> locally
</span><span class='line'>latest: Pulling from library/hello-world
</span><span class='line'>78445dd45222: Pull <span class="nb">complete</span>
</span><span class='line'>Digest: sha256:c5515758d4c5e1e838e9cd307f6c6a0d620b5e07e6f927b07d05f6d12a1ac8d7
</span><span class='line'>Status: Downloaded newer image <span class="k">for</span> hello-world:latest
</span><span class='line'>
</span><span class='line'>Hello from Docker!
</span><span class='line'>This message shows that your installation appears to be working correctly.
</span></code></pre></td></tr></table></div></figure>


<h2>DNS Configuration</h2>

<p>If you have a DNS Server you can configure the A Records for these hosts on DNS, but for simplicity, I will add the noted IP Addresses from the previous step into my <code>/etc/hosts</code> file so we can resolve names to IP&rsquo;s</p>

<p>Open up the the hosts file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo vim /etc/hosts
</span></code></pre></td></tr></table></div></figure>


<p>In my example, my IP Addresses:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>192.0.2.41  manager
</span><span class='line'>192.0.2.42  worker-1
</span><span class='line'>192.0.2.43  worker-2
</span></code></pre></td></tr></table></div></figure>


<p>Repeat the above steps on the other 2 Servers and make note of the IP Addresses of each node. You should be able to ping and reach the nodes that was configured. Make sure to allow all traffic between these nodes.</p>

<h2>Initialize the Swarm:</h2>

<p>Now we will initialize the swarm on the manager node and as we have more than one network interface, we will specify the &ndash;advertise-addr option:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker swarm init --advertise-addr 192.0.2.41
</span><span class='line'>Swarm initialized: current node <span class="o">(</span>siqyf3yricsvjkzvej00a9b8h<span class="o">)</span> is now a manager.
</span><span class='line'>
</span><span class='line'>    To add a worker to this swarm, run the following <span class="nb">command</span>:
</span><span class='line'>
</span><span class='line'>    docker swarm join <span class="se">\</span>
</span><span class='line'>    --token SWMTKN-1-0eith07xkcg93lzftuhjmxaxwfa6mbkjsmjzb3d3sx9cobc2zp-97s6xzdt27y2gk3kpm0cgo6y2 <span class="se">\</span>
</span><span class='line'>    192.0.2.41:2377
</span><span class='line'>
</span><span class='line'>    To add a manager to this swarm, run <span class="s1">&#39;docker swarm join-token manager&#39;</span> and follow the instructions.
</span></code></pre></td></tr></table></div></figure>


<p>From the response above, we received the join token that allows the workers to register with the manager node. If its a scenario where you want to have more than one manager node, you can run <code>docker swarm join-token manager</code> to receive the join token for additional manager.</p>

<p>Let&rsquo;s add the two worker nodes to the manager:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="o">[</span>worker-1<span class="o">]</span> docker swarm join --token SWMTKN-1-0eith07xkcg93lzftuhjmxaxwfa6mbkjsmjzb3d3sx9cobc2zp-97s6xzdt27y2gk3kpm0cgo6y2 192.0.2.41:2377
</span><span class='line'>This node joined a swarm as a worker.
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="o">[</span>worker-2<span class="o">]</span> docker swarm join --token SWMTKN-1-0eith07xkcg93lzftuhjmxaxwfa6mbkjsmjzb3d3sx9cobc2zp-97s6xzdt27y2gk3kpm0cgo6y2 192.0.2.41:2377
</span><span class='line'>This node joined a swarm as a worker.
</span></code></pre></td></tr></table></div></figure>


<p>To see the node status, so that we can determine if the nodes are active/available etc, from the manager node, list all the nodes in the swarm:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>manager<span class="o">]</span> <span class="nv">$ </span>docker node ls
</span><span class='line'>ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS
</span><span class='line'>j14mte3v1jhtbm3pb2qrpgwp6    worker-1  Ready   Active
</span><span class='line'>siqyf3yricsvjkzvej00a9b8h *  master    Ready   Active        Leader
</span><span class='line'>srl5yzme5hxnzxal2t1efmwje    worker-2  Ready   Active
</span></code></pre></td></tr></table></div></figure>


<h2>Reobtaining the Join Tokens</h2>

<p>If at any time, you lost your join token, it can be retrieved by running the following for the manager token:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker swarm join-token manager -q SWMTKN-1-67chzvi4epx28ii18gizcia8idfar5hokojz660igeavnrltf0-09ijujbnnh4v960b8xel58pmj
</span></code></pre></td></tr></table></div></figure>


<p>And the following to retrieve the worker token:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker swarm join-token worker -q SWMTKN-1-67chzvi4epx28ii18gizcia8idfar5hokojz660igeavnrltf0-acs21nn28v17uwhw0oqg5ibwx
</span></code></pre></td></tr></table></div></figure>


<p>Swarm Services in Docker uses a declarative model which means that you define the desired state of the service, and rely on Docker to maintain this state. More information on this can be found on their <a href="https://docs.docker.com/engine/swarm/how-swarm-mode-works/services/">Documentation</a></p>

<p>At this moment, we will see that we have no services running in our swarm:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>manager<span class="o">]</span> <span class="nv">$ </span>docker service ls
</span><span class='line'>ID  NAME  MODE  REPLICAS  IMAGE
</span></code></pre></td></tr></table></div></figure>


<h2>Deploying our First Service</h2>

<p>Now onto the creation of a standard nginx service with 2 replicas, which means that there will be 2 containers of nginx running in our swarm.</p>

<p>But first, we need to create a overlay network, which is a network driver that creates a distributed network among multiple Docker daemon hosts. Swarm takes care of the routing automatically, which is routed via the port mappings. So you can have that your container sits on worker-2, when you hit your manager node on the published port, it will route the request to the desired application that resides on the respective container.</p>

<p>To create a overlay network called mynet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>manager<span class="o">]</span> <span class="nv">$ </span>docker network create --driver overlay mynet
</span></code></pre></td></tr></table></div></figure>


<p>Now onto creating the Service. If any of these containers fail, they will handled by the manager node and will be spawned again to have the desired number that we set on the replica option:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>manager<span class="o">]</span> <span class="nv">$ </span>docker service create --name my-web --publish 8080:80 --replicas <span class="m">2</span> --network mynet nginx
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s have a look at our nginx service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>manager<span class="o">]</span> <span class="nv">$ </span>docker service ls
</span><span class='line'>ID            NAME    MODE        REPLICAS  IMAGE
</span><span class='line'>1okycpshfusq  my-web  replicated  2/2       nginx:latest
</span></code></pre></td></tr></table></div></figure>


<p>After we see that the replica count is 2/2 our service is ready.</p>

<p>To see on which nodes our containers are running that makes up our service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>manager<span class="o">]</span> <span class="nv">$ </span>docker service ps my-web
</span><span class='line'>ID            NAME      IMAGE         NODE      DESIRED STATE  CURRENT STATE           ERROR  PORTS
</span><span class='line'>k0qqrh8s0c2d  my-web.1  nginx:latest  worker-1  Running        Running <span class="m">30</span> seconds ago
</span><span class='line'>nku9wer6tmll  my-web.2  nginx:latest  worker-2  Running        Running <span class="m">30</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>From the above output, we can see that worker-1 and worker-2 are serving our containers for our service. We can also retrieve more information of our service by using the inspect option, which will give you a detailed response in json format of the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>manager<span class="o">]</span> <span class="nv">$ </span>docker service inspect my-web
</span></code></pre></td></tr></table></div></figure>


<p>We can get the Endpoint Port info by using inspect and using the &ndash;format parameter to filter the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>manager<span class="o">]</span> <span class="nv">$ </span>docker service inspect --format<span class="o">=</span><span class="s2">&quot;&quot;</span> my-web  <span class="p">|</span> python -m json.tool
</span></code></pre></td></tr></table></div></figure>


<p>From the output we will find the PublishedPort is the Port that we Expose, which will be the listener. Our TargetPort will be the port that is listening on the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;tcp&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;PublishMode&quot;</span><span class="p">:</span> <span class="s2">&quot;ingress&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;PublishedPort&quot;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;TargetPort&quot;</span><span class="p">:</span> <span class="mi">80</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we went through the inspection of our service, its time to test our base nginx service.</p>

<h2>Testing Nginx in our Swarm</h2>

<p>Make a request against your docker node manager address on the port that was exposed, in this case 8080:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -I http://docker-node-manager-ip:8080
</span><span class='line'>
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.15.5
</span><span class='line'>Date: Thu, <span class="m">10</span> Jan <span class="m">2019</span> 14:48:40 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 612
</span><span class='line'>Last-Modified: Tue, <span class="m">02</span> Oct <span class="m">2018</span> 14:49:27 GMT
</span><span class='line'>Connection: keep-alive
</span><span class='line'>ETag: <span class="s2">&quot;5bb38577-264&quot;</span>
</span><span class='line'>Accept-Ranges: bytes
</span></code></pre></td></tr></table></div></figure>


<p>Now we have successfull setup a 3 node docker swarm cluster and deployed a basic nginx service to our swarm. Please have a look at my other <a href="https://blog.ruanbekker.com/blog/categories/docker/">Docker Swarm Tutorials</a> for other content.</p>

<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
</form>
</center>




<p><p></p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Fix Mac High Sierra Opendlrectoryd Too Many Corpses Being Created Issue]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/01/07/fix-mac-high-sierra-opendlrectoryd-too-many-corpses-being-created-issue/"/>
    <updated>2019-01-07T06:57:56-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/01/07/fix-mac-high-sierra-opendlrectoryd-too-many-corpses-being-created-issue</id>
    <content type="html"><![CDATA[<p>This morning my brother&rsquo;s iMac gave some boot issues. The resolution to the issue was to drop into a terminal, rename the mrb_cache directory and reboot.</p>

<h2>Steps to Resolution</h2>

<p>When booting, the loading bar got stuck as seen below:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50767470-9f0eac00-1285-11e9-80a6-0475bb3b97cb.png" alt="" /></p>

<p>Starting to investigate, he ran <code>cmd+s</code> to logon to single user mode, and he noticed the error: <strong>crashed: opendlrectoryd. Toomay corpses being crashed</strong>, as seen from the screenshot below:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50767477-a635ba00-1285-11e9-9086-605e06864d39.png" alt="" /></p>

<p>After some troubleshooting he had to hard reboot his mac, hit <code>cmd+r</code> repeatedly until he loaded his mac into recovery mode:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50767613-2fe58780-1286-11e9-9d5b-02b73c052d6f.png" alt="" /></p>

<p>From thereon, from the top dropdown select Utilities -> Terminal, change into the directory where the cache folder needs to be moved:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /Volumes/Macintosh\ HD/var/db/caches/opendirectory</span></code></pre></td></tr></table></div></figure>


<p>List to see if the cache directory is present:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls -la <span class="p">|</span> grep cache
</span><span class='line'>-rw-------- root wheel <span class="m">28655</span>   Jan <span class="m">3</span>    22:22 mbr_cache
</span></code></pre></td></tr></table></div></figure>


<p>Rename the cache directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mv ./mbr_cache ./mbr_cache_old
</span></code></pre></td></tr></table></div></figure>


<p>Once that is done, reboot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>reboot
</span></code></pre></td></tr></table></div></figure>


<p>If you experienced the similar issue, you should be able to see the login screen after successful boot.</p>

<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
</form>
</center>


<p><br></p>

<p>Ad space:</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>




<p><p></p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Tutorial on Using Gitlab CI/CD Pipelines to Deploy Your Python Flask Restful API With Postgres on Heroku]]></title>
    <link href="http://blog.ruanbekker.com/blog/2019/01/05/tutorial-on-using-gitlab-cicd-pipelines-to-deploy-your-python-flask-restful-api-with-postgres-on-heroku/"/>
    <updated>2019-01-05T10:27:31-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2019/01/05/tutorial-on-using-gitlab-cicd-pipelines-to-deploy-your-python-flask-restful-api-with-postgres-on-heroku</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/50217968-0629f680-0393-11e9-8387-ad69937eb891.png" alt="" /></p>

<p>Today we will build a Restful API using Python Flask, SQLAlchemy using Postgres as our Database, testing using Python Unittest, a CI/CD Pipeline on Gitlab, and Deployment to Heroku.</p>

<p>From our previous post, we demonstrated setting up a <a href="https://blog.ruanbekker.com/blog/2018/12/20/setup-a-gitlab-runner-on-your-own-server-to-run-your-jobs-that-gets-triggered-from-gitlab-ci/">Custom Gitlab Runner on Your Own Server for  Gitlab CI</a>.</p>

<h2>Heroku</h2>

<p>If you don&rsquo;t have an account already, <a href="https://dashboard.heroku.com/account">Heroku</a> offer&rsquo;s 5 free applications in their free tier account. Once you have created your account, create 2 applications. I named mine flask-api-staging and flask-api-prod.</p>

<p>You can create the applications via cli or the ui, from the ui it will look more or less like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50719120-69f53480-10a0-11e9-8720-aa3dc007b6fc.png" alt="" /></p>

<p>Select an app name and check if the name is available then select create. Note down the name and config as we will use it in our <code>.gitlab-ci.yml</code> config:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50719134-8db87a80-10a0-11e9-80f4-cccd9a86752f.png" alt="" /></p>

<h2>Heroku API Key</h2>

<p>To allow the deployment of applications to Heroku from Gitlab, we need to generate a API Key on Heroku and save the config in Gitlab.</p>

<p>Head over to your <a href="https://dashboard.heroku.com/account">Heroku Dashboard</a>, select Account Settings, scroll to the API Key section and generate a API Key.</p>

<p>Head over to your Gitlab Repository, select Settings, CI/CD, then select Variables enter the Key: HEROKU_API_KEY and the Secret of the API Key into the Value and select Save Variable.</p>

<p>We will reference this variable from our deploy steps.</p>

<h2>Heroku Postgres Add-on</h2>

<p>Heroku offers a free Postgres Add-On, to activate: Select your application, select Resources, search for the Add-on <code>Heroku Postgres</code>, select and select the Hobby Dev Free version and select provision.</p>

<h2>Our Application Code</h2>

<p>Clone your repository then let&rsquo;s start by creating our Flask API. Note this is more on Gitlab CI/CD than going into detail into the Flask Application.</p>

<p>Create the files that we will need:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>touch app.py config.cfg requirements.txt tests.py Procfile
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s start by populating our configuration for our flask app: <code>config.cfg</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#SQLALCHEMY_DATABASE_URI=&#39;sqlite:///database.db&#39;</span>
</span><span class='line'><span class="nv">SQLALCHEMY_TRACK_MODIFICATIONS</span><span class="o">=</span>False
</span></code></pre></td></tr></table></div></figure>


<p>Our Flask Application: <code>app.py</code></p>

<p>Note that we are using flask-heroku, with this package Heroku will automatically discover your configuration for your database using environment variables. So if you have a postgres add-on, you don&rsquo;t need to specify the location of your database.</p>

<p>If you want to use sqlite, you can remove the heroku instantiation and uncomment the <code>SQLALCHEMY_DATABASE_URI</code> property in your <code>config.cfg</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">flask_marshmallow</span> <span class="kn">import</span> <span class="n">Marshmallow</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">flask_heroku</span> <span class="kn">import</span> <span class="n">Heroku</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">passlib.hash</span> <span class="kn">import</span> <span class="n">sha256_crypt</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s">&#39;config.cfg&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">heroku</span> <span class="o">=</span> <span class="n">Heroku</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'><span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'><span class="n">ma</span> <span class="o">=</span> <span class="n">Marshmallow</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">## --Database Models--</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Member</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span class='line'>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;members&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
</span><span class='line'>    <span class="n">firstname</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>    <span class="n">lastname</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>    <span class="n">registered_on</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MemberSchema</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">ModelSchema</span><span class="p">):</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
</span><span class='line'>        <span class="n">model</span> <span class="o">=</span> <span class="n">Member</span>
</span><span class='line'>        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">member_schema</span> <span class="o">=</span> <span class="n">MemberSchema</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">))</span>
</span><span class='line'><span class="n">members_schema</span> <span class="o">=</span> <span class="n">MemberSchema</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c">## --Views--</span>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;ok&#39;</span><span class="p">}),</span> <span class="mi">200</span>
</span><span class='line'>
</span><span class='line'><span class="c"># list users</span>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">list_users</span><span class="p">():</span>
</span><span class='line'>    <span class="n">all_users</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">members_schema</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">all_users</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># get user</span>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/user/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">member_schema</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># add user</span>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">add_user</span><span class="p">():</span>
</span><span class='line'>    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">sha256_crypt</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">firstname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">lastname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;lastname&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">new_user</span> <span class="o">=</span> <span class="n">Member</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password_hash</span><span class="o">=</span><span class="n">password_hash</span><span class="p">,</span> <span class="n">firstname</span><span class="o">=</span><span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="n">lastname</span><span class="p">,</span> <span class="n">registered_on</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>
</span><span class='line'>        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">member_schema</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">Member</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">new_user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;member&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">})</span>
</span><span class='line'>    <span class="k">except</span><span class="p">:</span>
</span><span class='line'>        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;error&#39;</span><span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># update user</span>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/user/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;PUT&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">update_user</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
</span><span class='line'>    <span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">member_schema</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># delete user</span>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/user/&lt;int:id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;DELETE&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&#39;message&#39;</span><span class="p">:</span> <span class="s">&#39;{} has been deleted&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)})</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our tests: <code>tests.py</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">unittest</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">app</span> <span class="kn">as</span> <span class="nn">myapi</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TestFlaskApi</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">myapi</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">test_hello_world</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
</span><span class='line'>            <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">())),</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;ok&quot;</span><span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our requirements file: <code>requirements.txt</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Click</span><span class="o">==</span><span class="mf">7.0</span>
</span><span class='line'><span class="n">Flask</span><span class="o">==</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">2</span>
</span><span class='line'><span class="n">flask</span><span class="o">-</span><span class="n">heroku</span><span class="o">==</span><span class="mf">0.1</span><span class="o">.</span><span class="mi">9</span>
</span><span class='line'><span class="n">flask</span><span class="o">-</span><span class="n">marshmallow</span><span class="o">==</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">Flask</span><span class="o">-</span><span class="n">SQLAlchemy</span><span class="o">==</span><span class="mf">2.3</span><span class="o">.</span><span class="mi">2</span>
</span><span class='line'><span class="n">gunicorn</span><span class="o">==</span><span class="mf">19.9</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">itsdangerous</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">Jinja2</span><span class="o">==</span><span class="mf">2.10</span>
</span><span class='line'><span class="n">MarkupSafe</span><span class="o">==</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">marshmallow</span><span class="o">==</span><span class="mf">2.17</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">marshmallow</span><span class="o">-</span><span class="n">sqlalchemy</span><span class="o">==</span><span class="mf">0.15</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">passlib</span><span class="o">==</span><span class="mf">1.7</span><span class="o">.</span><span class="mi">1</span>
</span><span class='line'><span class="n">psycopg2</span><span class="o">-</span><span class="n">binary</span><span class="o">==</span><span class="mf">2.7</span><span class="o">.</span><span class="mf">6.1</span>
</span><span class='line'><span class="n">six</span><span class="o">==</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">SQLAlchemy</span><span class="o">==</span><span class="mf">1.2</span><span class="o">.</span><span class="mi">15</span>
</span><span class='line'><span class="n">Werkzeug</span><span class="o">==</span><span class="mf">0.14</span><span class="o">.</span><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our Procfile for Heroku: <code>Procfile</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">web</span><span class="p">:</span> <span class="n">gunicorn</span> <span class="n">app</span><span class="p">:</span><span class="n">app</span>
</span></code></pre></td></tr></table></div></figure>


<p>And lastly, our gitlab-ci configuration which will include our build, test and deploy steps. As soon as a commit to master is received the pipeline will be acticated. Note that our production deploy step is a manual trigger.</p>

<p>Our config for <code>.gitlab-ci.yml</code>. Note to replace your Heroku app names.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbekker87/build-tools:latest</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">stages</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ver</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">init</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">tests</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">deploy</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">ver</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ver</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">python --version</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">whoami</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">init</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">init</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apk add postgresql-dev --no-cache</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip install psycopg2-binary</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip install -r requirements.txt</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">run_tests</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tests</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apk add postgresql-dev --no-cache</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip install psycopg2-binary</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip install -r requirements.txt</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">python tests.py</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">deploy_staging</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">git remote add heroku https://heroku:$HEROKU_API_KEY@git.heroku.com/flask-api-staging.git</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">git push heroku master</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;Deployed to Staging Server https://flask-api-staging.herokuapp.com&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">staging</span>
</span><span class='line'>    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://flask-api-staging.herokuapp.com/</span>
</span><span class='line'>  <span class="l-Scalar-Plain">only</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">master</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">deploy_production</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deploy</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">git remote add heroku https://heroku:$HEROKU_API_KEY@git.heroku.com/flask-api-prod.git</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">git push heroku master</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;Deployed to Production Server https://flask-api-prod.herokuapp.com&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">production</span>
</span><span class='line'>    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://flask-api-prod.herokuapp.com/</span>
</span><span class='line'>  <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">manual</span>
</span><span class='line'>  <span class="l-Scalar-Plain">only</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">master</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Send to Gitlab:</h2>

<p>Once everything is populated, stage your changes, commit your work and push to master:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git add .
</span><span class='line'><span class="nv">$ </span>git commit -m <span class="s2">&quot;blogpost demo commit&quot;</span>
</span><span class='line'><span class="nv">$ </span>git push origin master
</span></code></pre></td></tr></table></div></figure>


<p>Once the code has been pushed to master, gitlab will pick it up and trigger the pipeline to run.</p>

<h2>Gitlab Pipelines</h2>

<p>Head over to Gitlab, select CI/CD -> Pipelines, you should see a running pipeline, select it, then you should see the overview of all your jobs:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50728734-83958b00-1137-11e9-8c6f-4f7d9aaab46d.png" alt="" /></p>

<p>If everything has passed you should see the <code>Passed</code> status as shown above.</p>

<p>You will notice that the staging environment has been deployed. Now you can do some testing and when you are happy with it, you can select the play button which will deploy to production on the pipelines dashboard.</p>

<h2>Creating the Tables on Postgres</h2>

<p>Before we can interact with our API, we need to provision the postgres tables from the database models that we wrote in our application.</p>

<p>Open up a Python shell on Heroku and initialize the tables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>heroku run python -a flask-api-prod
</span><span class='line'>&gt;&gt;&gt; from app import db
</span><span class='line'>&gt;&gt;&gt; db.create_all<span class="o">()</span>
</span><span class='line'>&gt;&gt;&gt; <span class="nb">exit</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing the API:</h2>

<p>Now that everything is up and running, its time to test our API.</p>

<p>List the users:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl https://flask-api-staging.herokuapp.com/api/user
</span><span class='line'><span class="o">[]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a User:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -XPOST https://flask-api-staging.herokuapp.com/api/user -d <span class="s1">&#39;{&quot;username&quot;: &quot;ruanb&quot;, &quot;password&quot;: &quot;pass&quot;, &quot;email&quot;: &quot;r@r.com&quot;, &quot;firstname&quot;: &quot;ruan&quot;, &quot;lastname&quot;: &quot;bekker&quot;}&#39;</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;member&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;id&quot;</span>: 1,
</span><span class='line'>    <span class="s2">&quot;username&quot;</span>: <span class="s2">&quot;ruanb&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>List Users:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -XGET https://flask-api-staging.herokuapp.com/api/user
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;email&quot;</span>: <span class="s2">&quot;ruan@r.com&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;id&quot;</span>: 1,
</span><span class='line'>    <span class="s2">&quot;username&quot;</span>: <span class="s2">&quot;ruanb&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update a User&rsquo;s email address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -XPUT https://flask-api-staging.herokuapp.com/api/user/1 -d <span class="s1">&#39;{&quot;username&quot;: &quot;ruanb&quot;, &quot;email&quot;: &quot;ruan@r.com&quot;}&#39;</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;id&quot;</span>: 1,
</span><span class='line'>  <span class="s2">&quot;username&quot;</span>: <span class="s2">&quot;ruanb&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Retrieve a single user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -XGET https://flask-api-staging.herokuapp.com/api/user/1
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;email&quot;</span>: <span class="s2">&quot;ruan@r.com&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;id&quot;</span>: 1,
</span><span class='line'>  <span class="s2">&quot;username&quot;</span>: <span class="s2">&quot;ruanb&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Delete User:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -XDELETE https://flask-api-staging.herokuapp.com/api/user/1
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;message&quot;</span>: <span class="s2">&quot;ruanb has been deleted&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Troubleshooting</h2>

<p>I had some issues with Heroku, where one was after I deployed, I received this error in Heroku&rsquo;s logs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">code</span><span class="o">=</span>H14 <span class="nv">desc</span><span class="o">=</span><span class="s2">&quot;No web processes running&quot;</span> <span class="nv">method</span><span class="o">=</span>GET <span class="nv">path</span><span class="o">=</span><span class="s2">&quot;/&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I just had to scale my web dyno to 1:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>heroku ps:scale <span class="nv">web</span><span class="o">=</span><span class="m">1</span> -a flask-api-staging
</span><span class='line'>Scaling dynos... <span class="k">done</span>, now running web at 1:Free
</span></code></pre></td></tr></table></div></figure>


<p>Have a look at their <a href="https://devcenter.heroku.com/articles/heroku-cli">documentation</a> if you need help with the heroku cli.</p>

<p>And to troubleshoot within the dyno, you can exec into it by running this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>heroku ps:exec -a flask-api-staging
</span></code></pre></td></tr></table></div></figure>


<p>I seriously dig Gitlab-CI and with this demonstration you can see how easy it is to setup a CI/CD Pipeline on Gitlab and Deploy them to Heroku.</p>

<h2>Resources:</h2>

<p>The code for this demo is available at: <a href="https://gitlab.com/rbekker87/demo-cicd-flask-heroku">gitlab.com/rbekker87/demo-cicd-flask-heroku</a></p>

<p>For more blog posts on Gitlab, have a look at my <a href="https://blog.ruanbekker.com/blog/categories/gitlab/">gitlab</a> category on <a href="https://blog.ruanbekker.com/">blog.ruanbekker.com</a></p>

<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
</form>
</center>


<p><br></p>

<p>Ad space:</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>




<p><p></p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a Gitlab Runner on Your Own Server to Run Your Jobs That Gets Triggered From Gitlab CI]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/12/20/setup-a-gitlab-runner-on-your-own-server-to-run-your-jobs-that-gets-triggered-from-gitlab-ci/"/>
    <updated>2018-12-20T04:21:16-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/12/20/setup-a-gitlab-runner-on-your-own-server-to-run-your-jobs-that-gets-triggered-from-gitlab-ci</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/50217968-0629f680-0393-11e9-8387-ad69937eb891.png" alt="" /></p>

<p>From our previous post, we went through the setup on setting up a <a href="https://blog.ruanbekker.com/blog/2018/12/19/setup-a-basic-ci-pipeline-on-gitlab/">Basic CI Pipeline on Gitlab</a>, in conjunction with Gitlab CI which coordinates your jobs, where we used the Shared Runners, which runs your jobs on Gitlab&rsquo;s Infrastructure.</p>

<p>In Gitlab, you have Shared Runners and your Own Runners, which is used to run your jobs and send the results back to GitLab.</p>

<p>In this tutorial we will Setup a Server with gitlab-runner and Docker on Ubuntu and then Setup a Basic Pipeline to Utilize your Gitlab Runner.</p>

<h2>Setup Docker</h2>

<p>Install Docker:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span><span class='line'><span class="nv">$ </span>sudo apt-get install apt-transport-https ca-certificates curl software-properties-common -y
</span><span class='line'><span class="nv">$ </span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class="p">|</span> sudo apt-key add -
</span><span class='line'><span class="nv">$ </span>sudo add-apt-repository <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sudo apt update
</span><span class='line'><span class="nv">$ </span>sudo apt install docker-ce -y
</span><span class='line'><span class="nv">$ </span>docker run hello-world
</span></code></pre></td></tr></table></div></figure>


<h2>Install and Setup Gitlab Runner</h2>

<p>This setup is intended for Linux 64bit, for other distributions, have a look at their <a href="https://docs.gitlab.com/runner/install/">docs</a></p>

<p>Install the Runner:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget -O /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64
</span><span class='line'><span class="nv">$ </span>chmod +x /usr/local/bin/gitlab-runner
</span><span class='line'><span class="nv">$ </span>useradd --comment <span class="s1">&#39;GitLab Runner&#39;</span> --create-home gitlab-runner --shell /bin/bash
</span><span class='line'><span class="nv">$ </span>gitlab-runner install --user<span class="o">=</span>gitlab-runner --working-directory<span class="o">=</span>/home/gitlab-runner
</span><span class='line'><span class="nv">$ </span>gitlab-runner start
</span></code></pre></td></tr></table></div></figure>


<p>Register the Runner. The Gitlab-CI Token is available in your CI/CD Settings panel from the UI: <code>https://gitlab.com/&lt;account&gt;/&lt;repo&gt;/settings/ci_cd</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gitlab-runner register
</span><span class='line'>Please enter the gitlab-ci coordinator URL <span class="o">(</span>e.g. https://gitlab.com/<span class="o">)</span>:
</span><span class='line'>https://gitlab.com/
</span><span class='line'>
</span><span class='line'>Please enter the gitlab-ci token <span class="k">for</span> this runner:
</span><span class='line'>__masked__
</span><span class='line'>
</span><span class='line'>Please enter the gitlab-ci description <span class="k">for</span> this runner:
</span><span class='line'><span class="o">[</span>my-runner<span class="o">]</span>: my-runner
</span><span class='line'>
</span><span class='line'>Please enter the gitlab-ci tags <span class="k">for</span> this runner <span class="o">(</span>comma separated<span class="o">)</span>:
</span><span class='line'>my-runner,foobar
</span><span class='line'>Registering runner... succeeded                     <span class="nv">runner</span><span class="o">=</span>66m_339h
</span><span class='line'>
</span><span class='line'>Please enter the executor: docker-ssh+machine, docker, docker-ssh, parallels, shell, ssh, virtualbox, docker+machine, kubernetes:
</span><span class='line'>docker
</span><span class='line'>
</span><span class='line'>Please enter the default Docker image <span class="o">(</span>e.g. ruby:2.1<span class="o">)</span>:
</span><span class='line'>alpine:latest
</span><span class='line'>
</span><span class='line'>Runner registered successfully. Feel free to start it, but <span class="k">if</span> it<span class="err">&#39;</span>s running already the config should be automatically reloaded!
</span></code></pre></td></tr></table></div></figure>


<p>Verify the Status and check if Docker and Gitlab Runner is enabled on startup:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gitlab-runner status
</span><span class='line'>Runtime platform                                    <span class="nv">arch</span><span class="o">=</span>amd64 <span class="nv">os</span><span class="o">=</span>linux <span class="nv">pid</span><span class="o">=</span><span class="m">30363</span> <span class="nv">revision</span><span class="o">=</span>7f00c780 <span class="nv">version</span><span class="o">=</span>11.5.1
</span><span class='line'>gitlab-runner: Service is running!
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>systemctl is-enabled gitlab-runner
</span><span class='line'>enabled
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>systemctl is-enabled docker
</span><span class='line'>enabled
</span></code></pre></td></tr></table></div></figure>


<h2>Gitlab-CI Config for Shared Runners</h2>

<p>If you would like to use the shared runners that Gitlab Offers, the <code>.gitlab-ci.yml</code> config will look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">stages</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">build</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">build</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is building&quot;</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostname</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir builds</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">touch builds/data.txt</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;true&quot; &gt; builds/data.txt</span>
</span><span class='line'>  <span class="l-Scalar-Plain">artifacts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">builds/</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is testing&quot;</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostname</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test -f builds/data.txt</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">grep &quot;true&quot; builds/data.txt</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Gitlab-CI Config for your own Gitlab Runner</h2>

<p>Gitlab utilizes the tags that was specified on registration to determine where the jobs gets executed on, for more information on this, have a look at their <a href="https://docs.gitlab.com/ce/ci/yaml/README.html#tags">docs</a></p>

<p>The <code>.gitlab-ci.yml</code> config for using your gitlab runner:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">stages</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">build</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">build</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">my-runner</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is building&quot;</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostname</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir builds</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">touch builds/data.txt</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;true&quot; &gt; builds/data.txt</span>
</span><span class='line'>  <span class="l-Scalar-Plain">artifacts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">builds/</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">my-runner</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is testing&quot;</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostname</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test -f builds/data.txt</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">grep &quot;true&quot; builds/data.txt</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Trigger and Check Docker</h2>

<p>Commit the config to master, let your pipeline run their jobs upon completion have a look at docker on your server for the containers that the jobs ran on:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker ps -a
</span><span class='line'>CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                          PORTS               NAMES
</span><span class='line'>04292a78de0b        c04b8be95e1e        <span class="s2">&quot;gitlab-runner-cache..&quot;</span>  About a minute ago   Exited <span class="o">(</span>0<span class="o">)</span> About a minute ago                       runner-xx-project-xx-concurrent-0-cache-3cxx0
</span><span class='line'>49b1b3c4adf9        c04b8be95e1e        <span class="s2">&quot;gitlab-runner-cache..&quot;</span>  About a minute ago   Exited <span class="o">(</span>0<span class="o">)</span> About a minute ago                       runner-xx-project-xx-concurrent-0-cache-6cxxa
</span><span class='line'>422b23191e8c        hello-world         <span class="s2">&quot;/hello&quot;</span>                 <span class="m">24</span> minutes ago       Exited <span class="o">(</span>0<span class="o">)</span> <span class="m">24</span> minutes ago                           wizardly_meninsky
</span></code></pre></td></tr></table></div></figure>


<p>As we know each job gets executed in different containers, you can see from the output above that there was 2 different containers for the 2 jobs that was specified in our pipeline.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://docs.gitlab.com/ee/ci/quick_start/">https://docs.gitlab.com/ee/ci/quick_start/</a></li>
<li><a href="https://docs.gitlab.com/ee/ci/runners/">https://docs.gitlab.com/ee/ci/runners/</a></li>
</ul>


<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
</form>
</center>


<p><br></p>

<p>Ad space:</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>




<p><p></p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Local Dev Environment for Wordpress Using Docker Compose]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/12/19/local-dev-environment-for-wordpress-using-docker-compose/"/>
    <updated>2018-12-19T08:33:44-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/12/19/local-dev-environment-for-wordpress-using-docker-compose</id>
    <content type="html"><![CDATA[<p>Let&rsquo;s setup a local development environment with Docker, Wordpress, MySQL using Docker Compose</p>

<h2>Docker Compose File</h2>

<p>Let&rsquo;s look at our docker-compose.yml file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.1&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">wordpress</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wordpress</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">WORDPRESS_DB_NAME=wordpress</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">WORDPRESS_DB_HOST=mysql</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">WORDPRESS_DB_USER=wordpress</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">WORDPRESS_DB_PASSWORD=wordpress</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">wordpress</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">mysql</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql:5.7</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD=password</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_DATABASE=wordpress</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_USER=wordpress</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_PASSWORD=wordpress</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">wordpress</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">wordpress</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>Environment Variables for the MySQL Docker image is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_DATABASE</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_USER, MYSQL_PASSWORD</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ALLOW_EMPTY_PASSWORD</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_RANDOM_ROOT_PASSWORD</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ONETIME_PASSWORD</span>
</span></code></pre></td></tr></table></div></figure>


<p>More info can be viewed on this resource: <a href="https://hub.docker.com/_/mysql/">hub.docker.com/_/mysql/</a></p>

<h2>Launching our Wordpress Application:</h2>

<p>Lets deploy wordpress:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-compose up
</span><span class='line'>Creating network <span class="s2">&quot;wordpress_wordpress&quot;</span> with the default driver
</span><span class='line'>Creating wordpress_mysql_1_3e6e3cfe07b1     ... <span class="k">done</span>
</span><span class='line'>Creating wordpress_wordpress_1_a9cb16f277af ... <span class="k">done</span>
</span><span class='line'>Attaching to wordpress_wordpress_1_9227f3d3e587, wordpress_mysql_1_65cc98d222d0
</span></code></pre></td></tr></table></div></figure>


<h2>Accessing Wordpress</h2>

<p>You should be able to access Wordpress on <code>http://localhost:80/</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Local Dev Environment for Mediawiki Using Docker Compose]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/12/19/local-dev-environment-for-mediawiki-using-docker-compose/"/>
    <updated>2018-12-19T08:22:36-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/12/19/local-dev-environment-for-mediawiki-using-docker-compose</id>
    <content type="html"><![CDATA[<p>Let&rsquo;s setup a local development environment with Docker, Mediawiki, MySQL using Docker Compose</p>

<h2>Docker Compose File</h2>

<p>Let&rsquo;s look at our docker-compose.yml file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.4&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">db</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql:5.6</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD=password</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_USER=mw</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_DATABASE=mediawiki</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_PASSWORD=pass</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/Users/ruan/workspace/docker/mediawiki/mediawiki-mysql-data:/var/lib/mysql</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mediawiki</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3306:3306</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">memcached</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbekker87/memcached:alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEMCACHED_USER=memcached</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEMCACHED_HOST=0.0.0.0</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEMCACHED_PORT=11211</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEMCACHED_MEMUSAGE=128</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEMCACHED_MAXCONN=1024</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mediawiki</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">mediawiki</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">benhutchins/mediawiki:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mediawiki</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_DB_TYPE=mysql</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_DB_HOST=db</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_DB_USER=mw</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_DB_PASSWORD=pass</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_SITE_SERVER=http://localhost</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_SITE_NAME=&quot;My Lekke Wiki&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_SITE_LANG=en</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_ADMIN_USER=admin</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_ADMIN_PASS=password123</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_UPDATE=true</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MEDIAWIKI_ENABLE_SSL=false</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/Users/ruan/workspace/docker/mediawiki/mediawiki-data:/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">80:80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">db</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">memcached</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">mediawiki</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>Your current working directory in this case: <code>/Users/ruan/workspace/docker/mediawiki</code></p>

<p>Environment Variables for the MySQL Docker image is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_DATABASE</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_USER, MYSQL_PASSWORD</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ALLOW_EMPTY_PASSWORD</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_RANDOM_ROOT_PASSWORD</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ONETIME_PASSWORD</span>
</span></code></pre></td></tr></table></div></figure>


<p>More info can be viewed on this resource: <a href="https://hub.docker.com/_/mysql/">hub.docker.com/_/mysql/</a></p>

<h2>Launching our Mediawiki Application:</h2>

<p>Lets deploy mediawiki:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-compose up
</span><span class='line'>Creating network <span class="s2">&quot;mediawiki_mediawiki&quot;</span> with the default driver
</span><span class='line'>Creating mediawiki_memcached_1_bbbe8d3fa8b3 ... <span class="k">done</span>
</span><span class='line'>Creating mediawiki_db_1_257775fcf65b        ... <span class="k">done</span>
</span><span class='line'>Creating mediawiki_mediawiki_1_56813d66cbe2 ... <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Accessing Mediawiki</h2>

<p>You should be able to access Mediawiki on <code>http://localhost:80/</code></p>

<h2>Resources:</h2>

<ul>
<li><a href="https://github.com/benhutchins/docker-mediawiki">https://github.com/benhutchins/docker-mediawiki</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a Basic CI Pipeline on Gitlab]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/12/19/setup-a-basic-ci-pipeline-on-gitlab/"/>
    <updated>2018-12-19T05:43:00-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/12/19/setup-a-basic-ci-pipeline-on-gitlab</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/50217968-0629f680-0393-11e9-8387-ad69937eb891.png" alt="" /></p>

<p>In this tutorial we will setup a Basic CI (Continuous Integration) Pipeline on Gitlab.</p>

<p>The code for this example is available on <a href="https://gitlab.com/rbekker87/demo-ci-basic-pipeline">gitlab.com/rbekker87/demo-ci-basic-pipeline</a>.</p>

<p>If you would like to read more on <a href="https://www.atlassian.com/continuous-delivery/continuous-integration">Continuous Integration / Continuous Deliver (CI/CD)</a>.</p>

<h2>What will we be doing?</h2>

<p>The aim for this is every time there is a commit made to the master branch, that the jobs defined by the <code>.gitlab-ci.yml</code> will be executed and will only pass if exit code 0 has been returned on the scripts.</p>

<p>The jobs gets executed on <a href="https://docs.gitlab.com/ee/ci/yaml/">gitlab runners</a> which is hosted with Giltab. Important to note is that every job runs independently from each other.</p>

<h2>Our Basic Pipeline</h2>

<p>In this pipeline we will have 2 basic jobs, each job execute a set of scripts:</p>

<p>Build:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "this is building" 
</span><span class='line'>$ hostname
</span><span class='line'>$ mkdir builds
</span><span class='line'>$ touch builds/data.txt
</span><span class='line'>$ echo "true" &gt; builds/data.txt</span></code></pre></td></tr></table></div></figure>


<p>Test:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "this is testing"
</span><span class='line'>$ hostname
</span><span class='line'>$ test -f builds/data.txt
</span><span class='line'>$ grep "true" builds/data.txt</span></code></pre></td></tr></table></div></figure>


<h2>Setup the Pipeline:</h2>

<p>From a newly created repository which i&rsquo;ve cloned to my workspace, create the config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ touch .gitlab-ci.yml</span></code></pre></td></tr></table></div></figure>


<p>The config for above yaml file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">stages</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">build</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">build</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is building&quot;</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostname</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir builds</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">touch builds/data.txt</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;false&quot; &gt; builds/data.txt</span>
</span><span class='line'>  <span class="l-Scalar-Plain">artifacts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">builds/</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is testing&quot;</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostname</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test -f builds/data.txt</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">grep &quot;true&quot; builds/data.txt</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Config Explained</h2>

<ul>
<li>We define 2 stages for this pipeline: build and test</li>
<li>We provide context of each job, the stage, the script (commands that will be executed in the lifecycle of the runner) and artifacts (artifacts will be the content that will be transferred, as each job runs in a different runner/container)</li>
</ul>


<p>Note that I deliberately made a mistake so that my pipeline can fail. I populated the content &ldquo;false&rdquo; into the <code>builds/data.txt</code> file from the build job and grep for the word &ldquo;true&rdquo; on the test job, so this job will fail.</p>

<h2>Push to Github</h2>

<p>Save the content to the config file, add, commit and push to master:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git add .gitlab-ci.yml
</span><span class='line'><span class="nv">$ </span>git commit -m <span class="s2">&quot;add gitlab-ci config&quot;</span>
</span><span class='line'><span class="nv">$ </span>git push origin master
</span></code></pre></td></tr></table></div></figure>


<h2>Gitlab Pipelines</h2>

<p>From the Gitlab UI, if you head over to CI/CD -> Pipelines, you should see your pipeline running:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50216548-c103c580-038e-11e9-959b-ffdcf6038305.png" alt="" /></p>

<p>When you select the Pipeline ID, you should be presented with the jobs available in your pipeline:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50216698-2ce62e00-038f-11e9-8cb5-8b67dc6e6e3d.png" alt="" /></p>

<p>Select Jobs, and you should see an overview of your jobs. At this moment we can see that the build job has completed, and that the test job is busy running:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50216644-0922e800-038f-11e9-81d8-d40dd6ff0862.png" alt="" /></p>

<p>Shortly thereafter the status of the test job should change to failed, select the Job ID and you should see the output:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50216833-89e1e400-038f-11e9-896f-9d36aad1c55d.png" alt="" /></p>

<p>From the above output it gives you a link to create a new issue, which is quite handy.</p>

<h2>Fix the Pipeline Config</h2>

<p>Let&rsquo;s go ahead and change the content in the <code>.gitlab-ci.yml</code> config and push to master:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim .gitlab-ci.yml
</span></code></pre></td></tr></table></div></figure>


<p>Change line 12 from <code>- echo "false" &gt; builds/data.txt</code> to <code>- echo "true" &gt; builds/data.txt</code>, the full content of the file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">stages</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">build</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">build</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is building&quot;</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostname</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir builds</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">touch builds/data.txt</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;true&quot; &gt; builds/data.txt</span>
</span><span class='line'>  <span class="l-Scalar-Plain">artifacts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">builds/</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is testing&quot;</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hostname</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test -f builds/data.txt</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">grep &quot;true&quot; builds/data.txt</span>
</span></code></pre></td></tr></table></div></figure>


<p>Commit and push to master:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git add .gitlab-ci.yml
</span><span class='line'><span class="nv">$ </span>git commit -m <span class="s2">&quot;change content in script&quot;</span>
</span><span class='line'><span class="nv">$ </span>git push origin master
</span></code></pre></td></tr></table></div></figure>


<p>When you head over to Pipelines, you will see that the pipeline is busy running, and on the right the commit that we just made:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50217143-91ee5380-0390-11e9-8b08-08626984f176.png" alt="" /></p>

<h2>Great Success</h2>

<p>Select the Pipeline ID, then select Jobs, you should see both jobs succeeded:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50217299-f9a49e80-0390-11e9-871d-78423f0651c7.png" alt="" /></p>

<p>Select the Job ID of the test job, and from the output you will see that the job succeeded:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50217268-eb568280-0390-11e9-972c-58f23ce39741.png" alt="" /></p>

<p>From this output you can also confirm from both jobs, that each job ran in a different runner as the hostnames that was returned to stdout was different.</p>

<h2>Resources</h2>

<p>This was a really basic example to demonstrate Gitlab CI. Some relevant resources to this post:</p>

<ul>
<li><a href="https://docs.gitlab.com/ee/ci/">Gitlab CI/CD Docs</a></li>
<li><a href="https://hackernoon.com/setting-up-ci-cd-on-gitlab-step-by-step-guide-part-1-826385728223">Full CI/CD Example with Gitlab and Heroku</a></li>
</ul>


<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
</form>
</center>


<p><br></p>

<p>Ad space:</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>




<p><p></p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Resizing Hetzner Cloud Block Storage Volumes on the Fly]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/12/19/resizing-hetzner-cloud-block-storage-volumes-on-the-fly/"/>
    <updated>2018-12-19T00:59:11-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/12/19/resizing-hetzner-cloud-block-storage-volumes-on-the-fly</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/50203557-96a01100-036a-11e9-8fd5-2953497f92d8.png" alt="" /></p>

<p>Today we will be looking into Hetzner&rsquo;s Cloud Storage Volumes and how you can resize volumes on the fly!</p>

<h2>What is Hetzner&rsquo;s Cloud Storage Volumes</h2>

<p><a href="https://www.hetzner.com/cloud">Hetzner Cloud</a> offers a fast, flexible, and cost-effective SSD based Block Storage which can be attach to your Hetzner Cloud Server. At this point in time its available in the Nuremberg and Helsinki regions.</p>

<h2>Resizing of Volumes</h2>

<p>Volumes can be resized up to 10TB and the console allows you to resize in 1GB increments. You are allowed to increase, but cannot decrease.</p>

<h2>Demo through Cloud Volumes</h2>

<p>Let&rsquo;s run through a demo, where we will do the following:</p>

<ul>
<li>Provision a Server</li>
<li>Provision a Volume (XFS Filesystem / EXT4 is also optional)</li>
<li>Inspect the Volume, do some performance testing</li>
<li>Resize the Volume via Hetzner Cloud Console</li>
<li>Grow the XFS Filesystem</li>
</ul>


<p>After provisioning a server, which takes less than a minute, you should see that the server is created:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50202325-6f474500-0366-11e9-8e7d-e96f0c78beba.png" alt="" /></p>

<p>SSH into your server. At this moment, we have not provisioned any volumes, so only the root partition should be mounted. Look at the block allocation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsblk
</span><span class='line'>NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span><span class='line'>sda      8:0    <span class="m">0</span> 19.1G  <span class="m">0</span> disk
</span><span class='line'>--sda1   8:1    <span class="m">0</span> 19.1G  <span class="m">0</span> part /
</span><span class='line'>sr0     11:0    <span class="m">1</span> 1024M  <span class="m">0</span> rom
</span></code></pre></td></tr></table></div></figure>


<p>Have a look at the fstab:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat /etc/fstab
</span><span class='line'><span class="c"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span>
</span><span class='line'><span class="nv">UUID</span><span class="o">=</span>2f54e8e6-ff9c-497a-88ea-ce159f6cd283 /               ext4    discard,errors<span class="o">=</span>remount-ro <span class="m">0</span>       1
</span><span class='line'>/dev/fd0        /media/floppy0  auto    rw,user,noauto,exec,utf8 <span class="m">0</span>       0
</span></code></pre></td></tr></table></div></figure>


<p>And have a look at the mounted disks layout:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>udev            959M     <span class="m">0</span>  959M   0% /dev
</span><span class='line'>tmpfs           195M  652K  194M   1% /run
</span><span class='line'>/dev/sda1        19G  1.6G   17G   9% /
</span><span class='line'>tmpfs           973M     <span class="m">0</span>  973M   0% /dev/shm
</span><span class='line'>tmpfs           5.0M     <span class="m">0</span>  5.0M   0% /run/lock
</span><span class='line'>tmpfs           973M     <span class="m">0</span>  973M   0% /sys/fs/cgroup
</span><span class='line'>tmpfs           195M     <span class="m">0</span>  195M   0% /run/user/0
</span></code></pre></td></tr></table></div></figure>


<p>Now, time to provision a Volume. Head over to the Volumes section:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50202468-dfee6180-0366-11e9-8e48-aaadeb707938.png" alt="" /></p>

<p>I&rsquo;m going ahead with creating a volume with 10GB of space and assign it to my server, and yeah that&rsquo;s right, 10GB of storage is 0,40 EUR per month, epic value for money!</p>

<p><img src="https://user-images.githubusercontent.com/567298/50202502-fd233000-0366-11e9-9c71-475966488ca1.png" alt="" /></p>

<p>After you volume is created, you should see similar output below:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50202614-5a1ee600-0367-11e9-97ab-8352d5b6f064.png" alt="" /></p>

<p>Head back to your server, and have a look at the output when running the similar commands from earlier:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsblk
</span><span class='line'>NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span><span class='line'>sda      8:0    <span class="m">0</span> 19.1G  <span class="m">0</span> disk
</span><span class='line'>--sda1   8:1    <span class="m">0</span> 19.1G  <span class="m">0</span> part /
</span><span class='line'>sdb      8:16   <span class="m">0</span>   10G  <span class="m">0</span> disk /mnt/HC_Volume_1497823
</span><span class='line'>sr0     11:0    <span class="m">1</span> 1024M  <span class="m">0</span> rom
</span></code></pre></td></tr></table></div></figure>


<p>The fstab config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/fstab
</span><span class='line'><span class="c"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span>
</span><span class='line'><span class="nv">UUID</span><span class="o">=</span>2f54e8e6-ff9c-497a-88ea-ce159f6cd283 /               ext4    discard,errors<span class="o">=</span>remount-ro <span class="m">0</span>       1
</span><span class='line'>/dev/fd0        /media/floppy0  auto    rw,user,noauto,exec,utf8 <span class="m">0</span>       0
</span><span class='line'>/dev/disk/by-id/scsi-0HC_Volume_1497823 /mnt/HC_Volume_1497823 xfs discard,nofail,defaults <span class="m">0</span> 0
</span></code></pre></td></tr></table></div></figure>


<p>The disk layout:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>udev            959M     <span class="m">0</span>  959M   0% /dev
</span><span class='line'>tmpfs           195M  660K  194M   1% /run
</span><span class='line'>/dev/sda1        19G  1.6G   17G   9% /
</span><span class='line'>tmpfs           973M     <span class="m">0</span>  973M   0% /dev/shm
</span><span class='line'>tmpfs           5.0M     <span class="m">0</span>  5.0M   0% /run/lock
</span><span class='line'>tmpfs           973M     <span class="m">0</span>  973M   0% /sys/fs/cgroup
</span><span class='line'>tmpfs           195M     <span class="m">0</span>  195M   0% /run/user/0
</span><span class='line'>/dev/sdb         10G   43M   10G   1% /mnt/HC_Volume_1497823
</span></code></pre></td></tr></table></div></figure>


<p>We can see from the output above how easy it is to provision a volume to your Hetzner Cloud Server. And everything gets done for you, the disk is mounted and the <code>/etc/fstab</code> configuration is populated for you.</p>

<p>Time for some performance testing on the volume:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>dd <span class="nv">bs</span><span class="o">=</span>2M <span class="nv">count</span><span class="o">=</span><span class="m">256</span> <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/mnt/HC_Volume_1497823/test.dd
</span><span class='line'>256+0 records in
</span><span class='line'>256+0 records out
</span><span class='line'><span class="m">536870912</span> bytes <span class="o">(</span><span class="m">537</span> MB, <span class="m">512</span> MiB<span class="o">)</span> copied, 0.911306 s, <span class="m">589</span> MB/s
</span></code></pre></td></tr></table></div></figure>


<p>Pretty neat right? :D</p>

<p>Let&rsquo;s resize the volume via the Hetzner Cloud Console to 20GB and resize the filesystem. From the Console, head over to the volumes section, select the more options and select resize:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50203010-bcc4b180-0368-11e9-86e8-653490ad6870.png" alt="" /></p>

<p>After the volume has been resized, head back to your server and resize the filesystem. As we are using XFS Filesystem, we will use <code>xfs_growfs</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>xfs_growfs /dev/sdb
</span><span class='line'>meta-data<span class="o">=</span>/dev/sdb               <span class="nv">isize</span><span class="o">=</span><span class="m">512</span>    <span class="nv">agcount</span><span class="o">=</span>4, <span class="nv">agsize</span><span class="o">=</span><span class="m">655360</span> <span class="nv">blks</span>
</span><span class='line'>         <span class="o">=</span>                       <span class="nv">sectsz</span><span class="o">=</span><span class="m">512</span>   <span class="nv">attr</span><span class="o">=</span>2, <span class="nv">projid32bit</span><span class="o">=</span><span class="nv">1</span>
</span><span class='line'>         <span class="o">=</span>                       <span class="nv">crc</span><span class="o">=</span><span class="m">1</span>        <span class="nv">finobt</span><span class="o">=</span><span class="m">1</span> <span class="nv">spinodes</span><span class="o">=</span><span class="m">0</span> <span class="nv">rmapbt</span><span class="o">=</span><span class="nv">0</span>
</span><span class='line'>         <span class="o">=</span>                       <span class="nv">reflink</span><span class="o">=</span>0
</span><span class='line'><span class="nv">data</span>     <span class="o">=</span>                       <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>2621440, <span class="nv">imaxpct</span><span class="o">=</span><span class="nv">25</span>
</span><span class='line'>         <span class="o">=</span>                       <span class="nv">sunit</span><span class="o">=</span><span class="m">0</span>      <span class="nv">swidth</span><span class="o">=</span><span class="m">0</span> blks
</span><span class='line'><span class="nv">naming</span>   <span class="o">=</span>version <span class="m">2</span>              <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   ascii-ci<span class="o">=</span><span class="m">0</span> <span class="nv">ftype</span><span class="o">=</span>1
</span><span class='line'><span class="nv">log</span>      <span class="o">=</span>internal               <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>2560, <span class="nv">version</span><span class="o">=</span><span class="nv">2</span>
</span><span class='line'>         <span class="o">=</span>                       <span class="nv">sectsz</span><span class="o">=</span><span class="m">512</span>   <span class="nv">sunit</span><span class="o">=</span><span class="m">0</span> blks, lazy-count<span class="o">=</span>1
</span><span class='line'><span class="nv">realtime</span> <span class="o">=</span>none                   <span class="nv">extsz</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>0, <span class="nv">rtextents</span><span class="o">=</span>0
</span><span class='line'>data blocks changed from <span class="m">2621440</span> to 5242880
</span></code></pre></td></tr></table></div></figure>


<p>Have a look at the disk layout and see that the filesystem was resized on the fly. If you have applications writing/reading to and from that volume, its better to unmount it first.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>udev            959M     <span class="m">0</span>  959M   0% /dev
</span><span class='line'>tmpfs           195M  660K  194M   1% /run
</span><span class='line'>/dev/sda1        19G  2.1G   16G  12% /
</span><span class='line'>tmpfs           973M     <span class="m">0</span>  973M   0% /dev/shm
</span><span class='line'>tmpfs           5.0M     <span class="m">0</span>  5.0M   0% /run/lock
</span><span class='line'>tmpfs           973M     <span class="m">0</span>  973M   0% /sys/fs/cgroup
</span><span class='line'>tmpfs           195M     <span class="m">0</span>  195M   0% /run/user/0
</span><span class='line'>/dev/sdb         20G  565M   20G   3% /mnt/HC_Volume_1497823
</span></code></pre></td></tr></table></div></figure>


<p>I must admit, I am really stoked with Hetzner&rsquo;s offerings and their performance. I&rsquo;ve been hosting servers with them for the past 5 months and so far they really impressed me.</p>

<p>Have a look at <a href="https://www.hetzner.com/cloud">Hetzner Cloud&rsquo;s</a> offerings, they have great prices as you can start off with a server from as little as 2.49 EUR per month, which gives you 1vCPU, 2GB of RAM, 20GB disk Space and 20TB of traffic. I mean, thats awesome value for money. They also offer Floating IP&rsquo;s, Backups, etc.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://www.hetzner.com/cloud">Hetzner Cloud&rsquo;s</a></li>
<li><a href="https://wiki.hetzner.de/index.php/CloudServer/en#What_are_the_Hetzner_Cloud_Volumes.3F">More info on Hetzner Volumes</a></li>
</ul>


<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
</form>
</center>


<p><br></p>

<p>Ad space:</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>




<p><p></p>

<p>Thanks for reading!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Creating a UI in Python Flask and Bootstrap for Our Serverless URL Shortener]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/12/18/creating-a-ui-in-python-flask-and-bootstrap-for-our-serverless-url-shortener/"/>
    <updated>2018-12-18T09:35:53-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/12/18/creating-a-ui-in-python-flask-and-bootstrap-for-our-serverless-url-shortener</id>
    <content type="html"><![CDATA[<p><img src="https://objects.ruanbekker.com/assets/images/python-flask.png" alt="" /></p>

<p>From a <a href="https://blog.ruanbekker.com/blog/2018/11/30/how-to-setup-a-serverless-url-shortener-with-api-gateway-lambda-and-dynamodb-on-aws/">previous</a> post, we went through the setup of building a <a href="https://blog.ruanbekker.com/blog/2018/11/30/how-to-setup-a-serverless-url-shortener-with-api-gateway-lambda-and-dynamodb-on-aws/">Serverless URL Shortener with API Gateway, Lambda, and DynamoDB on AWS</a>. Today we will build a Web User Interface using Python Flask, Bootstrap and JavaScript that will communicate to our API to shorten URL&rsquo;s.</p>

<p>Note: Although using Python Flask is a Hosted option, you could also use <a href="https://s3-us-west-2.amazonaws.com/sha-public-us-west-2/URLShortener/index.html">this example</a> to host it as a web page on Amazon S3, for the complete serverless route.</p>

<h2>Dependencies:</h2>

<p>We need Flask, Gunicorn (optional) and Requests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install flask gunicorn requests
</span></code></pre></td></tr></table></div></figure>


<h2>Application Code:</h2>

<p>It&rsquo;s good practice to use a API Key for some level of security, but if not, you can just remove the headers section of <code>x-api-key</code>.</p>

<p>The application relies on 3 environment variables: <code>APP_TITLE</code> - which is the banner name (defaults to &ldquo;My URL Shortener&rdquo; if none is set), <code>TINY_API_URL</code> - which is the URL to create the shortened url and <code>X_API_KEY</code> which is the api key for your API.</p>

<p>The content of <code>app.py</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url_for</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">logging</span>
</span><span class='line'>
</span><span class='line'><span class="n">tiny_api_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;TINY_API_URL&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class='line'><span class="n">tiny_api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;X_API_KEY&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class='line'><span class="n">app_title</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APP_TITLE&#39;</span><span class="p">,</span> <span class="s">&#39;My URL Shortener&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">tiny_api_url</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">tiny_api_key</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
</span><span class='line'>    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to load configuration&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s">&#39;application/json&#39;</span><span class="p">,</span> <span class="s">&#39;X-Api-Key&#39;</span><span class="p">:</span> <span class="n">tiny_api_key</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">app_title</span><span class="o">=</span><span class="n">app_title</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/shortened&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">search_request</span><span class="p">():</span>
</span><span class='line'>    <span class="n">user_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&quot;input&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
</span><span class='line'>        <span class="n">tiny_api_url</span><span class="p">,</span>
</span><span class='line'>        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
</span><span class='line'>        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span class='line'>            <span class="s">&quot;long_url&quot;</span><span class="p">:</span> <span class="n">user_url</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;results.html&#39;</span><span class="p">,</span> <span class="n">app_title</span><span class="o">=</span><span class="n">app_title</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">passthrough_errors</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>JavaScript</h2>

<p>We want to copy the value of the shortened url response to clipboard when clicking on a button. For that functionality, we need some javascript.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p static/js
</span><span class='line'><span class="nv">$ </span>touch static/js/clipboard.js
</span></code></pre></td></tr></table></div></figure>


<p>the content for our javascript function - <code>static/js/clipboard.js</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">copyToClipboard</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">copyText</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">copyText</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
</span><span class='line'>  <span class="nb">document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s2">&quot;Copy&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>HTML</h2>

<p>The content for <code>templates/index.html</code> :</p>

<script src="https://gist.github.com/ruanbekker/0c12fd81c94dc9019641dd536d704519.js"></script>


<p>The content for <code>templates/results.html</code> :</p>

<script src="https://gist.github.com/ruanbekker/01e27db70d4a2f60393b927697b2ca57.js"></script>


<h2>Run the Server</h2>

<p>Before we run the server, we need to set the environment variables as mentioned earlier:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">TINY_API_URL</span><span class="o">=</span>https://tiny-api.mydomain.com/create
</span><span class='line'><span class="nv">X_API_KEY</span><span class="o">=</span>someRandomSecretKey09876543210
</span></code></pre></td></tr></table></div></figure>


<p>Run the Server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gunicorn -w <span class="m">2</span> -b 0.0.0.0:8080 --access-logfile<span class="o">=</span>/dev/stdout --error-log<span class="o">=</span>/dev/stderr app:app
</span></code></pre></td></tr></table></div></figure>


<p>After booting the server, access the server on <code>http://localhost:8080/</code> and the response should look like:</p>

<p><img src="https://user-images.githubusercontent.com/567298/50162763-c5c16e80-02e7-11e9-8744-a4c3c3c51f8e.png" alt="" /></p>

<h2>Dockerizing this Application</h2>

<p>The source code for this project is available on my <a href="https://github.com/ruanbekker/flask-url-shortener-ui">github repository</a></p>

<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
</form>
</center>


<p><br></p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[VULTR Cloud Servers Limited Signup Promotion]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/12/12/vultr-cloud-servers-limited-singup-promotion/"/>
    <updated>2018-12-12T01:00:32-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/12/12/vultr-cloud-servers-limited-singup-promotion</id>
    <content type="html"><![CDATA[<p><img src="https://user-images.githubusercontent.com/567298/49853336-78c53000-fdef-11e8-8cc2-4b7684550060.png" alt="" /></p>

<p>It&rsquo;s promotion time with VULTR! Get a head start with some free credits.</p>

<h2>Promotion</h2>

<p>VULTR has a promotion running for a limited time, when you sign up with this link below, use the coupon / promo code: <em>VULTRMATCH</em> and you will receive double the deposit in credits for up to $100. This applies to new customers only.</p>

<p>I&rsquo;m not quite sure how long they will be running this promotion, but you can get $100 free in credits when you sign up. That is basically <em>20 months free hosting</em> of a Cloud Server with 1CPU, 1GB RAM, 1TB Bandwidth.</p>

<p>Here&rsquo;s the link:</p>

<p><a href="https://goo.gl/hiAamd"><img src="https://www.vultr.com/media/banner_1.png" width="468" height="60"></a></p>

<h2>About VULTR</h2>

<p>If you are not familliar with VULTR, they are a Cloud Hosting Company that offers cloud servers, bare-metal servers and storage servers in 16 different regions and they provide a hourly billing model.</p>

<p>Below are some of their features:</p>

<ul>
<li>16 Locations: Silicon Valley, Seattle, LA, Dallas, Toronto, Miami, New Jersey, Chicago, Atlanta, London, Paris, Frankfurt, Amsterdam, Tokyo, Singapore, Sydney</li>
<li>100% SLA Guaranteed</li>
<li>Solid-State Drives (SSD)</li>
<li>Private Networking</li>
<li>Reserved IP&rsquo;s</li>
<li>Anti-DDOS Support</li>
<li>Backups</li>
<li>DNS</li>
<li>Startup Scripts</li>
<li>Firewalls</li>
<li>Pretty Slick User Interface</li>
<li>Root Access</li>
<li>Hourly Billing</li>
<li>Deploy Applications Instantly to your Servers with App Deploys</li>
<li>OS Support: Linux, Windows and Custom Uploads</li>
<li>API Support</li>
<li>Great Documentation and Tutorials</li>
</ul>


<p>They also allow you to submit articles to them that can earn you up to $300 per article, check it out <a href="https://goo.gl/hiAamd">here</a></p>

<h2>VULTR Mission</h2>

<p>From their website, their about us section states:</p>

<p>&ldquo;Vultr, founded in 2014, is on a mission to empower developers and businesses by simplifying the deployment of infrastructure via its advanced cloud platform. Vultr is strategically located in 16 datacenters around the globe and provides frictionless provisioning of public cloud, storage and single-tenant bare metal.&rdquo;</p>

<p>&ldquo;Vultr has made it our priority to offer a standardized highly reliable high performance cloud compute environment in all of the cities we serve. Launching a cloud server environment in 16 cities around the globe has never been easier!&rdquo;</p>

<h2>Launching a Server</h2>

<p>I decided to deploy a server pre-configured with Docker, and just about a minute I had my server up and running with Docker, ready to go.</p>

<p>Screenshot of the UI:</p>

<p><img src="https://user-images.githubusercontent.com/567298/49851122-bc686b80-fde8-11e8-82f5-d5fd7fdbaf8a.png" alt="" /></p>

<p>Screenshot of the root login:</p>

<p><img src="https://user-images.githubusercontent.com/567298/49851151-d609b300-fde8-11e8-98aa-974b79b67ed1.png" alt="" /></p>

<h2>Overall</h2>

<p>I&rsquo;m quite impressed with VULTR and the ease of use. The pricing is really good and like the fact that you can deploy servers with pre-configured software on it.</p>

<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
<img alt="" border="0" src="https://www.paypal.com/en_ZA/i/scr/pixel.gif" width="1" height="1" />
</form>
</center>


<p><br></p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python Flask Tutorial Series: Routing in Flask]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/12/11/python-flask-tutorial-series-routing-in-flask-p3/"/>
    <updated>2018-12-11T05:29:14-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/12/11/python-flask-tutorial-series-routing-in-flask-p3</id>
    <content type="html"><![CDATA[<p><img src="https://objects.ruanbekker.com/assets/images/python-flask.png" alt="" /></p>

<p>This is post 3 of our <a href="http://blog.ruanbekker.com/blog/categories/flask-tutorial/">Python Flask Tutorial Series</a> where we will go into Views and Routing.</p>

<p>In our previous post we went through the steps to setup a <a href="https://blog.ruanbekker.com/blog/2018/12/09/python-flask-tutorial-series-setup-a-python-virtual-environment-p2/">Virtual Environment for our Flask App</a></p>

<h2>Flask Views and Routing:</h2>

<p>Flask Routing is essentially mapping a URL eg. <code>example.com/pages/test</code> to a view function within your code. For example having <code>/contact-us</code> displaying a page about contact details.</p>

<p>The <code>route()</code> decorator in Flask is used to bind the URL to a function.</p>

<h2>Some basic examples:</h2>

<p>This is a basic web app that shows on which page you are:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/home&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;&lt;h2&gt;You are on the Home Page&lt;/h2&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/about-us&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">about</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;&lt;h2&gt;You are on the About Us Page&lt;/h2&gt;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__main__</span> <span class="o">==</span> <span class="s">&#39;__name__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>With <code>app.run()</code> we have passed no arguments, so it will use the defaults, which is:</p>

<ul>
<li>Host: <code>127.0.0.1</code></li>
<li>Port: <code>5000</code></li>
<li>Debug: <code>False</code></li>
</ul>


<p>To set your own values, you could do something like: <code>app.run(host='0.0.0.0', port=8080, debug=True)</code>. Note: Never use debug mode in production.</p>

<p>So when you do a GET Request on <code>http://localhost:5000/home</code> you will be presented with the response that you are on the home page.</p>

<p>This is all good and well, but its static, so lets look how we can set this up in a dynamic way.</p>

<h2>URL Variables:</h2>

<p>We can use variables in the <code>route()</code> decorator which we can parse through to the function. In this next example we will use a <code>name</code> variable, and depending on what name is passed in the GET request, will be provided in the response.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/user/&lt;name&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;Welcome, {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__main__</span> <span class="o">==</span> <span class="s">&#39;__name__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>So with the above example, <code>&lt;name&gt;</code> will be used as a placeholder or variable, and then passed through to our function and then returned in our response, for example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://localhost:5000/user/James
</span><span class='line'>Welcome, James
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -XGET http://localhost:5000/user/Frank
</span><span class='line'>Welcome, Frank
</span></code></pre></td></tr></table></div></figure>


<p>So this can be really useful when dealing with dynamic data. You can also go deeper into this, like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/user/&lt;name&gt;/&lt;surname&gt;/&lt;prog_lang&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">surname</span><span class="p">,</span> <span class="n">prog_lang</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;{} {} likes {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">surname</span><span class="p">,</span> <span class="n">prog_lang</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__main__</span> <span class="o">==</span> <span class="s">&#39;__name__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will produce:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://localhost:5000/user/John/Smith/Python
</span><span class='line'>John Smith likes Python
</span></code></pre></td></tr></table></div></figure>


<p>We can also have defaults, so if no values was passed, and you only hit the <code>/user</code> endpoint, you can have a default value returned:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/user&#39;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Ruan&#39;</span><span class="p">,</span> <span class="s">&#39;surname&#39;</span><span class="p">:</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="s">&#39;prog_lang&#39;</span><span class="p">:</span> <span class="s">&#39;Python&#39;</span><span class="p">})</span>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/user/&lt;name&gt;/&lt;surname&gt;/&lt;prog_lang&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">surname</span><span class="p">,</span> <span class="n">prog_lang</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;{} {} likes {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">surname</span><span class="p">,</span> <span class="n">prog_lang</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__main__</span> <span class="o">==</span> <span class="s">&#39;__name__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>So then the output would look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://localhost:5000/user
</span><span class='line'>Ruan B likes Python
</span></code></pre></td></tr></table></div></figure>


<p>This is a very simple example, but you could use it in many ways.</p>

<h2>Data Types in URL Routing:</h2>

<p>You could also explicitly set your datatypes, like string or integer etc in your route decorators.</p>

<p>Example for <em>Strings</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/city/&lt;string:cityname&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">cityname</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;Selected City is: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cityname</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__main__</span> <span class="o">==</span> <span class="s">&#39;__name__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Example for <em>Integers</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/user/&lt;integer:age&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;Selected age is: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__main__</span> <span class="o">==</span> <span class="s">&#39;__name__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now because the datatype is an integer, when you try to pass a string, you will be faced with an error. So the value that you will need to pass would then be strictly set to the type of integer.</p>

<p>Example with <em>if statements</em>:</p>

<p>You could also use if statements in your functions, like determining the age group, for example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/user/&lt;integer:age&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">28</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&#39;Your selected age is {}, so you are in the 28 and older group&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&#39;Your selected age is {}, so you are in the younger then 28 group&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__main__</span> <span class="o">==</span> <span class="s">&#39;__name__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>So with the above example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1:5000/user/12
</span><span class='line'>Your selected age is 12, so you are in the younger <span class="k">then</span> <span class="m">28</span> group
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1:5000/user/30
</span><span class='line'>Your selected age is 30, so you are in the <span class="m">28</span> and older group
</span></code></pre></td></tr></table></div></figure>


<p>Example with <em>Floats</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>@app.route<span class="o">(</span><span class="s1">&#39;/myfloat/&lt;float:floatnum&gt;&#39;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Example with <em>Path Types</em>:</p>

<p>We can also pass accept the URL Path, that is passed by using the path type:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/path/&lt;path:mypath&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">mypath</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;Your selected path is: /{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mypath</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__main__</span> <span class="o">==</span> <span class="s">&#39;__name__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>So with the above example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1:5000/path/apps/data/my/app
</span><span class='line'>Your selected path is: /apps/data/my/app
</span></code></pre></td></tr></table></div></figure>


<p>I hope this was useful, next up in our <a href="http://blog.ruanbekker.com/blog/categories/flask-tutorial/">Python Flask Tutorial-Series</a> will be rendering templates in flask with the jinja2 templating engine.</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python Flask Tutorial Series: Setup a Python Virtual Environment]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/12/09/python-flask-tutorial-series-setup-a-python-virtual-environment-p2/"/>
    <updated>2018-12-09T17:19:24-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/12/09/python-flask-tutorial-series-setup-a-python-virtual-environment-p2</id>
    <content type="html"><![CDATA[<p><img src="https://objects.ruanbekker.com/assets/images/python-flask.png" alt="" /></p>

<p>In our previous post we wrote a basic <a href="https://blog.ruanbekker.com/blog/2018/11/27/python-flask-tutorial-series-create-a-hello-world-app-p1/">Hello World App in Flask</a>. This is post 2 of the <a href="http://blog.ruanbekker.com/blog/categories/flask-tutorial/">Python Flask Tutorial Series</a></p>

<p>In this section we will be covering our Environment Setup, where I will be showing you how to setup a typical Python Flask Environment using <a href="http://virtualenv.readthedocs.org/en/latest/">virtualenv</a></p>

<h2>What is VirtualEnv?</h2>

<p>Virtualenv allows you to have isolated Python Environments, where each project or environment can have their own versions. Some applications may need a specific version of a certain package, so lets say you are running multiple applications on one server, then having to manage each ones dependencies can be a pain. As you may run into scenarios where they are dependent on specific versions, where you have to upgrade/downgrade packages like no-ones business.</p>

<p>Luckily with the help of virtualenv, each environment is isolated from each other, so system wide you might be running Python 2.7 with minimal packages installed, then you can create a virtual environment with Python 3 with packages for the application you are developing.</p>

<h2>Setup a Virtual Environment:</h2>

<p>We will setup a virtualenv for our project with our default python version which in this case is 2.7:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir ~/projects/mywebapp
</span><span class='line'>$ cd ~/projects/mywebapp
</span><span class='line'>$ virtualenv .venv</span></code></pre></td></tr></table></div></figure>


<p>At this moment you should have your virtual environment ready, now to enter and activate our environment:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ source .venv/bin/activate</span></code></pre></td></tr></table></div></figure>


<p>To confirm your python version:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python --version
</span><span class='line'>Python 2.7.6</span></code></pre></td></tr></table></div></figure>


<p>If you have multiple versions of python, you can create your virtual environment with a different python version by using the <code>-p</code> flag, as in:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virtualenv -p /usr/local/bin/python2.7 .venv</span></code></pre></td></tr></table></div></figure>


<p>Now that we are in our virtualenv, lets install 2 packages, Flask and Requests:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip install flask
</span><span class='line'>$ pip install requests</span></code></pre></td></tr></table></div></figure>


<p>With pip we can list the installed packages we have with <code>pip freeze</code>. Since this is our virtual environment, we will only see the packages that was installed into this environment:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip freeze
</span><span class='line'>click==6.7
</span><span class='line'>Flask==0.12
</span><span class='line'>itsdangerous==0.24
</span><span class='line'>Jinja2==2.9.5.1
</span><span class='line'>MarkupSafe==1.0
</span><span class='line'>requests==2.7.0
</span><span class='line'>six==1.10.0
</span><span class='line'>virtualenv==15.0.1
</span><span class='line'>Werkzeug==0.12.1</span></code></pre></td></tr></table></div></figure>


<p>We can dump this to a file, which we can later use to install packages from a list so that we don&rsquo;t have to specify them manually. We can dump them by doing this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip freeze &gt; requirements.txt
</span></code></pre></td></tr></table></div></figure>


<p>Now lets say you are on a different host and you would like to install the packages from the <code>requirements.txt</code> file, we do this by using the following command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install -r requirements.txt
</span></code></pre></td></tr></table></div></figure>


<p>To exit your virtualenv, you do the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>deactivate
</span></code></pre></td></tr></table></div></figure>


<p>I hope this was useful, next up in our <a href="http://blog.ruanbekker.com/blog/categories/flask-tutorial/">Python Flask Tutorial Series</a> will be <a href="https://blog.ruanbekker.com/blog/2018/12/11/python-flask-tutorial-series-routing-in-flask-p3/">Routing in Flask</a></p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Setup a Serverless URL Shortener With API Gateway Lambda and DynamoDB on AWS]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/11/30/how-to-setup-a-serverless-url-shortener-with-api-gateway-lambda-and-dynamodb-on-aws/"/>
    <updated>2018-11-30T02:51:24-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/11/30/how-to-setup-a-serverless-url-shortener-with-api-gateway-lambda-and-dynamodb-on-aws</id>
    <content type="html"><![CDATA[<p><img src="https://objects.ruanbekker.com/assets/images/aws-logo.png" alt="" /></p>

<p>Today we will set a Serverless URL Shortener using API Gateway, Lambda with Python and DynamoDB.</p>

<h2>Overview</h2>

<p>The service that we will be creating, will shorten URLs via our API which will create an entry on DynamoDB. When a GET method is performed on the shortened URL, a GetItem is executed on DynamoDB to get the Long URL and a 301 Redirect is performed to redirect the client to intended destination URL.</p>

<p>Note, I am using a domain name which is quite long, but its only for demonstration, if you can get hold of any short domains like <code>t.co</code> etc, that will make your Shortened URLs really short in character count.</p>

<p>Update: URL Shortener UI <a href="https://blog.ruanbekker.com/blog/2018/12/18/creating-a-ui-in-python-flask-and-bootstrap-for-our-serverless-url-shortener/">available in this post</a></p>

<h2>The Setup</h2>

<p>The following services will be used to create a URL Shortener:</p>

<ul>
<li>AWS API Gateway: ( <code>/create</code>: to create a shortened url and <code>/t/{id}</code> to redirect to long url)</li>
<li>AWS IAM: (Role and Policy for Permissions to call DynamoDB from Lambda)</li>
<li>AWS Lambda: (Application Logic)</li>
<li>AWS DynamoDB: (Persistent Store to save our Data)</li>
<li>AWS ACM: (Optional: Certificate for your Domain)</li>
<li>AWS Route53: (Optional: DNS for the domain that you want to associate to your API)</li>
</ul>


<p>The flow will be like the following:</p>

<ul>
<li>POST Request gets made to the <code>/create</code> request path with the <code>long_url</code> data in the payload</li>
<li>This data is then used by the Lambda function to create a short url and create a entry in DynamoDB</li>
<li>In DynamoDB the entry is created with the short id as the hash key and the long url as one of the attributes</li>
<li>The response to the client will be the short url</li>
<li>When a GET method is performed on the id eg <code>/t/{short_id}</code>, a lookup gets done on the DynamoDB table, retrieves the long url from the table</li>
<li>A 301 redirect gets performed on API Gateway and the client gets redirected to the intended url</li>
</ul>


<h2>Creating the URL Shortener</h2>

<p>After completing this tutorial you will have your own Serverless URL Shortener using API Gateway, Lambda and DynamoDB.</p>

<h2>IAM Permissions</h2>

<p>On AWS IAM, create a IAM Policy, in my case the policy name is <code>lambda-dynamodb-url-shortener</code> and note that I masked out my account number:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;VisualEditor0&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;dynamodb:PutItem&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;dynamodb:DeleteItem&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;dynamodb:GetItem&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;dynamodb:Query&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;dynamodb:UpdateItem&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:dynamodb:eu-west-1:xxxxxxxxxxxx:table/url-shortener-table&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Head over to <a href="https://console.aws.amazon.com/iam/home?region=eu-west-1#/roles">IAM Roles</a>, select Create Role, Select Lambda as the Trusted Entitiy from the AWS Service section, go ahead with the permissions and select your IAM Policy that was created, in my case <code>lambda-dynamodb-url-shortener</code> and <code>AWSLambdaBasicExecution</code> role. Give your Role a name, in my case <code>lambda-dynamodb-url-shortener-role</code>.</p>

<h2>DynamoDB Table</h2>

<p>Next, head over to <a href="https://eu-west-1.console.aws.amazon.com/dynamodb/home?region=eu-west-1#create-table:">DynamoDB</a> create a table, in my case the table name: <code>url-shortener-table</code> and the primary key <code>short_id</code> set to string:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-02.png" alt="" /></p>

<h2>Lambda Functions</h2>

<p>Once the table is created, head over to <a href="https://eu-west-1.console.aws.amazon.com/lambda/home?region=eu-west-1#/create?firstrun=true">Lambda</a> and create a Lambda function, in my case using Python 3.6 and provide a name, where I used: <code>url-shortener-create</code> and select the IAM role from the previous role that we created, this function will be the lambda function that will create the shortened urls:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-03-lambda.png" alt="" /></p>

<p>The code for your lambda function which will take care of creating the short urls and save them to dynamodb, take note on the region and table name to ensure that it matches your setup:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">ascii_letters</span><span class="p">,</span> <span class="n">digits</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span><span class="p">,</span> <span class="n">randint</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">time</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">parse</span>
</span><span class='line'>
</span><span class='line'><span class="n">app_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APP_URL&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">min_char</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;MIN_CHAR&#39;</span><span class="p">))</span>
</span><span class='line'><span class="n">max_char</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;MAX_CHAR&#39;</span><span class="p">))</span>
</span><span class='line'><span class="n">string_format</span> <span class="o">=</span> <span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">digits</span>
</span><span class='line'>
</span><span class='line'><span class="n">ddb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span> <span class="o">=</span> <span class="s">&#39;eu-west-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;url-shortener-table&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">generate_timestamp</span><span class="p">():</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">expiry_date</span><span class="p">():</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mi">604800</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">check_id</span><span class="p">(</span><span class="n">short_id</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;Item&#39;</span> <span class="ow">in</span> <span class="n">ddb</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;short_id&#39;</span><span class="p">:</span> <span class="n">short_id</span><span class="p">}):</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="n">generate_id</span><span class="p">()</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">short_id</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">generate_id</span><span class="p">():</span>
</span><span class='line'>    <span class="n">short_id</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">choice</span><span class="p">(</span><span class="n">string_format</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="n">min_char</span><span class="p">,</span> <span class="n">max_char</span><span class="p">)))</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">short_id</span><span class="p">)</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">check_id</span><span class="p">(</span><span class="n">short_id</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span><span class='line'>    <span class="n">analytics</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span class='line'>    <span class="n">short_id</span> <span class="o">=</span> <span class="n">generate_id</span><span class="p">()</span>
</span><span class='line'>    <span class="n">short_url</span> <span class="o">=</span> <span class="n">app_url</span> <span class="o">+</span> <span class="n">short_id</span>
</span><span class='line'>    <span class="n">long_url</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;long_url&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">generate_timestamp</span><span class="p">()</span>
</span><span class='line'>    <span class="n">ttl_value</span> <span class="o">=</span> <span class="n">expiry_date</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">analytics</span><span class="p">[</span><span class="s">&#39;user_agent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;headers&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;User-Agent&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">analytics</span><span class="p">[</span><span class="s">&#39;source_ip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;headers&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;X-Forwarded-For&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">analytics</span><span class="p">[</span><span class="s">&#39;xray_trace_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;headers&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;X-Amzn-Trace-Id&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="n">url_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">parse</span><span class="o">.</span><span class="n">parse_qsl</span><span class="p">(</span><span class="n">parse</span><span class="o">.</span><span class="n">urlsplit</span><span class="p">(</span><span class="n">long_url</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">url_params</span><span class="p">:</span>
</span><span class='line'>            <span class="n">analytics</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">url_params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;short_id&#39;</span><span class="p">:</span> <span class="n">short_id</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;created_at&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;ttl&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">ttl_value</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&#39;short_url&#39;</span><span class="p">:</span> <span class="n">short_url</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;long_url&#39;</span><span class="p">:</span> <span class="n">long_url</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;analytics&#39;</span><span class="p">:</span> <span class="n">analytics</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;hits&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;body&quot;</span><span class="p">:</span> <span class="n">short_url</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set a couple of environment variables that will be used in our function, min and max chars from the screenshot below is the amount of characters that will be used in a random manner to make the short id unique. The app_url will be your domain name, as this will be returned to the client with the short id eg. <code>https://tiny.myserverlessapp.net/t/3f8Hf38n398t</code> :</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-04-lambda.png" alt="" /></p>

<p>While you are on Lambda, create the function that will retrieve the long url, in my case <code>url-shortener-retrieve</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'>
</span><span class='line'><span class="n">ddb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">,</span> <span class="n">region_name</span> <span class="o">=</span> <span class="s">&#39;eu-west-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;eng-url-shortener&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span><span class='line'>    <span class="n">short_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;short_id&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">item</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;short_id&#39;</span><span class="p">:</span> <span class="n">short_id</span><span class="p">})</span>
</span><span class='line'>        <span class="n">long_url</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Item&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;long_url&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="c"># increase the hit number on the db entry of the url (analytics?)</span>
</span><span class='line'>        <span class="n">ddb</span><span class="o">.</span><span class="n">update_item</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;short_id&#39;</span><span class="p">:</span> <span class="n">short_id</span><span class="p">},</span>
</span><span class='line'>            <span class="n">UpdateExpression</span><span class="o">=</span><span class="s">&#39;set hits = hits + :val&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">ExpressionAttributeValues</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;:val&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">except</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;statusCode&#39;</span><span class="p">:</span> <span class="mi">301</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;location&#39;</span><span class="p">:</span> <span class="s">&#39;https://objects.ruanbekker.com/assets/images/404-blue.jpg&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">301</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;location&quot;</span><span class="p">:</span> <span class="n">long_url</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>API Gateway</h2>

<p>Head over to <a href="https://console.aws.amazon.com/apigateway/home?region=us-east-1#/apis">API Gateway</a> and create your API, in my case <code>url-shortener-api</code></p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-05-api-gateway.png" alt="" /></p>

<p>Head over to Resources:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-06-api-gateway.png" alt="" /></p>

<p>and create a new resource called <code>/create</code>:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-07-api-gateway.png" alt="" /></p>

<p>Once the resource is created, create a post method on the <code>create</code> resource and select Lambda as the integration type and lambda proxy integration as seen below:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-09-api-gateway.png" alt="" /></p>

<p>Once you save it, it will ask to give api gateway permission to invoike your lambda function wich you can accept by hitting ok as below:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-10-iam-permission.png" alt="" /></p>

<p>When you look at the POST method on your create resource, it should look like this:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-12-api-gateway.png" alt="" /></p>

<p>Select the root resource <code>/</code> and from Actions create a new resource <code>/t</code>:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-13-api-gateway.png" alt="" /></p>

<p>Select the <code>/t</code> resource and create a new resource named <code>shortid</code> and provide <code>{shortid}</code> in the resource path as this will be the data that will be proxied through to our lambda function:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-14-api-gateway.png" alt="" /></p>

<p>Create a GET method on the <code>/t/{shortid}</code> resource and select <code>url-shortener-retrieve</code> lambda function as the function from the lambda integration selection as seen below:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-17-api-gateway.png" alt="" /></p>

<p>Again, grant api gateway permission to invoke your function:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-18-iam-permission.png" alt="" /></p>

<p>When you select the GET method, it should look like this:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-19-api-gateway.png" alt="" /></p>

<p>Select the Integration Request and head over to Mapping Templates:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-20-api-gateway.png" alt="" /></p>

<p>from the Request body passtrhough, add a mapping template <code>application/json</code> and provide the following mapping template:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;short_id&quot;</span><span class="p">:</span> <span class="s">&quot;$input.params(&#39;shortid&#39;)&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>On the Method Response:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-21-api-gateway.png" alt="" /></p>

<p>Delete the 200 HTTP Status Response and create a new response by &ldquo;Add Response&rdquo;, add <code>301</code> HTTP Status, add <code>Location</code> Header to the response.</p>

<p>Navigate to the Integration Response from the <code>/{shortid}</code> GET method:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-21-api-gateway.png" alt="" /></p>

<p>delete the 200 HTTP Response, add &ldquo;integration response&rdquo;, set method response status to 301 and add header mapping for location to integration.response.body.location as below:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-23-api-gateway.png" alt="" /></p>

<p>make sure to select the integration response to - so that the method response reflects to 301:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-24-api-gateway.png" alt="" /></p>

<p>Navigate to Actions and select &ldquo;Deploy API&rdquo;, select your stage, in my case <code>test</code> and deploy:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-25-api-gateway.png" alt="" /></p>

<p>Go to stages, select your stage, select the post request to reveal the API URL:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-26-api-gateway.png" alt="" /></p>

<p>Time to test out the URL Shortener:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -XPOST -H <span class="s2">&quot;Content-Type: application/json&quot;</span> https://xxxxxx.execute-api.eu-west-1.amazonaws.com/test/create -d <span class="s1">&#39;{&quot;long_url&quot;: &quot;https://www.google.com/search?q=helloworld&quot;}&#39;</span>
</span><span class='line'>https://tiny.myserverlessapp.net/t/pcnWoCGCr2ad1x
</span></code></pre></td></tr></table></div></figure>


<h2>ACM Certificates</h2>

<p>At this moment we dont have our domain connected with our API Gateway, and we would also want a certificate on our application, which we can use ACM to request a certificate that can be associated to our domain. So in order to do that, first request a certificate on <a href="https://eu-west-1.console.aws.amazon.com/acm/home?region=eu-west-1#/privatewizard/">ACM</a>. Select Request a certificate, create a wildcard entry: <code>*.yourdomain.com</code>, select DNS Validation (If you host with Route53, they allow you the option to create the record).</p>

<p>Head back to API Gateway to associate the Domain and ACM Certificate to our API:</p>

<p>From the &ldquo;Custom Domain Names&rdquo; section, create a custom domain name, once you selected regional, it will ask for the target domain name, which will be the resolved to your API Endpoint that was created, and from the &ldquo;Base Path Mappings&rdquo; section, select <code>/</code> as the path to your API stage, in my case <code>url-shortener-api:test</code>:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-28-api-gateway.png" alt="" /></p>

<h2>Route 53</h2>

<p>Last part is to create a Route53 entry for tiny.yourdomain.com to resolve to the CNAME value of the target domain name that was provided in the custom domain names section:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/tiny-url-setup-29-route53.png" alt="" /></p>

<h2>Demo the URL Shortener Service:</h2>

<p>Once everything is setup we can test, by creating a Shortened URL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s2">&quot;Content-Type: application/json&quot;</span> https://tiny.myserverlessapp.net/create -d <span class="s1">&#39;{&quot;long_url&quot;: &quot;https://www.google.com/search?q=helloworld&quot;}&#39;</span>
</span><span class='line'>https://tiny.myserverlessapp.net/t/p7ISNcxTByXhN
</span></code></pre></td></tr></table></div></figure>


<p>Testing out the Short URL to redirect to the Destination URL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -ivL https://tiny.myserverlessapp.net/t/p7ISNcxTByXhN
</span><span class='line'>*   Trying 34.226.10.0...
</span><span class='line'>* TCP_NODELAY <span class="nb">set</span>
</span><span class='line'>* Connected to tiny.myserverlessapp.net <span class="o">(</span>34.226.10.0<span class="o">)</span> port <span class="m">443</span> <span class="o">(</span><span class="c">#0)</span>
</span><span class='line'>* TLS 1.2 connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
</span><span class='line'>* Server certificate: *.myserverlessapp.net
</span><span class='line'>* Server certificate: Amazon
</span><span class='line'>* Server certificate: Amazon Root CA 1
</span><span class='line'>* Server certificate: Starfield Services Root Certificate Authority - G2
</span><span class='line'>&gt; GET /t/p7ISNcxTByXhN HTTP/1.1
</span><span class='line'>&gt; Host: tiny.myserverlessapp.net
</span><span class='line'>&gt; User-Agent: curl/7.54.0
</span><span class='line'>&gt; Accept: */*
</span><span class='line'>&gt;
</span><span class='line'>&lt; HTTP/1.1 <span class="m">301</span> Moved Permanently
</span><span class='line'>HTTP/1.1 <span class="m">301</span> Moved Permanently
</span><span class='line'>&lt; Date: Tue, <span class="m">29</span> Nov <span class="m">2018</span> 00:05:02 GMT
</span><span class='line'>Date: Tue, <span class="m">29</span> Nov <span class="m">2018</span> 00:05:02 GMT
</span><span class='line'>&lt; Content-Type: application/json
</span><span class='line'>Content-Type: application/json
</span><span class='line'>&lt; Content-Length: 77
</span><span class='line'>Content-Length: 77
</span><span class='line'>&lt; Connection: keep-alive
</span><span class='line'>Connection: keep-alive
</span><span class='line'>&lt; x-amzn-RequestId: f79048c8-cb56-41e8-b21d-b45fac47453a
</span><span class='line'>x-amzn-RequestId: f79048c8-cb56-41e8-b21d-b45fac47453a
</span><span class='line'>&lt; x-amz-apigw-id: <span class="nv">OeKPHH7_DoEFdjg</span><span class="o">=</span>
</span><span class='line'>x-amz-apigw-id: <span class="nv">OeKPHH7_DoEFdjg</span><span class="o">=</span>
</span><span class='line'>&lt; Location: https://www.google.com/search?q<span class="o">=</span>helloworld
</span><span class='line'>Location: https://www.google.com/search?q<span class="o">=</span>helloworld
</span></code></pre></td></tr></table></div></figure>


<p>At this moment our API is open to the world, which is probably not the best as everyone will be able to Shorten URL&rsquo;s. You can check out <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-setup-api-key-with-console.html">Set Up API Keys Using the API Gateway Console</a> documentation on how to secure your application by utilizing a api key which can be included in your request headers when Shortening URLs.</p>

<p>For a bit of housekeeping, you can implement TTL on DynamoDB so that old items expire, which can help you to refrain your dynamodb table from growing into large amounts of storage, you can have a look at a post on <a href="https://blog.ruanbekker.com/blog/2017/11/22/delete-old-items-with-amazons-dynamodb-ttl-feature/">Delete Old Items with Amazons DynamoDB TTL Feature</a> to implement that.</p>

<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
</form>
</center>


<p><br></p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

]]></content>
  </entry>
  
</feed>
