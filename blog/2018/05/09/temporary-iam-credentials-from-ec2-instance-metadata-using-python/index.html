<p>From a Best Practice Perspective its good not having to pass sensitive information around, and especially not hard coding them.</p>

<h2>Best Practice: Security</h2>

<p>One good way is to use SSM with KMS to Encrypt/Decrypt them, but since EC2 has a <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html">Metadata Service</a> available, we can make use of that to retrieve <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp.html">temporary credentials</a>. One requirement though, is that the instance will require an IAM Role where the code will be executed on. The IAM Role also needs to have sufficient privileges to be able to execute, whatever you need to do.</p>

<p>The <a href="https://12factor.net/">12 Factor</a> Methodology however states to use config in your environment variables, but from the application logic, its easy to save it in our environment.</p>

<h2>Scenario: Applications on AWS EC2</h2>

<p>When you run applications on Amazon EC2 the nodes has access to the EC2 Metadata Service, so in this case our IAM Role has a Policy that authorizes GetItem on our DynamoDB table, therefore we can define our code with no sensitive information, as the code will do all the work to get the credentials and use the credentials to access DynamoDB.</p>

<h2>Use Temporary Credentials to Read from DynamoDB</h2>

<p>In this example we will get the temporary credentials from the metadata service, then define the temporary credentials in our session to authorize our request against dynamodb to read from our table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">botocore.utils</span> <span class="kn">import</span> <span class="n">InstanceMetadataFetcher</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">botocore.credentials</span> <span class="kn">import</span> <span class="n">InstanceMetadataProvider</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">InstanceMetadataProvider</span><span class="p">(</span><span class="n">iam_role_fetcher</span><span class="o">=</span><span class="n">InstanceMetadataFetcher</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_attempts</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">creds</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span>
</span><span class='line'>    <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">creds</span><span class="o">.</span><span class="n">access_key</span><span class="p">,</span>
</span><span class='line'>    <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">creds</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span>
</span><span class='line'>    <span class="n">aws_session_token</span><span class="o">=</span><span class="n">creds</span><span class="o">.</span><span class="n">token</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">ddb</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span>
</span><span class='line'>    <span class="n">TableName</span><span class="o">=</span><span class="s">&#39;my-dynamodb-table&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Key</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;node_type&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;S&#39;</span><span class="p">:</span> <span class="s">&#39;primary_manager&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;Item&#39;</span><span class="p">][</span><span class="s">&#39;ip&#39;</span><span class="p">][</span><span class="s">&#39;S&#39;</span><span class="p">])</span>
</span><span class='line'><span class="s">&#39;10.0.0.32</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also, when you are logged onto the EC2 instance, you can use curl to see the temporary credentials information:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ iam_role_name</span><span class="o">=</span><span class="k">$(</span>curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/<span class="k">)</span>
</span><span class='line'><span class="nv">$ </span>curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/<span class="k">${</span><span class="nv">iam_role_name</span><span class="k">}</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;Code&quot;</span> : <span class="s2">&quot;Success&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;LastUpdated&quot;</span> : <span class="s2">&quot;2018-05-09T14:25:48Z&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;Type&quot;</span> : <span class="s2">&quot;AWS-HMAC&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;AccessKeyId&quot;</span> : <span class="s2">&quot;&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;SecretAccessKey&quot;</span> : <span class="s2">&quot;&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;Token&quot;</span> : <span class="s2">&quot;&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;Expiration&quot;</span> : <span class="s2">&quot;2018-05-09T20:46:55Z&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

