
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Using the GeoIP Processor Plugin With Elasticsearch to Enrich Your Location Based Data - Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="So we have documents ingested into Elasticsearch, and one of the fields has a IP Address, but at this moment it&rsquo;s just an IP Address, the goal &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="canonical" href="http://blog.ruanbekker.com/blog/2018/09/12/using-the-geoip-processor-plugin-with-elasticsearch-to-enrich-your-location-based-data/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My HowTo Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Using the GeoIP Processor Plugin With Elasticsearch to Enrich Your Location Based Data</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-09-12T10:14:30-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>10:14 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img src="https://objects.ruanbekker.com/assets/images/kibana-map-plot-1.png" alt="" /></p>

<p>So we have documents ingested into Elasticsearch, and one of the fields has a IP Address, but at this moment it&rsquo;s just an IP Address, the goal is to have more information from this IP Address, so that we can use Kibana&rsquo;s Coordinate Maps to map our data on a Geographical Map.</p>

<p>In order to do this we need to make use of the GeoIP Ingest Processor Plugin, which adds information about the grographical location of the IP Address that it receives. This information is retrieved from the <a href="http://dev.maxmind.com/geoip/geoip2/geolite2/">Maxmind Datases</a>.</p>

<p>So when we pass our IP Address through the processor, for example one of Github&rsquo;s IP Addresses: <code>192.30.253.113</code> we will in return get:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"_source" : {
</span><span class='line'>  "geoip" : {
</span><span class='line'>    "continent_name" : "North America",
</span><span class='line'>    "city_name" : "San Francisco",
</span><span class='line'>    "country_iso_code" : "US",
</span><span class='line'>    "region_name" : "California",
</span><span class='line'>    "location" : {
</span><span class='line'>      "lon" : -122.3933,
</span><span class='line'>      "lat" : 37.7697
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "ip" : "192.30.253.113",
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Installation</h2>

<p>First we need to install the <code>ingest-geoip</code> plugin. Change to your elasticsearch home path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /usr/share/elasticsearch/
</span><span class='line'>$ sudo bin/elasticsearch-plugin install ingest-geoip</span></code></pre></td></tr></table></div></figure>


<h2>Setting up the Pipeline</h2>

<p>Now that we&rsquo;ve installed the plugin, lets setup our Pipeline where we will reference our GeoIP Processor:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPUT 'http://localhost:9200/_ingest/pipeline/geoip' -d '
</span><span class='line'>{
</span><span class='line'>  "description" : "Add GeoIP Info",
</span><span class='line'>  "processors" : [
</span><span class='line'>    {
</span><span class='line'>      "geoip" : {
</span><span class='line'>        "field" : "ip"
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  ]
</span><span class='line'>}
</span><span class='line'>'</span></code></pre></td></tr></table></div></figure>


<h2>Ingest and Test</h2>

<p>Let&rsquo;s create the Index and apply the mapping:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -XPUT <span class="s1">&#39;http://localhost:9200/my_index&#39;</span> -d <span class="s1">&#39;</span>
</span><span class='line'><span class="s1">{</span>
</span><span class='line'><span class="s1">  &quot;mappings&quot;: {</span>
</span><span class='line'><span class="s1">    &quot;doc&quot;: {</span>
</span><span class='line'><span class="s1">      &quot;properties&quot;: {</span>
</span><span class='line'><span class="s1">        &quot;geoip&quot;: {</span>
</span><span class='line'><span class="s1">          &quot;properties&quot;: {</span>
</span><span class='line'><span class="s1">            &quot;location&quot;: {</span>
</span><span class='line'><span class="s1">              &quot;type&quot;: &quot;geo_point&quot;</span>
</span><span class='line'><span class="s1">            }</span>
</span><span class='line'><span class="s1">          }</span>
</span><span class='line'><span class="s1">        }</span>
</span><span class='line'><span class="s1">      }</span>
</span><span class='line'><span class="s1">    }</span>
</span><span class='line'><span class="s1">  }</span>
</span><span class='line'><span class="s1">}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the Document and specify the pipeline name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -XPOST <span class="s1">&#39;http://localhost:9200/my_index/metrics/?pipeline=geoip&#39;</span> -d <span class="s1">&#39;</span>
</span><span class='line'><span class="s1">{</span>
</span><span class='line'><span class="s1">  &quot;identifier&quot;: &quot;github&quot;, </span>
</span><span class='line'><span class="s1">  &quot;service&quot;: &quot;test&quot;, </span>
</span><span class='line'><span class="s1">  &quot;os&quot;: &quot;linux&quot;, </span>
</span><span class='line'><span class="s1">  &quot;ip&quot;: &quot;192.30.253.113&quot;</span>
</span><span class='line'><span class="s1">}</span>
</span><span class='line'><span class="s1">&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once the document is ingested, have a look at the document:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET <span class="s1">&#39;http://localhost:9200/my_index/_search?q=identifier:github&amp;pretty&#39;</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;took&quot;</span> : 4,
</span><span class='line'>  <span class="s2">&quot;timed_out&quot;</span> : <span class="nb">false</span>,
</span><span class='line'>  <span class="s2">&quot;_shards&quot;</span> : <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;total&quot;</span> : 5,
</span><span class='line'>    <span class="s2">&quot;successful&quot;</span> : 5,
</span><span class='line'>    <span class="s2">&quot;skipped&quot;</span> : 0,
</span><span class='line'>    <span class="s2">&quot;failed&quot;</span> : 0
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="s2">&quot;hits&quot;</span> : <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;total&quot;</span> : 1,
</span><span class='line'>    <span class="s2">&quot;max_score&quot;</span> : 0.6931472,
</span><span class='line'>    <span class="s2">&quot;hits&quot;</span> : <span class="o">[</span>
</span><span class='line'>      <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;_index&quot;</span> : <span class="s2">&quot;my_index&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;_type&quot;</span> : <span class="s2">&quot;doc&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;2QVXzmUBZLvWjZA0DvLO&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;_score&quot;</span> : 0.6931472,
</span><span class='line'>        <span class="s2">&quot;_source&quot;</span> : <span class="o">{</span>
</span><span class='line'>          <span class="s2">&quot;identifier&quot;</span> : <span class="s2">&quot;github&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;geoip&quot;</span> : <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;continent_name&quot;</span> : <span class="s2">&quot;North America&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;city_name&quot;</span> : <span class="s2">&quot;San Francisco&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;country_iso_code&quot;</span> : <span class="s2">&quot;US&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;region_name&quot;</span> : <span class="s2">&quot;California&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;location&quot;</span> : <span class="o">{</span>
</span><span class='line'>              <span class="s2">&quot;lon&quot;</span> : -122.3933,
</span><span class='line'>              <span class="s2">&quot;lat&quot;</span> : 37.7697
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>,
</span><span class='line'>          <span class="s2">&quot;service&quot;</span> : <span class="s2">&quot;test&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;ip&quot;</span> : <span class="s2">&quot;192.30.253.113&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;os&quot;</span> : <span class="s2">&quot;linux&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Kibana</h2>

<p>Let&rsquo;s plot our data on Kibana:</p>

<ul>
<li>From Management: Select Index Patterns, Create index pattern, set: <code>my_index</code></li>
<li>From Visualize: Select Geo Coordinates, select your index: <code>my_index</code></li>
<li>From Buckets select Geo Corrdinates, Aggregation by GeoHash, then field, select <code>geoip.location</code> then hit run and you should see something like this:</li>
</ul>


<p><img src="https://objects.ruanbekker.com/assets/images/kibana-geoip-1.png" alt="" /></p>

<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/blog/geoip-in-the-elastic-stack">https://www.elastic.co/blog/geoip-in-the-elastic-stack</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/plugins/5.3/using-ingest-geoip.html">https://www.elastic.co/guide/en/elasticsearch/plugins/5.3/using-ingest-geoip.html</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.3/put-pipeline-api.html">https://www.elastic.co/guide/en/elasticsearch/reference/5.3/put-pipeline-api.html</a></li>
<li><a href="https://ring.nlnog.net/api/1.0/nodes">https://ring.nlnog.net/api/1.0/nodes</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ruan</span></span>

      




<time class='entry-date' datetime='2018-09-12T10:14:30-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>10:14 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a>, <a class='category' href='/blog/categories/geoip/'>geoip</a>, <a class='category' href='/blog/categories/location/'>location</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.ruanbekker.com/blog/2018/09/12/using-the-geoip-processor-plugin-with-elasticsearch-to-enrich-your-location-based-data/" data-via="ruanbekker" data-counturl="http://blog.ruanbekker.com/blog/2018/09/12/using-the-geoip-processor-plugin-with-elasticsearch-to-enrich-your-location-based-data/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2018/09/05/investigating-high-request-latencies-on-amazon-dynamodb/" title="Previous Post: Investigating High Request Latencies on Amazon DynamoDB">&laquo; Investigating High Request Latencies on Amazon DynamoDB</a>
      
      
        <a class="basic-alignment right" href="/blog/2018/10/04/splitting-query-string-parameters-from-a-url-in-python/" title="Next Post: Splitting Query String Parameters from a URL in Python">Splitting Query String Parameters from a URL in Python &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/10/23/building-a-raspberry-pi-nginx-image-with-caching-on-alpine-for-docker-swarm/">Building a Raspberry Pi Nginx Image With Caching on Alpine for Docker Swarm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/23/nginx-caching-performance-for-static-content-on-docker-swarm-with-raspberrypi/">Nginx Caching Performance for Static Content on Docker Swarm With RaspberryPi</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/23/setting-up-a-docker-swarm-cluster-on-3-raspberrypi-nodes/">Setting Up a Docker Swarm Cluster on 3 RaspberryPi Nodes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/23/my-pistack-blog-proudly-hosted-on-my-raspberrypi-swarm-cluster/">My PiStack Blog Proudly Hosted on My RaspberryPi Swarm Cluster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/11/capturing-54-million-passwords-with-a-docker-ssh-honeypot/">Capturing 54 Million Passwords With a Docker SSH Honeypot</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.ruanbekker.com/blog/2018/09/12/using-the-geoip-processor-plugin-with-elasticsearch-to-enrich-your-location-based-data/';
        var disqus_url = 'http://blog.ruanbekker.com/blog/2018/09/12/using-the-geoip-processor-plugin-with-elasticsearch-to-enrich-your-location-based-data/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
