
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How to Deploy a Docker Swarm Cluster on Scaleway With Terraform - Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="We will deploy a 3 node docker swarm cluster with terraform on scaleway. I have used the base source code from this repository but tweaked the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="http://blog.ruanbekker.com/blog/2019/03/21/how-to-deploy-a-docker-swarm-cluster-on-scaleway-with-terraform/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.ruan.dev/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How to Deploy a Docker Swarm Cluster on Scaleway With Terraform</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-21T08:15:07+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2019</span></span> <span class='time'>8:15 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/54737111-09fa2e80-4bb7-11e9-97f4-a94a31fc9a3a.png" alt="" /></p>

<p>We will deploy a 3 node docker swarm cluster with terraform on scaleway. I have used the base source code from <a href="https://github.com/stefanprodan/scaleway-swarm-terraform">this</a> repository but tweaked the configuration to my needs.</p>

<h2>Pre-Requisites</h2>

<p>Ensure terraform and jq is instaled:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install terraform
</span><span class='line'><span class="nv">$ </span>brew install jq
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform</h2>

<p>You can have a look at the linked source at the top for the source code, but below I will provide each file that will make up our terraform deployment.</p>

<p>Ource <code>main.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>provider <span class="s2">&quot;scaleway&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">region</span> <span class="o">=</span> <span class="s2">&quot;${var.region}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;scaleway_bootscript&quot;</span> <span class="s2">&quot;debian&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">architecture</span> <span class="o">=</span> <span class="s2">&quot;x86_64&quot;</span>
</span><span class='line'>  <span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;x86_64 mainline 4.15.11 rev1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;scaleway_image&quot;</span> <span class="s2">&quot;debian_stretch&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">architecture</span> <span class="o">=</span> <span class="s2">&quot;x86_64&quot;</span>
</span><span class='line'>  <span class="nv">name</span>         <span class="o">=</span> <span class="s2">&quot;Debian Stretch&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;template_file&quot;</span> <span class="s2">&quot;docker_conf&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">template</span> <span class="o">=</span> <span class="s2">&quot;${file(&quot;</span>conf/docker.tpl<span class="s2">&quot;)}&quot;</span>
</span><span class='line'>
</span><span class='line'>  vars <span class="o">{</span>
</span><span class='line'>    <span class="nv">ip</span> <span class="o">=</span> <span class="s2">&quot;${var.docker_api_ip}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>outputs.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>output <span class="s2">&quot;swarm_manager_public_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;swarm_manager_private_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_server.swarm_manager.0.private_ip}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;swarm_workers_public_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${concat(scaleway_server.swarm_worker.*.name, scaleway_server.swarm_worker.*.public_ip)}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;swarm_workers_private_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${concat(scaleway_server.swarm_worker.*.name, scaleway_server.swarm_worker.*.private_ip)}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;workspace&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${terraform.workspace}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>security-groups.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;scaleway_security_group&quot;</span> <span class="s2">&quot;swarm_managers&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>        <span class="o">=</span> <span class="s2">&quot;swarm_managers&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;Allow HTTP/S and SSH traffic&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;ssh_accept&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 22
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;http_accept&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 80
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;https_accept&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 443
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group&quot;</span> <span class="s2">&quot;swarm_workers&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>        <span class="o">=</span> <span class="s2">&quot;swarm_workers&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;Allow SSH traffic&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;ssh_accept_workers&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_workers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 22
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>variables.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>variable <span class="s2">&quot;docker_version&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;18.06.3~ce~3-0~debian&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;region&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;ams1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;manager_instance_type&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;START1-M&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;worker_instance_type&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;START1-M&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;worker_instance_count&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> 2
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;docker_api_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>managers.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;scaleway_ip&quot;</span> <span class="s2">&quot;swarm_manager_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span> <span class="o">=</span> 1
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_server&quot;</span> <span class="s2">&quot;swarm_manager&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>          <span class="o">=</span> 1
</span><span class='line'>  <span class="nv">name</span>           <span class="o">=</span> <span class="s2">&quot;${terraform.workspace}-manager-${count.index + 1}&quot;</span>
</span><span class='line'>  <span class="nv">image</span>          <span class="o">=</span> <span class="s2">&quot;${data.scaleway_image.debian_stretch.id}&quot;</span>
</span><span class='line'>  <span class="nb">type</span>           <span class="o">=</span> <span class="s2">&quot;${var.manager_instance_type}&quot;</span>
</span><span class='line'>  <span class="nv">bootscript</span>     <span class="o">=</span> <span class="s2">&quot;${data.scaleway_bootscript.debian.id}&quot;</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>  <span class="nv">public_ip</span>      <span class="o">=</span> <span class="s2">&quot;${element(scaleway_ip.swarm_manager_ip.*.ip, count.index)}&quot;</span>
</span><span class='line'>
</span><span class='line'>  volume <span class="o">{</span>
</span><span class='line'>    <span class="nv">size_in_gb</span> <span class="o">=</span> 50
</span><span class='line'>    <span class="nb">type</span>       <span class="o">=</span> <span class="s2">&quot;l_ssd&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">script</span> <span class="o">=</span> <span class="s2">&quot;scripts/mount-disk.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  connection <span class="o">{</span>
</span><span class='line'>    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>    <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="nv">private_key</span> <span class="o">=</span> <span class="s2">&quot;${file(&quot;</span>~/.ssh/id_rsa<span class="s2">&quot;)}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;mkdir -p /etc/systemd/system/docker.service.d&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">content</span>     <span class="o">=</span> <span class="s2">&quot;${data.template_file.docker_conf.rendered}&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/etc/systemd/system/docker.service.d/docker.conf&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/install-docker-ce.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/install-docker-ce.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/local-persist-plugin.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/install-docker-ce.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/install-docker-ce.sh ${var.docker_version}&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;docker swarm init --advertise-addr ${self.private_ip}&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/local-persist-plugin.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>workers.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;scaleway_ip&quot;</span> <span class="s2">&quot;swarm_worker_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span> <span class="o">=</span> <span class="s2">&quot;${var.worker_instance_count}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_server&quot;</span> <span class="s2">&quot;swarm_worker&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>          <span class="o">=</span> <span class="s2">&quot;${var.worker_instance_count}&quot;</span>
</span><span class='line'>  <span class="nv">name</span>           <span class="o">=</span> <span class="s2">&quot;${terraform.workspace}-worker-${count.index + 1}&quot;</span>
</span><span class='line'>  <span class="nv">image</span>          <span class="o">=</span> <span class="s2">&quot;${data.scaleway_image.debian_stretch.id}&quot;</span>
</span><span class='line'>  <span class="nb">type</span>           <span class="o">=</span> <span class="s2">&quot;${var.worker_instance_type}&quot;</span>
</span><span class='line'>  <span class="nv">bootscript</span>     <span class="o">=</span> <span class="s2">&quot;${data.scaleway_bootscript.debian.id}&quot;</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_workers.id}&quot;</span>
</span><span class='line'>  <span class="nv">public_ip</span>      <span class="o">=</span> <span class="s2">&quot;${element(scaleway_ip.swarm_worker_ip.*.ip, count.index)}&quot;</span>
</span><span class='line'>
</span><span class='line'>  volume <span class="o">{</span>
</span><span class='line'>    <span class="nv">size_in_gb</span> <span class="o">=</span> 50
</span><span class='line'>    <span class="nb">type</span>       <span class="o">=</span> <span class="s2">&quot;l_ssd&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">script</span> <span class="o">=</span> <span class="s2">&quot;scripts/mount-disk.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  connection <span class="o">{</span>
</span><span class='line'>    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>    <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="nv">private_key</span> <span class="o">=</span> <span class="s2">&quot;${file(&quot;</span>~/.ssh/id_rsa<span class="s2">&quot;)}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;mkdir -p /etc/systemd/system/docker.service.d&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">content</span>     <span class="o">=</span> <span class="s2">&quot;${data.template_file.docker_conf.rendered}&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/etc/systemd/system/docker.service.d/docker.conf&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/install-docker-ce.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/install-docker-ce.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/local-persist-plugin.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/install-docker-ce.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/install-docker-ce.sh ${var.docker_version}&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;docker swarm join --token ${data.external.swarm_tokens.result.worker} ${scaleway_server.swarm_manager.0.private_ip}:2377&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/local-persist-plugin.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">when</span> <span class="o">=</span> <span class="s2">&quot;destroy&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;docker node update --availability drain ${self.name}&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">on_failure</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>
</span><span class='line'>
</span><span class='line'>    connection <span class="o">{</span>
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>      <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>      <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">when</span> <span class="o">=</span> <span class="s2">&quot;destroy&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;docker swarm leave&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">on_failure</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">when</span> <span class="o">=</span> <span class="s2">&quot;destroy&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;docker node rm --force ${self.name}&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">on_failure</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>
</span><span class='line'>
</span><span class='line'>    connection <span class="o">{</span>
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>      <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>      <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;external&quot;</span> <span class="s2">&quot;swarm_tokens&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">program</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;./scripts/fetch-tokens.sh&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">query</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">depends_on</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;scaleway_server.swarm_manager&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our config for the docker daemon: <code>conf/docker.tpl</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/dockerd -H fd:// <span class="se">\</span>
</span><span class='line'>  -H tcp://<span class="k">${</span><span class="nv">ip</span><span class="k">}</span>:2375 <span class="se">\</span>
</span><span class='line'>  --storage-driver<span class="o">=</span>overlay2 <span class="se">\</span>
</span><span class='line'>  --dns 8.8.4.4 --dns 8.8.8.8 <span class="se">\</span>
</span><span class='line'>  --log-driver json-file <span class="se">\</span>
</span><span class='line'>  --log-opt max-size<span class="o">=</span>50m --log-opt max-file<span class="o">=</span><span class="m">10</span> <span class="se">\</span>
</span><span class='line'>  --experimental<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class='line'>  --metrics-addr 172.17.0.1:9323
</span></code></pre></td></tr></table></div></figure>


<p>Our script to mount our additional disk: <code>scripts/mount-disk.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>apt update
</span><span class='line'>apt install xfsprogs attr -y
</span><span class='line'>mkfs -t xfs /dev/vdb
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;/dev/vdb /mnt xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab
</span><span class='line'>mount -a
</span></code></pre></td></tr></table></div></figure>


<p>Our script to install docker: <code>scripts/install-docker-ce.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="nv">DOCKER_VERSION</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get -qq update
</span><span class='line'>apt-get -qq install apt-transport-https ca-certificates curl software-properties-common
</span><span class='line'>curl -fsSL https://download.docker.com/linux/debian/gpg <span class="p">|</span> sudo apt-key add -
</span><span class='line'>add-apt-repository <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable&quot;</span>
</span><span class='line'>
</span><span class='line'>apt-get -q update -y
</span><span class='line'>apt-get -q install -y docker-ce<span class="o">=</span><span class="nv">$DOCKER_VERSION</span> containerd.io
</span></code></pre></td></tr></table></div></figure>


<p>Our script that retrieves the swarm tokens: <code>scripts/fetch-tokens.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Processing JSON in shell scripts</span>
</span><span class='line'><span class="c"># https://www.terraform.io/docs/providers/external/data_source.html#processing-json-in-shell-scripts</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="c"># Extract &quot;host&quot; argument from the input into HOST shell variable</span>
</span><span class='line'><span class="nb">eval</span> <span class="s2">&quot;$(jq -r &#39;@sh &quot;</span><span class="nv">HOST</span><span class="o">=</span><span class="se">\(</span>.host<span class="o">)</span><span class="s2">&quot;&#39;)&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">MANAGER</span><span class="o">=</span><span class="k">$(</span>ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null root@<span class="nv">$HOST</span> docker swarm join-token manager -q<span class="k">)</span>
</span><span class='line'><span class="nv">WORKER</span><span class="o">=</span><span class="k">$(</span>ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null root@<span class="nv">$HOST</span> docker swarm join-token worker -q<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># produce a json object containing the tokens</span>
</span><span class='line'>jq -n --arg manager <span class="s2">&quot;$MANAGER&quot;</span> --arg worker <span class="s2">&quot;$WORKER&quot;</span> <span class="s1">&#39;{&quot;manager&quot;:$manager,&quot;worker&quot;:$worker}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our script to install the <a href="https://github.com/CWSpear/local-persist">local-persist docker volume</a> plugin: <code>scripts/local-persist-plugin.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>curl -fsSL https://raw.githubusercontent.com/CWSpear/local-persist/master/scripts/install.sh <span class="p">|</span> bash
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy your Swarm</h2>

<p>Note that we will be deploying 3x SMART1-M servers with Debian Stretch. At this moment the image id is the one of debian stretch but may change in the future. If you want to change the distro, update the install script, and the terraform files.</p>

<p><a href="https://www.scaleway.com/docs/generate-an-api-token/">Generate API Token on Scaleway</a> then export it to your current shell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">SCALEWAY_ORGANIZATION</span><span class="o">=</span><span class="s2">&quot;&lt;organization-id&gt;&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">SCALEWAY_TOKEN</span><span class="o">=</span><span class="s2">&quot;&lt;secret&gt;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure that your ssh private key is the intended one as in the config, in my example: <code>~/.ssh/id_rsa</code> and that they are allowed in your servers <code>authorized_keys</code> file</p>

<p>Create a new workspace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform new workspace swarm
</span></code></pre></td></tr></table></div></figure>


<p>Pull down the providers and initialize:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Deploy!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform apply
</span><span class='line'>...
</span><span class='line'>...
</span><span class='line'>scaleway_server.swarm_worker<span class="o">[</span>0<span class="o">]</span>: Creation <span class="nb">complete </span>after 4m55s <span class="o">(</span>ID: xx-xx-xx-xx-xx<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Apply <span class="nb">complete</span>! Resources: <span class="m">14</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span><span class='line'>Outputs:
</span><span class='line'>
</span><span class='line'><span class="nv">swarm_manager_private_ip</span> <span class="o">=</span> 10.21.x.x
</span><span class='line'><span class="nv">swarm_manager_public_ip</span> <span class="o">=</span> 51.xx.xx.xx
</span><span class='line'><span class="nv">swarm_workers_private_ip</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    swarm-worker-1,
</span><span class='line'>    swarm-worker-2,
</span><span class='line'>    10.20.xx.xx,
</span><span class='line'>    10.20.xx.xx,
</span><span class='line'><span class="o">]</span>
</span><span class='line'><span class="nv">swarm_workers_public_ip</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    swarm-worker-1,
</span><span class='line'>    swarm-worker-2,
</span><span class='line'>    51.xx.xx.xx,
</span><span class='line'>    51.xx.xx.xx,
</span><span class='line'><span class="o">]</span>
</span><span class='line'><span class="nv">workspace</span> <span class="o">=</span> swarm
</span></code></pre></td></tr></table></div></figure>


<p>Once your deployment is done you will be prompted with the public/private ip addresses of your nodes as seen above, you can also manually retrieve them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform terraform output
</span></code></pre></td></tr></table></div></figure>


<p>Or for a specific node, such as the manager:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform terraform output swarm-manager
</span><span class='line'>51.xx.xx.xx
</span></code></pre></td></tr></table></div></figure>


<p>Go ahead and ssh to your manager nodes and list the swarm nodes, boom, easy right.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker node ls
</span><span class='line'>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
</span><span class='line'>2696o0vrt93x8qf2gblbfc8pf *   swarm-manager       Ready               Active              Leader              18.09.3
</span><span class='line'>72ava7rrp2acnyadisg52n7ym     swarm-worker-1      Ready               Active                                  18.09.3
</span><span class='line'>sy2otqn20qe9jc2v9io3a21jm     swarm-worker-2      Ready               Active                                  18.09.3
</span></code></pre></td></tr></table></div></figure>


<p>When you want to destroy the environment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform destroy -force
</span></code></pre></td></tr></table></div></figure>


<h2>References:</h2>

<p>Big thanks goes to <a href="https://github.com/stefanprodan">@stefanprodan</a></p>

<ul>
<li><a href="https://www.terraform.io/docs/index.html">https://www.terraform.io/docs/index.html</a></li>
<li><a href="https://docs.docker.com/engine/swarm/">https://docs.docker.com/engine/swarm/</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ruan</span></span>

      




<time class='entry-date' datetime='2019-03-21T08:15:07+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2019</span></span> <span class='time'>8:15 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/docker/'>docker</a>, <a class='category' href='/blog/categories/scaleway/'>scaleway</a>, <a class='category' href='/blog/categories/swarm/'>swarm</a>, <a class='category' href='/blog/categories/terraform/'>terraform</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.ruanbekker.com/blog/2019/03/21/how-to-deploy-a-docker-swarm-cluster-on-scaleway-with-terraform/" data-via="ruanbekker" data-counturl="http://blog.ruanbekker.com/blog/2019/03/21/how-to-deploy-a-docker-swarm-cluster-on-scaleway-with-terraform/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2019/03/21/deploy-scaleway-servers-via-the-api-in-python/" title="Previous Post: Deploy Scaleway Servers via the API in Python">&laquo; Deploy Scaleway Servers via the API in Python</a>
      
      
        <a class="basic-alignment right" href="/blog/2019/03/27/ship-your-logs-to-elasticsearch-with-filebeat/" title="Next Post: Ship your Logs to Elasticsearch with Filebeat">Ship your Logs to Elasticsearch with Filebeat &raquo;</a>
      
    </p>
  </footer>
</article>
<!-- google advertisements
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>

-->

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/09/08/reindex-elasticsearch-indices-with-logstash/">Reindex Elasticsearch Indices With Logstash</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/09/05/deploy-a-monitoring-stack-on-docker-swarm-with-grafana-and-prometheus/">Deploy a Monitoring Stack on Docker Swarm With Grafana and Prometheus</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/09/04/deploy-traefik-using-bekker-stacks/">Deploy Traefik Using Bekker Stacks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/09/04/aws-s3-kms-and-python-for-secrets-management/">AWS S3 KMS and Python for Secrets Management</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/07/making-deploying-functions-even-easier-with-faas-cli-up-using-openfaas/">Making Deploying Functions Even Easier With Faas-cli Up Using OpenFaaS</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.ruanbekker.com/blog/2019/03/21/how-to-deploy-a-docker-swarm-cluster-on-scaleway-with-terraform/';
        var disqus_url = 'http://blog.ruanbekker.com/blog/2019/03/21/how-to-deploy-a-docker-swarm-cluster-on-scaleway-with-terraform/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>

</body>
</html>
