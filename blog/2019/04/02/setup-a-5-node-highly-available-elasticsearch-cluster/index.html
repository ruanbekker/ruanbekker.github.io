
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Setup a 5 Node Highly Available Elasticsearch Cluster - Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="Deploy a highly available 5 node elasticsearch cluster with elasticsearch master and elasticsearch data nodes. search and analytic engine on ubuntu &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/blog/2019/04/02/setup-a-5-node-highly-available-elasticsearch-cluster/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script async defer data-website-id="2cfa7c36-c1f7-48fd-949c-2e5e8a1d873d" src="https://umami-analytics.ruan.dev/umami.js"></script>

  <!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1100086574264181"
     crossorigin="anonymous"></script>

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="Setup a 5 Node Highly Available Elasticsearch Cluster">


<meta name="twitter:description" content="Deploy a highly available 5 node elasticsearch cluster with elasticsearch master and elasticsearch data nodes. search and analytic engine on ubuntu linux.">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Setup a 5 Node Highly Available Elasticsearch Cluster</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-02T05:05:19-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2019</span></span> <span class='time'>5:05 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53352581-b3892f80-392b-11e9-9532-5db5cbfc8f1c.jpg" alt="elasticsearch" /></p>

<p>This is post 1 of my big collection of <strong><a href="https://blog.ruanbekker.com/blog/categories/elasticsearch-tutorials">elasticsearch-tutorials</a></strong> which includes, setup, index, management, searching, etc. More details at the bottom.</p>

<p>In this tutorial we will setup a <strong>5 node highly available elasticsearch cluster</strong> that will consist of 3 Elasticsearch Master Nodes and 2 Elasticsearch Data Nodes.</p>

<blockquote><p>&ldquo;Three master nodes is the way to start, but only if you&rsquo;re building a full cluster, which at minimum is 3 master nodes plus at least 2 data nodes.&rdquo;
 - <a href="https://discuss.elastic.co/t/should-dedicated-master-nodes-and-data-nodes-be-considered-separately/75093/14">https://discuss.elastic.co/t/should-dedicated-master-nodes-and-data-nodes-be-considered-separately/75093/14</a></p></blockquote>

<p><a href="https://github.com/ruanbekker/cheatsheets" target="_blank"><img alt="ruanbekker-cheatsheets" src="https://user-images.githubusercontent.com/567298/169162832-ef3019de-bc49-4d6c-b2a6-8ac17c457d24.png"></a></p>

<h2>The Overview:</h2>

<p>In short the responsibilites of the node types:</p>

<p><strong>Master Nodes</strong>: Master nodes are responsible for Cluster related tasks, creating / deleting indexes, tracking of nodes, allocate shards to nodes, etc.</p>

<p><strong>Data Nodes</strong>: Data nodes are responsible for hosting the actual shards that has the indexed data also handles data related operations like CRUD, search, and aggregations.</p>

<p>For more concepts of Elasticsearch, have a look at their <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-concepts.html">basic-concepts</a> documentation.</p>

<p>Our Inventory will consist of:</p>

<p><strong>Master Nodes:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Hostname: es-master-1, Private IP: 172.31.0.77
</span><span class='line'>Hostname: es-master-2, Private IP: 172.31.0.45
</span><span class='line'>Hostname: es-master-3, Private IP: 172.31.1.31</span></code></pre></td></tr></table></div></figure>


<p><strong>Data Nodes:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Hostname: es-data-1, Private IP:172.31.2.30
</span><span class='line'>Hostname: es-data-2, Private IP:172.31.0.83</span></code></pre></td></tr></table></div></figure>


<p><strong>Reserved Volumes</strong> for Data Nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>es-data-1: 10GB assigned to /dev/vdb
</span><span class='line'>es-data-2: 10GB assigned to /dev/vdb</span></code></pre></td></tr></table></div></figure>


<p><strong>Authentication:</strong></p>

<p>Note that I have configured the bind address for elasticsearch to <code>0.0.0.0</code> using <code>network.host: 0.0.0.0</code> for this demonstration, but this means that if your server has a public ip address with no firewall rules or no auth, that anyone will be able to interact with your cluster.</p>

<p>This address will also be reachable for all nodes to see each other.</p>

<p>It&rsquo;s advisable do protect your endpoint, either with <a href="https://blog.ruanbekker.com/blog/2017/08/31/secure-your-access-to-kibana-5-and-elasticsearch-5-with-nginx-for-aws/">basic auth using nginx</a> which can be found in the embedded link, or using firewall rules to protect communication from the outside (depending on your setup)</p>

<h2>Setup the Elasticsearch Master Nodes</h2>

<p>The setup below how to provision a elasticsearch master node. Repeat this on node: <code>es-master-1</code>, <code>es-master-2</code>, <code>es-master-3</code></p>

<p>Set your hosts file for name resolution (if you don&rsquo;t have private dns in place):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/hosts &lt;&lt; EOF
</span><span class='line'>127.0.0.1 localhost
</span><span class='line'>172.31.0.77 es-master-1
</span><span class='line'>172.31.0.45 es-master-2
</span><span class='line'>172.31.1.31 es-master-3
</span><span class='line'>172.31.2.30 es-data-1
</span><span class='line'>172.31.0.83 es-data-2
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Get the elasticsearch repositories, install the java development kit dependency and install elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt upgrade -y
</span><span class='line'>$ apt install software-properties-common python-software-properties apt-transport-https -y
</span><span class='line'>$ wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
</span><span class='line'>$ echo "deb https://artifacts.elastic.co/packages/6.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list
</span><span class='line'>$ apt update
</span><span class='line'>$ apt install default-jdk -y
</span><span class='line'>$ apt install elasticsearch -y</span></code></pre></td></tr></table></div></figure>


<p>The elasticsearch config, before we get to the full example config, I just want to show a snippet of how you could split up logs and data.</p>

<p>Note that you can seperate your logging between data/logs like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># example of log splitting:
</span><span class='line'>...
</span><span class='line'>path:
</span><span class='line'>  logs: /var/log/elasticsearch
</span><span class='line'>  data: /var/data/elasticsearch
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Also, your data can be divided between paths:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># example of data paths:
</span><span class='line'>...
</span><span class='line'>path:
</span><span class='line'>  data:
</span><span class='line'>    - /mnt/elasticsearch_1
</span><span class='line'>    - /mnt/elasticsearch_2
</span><span class='line'>    - /mnt/elasticsearch_3
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Bootstrap the elasticsearch config with a cluster name (all the nodes should have the same cluster name), set the nodes as master <code>node.master: true</code> disable the <code>node.data</code> and specify that the cluster should at least have a minimum of 2 master nodes before it stops. This is used to prevent split brain.</p>

<p>To avoid a split brain, this setting should be set to a quorum of master-eligible nodes:
<code>(master_eligible_nodes / 2) + 1</code></p>

<p>The full example config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/elasticsearch/elasticsearch.yml &lt;&lt; EOF
</span><span class='line'>cluster.name: es-cluster
</span><span class='line'>node.name: \${HOSTNAME}
</span><span class='line'>node.master: true
</span><span class='line'>node.data: false
</span><span class='line'>path.logs: /var/log/elasticsearch
</span><span class='line'>bootstrap.memory_lock: true
</span><span class='line'>network.host: 0.0.0.0
</span><span class='line'>discovery.zen.minimum_master_nodes: 2
</span><span class='line'>discovery.zen.ping.unicast.hosts: ["es-master-1", "es-master-2", "es-master-3"]
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Important settings for your elasticsearch cluster is described on their <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html">docs</a>:</p>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-configuration-memory.html">Disable swapping</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/file-descriptors.html">Increase file descriptors</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html">Ensure sufficient virtual memory</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/max-number-of-threads.html">Ensure sufficient threads</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/networkaddress-cache-ttl.html">JVM DNS cache settings</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/executable-jna-tmpdir.html">Temporary directory not mounted with noexec</a></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/default/elasticsearch &lt;&lt; EOF
</span><span class='line'>ES_STARTUP_SLEEP_TIME=5
</span><span class='line'>MAX_OPEN_FILES=65536
</span><span class='line'>MAX_LOCKED_MEMORY=unlimited
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Ensure that pages are not swapped out to disk by requesting the JVM to lock the heap in memory by setting <code>LimitMEMLOCK=infinity</code>. Set the maxiumim file descriptor number for this process: <code>LimitNOFILE</code> and increase the number of threads using <code>LimitNPROC</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /usr/lib/systemd/system/elasticsearch.service
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>LimitMEMLOCK=infinity
</span><span class='line'>LimitNOFILE=65535
</span><span class='line'>LimitNPROC=4096
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Increase the limit on the number of open files descriptors to user elasticsearch of 65536 or higher</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/security/limits.conf &lt;&lt; EOF
</span><span class='line'>elasticsearch soft memlock unlimited
</span><span class='line'>elasticsearch hard memlock unlimited
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Increase the value of the mmap counts as elasticsearch uses mmapfs directory to store its indices:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -w vm.max_map_count=262144</span></code></pre></td></tr></table></div></figure>


<p>For a permanent setting, update <code>vm.max_map_count</code> in <code>/etc/sysctl.conf</code> and run</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -p /etc/sysctl.conf </span></code></pre></td></tr></table></div></figure>


<p>Prepare the directories and set the ownership to elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /usr/share/elasticsearch/data
</span><span class='line'>$ chown -R elasticsearch:elasticsearch /usr/share/elasticsearch/data</span></code></pre></td></tr></table></div></figure>


<p>Reload the systemd daemon, enable and start elasticsearch</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl enable elasticsearch
</span><span class='line'>$ systemctl restart elasticsearch</span></code></pre></td></tr></table></div></figure>


<p>Once all 3 elasticsearch masters has been started, verify that they are listening: <code>netstat -tulpn | grep 9200</code> then look at the cluster health:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cluster/health?pretty
</span><span class='line'>{
</span><span class='line'>  "cluster_name" : "es-cluster",
</span><span class='line'>  "status" : "green",
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "number_of_nodes" : 3,
</span><span class='line'>  "number_of_data_nodes" : 0,
</span><span class='line'>  "active_primary_shards" : 0,
</span><span class='line'>  "active_shards" : 0,
</span><span class='line'>  "relocating_shards" : 0,
</span><span class='line'>  "initializing_shards" : 0,
</span><span class='line'>  "unassigned_shards" : 0,
</span><span class='line'>  "delayed_unassigned_shards" : 0,
</span><span class='line'>  "number_of_pending_tasks" : 0,
</span><span class='line'>  "number_of_in_flight_fetch" : 0,
</span><span class='line'>  "task_max_waiting_in_queue_millis" : 0,
</span><span class='line'>  "active_shards_percent_as_number" : 100.0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Have a look at the nodes, you will see that the node.role for now shows <code>mi</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/nodes?v
</span><span class='line'>ip          heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>10.163.68.8           11          80  18    0.28    0.14     0.09 mi        -      es-master-2
</span><span class='line'>10.163.68.5           14          80  14    0.27    0.18     0.11 mi        *      es-master-1
</span><span class='line'>10.163.68.4           15          79   6    0.62    0.47     0.18 mi        -      es-master-3</span></code></pre></td></tr></table></div></figure>


<h2>Setup the Elasticsearch Data Nodes</h2>

<p>Now that we have our 3 elasticsearch master nodes running, its time to provision the 2 elasticsearch data nodes. This setup needs to be repeated on both <code>es-data-1</code> and <code>es-data-2</code>.</p>

<p>Configure the hosts file for name resolution:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/hosts &lt;&lt; EOF
</span><span class='line'>127.0.0.1 localhost
</span><span class='line'>172.31.0.77 es-master-1
</span><span class='line'>172.31.0.45 es-master-2
</span><span class='line'>172.31.1.31 es-master-3
</span><span class='line'>172.31.2.30 es-data-1
</span><span class='line'>172.31.0.83 es-data-2
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Get the elasticsearch repositories, install the java development kit dependency and install elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt upgrade -y
</span><span class='line'>$ apt install software-properties-common python-software-properties apt-transport-https -y
</span><span class='line'>$ wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -
</span><span class='line'>$ echo "deb https://artifacts.elastic.co/packages/6.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list
</span><span class='line'>$ apt update
</span><span class='line'>$ apt install default-jdk -y
</span><span class='line'>$ apt install elasticsearch -y</span></code></pre></td></tr></table></div></figure>


<p>Since we attached an extra disk to our data nodes, verify that you can see the disk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ lsblk
</span><span class='line'>NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
</span><span class='line'>vda    253:0    0  25G  0 disk
</span><span class='line'>└─vda1 253:1    0  25G  0 part /
</span><span class='line'>vdb    253:16   0  10G  0 disk             &lt;----</span></code></pre></td></tr></table></div></figure>


<p>Provision the block device with xfs or anything else that you prefer, create the directory where elasticsearch data will reside, change the ownership that elasticsearch has permission to write/read, set the device on startup and mount the disk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkfs.xfs /dev/vdb
</span><span class='line'>$ mkdir /data
</span><span class='line'>$ mkdir /data/nodes
</span><span class='line'>$ chown -R elasticsearch:elasticsearch /data
</span><span class='line'>$ chown -R elasticsearch:elasticsearch /data/nodes
</span><span class='line'>$ echo '/dev/vdb /data xfs defaults 0 0' &gt;&gt; /etc/fstab
</span><span class='line'>$ mount -a</span></code></pre></td></tr></table></div></figure>


<p>Verify that the disk is mounted:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>udev            994M     0  994M   0% /dev
</span><span class='line'>tmpfs           201M  3.1M  197M   2% /run
</span><span class='line'>/dev/vda1        25G  1.8G   23G   8% /
</span><span class='line'>/dev/vdb         10G   33M   10G   1% /data</span></code></pre></td></tr></table></div></figure>


<p>Bootstrap the elasticsearch config with a cluster name, set the <code>node.name</code> to an identifier, in this case I will use the servers hostname, set the <code>node.master</code> to false as this will be data nodes, also enable these nodes as data nodes: <code>node.data: true</code>, configure the <code>path.data: /data</code> to the path that we configured, etc:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/elasticsearch/elasticsearch.yml &lt;&lt; EOF
</span><span class='line'>cluster.name: es-cluster
</span><span class='line'>node.name: \${HOSTNAME}
</span><span class='line'>node.master: false
</span><span class='line'>node.data: true
</span><span class='line'>path.data: /data
</span><span class='line'>path.logs: /var/log/elasticsearch
</span><span class='line'>bootstrap.memory_lock: true
</span><span class='line'>network.host: 0.0.0.0
</span><span class='line'>discovery.zen.minimum_master_nodes: 2
</span><span class='line'>discovery.zen.ping.unicast.hosts: ["es-master-1", "es-master-2", "es-master-3"]
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Set a couple of important settings for your elasticsearch cluster is described on their <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/system-config.html">docs</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/default/elasticsearch &lt;&lt; EOF
</span><span class='line'>ES_STARTUP_SLEEP_TIME=5
</span><span class='line'>MAX_OPEN_FILES=65536
</span><span class='line'>MAX_LOCKED_MEMORY=unlimited
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Disable swapping, increase the file descriptors and increase the maximum number of threads:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /usr/lib/systemd/system/elasticsearch.service
</span><span class='line'>[Service]
</span><span class='line'>LimitMEMLOCK=infinity
</span><span class='line'>LimitNOFILE=65535
</span><span class='line'>LimitNPROC=4096</span></code></pre></td></tr></table></div></figure>


<p>Also update them via limits.conf:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/security/limits.conf &lt;&lt; EOF
</span><span class='line'>elasticsearch soft memlock unlimited
</span><span class='line'>elasticsearch hard memlock unlimited
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Reload the systemd daemon, enable and start elasticsearch. Allow it to start and check if the ports are listening with <code>netstat -tulpn | grep 9200</code>, then:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl enable elasticsearch
</span><span class='line'>$ systemctl restart elasticsearch</span></code></pre></td></tr></table></div></figure>


<p>Verify that everything works as expected, look at the cluster health and look at the status and number of nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cluster/health?pretty
</span><span class='line'>{
</span><span class='line'>  "cluster_name" : "es-cluster",
</span><span class='line'>  "status" : "green",
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "number_of_nodes" : 5,
</span><span class='line'>  "number_of_data_nodes" : 2,
</span><span class='line'>  "active_primary_shards" : 0,
</span><span class='line'>  "active_shards" : 0,
</span><span class='line'>  "relocating_shards" : 0,
</span><span class='line'>  "initializing_shards" : 0,
</span><span class='line'>  "unassigned_shards" : 0,
</span><span class='line'>  "delayed_unassigned_shards" : 0,
</span><span class='line'>  "number_of_pending_tasks" : 0,
</span><span class='line'>  "number_of_in_flight_fetch" : 0,
</span><span class='line'>  "task_max_waiting_in_queue_millis" : 0,
</span><span class='line'>  "active_shards_percent_as_number" : 100.0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Look at the nodes api and you will see that we now have the extra 2 nodes showing up on <code>node.role</code> as <code>di</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/nodes?v
</span><span class='line'>ip           heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>10.163.68.7             9          96   6    0.12    0.11     0.03 di        -      es-data-2
</span><span class='line'>10.163.68.5            10          80   2    0.20    0.09     0.08 mi        *      es-master-1
</span><span class='line'>10.163.68.11           12          96   9    0.12    0.09     0.03 di        -      es-data-1
</span><span class='line'>10.163.68.4            10          79   0    0.00    0.12     0.11 mi        -      es-master-3
</span><span class='line'>10.163.68.8            12          79   1    0.05    0.06     0.07 mi        -      es-master-2</span></code></pre></td></tr></table></div></figure>


<h2>Interact with Elasticsearch</h2>

<p>Let&rsquo;s interact with elasticsearch, the overview:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200
</span><span class='line'>{
</span><span class='line'>  "name" : "es-data-1",
</span><span class='line'>  "cluster_name" : "es-cluster",
</span><span class='line'>  "cluster_uuid" : "5BLs4sxsSEK-4OxlGnmlmw",
</span><span class='line'>  "version" : {
</span><span class='line'>    "number" : "6.7.0",
</span><span class='line'>    "build_flavor" : "default",
</span><span class='line'>    "build_type" : "deb",
</span><span class='line'>    "build_hash" : "8453f77",
</span><span class='line'>    "build_date" : "2019-03-21T15:32:29.844721Z",
</span><span class='line'>    "build_snapshot" : false,
</span><span class='line'>    "lucene_version" : "7.7.0",
</span><span class='line'>    "minimum_wire_compatibility_version" : "5.6.0",
</span><span class='line'>    "minimum_index_compatibility_version" : "5.0.0"
</span><span class='line'>  },
</span><span class='line'>  "tagline" : "You Know, for Search"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s look at the Health API:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/health?v
</span><span class='line'>epoch      timestamp cluster    status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent
</span><span class='line'>1554154652 21:37:32  es-cluster green           5         2     10   5    0    0        0             0                  -                100.0%</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s ingest some data into elasticsearch, we will create an index named <code>first-index</code> with some dummy data about people, username, name, surname, location and hobbies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://127.0.0.1:9200/first-index/docs/ -d '{"username": "mikes", "name": "mike", "surname": "steyn", "location": {"country": "south africa", "city": "cape town"}, "hobbies": ["sport", "coffee"]}'
</span><span class='line'>
</span><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://127.0.0.1:9200/first-index/docs/ -d '{"username": "clarissas", "name": "clarissa", "surname": "smith", "location": {"country": "ireland", "city": "dublin"}, "hobbies": ["shopping", "reading", "chess"]}'
</span><span class='line'>
</span><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://127.0.0.1:9200/first-index/docs/ -d '{"username": "franka", "name": "frank", "surname": "adams", "location": {"country": "new zealand", "city": "auckland"}, "hobbies": ["programming", "swimming", "rugby"]}'</span></code></pre></td></tr></table></div></figure>


<p>Now that we ingested our data into elasticsearch, lets have a look at the Indices API, where the number of documents, size etc should reflect:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/indices?v
</span><span class='line'>health status index       uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   first-index 1o6yM7tCSqagqoeihKM7_g   5   1          3            0     40.6kb         20.3kb</span></code></pre></td></tr></table></div></figure>


<p>Now lets request a search, which will give you by default 10 returned documents:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/first-index/_search?pretty
</span><span class='line'>{
</span><span class='line'>  "took" : 116,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 3,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "first-index",
</span><span class='line'>        "_type" : "docs",
</span><span class='line'>        "_id" : "-NTO2mkB8pugP4aC2jtZ",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "username" : "mikes",
</span><span class='line'>          "name" : "mike",
</span><span class='line'>          "surname" : "steyn",
</span><span class='line'>          "location" : {
</span><span class='line'>            "country" : "south africa",
</span><span class='line'>            "city" : "cape town"
</span><span class='line'>          },
</span><span class='line'>          "hobbies" : [
</span><span class='line'>            "sport",
</span><span class='line'>            "coffee"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "_index" : "first-index",
</span><span class='line'>        "_type" : "docs",
</span><span class='line'>        "_id" : "-tTR2mkB8pugP4aCAzvG",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "username" : "franka",
</span><span class='line'>          "name" : "frank",
</span><span class='line'>          "surname" : "adams",
</span><span class='line'>          "location" : {
</span><span class='line'>            "country" : "new zealand",
</span><span class='line'>            "city" : "auckland"
</span><span class='line'>          },
</span><span class='line'>          "hobbies" : [
</span><span class='line'>            "programming",
</span><span class='line'>            "swimming",
</span><span class='line'>            "rugby"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "_index" : "first-index",
</span><span class='line'>        "_type" : "docs",
</span><span class='line'>        "_id" : "-dTP2mkB8pugP4aC1ztI",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "username" : "clarissas",
</span><span class='line'>          "name" : "clarissa",
</span><span class='line'>          "surname" : "smith",
</span><span class='line'>          "location" : {
</span><span class='line'>            "country" : "ireland",
</span><span class='line'>            "city" : "dublin"
</span><span class='line'>          },
</span><span class='line'>          "hobbies" : [
</span><span class='line'>            "shopping",
</span><span class='line'>            "reading",
</span><span class='line'>            "chess"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s have a look at our shards using the Shards API, you will also see where each document is assigned to a specific shard, and also if its a primary or replica shard:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/shards?v
</span><span class='line'>index       shard prirep state   docs store ip           node
</span><span class='line'>first-index 4     p      STARTED    0  230b 10.163.68.7  es-data-2
</span><span class='line'>first-index 4     r      STARTED    0  230b 10.163.68.11 es-data-1
</span><span class='line'>first-index 2     p      STARTED    0  230b 10.163.68.7  es-data-2
</span><span class='line'>first-index 2     r      STARTED    0  230b 10.163.68.11 es-data-1
</span><span class='line'>first-index 3     r      STARTED    1 6.6kb 10.163.68.7  es-data-2
</span><span class='line'>first-index 3     p      STARTED    1 6.6kb 10.163.68.11 es-data-1
</span><span class='line'>first-index 1     r      STARTED    2  13kb 10.163.68.7  es-data-2
</span><span class='line'>first-index 1     p      STARTED    2  13kb 10.163.68.11 es-data-1
</span><span class='line'>first-index 0     p      STARTED    0  230b 10.163.68.7  es-data-2
</span><span class='line'>first-index 0     r      STARTED    0  230b 10.163.68.11 es-data-1</span></code></pre></td></tr></table></div></figure>


<p>Then we can also use the Allocation API to see the size of our indices, disk space per node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/allocation?v
</span><span class='line'>shards disk.indices disk.used disk.avail disk.total disk.percent host         ip           node
</span><span class='line'>     5       20.3kb    32.4mb      9.9gb      9.9gb            0 10.163.68.11 10.163.68.11 es-data-1
</span><span class='line'>     5       20.3kb    32.4mb      9.9gb      9.9gb            0 10.163.68.7  10.163.68.7  es-data-2</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s search for anyone with the surname <code>smith</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s http://127.0.0.1:9200/first-index/_search?q=surname=smith | jq .
</span><span class='line'>{
</span><span class='line'>  "took": 22,
</span><span class='line'>  "timed_out": false,
</span><span class='line'>  "_shards": {
</span><span class='line'>    "total": 5,
</span><span class='line'>    "successful": 5,
</span><span class='line'>    "skipped": 0,
</span><span class='line'>    "failed": 0
</span><span class='line'>  },
</span><span class='line'>  "hits": {
</span><span class='line'>    "total": 1,
</span><span class='line'>    "max_score": 0.2876821,
</span><span class='line'>    "hits": [
</span><span class='line'>      {
</span><span class='line'>        "_index": "first-index",
</span><span class='line'>        "_type": "docs",
</span><span class='line'>        "_id": "-dTP2mkB8pugP4aC1ztI",
</span><span class='line'>        "_score": 0.2876821,
</span><span class='line'>        "_source": {
</span><span class='line'>          "username": "clarissas",
</span><span class='line'>          "name": "clarissa",
</span><span class='line'>          "surname": "smith",
</span><span class='line'>          "location": {
</span><span class='line'>            "country": "ireland",
</span><span class='line'>            "city": "dublin"
</span><span class='line'>          },
</span><span class='line'>          "hobbies": [
</span><span class='line'>            "shopping",
</span><span class='line'>            "reading",
</span><span class='line'>            "chess"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s search for anyone with <code>rugby</code> as one of their hobbies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s http://127.0.0.1:9200/first-index/_search?q=hobbies=rugby | jq .
</span><span class='line'>{
</span><span class='line'>  "took": 23,
</span><span class='line'>  "timed_out": false,
</span><span class='line'>  "_shards": {
</span><span class='line'>    "total": 5,
</span><span class='line'>    "successful": 5,
</span><span class='line'>    "skipped": 0,
</span><span class='line'>    "failed": 0
</span><span class='line'>  },
</span><span class='line'>  "hits": {
</span><span class='line'>    "total": 1,
</span><span class='line'>    "max_score": 0.64072424,
</span><span class='line'>    "hits": [
</span><span class='line'>      {
</span><span class='line'>        "_index": "first-index",
</span><span class='line'>        "_type": "docs",
</span><span class='line'>        "_id": "-tTR2mkB8pugP4aCAzvG",
</span><span class='line'>        "_score": 0.64072424,
</span><span class='line'>        "_source": {
</span><span class='line'>          "username": "franka",
</span><span class='line'>          "name": "frank",
</span><span class='line'>          "surname": "adams",
</span><span class='line'>          "location": {
</span><span class='line'>            "country": "new zealand",
</span><span class='line'>            "city": "auckland"
</span><span class='line'>          },
</span><span class='line'>          "hobbies": [
</span><span class='line'>            "programming",
</span><span class='line'>            "swimming",
</span><span class='line'>            "rugby"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>More on Elasticsearch</h2>

<p>I am planning to write up <strong>elasticsearch</strong> articles on the following topics:</p>

<ul>
<li><a href="">Setting up a 5 Node HA Elasticsearch Cluster</a></li>
<li>Indexes / Replicas</li>
<li>Search Queries</li>
<li>Delete Queries</li>
<li>Elasticsearch Snapshots and Restores on S3</li>
<li>Mapping Templates</li>
<li>Resizing Index Shards</li>
<li>Dealing with Old Timeseries Data</li>
<li>Elasticsearch Percentiles</li>
<li>Managing Yellow and Red Status Clusters</li>
<li>Managing High JVM Memory Pressure</li>
<li>and more</li>
</ul>


<p>As I finish up the writing of these posts they will be published under the <a href="https://blog.ruanbekker.com/blog/categories/elasticsearch-tutorials">#elasticsearch-tutorials</a> category on my blog and for any other elasticsearch tutorials, you can find them under the <a href="https://blog.ruanbekker.com/blog/categories/elasticsearch">#elasticsearch</a> category.</p>

<p>Oke byyyyyye :D</p>

<h2>Resources</h2>

<ul>
<li><a href="https://www.elastic.co/products/elasticsearch">Elasticsearch</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">Elasticsearch Docs</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  


<span class="byline author vcard">Posted by <span class="fn">Ruan</span></span>


      




<time class='entry-date' datetime='2019-04-02T05:05:19-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2019</span></span> <span class='time'>5:05 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cluster/'>cluster</a>, <a class='category' href='/blog/categories/databases/'>databases</a>, <a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a>, <a class='category' href='/blog/categories/elasticsearch-tutorials/'>elasticsearch-tutorials</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://blog.ruanbekker.com/blog/2019/04/02/setup-a-5-node-highly-available-elasticsearch-cluster/" data-via="ruanbekker" data-counturl="https://blog.ruanbekker.com/blog/2019/04/02/setup-a-5-node-highly-available-elasticsearch-cluster/" >Tweet</a>
  
  
  
</div>

    
    <!-- https://www.undefinednull.com/2013/10/15/octopress-blog-tweaks-adding-author-information-section-below-each-posts/ -->
    <!-- include custom/carbon-ads.html -->
    <div class="about">
     <span class="about-image">
          <img src="/images/author.png" alt="Ruan Bekker">
     </span>
     <span class="about-desc">
          <span>My name is <a href="https://ruan.dev">Ruan</a>, I'm a DevOps Engineer from South Africa. I'm passionate
          about AWS, OpenSource, Observability, Containers, Linux, Automation and sharing my findings with the world.
          More info about me on my website, <a href="https://ruan.dev">ruan.dev</a>.</span>
          <br/>
          <hr/>
          <a href="https://twitter.com/ruanbekker" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @ruanbekker</a>
     </span>
</div>

    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2019/03/28/snippet-create-custom-cloudwatch-metrics-with-python/" title="Previous Post: Snippet: Create Custom CloudWatch Metrics with Python">&laquo; Snippet: Create Custom CloudWatch Metrics with Python</a>
      
      
        <a class="basic-alignment right" href="/blog/2019/04/02/setup-kibana-dashboards-for-nginx-log-data-to-understand-the-behavior/" title="Next Post: Setup Kibana Dashboards for Nginx log data to understand the behavior">Setup Kibana Dashboards for Nginx log data to understand the behavior &raquo;</a>
      
    </p>
  </footer>
</article>
<!-- google advertisements -->
    <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->

 


</div>

<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Carbon</h1>
  <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CEAIP2JL&placement=blogruanbekkercom" id="_carbonads_js"></script>
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>

<section>
  <h1>Say Hi!</h1>
  Send me a note using the <a href="https://saythanks.io/to/ruanbekker">saythanks.io</a> project.
</section>

<section>
  <h1>Newsletter</h1>
  View my newsletter on <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog" target="_blank">digests.ruanbekker.com</a>
</section>

<section>
  <h1>Cheetsheet Repository</h1>
  Have a look at my <strong>Cheetsheets Github Repository</strong>:
  <p></p>
  <a href="https://github.com/ruanbekker/cheatsheets" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719365-1d8a05e2-a0d3-4078-a84f-c691544e4b8f.png" width="480" height="240"></a>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/08/28/ansible-playbook-for-your-macbook-homebrew-packages/">Ansible Playbook for Your Macbook Homebrew Packages</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/07/31/docker-multistage-builds-for-hugo/">Docker Multistage Builds for Hugo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/07/14/remote-builds-with-docker-contexts/">Remote Builds With Docker Contexts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/29/create-a-raid5-array-with-mdadm-on-linux/">Create a RAID5 Array With Mdadm on Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/23/install-a-specific-python-version-on-ubuntu/">Install a Specific Python Version on Ubuntu</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest elasticsearch cheatsheet in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719853-fe9a50a4-03f2-4a26-a422-0deb946ca09c.png" width="480" height="240"></a>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ruanbekker" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
