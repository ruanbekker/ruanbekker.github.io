
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>IPSec Site to Site VPN With Dynamic IPs With Openswan - Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In this tutorial we will setup a site to site ipsec vpn with strongswan and we will enable each server to discover the other vpn server via dynamic &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/blog/2020/04/19/ipsec-site-to-site-vpn-with-dynamic-ips-with-openswan/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
<script>
(function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
})(document, window, '//fh-blog-ruanbekker-com.home.ruan.dev/tracker.js', 'fathom');
fathom('set', 'siteId', 'MWBHH');
fathom('trackPageview');
</script>
<!-- / Fathom -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="IPSec Site to Site VPN with Dynamic IPs with Openswan">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">IPSec Site to Site VPN With Dynamic IPs With Openswan</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-04-19T20:58:17+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>8:58 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In this tutorial we will setup a site to site ipsec vpn with strongswan and we will enable each server to discover the other vpn server via dynamic dns. We will also append to our config the ability of roadwarriors so that you will be able to connect to your homelab from any mobile or laptop device from any remote source.</p>

<h2>Some background</h2>

<p>Me and one of my friends decided to build a site to site vpn with strongswan so that our homelabs could be reachable to each other over private networks.</p>

<p>One challenge that I thought of is that both of our internet providers don&rsquo;t support static ip addressing, so each vpn server needs to know where to connect to whenever the ip address changes.</p>

<h2>What we will be doing</h2>

<p>We will setup strongswan vpn on both servers and allow the private LAN ranges to be reachable for both sides. As I have a domain hosted on cloudflare, I will be using cloudflare&rsquo;s api to update the A record of each sides dns whenever the IP changes.</p>

<h2>Environment</h2>

<p>On my side, which I will be referring to as <strong>Side-A</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Public DNS Name: side-a.example.com
</span><span class='line'>Private Range: 192.168.0.0/24
</span><span class='line'>VPN Server IP: 192.168.0.2</span></code></pre></td></tr></table></div></figure>


<p>On my friend&rsquo;s side, which I will be referring to as <strong>Side-B</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Public DNS Name: side-b.example.com
</span><span class='line'>Private Range: 192.168.1.0/24
</span><span class='line'>VPN Server IP: 192.168.1.2</span></code></pre></td></tr></table></div></figure>


<h2>Cloudflare Dynamic DNS</h2>

<p>You don&rsquo;t need to use Cloudflare, theres services such as dyndns.com, no-ip.com. But for this tutorial I will be using cloudflare to utilize my own domain.</p>

<p>I will be using the <a href="https://github.com/LINKIWI/cloudflare-ddns-client">cloudflare-ddns-client</a></p>

<p>First we need to create a API Token, head over to your dashboard: <a href="https://dash.cloudflare.com">dash.cloudflare.com</a>, head over to &ldquo;my profile&rdquo;, select &ldquo;API Tokens&rdquo;, then allow &ldquo;Read Zones&rdquo; and &ldquo;Edit DNS&rdquo;, then select &ldquo;Create Token&rdquo;. Keep the returned token value in a safe place.</p>

<p>Install the pre-requirements:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install python python-dev python-pip make curl build-essential -y</span></code></pre></td></tr></table></div></figure>


<p>Get the source and install:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/LINKIWI/cloudflare-ddns-client.git
</span><span class='line'>$ cd cloudflare-ddns-client
</span><span class='line'>$ make install</span></code></pre></td></tr></table></div></figure>


<p>We will now configure the cloudflare dynamic dns client, this will be done on both sides, but will only demonstrate for side-a:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cloudflare-ddns --configure
</span><span class='line'>Use API token or API key to authenticate?
</span><span class='line'>Choose [T]oken or [K]ey: T
</span><span class='line'>Enter the API token you created at https://dash.cloudflare.com/profile/api-tokens.
</span><span class='line'>Required permissions are READ Account.Access: Organizations, Identity Providers, and Groups; READ Zone.Zone; EDIT Zone.DNS
</span><span class='line'>CloudFlare API token: [redacted]
</span><span class='line'>Enter the domains for which you would like to automatically update the DNS records, delimited by a single comma.
</span><span class='line'>Comma-delimited domains: side-a.example.com</span></code></pre></td></tr></table></div></figure>


<p>Testing it out to ensure the A record can be updated:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cloudflare-ddns --update-now
</span><span class='line'>Found external IPv4: "1.x.x.x"
</span><span class='line'>Listing all zones.
</span><span class='line'>Finding all DNS records.
</span><span class='line'>Updating the A record (ID x) of (sub)domain side-a.example.com (ID x) to 1.x.x.x.
</span><span class='line'>DNS record updated successfully!</span></code></pre></td></tr></table></div></figure>


<p>We can run this command from above in a cron, but I will use a bash script to only run when the public ip changed: <code>/opt/scripts/detect_ip_change.sh</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>set -ex
</span><span class='line'>MY_DDNS_HOST="side-a.example.com"
</span><span class='line'>
</span><span class='line'>if [ $(dig ${MY_DDNS_HOST} +short) == $(curl -s icanhazip.com) ];
</span><span class='line'>  then exit 0;
</span><span class='line'>  else /usr/local/bin/cloudflare-ddns --update-now;
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>


<p>Make the file executable: <code>chmod +x /opt/scripts/detect_ip_change.sh</code> then edit your cronjobs: <code>crontab -e</code> and add the script:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* * * * * /opt/scripts/detect_ip_change.sh</span></code></pre></td></tr></table></div></figure>


<p>This will keep your DNS updated, this needs to be done on both sides, if you want to use dynamic dns.</p>

<h2>Port Forwarding</h2>

<p>We will need to forward UDP traffic from the router to the VPN server, on both sides:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Port: UDP/500 
</span><span class='line'>Target: VPN-Server-IP:500
</span><span class='line'>
</span><span class='line'>Port: UDP/4500
</span><span class='line'>Target: VPN-Server-IP:4500</span></code></pre></td></tr></table></div></figure>


<h2>Create a Pre-Shared Key</h2>

<p>Create a preshared key that will be used on both sides to authenticate:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl rand -base64 36
</span><span class='line'>pgDU4eKZaQNL7GNRWJPvZbaSYFn2PAFjK9vDOvxAQ85p7qc4</span></code></pre></td></tr></table></div></figure>


<p>This value will be used on both sides, which we will need later.</p>

<h2>Install Strongswan on Side-A</h2>

<p>Install strongswan and enable the service on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install strongswan -y
</span><span class='line'>$ systemctl enable strongswan</span></code></pre></td></tr></table></div></figure>


<p>The left side will be the side we are configuring and the right side will be the remote side.</p>

<p>Create the config: <code>/etc/ipsec.conf</code> and provide the following config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config setup
</span><span class='line'>    charondebug="all"
</span><span class='line'>    uniqueids=yes
</span><span class='line'>    virtual_private=
</span><span class='line'>    cachecrls=no
</span><span class='line'>
</span><span class='line'>conn vpn-to-side-b
</span><span class='line'>    type=tunnel
</span><span class='line'>    authby=secret
</span><span class='line'>    left=%defaultroute
</span><span class='line'>    leftid=side-a.example.com
</span><span class='line'>    leftsubnet=192.168.0.0/24
</span><span class='line'>    right=%side-b.example.com
</span><span class='line'>    rightid=side-b.example.com
</span><span class='line'>    rightsubnet=192.168.1.0/24
</span><span class='line'>    ike=aes256-sha2_256-modp1024!
</span><span class='line'>    esp=aes256-sha2_256!
</span><span class='line'>    keyingtries=0
</span><span class='line'>    ikelifetime=1h
</span><span class='line'>    lifetime=8h
</span><span class='line'>    dpddelay=30
</span><span class='line'>    dpdtimeout=120
</span><span class='line'>    dpdaction=restart
</span><span class='line'>    auto=start</span></code></pre></td></tr></table></div></figure>


<p>Create the secrets file: <code>/etc/ipsec.secrets</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>side-b.example.com : PSK "pgDU4eKZaQNL7GNRWJPvZbaSYFn2PAFjK9vDOvxAQ85p7qc4"</span></code></pre></td></tr></table></div></figure>


<p>Append the following kernel parameters to <code>/etc/sysctl.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>net.ipv4.ip_forward = 1
</span><span class='line'>net.ipv4.conf.all.accept_redirects = 0
</span><span class='line'>net.ipv4.conf.all.send_redirects = 0</span></code></pre></td></tr></table></div></figure>


<p>Save:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -p</span></code></pre></td></tr></table></div></figure>


<p>We now want to add a POSTROUTING and FORWARD rule using iptables:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iptables -t nat -A POSTROUTING -s 192.168.1.0/24  -d 192.168.0.0/24 -j MASQUERADE
</span><span class='line'>$ iptables -A FORWARD -s 192.168.1.0/24 -d 192.168.0.0/24 -j ACCEPT</span></code></pre></td></tr></table></div></figure>


<p>Now we need to route back:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ip route add 192.168.1.0/24 via 192.168.0.2 dev eth0</span></code></pre></td></tr></table></div></figure>


<p>We want to persist the iptables and static route across reboots, so edit the <code>/etc/rc.local</code> file, if it&rsquo;s not there create it with the following values:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>iptables -t nat -A POSTROUTING -s 192.168.1.0/24  -d 192.168.0.0/24 -j MASQUERADE
</span><span class='line'>iptables -A FORWARD -s 192.168.1.0/24 -d 192.168.0.0/24 -j ACCEPT
</span><span class='line'>ip route add 192.168.1.0/24 via 192.168.0.2 dev eth0
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<p>If you created the file, make sure to apply executable permissions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod +x /etc/rc.local</span></code></pre></td></tr></table></div></figure>


<p>Read the secrets and restart strongswan:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec rereadsecrets
</span><span class='line'>$ systemctl restart strongswan</span></code></pre></td></tr></table></div></figure>


<h2>Install Strongswan on Side-B</h2>

<p>Install strongswan and enable the service on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install strongswan -y
</span><span class='line'>$ systemctl enable strongswan</span></code></pre></td></tr></table></div></figure>


<p>The left side will be the side we are configuring and the right side will be the remote side.</p>

<p>Create the config: <code>/etc/ipsec.conf</code> and provide the following config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config setup
</span><span class='line'>    charondebug="all"
</span><span class='line'>    uniqueids=yes
</span><span class='line'>    virtual_private=
</span><span class='line'>    cachecrls=no
</span><span class='line'>
</span><span class='line'>conn vpn-to-side-a
</span><span class='line'>    type=tunnel
</span><span class='line'>    authby=secret
</span><span class='line'>    left=%defaultroute
</span><span class='line'>    leftid=side-b.example.com
</span><span class='line'>    leftsubnet=192.168.1.0/24
</span><span class='line'>    right=%side-a.example.com
</span><span class='line'>    rightid=side-a.example.com
</span><span class='line'>    rightsubnet=192.168.0.0/24
</span><span class='line'>    ike=aes256-sha2_256-modp1024!
</span><span class='line'>    esp=aes256-sha2_256!
</span><span class='line'>    keyingtries=0
</span><span class='line'>    ikelifetime=1h
</span><span class='line'>    lifetime=8h
</span><span class='line'>    dpddelay=30
</span><span class='line'>    dpdtimeout=120
</span><span class='line'>    dpdaction=restart
</span><span class='line'>    auto=start</span></code></pre></td></tr></table></div></figure>


<p>Create the secrets file: <code>/etc/ipsec.secrets</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>side-a.example.com : PSK "pgDU4eKZaQNL7GNRWJPvZbaSYFn2PAFjK9vDOvxAQ85p7qc4"</span></code></pre></td></tr></table></div></figure>


<p>Append the following kernel parameters to <code>/etc/sysctl.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>net.ipv4.ip_forward = 1
</span><span class='line'>net.ipv4.conf.all.accept_redirects = 0
</span><span class='line'>net.ipv4.conf.all.send_redirects = 0</span></code></pre></td></tr></table></div></figure>


<p>Save:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -p</span></code></pre></td></tr></table></div></figure>


<p>We now want to add a POSTROUTING and FORWARD rule using iptables:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iptables -t nat -A POSTROUTING -s 192.168.0.0/24  -d 192.168.1.0/24 -j MASQUERADE
</span><span class='line'>$ iptables -A FORWARD -s 192.168.0.0/24 -d 192.168.1.0/24 -j ACCEPT</span></code></pre></td></tr></table></div></figure>


<p>Now we need to route back:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ip route add 192.168.0.0/24 via 192.168.1.2 dev eth0</span></code></pre></td></tr></table></div></figure>


<p>We want to persist the iptables and static route across reboots, so edit the <code>/etc/rc.local</code> file, if it&rsquo;s not there create it with the following values:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>iptables -t nat -A POSTROUTING -s 192.168.0.0/24  -d 192.168.1.0/24 -j MASQUERADE
</span><span class='line'>iptables -A FORWARD -s 192.168.0.0/24 -d 192.168.1.0/24 -j ACCEPT
</span><span class='line'>ip route add 192.168.0.0/24 via 192.168.1.2 dev eth0
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<p>If you created the file, make sure to apply executable permissions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod +x /etc/rc.local</span></code></pre></td></tr></table></div></figure>


<p>Read the secrets and restart strongswan:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec rereadsecrets
</span><span class='line'>$ systemctl restart strongswan</span></code></pre></td></tr></table></div></figure>


<h2>Verify Status</h2>

<p>Verify that the ipsec tunnel is up on side-a:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec statusall
</span><span class='line'>
</span><span class='line'>Connections:
</span><span class='line'>  vpn-to-side-b:  %any...side-b.example.com,0.0.0.0/0,::/0  IKEv1/2
</span><span class='line'>  vpn-to-side-b:   local:  [side-a.example.com] uses pre-shared key authentication
</span><span class='line'>  vpn-to-side-b:   remote: [side-b.example.com] uses pre-shared key authentication
</span><span class='line'>  vpn-to-side-b:   child:  192.168.0.0/24 === 192.168.1.0/24 TUNNEL
</span><span class='line'>Security Associations (1 up, 0 connecting):
</span><span class='line'>  vpn-to-side-b[1]: ESTABLISHED 28 minutes ago, 192.168.0.2[side-a.example.com]...4x.x.x.214[side-b.example.com]
</span><span class='line'>  vpn-to-side-b[1]: IKEv2 SPIs: 81996170df1c927d_i e8294946491ddf08_r, pre-shared key reauthentication in 2 hours
</span><span class='line'>  vpn-to-side-b[1]: IKE proposal: AES_CBC_128/HMAC_SHA2_256_128/PRF_HMAC_SHA2_256/ECP_256
</span><span class='line'>  vpn-to-side-b{2}:  INSTALLED, TUNNEL, reqid 1, ESP in UDP SPIs: cc4504be_i c294cb26_o
</span><span class='line'>  vpn-to-side-b{2}:  AES_CBC_128/HMAC_SHA2_256_128, 0 bytes_i, 240 bytes_o (4 pkts, 7s ago), rekeying in 18 minutes
</span><span class='line'>  vpn-to-side-b{2}:   192.168.0.0/24 === 192.168.1.0/24</span></code></pre></td></tr></table></div></figure>


<p>Verify that the ipsec tunnel is up on side-b:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec statusall
</span><span class='line'>
</span><span class='line'>Connections:
</span><span class='line'> vpn-to-side-a:  %any...side-a.example.com,0.0.0.0/0,::/0  IKEv1/2
</span><span class='line'> vpn-to-side-a:   local:  [side-b.example.com] uses pre-shared key authentication
</span><span class='line'> vpn-to-side-a:   remote: [side-a.example.com] uses pre-shared key authentication
</span><span class='line'> vpn-to-side-a:   child:  192.168.1.0/24 === 192.168.0.0/24 TUNNEL
</span><span class='line'>Security Associations (1 up, 0 connecting):
</span><span class='line'> vpn-to-side-a[2]: ESTABLISHED 20 minutes ago, 192.168.1.2[side-b.example.com]...14x.x.x.x[side-a.example.com]
</span><span class='line'> vpn-to-side-a[2]: IKEv2 SPIs: 81996170df1c927d_i e8294946491ddf08_r, pre-shared key reauthentication in 2 hours
</span><span class='line'> vpn-to-side-a[2]: IKE proposal: AES_CBC_128/HMAC_SHA2_256_128/PRF_HMAC_SHA2_256/ECP_256
</span><span class='line'> vpn-to-side-a{2}:  INSTALLED, TUNNEL, reqid 1, ESP in UDP SPIs: c294cb26_i cc4504be_o
</span><span class='line'> vpn-to-side-a{2}:  AES_CBC_128/HMAC_SHA2_256_128, 0 bytes_i, 0 bytes_o, rekeying in 26 minutes
</span><span class='line'> vpn-to-side-a{2}:   192.168.1.0/24 === 192.168.0.0/24</span></code></pre></td></tr></table></div></figure>


<p>From side-a (192.168.0.2) ping the gateway on side-b (192.168.1.1):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ $ ping -c2 192.168.1.1
</span><span class='line'>PING 10.3.96.2 (192.168.1.1) 56(84) bytes of data.
</span><span class='line'>64 bytes from 192.168.1.1: icmp_seq=1 ttl=62 time=11.9 ms</span></code></pre></td></tr></table></div></figure>


<p>If you want to be able to reach the private range of the other side of the vpn from any device on your network, you should add a static route on your router to inform your default gateway where to route traffic to.</p>

<p>In this case on side-a (192.168.0.0/24) we want to inform our default gateway to route (192.168.1.0/24) to the VPN as it knows to route that destination over the VPN.</p>

<p>On side-a, on your router, add a static route:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Route: 192.168.1.0
</span><span class='line'>Subnet: 255.255.255.0
</span><span class='line'>Gateway: 192.168.0.2</span></code></pre></td></tr></table></div></figure>


<p>On side-b, on your router, add a static route:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Route: 192.168.0.0
</span><span class='line'>Subnet: 255.255.255.0
</span><span class='line'>Gateway: 192.168.1.2</span></code></pre></td></tr></table></div></figure>


<h2>Optional: Roadwarrior VPN Clients</h2>

<p>This step is optional, but since we can access each others homelabs, we thought it would be nice to be able to access the resources from mobile devices or laptops when we are on remote locations.</p>

<p>We made it that each VPN owner will connect to its own endpoint (for roadwarriors), so side-a (which will be me) will connect to its own dns endpoint to connect when away from home..</p>

<p>I will only demonstrate how to append your config to add the ability for a roadwarrion vpn connection, append to the <code>/etc/ipsec.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ...
</span><span class='line'>conn ikev2-vpn
</span><span class='line'>    auto=add
</span><span class='line'>    type=tunnel
</span><span class='line'>    authby=secret
</span><span class='line'>    left=%any
</span><span class='line'>    leftid=side-a.roadwarrior
</span><span class='line'>    leftsubnet=0.0.0.0/0
</span><span class='line'>    right=%any
</span><span class='line'>    rightid=%any
</span><span class='line'>    rightsourceip=10.10.0.0/24
</span><span class='line'>    rightdns=192.168.0.1,8.8.8.8
</span><span class='line'>    auto=start</span></code></pre></td></tr></table></div></figure>


<p>Append the secret in <code>/etc/ipsec.secrets</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ...
</span><span class='line'>side-a.roadwarrior my-laptop : PSK "MySuperSecureSecret123"</span></code></pre></td></tr></table></div></figure>


<p>Add the vpn ip&rsquo;s that we will assign to the roardwarrior clients to the routing table:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ip route add 10.10.0.0/24 via 192.168.0.2 dev eth0</span></code></pre></td></tr></table></div></figure>


<p>If you only want the roadwarriors to be able to reach your network, you will only forward to the local network such as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iptables -A FORWARD -s 10.10.0.0/24 -d 192.168.0.0/24 -j ACCEPT</span></code></pre></td></tr></table></div></figure>


<p>But we will be forwarding traffic to all destinations:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iptables -A FORWARD -s 10.10.0.0/24 -d 0.0.0.0/0 -j ACCEPT
</span><span class='line'>$ iptables -t nat -A POSTROUTING -s 10.10.0.0/24 -d 0.0.0.0/0 -j MASQUERADE</span></code></pre></td></tr></table></div></figure>


<p>Remember to append the routes to <code>/etc/rc.local</code> to persist across reboots.</p>

<p>Reread the secrets and restart strongswan:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec rereadsecrets
</span><span class='line'>$ systemctl restart strongswan</span></code></pre></td></tr></table></div></figure>


<p>Connecting your VPN Client, I will be using my Laptop, with the following details:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>VPN Type: IKEv2
</span><span class='line'>Description: Home VPN
</span><span class='line'>Server: side-a.example.com
</span><span class='line'>Remote ID: side-a.roadwarrior
</span><span class='line'>Local ID: my-laptop
</span><span class='line'>User Authentication: None
</span><span class='line'>Secret: MySuperSecureSecret123</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>In this tutorial I demonstrated how to setup a site to site ipsec vpn between 2 sides that consists of internet connections that has dynamic ip&rsquo;s and also appending roadwarrior config so that you can connect to your homelab from anywhere in the world.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ruan</span></span>

      




<time class='entry-date' datetime='2020-04-19T20:58:17+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>8:58 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ipsec/'>ipsec</a>, <a class='category' href='/blog/categories/networking/'>networking</a>, <a class='category' href='/blog/categories/strongswan/'>strongswan</a>, <a class='category' href='/blog/categories/vpn/'>vpn</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://blog.ruanbekker.com/blog/2020/04/19/ipsec-site-to-site-vpn-with-dynamic-ips-with-openswan/" data-via="ruanbekker" data-counturl="https://blog.ruanbekker.com/blog/2020/04/19/ipsec-site-to-site-vpn-with-dynamic-ips-with-openswan/" >Tweet</a>
  
  
  
</div>

    
    <!-- https://www.undefinednull.com/2013/10/15/octopress-blog-tweaks-adding-author-information-section-below-each-posts/ -->
    <div class="about">
     <span class="about-image">
          <img src="/images/author.png" alt="Ruan Bekker">
     </span>
     <span class="about-desc">
          <span>My name is <a href="https://ruan.dev">Ruan</a>, i'm a DevOps Engineer from Cape Town, South Africa. I'm
          passionate about AWS, OpenSource, Containers, Linux, Automation and sharing my findings with the world.
          More info about me on my website, <a href="https://ruan.dev">ruan.dev</a>.</span>
          <br/>
          <hr/>
          <a href="https://twitter.com/ruanbekker" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @ruanbekker</a>
     </span>
</div>

    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2020/02/21/persistent-volumes-with-k3d-kubernetes/" title="Previous Post: Persistent Volumes with k3d Kubernetes">&laquo; Persistent Volumes with k3d Kubernetes</a>
      
      
        <a class="basic-alignment right" href="/blog/2020/04/25/nginx-metrics-on-prometheus-with-the-nginx-log-exporter/" title="Next Post: Nginx Metrics on Prometheus with the Nginx Log Exporter">Nginx Metrics on Prometheus with the Nginx Log Exporter &raquo;</a>
      
    </p>
  </footer>
</article>
<!-- google advertisements
    <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->

 
-->


  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/10/26/easy-ad-hoc-vpns-with-sshuttle/">Easy Ad-Hoc VPNs With Sshuttle</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/10/26/use-a-ssh-jump-host-with-ansible/">Use a SSH Jump Host With Ansible</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/10/23/basic-ping-role-with-ansible-in-a-playbook/">Basic Ping Role With Ansible in a Playbook</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/10/08/using-the-libvirt-provisioner-with-terraform-for-kvm/">Using the Libvirt Provisioner With Terraform for KVM</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/10/07/setup-a-kvm-host-for-virtualization-on-oneprovider/">Setup a KVM Host for Virtualization on OneProvider</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest cheatsheets in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com"><img src="https://user-images.githubusercontent.com/567298/97010485-c2334a00-1545-11eb-9e1d-2333e5148da1.png" width="290" height="900"></a>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://blog.ruanbekker.com/blog/2020/04/19/ipsec-site-to-site-vpn-with-dynamic-ips-with-openswan/';
        var disqus_url = 'https://blog.ruanbekker.com/blog/2020/04/19/ipsec-site-to-site-vpn-with-dynamic-ips-with-openswan/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
