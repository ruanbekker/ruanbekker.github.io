
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Manage Helm Releases With Terraform - Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In this post we will use terraform to deploy a helm release to kubernetes. Kubernetes For this demonstration I will be using kind to deploy a local &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/blog/2023/03/09/manage-helm-releases-with-terraform/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script async defer data-website-id="2cfa7c36-c1f7-48fd-949c-2e5e8a1d873d" src="https://umami-analytics.ruan.dev/umami.js"></script>

  <!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1100086574264181"
     crossorigin="anonymous"></script>

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="Manage Helm Releases with Terraform">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

  
  
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Manage Helm Releases With Terraform</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-03-09T16:15:47-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>4:15 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/224163430-34e18f11-2182-4d2b-b7ab-f4683c187719.png" alt="helm-releases-with-terraform" /></p>

<p>In this post we will use terraform to deploy a helm release to kubernetes.</p>

<h2>Kubernetes</h2>

<p>For this demonstration I will be using <a href="https://kind.sigs.k8s.io/">kind</a> to deploy a local Kubernetes cluster to the operating system that I am running this on, which will be Ubuntu Linux. For a more in-depth tutorial on Kind, you can see my post on <a href="https://blog.ruanbekker.com/blog/2022/09/20/kind-for-local-kubernetes-clusters/">Kind for Local Kubernetes Clusters</a>.</p>

<h2>Installing the Pre-Requirements</h2>

<p>We will be installing terraform, docker, kind and kubectl on Linux.</p>

<p>Install terraform:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget https://releases.hashicorp.com/terraform/1.3.0/terraform_1.3.0_linux_amd64.zip
</span><span class='line'>unzip terraform_1.3.0_linux_amd64.zip
</span><span class='line'>rm terraform_1.3.0_linux_amd64.zip
</span><span class='line'>mv terraform /usr/bin/terraform
</span></code></pre></td></tr></table></div></figure>


<p>Verify that terraform has been installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform -version
</span></code></pre></td></tr></table></div></figure>


<p>Which in my case returns:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform v1.3.0
</span><span class='line'>on linux_amd64
</span></code></pre></td></tr></table></div></figure>


<p>Install Docker on Linux (be careful to curl pipe bash - trust the scripts that you are running):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl https://get.docker.com <span class="p">|</span> bash
</span></code></pre></td></tr></table></div></figure>


<p>Then running <code>docker ps</code> should return:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>CONTAINER ID   IMAGE        COMMAND         CREATED          STATUS          PORTS       NAMES
</span></code></pre></td></tr></table></div></figure>


<p>Install kind on Linux:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>apt update
</span><span class='line'>curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.17.0/kind-linux-amd64
</span><span class='line'>chmod +x ./kind
</span><span class='line'>sudo mv ./kind /usr/local/bin/kind
</span></code></pre></td></tr></table></div></figure>


<p>Then to verify that kind was installed with <code>kind --version</code> should return:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kind version 0.17.0
</span></code></pre></td></tr></table></div></figure>


<p>Create a kubernetes cluster using kind:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kind create cluster --name rbkr --image kindest/node:v1.24.0
</span></code></pre></td></tr></table></div></figure>


<p>Now install <a href="https://kubernetes.io/docs/tasks/tools/">kubectl</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -LO <span class="s2">&quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;</span>
</span><span class='line'>sudo install -o root -g root -m <span class="m">0755</span> kubectl /usr/local/bin/kubectl
</span></code></pre></td></tr></table></div></figure>


<p>Then to verify that kubectl was installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl version --client
</span></code></pre></td></tr></table></div></figure>


<p>Which in my case returns:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Client Version: version.Info<span class="o">{</span>Major:<span class="s2">&quot;1&quot;</span>, Minor:<span class="s2">&quot;26&quot;</span>, GitVersion:<span class="s2">&quot;v1.26.1&quot;</span>, GitCommit:<span class="s2">&quot;8f94681cd294aa8cfd3407b8191f6c70214973a4&quot;</span>, GitTreeState:<span class="s2">&quot;clean&quot;</span>, BuildDate:<span class="s2">&quot;2023-01-18T15:58:16Z&quot;</span>, GoVersion:<span class="s2">&quot;go1.19.5&quot;</span>, Compiler:<span class="s2">&quot;gc&quot;</span>, Platform:<span class="s2">&quot;linux/amd64&quot;</span><span class="o">}</span>
</span><span class='line'>Kustomize Version: v4.5.7
</span></code></pre></td></tr></table></div></figure>


<p>Now we can test if kubectl can communicate with the kubernetes api server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get nodes
</span></code></pre></td></tr></table></div></figure>


<p>In my case it returns:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>NAME                 STATUS   ROLES           AGE     VERSION
</span><span class='line'>rbkr-control-plane   Ready    control-plane   6m20s   v1.24.0
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform</h2>

<p>Now that our pre-requirements are sorted we can configure terraform to communicate with kubernetes. For that to happen, we need to consult the <a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs">terraform kubernetes provider</a>&rsquo;s documentation.</p>

<p>As per their documentation they provide us with this snippet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">kubernetes</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/kubernetes&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;2.18.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;kubernetes&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="c"># Configuration options</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And from their <a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs">main</a> page, it gives us a couple of options to configure the provider and the easiest is probably to read the <code>~/.kube/config</code> configuration file.</p>

<p>But in cases where you have multiple configurations in your kube config file, this might not be ideal, and I like to be precise, so I will extract the client certificate, client key and cluster ca certificate and endpoint from our <code>~/.kube/config</code> file.</p>

<p>If we run <code>cat ~/.kube/config</code> we will see something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">clusters</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">cluster</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">certificate-authority-data</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">LS0tLS1CRU......FURS0tLS0tCg==</span>
</span><span class='line'>    <span class="l-Scalar-Plain">server</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://127.0.0.1:40305</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'><span class="l-Scalar-Plain">contexts</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">context</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cluster</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'>    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'><span class="l-Scalar-Plain">current-context</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Config</span>
</span><span class='line'><span class="l-Scalar-Plain">preferences</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">users</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'>  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">client-certificate-data</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">LS0tLS1CRX......FURS0tLS0tCg==</span>
</span><span class='line'>    <span class="l-Scalar-Plain">client-key-data</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">LS0tLS1CRUejhKWUk2N2.....S0tCg==</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we will create a directory for our certificates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir ~/certs
</span></code></pre></td></tr></table></div></figure>


<p>I have truncated my kube config for readability, but for our first file <code>certs/client-cert.pem</code> we will copy the value of <code>client-certificate-data:</code>, which will look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat certs/client-cert.pem
</span><span class='line'>LS0tLS1CRX......FURS0tLS0tCg<span class="o">==</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we will copy the contents of <code>client-key-data:</code> into <code>certs/client-key.pem</code> and then lastly the content of <code>certificate-authority-data:</code> into <code>certs/cluster-ca-cert.pem</code>.</p>

<p>So then we should have the following files inside our <code>certs/</code> directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tree certs/
</span><span class='line'>certs/
</span><span class='line'>├── client-cert.pem
</span><span class='line'>├── client-key.pem
</span><span class='line'>└── cluster-ca-cert.pem
</span><span class='line'>
</span><span class='line'><span class="m">0</span> directories, <span class="m">3</span> files
</span></code></pre></td></tr></table></div></figure>


<p>Now make them read only:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chmod <span class="m">400</span> ~/certs/*
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have that we can start writing our terraform configuration. In <code>providers.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">kubernetes</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/kubernetes&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;2.18.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;kubernetes&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">host</span>                   <span class="o">=</span> <span class="s2">&quot;https://127.0.0.1:40305&quot;</span>
</span><span class='line'>  <span class="nv">client_certificate</span>     <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="nv">client_key</span>             <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-key.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="nv">cluster_ca_certificate</span> <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/cluster-ca-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Your host might look different to mine, but you can find your host endpoint in <code>~/.kube/config</code>.</p>

<p>For a simple test we can list all our namespaces to ensure that our configuration is working. In a file called <code>namespaces.tf</code>, we can populate the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>data <span class="s2">&quot;kubernetes_all_namespaces&quot;</span> <span class="s2">&quot;allns&quot;</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;all-ns&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> data.kubernetes_all_namespaces.allns.namespaces
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to initialize terraform so that it can download the providers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Then we can run a plan which will reveal our namespaces:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform plan
</span><span class='line'>
</span><span class='line'>data.kubernetes_all_namespaces.allns: Reading...
</span><span class='line'>data.kubernetes_all_namespaces.allns: Read <span class="nb">complete </span>after 0s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>a0ff7e83ffd7b2d9953abcac9f14370e842bdc8f126db1b65a18fd09faa3347b<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + all-ns <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      + <span class="s2">&quot;default&quot;</span>,
</span><span class='line'>      + <span class="s2">&quot;kube-node-lease&quot;</span>,
</span><span class='line'>      + <span class="s2">&quot;kube-public&quot;</span>,
</span><span class='line'>      + <span class="s2">&quot;kube-system&quot;</span>,
</span><span class='line'>      + <span class="s2">&quot;local-path-storage&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now remove our <code>namespaces.tf</code> as our test worked:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rm namespaces.tf
</span></code></pre></td></tr></table></div></figure>


<h2>Helm Releases with Terraform</h2>

<p>We will need two things, we need to consult the <a href="https://registry.terraform.io/providers/hashicorp/helm/latest/docs/resources/release">terraform helm release provider</a> documentation and we also need to consult the helm chart documentation which we are interested in.</p>

<p>In my previous post I wrote about <a href="https://blog.ruanbekker.com/blog/2023/01/24/everything-you-need-to-know-about-helm/">Everything you need to know about Helm</a> and I used the <a href="https://artifacthub.io/packages/helm/bitnami/nginx">Bitnami Nginx Helm Chart</a>, so we will use that one again.</p>

<p>As we are working with helm releases, we need to configure the helm provider, I will just extend my configuration from my previous provider config in <code>providers.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">kubernetes</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/kubernetes&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;2.18.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="nv">helm</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/helm&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;2.9.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;kubernetes&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">host</span>                   <span class="o">=</span> <span class="s2">&quot;https://127.0.0.1:40305&quot;</span>
</span><span class='line'>  <span class="nv">client_certificate</span>     <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="nv">client_key</span>             <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-key.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="nv">cluster_ca_certificate</span> <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/cluster-ca-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;helm&quot;</span> <span class="o">{</span>
</span><span class='line'>  kubernetes <span class="o">{</span>
</span><span class='line'>    <span class="nv">host</span>                   <span class="o">=</span> <span class="s2">&quot;https://127.0.0.1:40305&quot;</span>
</span><span class='line'>    <span class="nv">client_certificate</span>     <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'>    <span class="nv">client_key</span>             <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-key.pem&quot;</span><span class="o">))</span>
</span><span class='line'>    <span class="nv">cluster_ca_certificate</span> <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/cluster-ca-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will create three terraform files:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch <span class="o">{</span>main,outputs,variables<span class="o">}</span>.tf
</span></code></pre></td></tr></table></div></figure>


<p>And our values yaml in <code>helm-chart/nginx/values.yaml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p helm-chart/nginx
</span></code></pre></td></tr></table></div></figure>


<p>Then you can copy the values file from <a href="https://artifacthub.io/packages/helm/bitnami/nginx?modal=values">https://artifacthub.io/packages/helm/bitnami/nginx?modal=values</a> into <code>helm-chart/nginx/values.yaml</code>.</p>

<p>In our <code>main.tf</code> I will use two ways to override values in our <code>values.yaml</code> using <code>set</code> and <code>templatefile</code>. The reason for the templatefile, is when we want to fetch a value and want to replace the content with our values file, it could be used when we retrieve a value from a data source as an example. In my example im just using a variable.</p>

<p>We will have the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;helm_release&quot;</span> <span class="s2">&quot;nginx&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>             <span class="o">=</span> var.release_name
</span><span class='line'>  <span class="nv">version</span>          <span class="o">=</span> var.chart_version
</span><span class='line'>  <span class="nv">namespace</span>        <span class="o">=</span> var.namespace
</span><span class='line'>  <span class="nv">create_namespace</span> <span class="o">=</span> var.create_namespace
</span><span class='line'>  <span class="nv">chart</span>            <span class="o">=</span> var.chart_name
</span><span class='line'>  <span class="nv">repository</span>       <span class="o">=</span> var.chart_repository_url
</span><span class='line'>  <span class="nv">dependency_update</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">reuse_values</span>      <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">force_update</span>      <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">atomic</span>              <span class="o">=</span> var.atomic
</span><span class='line'>
</span><span class='line'>  <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>  <span class="o">=</span> <span class="s2">&quot;image.tag&quot;</span>
</span><span class='line'>    <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;1.23.3-debian-11-r3&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>  <span class="o">=</span> <span class="s2">&quot;service.type&quot;</span>
</span><span class='line'>    <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;ClusterIP&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">values</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    templatefile<span class="o">(</span><span class="s2">&quot;${path.module}/helm-chart/nginx/values.yaml&quot;</span>, <span class="o">{</span>
</span><span class='line'>      <span class="nv">NAME_OVERRIDE</span>   <span class="o">=</span> var.release_name
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">)]</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see we are referencing a <code>NAME_OVERRIDE</code> in our <code>values.yaml</code>, I have cleaned up the values file to the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">nameOverride</span><span class="p-Indicator">:</span> <span class="s">&quot;${NAME_OVERRIDE}&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## ref: https://hub.docker.com/r/bitnami/nginx/tags/</span>
</span><span class='line'><span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">registry</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker.io</span>
</span><span class='line'>  <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bitnami/nginx</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1.23.3-debian-11-r3</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>NAME_OVERRIDE</code> must be in a <code>${}</code> format.</p>

<p>In our <code>variables.tf</code> we will have the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">variable &quot;release_name&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;nginx&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The name of our release.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;chart_repository_url&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;https://charts.bitnami.com/bitnami&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The chart repository url.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;chart_name&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;nginx&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The name of of our chart that we want to install from the repository.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;chart_version&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;13.2.20&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The version of our chart.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;namespace&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;apps&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The namespace where our release should be deployed into.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;create_namespace&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = bool</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;If it should create the namespace if it doesnt exist.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;atomic&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = bool</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = false</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;If it should wait until release is deployed.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And lastly our <code>outputs.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">output &quot;metadata&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">value = helm_release.nginx.metadata</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have all our configuration ready, we can initialize terraform:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Then we can run a plan to see what terraform wants to deploy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform plan
</span></code></pre></td></tr></table></div></figure>


<p>The plan output shows the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span><span class='line'>  + create
</span><span class='line'>
</span><span class='line'>Terraform will perform the following actions:
</span><span class='line'>
</span><span class='line'>  <span class="c"># helm_release.nginx will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;helm_release&quot;</span> <span class="s2">&quot;nginx&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">atomic</span>                     <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">chart</span>                      <span class="o">=</span> <span class="s2">&quot;nginx&quot;</span>
</span><span class='line'>      + <span class="nv">cleanup_on_fail</span>            <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">create_namespace</span>           <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>      + <span class="nv">dependency_update</span>          <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">disable_crd_hooks</span>          <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">disable_openapi_validation</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">disable_webhooks</span>           <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">force_update</span>               <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">id</span>                         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">lint</span>                       <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">manifest</span>                   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">max_history</span>                <span class="o">=</span> 0
</span><span class='line'>      + <span class="nv">metadata</span>                   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">name</span>                       <span class="o">=</span> <span class="s2">&quot;nginx&quot;</span>
</span><span class='line'>      + <span class="nv">namespace</span>                  <span class="o">=</span> <span class="s2">&quot;apps&quot;</span>
</span><span class='line'>      + <span class="nv">pass_credentials</span>           <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">recreate_pods</span>              <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">render_subchart_notes</span>      <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>      + <span class="nv">replace</span>                    <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">repository</span>                 <span class="o">=</span> <span class="s2">&quot;https://charts.bitnami.com/bitnami&quot;</span>
</span><span class='line'>      + <span class="nv">reset_values</span>               <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">reuse_values</span>               <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">skip_crds</span>                  <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">status</span>                     <span class="o">=</span> <span class="s2">&quot;deployed&quot;</span>
</span><span class='line'>      + <span class="nv">timeout</span>                    <span class="o">=</span> 300
</span><span class='line'>      + <span class="nv">values</span>                     <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>          + <span class="s">&lt;&lt;-EOT</span>
</span><span class='line'><span class="s">                nameOverride: &quot;nginx&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">                ## ref: https://hub.docker.com/r/bitnami/nginx/tags/</span>
</span><span class='line'><span class="s">                image:</span>
</span><span class='line'><span class="s">                  registry: docker.io</span>
</span><span class='line'><span class="s">                  repository: bitnami/nginx</span>
</span><span class='line'><span class="s">                  tag: 1.23.3-debian-11-r3</span>
</span><span class='line'><span class="s">            EOT</span>,
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>      + <span class="nv">verify</span>                     <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">version</span>                    <span class="o">=</span> <span class="s2">&quot;13.2.20&quot;</span>
</span><span class='line'>      + <span class="nb">wait</span>                       <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">wait_for_jobs</span>              <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>
</span><span class='line'>      + <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'>          + <span class="nv">name</span>  <span class="o">=</span> <span class="s2">&quot;image.tag&quot;</span>
</span><span class='line'>          + <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;1.23.3-debian-11-r3&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">1</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + <span class="nv">metadata</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once we are happy with our plan, we can run a apply:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform apply
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">1</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + <span class="nv">metadata</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Do you want to perform these actions?
</span><span class='line'>  Terraform will perform the actions described above.
</span><span class='line'>  Only <span class="s1">&#39;yes&#39;</span> will be accepted to approve.
</span><span class='line'>
</span><span class='line'>  Enter a value: yes
</span><span class='line'>
</span><span class='line'>helm_release.nginx: Creating...
</span><span class='line'>helm_release.nginx: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="nv">metadata</span> <span class="o">=</span> tolist<span class="o">([</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;app_version&quot;</span> <span class="o">=</span> <span class="s2">&quot;1.23.3&quot;</span>
</span><span class='line'>    <span class="s2">&quot;chart&quot;</span> <span class="o">=</span> <span class="s2">&quot;nginx&quot;</span>
</span><span class='line'>    <span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="s2">&quot;nginx&quot;</span>
</span><span class='line'>    <span class="s2">&quot;namespace&quot;</span> <span class="o">=</span> <span class="s2">&quot;apps&quot;</span>
</span><span class='line'>    <span class="s2">&quot;revision&quot;</span> <span class="o">=</span> 1
</span><span class='line'>    <span class="s2">&quot;values&quot;</span> <span class="o">=</span> <span class="s2">&quot;{\&quot;image\&quot;:{\&quot;registry\&quot;:\&quot;docker.io\&quot;,\&quot;repository\&quot;:\&quot;bitnami/nginx\&quot;,\&quot;tag\&quot;:\&quot;1.23.3-debian-11-r3\&quot;},\&quot;nameOverride\&quot;:\&quot;nginx\&quot;}&quot;</span>
</span><span class='line'>    <span class="s2">&quot;version&quot;</span> <span class="o">=</span> <span class="s2">&quot;13.2.20&quot;</span>
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we can verify if the pod is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get pods -n apps
</span><span class='line'>NAME                    READY   STATUS    RESTARTS   AGE
</span><span class='line'>nginx-59bdc6465-xdbfh   1/1     Running   <span class="m">0</span>          2m35s
</span></code></pre></td></tr></table></div></figure>


<h2>Importing Helm Releases into Terraform State</h2>

<p>If you have an existing helm release that was deployed with helm and you want to transfer the ownership to terraform, you first need to write the terraform code, then import the resources into terraform state using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform import helm_release.nginx apps/nginx
</span></code></pre></td></tr></table></div></figure>


<p>Where the last argument is <code>&lt;namespace&gt;/&lt;release-name&gt;</code>. Once that is imported you can run terraform plan and apply.</p>

<p>If you want to discover all helm releases managed by helm you can use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get all -A -l app.kubernetes.io/managed-by<span class="o">=</span>Helm
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>

<ul>
<li>Linktree: <a href="https://go.ruan.dev/links">https://go.ruan.dev/links</a></li>
<li>Patreon: <a href="https://go.ruan.dev/patreon">https://go.ruan.dev/patreon</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  


<span class="byline author vcard">Posted by <span class="fn">Ruan</span></span>


      




<time class='entry-date' datetime='2023-03-09T16:15:47-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>4:15 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/helm/'>helm</a>, <a class='category' href='/blog/categories/kubernetes/'>kubernetes</a>, <a class='category' href='/blog/categories/terraform/'>terraform</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://blog.ruanbekker.com/blog/2023/03/09/manage-helm-releases-with-terraform/" data-via="ruanbekker" data-counturl="https://blog.ruanbekker.com/blog/2023/03/09/manage-helm-releases-with-terraform/" >Tweet</a>
  
  
  
</div>

    
    <!-- https://www.undefinednull.com/2013/10/15/octopress-blog-tweaks-adding-author-information-section-below-each-posts/ -->
    <!-- include custom/carbon-ads.html -->
    <div class="about">
     <span class="about-image">
          <img src="/images/author.png" alt="Ruan Bekker">
     </span>
     <span class="about-desc">
          <span>My name is <a href="https://ruan.dev">Ruan</a>, I'm a DevOps Engineer from South Africa. I'm passionate
          about AWS, OpenSource, Observability, Containers, Linux, Automation and sharing my findings with the world.
          More info about me on my website, <a href="https://ruan.dev">ruan.dev</a>.</span>
          <br/>
          <hr/>
          <a href="https://twitter.com/ruanbekker" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @ruanbekker</a>
     </span>
</div>

    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2023/03/05/persisting-terraform-remote-state-in-gitlab/" title="Previous Post: Persisting Terraform Remote State in Gitlab">&laquo; Persisting Terraform Remote State in Gitlab</a>
      
      
        <a class="basic-alignment right" href="/blog/2023/05/17/running-a-multi-broker-kafka-cluster-on-docker/" title="Next Post: Running a Multi-Broker Kafka Cluster on Docker">Running a Multi-Broker Kafka Cluster on Docker &raquo;</a>
      
    </p>
  </footer>
</article>
<!-- google advertisements -->
    <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->

 


</div>

<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Carbon</h1>
  <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CEAIP2JL&placement=blogruanbekkercom" id="_carbonads_js"></script>
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>

<section>
  <h1>Say Hi!</h1>
  Send me a note using the <a href="https://saythanks.io/to/ruanbekker">saythanks.io</a> project.
</section>

<section>
  <h1>Newsletter</h1>
  View my newsletter on <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog" target="_blank">digests.ruanbekker.com</a>
</section>

<section>
  <h1>Cheetsheet Repository</h1>
  Have a look at my <strong>Cheetsheets Github Repository</strong>:
  <p></p>
  <a href="https://github.com/ruanbekker/cheatsheets" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719365-1d8a05e2-a0d3-4078-a84f-c691544e4b8f.png" width="480" height="240"></a>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2023/12/22/how-to-use-cert-manager-dns-challenge-with-cloudflare-on-kubernetes-with-helm/">How to Use Cert-Manager DNS Challenge With Cloudflare on Kubernetes With Helm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/12/22/how-to-deploy-ingress-nginx-controller-on-kubernetes-with-helm/">How to Deploy Ingress-Nginx Controller on Kubernetes With Helm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/08/03/creating-a-python-lambda-function-with-terraform-on-aws/">Creating a Python Lambda Function With Terraform on AWS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/07/15/how-to-use-the-mysql-terraform-provider/">How to Use the MySQL Terraform Provider</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/07/15/how-to-use-the-aws-terraform-provider/">How to Use the AWS Terraform Provider</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest elasticsearch cheatsheet in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719853-fe9a50a4-03f2-4a26-a422-0deb946ca09c.png" width="480" height="240"></a>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2024 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ruanbekker" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
