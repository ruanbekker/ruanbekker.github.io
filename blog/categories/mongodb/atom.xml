<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Mongodb | Ruan Bekker's Blog]]></title>
  <link href="http://blog.ruanbekker.com/blog/categories/mongodb/atom.xml" rel="self"/>
  <link href="http://blog.ruanbekker.com/"/>
  <updated>2018-03-28T02:06:09-04:00</updated>
  <id>http://blog.ruanbekker.com/</id>
  <author>
    <name><![CDATA[Ruan]]></name>
    <email><![CDATA[ruan@ruanbekker.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Create a Chatbot With Chatterbot on Python]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/12/13/create-a-chatbot-with-chatterbot-on-python/"/>
    <updated>2017-12-13T08:53:50-05:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/12/13/create-a-chatbot-with-chatterbot-on-python</id>
    <content type="html"><![CDATA[<p><img src="https://chatterbot.readthedocs.io/en/stable/_images/banner.png" alt="" /></p>

<p>So I&rsquo;ve been wanting to take a stab at chatbots for some time, and recently discovered <a href="https://github.com/gunthercox/ChatterBot">Chatterbot</a>, so in this tutorial I will go through some examples on setting up a very basic chatbot.</p>

<h2>Getting the Dependencies:</h2>

<p>I will be using Alpine on <a href="docker.com">Docker</a> to run all the the examples, I am using Alpine so that we have a basic container with nothing special pre-installed.</p>

<p>Chatterbot is written in Python, so let&rsquo;s install Python and Chatterbot:</p>

<pre><code class="bash">$ docker run -it --name chatbot alpine:edge sh
$ apk update &amp;&amp; apk add python py2-pip
$ pip install pip --upgrade --user
$ pip install chatterbot
</code></pre>

<h2>Setup the Basic Chatbot:</h2>

<p>Now that our dependencies is installed, enter the Python interpreter where we will instantiate our Chatbot, and get a response from our Chatbot. By default the library will create a sqlite database to build up statements that is passed to and from the bot.</p>

<p>At this point, the bot is still pretty useless:</p>

<pre><code class="bash">$ python
&gt;&gt;&gt; from chatterbot import ChatBot
&gt;&gt;&gt; chatbot = ChatBot('Ben')
&gt;&gt;&gt; chatbot.get_response('What is your name?')
&lt;Statement text:What is your name?&gt;
&gt;&gt;&gt; chatbot.get_response('My name is Ruan, what is your name?')
&lt;Statement text:What is your name?&gt;
</code></pre>

<h2>Training your Bot:</h2>

<p>To enable your bot to have some knowledge, we can train the bot with training data. The training data is populated in a list, which will represent the conversation.</p>

<p>Exit the python interpreter and delete the sqlite database:</p>

<pre><code class="bash">$ rm -rf db.sqlite3
</code></pre>

<p>Now our Bot wont have any history of what we said. Start the interpreter again and add some data to train our bot. In this example, we want our Chatbot to respond when we ask it, what his name is:</p>

<pre><code class="bash">&gt;&gt;&gt; from chatterbot import ChatBot
&gt;&gt;&gt; from chatterbot.trainers import ListTrainer
&gt;&gt;&gt; chatbot = ChatBot('Ben')
&gt;&gt;&gt; chatbot.set_trainer(ListTrainer)
&gt;&gt;&gt; chatbot.train(['What is your name?', 'My name is Ben'])
List Trainer: [####################] 100%
</code></pre>

<p>Now that we have trained our bot, let&rsquo;s try to chat to our bot:</p>

<pre><code class="bash">&gt;&gt;&gt; chatbot.get_response('What is your name?')
&lt;Statement text:My name is Ben&gt;
&gt;&gt;&gt; chatbot.get_response('Who is Ben?')
&lt;Statement text:My name is Ben&gt;
</code></pre>

<p>We can also enable our bot to respond on multiple statements:</p>

<pre><code class="bash">&gt;&gt;&gt; chatbot.train(['Do you know someone with the name of Sarah?', 'Yes, my sisters name is Sarah', 'Is your sisters name, Sarah?', 'Faw shizzle!'])
List Trainer: [####################] 100%

&gt;&gt;&gt; chatbot.get_response('do you know someone with the name of Sarah?')
&lt;Statement text:Yes, my sisters name is Sarah&gt;
&gt;&gt;&gt; chatbot.get_response('is your sisters name Sarah?')
&lt;Statement text:Faw shizzle!&gt;
</code></pre>

<p>With that said, we can define our list of statements in our code:</p>

<pre><code class="python">&gt;&gt;&gt; conversations = [
...     'Are you an athlete?', 'No, are you mad? I am a bot',
...     'Do you like big bang theory?', 'Bazinga!',
...     'What is my name?', 'Ruan',
...     'What color is the sky?', 'Blue, stop asking me stupid questions'
... ]

&gt;&gt;&gt; chatbot.train(conversations)
List Trainer: [####################] 100%
&gt;&gt;&gt; chatbot.get_response('What color is the sky?')
&lt;Statement text:Blue, stop asking me stupid questions&gt;
</code></pre>

<p>So we can see it works as expected, but let&rsquo;s state one of the answers from our statements, to see what happens:</p>

<pre><code class="bash">&gt;&gt;&gt; chatbot.get_response('Bazinga')
&lt;Statement text:What is my name?&gt;
&gt;&gt;&gt; chatbot.get_response('Your name is Ben')
&lt;Statement text:Yes, my name is Ben&gt;
</code></pre>

<p>So we can see it uses natural language processing to learn from the data that we provide our bot. Just to check another question:</p>

<pre><code class="bash">&gt;&gt;&gt; chatbot.get_response('Do you like big bang theory?')
&lt;Statement text:Bazinga!&gt;
</code></pre>

<p>If we have quite a large subset of learning data, we can add all the data in a file, seperated by new lines then we can use python to read the data from disk, and split up the data in the expected format.</p>

<p>The training file will reside in our working directory, let&rsquo;s name it <code>training-data.txt</code> and the content will look like this:</p>

<pre><code class="bash">What is Bitcoin?
Bitcoin is a Crypto Currency
Where is this blog hosted?
Github
</code></pre>

<p>A visual example of how we will process this data will look like this:</p>

<pre><code class="bash">&gt;&gt;&gt; data = open('training-data.txt').read()
&gt;&gt;&gt; data.strip().split('\n')
['What is Bitcoin?', 'Bitcoin is a Crypto Currency', 'Where is this blog hosted?', 'Github']
</code></pre>

<p>And in action, it will look like this:</p>

<pre><code class="bash">&gt;&gt;&gt; data = open('training-data.txt').read()
&gt;&gt;&gt; conversations = data.strip().split('\n')
&gt;&gt;&gt; chatbot.train(conversations)
List Trainer: [####################] 100%

&gt;&gt;&gt; chatbot.get_response('Where is this blog hosted?')
&lt;Statement text:Github&gt;
</code></pre>

<p>There is also pre-populated data that you can use to train your bot, on the <a href="https://chatterbot.readthedocs.io/en/stable/training.html#training-with-corpus-data">documentation</a> is a couple of examples, but for demonstration, we will use the CorpusTrainer:</p>

<pre><code class="bash">&gt;&gt;&gt; from chatterbot.trainers import ChatterBotCorpusTrainer
&gt;&gt;&gt; chatterbot.set_trainer(ChatterBotCorpusTrainer)
&gt;&gt;&gt; chatbot.train("chatterbot.corpus.english")
ai.yml Training: [####################] 100%
botprofile.yml Training: [####################] 100%
computers.yml Training: [####################] 100%
conversations.yml Training: [####################] 100%
emotion.yml Training: [####################] 100%
food.yml Training: [####################] 100%
gossip.yml Training: [####################] 100%
greetings.yml Training: [####################] 100%
history.yml Training: [####################] 100%
humor.yml Training: [####################] 100%
literature.yml Training: [####################] 100%
money.yml Training: [####################] 100%
movies.yml Training: [####################] 100%
politics.yml Training: [####################] 100%
psychology.yml Training: [####################] 100%
science.yml Training: [####################] 100%
sports.yml Training: [####################] 100%
trivia.yml Training: [####################] 100%

&gt;&gt;&gt; chatbot.get_response('Do you like peace?')
&lt;Statement text:not especially. i am not into violence.&gt;
&gt;&gt;&gt; chatbot.get_response('Are you emotional?')
&lt;Statement text:Sort of.&gt;
&gt;&gt;&gt; chatbot.get_response('What language do you speak?')
&lt;Statement text:Python.&gt;
&gt;&gt;&gt; chatbot.get_response('What is your name?')
&lt;Statement text:My name is Ben&gt;
&gt;&gt;&gt; chatbot.get_response('Who is the President of America?')
&lt;Statement text:Richard Nixon&gt; #data seems outdated :D
&gt;&gt;&gt; chatbot.get_response('I like cheese')
&lt;Statement text:What kind of movies do you like?&gt;
</code></pre>

<h2>Using an External Database like MongoDB</h2>

<p>Instead of using sqlite on the same host, we can use a NoSQL Database like MongoDB that resides outside our application.</p>

<p>For the sake of this tutorial, I will use Docker to spin up a MongoDB Container:</p>

<pre><code class="bash">$ docker run -d --name mongodb -p 27017:27017 -p 28017:28017 -e AUTH=no -e OPLOG_SIZE=50 tutum/mongodb
</code></pre>

<p>Below is my code of a terminal application that uses Chatterbot, MongoDB as a Storage Adapter, and we are using a while loop, so that we can chat with our bot, and in our except statement, we can stop our application by using our keyboard to exit:</p>

<pre><code class="python">from chatterbot import ChatBot
from chatterbot.trainers import ChatterBotCorpusTrainer

chatbot = ChatBot(
    "Chatbot Backed by MongoDB",
    storage_adapter="chatterbot.storage.MongoDatabaseAdapter",
    database="chatterbot_db",
    database_uri="mongodb://172.17.0.3:27017/",
    logic_adapters=[
        'chatterbot.logic.BestMatch'
    ],
    trainer='chatterbot.trainers.ChatterBotCorpusTrainer',
    filters=[
        'chatterbot.filters.RepetitiveResponseFilter'
    ],
    input_adapter='chatterbot.input.TerminalAdapter',
    output_adapter='chatterbot.output.TerminalAdapter'
)

chatbot.set_trainer(ChatterBotCorpusTrainer)
chatbot.train("chatterbot.corpus.english")

print('Chatbot Started:')

while True:
    try:
        print(" -&gt; You:")
        botInput = chatbot.get_response(None)
    except (KeyboardInterrupt, EOFError, SystemExit):
        break
</code></pre>

<p>Running the example:</p>

<pre><code class="bash">$ python bot.py
 -&gt; You:
How are you?
I am doing well.
 -&gt; You:
Tell me a joke
A 3-legged dog walks into an old west saloon, slides up to the bar and announces "I'm looking for the man who shot my paw."
</code></pre>

<p>And from mongodb, we can see some data:</p>

<pre><code class="bash">$ mongo
&gt; show dbs
admin          0.078GB
chatterbot_db  0.078GB
local          0.078GB

&gt; use chatterbot_db
switched to db chatterbot_db

&gt; show collections;
conversations
statements
system.indexes

&gt; db.conversations.find().count()
4
&gt; db.statements.find().count()
1240
&gt; db.system.indexes.find().count()
3
</code></pre>

<p>That was a basic tutorial on Chatterbot, next I will be looking into mining data from Twitter&rsquo;s API and see how clever our bot can become.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://chatterbot.readthedocs.io/en/stable/quickstart.html#quick-start-guide">Chatterbot Documentation</a></li>
<li><a href="https://github.com/gunthercox/ChatterBot/tree/master/examples">Chatterbot Examples</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Backup and Restore Mutliple Collections From a Database With MongoDB]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/10/03/backup-and-restore-mutliple-collections-from-a-database-with-mongodb/"/>
    <updated>2017-10-03T16:42:34-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/10/03/backup-and-restore-mutliple-collections-from-a-database-with-mongodb</id>
    <content type="html"><![CDATA[<p>From a previous post we&rsquo;ve  <a href="http://blog.ruanbekker.com/blog/2017/09/02/setup-a-3-node-mongodb-replica-set-on-ubuntu-16/">Setup a MongoDB Cluster</a>, and in this post we will go through the steps of backing up a database and restoring it to another mongodb cluster.</p>

<p><a href="http://mlab.com/">MLab</a> offers a free Shared MongoDB Hosted Service with a limitation of 500MB, which I will be using to restore my data from my own hosted cluster to the free MLab service.</p>

<h2>Create the MongoDB Backup</h2>

<p>First we will need to create our backup path, and then backup our database, in my case, I am backing up my <code>rocketchat</code> database:</p>

<pre><code class="bash">$ mkdir -p /opt/backups/mongodb
$ mongodump --host mongodb.example.com --port 27017 -u &lt;mongouser&gt; --authenticationDatabase &lt;authdb&gt; --db rocketchat --out /opt/backups/mongodb/
</code></pre>

<p>Change into the backup directory:</p>

<pre><code class="bash">$ cd /opt/backups/mongodb/rocketchat/ 
</code></pre>

<p>You will find the <code>bson</code> and <code>json metadata</code> files for each collection:</p>

<pre><code class="bash">$ ls -l | awk '{print $9}' | head -9
custom_emoji.chunks.bson
custom_emoji.chunks.metadata.json
custom_emoji.files.bson
custom_emoji.files.metadata.json
instances.bson
instances.metadata.json
meteor_accounts_loginServiceConfiguration.bson
meteor_accounts_loginServiceConfiguration.metadata.json
...
</code></pre>

<h2>Restore MongoDB Database</h2>

<p>We will need to restore all the collections to our new mongodb service, I have created a bash script (<code>restore-mongodb.sh</code>) that will restore each collection to our <code>rocketchat</code> database:</p>

<pre><code class="bash">#!/usr/bin/env bash

mongo_user=&lt;mongouser&gt;
mongo_pass=&lt;mongopass&gt;

for file in `ls | grep bson`
  do
    for collection in `echo $file | sed 's/.bson//g'`
  do
    mongorestore --host mymongoid.mlab.com --port 12345 -u $mongo_user -p $mongo_pass -d rocketchat -c $collection $file
    sleep 2
  done
done
</code></pre>

<p>Change the permissions of your script to make it executable and execute the script:</p>

<pre><code>$ chmod +x restore-mongodb.sh
$ ./restore-mongodb.sh

2017-10-03T22:05:39.138+0200    checking for collection data in custom_emoji.chunks.bson
2017-10-03T22:05:39.159+0200    reading metadata for rocketchat.custom_emoji.chunks from custom_emoji.chunks.metadata.json
2017-10-03T22:05:39.211+0200    restoring rocketchat.custom_emoji.chunks from custom_emoji.chunks.bson
2017-10-03T22:05:39.900+0200    restoring indexes for collection rocketchat.custom_emoji.chunks from metadata
2017-10-03T22:05:39.922+0200    finished restoring rocketchat.custom_emoji.chunks (20 documents)
2017-10-03T22:05:39.922+0200    done
2017-10-03T22:05:42.188+0200    checking for collection data in custom_emoji.files.bson
2017-10-03T22:05:42.231+0200    reading metadata for rocketchat.custom_emoji.files from custom_emoji.files.metadata.json
2017-10-03T22:05:42.252+0200    restoring rocketchat.custom_emoji.files from custom_emoji.files.bson
2017-10-03T22:05:42.623+0200    restoring indexes for collection rocketchat.custom_emoji.files from metadata
2017-10-03T22:05:42.645+0200    finished restoring rocketchat.custom_emoji.files (20 documents)
2017-10-03T22:05:42.645+0200    done
...
</code></pre>

<h2>Checkout the New MongoDB Database:</h2>

<p>Once the restore has been done, logon to your new mongodb database and have a look at the collections in the database:</p>

<pre><code>$ mongo mymongoid.mlab.com:12345/rocketchat -u &lt;mongouser&gt; -p
MongoDB shell version v3.4.7
Enter password:
connecting to: mongodb://mymongoid.mlab.com:12345/rocketchat
MongoDB server version: 3.4.9

rs-mymongoid:PRIMARY&gt; show collections
_raix_push_app_tokens
_raix_push_notifications
custom_emoji.chunks
custom_emoji.files
instances
</code></pre>

<h2>Resources:</h2>

<ul>
<li><a href="https://docs.mongodb.com/manual/reference/program/mongodump/">https://docs.mongodb.com/manual/reference/program/mongodump/</a></li>
<li><a href="https://docs.mongodb.com/manual/reference/program/mongorestore/">https://docs.mongodb.com/manual/reference/program/mongorestore/</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup RocketChat on Docker Swarm]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/10/setup-rocketchat-on-docker-swarm/"/>
    <updated>2017-09-10T18:45:12-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/10/setup-rocketchat-on-docker-swarm</id>
    <content type="html"><![CDATA[<p>Rocket Chat, a Self Hosted Alternative, which is very similar to Slack.</p>

<p>We will setup a RocketChat Server which is hosted on Docker Swarm. In future posts, I will also go through the steps on working with the API, Custom Emoji&rsquo;s etc.</p>

<h2>Requirements:</h2>

<p>RocketChat uses MongoDB as its Database, we will keep the database outside of our swarm, if you don&rsquo;t already have a MongoDB Server in place, follow the <a href="http://blog.ruanbekker.com/blog/2017/09/02/setup-a-3-node-mongodb-replica-set-on-ubuntu-16/">Setup a 3 Node MongoDB</a> post to get that sorted.</p>

<p>Another requirement is to have docker swarm running, alternatively, you can also follow <a href="https://rocket.chat/docs/installation/">RocketChat&rsquo;s Documentation</a> if you prefer setting it up elsewhere.</p>

<h2>Setup Rocket Chat</h2>

<p>We will assume MongoDB is accessible via <code>mongodb.domain.com</code> on port <code>27017</code>, with a username and password.</p>

<p>Creating the RocketChat service and associate it to our <code>appnet</code> overlay network:</p>

<pre><code class="bash">docker service create --name rocketchat \
--replicas 1 \
--network appnet \
--env DEPLOY_METHOD=docker \
--env NODE_ENV=production \
--env PORT=3000 \
--env MONGO_URL="mongodb://mongoadmin:mongopass@mongodb.domain.com:27017/rocketchat?authSource=admin" \
--env ROOT_URL=http://rocketchat.domain.com \
--env ADMIN_USERNAME=myadmin \
--env ADMIN_PASS=secret \
--env ADMIN_EMAIL=mail@domain.com \
--env Accounts_AvatarStorePath=/app/uploads \
--secret rocketchat_secret \
rocketchat/rocket.chat
</code></pre>

<h2>View the RocketChat Service Logs</h2>

<p>Lets monitor the docker service logs for our rocketchat service:</p>

<pre><code class="bash">$ docker service logs -f rocketchat

rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | Using GridFS for custom sounds storage
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | Using GridFS for custom emoji storage
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | ufs: temp directory created at "/tmp/ufs"
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | System startup
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | +--------------------------------------------------------------+
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |                        SERVER RUNNING                        |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | +--------------------------------------------------------------+
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |                                                              |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |  Rocket.Chat Version: 0.58.2                                 |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |       NodeJS Version: 4.8.4 - x64                            |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |             Platform: linux                                  |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |         Process Port: 3000                                   |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |             Site URL: http://rocketchat.domain.com           |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |     ReplicaSet OpLog: Disabled                               |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |          Commit Hash: 988103d449                             |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |        Commit Branch: HEAD                                   |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | |                                                              |
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | +--------------------------------------------------------------+
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | Inserting admin user:
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | Name: Administrator
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | Email: mail@domain.com
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | Username: myadmin
rocketchat.1.lnbyfjiotqpz@docker-swarm-worker-03    | Password: secret
</code></pre>

<p>Now you should be able to access Rocket Chat on the <code>ROOT_URL</code> that you have specified.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://rocket.chat/docs/installation/">https://rocket.chat/docs/installation/</a></li>
<li><a href="https://github.com/RocketChat/Docker.Official.Image">https://github.com/RocketChat/Docker.Official.Image</a></li>
<li><a href="https://rocket.chat/docs/installation/docker-containers">https://rocket.chat/docs/installation/docker-containers</a></li>
</ul>


<center>
        <script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Buy Me a Coffee', '#46b798', 'A6423ZIQ');kofiwidget2.draw();</script>
</center>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a 3 Node MongoDB Replica Set on Ubuntu 16]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/09/02/setup-a-3-node-mongodb-replica-set-on-ubuntu-16/"/>
    <updated>2017-09-02T19:29:10-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/09/02/setup-a-3-node-mongodb-replica-set-on-ubuntu-16</id>
    <content type="html"><![CDATA[<p>Today we will setup a 3 Node Replica Set for MongoDB on Ubuntu 16. A Replica Set is a form of data replication, so that your data resides on more than one node for data durability. We will setup the 1st node as the primary node, the second as the secondary node and the 3rd node will act as an arbiter.</p>

<p>The arbiter node can almost be mentioned as a voter node, as it will be set in place to prevent split brain.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://eladnava.com/deploy-a-highly-available-mongodb-replica-set-on-aws/">https://eladnava.com/deploy-a-highly-available-mongodb-replica-set-on-aws/</a></li>
<li><a href="https://stackoverflow.com/questions/38524150/mongodb-replica-set-with-simple-password-authentication">https://stackoverflow.com/questions/38524150/mongodb-replica-set-with-simple-password-authentication</a> (auth)</li>
<li><a href="https://stackoverflow.com/questions/14789622/mongodb-keyfile-too-open-permissions">https://stackoverflow.com/questions/14789622/mongodb-keyfile-too-open-permissions</a></li>
</ul>


<h2>Installing MongoDB on our 3 Nodes:</h2>

<p>Our case, using Ubuntu 16.04, setting up our repository and installing mongodb from our repository:</p>

<pre><code class="bash">$ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6
$ echo "deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list
$ apt update
$ apt install -y mongodb-org -y
</code></pre>

<p>Preparing our Directories:</p>

<pre><code class="bash">$ mkdir -p /srv/mongodb/rs0-0 /srv/mongodb/rs0-1 /srv/mongodb/rs0-2
$ mkdir -p /var/log/mongodb/rs0-0 /var/log/mongodb/rs0-1 /var/log/mongodb/rs0-2
</code></pre>

<p>Populating our MongoDB Configuration:</p>

<ul>
<li>MongoDB Prefers XFS File Systems when using WiredTiger.</li>
</ul>


<pre><code class="bash">$ cat &gt; /etc/mongod.conf &lt;&lt; EOF
storage:
  dbPath: /var/lib/mongodb
  journal:
    enabled: false

storage:
  mmapv1:
    smallFiles: true

systemLog:
  destination: file
  logAppend: true
  path: /var/log/mongodb/mongod.log

net:
  port: 27017
  bindIp: 0.0.0.0

replication:
  replSetName: rs0

security:
  authorization: enabled
EOF
</code></pre>

<p>Enable MongoDB On Startup and Start MongoDB:</p>

<pre><code class="bash">$ systemctl enable mongod
$ systemctl restart mongod
</code></pre>

<h2>Setup MongoDB Replica Sets:</h2>

<p>In our setup we will have 3 nodes: (mongodb-1, mongodb-2, mongodb3) From our Primary Node, connect to MongoDB and inititalize our replica set:</p>

<pre><code class="bash">$ mongo 
MongoDB shell version v3.4.7
connecting to: mongodb://127.0.0.1:27017
MongoDB server version: 3.4.7
&gt; rs.initiate()
{
        "info2" : "no configuration specified. Using a default configuration for the set",
        "me" : "mysql-1:27017",
        "ok" : 1
}
</code></pre>

<p>Next, add our 2 other MongoDB Nodes, remember <code>mongodb-3</code> is our arbiter node:</p>

<pre><code class="bash">rs0:SECONDARY&gt; rs.add("mongodb-2")
{ "ok" : 1 }
rs0:PRIMARY&gt; rs.add("mongodb-3", true)
{ "ok" : 1 }
</code></pre>

<p>Verify the Replica Set Status:</p>

<pre><code class="bash">rs0:PRIMARY&gt; rs.status()
</code></pre>

<pre><code class="json">{
        "set" : "rs0",
        "date" : ISODate("2017-08-27T13:17:42.469Z"),
        "myState" : 1,
        "term" : NumberLong(1),
        "heartbeatIntervalMillis" : NumberLong(2000),
        "optimes" : {
                "lastCommittedOpTime" : {
                        "ts" : Timestamp(0, 0),
                        "t" : NumberLong(-1)
                },
                "appliedOpTime" : {
                        "ts" : Timestamp(1503839853, 1),
                        "t" : NumberLong(1)
                },
                "durableOpTime" : {
                        "ts" : Timestamp(1503839722, 1),
                        "t" : NumberLong(-1)
                }
        },
        "members" : [
                {
                        "_id" : 0,
                        "name" : "mysql-1:27017",
                        "health" : 1,
                        "state" : 1,
                        "stateStr" : "PRIMARY",
                        "uptime" : 422,
                        "optime" : {
                                "ts" : Timestamp(1503839853, 1),
                                "t" : NumberLong(1)
                        },
                        "optimeDate" : ISODate("2017-08-27T13:17:33Z"),
                        "electionTime" : Timestamp(1503839723, 1),
                        "electionDate" : ISODate("2017-08-27T13:15:23Z"),
                        "configVersion" : 3,
                        "self" : true
                },
                {
                        "_id" : 1,
                        "name" : "mongodb-2:27017",
                        "health" : 1,
                        "state" : 2,
                        "stateStr" : "SECONDARY",
                        "uptime" : 28,
                        "optime" : {
                                "ts" : Timestamp(1503839853, 1),
                                "t" : NumberLong(1)
                        },
                        "optimeDurable" : {
                                "ts" : Timestamp(0, 0),
                                "t" : NumberLong(-1)
                        },
                        "optimeDate" : ISODate("2017-08-27T13:17:33Z"),
                        "optimeDurableDate" : ISODate("1970-01-01T00:00:00Z"),
                        "lastHeartbeat" : ISODate("2017-08-27T13:17:41.707Z"),
                        "lastHeartbeatRecv" : ISODate("2017-08-27T13:17:40.699Z"),
                        "pingMs" : NumberLong(4),
                        "syncingTo" : "mysql-1:27017",
                        "configVersion" : 3
                },
                {
                        "_id" : 2,
                        "name" : "mongodb-3:27017",
                        "health" : 1,
                        "state" : 7,
                        "stateStr" : "ARBITER",
                        "uptime" : 8,
                        "lastHeartbeat" : ISODate("2017-08-27T13:17:41.721Z"),
                        "lastHeartbeatRecv" : ISODate("2017-08-27T13:17:38.749Z"),
                        "pingMs" : NumberLong(2),
                        "configVersion" : 3
                }
        ],
        "ok" : 1
}
rs0:PRIMARY&gt; exit
bye
</code></pre>

<h2>Setup Auth:</h2>

<p>Setup Authentication on our MongoDB Database, we will create the user <code>adminuser</code> and setup the password to <code>secret</code>:</p>

<pre><code class="bash">rs0:PRIMARY&gt; use admin
switched to db admin

rs0:PRIMARY&gt; db.createUser({user: "adminuser", pwd: "secret", roles:[{role: "root", db: "admin"}]})
</code></pre>

<pre><code class="json">Successfully added user: {
        "user" : "adminuser",
        "roles" : [
                {
                        "role" : "root",
                        "db" : "admin"
                }
        ]
}
rs0:PRIMARY&gt; exit
</code></pre>

<p>Restart MongoDB:</p>

<pre><code class="bash">$ systemctl restart mongod
</code></pre>

<h2>Connect and Authenticate against MongoDB:</h2>

<p>Connect to your MongoDB Cluster with auth:</p>

<pre><code class="bash">$ mongo --host mongodb.example.com --port 27017 -u &lt;username&gt; -p --authenticationDatabase admin
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using the Python API for MongoDB Using PyMongo]]></title>
    <link href="http://blog.ruanbekker.com/blog/2017/08/27/using-the-python-api-for-mongodb-using-pymongo/"/>
    <updated>2017-08-27T16:19:48-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2017/08/27/using-the-python-api-for-mongodb-using-pymongo</id>
    <content type="html"><![CDATA[<p>Using the Python API for MongoDB using Pymongo</p>

<h2>Requirements:</h2>

<p>You will need to install the <code>pymongo</code> driver using pip:</p>

<pre><code class="bash Install Pymongo">$ pip install pymongo
</code></pre>

<p>A configuration file with your access credentials, which I like to use outside my code:</p>

<pre><code class="bash config.py">credentials = {
    "mongodb": {
        "HOSTNAME": "host.domain.com",
        "USERNAME": "username",
        "PASSWORD": "password"
    }
}
</code></pre>

<h2>Connecting to MongoDB:</h2>

<p>From the python interpreter, connect to MongoDB:</p>

<pre><code class="python ">&gt;&gt;&gt; from pymongo import MongoClient
&gt;&gt;&gt; from config import credentials as secrets
&gt;&gt;&gt; mongo_host = secrets['mongodb']['HOSTNAME']
&gt;&gt;&gt; mongo_username = secrets['mongodb']['USERNAME']
&gt;&gt;&gt; mongo_password = secrets['mongodb']['PASSWORD']
&gt;&gt;&gt; mongodb_client = MongoClient('mongodb://%s:%s@%s:27017/admin?authMechanism=SCRAM-SHA-1' % (mongo_username, mongo_password, mongo_host))
</code></pre>

<p>Find the Database that you are connected to:</p>

<pre><code class="python">&gt;&gt;&gt; mongodb_client.get_database().name
u'admin'
</code></pre>

<p>Find all the databases that is currently on your MongoDB Server:</p>

<pre><code class="python">&gt;&gt;&gt; dbs = mongodb_client.database_names()
&gt;&gt;&gt; for x in dbs:
...     print(x)
...
admin
flask_reminders
local
</code></pre>

<h2>Create a Database, Collection and Write a Document into your Database:</h2>

<p>Let&rsquo;s create a database, in my case it will be <code>ruan-test</code>, and my collection name <code>mycollection</code> and the write one item into it:</p>

<pre><code class="python">&gt;&gt;&gt; newdb = mongodb_client['ruan-test']
&gt;&gt;&gt; newdb_collection = newdb['mycollection']
&gt;&gt;&gt; doc = {"name": "frank", "surname": "jeffreys", "tags": ["person", "name"]}
&gt;&gt;&gt; doc_id = newdb_collection.insert_one(doc).inserted_id
&gt;&gt;&gt; print(doc_id)
59a319ec1f15a5088ba3a339
</code></pre>

<p>Note: you can also connect to your collection like the following</p>

<pre><code class="python">&gt;&gt;&gt; newdb_collection = mongodb_client['ruan-test']['mycollection']
</code></pre>

<p>We have inserted one item into our database, which we can verify with <code>count()</code>:</p>

<pre><code class="python">&gt;&gt;&gt; newdb_collection.find().count()
1
</code></pre>

<p>As you can see I have the value of the item&rsquo;s id, we can use that to find it from our collection:</p>

<pre><code class="python">&gt;&gt;&gt; newdb_collection.find_one({"_id": doc_id})
{u'_id': ObjectId('59a319ec1f15a5088ba3a339'), u'surname': u'jeffreys', u'name': u'frank', u'tags': [u'person', u'name']}
</code></pre>

<p>As we only have one item in our database, we can also use <code>find_one()</code> which will give us the exact same data:</p>

<pre><code class="python">&gt;&gt;&gt; newdb_collection.find_one()
{u'_id': ObjectId('59a319ec1f15a5088ba3a339'), u'surname': u'jeffreys', u'name': u'frank', u'tags': [u'person', u'name']}
</code></pre>

<p>We can write some more data to our database, but this time, lets write to a different collection:</p>

<pre><code class="python">&gt;&gt;&gt; newdb_collection2 = newdb['new-collection-2']
&gt;&gt;&gt; item = newdb_collection2.insert_one({"name": "ruby", "surname": "james"}).inserted_id
&gt;&gt;&gt; item2 = newdb_collection2.insert_one({"name": "ruby", "surname": "james"}).inserted_id
</code></pre>

<p>As we captured the items <code>_id</code>, we can view the:</p>

<pre><code class="python">&gt;&gt;&gt; print(item)
59a31acf1f15a5088ba3a33b
&gt;&gt;&gt; print(item2)
59a31a8a1f15a5088ba3a33a
</code></pre>

<h2>Query Data from MongoDB:</h2>

<p>We can then query for this data:</p>

<pre><code class="python">&gt;&gt;&gt; newdb2.find_one({"name": "ruby"})
{u'_id': ObjectId('59a31acf1f15a5088ba3a33b'), u'surname': u'james', u'name': u'ruby'}

&gt;&gt;&gt; newdb2.find_one({"_id": item})
{u'_id': ObjectId('59a31acf1f15a5088ba3a33b'), u'surname': u'james', u'name': u'ruby'}
</code></pre>

<p>Also scan for all items in the collection:</p>

<pre><code class="python">&gt;&gt;&gt; scan = newdb_collection2.find({})
&gt;&gt;&gt; for x in scan:
...     print(x)
...
{u'_id': ObjectId('59a31a8a1f15a5088ba3a33a'), u'surname': u'james', u'name': u'phillip'}
{u'_id': ObjectId('59a31acf1f15a5088ba3a33b'), u'surname': u'james', u'name': u'ruby'}

&gt;&gt;&gt; newdb2.find().count()
2
</code></pre>

<p>We can now verify that we have 2 collections in our database:</p>

<pre><code class="python">&gt;&gt;&gt; newdb.collection_names()
[u'mycollection-2', u'mycollection']
</code></pre>

<h2>Connecting to an existing Database:</h2>

<p>Let&rsquo;s connect to an existing database on our MongoDB Server:</p>

<pre><code class="python">&gt;&gt;&gt; flaskdb = mongodb_client['flask_reminders']
</code></pre>

<p>List the collections:</p>

<pre><code class="python">&gt;&gt;&gt; flaskdb.collection_names()
[u'reminders', u'usersessions']
</code></pre>

<p>Count the number of items in our <code>reminders</code> Collection:</p>

<pre><code class="python">&gt;&gt;&gt; flaskdb.reminders.find().count()
624
</code></pre>

<p>Find a Random Item:</p>

<pre><code class="python">&gt;&gt;&gt; flaskdb.reminders.find_one()
{u'category': u'Python', u'description': u'Chatbot with SQLite', u'link': u'http://rodic.fr/blog/python-chatbot-1/', u'date': u'2017-01-03', u'_id': ObjectId('586bb6dd0269103671afce32'), u'type': u'Discovered Service'}
</code></pre>

<p>Find One Item, with a Specific Value, for example the value <code>AWS</code> for our <code>Category key</code>:</p>

<pre><code class="python">&gt;&gt;&gt; flaskdb.reminders.find_one({"category": "AWS"})
{u'category': u'AWS', u'description': u'Elasticsearch Documentation Access Policies', u'link': u'http://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-createupdatedomains.html#es-createdomain-configure-access-policies', u'date': u'2017-02-13', u'_id': ObjectId('58a1d45202691070616947c3'), u'type': u'Documentation'}
</code></pre>

<p>Find All Items, with a specific value:</p>

<pre><code class="python">&gt;&gt;&gt; data = flaskdb.reminders.find({"category": "AWS"})
&gt;&gt;&gt; for x in data:
...     print(x)
...
{u'category': u'Python', u'description': u'Chatbot with SQLite', u'link': u'http://rodic.fr/blog/python-chatbot-1/', u'date': u'2017-01-03', u'_id': ObjectId('586bb6dd0269103671afce32'), u'type': u'Discovered Service'}
{u'category': u'Python', u'description': u'Boto: Kinesis List', u'link': u'https://gitlab.com/rbekker87/code-examples/blob/master/kinesis/firehose/python/firehose.list.py', u'date': u'2017-01-05', u'_id': ObjectId('586dde1e0269103671afce36'), u'type': u'Stuff Done'}
</code></pre>

<h2>Deleting Databases:</h2>

<p>Cleaning up, deleting the database that we created, when a database is delete, the collections within that database also gets removed.</p>

<p>First list the databases:</p>

<pre><code>&gt;&gt;&gt; dbs = mongodb_client.database_names()
&gt;&gt;&gt; for x in dbs:
...     print(x)
...
admin
flask_reminders
local
ruan-test
</code></pre>

<p>Then delete the database that you want to delete:</p>

<pre><code class="python">&gt;&gt;&gt; mongodb_client.drop_database("ruan-test")
</code></pre>

<p>Then verify if the database was removed:</p>

<pre><code class="python">&gt;&gt;&gt; dbs = mongodb_client.database_names()
&gt;&gt;&gt; for x in dbs:
...     print(x)
...
admin
flask_reminders
local
</code></pre>

<h2>Resources:</h2>

<ul>
<li><a href="http://api.mongodb.com/python/current/tutorial.html">http://api.mongodb.com/python/current/tutorial.html</a></li>
<li><a href="https://docs.mongodb.com/getting-started/python/client/">https://docs.mongodb.com/getting-started/python/client/</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
