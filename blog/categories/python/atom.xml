<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Python | Ruan Bekker's Blog]]></title>
  <link href="http://blog.ruanbekker.com/blog/categories/python/atom.xml" rel="self"/>
  <link href="http://blog.ruanbekker.com/"/>
  <updated>2018-04-29T11:44:40-04:00</updated>
  <id>http://blog.ruanbekker.com/</id>
  <author>
    <name><![CDATA[Ruan]]></name>
    <email><![CDATA[ruan@ruanbekker.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Encryption and Decryption With Simple Crypt Using Python]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/04/29/encryption-and-decryption-with-simple-crypt-using-python/"/>
    <updated>2018-04-29T10:50:46-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/04/29/encryption-and-decryption-with-simple-crypt-using-python</id>
    <content type="html"><![CDATA[<p>Today I wanted to encrypt sensitive information to not expose passwords, hostnames etc. I wanted to have a way to encrypt my strings with a master password and stumbled upon Simple Crypt.</p>

<h2>Simple Crypt</h2>

<p>Why simple-crypt? Referenced from their <a href="https://pypi.org/project/simple-crypt/">docs</a>:</p>

<ul>
<li>Simple Crypt uses standard, well-known algorithms following the recommendations from <a href="http://www.daemonology.net/blog/2009-06-11-cryptographic-right-answers.html">this</a> link.</li>
<li>The PyCrypto library provides the algorithm implementation, where AES256 cipher is used.</li>
<li>It includes a check (an HMAC with SHA256) to warn when ciphertext data are modified.</li>
<li>It tries to make things as secure as possible when poor quality passwords are used (PBKDF2 with SHA256, a 256 bit random salt, and 100,000 rounds).</li>
<li>Using a library, rather than writing your own code, means that we have less solutions to the same problem.</li>
</ul>


<h2>Installing Simple-Crypt:</h2>

<p>From a base alpine image:</p>

<pre><code class="bash">$ apk update
$ apk add python python-dev py2-pip
$ apk add gcc g++ make libffi-dev openssl-dev
$ pip install simple-crypt
</code></pre>

<h2>Simple Examples:</h2>

<p>Two simple examples to encrypt and decrypt data with simple-crypt. We will use a password <code>sekret</code> and we will encrypt the string: <code>this is a secure message</code>:</p>

<pre><code class="python">&gt;&gt;&gt; from simplecrypt import encrypt, decrypt
&gt;&gt;&gt; password = 'sekret'
&gt;&gt;&gt; message = 'this is a secret message'
&gt;&gt;&gt; ciphertext = encrypt(password, message)
&gt;&gt;&gt;
&gt;&gt;&gt; print(ciphertext)
sc#$%^&amp;*(..........
</code></pre>

<p>Now that we have our encrypted string, lets decrypt it. First we will use the wrong password, so that you will see how the expected output should look when using a different password, than was used when it was encrypted:</p>

<pre><code class="python">&gt;&gt;&gt; print(decrypt('badpass', ciphertext))
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/usr/lib/python2.7/site-packages/simplecrypt/__init__.py", line 72, in decrypt
    _assert_hmac(hmac_key, hmac, hmac2)
  File "/usr/lib/python2.7/site-packages/simplecrypt/__init__.py", line 116, in _assert_hmac
    raise DecryptionException('Bad password or corrupt / modified data.')
simplecrypt.DecryptionException: Bad password or corrupt / modified data.
</code></pre>

<p>Now using the correct password to decrypt:</p>

<pre><code class="python">&gt;&gt;&gt; print(decrypt('sekret', ciphertext))
this is a secret message
</code></pre>

<h2>SimpleCrypt Base64 and Getpass</h2>

<p>I wanted to store the encrypted string in a database, but the ciphertext has a combination of random special characters, so I decided to encode the ciphertext with base64. And the password input will be used with the getpass module.</p>

<p>Our encryption app:</p>

<pre><code class="python encrypt.py">import sys
from simplecrypt import encrypt, decrypt
from base64 import b64encode, b64decode
from getpass import getpass

password = getpass()
message = sys.argv[1]

cipher = encrypt(password, message)
encoded_cipher = b64encode(cipher)
print(encoded_cipher)
</code></pre>

<p>Our decryption app:</p>

<pre><code class="python">import sys
from simplecrypt import encrypt, decrypt
from base64 import b64encode, b64decode
from getpass import getpass

password = getpass()
encoded_cipher = sys.argv[1]

cipher = b64decode(encoded_cipher)
plaintext = decrypt(password, cipher)
print(plaintext)
</code></pre>

<h2>Encrypt and Decrypting Data using our Scripts:</h2>

<p>Encrypting the string <code>this is a secret message</code>:</p>

<pre><code class="bash">$ python encrypt.py "this is a secret message"
Password: 
c2MAAnyfWIfOBV43vxo3sVCEYMG4C6hx69hv2Ii1JKlVHJUgBAlADJPOsD5cJO6MMI9faTDm1As/VfesvBzIe5S16mNyg2q7xfnP5iJ0RlK92vMNRbKOvNibg3M=
</code></pre>

<p>Now that we have our encoded ciphertext, lets decrypt it with the password that we encrypted it with:</p>

<pre><code class="bash">$ python decrypt.py 'c2MAAnyfWIfOBV43vxo3sVCEYMG4C6hx69hv2Ii1JKlVHJUgBAlADJPOsD5cJO6MMI9faTDm1As/VfesvBzIe5S16mNyg2q7xfnP5iJ0RlK92vMNRbKOvNibg3M='
Password: 
this is a secret message
</code></pre>

<p>This is one way of working with sensitive info that you would like to encrypt/decrypt.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Paramiko Module in Python to Execute Remote Bash Commands]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/04/23/using-paramiko-module-in-python-to-execute-remote-bash-commands/"/>
    <updated>2018-04-23T12:16:59-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/04/23/using-paramiko-module-in-python-to-execute-remote-bash-commands</id>
    <content type="html"><![CDATA[<p>Paramiko is a python implementation of the sshv2 protocol.</p>

<h2>Paramiko to execute Remote Commands:</h2>

<p>We will use paramiko module in python to execute a command on our remote server.</p>

<p>Client side will be referenced as (side-a) and Server side will be referenced as (side-b)</p>

<h2>Getting the Dependencies:</h2>

<p>Install Paramiko via pip on side-a:</p>

<pre><code class="bash">$ pip install paramiko --user
</code></pre>

<h2>Using Paramiko in our Code:</h2>

<p>Our Python Code:</p>

<pre><code class="python">import paramiko

ssh = paramiko.SSHClient()
ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
ssh.connect(hostname='192.168.10.10', username='ubuntu', key_filename='/home/ubuntu/.ssh/mykey.pem')

stdin, stdout, stderr = ssh.exec_command('lsb_release -a')

for line in stdout.read().splitlines():
    print(line)

ssh.close()
</code></pre>

<h2>Execute our Command Remotely:</h2>

<p>Now we will attempt to establish the ssh connection from side-a, then run <code>lsb_release -a</code> on our remote server, side-b:</p>

<pre><code class="bash">$ python execute.py

Distributor ID: Ubuntu
Description:    Ubuntu 16.04.4 LTS
Release:    16.04
Codename:   xenial
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setup a SSH Tunnel With the Sshtunnel Module in Python]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/04/23/setup-a-ssh-tunnel-with-the-sshtunnel-module-in-python/"/>
    <updated>2018-04-23T11:56:46-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/04/23/setup-a-ssh-tunnel-with-the-sshtunnel-module-in-python</id>
    <content type="html"><![CDATA[<p>Sometimes we need to restrict access to a port, where a port should listen on localhost, but you want to access that port from a remote source. One secure way of doing that, is to establish a SSH Tunnel to the remote side, and forward to port via the SSH Tunnel.</p>

<p>Today we will setup a Flask Web Service on our Remote Server (Side B) which will be listening on <code>127.0.0.1:5000</code> and setup the SSH Tunnel with the <code>sshtunnel</code> module in Python from our client side (Side A). Then we will make a GET request on our client side to the port that we are forwarding via the tunnel to our remote side.</p>

<h2>Remote Side:</h2>

<p>Our Demo Python Flask Application:</p>

<pre><code class="python">from flask import Flask

app = Flask(__name__)

@app.route('/')
def index():
    return 'OK'

if __name__ == '__main__':
    app.run(host='127.0.0.1', port=5000)
</code></pre>

<p>Run the server:</p>

<pre><code class="bash">$ python app.py
Listening on 127.0.0.1:5000
</code></pre>

<h2>Client Side:</h2>

<p>From our client side we first need to install sshtunnel via pip:</p>

<pre><code class="bash">$ pip install sshtunnel requests --user
</code></pre>

<p>Our code for our client that will establish the tunnel and do the GET request:</p>

<pre><code class="python">from sshtunnel import SSHTunnelForwarder
import requests

remote_user = 'ubuntu'
remote_host = '192.168.10.10'
remote_port = 22
local_host = '127.0.0.1'
local_port = 5000

server = SSHTunnelForwarder(
   (remote_host, remote_port),
   ssh_username=remote_user,
   ssh_private_key='/home/ubuntu/.ssh/mykey.pem',
   remote_bind_address=(local_host, local_port),
   local_bind_address=(local_host, local_port),
   )

server.start()

headers = { 'User-Agent': 'Mozilla/5.0 (Windows NT 6.0; WOW64; rv:24.0) Gecko/20100101 Firefox/24.0'}
r = requests.get('http://127.0.0.1:5000', headers=headers).content
print(r)
server.stop()
</code></pre>

<p>Running our app:</p>

<pre><code class="bash">$ python ssh_tunnel.py
OK
</code></pre>

<p>So we have sucessfully established our ssh tunnel to our remote side, and able to access the network restricted port via the tunnel.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://pypi.org/project/sshtunnel/">SSHTunnel</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Basic RESTFul API Server With Python Flask]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/04/21/basic-restful-api-server-with-python-flask/"/>
    <updated>2018-04-21T19:35:34-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/04/21/basic-restful-api-server-with-python-flask</id>
    <content type="html"><![CDATA[<p><img src="http://obj-cache.cloud.ruanbekker.com/flask.png" alt="" /></p>

<p>A Basic RESTFul API Service with Python Flask. We will be using the Flask, jsonify and request classes to build our API service.</p>

<h2>Description of this demonstration:</h2>

<p>Our API will be able to do the following:</p>

<ul>
<li>Create, Read, Update, Delete</li>
</ul>


<p>In this demonstration, we will add some information about people to our API, then go through each method that is mentioned above.</p>

<h2>Getting the Dependencies:</h2>

<p>Setup the virtualenv and install the dependencies:</p>

<pre><code class="bash">$ virtualenv .venv
$ source .venv/bin/activate
$ pip install flask
</code></pre>

<h2>The API Server Code:</h2>

<p>Here&rsquo;s the complete code, as you can see I have a couple of decorators for each url endpoint, and a <code>id_generator</code> function, that will generate id&rsquo;s for each document. The id will be used for getting users information, updates and deletes:</p>

<pre><code class="python">from flask import Flask, jsonify, request
from multiprocessing import Value

counter = Value('i', 0)
app = Flask(__name__)

a = []
help_message = """
API Usage:

- GET    /api/list
- POST   /api/add data={"key": "value"}
- GET    /api/get/&lt;id&gt;
- PUT    /api/update/&lt;id&gt; data={"key": "value_to_replace"}
- DELETE /api/delete/&lt;id&gt; 

"""

def id_generator():
    with counter.get_lock():
        counter.value += 1
        return counter.value

@app.route('/api', methods=['GET'])
def help():
    return help_message

@app.route('/api/list', methods=['GET'])
def list():
    return jsonify(a)

@app.route('/api/add', methods=['POST'])
def index():
    payload = request.json 
    payload['id'] = id_generator()
    a.append(payload)
    return "Created: {} \n".format(payload)

@app.route('/api/get', methods=['GET'])
def get_none():
    return 'ID Required: /api/get/&lt;id&gt; \n'

@app.route('/api/get/&lt;int:_id&gt;', methods=['GET'])
def get(_id):
    for user in a:
        if _id == user['id']:
            selected_user = user
    return jsonify(selected_user)

@app.route('/api/update', methods=['PUT'])
def update_none():
    return 'ID and Desired K/V in Payload required: /api/update/&lt;id&gt; -d \'{"name": "john"}\' \n'

@app.route('/api/update/&lt;int:_id&gt;', methods=['PUT'])
def update(_id):
    update_req = request.json
    key_to_update = update_req.keys()[0]
    update_val = (item for item in a if item['id'] == _id).next()[key_to_update] = update_req.values()[0]
    update_resp = (item for item in a if item['id'] == _id).next()
    return "Updated: {} \n".format(update_resp)

@app.route('/api/delete/&lt;int:_id&gt;', methods=['DELETE'])
def delete(_id):
    deleted_user = (item for item in a if item['id'] == _id).next()
    a.remove(deleted_user)
    return "Deleted: {} \n".format(deleted_user)

if __name__ == '__main__':
    app.run()
</code></pre>

<h2>Demo Time:</h2>

<p>Retrieving the Help output:</p>

<pre><code class="bash">$ curl -XGET -H 'Content-Type: application/json' http://localhost:5000/api

API Usage:

- GET    /api/list
- POST   /api/add data={"key": "value"}
- GET    /api/get/&lt;id&gt;
- PUT    /api/update/&lt;id&gt; data={"key": "value_to_replace"}
- DELETE /api/delete/&lt;id&gt; 
</code></pre>

<p>Doing a list, to list all the users, its expected for it to be empty as we have not added any info to our API:</p>

<pre><code class="bash">$ curl -XGET -H 'Content-Type: application/json' http://localhost:5000/api/list
[]
</code></pre>

<p>Adding our first user:</p>

<pre><code class="bash">$ curl -XPOST -H 'Content-Type: application/json' http://localhost:5000/api/add -d '{"name": "ruan", "country": "south africa", "age": 30}'
Created: {u'country': u'south africa', u'age': 30, u'name': u'ruan', 'id': 1} 
</code></pre>

<p>Adding our second user:</p>

<pre><code class="bash">$ curl -XPOST -H 'Content-Type: application/json' http://localhost:5000/api/add -d '{"name": "stefan", "country": "south africa", "age": 29}'
Created: {u'country': u'south africa', u'age': 29, u'name': u'stefan', 'id': 2}
</code></pre>

<p>Doing a list again, will retrieve all our users:</p>

<pre><code class="bash">$ curl -XGET -H 'Content-Type: application/json' http://localhost:5000/api/list
[
  {
    "age": 30, 
    "country": "south africa", 
    "id": 1, 
    "name": "ruan"
  }, 
  {
    "age": 29, 
    "country": "south africa", 
    "id": 2, 
    "name": "stefan"
  }
]
</code></pre>

<p>Doing a GET on the userid, to only display the users info:</p>

<pre><code class="bash">$ curl -XGET -H 'Content-Type: application/json' http://localhost:5000/api/get/2
{
  "age": 29, 
  "country": "south africa", 
  "id": 2, 
  "name": "stefan"
}
</code></pre>

<p>Now, let&rsquo;s update some details. Let&rsquo;s say that Stefan relocated to New Zealand. We will need to provide his <code>id</code> and also the key/value that we want to update:</p>

<pre><code class="bash">$ curl -XPUT -H 'Content-Type: application/json' http://localhost:5000/api/update/2 -d '{"country": "new zealand"}'
Updated: {u'country': u'new zealand', u'age': 29, u'name': u'stefan', 'id': 2} 
</code></pre>

<p>As you can see the response confirmed that the value was updated, but let&rsquo;s verify the output, by doing a get on his id:</p>

<pre><code class="bash">$ curl -XGET -H 'Content-Type: application/json' http://localhost:5000/api/get/2
{
  "age": 29, 
  "country": "new zealand", 
  "id": 2, 
  "name": "stefan"
}
</code></pre>

<p>And lastly, lets delete our user, which will only require the userid:</p>

<pre><code class="bash">$ curl -XDELETE -H 'Content-Type: application/json' http://localhost:5000/api/delete/2
Deleted: {u'country': u'new zealand', u'age': 29, u'name': u'stefan', 'id': 2} 
</code></pre>

<p>To verify this, list all the users:</p>

<pre><code class="bash">$ curl -XGET -H 'Content-Type: application/json' http://localhost:5000/api/list
[
  {
    "age": 30, 
    "country": "south africa", 
    "id": 1, 
    "name": "ruan"
  }
]
</code></pre>

<h2>Using Python Requests:</h2>

<p>We can also use python&rsquo;s requests module to do the same, to give a demonstration I will create a new user:</p>

<pre><code class="bash">$ pip install requests
$ python
</code></pre>

<pre><code class="python">&gt;&gt;&gt; import requests
&gt;&gt;&gt; import json

&gt;&gt;&gt; base_url = 'http://localhost:5000/api/add'
&gt;&gt;&gt; headers = {"Content-Type": "application/json"}
&gt;&gt;&gt; payload = json.dumps({"name": "shaun", "country": "australia", "age": 24})

&gt;&gt;&gt; r = requests.post(base_url, headers=headers, data=payload)
&gt;&gt;&gt; r.content
Created: {u'country': u'australia', u'age': 24, u'name': u'shaun', 'id': 4}
</code></pre>

<p>Thats it. I&rsquo;ve stumbled upon <a href="https://flask-restful.readthedocs.io/en/latest/">Flask-Restful</a> which I still want to check out, and as soon as I do, I will do a post on it, maybe baked with a NoSQL db or something like that.</p>

<p>Cheers!</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://stackoverflow.com/a/8653568">Python Generator Expressions</a></li>
<li><a href="http://flask.pocoo.org/docs/0.12/api/#flask.Request">Flask Docs</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Basic Introduction to Use Arguments With Argparse on Python]]></title>
    <link href="http://blog.ruanbekker.com/blog/2018/04/18/basic-introduction-to-use-arguments-with-argparse-on-python/"/>
    <updated>2018-04-18T13:35:28-04:00</updated>
    <id>http://blog.ruanbekker.com/blog/2018/04/18/basic-introduction-to-use-arguments-with-argparse-on-python</id>
    <content type="html"><![CDATA[<p>I used to work a lot with <code>sys.argv</code> for using arguments in my applications, until I stumbled upon the <code>argparse</code> module! (Thanks Donovan!)</p>

<p>What I like about argparse, is that it builds up the help menu for you, and you also have a lot of options, as you can set the argument to be required, set the datatypes, addtional help context etc.</p>

<h2>The Basic Demonstration:</h2>

<p>Today we will just run through a very basic example on how to use <code>argparse</code>:</p>

<ul>
<li>Return the generated help menu</li>
<li>Return the required value</li>
<li>Return the additional arguments</li>
<li>Compare arguments with a IF statement</li>
</ul>


<h2>The Python Argparse Tutorial Code:</h2>

<pre><code class="python">import argparse

parser = argparse.ArgumentParser(description='argparse demo')
parser.add_argument('-w', '--word', help='a word (required)', required=True)
parser.add_argument('-s', '--sentence', help='a sentence (not required)', required=False)
parser.add_argument('-c', '--comparison', help='a word to compare (not required)', required=False)
args = parser.parse_args()

print("Word: {}".format(args.word))

if args.sentence:
    print("Sentence: :{}".format(args.sentence))

if args.comparison:
    if args.comparison == args.word:
        print("Comparison: the provided word argument and provided comparison argument is the same")
    else:
        print("Comparison: the provided word argument and provided comparison argument is NOT the same")
</code></pre>

<h2>Seeing it in action:</h2>

<p>To return a usage/help info, run it with the <code>-h</code> or <code>--help</code> argument:</p>

<pre><code class="bash">$ python foo.py -h
usage: foo.py [-h] -w WORD [-s SENTENCE] [-c COMPARISON]

argparse demo

optional arguments:
  -h, --help            show this help message and exit
  -w WORD, --word WORD  a word (required)
  -s SENTENCE, --sentence SENTENCE
                        a sentence (not required)
  -c COMPARISON, --comparison COMPARISON
                        a word to compare (not required)
</code></pre>

<p>For this to work, the application is expecting the <code>word</code> argument to run, as we declared it as <code>required=True</code>:</p>

<pre><code class="bash">$ python foo.py -w hello
Word: hello
</code></pre>

<p>Now to use the arguments that is not required, which makes it optional:</p>

<pre><code class="bash">$ python foo.py -w hello -s "hello, world"
Word: hello
Sentence: :hello, world
</code></pre>

<p>We can also implement some if statements into our application to compare if arguments are the same (as a basic example):</p>

<pre><code class="bash">$ python foo.py -w hello -s "hello, world" -c goodbye
Word: hello
Sentence: :hello, world
Comparison: the provided word argument and provided comparison argument is NOT the same
</code></pre>

<p>We can see that the word and comparison arguments are not the same. When they match up:</p>

<pre><code class="bash">$ python foo.py -w hello -s "hello, world" -c hello
Word: hello
Sentence: :hello, world
Comparison: the provided word argument and provided comparison argument is the same
</code></pre>

<p>This was a very basic demonstration on the <code>argparse</code> module.</p>

<h2>Resource:</h2>

<ul>
<li><a href="https://docs.python.org/3/library/argparse.html">Python Docs: Argparse</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
