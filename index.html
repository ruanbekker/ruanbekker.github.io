
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In this tutorial we will visualize our Redis Cluster&rsquo;s Metrics with Grafana. In order to do that we will setup a redis exporter which will &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.ruan.dev/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/05/05/how-to-setup-a-redis-exporter-for-prometheus/">How to Setup a Redis Exporter for Prometheus</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-05-05T23:14:52+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:14 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will visualize our Redis Cluster&rsquo;s Metrics with Grafana. In order to do that we will setup a <a href="https://github.com/oliver006/redis_exporter">redis exporter</a> which will authenticate with redis and then configure prometheus to scrape the endpoint of the redis exporter&rsquo;s http endpoint to write the time series data to prometheus.</p>

<h2>Install Golang</h2>

<p>We need to build a binary from the redis exporter project, and we need a Golang environment. If you don&rsquo;t have golang installed already:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /tmp/
</span><span class='line'>$ wget https://dl.google.com/go/go1.14.2.linux-amd64.tar.gz
</span><span class='line'>$ tar -xf go1.14.2.linux-amd64.tar.gz -C /usr/local
</span><span class='line'>$ mkdir -p $HOME/go/{bin,src,pkg}
</span><span class='line'>$ export GOPATH=/go
</span><span class='line'>$ export PATH=${PATH}:${GOPATH}/bin:/usr/local/go/bin</span></code></pre></td></tr></table></div></figure>


<p>You should now be able to get a response:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go version
</span><span class='line'>go version go1.14.2 linux/amd64</span></code></pre></td></tr></table></div></figure>


<h2>Redis Exporter</h2>

<p>Get the source code and build the binary:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/oliver006/redis_exporter.git
</span><span class='line'>$ cd redis_exporter
</span><span class='line'>$ go build .</span></code></pre></td></tr></table></div></figure>


<p>Now the binary should be built, and you should be able to get a response when running the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./redis_exporter --help</span></code></pre></td></tr></table></div></figure>


<p>Copy the binary the the following path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp redis_exporter /usr/bin/</span></code></pre></td></tr></table></div></figure>


<p>Then create the systemd unit file, in <code>/etc/systemd/system/redis_exporter.service</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=Redis Exporter
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=root
</span><span class='line'>Group=root
</span><span class='line'>Type=simple
</span><span class='line'>ExecStart=/usr/bin/redis_exporter \
</span><span class='line'>    -web.listen-address ":9121" \
</span><span class='line'>    -redis.addr "redis://ip.of.redis.server:6379" \
</span><span class='line'>    -redis.password "your-strong-redis-password"
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Reload systemd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-relaod</span></code></pre></td></tr></table></div></figure>


<p>Then start the redis exporter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart redis_exporter</span></code></pre></td></tr></table></div></figure>


<p>Now you should be able to get redis metrics when you hit the redis exporter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9121/metrics
</span><span class='line'>...
</span><span class='line'># TYPE redis_commands_duration_seconds_total counter
</span><span class='line'>redis_commands_duration_seconds_total{cmd="auth"} 0.000308
</span><span class='line'>redis_commands_duration_seconds_total{cmd="client"} 0.000251
</span><span class='line'>redis_commands_duration_seconds_total{cmd="config"} 0.010594
</span><span class='line'>redis_commands_duration_seconds_total{cmd="evalsha"} 229.214873
</span><span class='line'>redis_commands_duration_seconds_total{cmd="get"} 0.002343
</span><span class='line'>redis_commands_duration_seconds_total{cmd="info"} 0.013722
</span><span class='line'>redis_commands_duration_seconds_total{cmd="latency"} 0.000557
</span><span class='line'>redis_commands_duration_seconds_total{cmd="lrange"} 11.102069
</span><span class='line'>redis_commands_duration_seconds_total{cmd="ltrim"} 3.731263
</span><span class='line'>redis_commands_duration_seconds_total{cmd="ping"} 2e-05
</span><span class='line'>redis_commands_duration_seconds_total{cmd="rpush"} 3.460981
</span><span class='line'>redis_commands_duration_seconds_total{cmd="script"} 0.008393
</span><span class='line'>redis_commands_duration_seconds_total{cmd="set"} 0.001329
</span><span class='line'>redis_commands_duration_seconds_total{cmd="slowlog"} 0.001308
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h2>Configure Prometheus</h2>

<p>If you don&rsquo;t have prometheus setup, you can <a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">view this blogpost</a> to get it setup.</p>

<p>Then configure your <code>prometheus.yml</code> and add the target to scrape the redis exporter endpoint to write the time series data into prometheus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: redis_exporter
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['ip.of.redis.exporter:9121']</span></code></pre></td></tr></table></div></figure>


<p>Then restart prometheus, if you have docker redeploy your stack or prometheus container. For prometheus as a service you can use <code>systemctl restart prometheus</code>, depending on your operating system distribution.</p>

<h2>Grafana</h2>

<p>Head over to Grafana, if you don&rsquo;t have Grafana, you can <a href="https://blog.ruanbekker.com/blog/2019/05/17/install-grafana-to-visualize-your-metrics-from-datasources-such-as-prometheus-on-linux/">view this post</a> to install Grafana.</p>

<p>Then import the dashboard <a href="https://grafana.com/grafana/dashboards/763">763</a> and after some time, you should see a dashboard more or less like this:</p>

<p><img width="1280" alt="image" src="https://user-images.githubusercontent.com/567298/81118917-0b58f880-8f2a-11ea-941a-b43696fab9b0.png"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/04/28/nginx-analysis-dashboard-using-grafana-and-elasticsearch/">Nginx Analysis Dashboard Using Grafana and Elasticsearch</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-04-28T20:07:22+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>8:07 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we will be setting up a <strong>analytical dashboard</strong> using <strong>grafana</strong> to visualize our <strong>nginx access logs</strong>.</p>

<p><img width="1212" alt="grafana-nginx-elasticsearch-prometheus" src="https://user-images.githubusercontent.com/567298/80539136-48ac0c00-89a7-11ea-869d-597da4fa4d92.png"></p>

<p>In this tutorial I will be using my other blog <code>sysadmins.co.za</code> which is being served on nginx. We will also be setting up the other components such as filebeat, logstash, elasticsearch and redis, which require if you would like to follow along.</p>

<h2>The End Result</h2>

<p>We will be able to analyze our Nginx Access logs to answer questions such as:</p>

<ul>
<li>Whats the Top 10 Countries accessing your website in the last 24 hours</li>
<li>Who&rsquo;s the Top 10 Referers?</li>
<li>Whats the most popular page for the past 24 hours?</li>
<li>How does the percentage of 200&rsquo;s vs 404&rsquo;s look like?</li>
<li>Ability to view results based on status code</li>
<li>Everyone loves a World Map to view hotspots</li>
</ul>


<p>At the end of the tutorial, your dashboard will look similar to this:</p>

<p><img width="1123" alt="grafana-elasticsearch-nginx-dashboard" src="https://user-images.githubusercontent.com/567298/80523974-32925180-898f-11ea-96b6-e8e559655745.png"></p>

<h2>High Level Overview</h2>

<p>Our infrastructure will require Nginx with Filebeat, Redis, Logstash, Elasticsearch and Grafana and will look like this:</p>

<p><img width="871" alt="grafana-elasticsearch-logs-setup" src="https://user-images.githubusercontent.com/567298/80526020-6d49b900-8992-11ea-9a39-67331ccc3808.png"></p>

<p>I will drill down how everything is connected:</p>

<ol>
<li>Nginx has a custom <code>log_format</code> that we define, that will write to <code>/var/log/nginx/access_json.log</code>, which will be picked up by <strong>Filebeat</strong> as a input.</li>
<li>and <strong>Filebeat</strong> has an output that pushes the data to <strong>Redis</strong></li>
<li><strong>Logstash</strong> is configured with <strong>Redis</strong> as an input with configured filter section to transform the data and outputs to <strong>Elasticsearch</strong></li>
<li>From <strong>Grafana</strong> we have a configured <strong>Elasticsearch</strong> datasource</li>
<li>Use the grafana template to build this awesome dashboard on Grafana</li>
</ol>


<p>But first, a massive thank you to <a href="https://www.akiraka.net">akiraka</a> for templatizing this dashboard and made it available on <a href="https://grafana.com/orgs/akiraka">grafana</a></p>

<h2>Let&rsquo;s build all the things</h2>

<p>I will be using LXD to run my system/server containers (running ubuntu 18), but you can use a vps, cloud instance, multipass, virtualbox, or anything to host your servers that we will be deploying redis, logstash, etc.</p>

<p>Servers provisioned for this setup:</p>

<ul>
<li>Nginx</li>
<li>Redis</li>
<li>Logstash</li>
<li>Elasticsearch</li>
<li>Grafana</li>
<li>Prometheus</li>
</ul>


<h2>Elasticsearch</h2>

<p>If you don&rsquo;t have a cluster running already, you can follow <strong><a href="https://blog.ruanbekker.com/blog/2019/04/02/setup-a-5-node-highly-available-elasticsearch-cluster/">this tutorial</a></strong> which will help you deploy a HA Elasticsearch Cluster, or if you prefer docker, you can follow <strong><a href="https://blog.ruanbekker.com/blog/2018/04/29/running-a-3-node-elasticsearch-cluster-with-docker-compose-on-your-laptop-for-testing/">this tutorial</a></strong></p>

<h2>Redis</h2>

<p>For our in-memory data store, I will be securing my redis installation with a password as well.</p>

<p>Install redis:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt install redis-server -y</span></code></pre></td></tr></table></div></figure>


<p>Generate a password:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl rand -base64 36
</span><span class='line'>9V5YlWvm8WuC4n1KZLYUEbLruLJLNJEnDzhu4WnAIfgxMmlv</span></code></pre></td></tr></table></div></figure>


<p>In your redis config <code>/etc/redis/redis.conf</code>, you need to change the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>bind 0.0.0.0
</span><span class='line'>port 6379
</span><span class='line'>daemonize yes
</span><span class='line'>supervised systemd
</span><span class='line'>requirepass 9V5YlWvm8WuC4n1KZLYUEbLruLJLNJEnDzhu4WnAIfgxMmlv
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Restart redis to activate your changes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart redis.service</span></code></pre></td></tr></table></div></figure>


<p>and then set and get a key using your password:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ redis-cli -a "9V5YlWvm8WuC4n1KZLYUEbLruLJLNJEnDzhu4WnAIfgxMmlv" set test ok
</span><span class='line'>$ redis-cli -a "9V5YlWvm8WuC4n1KZLYUEbLruLJLNJEnDzhu4WnAIfgxMmlv" get test
</span><span class='line'>ok</span></code></pre></td></tr></table></div></figure>


<h2>Logstash</h2>

<p>On the logstash server, install the requirements:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt install wget apt-transport-https default-jre -y
</span><span class='line'>$ wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add -
</span><span class='line'>$ echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" | tee -a /etc/apt/sources.list.d/elastic-7.x.list</span></code></pre></td></tr></table></div></figure>


<p>Now the repository for elastic is setup now we need to update and install logstash:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt install logstash -y</span></code></pre></td></tr></table></div></figure>


<p>Once logstash is installed, we need to provide logstash with a configuration, in our scenario we will have a input for redis, a filter section to transform and output as elasticsearch.</p>

<p>Just make sure of the following:</p>

<ul>
<li>Populate the connection details of redis (we will define the key in filebeat later)</li>
<li>Ensure that <code>GeoLite2-City.mmdb</code> is in the path that I have under filter</li>
<li>Populate the connectiond details of Elasticsearch and choose a suitable index name, we will need to provide that index name in Grafana later</li>
</ul>


<p>Create the config: <code>/etc/logstash/conf.d/logs.conf</code> and my config will look like the following. (<a href="https://grafana.com/grafana/dashboards/11190">config source</a>)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>input {
</span><span class='line'>  redis {
</span><span class='line'>    data_type =&gt;"list"
</span><span class='line'>    key =&gt;"nginx_logs"
</span><span class='line'>    host =&gt;"10.47.127.37"
</span><span class='line'>    port =&gt; 6379
</span><span class='line'>    password =&gt; "9V5YlWvm8WuC4n1KZLYUEbLruLJLNJEnDzhu4WnAIfgxMmlv"
</span><span class='line'>    db =&gt; 0
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>filter {
</span><span class='line'>  geoip {
</span><span class='line'>    target =&gt; "geoip"
</span><span class='line'>    source =&gt; "client_ip"
</span><span class='line'>    database =&gt; "/usr/share/logstash/vendor/bundle/jruby/2.5.0/gems/logstash-filter-geoip-6.0.3-java/vendor/GeoLite2-City.mmdb"
</span><span class='line'>    add_field =&gt; [ "[geoip][coordinates]", "%{[geoip][longitude]}" ]
</span><span class='line'>    add_field =&gt; [ "[geoip][coordinates]", "%{[geoip][latitude]}" ]
</span><span class='line'>    remove_field =&gt; ["[geoip][latitude]", "[geoip][longitude]", "[geoip][country_code]", "[geoip][country_code2]", "[geoip][country_code3]", "[geoip][timezone]", "[geoip][continent_code]", "[geoip][region_code]"]
</span><span class='line'>  }
</span><span class='line'>  mutate {
</span><span class='line'>    convert =&gt; [ "size", "integer" ]
</span><span class='line'>    convert =&gt; [ "status", "integer" ]
</span><span class='line'>    convert =&gt; [ "responsetime", "float" ]
</span><span class='line'>    convert =&gt; [ "upstreamtime", "float" ]
</span><span class='line'>    convert =&gt; [ "[geoip][coordinates]", "float" ]
</span><span class='line'>    remove_field =&gt; [ "ecs","agent","host","cloud","@version","input","logs_type" ]
</span><span class='line'>  }
</span><span class='line'>  useragent {
</span><span class='line'>    source =&gt; "http_user_agent"
</span><span class='line'>    target =&gt; "ua"
</span><span class='line'>    remove_field =&gt; [ "[ua][minor]","[ua][major]","[ua][build]","[ua][patch]","[ua][os_minor]","[ua][os_major]" ]
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>output {
</span><span class='line'>  elasticsearch {
</span><span class='line'>    hosts =&gt; ["10.47.127.132", "10.47.127.199", "10.47.127.130"]
</span><span class='line'>    #user =&gt; "myusername"
</span><span class='line'>    #password =&gt; "mypassword"
</span><span class='line'>    index =&gt; "logstash-nginx-sysadmins-%{+YYYY.MM.dd}"
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Nginx</h2>

<p>On our nginx server we will install nginx and filebeat, then configure nginx to log to a custom log format, and configure filebeat to read the logs and push it to redis.</p>

<p>Installing nginx:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt install nginx -y</span></code></pre></td></tr></table></div></figure>


<p>Installing <a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation.html">filebeat</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.6.2-amd64.deb
</span><span class='line'>$ dpkg -i filebeat-7.6.2-amd64.deb</span></code></pre></td></tr></table></div></figure>


<p>Next we will configure nginx to log to a seperate file with a custom log format to include data such as the, request method, upstream response time, hostname, remote address, etc.</p>

<p>Under the <code>http</code> directive in your <code>/etc/nginx/nginx.conf</code>, configure the <code>log_format</code> and <code>access_log</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>http {
</span><span class='line'>...
</span><span class='line'>        log_format json_logs '{"@timestamp":"$time_iso8601","host":"$hostname",'
</span><span class='line'>                            '"server_ip":"$server_addr","client_ip":"$remote_addr",'
</span><span class='line'>                            '"xff":"$http_x_forwarded_for","domain":"$host",'
</span><span class='line'>                            '"url":"$uri","referer":"$http_referer",'
</span><span class='line'>                            '"args":"$args","upstreamtime":"$upstream_response_time",'
</span><span class='line'>                            '"responsetime":"$request_time","request_method":"$request_method",'
</span><span class='line'>                            '"status":"$status","size":"$body_bytes_sent",'
</span><span class='line'>                            '"request_body":"$request_body","request_length":"$request_length",'
</span><span class='line'>                            '"protocol":"$server_protocol","upstreamhost":"$upstream_addr",'
</span><span class='line'>                            '"file_dir":"$request_filename","http_user_agent":"$http_user_agent"'
</span><span class='line'>                            '}';
</span><span class='line'>
</span><span class='line'>        access_log  /var/log/nginx/access_json.log  json_logs;
</span><span class='line'>...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Restart nginx to activate the changes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart nginx</span></code></pre></td></tr></table></div></figure>


<p>Next we need to configure filebeat to read from our nginx access logs and configure the output to redis. Edit the filebeat config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/filebeat/filebeat.yml</span></code></pre></td></tr></table></div></figure>


<p>And configure filebeat with the following and make sure to change the values where you need to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># config source: akiraka.net
</span><span class='line'># filebeat input 
</span><span class='line'>filebeat.inputs:
</span><span class='line'>- type: log
</span><span class='line'>  enabled: true
</span><span class='line'>  paths:
</span><span class='line'>    - /var/log/nginx/access_json.log
</span><span class='line'>  json.keys_under_root: true
</span><span class='line'>  json.overwrite_keys: true
</span><span class='line'>  json.add_error_key: true
</span><span class='line'>
</span><span class='line'># filebeat modules 
</span><span class='line'>filebeat.config.modules:
</span><span class='line'>  # remove the escape character before the wildcard below
</span><span class='line'>  path: ${path.config}/modules.d/\*.yml
</span><span class='line'>  reload.enabled: false
</span><span class='line'>
</span><span class='line'># elasticsearch template settings
</span><span class='line'>setup.template.settings:
</span><span class='line'>  index.number_of_shards: 3
</span><span class='line'>
</span><span class='line'># redis output
</span><span class='line'>output.redis:
</span><span class='line'>  hosts: ["10.47.127.140:6379"]
</span><span class='line'>  password: "9V5YlWvm8WuC4n1KZLYUEbLruLJLNJEnDzhu4WnAIfgxMmlv"
</span><span class='line'>  key: "nginx_logs"
</span><span class='line'>  # ^ this key needs to be the same as the configured key on logstash 
</span><span class='line'>  db: 0
</span><span class='line'>  timeout: 5</span></code></pre></td></tr></table></div></figure>


<p>Restart filebeat:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart filebeat</span></code></pre></td></tr></table></div></figure>


<p>When you make a request to your nginx server, you should see a similar logline like below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ tail -n1 /var/log/nginx/access_elg.log
</span><span class='line'>{"@timestamp":"2020-04-28T20:05:03+00:00","host":"sysadmins-blog","server_ip":"10.68.100.89","client_ip":"x.x.x.x","xff":"x.x.x.x","domain":"sysadmins.co.za","url":"/","referer":"-","args":"-","upstreamtime":"0.310","responsetime":"0.312","request_method":"GET","status":"200","size":"4453","request_body":"-","request_length":"519","protocol":"HTTP/1.1","upstreamhost":"127.0.0.1:2369","file_dir":"/var/www/web/root/","http_user_agent":"Mozilla/5.0"}</span></code></pre></td></tr></table></div></figure>


<h2>Grafana</h2>

<p>On the grafana server, install grafana:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt install apt-transport-https software-properties-common wget -y
</span><span class='line'>$ wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -
</span><span class='line'>$ add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
</span><span class='line'>$ apt update && apt install grafana -y</span></code></pre></td></tr></table></div></figure>


<p>Now we need to install a couple of grafana plugins that we require for our dashboards:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ grafana-cli plugins install grafana-worldmap-panel
</span><span class='line'>$ grafana-cli plugins install grafana-clock-panel
</span><span class='line'>$ grafana-cli plugins install grafana-piechart-panel</span></code></pre></td></tr></table></div></figure>


<p>Now reload systemd and restart grafana:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl restart grafana-server</span></code></pre></td></tr></table></div></figure>


<p>If you would like to setup nginx as a reverse proxy to grafana, you can have a look at <strong><a href="https://blog.ruanbekker.com/blog/2019/05/17/install-grafana-to-visualize-your-metrics-from-datasources-such-as-prometheus-on-linux/">this blogpost</a></strong> on how to do that.</p>

<h2>Prometheus</h2>

<p>If you don&rsquo;t have Prometheus installed already, you can view my <a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">blogpost</a> on setting up Prometheus.</p>

<h2>Verifying</h2>

<p>To verify if everything works as expected, make a request to your nginx server, then have a look if your index count on elasticsearch increases:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://elasticsearch-endpoint-address:9200/_cat/indices/logstash-*?v
</span><span class='line'>health status index                               uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   logstash-nginx-x-2020.04.28 SWbHCer-TeOcw6bi_695Xw   5   1      58279            0     32.6mb         16.3mb</span></code></pre></td></tr></table></div></figure>


<p>If you dont, make sure that all the processes are running on the servers, and that each server is able to reach each other on the targeted ports.</p>

<h2>The Fun Part: Dashboarding</h2>

<p>Now that we have everything in place, the fun part is to build the dashboards, first we need to configure elasticsearch as our datasource and specify the index we want to read from. Open grafana on <code>http://ip.of.grafana.server:3000</code>, default user and password is admin.</p>

<p>Select config on the left and select datasources, add a datasource, select elasticsearch and specify your datasource name, mine is <strong>es-nginx</strong> in this example, the <strong>url</strong> of your elasticsearch endpoint, if you have secured your elasticsearch cluster with authentication, provide the auth, then provide your index name as as provided in logstash.</p>

<p>My configured index will look like <code>logstash-nginx-sysadmins-YYYY-MM-dd</code>, therefore I specified index name as <code>logstash-nginx-sysadmins-*</code> and my timefield as <code>@timestamp</code>, the version, and select save and test, which would look like this:</p>

<p><img width="569" alt="AC025E20-38D0-4676-B576-9F5932913BA1" src="https://user-images.githubusercontent.com/567298/80538019-48ab0c80-89a5-11ea-8f4f-a30384991ab9.png"></p>

<p>Now we will import our dashboard template (Once again a massive thank you to <a href="https://grafana.com/grafana/dashboards/11190">Shenxiang, Qingkong and Ruixi</a> which made this template available!), head over to dashboards and select import, then provide the ID: <code>11190</code>, after that it will prompt what your dashboard needs to be named and you need to select your Elasticsearch and Prometheus datasource.</p>

<p>The description of the panels is in Chinese, if you would like it in english, I have translated mine to english and made the dashboard json available in <a href="https://gist.githubusercontent.com/ruanbekker/699fca31ebd7223b675d0acd25ea84bc/raw/316a015a0464989117cd72a1e8e056854d582178/nginx_grafana_dashboard_11190_eng.json">this gist</a></p>

<h2>Tour of our Dashboard Panels</h2>

<p>Looking at our hotspot map:</p>

<p><img width="1212" alt="grafana" src="https://user-images.githubusercontent.com/567298/80539136-48ac0c00-89a7-11ea-869d-597da4fa4d92.png"></p>

<p>The summary and top 10 pages:</p>

<p><img width="1243" alt="76E8CBE1-4B03-4226-8041-B98879BAD66A" src="https://user-images.githubusercontent.com/567298/80540596-e86a9980-89a9-11ea-924d-29f777a7c15a.png"></p>

<p>Page views, historical trends:</p>

<p><img width="1239" alt="grafana-page-views" src="https://user-images.githubusercontent.com/567298/80539728-4eeeb800-89a8-11ea-959e-5e2915387b7b.png"></p>

<p>Top 10 referers and table data of our logs:</p>

<p><img width="1235" alt="B17C4F55-DF91-4EA0-9669-C237FF560459" src="https://user-images.githubusercontent.com/567298/80540381-772ae680-89a9-11ea-9067-61cd519c9d8a.png"></p>

<h2>Thank You</h2>

<p>I hope this was useful, if you have any issues with this feel free to reach out to me. If you like my work, please feel free to share this post, follow me on Twitter at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> or visit me on my <strong><a href="https://ruan.dev">website</a></strong></p>

<p><a href="https://ko-fi.com/A6423ZIQ"><img src="https://www.ko-fi.com/img/githubbutton_sm.svg" alt="ko-fi" /></a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/04/27/how-to-do-port-forwarding-with-iptables/">How to Do Port Forwarding With Iptables</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-04-27T13:42:41+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>1:42 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a quick post on how to do port forwarding with iptables on linux.</p>

<h2>What would we like to achieve</h2>

<p>We have a lxc container running a <strong>redis</strong> server and we would like to do port forwarding so that we can reach the server over the internet</p>

<h2>LXC Host</h2>

<p>On our host that hosts our lxc containers, we want to forward the host port <code>5379</code> to <code>6379</code> of the container (10.37.117.37), so we can connect on a non-standard redis port:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iptables -t nat -I PREROUTING -p tcp --dport 5379 -j DNAT --to-destination 10.37.117.37:6379</span></code></pre></td></tr></table></div></figure>


<h2>Test over the Internet</h2>

<p>Test the connection by connecting to the LXC Host&rsquo;s IP:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ redis-cli -h lxc.host.ip.address -p 5379 -a "${REDIS_PW}"  get test
</span><span class='line'>"It's working!"</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading my short post on how to use iptables to do port forwarding.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/04/27/how-to-set-a-static-ip-in-ubuntu-18/">How to Set a Static IP in Ubuntu 18</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-04-27T13:39:19+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>1:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a short post on how to set a <strong>static ip address</strong> on <strong>ubuntu 18.04</strong> using <strong>netplan</strong></p>

<h2>Netplan</h2>

<p>At the moment my network interfaces uses dhcp, and we can see that below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/netplan/50-cloud-init.yaml
</span><span class='line'>network:
</span><span class='line'>    version: 2
</span><span class='line'>    ethernets:
</span><span class='line'>        eth0:
</span><span class='line'>            dhcp4: true</span></code></pre></td></tr></table></div></figure>


<p>Changing the configuration to static:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/netplan/50-cloud-init.yaml
</span><span class='line'>network:
</span><span class='line'>    version: 2
</span><span class='line'>    ethernets:
</span><span class='line'>        eth0:
</span><span class='line'>            dhcp4: false
</span><span class='line'>            addresses: [10.37.117.37/24]
</span><span class='line'>            gateway4: 10.37.117.1
</span><span class='line'>            nameservers:
</span><span class='line'>                addresses: [127.0.0.53,8.8.8.8]</span></code></pre></td></tr></table></div></figure>


<p>After changing the configuration, you need to apply your changes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ netplan apply</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thank you for reading my short post on how to change a static ip address on ubuntu 18.04 using netplan</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/04/26/graphing-covid-19-stats-with-grafana-and-elasticsearch-using-python/">Graphing Covid-19 Stats With Grafana and Elasticsearch Using Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-04-26T02:24:27+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>2:24 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/80421197-62345180-88dc-11ea-9e0a-557199aaf613.png" alt="coronavirus-covid19-grafana-metrics" /></p>

<p>I stumbled upon a <a href="https://github.com/pomber/covid19/">github repository</a> that stores time-series data in json format of corona virus / covid19 statistics, which get updated daily.</p>

<p>I was curious to see data about my country and want to see how metrics will look like after our lockdown started, so I decided to consume that data with <strong>Python</strong> and the requests library, then ingest data about covid19 into <strong>Elasticsearch</strong> and the visualize the data with <strong>Grafana</strong>.</p>

<h2>Sample of the Data</h2>

<p>Let&rsquo;s have a peek at the data to determine how we will use it to write to Elasticsearch. Let&rsquo;s consume the data with python:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; import requests
</span><span class='line'>&gt;&gt;&gt; import json
</span><span class='line'>&gt;&gt;&gt; response = requests.get('https://pomber.github.io/covid19/timeseries.json').json()</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s determine the data type:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; type(response)
</span><span class='line'>&lt;type 'dict'&gt;</span></code></pre></td></tr></table></div></figure>


<p>Now as it&rsquo;s a dictionary, let&rsquo;s look at they keys:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; response.keys()
</span><span class='line'>[u'Canada', u'Sao Tome and Principe', u'Lithuania', u'Cambodia', u'Ethiopia',....</span></code></pre></td></tr></table></div></figure>


<p>So let&rsquo;s take a look how the data looks like if we do a lookup for Canada:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; type(response['Canada'])
</span><span class='line'>&lt;type 'list'&gt;</span></code></pre></td></tr></table></div></figure>


<p>As we can see it&rsquo;s a list, we can count how many items is in our list:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; len(response['Canada'])
</span><span class='line'>94</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s peek at the data by accessing our first index of our list:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; response['Canada'][0]
</span><span class='line'>{u'date': u'2020-1-22', u'confirmed': 0, u'recovered': 0, u'deaths': 0}</span></code></pre></td></tr></table></div></figure>


<p>So our data will look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  [
</span><span class='line'>    'Country Name': [
</span><span class='line'>      {
</span><span class='line'>        'date': '&lt;string&gt;', 
</span><span class='line'>        'confirmed': '&lt;int&gt;', 
</span><span class='line'>        'recovered': '&lt;int&gt;', 
</span><span class='line'>        'deaths': '&lt;int&gt;'
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        'date': '&lt;string&gt;',
</span><span class='line'>        'confirmed': '&lt;int&gt;',
</span><span class='line'>        'recovered': '&lt;int&gt;',
</span><span class='line'>        'deaths': '&lt;int&gt;'
</span><span class='line'>      },
</span><span class='line'>    ],
</span><span class='line'>    'Country Name': [
</span><span class='line'>      ...
</span><span class='line'>    ]
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Some issues we need to fix</h2>

<p>As you can see the date is displayed as <code>2020-1-22</code> instead of <code>2020-01-22</code>, I want to make it consistent as I will be ingesting the data with a <code>@timestamp</code> key which we will use the date from the returned data. So first we will need to convert that before we ingest the data.</p>

<p>The other thing I was thinking of is that, if for some reason we need to ingest this data again, we dont want to sit with duplicates (same document with different _id&rsquo;s), so for that I decided to generate a hash value that consist of the date and the country, so if the script run to ingest the data, it will use the same id for the specific document, which would just overwrite it, therefore we won&rsquo;t sit with duplicates.</p>

<p>So the idea is to ingest a document to elasticsearch like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>doc = {
</span><span class='line'>    "_id": "sha_hash_value",
</span><span class='line'>    "day": "2020-01-22",
</span><span class='line'>    "timestamp": "@2020-01-22 00:00:00",
</span><span class='line'>    "country": "CountryName",
</span><span class='line'>    "confirmed": 0,
</span><span class='line'>    "recovered": 0,
</span><span class='line'>    "deaths": 0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>How we will ingest the data</h2>

<p>The first run will load all the data and ingest all the data up to the current day to elasticsearch. Once that is done, we will add code to our script to only ingest the most recent day&rsquo;s data into elasticsearch, which we will control with a cronjob.</p>

<p>Create a index with a mapping to let Elasticsearch know <code>timestamp</code> will be a date field:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XPUT -H 'Content-Type: application/json' \
</span><span class='line'>  -u username:pass 'https://es.domain.com/coronastats' -d \
</span><span class='line'>  '{"mappings": {"foo1": {"properties": {"timestamp" : {"type" : "date","format" : "yyyy-MM-dd HH:mm:ss"}}}}}'</span></code></pre></td></tr></table></div></figure>


<p>Once our index is created, create the python script that will load the data, loop through each country&rsquo;s daily data and ingest it into elasticsearch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">dt</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">hashlib</span>
</span><span class='line'>
</span><span class='line'><span class="n">url</span> <span class="o">=</span> <span class="s">&#39;https://pomber.github.io/covid19/timeseries.json&#39;</span>
</span><span class='line'><span class="n">elasticsearch_url</span> <span class="o">=</span> <span class="s">&quot;https://es.domain.com&quot;</span>
</span><span class='line'><span class="n">elasticsearch_username</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'><span class="n">elasticsearch_password</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">api_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">convert_datestamp</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">hash_function</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
</span><span class='line'>    <span class="n">string_to_hash</span> <span class="o">=</span> <span class="n">country</span> <span class="o">+</span> <span class="n">date</span>
</span><span class='line'>    <span class="n">hash_obj</span>  <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">string_to_hash</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">hash_value</span> <span class="o">=</span> <span class="n">hash_obj</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">hash_value</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">map_es_doc</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">country</span><span class="p">):</span>
</span><span class='line'>    <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;day&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">convert_datestamp</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]),</span>
</span><span class='line'>        <span class="s">&quot;country&quot;</span><span class="p">:</span> <span class="n">country</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;confirmed&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s">&#39;confirmed&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&quot;recovered&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s">&#39;recovered&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&quot;deaths&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s">&#39;deaths&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">doc</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">ingest</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
</span><span class='line'>        <span class="n">elasticsearch_url</span> <span class="o">+</span> <span class="s">&#39;/coronastats/coronastats/&#39;</span> <span class="o">+</span> <span class="n">doc_id</span><span class="p">,</span>
</span><span class='line'>        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">elasticsearch_username</span><span class="p">,</span> <span class="n">elasticsearch_password</span><span class="p">),</span>
</span><span class='line'>        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;content-type&#39;</span><span class="p">:</span> <span class="s">&#39;application/json&#39;</span><span class="p">},</span>
</span><span class='line'>        <span class="n">json</span><span class="o">=</span><span class="n">payload</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">api_response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">each_payload</span> <span class="ow">in</span> <span class="n">api_response</span><span class="p">[</span><span class="n">country</span><span class="p">]:</span>
</span><span class='line'>            <span class="n">doc_id</span> <span class="o">=</span> <span class="n">hash_function</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">each_payload</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">])</span>
</span><span class='line'>            <span class="n">doc</span> <span class="o">=</span> <span class="n">map_es_doc</span><span class="p">(</span><span class="n">each_payload</span><span class="p">,</span> <span class="n">country</span><span class="p">)</span>
</span><span class='line'>            <span class="n">response</span> <span class="o">=</span> <span class="n">ingest</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
</span><span class='line'>            <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the script to ingest all the data into elasticsearch. Now we will create the script that will run daily to only ingest the previous day&rsquo;s data, so that we only ingest the latest data and not all the data from scratch again.</p>

<p>I will create this file in <code>/opt/scripts/corona_covid19_ingest.py</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">dt</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">hashlib</span>
</span><span class='line'>
</span><span class='line'><span class="n">url</span> <span class="o">=</span> <span class="s">&#39;https://pomber.github.io/covid19/timeseries.json&#39;</span>
</span><span class='line'><span class="n">elasticsearch_url</span> <span class="o">=</span> <span class="s">&quot;https://es.domain.com&quot;</span>
</span><span class='line'><span class="n">elasticsearch_username</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'><span class="n">elasticsearch_password</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">api_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">yesterdays_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">convert_datestamp</span><span class="p">(</span><span class="n">day</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">day</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">hash_function</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
</span><span class='line'>    <span class="n">string_to_hash</span> <span class="o">=</span> <span class="n">country</span> <span class="o">+</span> <span class="n">date</span>
</span><span class='line'>    <span class="n">hash_obj</span>  <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">string_to_hash</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">hash_value</span> <span class="o">=</span> <span class="n">hash_obj</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">hash_value</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">map_es_doc</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">country</span><span class="p">):</span>
</span><span class='line'>    <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;day&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">convert_datestamp</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">]),</span>
</span><span class='line'>        <span class="s">&quot;country&quot;</span><span class="p">:</span> <span class="n">country</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;confirmed&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s">&#39;confirmed&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&quot;recovered&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s">&#39;recovered&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&quot;deaths&quot;</span><span class="p">:</span> <span class="n">payload</span><span class="p">[</span><span class="s">&#39;deaths&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">doc</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">ingest</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
</span><span class='line'>        <span class="n">elasticsearch_url</span> <span class="o">+</span> <span class="s">&#39;/coronastats/coronastats/&#39;</span> <span class="o">+</span> <span class="n">doc_id</span><span class="p">,</span>
</span><span class='line'>        <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">elasticsearch_username</span><span class="p">,</span> <span class="n">elasticsearch_password</span><span class="p">),</span>
</span><span class='line'>        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;content-type&#39;</span><span class="p">:</span> <span class="s">&#39;application/json&#39;</span><span class="p">},</span>
</span><span class='line'>        <span class="n">json</span><span class="o">=</span><span class="n">payload</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">api_response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">each_payload</span> <span class="ow">in</span> <span class="n">api_response</span><span class="p">[</span><span class="n">country</span><span class="p">]:</span>
</span><span class='line'>            <span class="k">if</span> <span class="n">convert_datestamp</span><span class="p">(</span><span class="n">each_payload</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">yesterdays_date</span><span class="p">):</span>
</span><span class='line'>                <span class="k">print</span><span class="p">(</span><span class="s">&quot;ingesting latest data for {country}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="n">country</span><span class="p">))</span>
</span><span class='line'>                <span class="n">doc_id</span> <span class="o">=</span> <span class="n">hash_function</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">each_payload</span><span class="p">[</span><span class="s">&#39;date&#39;</span><span class="p">])</span>
</span><span class='line'>                <span class="n">doc</span> <span class="o">=</span> <span class="n">map_es_doc</span><span class="p">(</span><span class="n">each_payload</span><span class="p">,</span> <span class="n">country</span><span class="p">)</span>
</span><span class='line'>                <span class="n">response</span> <span class="o">=</span> <span class="n">ingest</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
</span><span class='line'>                <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The only difference with this script is that it checks if the date is equals to yesterday&rsquo;s date, and if so the document will be prepared and ingested into elasticsearch. We will create a cronjob that runs this script every morning at 08:45.</p>

<p>First make the file executable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">corona_covid19_ingest</span><span class="o">.</span><span class="n">py</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run <code>crontab -e</code> and add the following</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="mi">45</span> <span class="mi">8</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">corona_covid19_ingest</span><span class="o">.</span><span class="n">py</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Visualize the Data with Grafana</h2>

<p>We will create this dashboard:</p>

<p><img src="https://user-images.githubusercontent.com/567298/80418135-35ca0680-88d7-11ea-83f6-3432a903333d.png" alt="corona-covid-19-dashboard" /></p>

<p>We need a elasticsearch datasource that points to the index that we ingest our data into. Head over to datasources, add a elasticsearch datasource and set the index to <code>coronastats</code> and add the timefield as <code>timestamp</code>.</p>

<p>We want to make the dashboard dynamic to have a <strong>&ldquo;country&rdquo;</strong> dropdown selector, for that go to the dashboard settings, select variable and add a country variable:</p>

<p><img src="https://user-images.githubusercontent.com/567298/80419463-7cb8fb80-88d9-11ea-959f-8f37ae3f6dc7.png" alt="covid19-dashboard-variables" /></p>

<p>First panel: &ldquo;Reported Cases per Day&rdquo;:</p>

<p><img src="https://user-images.githubusercontent.com/567298/80419572-af62f400-88d9-11ea-802e-7eeacb61ee19.png" alt="covid19-reported-cases" /></p>

<p>Second panel: &ldquo;Confirmed Cases&rdquo;:</p>

<p><img src="https://user-images.githubusercontent.com/567298/80419675-db7e7500-88d9-11ea-98a5-3aae4d9a6c87.png" alt="covid19-confirmed-cases" /></p>

<p>Third panel: &ldquo;Recovered Cases&rdquo;:</p>

<p><img src="https://user-images.githubusercontent.com/567298/80419750-fa7d0700-88d9-11ea-82a3-f26ff8c807ef.png" alt="covid19-recovered-cases" /></p>

<p>Now, if we select Italy, Spain and France as an example, we will see something like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/80419966-56479000-88da-11ea-8f30-39ac3da27007.png" alt="covid19-country-stats" /></p>

<h2>Thank You</h2>

<p>Although its pretty cool visualizing data, the issue that we are in at the moment with coronavirus / covid19 is really scary and we should all do our part to try and stay home, sanitize and try not to spread the virus. Together we can all do great things by reducing the spread of this virus.</p>

<p>Stay safe everyone.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/04/25/nginx-metrics-on-prometheus-with-the-nginx-log-exporter/">Nginx Metrics on Prometheus With the Nginx Log Exporter</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-04-25T01:42:35+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>1:42 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we will setup a nginx log exporter for prometeus to get metrics of our nginx web server, such as number of requests per method, status code, processed bytes etc. Then we will configure prometheus to scrape our nginx metric endpoint and also create a basic dashbaord to visualize our data.</p>

<p>If you follow along on this tutorial, it assumes that you have <a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">Prometheus</a> and <a href="https://blog.ruanbekker.com/blog/2019/05/17/install-grafana-to-visualize-your-metrics-from-datasources-such-as-prometheus-on-linux/">Grafana</a> up and running. But if not the embedded links will take you to the blog posts to set it up.</p>

<h2>Nginx Webserver</h2>

<p>Install nginx:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update
</span><span class='line'>$ apt install nginx -y</span></code></pre></td></tr></table></div></figure>


<p>Configure your nginx server&rsquo;s log format to match the nginx log exporter&rsquo;s expected format, we will name it custom:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  log_format custom   '$remote_addr - $remote_user [$time_local] '
</span><span class='line'>                      '"$request" $status $body_bytes_sent '
</span><span class='line'>                      '"$http_referer" "$http_user_agent" "$http_x_forwarded_for"';
</span></code></pre></td></tr></table></div></figure>


<p>Edit your main nginx config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/nginx/nginx.conf</span></code></pre></td></tr></table></div></figure>


<p>This is how my complete config looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user www-data;
</span><span class='line'>worker_processes auto;
</span><span class='line'>pid /run/nginx.pid;
</span><span class='line'># remote the escape char if you are going to use this config
</span><span class='line'>include /etc/nginx/modules-enabled/\*.conf;
</span><span class='line'>
</span><span class='line'>events {
</span><span class='line'>  worker_connections 768;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>http {
</span><span class='line'>
</span><span class='line'>  # basic config
</span><span class='line'>  sendfile on;
</span><span class='line'>  tcp_nopush on;
</span><span class='line'>  tcp_nodelay on;
</span><span class='line'>  keepalive_timeout 65;
</span><span class='line'>  types_hash_max_size 2048;
</span><span class='line'>  include /etc/nginx/mime.types;
</span><span class='line'>  default_type application/octet-stream;
</span><span class='line'>
</span><span class='line'>  # ssl config
</span><span class='line'>  ssl_protocols TLSv1 TLSv1.1 TLSv1.2; 
</span><span class='line'>  ssl_prefer_server_ciphers on;
</span><span class='line'>
</span><span class='line'>  # logging config
</span><span class='line'>  log_format custom   '$remote_addr - $remote_user [$time_local] '
</span><span class='line'>                      '"$request" $status $body_bytes_sent '
</span><span class='line'>                      '"$http_referer" "$http_user_agent" "$http_x_forwarded_for"';
</span><span class='line'>
</span><span class='line'>  access_log /var/log/nginx/access.log custom;
</span><span class='line'>  error_log /var/log/nginx/error.log;
</span><span class='line'>
</span><span class='line'>  # gzip
</span><span class='line'>  gzip on;
</span><span class='line'>
</span><span class='line'>  # virtual host config
</span><span class='line'>  include /etc/nginx/conf.d/myapp.conf;
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>I will delete the default host config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rm -rf /etc/nginx/sites-enabled/default</span></code></pre></td></tr></table></div></figure>


<p>And then create my <code>/etc/nginx/conf.d/myapp.conf</code> as referenced in my main config, with the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>
</span><span class='line'>  listen 80 default_server;
</span><span class='line'>  # remove the escape char if you are going to use this config
</span><span class='line'>  server_name \_;
</span><span class='line'>
</span><span class='line'>  root /var/www/html;
</span><span class='line'>  index index.html index.htm index.nginx-debian.html;
</span><span class='line'>
</span><span class='line'>  location / {
</span><span class='line'>    try_files $uri $uri/ =404;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>When you make a GET request to your server, you should see something like this in your access log:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>10x.1x.2x.1x - - [25/Apr/2020:00:31:11 +0000] "GET / HTTP/1.1" 200 396 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Safari/605.1.15" "-"</span></code></pre></td></tr></table></div></figure>


<h2>Nginx Log Exporter</h2>

<p>Head over to the <a href="https://github.com/martin-helmich/prometheus-nginxlog-exporter/releases">prometheus-nginxlog-exporter releases</a> page and get the latest version, in the time of writing it is v1.4.0:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://github.com/martin-helmich/prometheus-nginxlog-exporter/releases/download/v1.4.0/prometheus-nginxlog-exporter</span></code></pre></td></tr></table></div></figure>


<p>Make it executable and move it to your path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod +x prometheus-nginxlog-exporter
</span><span class='line'>$ mv prometheus-nginxlog-exporter /usr/bin/prometheus-nginxlog-exporter</span></code></pre></td></tr></table></div></figure>


<p>Create the directory where we will place our config for our exporter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /etc/prometheus</span></code></pre></td></tr></table></div></figure>


<p>Create the config file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/prometheus/nginxlog_exporter.yml</span></code></pre></td></tr></table></div></figure>


<p>You can follow the instructions from <a href="https://github.com/martin-helmich/prometheus-nginxlog-exporter">github.com/prometheus-nginxlog-exporter</a> for more information on configuration, but I will be using the following config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>listen:
</span><span class='line'>  port: 4040
</span><span class='line'>  address: "0.0.0.0"
</span><span class='line'>
</span><span class='line'>consul:
</span><span class='line'>  enable: false
</span><span class='line'>
</span><span class='line'>namespaces:
</span><span class='line'>  - name: myapp
</span><span class='line'>    format: "$remote_addr - $remote_user [$time_local] \"$request\" $status $body_bytes_sent \"$http_referer\" \"$http_user_agent\" \"$http_x_forwarded_for\""
</span><span class='line'>    source:
</span><span class='line'>      files:
</span><span class='line'>        - /var/log/nginx/access.log
</span><span class='line'>    labels:
</span><span class='line'>      service: "myapp"
</span><span class='line'>      environment: "production"
</span><span class='line'>      hostname: "myapp.example.com"
</span><span class='line'>    histogram_buckets: [.005, .01, .025, .05, .1, .25, .5, 1, 2.5, 5, 10]</span></code></pre></td></tr></table></div></figure>


<p>Create the systemd unit file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/systemd/system/nginxlog_exporter.service</span></code></pre></td></tr></table></div></figure>


<p>And my configuration that I will be using:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=Prometheus Log Exporter
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=root
</span><span class='line'>Group=root
</span><span class='line'>Type=simple
</span><span class='line'>ExecStart=/usr/bin/prometheus-nginxlog-exporter -config-file /etc/prometheus/nginxlog_exporter.yml
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Reload systemd and enable the service on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl enable nginxlog_exporter</span></code></pre></td></tr></table></div></figure>


<p>Restart the service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart nginxlog_exporter</span></code></pre></td></tr></table></div></figure>


<p>Ensure that the service is running:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl status nginxlog_exporter
</span><span class='line'>
</span><span class='line'>● nginxlog_exporter.service - Prometheus Log Exporter
</span><span class='line'>   Loaded: loaded (/etc/systemd/system/nginxlog_exporter.service; disabled; vendor preset: enabled)
</span><span class='line'>   Active: active (running) since Sat 2020-04-25 00:50:06 UTC; 5s ago
</span><span class='line'> Main PID: 4561 (prometheus-ngin)
</span><span class='line'>    Tasks: 7 (limit: 2317)
</span><span class='line'>   CGroup: /system.slice/nginxlog_exporter.service
</span><span class='line'>           └─4561 /usr/bin/prometheus-nginxlog-exporter -config-file /etc/prometheus/nginxlog_exporter.yml
</span><span class='line'>
</span><span class='line'>Apr 25 00:50:06 nginx-log-exporter systemd[1]: Started Prometheus Log Exporter.
</span><span class='line'>Apr 25 00:50:06 nginx-log-exporter prometheus-nginxlog-exporter[4561]: loading configuration file /etc/prometheus/nginxlog_exporter.yml
</span><span class='line'>Apr 25 00:50:06 nginx-log-exporter prometheus-nginxlog-exporter[4561]: using configuration {Listen:{Port:4040 Address:0.0.0.0} Consul:{Enable:false Address: Datacenter: Scheme: Toke
</span><span class='line'>Apr 25 00:50:06 nginx-log-exporter prometheus-nginxlog-exporter[4561]: starting listener for namespace myapp
</span><span class='line'>Apr 25 00:50:06 nginx-log-exporter prometheus-nginxlog-exporter[4561]: running HTTP server on address 0.0.0.0:4040
</span><span class='line'>Apr 25 00:50:06 nginx-log-exporter prometheus-nginxlog-exporter[4561]: 2020/04/25 00:50:06 Seeked /var/log/nginx/access.log - &{Offset:0 Whence:2}</span></code></pre></td></tr></table></div></figure>


<h2>Test the exporter</h2>

<p>Make a couple of requests against your webserver:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ for each in {1..10}; do curl http://78.141.211.49 ; done</span></code></pre></td></tr></table></div></figure>


<p>So prometheus will now scrape the exporter http endpoint (<code>:4040/metrics</code>) and push the returned values into prometheus. But to get a feel on how the metrics look like, make a request to the metrics endpoint:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://localhost:4040/metrics
</span><span class='line'>...
</span><span class='line'># HELP myapp_http_response_count_total Amount of processed HTTP requests
</span><span class='line'># TYPE myapp_http_response_count_total counter
</span><span class='line'>myapp_http_response_count_total{environment="production",hostname="myapp.example.com",method="GET",service="myapp",status="200"} 10
</span><span class='line'>myapp_http_response_count_total{environment="production",hostname="myapp.example.com",method="POST",service="myapp",status="404"} 1
</span><span class='line'># HELP myapp_http_response_size_bytes Total amount of transferred bytes
</span><span class='line'># TYPE myapp_http_response_size_bytes counter
</span><span class='line'>myapp_http_response_size_bytes{environment="production",hostname="myapp.example.com",method="GET",service="myapp",status="200"} 6120
</span><span class='line'>myapp_http_response_size_bytes{environment="production",hostname="myapp.example.com",method="POST",service="myapp",status="404"} 152
</span><span class='line'># HELP myapp_parse_errors_total Total number of log file lines that could not be parsed
</span><span class='line'># TYPE myapp_parse_errors_total counter
</span><span class='line'>myapp_parse_errors_total 0
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>As you can see we are getting metrics such as response count total, response size, errors, etc.</p>

<h2>Configure Prometheus</h2>

<p>Let&rsquo;s configure prometheus to scrape this endpoint. Head over to your prometheus instance, and edit your prometheus config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/prometheus/prometheus.yml</span></code></pre></td></tr></table></div></figure>


<p>Note that in my config I have 2 endpoints that I am scraping, the prometheus endpoint which exists and I will be adding the nginx endpoint, so in full, this is how my config will look like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global:
</span><span class='line'>  scrape_interval: 15s
</span><span class='line'>
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'prometheus'
</span><span class='line'>    scrape_interval: 5s
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['localhost:9090']
</span><span class='line'>
</span><span class='line'>  - job_name: 'nginx'
</span><span class='line'>    scrape_interval: 15s
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['ip.of.nginx.exporter:4040']</span></code></pre></td></tr></table></div></figure>


<p>Restart prometheus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart prometheus</span></code></pre></td></tr></table></div></figure>


<p>To verify that the exporter is working as expected, head over to your prometheus ui on port 9090, and query <code>up{}</code> to see if your exporters are returning 1:</p>

<p><img width="1280" alt="image" src="https://user-images.githubusercontent.com/567298/80267654-7b51be00-86a2-11ea-98e2-a48a5c2a1e4f.png"></p>

<p>We can then query prometheus with <code>myapp_http_response_count_total{service="myapp"}</code> to see the response counts:</p>

<p><img width="1273" alt="image" src="https://user-images.githubusercontent.com/567298/80267823-590c7000-86a3-11ea-9098-28e37e7941d7.png"></p>

<h2>Dashboarding in Grafana</h2>

<p>If you don&rsquo;t have Grafana installed, you can look at my <a href="https://blog.ruanbekker.com/blog/2019/05/17/install-grafana-to-visualize-your-metrics-from-datasources-such-as-prometheus-on-linux/">Grafana Installation</a> post to get that up and running.</p>

<p>If you have not created the Prometheus datasource, on Grafana, head over to the configuration section on your left, select Datasources, add a Prometheus datasource and add the following (this is assuming grafana runs on the prometheus node - which is fine for testing):</p>

<p><img width="592" alt="image" src="https://user-images.githubusercontent.com/567298/80267986-48a8c500-86a4-11ea-9046-3fba601d41cf.png"></p>

<p>Create a new dashboard and add a new panel:</p>

<p><img width="605" alt="image" src="https://user-images.githubusercontent.com/567298/80267884-b3a5cc00-86a3-11ea-8624-797e5310de80.png"></p>

<p>Let&rsquo;s query our data to show us HTTP Method and Status code per 30s: <code>rate(myapp_http_response_count_total{service="myapp"}[$__interval])</code></p>

<p><img width="1271" alt="image" src="https://user-images.githubusercontent.com/567298/80269073-e607f700-86ac-11ea-8d42-4814084dfb4a.png"></p>

<h2>Thank You</h2>

<p>Hope you found this helpful, if you haven&rsquo;t seen my other posts on Prometheus, have a look at the following:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">Setup Prometheus</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/17/install-grafana-to-visualize-your-metrics-from-datasources-such-as-prometheus-on-linux/">Setup Grafana</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">Setup Node Exporter</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/17/install-blackbox-exporter-to-monitor-websites-with-prometheus/">Setup Blackbox Exporter</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/17/install-alertmanager-to-alert-based-on-metrics-from-prometheus/">Setup Alertmanager</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/17/install-pushgateway-to-expose-metrics-to-prometheus/">Setup Pushgateway</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/04/19/ipsec-site-to-site-vpn-with-dynamic-ips-with-openswan/">IPSec Site to Site VPN With Dynamic IPs With Openswan</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-04-19T20:58:17+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>8:58 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will setup a site to site ipsec vpn with strongswan and we will enable each server to discover the other vpn server via dynamic dns. We will also append to our config the ability of roadwarriors so that you will be able to connect to your homelab from any mobile or laptop device from any remote source.</p>

<h2>Some background</h2>

<p>Me and one of my friends decided to build a site to site vpn with strongswan so that our homelabs could be reachable to each other over private networks.</p>

<p>One challenge that I thought of is that both of our internet providers don&rsquo;t support static ip addressing, so each vpn server needs to know where to connect to whenever the ip address changes.</p>

<h2>What we will be doing</h2>

<p>We will setup strongswan vpn on both servers and allow the private LAN ranges to be reachable for both sides. As I have a domain hosted on cloudflare, I will be using cloudflare&rsquo;s api to update the A record of each sides dns whenever the IP changes.</p>

<h2>Environment</h2>

<p>On my side, which I will be referring to as <strong>Side-A</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Public DNS Name: side-a.example.com
</span><span class='line'>Private Range: 192.168.0.0/24
</span><span class='line'>VPN Server IP: 192.168.0.2</span></code></pre></td></tr></table></div></figure>


<p>On my friend&rsquo;s side, which I will be referring to as <strong>Side-B</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Public DNS Name: side-b.example.com
</span><span class='line'>Private Range: 192.168.1.0/24
</span><span class='line'>VPN Server IP: 192.168.1.2</span></code></pre></td></tr></table></div></figure>


<h2>Cloudflare Dynamic DNS</h2>

<p>You don&rsquo;t need to use Cloudflare, theres services such as dyndns.com, no-ip.com. But for this tutorial I will be using cloudflare to utilize my own domain.</p>

<p>I will be using the <a href="https://github.com/LINKIWI/cloudflare-ddns-client">cloudflare-ddns-client</a></p>

<p>First we need to create a API Token, head over to your dashboard: <a href="https://dash.cloudflare.com">dash.cloudflare.com</a>, head over to &ldquo;my profile&rdquo;, select &ldquo;API Tokens&rdquo;, then allow &ldquo;Read Zones&rdquo; and &ldquo;Edit DNS&rdquo;, then select &ldquo;Create Token&rdquo;. Keep the returned token value in a safe place.</p>

<p>Install the pre-requirements:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install python python-dev python-pip make curl build-essential -y</span></code></pre></td></tr></table></div></figure>


<p>Get the source and install:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/LINKIWI/cloudflare-ddns-client.git
</span><span class='line'>$ cd cloudflare-ddns-client
</span><span class='line'>$ make install</span></code></pre></td></tr></table></div></figure>


<p>We will now configure the cloudflare dynamic dns client, this will be done on both sides, but will only demonstrate for side-a:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cloudflare-ddns --configure
</span><span class='line'>Use API token or API key to authenticate?
</span><span class='line'>Choose [T]oken or [K]ey: T
</span><span class='line'>Enter the API token you created at https://dash.cloudflare.com/profile/api-tokens.
</span><span class='line'>Required permissions are READ Account.Access: Organizations, Identity Providers, and Groups; READ Zone.Zone; EDIT Zone.DNS
</span><span class='line'>CloudFlare API token: [redacted]
</span><span class='line'>Enter the domains for which you would like to automatically update the DNS records, delimited by a single comma.
</span><span class='line'>Comma-delimited domains: side-a.example.com</span></code></pre></td></tr></table></div></figure>


<p>Testing it out to ensure the A record can be updated:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cloudflare-ddns --update-now
</span><span class='line'>Found external IPv4: "1.x.x.x"
</span><span class='line'>Listing all zones.
</span><span class='line'>Finding all DNS records.
</span><span class='line'>Updating the A record (ID x) of (sub)domain side-a.example.com (ID x) to 1.x.x.x.
</span><span class='line'>DNS record updated successfully!</span></code></pre></td></tr></table></div></figure>


<p>We can run this command from above in a cron, but I will use a bash script to only run when the public ip changed: <code>/opt/scripts/detect_ip_change.sh</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>set -ex
</span><span class='line'>MY_DDNS_HOST="side-a.example.com"
</span><span class='line'>
</span><span class='line'>if [ $(dig ${MY_DDNS_HOST} +short) == $(curl -s icanhazip.com) ];
</span><span class='line'>  then exit 0;
</span><span class='line'>  else /usr/local/bin/cloudflare-ddns --update-now;
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>


<p>Make the file executable: <code>chmod +x /opt/scripts/detect_ip_change.sh</code> then edit your cronjobs: <code>crontab -e</code> and add the script:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* * * * * /opt/scripts/detect_ip_change.sh</span></code></pre></td></tr></table></div></figure>


<p>This will keep your DNS updated, this needs to be done on both sides, if you want to use dynamic dns.</p>

<h2>Port Forwarding</h2>

<p>We will need to forward UDP traffic from the router to the VPN server, on both sides:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Port: UDP/500 
</span><span class='line'>Target: VPN-Server-IP:500
</span><span class='line'>
</span><span class='line'>Port: UDP/4500
</span><span class='line'>Target: VPN-Server-IP:4500</span></code></pre></td></tr></table></div></figure>


<h2>Create a Pre-Shared Key</h2>

<p>Create a preshared key that will be used on both sides to authenticate:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl rand -base64 36
</span><span class='line'>pgDU4eKZaQNL7GNRWJPvZbaSYFn2PAFjK9vDOvxAQ85p7qc4</span></code></pre></td></tr></table></div></figure>


<p>This value will be used on both sides, which we will need later.</p>

<h2>Install Strongswan on Side-A</h2>

<p>Install strongswan and enable the service on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install strongswan -y
</span><span class='line'>$ systemctl enable strongswan</span></code></pre></td></tr></table></div></figure>


<p>The left side will be the side we are configuring and the right side will be the remote side.</p>

<p>Create the config: <code>/etc/ipsec.conf</code> and provide the following config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config setup
</span><span class='line'>    charondebug="all"
</span><span class='line'>    uniqueids=yes
</span><span class='line'>    virtual_private=
</span><span class='line'>    cachecrls=no
</span><span class='line'>
</span><span class='line'>conn vpn-to-side-b
</span><span class='line'>    type=tunnel
</span><span class='line'>    authby=secret
</span><span class='line'>    left=%defaultroute
</span><span class='line'>    leftid=side-a.example.com
</span><span class='line'>    leftsubnet=192.168.0.0/24
</span><span class='line'>    right=%side-b.example.com
</span><span class='line'>    rightid=side-b.example.com
</span><span class='line'>    rightsubnet=192.168.1.0/24
</span><span class='line'>    ike=aes256-sha2_256-modp1024!
</span><span class='line'>    esp=aes256-sha2_256!
</span><span class='line'>    keyingtries=0
</span><span class='line'>    ikelifetime=1h
</span><span class='line'>    lifetime=8h
</span><span class='line'>    dpddelay=30
</span><span class='line'>    dpdtimeout=120
</span><span class='line'>    dpdaction=restart
</span><span class='line'>    auto=start</span></code></pre></td></tr></table></div></figure>


<p>Create the secrets file: <code>/etc/ipsec.secrets</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>side-b.example.com : PSK "pgDU4eKZaQNL7GNRWJPvZbaSYFn2PAFjK9vDOvxAQ85p7qc4"</span></code></pre></td></tr></table></div></figure>


<p>Append the following kernel parameters to <code>/etc/sysctl.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>net.ipv4.ip_forward = 1
</span><span class='line'>net.ipv4.conf.all.accept_redirects = 0
</span><span class='line'>net.ipv4.conf.all.send_redirects = 0</span></code></pre></td></tr></table></div></figure>


<p>Save:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -p</span></code></pre></td></tr></table></div></figure>


<p>We now want to add a POSTROUTING and FORWARD rule using iptables:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iptables -t nat -A POSTROUTING -s 192.168.1.0/24  -d 192.168.0.0/24 -j MASQUERADE
</span><span class='line'>$ iptables -A FORWARD -s 192.168.1.0/24 -d 192.168.0.0/24 -j ACCEPT</span></code></pre></td></tr></table></div></figure>


<p>Now we need to route back:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ip route add 192.168.1.0/24 via 192.168.0.2 dev eth0</span></code></pre></td></tr></table></div></figure>


<p>We want to persist the iptables and static route across reboots, so edit the <code>/etc/rc.local</code> file, if it&rsquo;s not there create it with the following values:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>iptables -t nat -A POSTROUTING -s 192.168.1.0/24  -d 192.168.0.0/24 -j MASQUERADE
</span><span class='line'>iptables -A FORWARD -s 192.168.1.0/24 -d 192.168.0.0/24 -j ACCEPT
</span><span class='line'>ip route add 192.168.1.0/24 via 192.168.0.2 dev eth0
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<p>If you created the file, make sure to apply executable permissions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod +x /etc/rc.local</span></code></pre></td></tr></table></div></figure>


<p>Read the secrets and restart strongswan:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec rereadsecrets
</span><span class='line'>$ systemctl restart strongswan</span></code></pre></td></tr></table></div></figure>


<h2>Install Strongswan on Side-B</h2>

<p>Install strongswan and enable the service on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install strongswan -y
</span><span class='line'>$ systemctl enable strongswan</span></code></pre></td></tr></table></div></figure>


<p>The left side will be the side we are configuring and the right side will be the remote side.</p>

<p>Create the config: <code>/etc/ipsec.conf</code> and provide the following config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config setup
</span><span class='line'>    charondebug="all"
</span><span class='line'>    uniqueids=yes
</span><span class='line'>    virtual_private=
</span><span class='line'>    cachecrls=no
</span><span class='line'>
</span><span class='line'>conn vpn-to-side-a
</span><span class='line'>    type=tunnel
</span><span class='line'>    authby=secret
</span><span class='line'>    left=%defaultroute
</span><span class='line'>    leftid=side-b.example.com
</span><span class='line'>    leftsubnet=192.168.1.0/24
</span><span class='line'>    right=%side-a.example.com
</span><span class='line'>    rightid=side-a.example.com
</span><span class='line'>    rightsubnet=192.168.0.0/24
</span><span class='line'>    ike=aes256-sha2_256-modp1024!
</span><span class='line'>    esp=aes256-sha2_256!
</span><span class='line'>    keyingtries=0
</span><span class='line'>    ikelifetime=1h
</span><span class='line'>    lifetime=8h
</span><span class='line'>    dpddelay=30
</span><span class='line'>    dpdtimeout=120
</span><span class='line'>    dpdaction=restart
</span><span class='line'>    auto=start</span></code></pre></td></tr></table></div></figure>


<p>Create the secrets file: <code>/etc/ipsec.secrets</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>side-a.example.com : PSK "pgDU4eKZaQNL7GNRWJPvZbaSYFn2PAFjK9vDOvxAQ85p7qc4"</span></code></pre></td></tr></table></div></figure>


<p>Append the following kernel parameters to <code>/etc/sysctl.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>net.ipv4.ip_forward = 1
</span><span class='line'>net.ipv4.conf.all.accept_redirects = 0
</span><span class='line'>net.ipv4.conf.all.send_redirects = 0</span></code></pre></td></tr></table></div></figure>


<p>Save:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sysctl -p</span></code></pre></td></tr></table></div></figure>


<p>We now want to add a POSTROUTING and FORWARD rule using iptables:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iptables -t nat -A POSTROUTING -s 192.168.0.0/24  -d 192.168.1.0/24 -j MASQUERADE
</span><span class='line'>$ iptables -A FORWARD -s 192.168.0.0/24 -d 192.168.1.0/24 -j ACCEPT</span></code></pre></td></tr></table></div></figure>


<p>Now we need to route back:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ip route add 192.168.0.0/24 via 192.168.1.2 dev eth0</span></code></pre></td></tr></table></div></figure>


<p>We want to persist the iptables and static route across reboots, so edit the <code>/etc/rc.local</code> file, if it&rsquo;s not there create it with the following values:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>iptables -t nat -A POSTROUTING -s 192.168.0.0/24  -d 192.168.1.0/24 -j MASQUERADE
</span><span class='line'>iptables -A FORWARD -s 192.168.0.0/24 -d 192.168.1.0/24 -j ACCEPT
</span><span class='line'>ip route add 192.168.0.0/24 via 192.168.1.2 dev eth0
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<p>If you created the file, make sure to apply executable permissions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod +x /etc/rc.local</span></code></pre></td></tr></table></div></figure>


<p>Read the secrets and restart strongswan:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec rereadsecrets
</span><span class='line'>$ systemctl restart strongswan</span></code></pre></td></tr></table></div></figure>


<h2>Verify Status</h2>

<p>Verify that the ipsec tunnel is up on side-a:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec statusall
</span><span class='line'>
</span><span class='line'>Connections:
</span><span class='line'>  vpn-to-side-b:  %any...side-b.example.com,0.0.0.0/0,::/0  IKEv1/2
</span><span class='line'>  vpn-to-side-b:   local:  [side-a.example.com] uses pre-shared key authentication
</span><span class='line'>  vpn-to-side-b:   remote: [side-b.example.com] uses pre-shared key authentication
</span><span class='line'>  vpn-to-side-b:   child:  192.168.0.0/24 === 192.168.1.0/24 TUNNEL
</span><span class='line'>Security Associations (1 up, 0 connecting):
</span><span class='line'>  vpn-to-side-b[1]: ESTABLISHED 28 minutes ago, 192.168.0.2[side-a.example.com]...4x.x.x.214[side-b.example.com]
</span><span class='line'>  vpn-to-side-b[1]: IKEv2 SPIs: 81996170df1c927d_i e8294946491ddf08_r, pre-shared key reauthentication in 2 hours
</span><span class='line'>  vpn-to-side-b[1]: IKE proposal: AES_CBC_128/HMAC_SHA2_256_128/PRF_HMAC_SHA2_256/ECP_256
</span><span class='line'>  vpn-to-side-b{2}:  INSTALLED, TUNNEL, reqid 1, ESP in UDP SPIs: cc4504be_i c294cb26_o
</span><span class='line'>  vpn-to-side-b{2}:  AES_CBC_128/HMAC_SHA2_256_128, 0 bytes_i, 240 bytes_o (4 pkts, 7s ago), rekeying in 18 minutes
</span><span class='line'>  vpn-to-side-b{2}:   192.168.0.0/24 === 192.168.1.0/24</span></code></pre></td></tr></table></div></figure>


<p>Verify that the ipsec tunnel is up on side-b:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec statusall
</span><span class='line'>
</span><span class='line'>Connections:
</span><span class='line'> vpn-to-side-a:  %any...side-a.example.com,0.0.0.0/0,::/0  IKEv1/2
</span><span class='line'> vpn-to-side-a:   local:  [side-b.example.com] uses pre-shared key authentication
</span><span class='line'> vpn-to-side-a:   remote: [side-a.example.com] uses pre-shared key authentication
</span><span class='line'> vpn-to-side-a:   child:  192.168.1.0/24 === 192.168.0.0/24 TUNNEL
</span><span class='line'>Security Associations (1 up, 0 connecting):
</span><span class='line'> vpn-to-side-a[2]: ESTABLISHED 20 minutes ago, 192.168.1.2[side-b.example.com]...14x.x.x.x[side-a.example.com]
</span><span class='line'> vpn-to-side-a[2]: IKEv2 SPIs: 81996170df1c927d_i e8294946491ddf08_r, pre-shared key reauthentication in 2 hours
</span><span class='line'> vpn-to-side-a[2]: IKE proposal: AES_CBC_128/HMAC_SHA2_256_128/PRF_HMAC_SHA2_256/ECP_256
</span><span class='line'> vpn-to-side-a{2}:  INSTALLED, TUNNEL, reqid 1, ESP in UDP SPIs: c294cb26_i cc4504be_o
</span><span class='line'> vpn-to-side-a{2}:  AES_CBC_128/HMAC_SHA2_256_128, 0 bytes_i, 0 bytes_o, rekeying in 26 minutes
</span><span class='line'> vpn-to-side-a{2}:   192.168.1.0/24 === 192.168.0.0/24</span></code></pre></td></tr></table></div></figure>


<p>From side-a (192.168.0.2) ping the gateway on side-b (192.168.1.1):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ $ ping -c2 192.168.1.1
</span><span class='line'>PING 10.3.96.2 (192.168.1.1) 56(84) bytes of data.
</span><span class='line'>64 bytes from 192.168.1.1: icmp_seq=1 ttl=62 time=11.9 ms</span></code></pre></td></tr></table></div></figure>


<p>If you want to be able to reach the private range of the other side of the vpn from any device on your network, you should add a static route on your router to inform your default gateway where to route traffic to.</p>

<p>In this case on side-a (192.168.0.0/24) we want to inform our default gateway to route (192.168.1.0/24) to the VPN as it knows to route that destination over the VPN.</p>

<p>On side-a, on your router, add a static route:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Route: 192.168.1.0
</span><span class='line'>Subnet: 255.255.255.0
</span><span class='line'>Gateway: 192.168.0.2</span></code></pre></td></tr></table></div></figure>


<p>On side-b, on your router, add a static route:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Route: 192.168.0.0
</span><span class='line'>Subnet: 255.255.255.0
</span><span class='line'>Gateway: 192.168.1.2</span></code></pre></td></tr></table></div></figure>


<h2>Optional: Roadwarrior VPN Clients</h2>

<p>This step is optional, but since we can access each others homelabs, we thought it would be nice to be able to access the resources from mobile devices or laptops when we are on remote locations.</p>

<p>We made it that each VPN owner will connect to its own endpoint (for roadwarriors), so side-a (which will be me) will connect to its own dns endpoint to connect when away from home..</p>

<p>I will only demonstrate how to append your config to add the ability for a roadwarrion vpn connection, append to the <code>/etc/ipsec.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ...
</span><span class='line'>conn ikev2-vpn
</span><span class='line'>    auto=add
</span><span class='line'>    type=tunnel
</span><span class='line'>    authby=secret
</span><span class='line'>    left=%any
</span><span class='line'>    leftid=side-a.roadwarrior
</span><span class='line'>    leftsubnet=0.0.0.0/0
</span><span class='line'>    right=%any
</span><span class='line'>    rightid=%any
</span><span class='line'>    rightsourceip=10.10.0.0/24
</span><span class='line'>    rightdns=192.168.0.1,8.8.8.8
</span><span class='line'>    auto=start</span></code></pre></td></tr></table></div></figure>


<p>Append the secret in <code>/etc/ipsec.secrets</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ...
</span><span class='line'>side-a.roadwarrior my-laptop : PSK "MySuperSecureSecret123"</span></code></pre></td></tr></table></div></figure>


<p>Add the vpn ip&rsquo;s that we will assign to the roardwarrior clients to the routing table:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ip route add 10.10.0.0/24 via 192.168.0.2 dev eth0</span></code></pre></td></tr></table></div></figure>


<p>If you only want the roadwarriors to be able to reach your network, you will only forward to the local network such as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iptables -A FORWARD -s 10.10.0.0/24 -d 192.168.0.0/24 -j ACCEPT</span></code></pre></td></tr></table></div></figure>


<p>But we will be forwarding traffic to all destinations:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ iptables -A FORWARD -s 10.10.0.0/24 -d 0.0.0.0/0 -j ACCEPT
</span><span class='line'>$ iptables -t nat -A POSTROUTING -s 10.10.0.0/24 -d 0.0.0.0/0 -j MASQUERADE</span></code></pre></td></tr></table></div></figure>


<p>Remember to append the routes to <code>/etc/rc.local</code> to persist across reboots.</p>

<p>Reread the secrets and restart strongswan:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ipsec rereadsecrets
</span><span class='line'>$ systemctl restart strongswan</span></code></pre></td></tr></table></div></figure>


<p>Connecting your VPN Client, I will be using my Laptop, with the following details:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>VPN Type: IKEv2
</span><span class='line'>Description: Home VPN
</span><span class='line'>Server: side-a.example.com
</span><span class='line'>Remote ID: side-a.roadwarrior
</span><span class='line'>Local ID: my-laptop
</span><span class='line'>User Authentication: None
</span><span class='line'>Secret: MySuperSecureSecret123</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>In this tutorial I demonstrated how to setup a site to site ipsec vpn between 2 sides that consists of internet connections that has dynamic ip&rsquo;s and also appending roadwarrior config so that you can connect to your homelab from anywhere in the world.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/02/21/persistent-volumes-with-k3d-kubernetes/">Persistent Volumes With K3d Kubernetes</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-02-21T00:07:48+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2020</span></span> <span class='time'>12:07 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>With k3d we can mount the host to container path, and with persistent volumes we can set a hostPath for our persistent volumes. With k3d, all the nodes will be using the same volume mapping which maps back to the host.</p>

<p>We will test the data persistence by writing a file inside a container, kill the pod, then exec into the pod again and test if the data persisted</p>

<h2>The k3d Cluster</h2>

<p>Create the directory on the host where we will persist the data:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; mkdir -p /tmp/k3dvol</span></code></pre></td></tr></table></div></figure>


<p>Create the cluster:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; k3d create --name "k3d-cluster" --volume /tmp/k3dvol:/tmp/k3dvol --publish "80:80" --workers 2
</span><span class='line'>&gt; export KUBECONFIG="$(k3d get-kubeconfig --name='k3d-cluster')"</span></code></pre></td></tr></table></div></figure>


<p>Our application will be a busybox container which will keep running with a ping command, map the persistent volume to <code>/data</code> inside the pod.</p>

<p>Our <code>app.yml</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apiVersion: v1
</span><span class='line'>kind: PersistentVolume
</span><span class='line'>metadata:
</span><span class='line'>  name: task-pv-volume
</span><span class='line'>  labels:
</span><span class='line'>    type: local
</span><span class='line'>spec:
</span><span class='line'>  storageClassName: manual
</span><span class='line'>  capacity:
</span><span class='line'>    storage: 1Gi
</span><span class='line'>  accessModes:
</span><span class='line'>    - ReadWriteOnce
</span><span class='line'>  hostPath:
</span><span class='line'>    path: "/tmp/k3dvol"
</span><span class='line'>---
</span><span class='line'>apiVersion: v1
</span><span class='line'>kind: PersistentVolumeClaim
</span><span class='line'>metadata:
</span><span class='line'>  name: task-pv-claim
</span><span class='line'>spec:
</span><span class='line'>  storageClassName: manual
</span><span class='line'>  accessModes:
</span><span class='line'>    - ReadWriteOnce
</span><span class='line'>  resources:
</span><span class='line'>    requests:
</span><span class='line'>      storage: 1Gi
</span><span class='line'>---
</span><span class='line'>apiVersion: apps/v1
</span><span class='line'>kind: Deployment
</span><span class='line'>metadata:
</span><span class='line'>  name: echo
</span><span class='line'>spec:
</span><span class='line'>  selector:
</span><span class='line'>    matchLabels:
</span><span class='line'>      app: echo
</span><span class='line'>  strategy:
</span><span class='line'>    type: Recreate
</span><span class='line'>  template:
</span><span class='line'>    metadata:
</span><span class='line'>      labels:
</span><span class='line'>        app: echo
</span><span class='line'>    spec:
</span><span class='line'>      volumes:
</span><span class='line'>        - name: task-pv-storage
</span><span class='line'>          persistentVolumeClaim:
</span><span class='line'>            claimName: task-pv-claim
</span><span class='line'>      containers:
</span><span class='line'>      - image: busybox
</span><span class='line'>        name: echo
</span><span class='line'>        volumeMounts:
</span><span class='line'>          - mountPath: "/data"
</span><span class='line'>            name: task-pv-storage
</span><span class='line'>        command: ["ping", "127.0.0.1"]</span></code></pre></td></tr></table></div></figure>


<p>Deploy the workload:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; kubectl apply -f app.yml
</span><span class='line'>persistentvolume/task-pv-volume created
</span><span class='line'>persistentvolumeclaim/task-pv-claim created
</span><span class='line'>deployment.apps/echo created</span></code></pre></td></tr></table></div></figure>


<p>View the persistent volumes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; kubectl get pv
</span><span class='line'>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS   REASON   AGE
</span><span class='line'>task-pv-volume                             1Gi        RWO            Retain           Bound    default/task-pv-claim    manual                  6s</span></code></pre></td></tr></table></div></figure>


<p>View the Persistent Volume Claims:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; kubectl get pvc
</span><span class='line'>NAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
</span><span class='line'>task-pv-claim    Bound    task-pv-volume                             1Gi        RWO            manual         11s</span></code></pre></td></tr></table></div></figure>


<p>View the pods:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; kubectl get pods
</span><span class='line'>NAME                   READY   STATUS    RESTARTS   AGE
</span><span class='line'>echo-58fd7d9b6-x4rxj   1/1     Running   0          16s</span></code></pre></td></tr></table></div></figure>


<p>Exec into the pod:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; kubectl exec -it echo-58fd7d9b6-x4rxj sh
</span><span class='line'>/ # df -h
</span><span class='line'>Filesystem                Size      Used Available Use% Mounted on
</span><span class='line'>overlay                  58.4G     36.1G     19.3G  65% /
</span><span class='line'>osxfs                   233.6G    139.7G     86.3G  62% /data
</span><span class='line'>/dev/sda1                58.4G     36.1G     19.3G  65% /etc/hosts
</span><span class='line'>/dev/sda1                58.4G     36.1G     19.3G  65% /dev/termination-log
</span><span class='line'>/dev/sda1                58.4G     36.1G     19.3G  65% /etc/hostname
</span><span class='line'>/dev/sda1                58.4G     36.1G     19.3G  65% /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>


<p>Write the hostname of the current pod to the persistent volume path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/ # echo $(hostname)
</span><span class='line'>echo-58fd7d9b6-x4rxj
</span><span class='line'>/ # echo $(hostname) &gt; /data/hostname.txt
</span><span class='line'>/ # exit</span></code></pre></td></tr></table></div></figure>


<p>Exit the pod and read the content from the host (workstation/laptop):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; cat /tmp/k3dvol/hostname.txt
</span><span class='line'>echo-58fd7d9b6-x4rxj</span></code></pre></td></tr></table></div></figure>


<p>Look at the host where the pod is running on:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; kubectl get nodes -o wide
</span><span class='line'>NAME                       STATUS   ROLES    AGE   VERSION        INTERNAL-IP    EXTERNAL-IP   OS-IMAGE   KERNEL-VERSION     CONTAINER-RUNTIME
</span><span class='line'>k3d-k3d-cluster-server     Ready    master   13m   v1.17.2+k3s1   192.168.32.2   &lt;none&gt;        Unknown    4.9.184-linuxkit   containerd://1.3.3-k3s1
</span><span class='line'>k3d-k3d-cluster-worker-1   Ready    &lt;none&gt;   13m   v1.17.2+k3s1   192.168.32.4   &lt;none&gt;        Unknown    4.9.184-linuxkit   containerd://1.3.3-k3s1
</span><span class='line'>k3d-k3d-cluster-worker-0   Ready    &lt;none&gt;   13m   v1.17.2+k3s1   192.168.32.3   &lt;none&gt;        Unknown    4.9.184-linuxkit   containerd://1.3.3-k3s1</span></code></pre></td></tr></table></div></figure>


<p>Delete the pod:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; kubectl delete pod/echo-58fd7d9b6-x4rxj
</span><span class='line'>pod "echo-58fd7d9b6-x4rxj" deleted</span></code></pre></td></tr></table></div></figure>


<p>Wait until the pod is rescheduled again and verify if the pod is running on a different node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; kubectl get pods -o wide
</span><span class='line'>NAME                   READY   STATUS    RESTARTS   AGE   IP          NODE                       NOMINATED NODE   READINESS GATES
</span><span class='line'>echo-58fd7d9b6-fkvbs   1/1     Running   0          35s   10.42.2.9   k3d-k3d-cluster-worker-1   &lt;none&gt;           &lt;none&gt;</span></code></pre></td></tr></table></div></figure>


<p>Exec into the new pod:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt; kubectl exec -it echo-58fd7d9b6-fkvbs sh</span></code></pre></td></tr></table></div></figure>


<p>View if the data is persisted:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/ # hostname
</span><span class='line'>echo-58fd7d9b6-fkvbs
</span><span class='line'>
</span><span class='line'>/ # cat /data/hostname.txt
</span><span class='line'>echo-58fd7d9b6-x4rxj</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/02/17/python-asynchronous-function-with-openfaas/">Asynchronous Function With OpenFaas</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-02-17T23:51:22+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:51 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we will explore how to use asynchronous functions in OpenFaas.</p>

<h2>What are we doing</h2>

<p>A synchronous request blocks the client until operation completes, where a asynchronous request doesn’t block the client, which is nice to use for long-running tasks or function invocations to run in the background through the use of NATS Streaming.</p>

<p>We will be building a Python Flask API Server which will act as our webhook service. When we invoke our function by making a http request, we also include a callback url as a header which will be the address where the queue worker will post it&rsquo;s results.</p>

<p>Then we will make a http request to the synchronous function where we will get the response from the function and a http request to the asynchronous function, where we will get the response from the webhook service&rsquo;s logs</p>

<h2>Deploy OpenFaas</h2>

<p>Deploy OpenFaas on a k3d Kubernetes Cluster if you want to follow along on your laptop. You can follow this post to deploy a kubernetes cluster and deploying openfaas:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2020/02/17/traefik-ingress-for-openfaas-on-kubernetes-k3d/">https://blog.ruanbekker.com/blog/2020/02/17/traefik-ingress-for-openfaas-on-kubernetes-k3d/</a></li>
</ul>


<h2>Webhook Service</h2>

<p>Lets build the Python Flask Webhook Service, our application code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">logging.config</span> <span class="kn">import</span> <span class="n">dictConfig</span>
</span><span class='line'>
</span><span class='line'><span class="n">dictConfig</span><span class="p">({</span>
</span><span class='line'>    <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;formatters&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;format&#39;</span><span class="p">:</span> <span class="s">&#39;[</span><span class="si">%(asctime)s</span><span class="s">] </span><span class="si">%(levelname)s</span><span class="s"> in </span><span class="si">%(module)s</span><span class="s">: </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}},</span>
</span><span class='line'>    <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;wsgi&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;logging.StreamHandler&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;stream&#39;</span><span class="p">:</span> <span class="s">&#39;ext://flask.logging.wsgi_errors_stream&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;formatter&#39;</span><span class="p">:</span> <span class="s">&#39;default&#39;</span>
</span><span class='line'>    <span class="p">}},</span>
</span><span class='line'>    <span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;INFO&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;wsgi&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="s">&quot;GET&quot;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">response</span><span class="p">[</span><span class="s">&quot;event&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;GET&quot;</span>
</span><span class='line'>        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Received Event: GET&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">response</span><span class="p">[</span><span class="s">&quot;event&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
</span><span class='line'>        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Receveid Event: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">response</span><span class="p">[</span><span class="s">&quot;event&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;OTHER&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Received Event:&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;event: {} </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>Dockerfile</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">FROM</span> <span class="n">python</span><span class="p">:</span><span class="mf">3.7</span><span class="o">-</span><span class="n">alpine</span>
</span><span class='line'><span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">flask</span>
</span><span class='line'><span class="n">ADD</span> <span class="n">app</span><span class="o">.</span><span class="n">py</span> <span class="o">/</span><span class="n">app</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="n">EXPOSE</span> <span class="mi">5000</span>
</span><span class='line'><span class="n">CMD</span> <span class="p">[</span><span class="s">&quot;python&quot;</span><span class="p">,</span> <span class="s">&quot;/app.py&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Building and Pushing to Docker Hub (or you can use my docker image):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">yourusername</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="n">webhook</span><span class="p">:</span><span class="n">openfaas</span> <span class="o">.</span>
</span><span class='line'><span class="err">$</span> <span class="n">docker</span> <span class="n">push</span> <span class="n">yourusername</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="n">webhook</span><span class="p">:</span><span class="n">openfaas</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the deployment manifest <code>webhook.yml</code> for our webhook service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">cat</span> <span class="o">&gt;</span> <span class="n">webhook</span><span class="o">.</span><span class="n">yml</span> <span class="o">&lt;&lt;</span> <span class="n">EOF</span>
</span><span class='line'><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
</span><span class='line'><span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
</span><span class='line'><span class="n">metadata</span><span class="p">:</span>
</span><span class='line'>  <span class="n">name</span><span class="p">:</span> <span class="n">webhook</span><span class="o">-</span><span class="n">service</span>
</span><span class='line'><span class="n">spec</span><span class="p">:</span>
</span><span class='line'>  <span class="n">selector</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="p">:</span> <span class="n">webhook</span>
</span><span class='line'>  <span class="n">ports</span><span class="p">:</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
</span><span class='line'>      <span class="n">port</span><span class="p">:</span> <span class="mi">5000</span>
</span><span class='line'>      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">5000</span>
</span><span class='line'>      <span class="n">name</span><span class="p">:</span> <span class="n">web</span>
</span><span class='line'><span class="o">---</span>
</span><span class='line'><span class="n">apiVersion</span><span class="p">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
</span><span class='line'><span class="n">kind</span><span class="p">:</span> <span class="n">Ingress</span>
</span><span class='line'><span class="n">metadata</span><span class="p">:</span>
</span><span class='line'>  <span class="n">name</span><span class="p">:</span> <span class="n">webhook</span><span class="o">-</span><span class="n">ingress</span>
</span><span class='line'>  <span class="n">annotations</span><span class="p">:</span>
</span><span class='line'>    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ingress</span><span class="o">.</span><span class="n">class</span><span class="p">:</span> <span class="n">traefik</span>
</span><span class='line'><span class="n">spec</span><span class="p">:</span>
</span><span class='line'>  <span class="n">rules</span><span class="p">:</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">host</span><span class="p">:</span> <span class="n">webhook</span><span class="o">.</span><span class="n">localdns</span><span class="o">.</span><span class="n">xyz</span>
</span><span class='line'>    <span class="n">http</span><span class="p">:</span>
</span><span class='line'>      <span class="n">paths</span><span class="p">:</span>
</span><span class='line'>      <span class="o">-</span> <span class="n">backend</span><span class="p">:</span>
</span><span class='line'>          <span class="n">serviceName</span><span class="p">:</span> <span class="n">webhook</span><span class="o">-</span><span class="n">service</span>
</span><span class='line'>          <span class="n">servicePort</span><span class="p">:</span> <span class="mi">5000</span>
</span><span class='line'><span class="o">---</span>
</span><span class='line'><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
</span><span class='line'><span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
</span><span class='line'><span class="n">metadata</span><span class="p">:</span>
</span><span class='line'>  <span class="n">labels</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="p">:</span> <span class="n">webhook</span>
</span><span class='line'>  <span class="n">name</span><span class="p">:</span> <span class="n">webhook</span>
</span><span class='line'><span class="n">spec</span><span class="p">:</span>
</span><span class='line'>  <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>  <span class="n">selector</span><span class="p">:</span>
</span><span class='line'>    <span class="n">matchLabels</span><span class="p">:</span>
</span><span class='line'>      <span class="n">app</span><span class="p">:</span> <span class="n">webhook</span>
</span><span class='line'>  <span class="n">template</span><span class="p">:</span>
</span><span class='line'>    <span class="n">metadata</span><span class="p">:</span>
</span><span class='line'>      <span class="n">labels</span><span class="p">:</span>
</span><span class='line'>        <span class="n">app</span><span class="p">:</span> <span class="n">webhook</span>
</span><span class='line'>    <span class="n">spec</span><span class="p">:</span>
</span><span class='line'>      <span class="n">containers</span><span class="p">:</span>
</span><span class='line'>      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">webhook</span>
</span><span class='line'>        <span class="n">image</span><span class="p">:</span> <span class="n">ruanbekker</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">flask</span><span class="o">-</span><span class="n">webhook</span><span class="p">:</span><span class="n">openfaas</span>
</span><span class='line'>        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
</span><span class='line'>        <span class="n">ports</span><span class="p">:</span>
</span><span class='line'>        <span class="o">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="mi">5000</span>
</span><span class='line'>          <span class="n">name</span><span class="p">:</span> <span class="n">http</span>
</span><span class='line'>          <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
</span><span class='line'><span class="n">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now deploy to kubernetes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">kubectl</span> <span class="nb">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">webhook</span><span class="o">.</span><span class="n">yml</span>
</span></code></pre></td></tr></table></div></figure>


<p>After a minute or so, verify that you get a response when making a http request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">webhook</span><span class="o">.</span><span class="n">localdns</span><span class="o">.</span><span class="n">xyz</span>
</span><span class='line'><span class="n">event</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;event&#39;</span><span class="p">:</span> <span class="s">&#39;GET&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy the OpenFaas Function</h2>

<p>We will deploy a dockerfile type function which will return the data that we feed it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">faas</span><span class="o">-</span><span class="n">cli</span> <span class="n">new</span> <span class="o">--</span><span class="n">lang</span> <span class="n">dockerfile</span> <span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span>
</span><span class='line'><span class="err">$</span> <span class="n">faas</span><span class="o">-</span><span class="n">cli</span> <span class="n">up</span> <span class="o">-</span><span class="n">f</span> <span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span><span class="o">.</span><span class="n">yml</span>
</span><span class='line'>
</span><span class='line'><span class="n">Deploying</span><span class="p">:</span> <span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="n">Deployed</span><span class="o">.</span> <span class="mi">202</span> <span class="n">Accepted</span><span class="o">.</span>
</span><span class='line'><span class="n">URL</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">openfaas</span><span class="o">.</span><span class="n">localdns</span><span class="o">.</span><span class="n">xyz</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span>
</span></code></pre></td></tr></table></div></figure>


<p>List the functions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">faas</span><span class="o">-</span><span class="n">cli</span> <span class="nb">list</span>
</span><span class='line'><span class="n">Function</span>                       <span class="n">Invocations</span>      <span class="n">Replicas</span>
</span><span class='line'><span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span>            <span class="mi">0</span>               <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Describe the function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">faas</span><span class="o">-</span><span class="n">cli</span> <span class="n">describe</span> <span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span>
</span><span class='line'><span class="n">Name</span><span class="p">:</span>                <span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span>
</span><span class='line'><span class="n">Status</span><span class="p">:</span>              <span class="n">Ready</span>
</span><span class='line'><span class="n">Replicas</span><span class="p">:</span>            <span class="mi">1</span>
</span><span class='line'><span class="n">Available</span> <span class="n">replicas</span><span class="p">:</span>  <span class="mi">1</span>
</span><span class='line'><span class="n">Invocations</span><span class="p">:</span>         <span class="mi">0</span>
</span><span class='line'><span class="n">Image</span><span class="p">:</span>               <span class="n">ruanbekker</span><span class="o">/</span><span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span><span class="p">:</span><span class="n">latest</span>
</span><span class='line'><span class="n">Function</span> <span class="n">process</span><span class="p">:</span>
</span><span class='line'><span class="n">URL</span><span class="p">:</span>                 <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">openfaas</span><span class="o">.</span><span class="n">localdns</span><span class="o">.</span><span class="n">xyz</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span>
</span><span class='line'><span class="n">Async</span> <span class="n">URL</span><span class="p">:</span>           <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">openfaas</span><span class="o">.</span><span class="n">localdns</span><span class="o">.</span><span class="n">xyz</span><span class="o">/</span><span class="n">async</span><span class="o">-</span><span class="n">function</span><span class="o">/</span><span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span>
</span><span class='line'><span class="n">Labels</span><span class="p">:</span>              <span class="n">faas_function</span> <span class="p">:</span> <span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span>
</span><span class='line'><span class="n">Annotations</span><span class="p">:</span>         <span class="n">prometheus</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">scrape</span> <span class="p">:</span> <span class="n">false</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing</h2>

<p>Test synchronous function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">openfaas</span><span class="o">.</span><span class="n">localdns</span><span class="o">.</span><span class="n">xyz</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'><span class="n">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>Test asynchronous function, remember, here we need to provide the callback url which the queue worker will inform, which will be our webhook service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">H</span> <span class="s">&quot;X-Callback-Url: http://webhook-service.default.svc.cluster.local:5000&quot;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">openfaas</span><span class="o">.</span><span class="n">localdns</span><span class="o">.</span><span class="n">xyz</span><span class="o">/</span><span class="n">async</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">function</span><span class="o">/</span><span class="n">function</span><span class="o">-</span><span class="n">async</span><span class="o">-</span><span class="n">task</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;asyyyyync&quot;</span>
</span><span class='line'><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">202</span> <span class="n">Accepted</span>
</span><span class='line'><span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">0</span>
</span><span class='line'><span class="n">Date</span><span class="p">:</span> <span class="n">Mon</span><span class="p">,</span> <span class="mi">17</span> <span class="n">Feb</span> <span class="mi">2020</span> <span class="mi">13</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">26</span> <span class="n">GMT</span>
</span><span class='line'><span class="n">Vary</span><span class="p">:</span> <span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span>
</span><span class='line'><span class="n">X</span><span class="o">-</span><span class="n">Call</span><span class="o">-</span><span class="n">Id</span><span class="p">:</span> <span class="n">d757c10f</span><span class="o">-</span><span class="mi">4293</span><span class="o">-</span><span class="mi">4</span><span class="n">daa</span><span class="o">-</span><span class="n">bf52</span><span class="o">-</span><span class="n">bbdc17b7dea3</span>
</span><span class='line'><span class="n">X</span><span class="o">-</span><span class="n">Start</span><span class="o">-</span><span class="n">Time</span><span class="p">:</span> <span class="mi">1581947846737501600</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check the logs of the webhook pod:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">kubectl</span> <span class="n">logs</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">/</span><span class="err">$</span><span class="p">(</span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">--</span><span class="n">selector</span><span class="o">=</span><span class="n">app</span><span class="o">=</span><span class="n">webhook</span> <span class="o">--</span><span class="n">output</span><span class="o">=</span><span class="n">jsonpath</span><span class="o">=</span><span class="s">&quot;{.items..metadata.name}&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">13</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">26</span><span class="p">,</span><span class="mi">774</span><span class="p">]</span> <span class="n">INFO</span> <span class="ow">in</span> <span class="n">app</span><span class="p">:</span> <span class="n">Receveid</span> <span class="n">Event</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;event&#39;</span><span class="p">:</span> <span class="n">b</span><span class="s">&#39;asyyyyync&#39;</span><span class="p">}</span>
</span><span class='line'><span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">13</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">26</span><span class="p">,</span><span class="mi">775</span><span class="p">]</span> <span class="n">INFO</span> <span class="ow">in</span> <span class="n">internal</span><span class="p">:</span> <span class="mf">10.42</span><span class="o">.</span><span class="mf">0.6</span> <span class="o">-</span> <span class="o">-</span> <span class="p">[</span><span class="mi">17</span><span class="o">/</span><span class="n">Feb</span><span class="o">/</span><span class="mi">2020</span> <span class="mi">13</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">26</span><span class="p">]</span> <span class="s">&quot;POST / HTTP/1.1&quot;</span> <span class="mi">200</span> <span class="o">-</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check the logs of the queue worker:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">kubectl</span> <span class="n">logs</span> <span class="o">-</span><span class="n">f</span> <span class="n">deployment</span><span class="o">/</span><span class="n">queue</span><span class="o">-</span><span class="n">worker</span> <span class="o">-</span><span class="n">n</span> <span class="n">openfaas</span>
</span><span class='line'><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="n">Received</span> <span class="n">on</span> <span class="p">[</span><span class="n">faas</span><span class="o">-</span><span class="n">request</span><span class="p">]:</span> <span class="s">&#39;sequence:45 subject:&quot;faas-request&quot; data:&quot;{</span><span class="se">\&quot;</span><span class="s">Header</span><span class="se">\&quot;</span><span class="s">:{</span><span class="se">\&quot;</span><span class="s">Accept</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">*/*</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">Accept-Encoding</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">gzip</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">Content-Length</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">9</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">Content-Type</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">application/x-www-form-urlencoded</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">User-Agent</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">curl/7.54.0</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">X-Call-Id</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">d757c10f-4293-4daa-bf52-bbdc17b7dea3</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">X-Callback-Url</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">http://webhook-service.default.svc.cluster.local:5000</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">X-Forwarded-For</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">10.42.0.0</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">X-Forwarded-Host</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">openfaas.localdns.xyz</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">X-Forwarded-Port</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">80</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">X-Forwarded-Proto</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">http</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">X-Forwarded-Server</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">traefik-6787cddb4b-87zss</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">X-Real-Ip</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">10.42.0.0</span><span class="se">\&quot;</span><span class="s">],</span><span class="se">\&quot;</span><span class="s">X-Start-Time</span><span class="se">\&quot;</span><span class="s">:[</span><span class="se">\&quot;</span><span class="s">1581947846737501600</span><span class="se">\&quot;</span><span class="s">]},</span><span class="se">\&quot;</span><span class="s">Host</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">openfaas.localdns.xyz</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">Body</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">YXN5eXl5eW5j</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">Method</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">POST</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">Path</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">QueryString</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">Function</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">openfaas-function-cat</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">CallbackUrl</span><span class="se">\&quot;</span><span class="s">:{</span><span class="se">\&quot;</span><span class="s">Scheme</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">http</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">Opaque</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">User</span><span class="se">\&quot;</span><span class="s">:null,</span><span class="se">\&quot;</span><span class="s">Host</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">webhook-service.default.svc.cluster.local:5000</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">Path</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">RawPath</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">ForceQuery</span><span class="se">\&quot;</span><span class="s">:false,</span><span class="se">\&quot;</span><span class="s">RawQuery</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">Fragment</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;\&quot;</span><span class="s">}}&quot; timestamp:1581947846738308800 &#39;</span>
</span><span class='line'><span class="n">Invoking</span><span class="p">:</span> <span class="n">openfaas</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">cat</span> <span class="k">with</span> <span class="mi">9</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">via</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">gateway</span><span class="o">.</span><span class="n">openfaas</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span><span class="n">function</span><span class="o">/</span><span class="n">openfaas</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">cat</span><span class="o">/</span>
</span><span class='line'><span class="n">Invoked</span><span class="p">:</span> <span class="n">openfaas</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">cat</span> <span class="p">[</span><span class="mi">200</span><span class="p">]</span> <span class="ow">in</span> <span class="mf">0.029029</span><span class="n">s</span>
</span><span class='line'><span class="n">Callback</span> <span class="n">to</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">webhook</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">5000</span>
</span><span class='line'><span class="n">openfaas</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">cat</span> <span class="n">returned</span> <span class="mi">9</span> <span class="nb">bytes</span>
</span><span class='line'><span class="n">Posted</span> <span class="n">result</span> <span class="k">for</span> <span class="n">openfaas</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">cat</span> <span class="n">to</span> <span class="n">callback</span><span class="o">-</span><span class="n">url</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">webhook</span><span class="o">-</span><span class="n">service</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="mi">200</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make 1000 Requests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">date</span> <span class="o">&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">date</span>
</span><span class='line'>  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">{</span><span class="mf">1.</span><span class="o">.</span><span class="mi">1000</span><span class="p">}</span>
</span><span class='line'>    <span class="n">do</span>
</span><span class='line'>      <span class="n">curl</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">H</span> <span class="s">&quot;X-Callback-Url: http://webhook-service.default.svc.cluster.local:5000&quot;</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">openfaas</span><span class="o">.</span><span class="n">localdns</span><span class="o">.</span><span class="n">xyz</span><span class="o">/</span><span class="n">async</span><span class="o">-</span><span class="n">function</span><span class="o">/</span><span class="n">openfaas</span><span class="o">-</span><span class="n">function</span><span class="o">-</span><span class="n">cat</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;asyyyyync&quot;</span>
</span><span class='line'>    <span class="n">done</span>
</span><span class='line'>  <span class="n">date</span> <span class="o">&gt;&gt;</span> <span class="n">time</span><span class="o">.</span><span class="n">date</span>
</span></code></pre></td></tr></table></div></figure>


<p>View the log file that we wrote before we started and finished our requests:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">cat</span> <span class="n">time</span><span class="o">.</span><span class="n">date</span>
</span><span class='line'><span class="n">Mon</span> <span class="n">Feb</span> <span class="mi">17</span> <span class="mi">16</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mi">16</span> <span class="n">SAST</span> <span class="mi">2020</span>
</span><span class='line'><span class="n">Mon</span> <span class="n">Feb</span> <span class="mi">17</span> <span class="mi">16</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mi">48</span> <span class="n">SAST</span> <span class="mi">2020</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last request was actioned at:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">[</span><span class="mi">2020</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">14</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mi">52</span><span class="p">,</span><span class="mi">421</span><span class="p">]</span> <span class="n">INFO</span> <span class="ow">in</span> <span class="n">internal</span><span class="p">:</span> <span class="mf">10.42</span><span class="o">.</span><span class="mf">0.6</span> <span class="o">-</span> <span class="o">-</span> <span class="p">[</span><span class="mi">17</span><span class="o">/</span><span class="n">Feb</span><span class="o">/</span><span class="mi">2020</span> <span class="mi">14</span><span class="p">:</span><span class="mo">03</span><span class="p">:</span><span class="mi">52</span><span class="p">]</span> <span class="s">&quot;POST / HTTP/1.1&quot;</span> <span class="mi">200</span> <span class="o">-</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>This was a basic example to demonstrate async functions using OpenFaas</p>

<h2>OpenFaas Documentation:</h2>

<ul>
<li><a href="https://docs.openfaas.com">https://docs.openfaas.com</a></li>
<li><a href="https://docs.openfaas.com/reference/async/">https://docs.openfaas.com/reference/async/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/02/17/traefik-ingress-for-openfaas-on-kubernetes-k3d/">Traefik Ingress for OpenFaas on Kubernetes (K3d)</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-02-17T23:36:33+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we will deploy <a href="https://www.openfaas.com/">OpenFaas</a> on Kubernetes locally using <a href="https://github.com/alexellis/k3sup">k3sup</a> and <a href="https://github.com/rancher/k3d">k3d</a>, then deploy a Traefik Ingress so that we can access the OpenFaas Gateway on HTTP over the standard port 80.</p>

<p>K3d is a amazing wrapper that deploys a k3s cluster on docker, and k3sup makes it very easy to provision OpenFaas to your Kubernetes cluster.</p>

<h2>Deploy a Kubernetes Cluster</h2>

<p>If you have not installed k3d, you can install k3d on mac with brew:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew install k3d</span></code></pre></td></tr></table></div></figure>


<p>We will deploy our cluster with 2 worker nodes and publish port 80 to the containers port 80:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ k3d create --name="demo" --workers="2" --publish="80:80"</span></code></pre></td></tr></table></div></figure>


<p>Point the kubeconfig to the location that k3d generated:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export KUBECONFIG="$(k3d get-kubeconfig --name='demo')"</span></code></pre></td></tr></table></div></figure>


<h2>Deploy OpenFaas</h2>

<p>First we need to get k3sup:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -sLfS https://get.k3sup.dev | sudo sh</span></code></pre></td></tr></table></div></figure>


<p>Once k3sup is installed, deploy OpenFaas to your cluster:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ k3sup app install openfaas</span></code></pre></td></tr></table></div></figure>


<p>Give it a minute or so and check if everything is running:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ kubectl get pods -n openfaas
</span><span class='line'>NAMESPACE     NAME                                 READY   STATUS      RESTARTS   AGE
</span><span class='line'>openfaas      alertmanager-546f66b6c6-qtb69        1/1     Running     0          5m
</span><span class='line'>openfaas      basic-auth-plugin-79b9878b7b-7vlln   1/1     Running     0          4m59s
</span><span class='line'>openfaas      faas-idler-db8cd9c7d-8xfpp           1/1     Running     2          4m57s
</span><span class='line'>openfaas      gateway-7dcc6d694d-dmvqn             2/2     Running     0          4m56s
</span><span class='line'>openfaas      nats-d6d574749-rt9vw                 1/1     Running     0          4m56s
</span><span class='line'>openfaas      prometheus-d99669d9b-mfxc8           1/1     Running     0          4m53s
</span><span class='line'>openfaas      queue-worker-75f44b56b9-mhhbv        1/1     Running     0          4m52s</span></code></pre></td></tr></table></div></figure>


<h2>Traefik Ingress</h2>

<p>In my scenario, I am using <code>openfaas.localdns.xyz</code> which resolves to <code>127.0.0.1</code>. Next we need to know to which service to route the traffic to, we can find that by:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ kubectl get svc/gateway -n openfaas
</span><span class='line'>NAME      TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
</span><span class='line'>gateway   ClusterIP   10.43.174.57   &lt;none&gt;        8080/TCP   23m</span></code></pre></td></tr></table></div></figure>


<p>Below is our ingress.yml:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apiVersion: extensions/v1beta1
</span><span class='line'>kind: Ingress
</span><span class='line'>metadata:
</span><span class='line'>  name: openfaas-gateway-ingress
</span><span class='line'>  namespace: openfaas
</span><span class='line'>  annotations:
</span><span class='line'>    kubernetes.io/ingress.class: traefik
</span><span class='line'>spec:
</span><span class='line'>  rules:
</span><span class='line'>  - host: openfaas.localdns.xyz
</span><span class='line'>    http:
</span><span class='line'>      paths:
</span><span class='line'>      - backend:
</span><span class='line'>          serviceName: gateway
</span><span class='line'>          servicePort: 8080</span></code></pre></td></tr></table></div></figure>


<p>Apply the ingress:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ kubectl apply -f ingress.yml
</span><span class='line'>ingress.extensions/openfaas-gateway-ingress created</span></code></pre></td></tr></table></div></figure>


<p>We can the verify that our ingress is visible:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ kubectl get ingress -n openfaas
</span><span class='line'>NAMESPACE   NAME                       HOSTS               ADDRESS      PORTS   AGE
</span><span class='line'>openfaas    openfaas-gateway-ingress   openfaas.co.local   172.25.0.4   80      28s</span></code></pre></td></tr></table></div></figure>


<h2>OpenFaas CLI</h2>

<p>Install the OpenFaas CLI:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -SLsf https://cli.openfaas.com | sudo sh</span></code></pre></td></tr></table></div></figure>


<p>Export the <code>OPENFAAS_URL</code> to our ingress endpoint and <code>OPENFAAS_PREFIX</code> for your dockerhub username:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export OPENFAAS_URL=http://openfaas.localdns.xyz
</span><span class='line'>$ export OPENFAAS_PREFIX=ruanbekker # change to your username</span></code></pre></td></tr></table></div></figure>


<p>Get your credentials for the OpenFaas Gateway and login with the OpenFaas CLI:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ PASSWORD=$(kubectl get secret -n openfaas basic-auth -o jsonpath="{.data.basic-auth-password}" | base64 --decode; echo)
</span><span class='line'>$ echo -n $PASSWORD | faas-cli login --username admin --password-stdin</span></code></pre></td></tr></table></div></figure>


<h2>Deploy a Function</h2>

<p>Deploy the figlet function as an example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ faas-cli store deploy figlet
</span><span class='line'>
</span><span class='line'>Deployed. 202 Accepted.
</span><span class='line'>URL: http://openfaas.localdns.xyz/function/figlet</span></code></pre></td></tr></table></div></figure>


<p>Invoke the function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://openfaas.localdns.xyz/function/figlet -d 'hello, world'
</span><span class='line'> _          _ _                             _     _
</span><span class='line'>| |__   ___| | | ___    __      _____  _ __| | __| |
</span><span class='line'>| '_ \ / _ \ | |/ _ \   \ \ /\ / / _ \| '__| |/ _` |
</span><span class='line'>| | | |  __/ | | (_) |   \ V  V / (_) | |  | | (_| |
</span><span class='line'>|_| |_|\___|_|_|\___( )   \_/\_/ \___/|_|  |_|\__,_|
</span><span class='line'>                    |/</span></code></pre></td></tr></table></div></figure>


<h2>Delete the Cluster</h2>

<p>Delete your k3d Kubernetes Cluster:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ k3d delete --name demo</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/05/05/how-to-setup-a-redis-exporter-for-prometheus/">How to Setup a Redis Exporter for Prometheus</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/28/nginx-analysis-dashboard-using-grafana-and-elasticsearch/">Nginx Analysis Dashboard Using Grafana and Elasticsearch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/27/how-to-do-port-forwarding-with-iptables/">How to Do Port Forwarding With Iptables</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/27/how-to-set-a-static-ip-in-ubuntu-18/">How to Set a Static IP in Ubuntu 18</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/26/graphing-covid-19-stats-with-grafana-and-elasticsearch-using-python/">Graphing Covid-19 Stats With Grafana and Elasticsearch Using Python</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Free $100 Credit</h1>
  <ul id=""></ul>
  <p></p>
  <strong>May 2020</strong>: Receive $100 to test on Vultr when you sign up.
  <p></p>
  <a href="https://www.vultr.com/?ref=8373836-6G"><img src="https://www.vultr.com/media/banners/banner_160x600.png" width="160" height="600"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
