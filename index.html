
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="Concourse is a Pipeline Based Continious Integration system written in Go Resources: https://concourse-ci.org/
https://github.com/concourse/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
<script>
(function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
})(document, window, '//fh-blog-ruanbekker-com.home.ruan.dev/tracker.js', 'fathom');
fathom('set', 'siteId', 'MWBHH');
fathom('trackPageview');
</script>
<!-- / Fathom -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/04/06/install-concourse-ci-v6-on-ubuntu-20-dot-04/">Install Concourse CI V6 on Ubuntu 20.04</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-04-06T17:56:38-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>5:56 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495" alt="" /></p>

<p>Concourse is a Pipeline Based Continious Integration system written in Go</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://concourse-ci.org/">https://concourse-ci.org/</a></li>
<li><a href="https://github.com/concourse/concourse">https://github.com/concourse/concourse</a></li>
<li><a href="https://github.com/starkandwayne/concourse-tutorial">https://github.com/starkandwayne/concourse-tutorial</a></li>
</ul>


<h2>Older Version</h2>

<p>An older version is available:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2017/11/07/setup-a-concourse-ci-server-on-ubuntu-16/">Setup Concourse CI v4 on Ubuntu 16.04</a></li>
</ul>


<h2>What is Concourse CI:</h2>

<p>Concourse CI is a Continious Integration Platform. Concourse enables you to construct pipelines with a yaml configuration that can consist out of 3 core concepts, tasks, resources, and jobs that compose them. For more information about this have a look at their <a href="https://concourse.ci/concepts.html">docs</a></p>

<h2>What will we be doing today</h2>

<p>We will setup a Concourse CI Server v6.7.6 (web and worker) on Ubuntu 20.04 and run the traditional <code>Hello, World</code> pipeline</p>

<h2>Setup the Server:</h2>

<p>Concourse needs <code>PostgresSQL</code> server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install postgresql postgresql-contrib -y
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>postgresql
</span></code></pre></td></tr></table></div></figure>


<p>Create the Database and User for Concourse on Postgres:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo -u postgres createuser concourse
</span><span class='line'><span class="nv">$ </span>sudo -u postgres createdb --owner<span class="o">=</span>concourse atc
</span></code></pre></td></tr></table></div></figure>


<p>Download the Concourse and Fly Cli Binaries:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v6.7.6/concourse-6.7.6-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v6.7.6/fly-6.7.6-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>tar -xvf concourse-6.7.6-linux-amd64.tgz -C /usr/local/
</span><span class='line'><span class="nv">$ </span>tar -xvf fly-6.7.6-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>mv fly /usr/bin/fly
</span><span class='line'><span class="nv">$ </span>rm -rf concourse-6.7.6-linux-amd64.tgz fly-6.7.6-linux-amd64.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Create the Encryption Keys:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /etc/concourse
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/tsa_host_key
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/worker_key
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/session_signing_key
</span><span class='line'><span class="nv">$ </span>cp /etc/concourse/worker_key.pub /etc/concourse/authorized_worker_keys
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Web Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/concourse/web_environment
</span><span class='line'>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/concourse/bin
</span><span class='line'><span class="nv">CONCOURSE_ADD_LOCAL_USER</span><span class="o">=</span>ruan:pass
</span><span class='line'><span class="nv">CONCOURSE_SESSION_SIGNING_KEY</span><span class="o">=</span>/etc/concourse/session_signing_key
</span><span class='line'><span class="nv">CONCOURSE_TSA_HOST_KEY</span><span class="o">=</span>/etc/concourse/tsa_host_key
</span><span class='line'><span class="nv">CONCOURSE_TSA_AUTHORIZED_KEYS</span><span class="o">=</span>/etc/concourse/authorized_worker_keys
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_HOST</span><span class="o">=</span>127.0.0.1
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_USER</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_PASSWORD</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_DATABASE</span><span class="o">=</span>atc
</span><span class='line'><span class="nv">CONCOURSE_MAIN_TEAM_LOCAL_USER</span><span class="o">=</span>ruan
</span><span class='line'><span class="nv">CONCOURSE_EXTERNAL_URL</span><span class="o">=</span>http://10.20.30.40:8080 <span class="c"># replace this with your ip address</span>
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Worker Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/concourse/worker_environment
</span><span class='line'>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/concourse/bin
</span><span class='line'><span class="nv">CONCOURSE_WORK_DIR</span><span class="o">=</span>/var/lib/concourse
</span><span class='line'><span class="nv">CONCOURSE_TSA_HOST</span><span class="o">=</span>127.0.0.1:2222
</span><span class='line'><span class="nv">CONCOURSE_TSA_PUBLIC_KEY</span><span class="o">=</span>/etc/concourse/tsa_host_key.pub
</span><span class='line'><span class="nv">CONCOURSE_TSA_WORKER_PRIVATE_KEY</span><span class="o">=</span>/etc/concourse/worker_key
</span><span class='line'><span class="nv">CONCOURSE_GARDEN_DNS_SERVER</span><span class="o">=</span>8.8.8.8
</span></code></pre></td></tr></table></div></figure>


<p>Create a Concourse user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /var/lib/concourse
</span><span class='line'><span class="nv">$ </span>sudo adduser --system --group concourse
</span><span class='line'><span class="nv">$ </span>sudo chown -R concourse:concourse /etc/concourse /var/lib/concourse
</span><span class='line'><span class="nv">$ </span>sudo chmod <span class="m">600</span> /etc/concourse/*_environment
</span></code></pre></td></tr></table></div></figure>


<p>Create SystemD Unit Files, first for the Web Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/systemd/system/concourse-web.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Concourse CI web process <span class="o">(</span>ATC and TSA<span class="o">)</span>
</span><span class='line'><span class="nv">After</span><span class="o">=</span>postgresql.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">User</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>on-failure
</span><span class='line'><span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/concourse/web_environment
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/concourse web
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></code></pre></td></tr></table></div></figure>


<p>Then the SystemD Unit File for the Worker Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/systemd/system/concourse-worker.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Concourse CI worker process
</span><span class='line'><span class="nv">After</span><span class="o">=</span>concourse-web.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">User</span><span class="o">=</span>root
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>on-failure
</span><span class='line'><span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/concourse/worker_environment
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/concourse worker
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></code></pre></td></tr></table></div></figure>


<p>Create a postgres password for the concourse user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /home/concourse/
</span><span class='line'><span class="nv">$ </span>sudo -u concourse psql atc
</span><span class='line'><span class="nv">atc</span><span class="o">=</span>&gt; ALTER USER concourse WITH PASSWORD <span class="s1">&#39;concourse&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">atc</span><span class="o">=</span>&gt; <span class="se">\q</span>
</span></code></pre></td></tr></table></div></figure>


<p>Start and Enable the Services:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl start concourse-web concourse-worker
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>concourse-web concourse-worker postgresql
</span><span class='line'><span class="nv">$ </span>systemctl status concourse-web concourse-worker
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>systemctl is-active concourse-worker concourse-web
</span><span class='line'>active
</span><span class='line'>active
</span></code></pre></td></tr></table></div></figure>


<p>The listening ports should more or less look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -tulpn
</span><span class='line'>
</span><span class='line'>Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7777          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7788          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:8079          0.0.0.0:*               LISTEN      4525/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      1283/sshd
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:5432          0.0.0.0:*               LISTEN      4047/postgres
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::36159                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::46829                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::2222                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::8080                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      1283/sshd
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:68              0.0.0.0:*                           918/dhclient
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:42165           0.0.0.0:*                           4530/concourse
</span></code></pre></td></tr></table></div></figure>


<h2>Client Side:</h2>

<p>I will be using a the Fly cli from a Mac, so first we need to download the fly-cli for Mac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v6.7.6/fly-6.7.6-darwin-amd64.tgz
</span><span class='line'><span class="nv">$ </span>tar -xvf fly-6.7.6-darwin-amd64.tgz
</span><span class='line'><span class="nv">$ </span>sudo mv fly /usr/local/bin/fly
</span><span class='line'><span class="nv">$ </span>rm -rf fly-6.7.6-darwin-amd64.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to setup our Concourse Target by Authenticating against our Concourse Endpoint, lets setup our target with the name <code>ci</code>, and make sure to replace the ip address with the ip of your concourse server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci login -c http://10.20.30.40:8080
</span><span class='line'>logging in to team <span class="s1">&#39;main&#39;</span>
</span><span class='line'>
</span><span class='line'>navigate to the following URL in your browser:
</span><span class='line'>
</span><span class='line'>  http://10.20.30.40:8080/login?fly_port<span class="o">=</span>42181
</span><span class='line'>
</span><span class='line'>or enter token manually <span class="o">(</span>input hidden<span class="o">)</span>:
</span><span class='line'>target saved
</span></code></pre></td></tr></table></div></figure>


<p>Lets list our targets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly targets
</span><span class='line'>name  url                        team  expiry
</span><span class='line'>ci    http://10.20.30.40:8080    main  Wed, <span class="m">08</span> Nov <span class="m">2021</span> 15:32:59 UTC
</span></code></pre></td></tr></table></div></figure>


<p>Listing Registered Workers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>10.20.30.40       <span class="m">0</span>           linux     none  none  running  1.2
</span></code></pre></td></tr></table></div></figure>


<p>Listing Active Containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job            build <span class="c">#  build id  type   name                  attempt</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hello World Pipeline:</h2>

<p>Let&rsquo;s create a basic pipeline, that will print out <code>Hello, World!</code>:</p>

<p>Our <code>hello-world.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-job</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">say-hello</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine</span>
</span><span class='line'>          <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">edge</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/bin/sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">-c</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Hello, World!&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Applying the configuration to our pipeline:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci <span class="nb">set</span>-pipeline -p yeeehaa -c hello-world.yml
</span><span class='line'><span class="nb">jobs</span>:
</span><span class='line'>  job my-job has been added:
</span><span class='line'>    name: my-job
</span><span class='line'>    plan:
</span><span class='line'>    - task: say-hello
</span><span class='line'>      config:
</span><span class='line'>        platform: linux
</span><span class='line'>        image_resource:
</span><span class='line'>          <span class="nb">type</span>: docker-image
</span><span class='line'>          <span class="nb">source</span>:
</span><span class='line'>            repository: alpine
</span><span class='line'>            tag: edge
</span><span class='line'>        run:
</span><span class='line'>          path: /bin/sh
</span><span class='line'>          args:
</span><span class='line'>          - -c
</span><span class='line'>          - <span class="p">|</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'>apply configuration? <span class="o">[</span>yN<span class="o">]</span>: y
</span><span class='line'>pipeline created!
</span><span class='line'>you can view your pipeline here: http://10.20.30.40:8080/teams/main/pipelines/yeeehaa
</span><span class='line'>
</span><span class='line'>the pipeline is currently paused. to unpause, either:
</span><span class='line'>  - run the unpause-pipeline <span class="nb">command</span>
</span><span class='line'>  - click play next to the pipeline in the web ui
</span></code></pre></td></tr></table></div></figure>


<p>We can browse to the WebUI to unpause the pipeline, but since I like to do everything on cli as far as possible, I will unpause the pipeline via cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci unpause-pipeline -p yeeehaa
</span><span class='line'>unpaused <span class="s1">&#39;yeeehaa&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now our Pipeline is unpaused, but since we did not specify any triggers, we need to manually trigger the pipeline to run, you can either via the WebUI, select your pipeline which in this case will be named <code>yeeehaa</code> and then select the job, which will be <code>my-job</code> then hit the <code>+</code> sign, which will trigger the pipeline.</p>

<p>I will be using the cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job
</span><span class='line'>started yeeehaa/my-job <span class="c">#1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Via the WebUI on <code>http://10.20.30.40:8080/teams/main/pipelines/yeeehaa/jobs/my-job/builds/1</code> you should see the <code>Hello, World!</code> output, or via the cli, we also have the option to see the output, so let&rsquo;s trigger it again, but this time passing the <code>--watch</code> flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job --watch
</span><span class='line'>started yeeehaa/my-job <span class="c">#2</span>
</span><span class='line'>
</span><span class='line'>initializing
</span><span class='line'>running /bin/sh -c <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>Hello, World!
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>


<p>Listing our Workers and Containers again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>10.20.30.40       <span class="m">2</span>           linux     none  none  running  1.2
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job         build <span class="c">#  build id  type   name           attempt</span>
</span><span class='line'>36982955-54fd-4c1b-57b8-216486c58db8  10.20.30.40       yeeehaa      my-job      <span class="m">2</span>        <span class="m">729</span>       task   say-hello      n/a
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/wireguard-vpn-with-unbound-ads-blocking-dns/">Wireguard VPN With Unbound ADS Blocking DNS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:59:51-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:59 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will setup a Wireguard VPN with Unbound DNS Server with some additional configuration to block ads for any clients using the DNS Server while connected to the VPN.</p>

<p>A massive thank you to <a href="https://github.com/complexorganizations/wireguard-manager/blob/main/wireguard-server.sh">complexorganizations</a> for providing the source where this tuturial is based off.</p>

<h2>Install Packages</h2>

<p>I will be using Debian Buster for this installation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update
</span><span class='line'>$ apt upgrade -y
</span><span class='line'>$ apt update && apt install iptables curl coreutils bc jq sed e2fsprogs -y
</span><span class='line'>$ apt install linux-headers-"$(uname -r)" -y</span></code></pre></td></tr></table></div></figure>


<p>I want to disable IPv6, in my case I had to apply a couple of kernel parameter tweaks:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo net.ipv6.conf.all.disable_ipv6 = 1 &gt; /etc/sysctl.d/70-disable-ipv6.conf
</span><span class='line'>$ echo "net.ipv6.conf.$(ip -4 route ls | grep default | grep -Po '(?&lt;=dev )(\S+)' | head -1).disable_ipv6 = 1" &gt;&gt; /etc/sysctl.d/70-disable-ipv6.conf
</span><span class='line'>$ echo 'net.ipv4.ip_forward = 1' &gt; /etc/sysctl.d/60-enable-ip-forwarding.conf
</span><span class='line'>$ sysctl -p -f /etc/sysctl.d/70-disable-ipv6.conf
</span><span class='line'>$ sysctl -p -f /etc/sysctl.d/60-enable-ip-forwarding.conf</span></code></pre></td></tr></table></div></figure>


<h2>Environment Variables</h2>

<p>A couple of environment variables that we will reference during our installation, tweak where your setup differs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export NPROC=$(nproc)
</span><span class='line'>$ export SERVER_HOST=$(curl -s -4 ifconfig.co)
</span><span class='line'>$ export SERVER_PORT="51820"
</span><span class='line'>$ export MTU_CHOICE="1280"
</span><span class='line'>$ export NAT_CHOICE="25"
</span><span class='line'>$ export IPV4_SUBNET="10.7.0.0/24"
</span><span class='line'>$ export PRIVATE_SUBNET_V4=${IPV4_SUBNET}
</span><span class='line'>$ export GATEWAY_ADDRESS_V4="${PRIVATE_SUBNET_V4::-4}1"
</span><span class='line'>$ export PRIVATE_SUBNET_MASK_V4=$(echo "$PRIVATE_SUBNET_V4" | cut -d "/" -f 2)
</span><span class='line'>$ export CLIENT_DNS="$GATEWAY_ADDRESS_V4"
</span><span class='line'>$ export CLIENT_ALLOWED_IP="0.0.0.0/0"</span></code></pre></td></tr></table></div></figure>


<h2>Unbound Installation</h2>

<p>Download the unbound <code>root.hints</code> file from internic:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl https://www.internic.net/domain/named.cache --create-dirs -o /etc/unbound/root.hints</span></code></pre></td></tr></table></div></figure>


<p>Generate the <code>/etc/unbound/unbound.conf</code> config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "include: \"/etc/unbound/unbound.conf.d/*.conf\"
</span><span class='line'>server:
</span><span class='line'>    num-threads: $NPROC
</span><span class='line'>    verbosity: 1
</span><span class='line'>    root-hints: /etc/unbound/root.hints
</span><span class='line'>    # auto-trust-anchor-file: /var/lib/unbound/root.key
</span><span class='line'>    interface: 0.0.0.0
</span><span class='line'>    interface: ::0
</span><span class='line'>    max-udp-size: 3072
</span><span class='line'>    access-control: 0.0.0.0/0                 refuse
</span><span class='line'>    access-control: $PRIVATE_SUBNET_V4               allow
</span><span class='line'>    access-control: 127.0.0.1                 allow
</span><span class='line'>    private-address: $PRIVATE_SUBNET_V4
</span><span class='line'>    hide-identity: yes
</span><span class='line'>    hide-version: yes
</span><span class='line'>    harden-glue: yes
</span><span class='line'>    harden-dnssec-stripped: yes
</span><span class='line'>    harden-referral-path: yes
</span><span class='line'>    unwanted-reply-threshold: 10000000
</span><span class='line'>    val-log-level: 1
</span><span class='line'>    cache-min-ttl: 1800
</span><span class='line'>    cache-max-ttl: 14400
</span><span class='line'>    prefetch: yes
</span><span class='line'>    qname-minimisation: yes
</span><span class='line'>    prefetch-key: yes
</span><span class='line'>    forward-zone:
</span><span class='line'>        name: \".\"
</span><span class='line'>        forward-addr: 1.1.1.1
</span><span class='line'>        forward-addr: 8.8.8.8" &gt;&gt; /etc/unbound/unbound.conf</span></code></pre></td></tr></table></div></figure>


<p>Download the host entries for all the ad servers which we will block:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/social/hosts -o /tmp/adblocking_hosts</span></code></pre></td></tr></table></div></figure>


<p>Include the ads configuration in <code>/etc/unbound/unbound.d/ads.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "server:" &gt; /etc/unbound/unbound.conf.d/ads.conf
</span><span class='line'>$ cat /etc/unbound/adblocking_hosts | grep '^0\.0\.0\.0' | awk '{print "    local-zone: \""$2"\" redirect\n    local-data: \""$2" A 0.0.0.0\""}' &gt;&gt; /etc/unbound/unbound.conf.d/ads.conf</span></code></pre></td></tr></table></div></figure>


<p>Update the VPN Server&rsquo;s nameserver configuration to unbound:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chattr -i /etc/resolv.conf
</span><span class='line'>$ mv /etc/resolv.conf /etc/resolv.conf.old
</span><span class='line'>$ echo "nameserver 127.0.0.1" &gt;&gt;/etc/resolv.conf
</span><span class='line'>$ chattr +i /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>


<p>Enable and Restart Unbound:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable unbound
</span><span class='line'>$ systemctl restart unbound</span></code></pre></td></tr></table></div></figure>


<p>Test if DNS Resolution works:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ dig google.com</span></code></pre></td></tr></table></div></figure>


<h2>Wireguard Installation</h2>

<p>Include the sources and install wireguard and its dependencies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "deb http://deb.debian.org/debian/ unstable main" &gt;&gt;/etc/apt/sources.list.d/unstable.list
</span><span class='line'>$ echo -e "Package: *\nPin: release a=unstable\nPin-Priority: 90"  &gt;&gt;/etc/apt/preferences.d/limit-unstable
</span><span class='line'>$ apt update
</span><span class='line'>$ apt install wireguard qrencode haveged ifupdown -y</span></code></pre></td></tr></table></div></figure>


<p>Set the environment variables and tweak where you need to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export SERVER_PRIVKEY=$(wg genkey)
</span><span class='line'>$ export SERVER_PUBKEY=$(echo "$SERVER_PRIVKEY" | wg pubkey)
</span><span class='line'>$ export CLIENT_NAME="ruan-pc"
</span><span class='line'>$ export CLIENT_PRIVKEY=$(wg genkey)
</span><span class='line'>$ export CLIENT_PUBKEY=$(echo "$CLIENT_PRIVKEY" | wg pubkey)
</span><span class='line'>$ export CLIENT_ADDRESS_V4="${PRIVATE_SUBNET_V4::-4}3"
</span><span class='line'>$ export PRESHARED_KEY=$(wg genpsk)
</span><span class='line'>$ export WIREGUARD_PUB_NIC="wg0"
</span><span class='line'>$ export PEER_PORT=$(shuf -i1024-65535 -n1)
</span><span class='line'>$ export WG_CONFIG="/etc/wireguard/$WIREGUARD_PUB_NIC.conf"</span></code></pre></td></tr></table></div></figure>


<p>Create the wireguard clients directory and create the config filename:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p /etc/wireguard/clients
</span><span class='line'>$ touch $WG_CONFIG && chmod 600 $WG_CONFIG</span></code></pre></td></tr></table></div></figure>


<p>Create the wireguard server config content and write it to the config file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "# $PRIVATE_SUBNET_V4 $SERVER_HOST:$SERVER_PORT $SERVER_PUBKEY $CLIENT_DNS $MTU_CHOICE $NAT_CHOICE $CLIENT_ALLOWED_IP
</span><span class='line'>[Interface]
</span><span class='line'>Address = $GATEWAY_ADDRESS_V4/$PRIVATE_SUBNET_MASK_V4
</span><span class='line'>ListenPort = $SERVER_PORT
</span><span class='line'>PrivateKey = $SERVER_PRIVKEY
</span><span class='line'>PostUp = iptables -A FORWARD -i $WIREGUARD_PUB_NIC -o $SERVER_PUB_NIC -j ACCEPT; iptables -t nat -A POSTROUTING -o $SERVER_PUB_NIC -j MASQUERADE; iptables -A INPUT -s $PRIVATE_SUBNET_V4 -p udp -m udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
</span><span class='line'>PostDown = iptables -D FORWARD -i $WIREGUARD_PUB_NIC  -o $SERVER_PUB_NIC -j ACCEPT; iptables -t nat -D POSTROUTING -o $SERVER_PUB_NIC -j MASQUERADE; iptables -D INPUT -s $PRIVATE_SUBNET_V4 -p udp -m udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
</span><span class='line'>SaveConfig = false
</span><span class='line'># $CLIENT_NAME start
</span><span class='line'>[Peer]
</span><span class='line'>PublicKey = $CLIENT_PUBKEY
</span><span class='line'>PresharedKey = $PRESHARED_KEY
</span><span class='line'>AllowedIPs = $CLIENT_ADDRESS_V4/32
</span><span class='line'># $CLIENT_NAME end &gt;&gt;" &gt;&gt; $WG_CONFIG</span></code></pre></td></tr></table></div></figure>


<p>Create the client config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "# $CLIENT_NAME
</span><span class='line'>[Interface]
</span><span class='line'>Address = $CLIENT_ADDRESS_V4/$PRIVATE_SUBNET_MASK_V4
</span><span class='line'>DNS = $CLIENT_DNS
</span><span class='line'>ListenPort = $PEER_PORT
</span><span class='line'>MTU = $MTU_CHOICE
</span><span class='line'>PrivateKey = $CLIENT_PRIVKEY
</span><span class='line'>[Peer]
</span><span class='line'>AllowedIPs = $CLIENT_ALLOWED_IP
</span><span class='line'>Endpoint = $SERVER_HOST:$SERVER_PORT
</span><span class='line'>PersistentKeepalive = $NAT_CHOICE
</span><span class='line'>PresharedKey = $PRESHARED_KEY
</span><span class='line'>PublicKey = $SERVER_PUBKEY" &gt;&gt; /etc/wireguard/clients/"$CLIENT_NAME"-$WIREGUARD_PUB_NIC.conf</span></code></pre></td></tr></table></div></figure>


<p>Restart and Enable Wireguard:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable wg-quick@$WIREGUARD_PUB_NIC
</span><span class='line'>$ systemctl restart wg-quick@$WIREGUARD_PUB_NIC</span></code></pre></td></tr></table></div></figure>


<h2>Connect your Client</h2>

<p>Head over to <a href="https://www.wireguard.com/install/">Wireguard.com</a> and install the client of your choice then generate a QR Code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ qrencode -t ansiutf8 -l L &lt;/etc/wireguard/clients/"$CLIENT_NAME"-$WIREGUARD_PUB_NIC.conf</span></code></pre></td></tr></table></div></figure>


<p>Configure your client and connect to the VPN, after the connection has been established you can have a look on the server for connection details with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wg show</span></code></pre></td></tr></table></div></figure>


<p>Once connected head over to a website with ads, such as <a href="https://www.speedtest.net/">https://www.speedtest.net/</a> and you should see no ads.</p>

<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/ssh-using-aws-ssm-session-manager/">SSH Using AWS SSM Session Manager</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:52:54-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:52 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You can use SSM Session Manager to connect to your EC2 instances, as long as your EC2 instance has the associated IAM Role which includes the AmazonSSMManagedInstanceCore managed policy.</p>

<h2>AWS EC2 Console</h2>

<p>Head over to &ldquo;Connect&rdquo; and select &ldquo;Session Manager&rdquo;:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103775580-e8da2a80-5036-11eb-9e00-0fd9b4d9d467.png" alt="image" /></p>

<p>You should get a shell:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103775597-f2639280-5036-11eb-8101-768f1c81108a.png" alt="image" /></p>

<h2>AWS CLI</h2>

<p>You can also use the CLI:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aws --profile prod ssm start-session --target i-0ebba722b102179b6</span></code></pre></td></tr></table></div></figure>


<p>If you get this error:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103775625-ff808180-5036-11eb-88dc-be8fde3586ad.png" alt="image" /></p>

<p>Head over to:</p>

<p><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html">https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html</a></p>

<p>Install the session manager plugin, for Mac:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip" -o "sessionmanager-bundle.zip"
</span><span class='line'>$ unzip sessionmanager-bundle.zip
</span><span class='line'>$ sudo ./sessionmanager-bundle/install -i /usr/local/sessionmanagerplugin -b /usr/local/bin/session-manager-plugin
</span><span class='line'>$ rm -rf sessionmanager-bundle</span></code></pre></td></tr></table></div></figure>


<p>After installation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aws --profile prod ssm start-session --target i-0ebba722b102179b6
</span><span class='line'>Starting session with SessionId: ruan.bekker-0b07cbbe261885ad3
</span><span class='line'>
</span><span class='line'>sh-4.2$ sudo su - ec2-user
</span><span class='line'>Last login: Wed Jan  6 12:55:03 UTC 2021 on pts/0
</span><span class='line'>[ec2-user@ip-172-31-23-246 ~]$</span></code></pre></td></tr></table></div></figure>


<p>Note: when you are using ssm session manager you dont require security groups or a direct routable network to your instance.</p>

<h2>Bash Functions FTW</h2>

<p>You can implement this into a bash function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.functions.aws
</span><span class='line'>aws-ssh(){
</span><span class='line'>  instance_name=${1}
</span><span class='line'>  instance_id=$(aws --profile prod ec2 describe-instances --filter "Name=tag:Name,Values=${instance_name}" --query "Reservations[].Instances[?State.Name == 'running'].InstanceId[]" --output text)
</span><span class='line'>  aws --profile prod ssm start-session --target ${instance_id}
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>$ aws-ssh ssm-session-manager-ssh-test2
</span><span class='line'>Starting session with SessionId: ruan.bekker-04daf56c5f3668790
</span><span class='line'>sh-4.2$</span></code></pre></td></tr></table></div></figure>


<p>If you have your own SSH key, you can use this ~/.ssh/config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># AWS SSM Session Manager
</span><span class='line'>Host i-*
</span><span class='line'>    ProxyCommand sh -c "aws --profile prod ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p'"</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -i ~/.ssh/infra.pem ec2-user@i-0ebba722b102179b6
</span><span class='line'>Warning: Permanently added 'i-0ebba722b102179b6' (ECDSA) to the list of known hosts.
</span><span class='line'>Last login: Wed Jan  6 13:04:03 2021
</span><span class='line'>
</span><span class='line'>       __|  __|_  )
</span><span class='line'>       _|  (     /   Amazon Linux 2 AMI
</span><span class='line'>      ___|\___|___|
</span><span class='line'>
</span><span class='line'>https://aws.amazon.com/amazon-linux-2/
</span><span class='line'>[ec2-user@ip-172-31-23-246 ~]$</span></code></pre></td></tr></table></div></figure>


<h2>Related:</h2>

<ul>
<li><a href="https://aws.amazon.com/blogs/mt/amazon-ec2-instance-port-forwarding-with-aws-systems-manager/">https://aws.amazon.com/blogs/mt/amazon-ec2-instance-port-forwarding-with-aws-systems-manager/</a></li>
<li><a href="https://aws.amazon.com/blogs/aws/new-port-forwarding-using-aws-system-manager-sessions-manager/">https://aws.amazon.com/blogs/aws/new-port-forwarding-using-aws-system-manager-sessions-manager/</a></li>
</ul>


<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/bypass-the-medium-paywall-system/">Bypass the Medium Paywall System</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:45:54-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:45 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Do you like reading stories on medium.com but not a big fan of the paywall system?</p>

<p><img src="https://user-images.githubusercontent.com/567298/108808924-6ab6f080-75b0-11eb-961f-25327551725f.png" alt="image" /></p>

<p>Copy the link, DM yourself on twitter and paste the link:</p>

<p><img src="https://user-images.githubusercontent.com/567298/108809014-9e921600-75b0-11eb-8c01-18da23d43793.png" alt="image" /></p>

<p>Click on the pasted link, and enjoy:</p>

<p><img src="https://user-images.githubusercontent.com/567298/108809056-b2d61300-75b0-11eb-8eeb-38f99118bb17.png" alt="image" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/generate-grafana-loki-log-links-from-metric-label-values/">Generate Grafana Loki Log Links From Metric Label Values</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:34:04-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:34 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will generate Loki Log links from selected dropdown template variables in a Grafana Dashboard.</p>

<h2>Context</h2>

<p>To give more context, we have a Grafana Dashboard with all our services, and when you select that service you see all the metrics of that service, now if you want to see the logs of that service, the selected label values will be parsed to a log link which you can click and it will take you to the Loki Explorer and parse the label values to the log link, so your logql will already be generated for you.</p>

<p>In order to achieve this, our metrics and logs need to share the same labels and label values (environment, container_name) etc.</p>

<h2>Dashboard Variables</h2>

<p>First we have our environment variable:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668240-a6862300-7b79-11eb-85ce-d381edfbe78e.png" alt="image" /></p>

<p>And here we have our service variable:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668438-dc2b0c00-7b79-11eb-9b17-629e9b1716a9.png" alt="image" /></p>

<p>Then for our container_name we have:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668632-05e43300-7b7a-11eb-97a0-8ff81f0c929c.png" alt="image" /></p>

<p>Notice the <code>/^(.*?)-[0-9]/</code> thats just to strip the end, if we remove it it will be:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668778-27451f00-7b7a-11eb-976f-a7d0b473cd1b.png" alt="image" /></p>

<h2>Grafana Dashboard</h2>

<p>Now when we select the environment, service, we get presented with a Loki LogURL:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668970-552a6380-7b7a-11eb-8c72-b284cf0f5eec.png" alt="image" /></p>

<p>If we look at our dashboard links, under the dashboard settings:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109669065-6b382400-7b7a-11eb-8a29-34b492fef327.png" alt="image" /></p>

<p>The Logs Uri is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://grafana.mydomain.com/explore?orgId=1&left=%5B%22now-1h%22,%22now%22,%22Loki%22,%7B%22expr%22:%22%7Bcontainer_name%3D~%5C%22.*$container_name.*%5C%22%7D%22%7D,%7B%22mode%22:%22Logs%22%7D,%7B%22ui%22:%5Btrue,true,true,%22none%22%5D%7D%5D</span></code></pre></td></tr></table></div></figure>


<p>Now when we select our label values from the dropdown for our service and we follow the link we will get:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109669297-a33f6700-7b7a-11eb-8205-f021467af751.png" alt="image" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/visualize-weather-data-with-grafana-and-the-dht22-sensor/">Visualize Weather Data With Grafana and the DHT22 Sensor</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:06:31-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:06 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial, we will connect the <a href="https://learn.adafruit.com/dht">DHT22</a> sensor to the Raspberry Pi Zero via the GPIO pins to measure temperature and humidity and visualize it with Grafana.</p>

<p><em>Note</em>: This post was originally posted on my <a href="https://blog.pistack.co.za/monitor-temperature-with-the-dht22-sensor-on-the-raspberry-pi/">RaspberryPi Blog</a></p>

<p>Then we will write a Python exporter for prometheus to expose our metrics so that we can visualize it in Grafana.</p>

<h2>The Endgoal</h2>

<p><img src="https://user-images.githubusercontent.com/30043398/104296987-fd9d3f00-54ca-11eb-8623-f3fd4a63e3cc.png" alt="image" /></p>

<h2>The Hardware</h2>

<p>This is how the sensor looks like (I got it from <a href="https://www.communica.co.za/products/bmt-temp-humd-snsr-dht22-on-pcb">Communica</a>)</p>

<p><img src="https://user-images.githubusercontent.com/567298/103872941-ba605c00-50d7-11eb-9f60-531995a185e6.png" alt="image" /></p>

<h2>Connecting the Sensor</h2>

<p>You can use the following graphic to connect your sensor to your raspberry pi:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103873892-27c0bc80-50d9-11eb-9c41-3f3b2ff5aee2.png" alt="image" /></p>

<h2>Installing Software</h2>

<p>To install the required software, we will be using pip:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip3 install Adafruit_DHT --user</span></code></pre></td></tr></table></div></figure>


<p>Once we installed the software we can configure it</p>

<h2>Interact with the Sensor</h2>

<p>Enter your python interpreter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python3
</span><span class='line'>&gt;&gt;&gt;</span></code></pre></td></tr></table></div></figure>


<p>Then import the library, and get the current temperature and humidity:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; import Adafruit_DHT as dht
</span><span class='line'>&gt;&gt;&gt; humidity, temperature = dht.read_retry(dht.DHT22, 4)
</span><span class='line'>&gt;&gt;&gt; humidity = format(humidity, ".2f") + "%"
</span><span class='line'>&gt;&gt;&gt; humidity
</span><span class='line'>'47.20%'
</span><span class='line'>&gt;&gt;&gt; temperature = format(temperature, ".2f") + "C"
</span><span class='line'>&gt;&gt;&gt; temperature
</span><span class='line'>'29.10C'</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s create a python script for it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat temps.py
</span><span class='line'>#!/usr/bin/env python3
</span><span class='line'>
</span><span class='line'>import Adafruit_DHT as dht_sensor
</span><span class='line'>import time
</span><span class='line'>
</span><span class='line'>def get_temperature_readings():
</span><span class='line'>    humidity, temperature = dht_sensor.read_retry(dht_sensor.DHT22, 4)
</span><span class='line'>    humidity = format(humidity, ".2f") + "%"
</span><span class='line'>    temperature = format(temperature, ".2f") + "C"
</span><span class='line'>    return {"temperature": temperature, "humidity": humidity}
</span><span class='line'>
</span><span class='line'>while True:
</span><span class='line'>    print(get_temperature_readings())
</span><span class='line'>    time.sleep(30)</span></code></pre></td></tr></table></div></figure>


<p>And run it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python3 temps.py
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.40%'}
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.30%'}
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.70%'}
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.40%'}
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.60%'}</span></code></pre></td></tr></table></div></figure>


<h2>Visualize with Grafana</h2>

<p>Let&rsquo;s visualize our data with Grafana. For this, we need to write an exporter so that Prometheus can scrape the data.</p>

<p>Let&rsquo;s create a python flask application with the prometheus client library for python to expose the metrics to prometheus with a <code>/metrics</code> endpoint.</p>

<p>Note: I have used <a href="https://openweathermap.org/api">OpenWeatherMap</a>&rsquo;s API to get the outside temperature for my location.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat flask_temps.py
</span><span class='line'>#!/usr/bin/env python3
</span><span class='line'>
</span><span class='line'>import Adafruit_DHT as dht_sensor
</span><span class='line'>import time
</span><span class='line'>from flask import Flask, Response
</span><span class='line'>from prometheus_client import Counter, Gauge, start_http_server, generate_latest
</span><span class='line'>import requests
</span><span class='line'>
</span><span class='line'>params = {"lat": "-xx.xxxxx", "lon": "xx.xxxx", "units": "metric", "appid": "your-api-key"}
</span><span class='line'>baseurl = "https://api.openweathermap.org/data/2.5/weather"
</span><span class='line'>content_type = str('text/plain; version=0.0.4; charset=utf-8')
</span><span class='line'>
</span><span class='line'>def get_temperature_readings():
</span><span class='line'>    humidity, temperature = dht_sensor.read_retry(dht_sensor.DHT22, 4)
</span><span class='line'>    humidity = format(humidity, ".2f")
</span><span class='line'>    temperature = format(temperature, ".2f")
</span><span class='line'>    outside_temp = get_outside_weather()
</span><span class='line'>    if all(v is not None for v in [humidity, temperature, outside_temp]):
</span><span class='line'>        response = {"temperature": temperature, "humidity": humidity, "outside_temp": outside_temp}
</span><span class='line'>        return response
</span><span class='line'>    else:
</span><span class='line'>        time.sleep(0.2)
</span><span class='line'>        humidity, temperature = dht_sensor.read_retry(dht_sensor.DHT22, 4)
</span><span class='line'>        humidity = format(humidity, ".2f")
</span><span class='line'>        temperature = format(temperature, ".2f")
</span><span class='line'>        outside_temp = get_outside_weather()
</span><span class='line'>        response = {"temperature": temperature, "humidity": humidity, "outside_temp": outside_temp}
</span><span class='line'>        return response
</span><span class='line'>
</span><span class='line'>def get_outside_weather():
</span><span class='line'>    response = requests.get(baseurl, params=params)
</span><span class='line'>    temp = response.json()['main']['temp']
</span><span class='line'>    return temp
</span><span class='line'>
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>
</span><span class='line'>current_humidity = Gauge(
</span><span class='line'>        'current_humidity',
</span><span class='line'>        'the current humidity percentage, this is a gauge as the value can increase or decrease',
</span><span class='line'>        ['room']
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>current_temperature = Gauge(
</span><span class='line'>        'current_temperature',
</span><span class='line'>        'the current temperature in celsius, this is a gauge as the value can increase or decrease',
</span><span class='line'>        ['room']
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>current_temperature_outside = Gauge(
</span><span class='line'>        'current_temperature_outside',
</span><span class='line'>        'the current outside temperature in celsius, this is a gauge as the value can increase or decrease',
</span><span class='line'>        ['location']
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>@app.route('/metrics')
</span><span class='line'>def metrics():
</span><span class='line'>    metrics = get_temperature_readings()
</span><span class='line'>    current_humidity.labels('study').set(metrics['humidity'])
</span><span class='line'>    current_temperature.labels('study').set(metrics['temperature'])
</span><span class='line'>    current_temperature_outside.labels('za_ct').set(metrics['outside_temp'])
</span><span class='line'>    return Response(generate_latest(), mimetype=content_type)
</span><span class='line'>
</span><span class='line'>if __name__ == '__main__':
</span><span class='line'>    app.run(host='0.0.0.0', port=5000)</span></code></pre></td></tr></table></div></figure>


<p>Then install the flask and prometheus_client package:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python3 -m pip install flask prometheus_client --user</span></code></pre></td></tr></table></div></figure>


<p>When you run the program, you should be able to retrieve metrics from the exporter by making a request on port 5000 on the <code>/metrics</code> request path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://localhost:5000/metrics
</span><span class='line'># HELP python_gc_objects_collected_total Objects collected during gc
</span><span class='line'># TYPE python_gc_objects_collected_total counter
</span><span class='line'>python_gc_objects_collected_total{generation="0"} 646.0
</span><span class='line'>python_gc_objects_collected_total{generation="1"} 129.0
</span><span class='line'>python_gc_objects_collected_total{generation="2"} 0.0
</span><span class='line'># HELP python_gc_objects_uncollectable_total Uncollectable object found during GC
</span><span class='line'># TYPE python_gc_objects_uncollectable_total counter
</span><span class='line'>python_gc_objects_uncollectable_total{generation="0"} 0.0
</span><span class='line'>python_gc_objects_uncollectable_total{generation="1"} 0.0
</span><span class='line'>python_gc_objects_uncollectable_total{generation="2"} 0.0
</span><span class='line'># HELP python_gc_collections_total Number of times this generation was collected
</span><span class='line'># TYPE python_gc_collections_total counter
</span><span class='line'>python_gc_collections_total{generation="0"} 104.0
</span><span class='line'>python_gc_collections_total{generation="1"} 9.0
</span><span class='line'>python_gc_collections_total{generation="2"} 0.0
</span><span class='line'># HELP python_info Python platform information
</span><span class='line'># TYPE python_info gauge
</span><span class='line'>python_info{implementation="CPython",major="3",minor="7",patchlevel="3",version="3.7.3"} 1.0
</span><span class='line'># HELP process_virtual_memory_bytes Virtual memory size in bytes.
</span><span class='line'># TYPE process_virtual_memory_bytes gauge
</span><span class='line'>process_virtual_memory_bytes 4.4761088e+07
</span><span class='line'># HELP process_resident_memory_bytes Resident memory size in bytes.
</span><span class='line'># TYPE process_resident_memory_bytes gauge
</span><span class='line'>process_resident_memory_bytes 2.7267072e+07
</span><span class='line'># HELP process_start_time_seconds Start time of the process since unix epoch in seconds.
</span><span class='line'># TYPE process_start_time_seconds gauge
</span><span class='line'>process_start_time_seconds 1.61044381853e+09
</span><span class='line'># HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.
</span><span class='line'># TYPE process_cpu_seconds_total counter
</span><span class='line'>process_cpu_seconds_total 5.86
</span><span class='line'># HELP process_open_fds Number of open file descriptors.
</span><span class='line'># TYPE process_open_fds gauge
</span><span class='line'>process_open_fds 6.0
</span><span class='line'># HELP process_max_fds Maximum number of open file descriptors.
</span><span class='line'># TYPE process_max_fds gauge
</span><span class='line'>process_max_fds 1024.0
</span><span class='line'># HELP current_humidity the current humidity percentage, this is a gauge as the value can increase or decrease
</span><span class='line'># TYPE current_humidity gauge
</span><span class='line'>current_humidity{room="study"} 47.0
</span><span class='line'># HELP current_temperature the current temperature in celsius, this is a gauge as the value can increase or decrease
</span><span class='line'># TYPE current_temperature gauge
</span><span class='line'>current_temperature{room="study"} 25.7
</span><span class='line'># HELP current_temperature_outside the current outside temperature in celsius, this is a gauge as the value can increase or decrease
</span><span class='line'># TYPE current_temperature_outside gauge
</span><span class='line'>current_temperature_outside{location="za_ct"} 27.97</span></code></pre></td></tr></table></div></figure>


<p>Now to configure our prometheus scrape config to scrape our endpoint:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/prometheus/prometheus.yml
</span><span class='line'>...
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'temperature-exporter'
</span><span class='line'>    scrape_interval: 15s
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['192.168.0.5:5000']
</span><span class='line'>      labels:
</span><span class='line'>        instance: 'pi-zero'
</span><span class='line'>        room: 'study'</span></code></pre></td></tr></table></div></figure>


<p>Then restart prometheus and head over to Grafana.</p>

<p>We will be adding a new panel with a graph visualization, and from our prometheus datasource, we will be referencing the 2 metrics (different from the screenshot):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>current_humidity{room="study"} 47.0
</span><span class='line'>current_temperature{room="study"} 25.7
</span><span class='line'>current_temperature_outside{location="za_ct"} 27.97</span></code></pre></td></tr></table></div></figure>


<p>As can be seen below:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103987136-a169b080-5194-11eb-8a61-6d36f45caf5c.png" alt="image" /></p>

<p>After a bit of customization, you can get something more or less like this:</p>

<p><img src="https://user-images.githubusercontent.com/30043398/104296987-fd9d3f00-54ca-11eb-8623-f3fd4a63e3cc.png" alt="image" /></p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content feel free to visit my website <strong><a href="https://ruan.dev">ruan.dev</a></strong> or follow me on Twitter <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/09/cicd-with-droneci-and-gitea-using-docker-compose/">CICD With DroneCI and Gitea Using Docker Compose</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-09T01:10:10-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>1:10 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we wil set up a drone-ci and gitea stack using docker-compose and then running a test pipeline.</p>

<p>I have posted a few times about this topic, but this post will be used when I create other examples and wanting to use this post for the ones not having the stack booted yet.</p>

<h2>The Source Code</h2>

<p>All the code will be in my <a href="https://github.com/ruanbekker/drone-gitea-on-docker">github repository</a>.</p>

<p>For our <code>docker-compose.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: '3.6'
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  gitea:
</span><span class='line'>    container_name: gitea
</span><span class='line'>    image: gitea/gitea:${GITEA_VERSION:-1.10.6}
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    environment:
</span><span class='line'>      # https://docs.gitea.io/en-us/install-with-docker/#environments-variables
</span><span class='line'>      - APP_NAME="Gitea"
</span><span class='line'>      - USER_UID=1000
</span><span class='line'>      - USER_GID=1000
</span><span class='line'>      - RUN_MODE=prod
</span><span class='line'>      - DOMAIN=${IP_ADDRESS}
</span><span class='line'>      - SSH_DOMAIN=${IP_ADDRESS}
</span><span class='line'>      - HTTP_PORT=3000
</span><span class='line'>      - ROOT_URL=http://${IP_ADDRESS}:3000
</span><span class='line'>      - SSH_PORT=222
</span><span class='line'>      - SSH_LISTEN_PORT=22
</span><span class='line'>      - DB_TYPE=sqlite3
</span><span class='line'>    ports:
</span><span class='line'>      - "3000:3000"
</span><span class='line'>      - "222:22"
</span><span class='line'>    networks:
</span><span class='line'>      - cicd_net
</span><span class='line'>    volumes:
</span><span class='line'>      - ./gitea:/data
</span><span class='line'>
</span><span class='line'>  drone:
</span><span class='line'>    container_name: drone
</span><span class='line'>    image: drone/drone:${DRONE_VERSION:-1.6.4}
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    depends_on:
</span><span class='line'>      - gitea
</span><span class='line'>    environment:
</span><span class='line'>      # https://docs.drone.io/server/provider/gitea/
</span><span class='line'>      - DRONE_DATABASE_DRIVER=sqlite3
</span><span class='line'>      - DRONE_DATABASE_DATASOURCE=/data/database.sqlite
</span><span class='line'>      - DRONE_GITEA_SERVER=http://${IP_ADDRESS}:3000/
</span><span class='line'>      - DRONE_GIT_ALWAYS_AUTH=false
</span><span class='line'>      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
</span><span class='line'>      - DRONE_SERVER_PROTO=http
</span><span class='line'>      - DRONE_SERVER_HOST=${IP_ADDRESS}:3001
</span><span class='line'>      - DRONE_TLS_AUTOCERT=false
</span><span class='line'>      - DRONE_USER_CREATE=${DRONE_USER_CREATE}
</span><span class='line'>      - DRONE_GITEA_CLIENT_ID=${DRONE_GITEA_CLIENT_ID}
</span><span class='line'>      - DRONE_GITEA_CLIENT_SECRET=${DRONE_GITEA_CLIENT_SECRET}
</span><span class='line'>    ports:
</span><span class='line'>      - "3001:80"
</span><span class='line'>      - "9001:9000"
</span><span class='line'>    networks:
</span><span class='line'>      - cicd_net
</span><span class='line'>    volumes:
</span><span class='line'>      - /var/run/docker.sock:/var/run/docker.sock
</span><span class='line'>      - ./drone:/data
</span><span class='line'>
</span><span class='line'>  drone-runner:
</span><span class='line'>    container_name: drone-runner
</span><span class='line'>    image: drone/drone-runner-docker:${DRONE_RUNNER_VERSION:-1}
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    depends_on:
</span><span class='line'>      - drone
</span><span class='line'>    environment:
</span><span class='line'>      # https://docs.drone.io/runner/docker/installation/linux/
</span><span class='line'>      # https://docs.drone.io/server/metrics/
</span><span class='line'>      - DRONE_RPC_PROTO=http
</span><span class='line'>      - DRONE_RPC_HOST=drone
</span><span class='line'>      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
</span><span class='line'>      - DRONE_RUNNER_NAME="${HOSTNAME}-runner"
</span><span class='line'>      - DRONE_RUNNER_CAPACITY=2
</span><span class='line'>      - DRONE_RUNNER_NETWORKS=cicd_net
</span><span class='line'>      - DRONE_DEBUG=false
</span><span class='line'>      - DRONE_TRACE=false
</span><span class='line'>    ports:
</span><span class='line'>      - "3002:3000"
</span><span class='line'>    networks:
</span><span class='line'>      - cicd_net
</span><span class='line'>    volumes:
</span><span class='line'>      - /var/run/docker.sock:/var/run/docker.sock
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  cicd_net:
</span><span class='line'>    name: cicd_net</span></code></pre></td></tr></table></div></figure>


<p>Our <code>boot.sh</code> which we will use to override environment variables:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env bash
</span><span class='line'>
</span><span class='line'>export HOSTNAME=$(hostname)
</span><span class='line'>export DRONE_VERSION=1.10.1
</span><span class='line'>export DRONE_RUNNER_VERSION=1.6.3
</span><span class='line'>export GITEA_VERSION=1.13
</span><span class='line'>export IP_ADDRESS=192.168.0.6
</span><span class='line'>export MINIO_ACCESS_KEY="EXAMPLEKEY"
</span><span class='line'>export MINIO_SECRET_KEY="EXAMPLESECRET"
</span><span class='line'>export GITEA_ADMIN_USER="example"
</span><span class='line'>export DRONE_RPC_SECRET="$(echo ${HOSTNAME} | openssl dgst -md5 -hex)"
</span><span class='line'>export DRONE_USER_CREATE="username:${GITEA_ADMIN_USER},machine:false,admin:true,token:${DRONE_RPC_SECRET}"
</span><span class='line'>export DRONE_GITEA_CLIENT_ID=""
</span><span class='line'>export DRONE_GITEA_CLIENT_SECRET=""
</span><span class='line'>docker-compose up -d
</span><span class='line'>
</span><span class='line'>echo ""
</span><span class='line'>echo "Gitea: http://${IP_ADDRESS}:3000/"
</span><span class='line'>echo "Drone: http://${IP_ADDRESS}:3001/"</span></code></pre></td></tr></table></div></figure>


<h2>Deploy the Stack</h2>

<p>Set the following in your <code>boot.sh</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>IP_ADDRESS=192.168.0.6       -&gt; either reachable dns or ip address which will be your clone address and ui addresses.
</span><span class='line'>GITEA_ADMIN_USER="giteauser" -&gt; will be the user you register with in drone</span></code></pre></td></tr></table></div></figure>


<p>Now boot the stack:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bash boot.sh</span></code></pre></td></tr></table></div></figure>


<p><em>Note</em>: Theres a <a href="https://github.com/go-gitea/gitea/issues/7702">current issue</a> where webhooks get fired twice, if you see that just restart gitea with <code>docker restart gitea</code>.</p>

<ul>
<li><p>Head over to: <code>http://${IP_ADDRESS}:3000/user/settings/applications</code> and create a new OAuth2 Application and set the Redirect URI to <code>http://${IP_ADDRESS}:3001/login</code></p></li>
<li><p>Capture the client id and client secret and populate them in the <code>boot.sh</code> in <code>DRONE_GITEA_CLIENT_ID</code> and <code>DRONE_GITEA_CLIENT_SECRET</code> and run <code>bash boot.sh</code> again. This will give drone the correct credentials in order to authenticate with gitea.</p></li>
<li><p>Now when you head over to <code>http://${IP_ADDRESS}:3001/</code> you will be asked to authorize the application and you should be able to access drone.</p></li>
</ul>


<h2>Drone CLI</h2>

<p>Install Drone CLI:
- <a href="https://docs.drone.io/cli/install/">https://docs.drone.io/cli/install/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -L https://github.com/drone/drone-cli/releases/latest/download/drone_darwin_amd64.tar.gz | tar zx
</span><span class='line'>$ sudo mv drone /usr/local/bin/drone
</span><span class='line'>$ chmod +x /usr/local/bin/drone</span></code></pre></td></tr></table></div></figure>


<p>Get your Drone Token:
- <a href="http://$">http://$</a>{IP_ADDRESS}:3001/account</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export DRONE_SERVER=http://${IP_ADDRESS}:3001
</span><span class='line'>$ export DRONE_TOKEN=one-from-the-account-page
</span><span class='line'>drone info</span></code></pre></td></tr></table></div></figure>


<h2>Build your first pipeline</h2>

<p>Create a test repo in gitea:</p>

<p><img src="https://user-images.githubusercontent.com/567298/110296470-0ad23800-7ffb-11eb-8428-af49d0ebd62d.png" alt="image" /></p>

<p>Commit a <code>.drone.yml</code> file for drone:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kind: pipeline
</span><span class='line'>type: docker
</span><span class='line'>name: hello-world
</span><span class='line'>
</span><span class='line'>trigger:
</span><span class='line'>  branch:
</span><span class='line'>    - master
</span><span class='line'>  event:
</span><span class='line'>    - push
</span><span class='line'>
</span><span class='line'>steps:
</span><span class='line'>  - name: say-hello
</span><span class='line'>    image: busybox
</span><span class='line'>    commands:
</span><span class='line'>      - echo hello-world</span></code></pre></td></tr></table></div></figure>


<p>Head over to drone and sync your repositories:</p>

<p><img src="https://user-images.githubusercontent.com/567298/110296425-00b03980-7ffb-11eb-9216-76725a62c09e.png" alt="image" /></p>

<p>Activate your repository:</p>

<p><img src="https://user-images.githubusercontent.com/567298/110296623-3523f580-7ffb-11eb-805f-db5db4dab0cb.png" alt="image" /></p>

<p>Push a commit to master and see your pipeline running:</p>

<p><img src="https://user-images.githubusercontent.com/567298/110296747-584ea500-7ffb-11eb-9909-259641a663aa.png" alt="image" /></p>

<h2>More Examples</h2>

<p>For more examples view my example section on the github repository:
- <a href="https://github.com/ruanbekker/drone-gitea-on-docker#more-examples">https://github.com/ruanbekker/drone-gitea-on-docker#more-examples</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/02/26/ship-your-docker-logs-to-loki-using-fluentbit/">Ship Your Docker Logs to Loki Using Fluentbit</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-02-26T15:26:34-05:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>3:26 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial, I will show you how to ship your docker containers logs to <a href="https://grafana.com/oss/loki/">Grafana Loki</a> via <a href="https://fluentbit.io/">Fluent Bit</a>.</p>

<h2>Grafana and Loki</h2>

<p>First we need to get Grafana and Loki up and running and we will be using docker and docker-compose to do that.</p>

<p>Our <code>docker-compose-loki.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: "3.7"
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  grafana:
</span><span class='line'>    image: grafana/grafana:7.4.2
</span><span class='line'>    container_name: 'grafana'
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    volumes:
</span><span class='line'>      - ./data/grafana/data:/var/lib/grafana
</span><span class='line'>      - ./configs/grafana/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml
</span><span class='line'>    networks:
</span><span class='line'>      - public
</span><span class='line'>    ports:
</span><span class='line'>      - 3000:3000
</span><span class='line'>    depends_on:
</span><span class='line'>      - loki
</span><span class='line'>    logging:
</span><span class='line'>      driver: "json-file"
</span><span class='line'>      options:
</span><span class='line'>        max-size: "1m"  
</span><span class='line'>  
</span><span class='line'>  loki:
</span><span class='line'>    image: grafana/loki:2.1.0
</span><span class='line'>    container_name: loki
</span><span class='line'>    command: -config.file=/mnt/loki-local-config.yaml
</span><span class='line'>    user: root
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    volumes:
</span><span class='line'>      - ./data/loki/data:/tmp/loki
</span><span class='line'>      - ./configs/loki/loki.yml:/mnt/loki-local-config.yaml
</span><span class='line'>    ports:
</span><span class='line'>      - 3100:3100
</span><span class='line'>    networks:
</span><span class='line'>      - public
</span><span class='line'>    logging:
</span><span class='line'>      driver: "json-file"
</span><span class='line'>      options:
</span><span class='line'>        max-size: "1m"
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  public:
</span><span class='line'>    name: public</span></code></pre></td></tr></table></div></figure>


<p>We are referencing 2 config files, first our loki datasource defined by <code>./configs/grafana/datasource.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apiVersion: 1
</span><span class='line'>
</span><span class='line'>datasources:
</span><span class='line'>- name: loki
</span><span class='line'>  type: loki
</span><span class='line'>  access: proxy
</span><span class='line'>  orgId: 1
</span><span class='line'>  url: http://loki:3100
</span><span class='line'>  basicAuth: false
</span><span class='line'>  isDefault: true
</span><span class='line'>  version: 1
</span><span class='line'>  editable: true</span></code></pre></td></tr></table></div></figure>


<p>And our second config is our loki config <code>./configs/loki/loki.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auth_enabled: false
</span><span class='line'>
</span><span class='line'>server:
</span><span class='line'>  http_listen_port: 3100
</span><span class='line'>
</span><span class='line'>ingester:
</span><span class='line'>  lifecycler:
</span><span class='line'>    address: 127.0.0.1
</span><span class='line'>    ring:
</span><span class='line'>      kvstore:
</span><span class='line'>        store: inmemory
</span><span class='line'>      replication_factor: 1
</span><span class='line'>    final_sleep: 0s
</span><span class='line'>  chunk_idle_period: 5m
</span><span class='line'>  chunk_retain_period: 30s
</span><span class='line'>  max_transfer_retries: 0
</span><span class='line'>
</span><span class='line'>schema_config:
</span><span class='line'>  configs:
</span><span class='line'>    - from: 2018-04-15
</span><span class='line'>      store: boltdb
</span><span class='line'>      object_store: filesystem
</span><span class='line'>      schema: v11
</span><span class='line'>      index:
</span><span class='line'>        prefix: index_
</span><span class='line'>        period: 168h
</span><span class='line'>
</span><span class='line'>storage_config:
</span><span class='line'>  boltdb:
</span><span class='line'>    directory: /tmp/loki/index
</span><span class='line'>
</span><span class='line'>  filesystem:
</span><span class='line'>    directory: /tmp/loki/chunks
</span><span class='line'>
</span><span class='line'>limits_config:
</span><span class='line'>  enforce_metric_name: false
</span><span class='line'>  reject_old_samples: true
</span><span class='line'>  reject_old_samples_max_age: 168h
</span><span class='line'>
</span><span class='line'>chunk_store_config:
</span><span class='line'>  max_look_back_period: 0s
</span><span class='line'>
</span><span class='line'>table_manager:
</span><span class='line'>  retention_deletes_enabled: false
</span><span class='line'>  retention_period: 0s</span></code></pre></td></tr></table></div></figure>


<p>Once you have everything in place, boot the grafana and loki containers:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose -f docker-compose-loki.yml up -d</span></code></pre></td></tr></table></div></figure>


<h2>Fluent Bit</h2>

<p>Next we need to boot our log processor and forwarder, fluent bit. In our <code>docker-compose-fluentbit.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: "3.7"
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  fluent-bit:
</span><span class='line'>    image: grafana/fluent-bit-plugin-loki:latest
</span><span class='line'>    container_name: fluent-bit
</span><span class='line'>    environment:
</span><span class='line'>      - LOKI_URL=http://loki:3100/loki/api/v1/push
</span><span class='line'>    volumes:
</span><span class='line'>      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
</span><span class='line'>    ports:
</span><span class='line'>      - "24224:24224"
</span><span class='line'>      - "24224:24224/udp"
</span><span class='line'>    networks:
</span><span class='line'>      - public
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  public:
</span><span class='line'>    name: public</span></code></pre></td></tr></table></div></figure>


<p>And as you can see we are referencing a config <code>./configs/fluentbit/fluent-bit.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[INPUT]
</span><span class='line'>    Name        forward
</span><span class='line'>    Listen      0.0.0.0
</span><span class='line'>    Port        24224
</span><span class='line'>[Output]
</span><span class='line'>    Name grafana-loki
</span><span class='line'>    Match *
</span><span class='line'>    Url ${LOKI_URL}
</span><span class='line'>    RemoveKeys source,container_id
</span><span class='line'>    Labels {job="fluent-bit"}
</span><span class='line'>    LabelKeys container_name
</span><span class='line'>    BatchWait 1s
</span><span class='line'>    BatchSize 1001024
</span><span class='line'>    LineFormat json
</span><span class='line'>    LogLevel info</span></code></pre></td></tr></table></div></figure>


<p>Once you have your configs in place, boot fluent-bit:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose -f docker-compose-fluentbit.yml up -d</span></code></pre></td></tr></table></div></figure>


<h2>Nginx App</h2>

<p>Now to configure our docker container to ship its logs to fluent-bit, which will forward the logs to Loki.</p>

<p>In our <code>docker-compose-app.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: "3"
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  nginx-json:
</span><span class='line'>    image: ruanbekker/nginx-demo:json
</span><span class='line'>    container_name: nginx-app
</span><span class='line'>    ports:
</span><span class='line'>      - 8080:80
</span><span class='line'>    logging:
</span><span class='line'>      driver: fluentd
</span><span class='line'>      options:
</span><span class='line'>        fluentd-address: 127.0.0.1:24224</span></code></pre></td></tr></table></div></figure>


<p>The fluent-bit container listens on port 24224 locally on our docker host and is not reachable via its container network, so let&rsquo;s boot our application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose -f docker-compose-app.yml up -d</span></code></pre></td></tr></table></div></figure>


<p>Once our application is up, let&rsquo;s make a request to our nginx-app:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://localhost:8080/
</span><span class='line'>ok</span></code></pre></td></tr></table></div></figure>


<p>Now head over to Grafana at <a href="http://localhost:3000/explore">http://localhost:3000/explore</a> and query: <code>{job="fluent-bit", container_name="/nginx-app"}</code> and you should see something like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109366000-03908900-789b-11eb-952e-36ff23657517.png" alt="image" /></p>

<p>Beautiful right? I know.</p>

<h2>Github Repo</h2>

<p>The source code for this can be found on:</p>

<ul>
<li><a href="https://github.com/ruanbekker/docker-logging-loki-fuentbit">https://github.com/ruanbekker/docker-logging-loki-fuentbit</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/01/31/installing-arduino-and-setup-the-nodemcu-esp32/">Installing Arduino and Setup the NodeMCU ESP32</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-01-31T11:33:31-05:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2021</span></span> <span class='time'>11:33 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A couple of weeks ago I got myself the <a href="">NodeMCU ESP32 Development Board</a>:</p>

<p><img src="https://user-images.githubusercontent.com/567298/106391027-f5626080-63f3-11eb-9dca-5efce53fbf80.png" alt="image" /></p>

<p>If you want to view more in-depth specs about the board you can have a look at the <a href="https://www.espressif.com/sites/default/files/documentation/esp32_datasheet_en.pdf">ESP32 Datasheet</a>, but in short it has:</p>

<ul>
<li>ESP32-D0WDQ6 Processor</li>
<li>WiFi with frequency range of 2.4G ~ 2.5G (2400M ~ 2483.5M)</li>
<li>Bluetooth 4.2</li>
<li>32Mbit built in Flash</li>
<li>2x19pin extension headers, breakout all the I/O pins of the module</li>
<li>2x keys, used as reset or user-defined</li>
</ul>


<h2>About this Tutorial</h2>

<p>In this tutorial we will download and install Arduino and how to setup our ESP32 Board, then just running a basic hello world application</p>

<h2>Installing Arduino</h2>

<p>Head over to <a href="https://www.arduino.cc/en/software">arduino.cc/en/software</a> and download arduino for your operating system.</p>

<p>Once installed you can reference <a href="https://github.com/espressif/arduino-esp32">arduino-esp32</a> for your operating system, but in general you will open the Arduino application, select Preferences and provide the following link on the &ldquo;Additional Boards Manager URL&rdquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json</span></code></pre></td></tr></table></div></figure>


<p>Hit OK, then select Tools, Board, Board Manager, then search for &ldquo;esp32&rdquo;, then install esp32 by Espressif Systems:</p>

<p><img width="800" alt="image" src="https://user-images.githubusercontent.com/567298/106391354-8c7be800-63f5-11eb-852d-d472fe3624e9.png"></p>

<p>Then make sure to select the board by navigating to Tools, Board, ESP32 Arduino, ESP32 Dev Module:</p>

<p><img width="1110" alt="image" src="https://user-images.githubusercontent.com/567298/106391458-06ac6c80-63f6-11eb-8a0b-eed0ae7e786b.png"></p>

<p>Select the upload rate from Tools, Upload Rate to 115200 and select the serial port, from mine it is Tools, Port, usb-serial-0001 (your&rsquo;s might differ)</p>

<h2>Hello World Application</h2>

<p>Now that we have Arduino installed and our board configured, let&rsquo;s write a hello world application, from the input text section:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void setup() {
</span><span class='line'>  Serial.begin(115200);
</span><span class='line'>  Serial.println("Setup done");
</span><span class='line'>  delay(5000);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>void loop() {
</span><span class='line'>  Serial.println("Hello, World");
</span><span class='line'>  delay(1000);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>From the setup function we set the baud rate and print a line then sleep for 5 seconds, once that is done we call the loop function which will print &ldquo;Hello, World&rdquo; and sleep for 1 second, and that will loop indefinitely.</p>

<p>Once you are done, save your sketch and upload it to the board by either selecting the upload button or from Sketch, Upload.</p>

<p>When the code has been compiled the device will reset and you can open the serial monitor, by selecting Tools, Serial Monitor:</p>

<p><img width="936" alt="image" src="https://user-images.githubusercontent.com/567298/106391690-47f14c00-63f7-11eb-85bf-227f1ac5f92a.png"></p>

<h2>Thank You</h2>

<p>Thank you for reading.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/12/23/reduce-docker-log-size-on-disk/">Reduce Docker Log Size on Disk</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-12-23T04:11:35-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2020</span></span> <span class='time'>4:11 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In cases where you are using the defaults for logging and your application logs a lot you can consume a lot of disk space and you can run out of disk space quite quickly.</p>

<p>If it&rsquo;s a case where you already ran out of disk space, we can investigate the disk space consumed by docker logs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /var/lib/docker/containers
</span><span class='line'>$ du -sh *
</span><span class='line'>6.0G  14052251a0f13f46f65bc73d10c01408130ee8ae71529600ba5bd6bee76af4ee
</span><span class='line'>1.2G  e6b40b1d30c5cf05e8cb201ca9abf6bd283d7cf7ceaa3be2a0422be7cd750a33</span></code></pre></td></tr></table></div></figure>


<p>Referenced from <a href="https://blog.birkhoff.me/devops-truncate-docker-container-logs-periodically-to-free-up-server-disk-space/">https://blog.birkhoff.me/devops-truncate-docker-container-logs-periodically-to-free-up-server-disk-space/</a> you can truncate those files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sh -c 'truncate -s 0 /var/lib/docker/containers/*/*-json.log'</span></code></pre></td></tr></table></div></figure>


<p>Check the size again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ du -sh *
</span><span class='line'>40K   14052251a0f13f46f65bc73d10c01408130ee8ae71529600ba5bd6bee76af4ee
</span><span class='line'>36K   e6b40b1d30c5cf05e8cb201ca9abf6bd283d7cf7ceaa3be2a0422be7cd750a33</span></code></pre></td></tr></table></div></figure>


<p>To overcome this issue you can use this in logging options in your compose:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>    logging:
</span><span class='line'>      driver: "json-file"
</span><span class='line'>      options:
</span><span class='line'>        max-size: "1m"
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2021/04/06/install-concourse-ci-v6-on-ubuntu-20-dot-04/">Install Concourse CI V6 on Ubuntu 20.04</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/wireguard-vpn-with-unbound-ads-blocking-dns/">Wireguard VPN With Unbound ADS Blocking DNS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/ssh-using-aws-ssm-session-manager/">SSH Using AWS SSM Session Manager</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/bypass-the-medium-paywall-system/">Bypass the Medium Paywall System</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/generate-grafana-loki-log-links-from-metric-label-values/">Generate Grafana Loki Log Links From Metric Label Values</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest cheatsheets in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com"><img src="https://user-images.githubusercontent.com/567298/97010485-c2334a00-1545-11eb-9e1d-2333e5148da1.png" width="290" height="900"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
