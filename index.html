
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In this tutorial I will demonstrate how to keep your docker container images nice and slim with the use of multistage builds for a hugo &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script async defer data-website-id="2cfa7c36-c1f7-48fd-949c-2e5e8a1d873d" src="https://umami-analytics.ruan.dev/umami.js"></script>

  <!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1100086574264181"
     crossorigin="anonymous"></script>

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/07/31/docker-multistage-builds-for-hugo/">Docker Multistage Builds for Hugo</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-07-31T02:23:51-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2022</span></span> <span class='time'>2:23 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/182013196-aff6e76f-2cf3-4ec2-bfcc-3e977915a6aa.png" alt="blog-ruanbekker-multistage-builds" /></p>

<p>In this tutorial I will demonstrate how to keep your docker <strong>container images</strong> nice and <strong>slim</strong> with the use of <strong>multistage builds</strong> for a <strong>hugo</strong> documentation project.</p>

<p>Hugo is a static content generator so essentially that means that it will <strong>generate your markdown files into html</strong>. Therefore we don&rsquo;t need to include all the content from our project repository as we only need the static content (html, css, javascript) to reside on our <strong>final container image</strong>.</p>

<h2>What are we doing today</h2>

<p>We will use the <strong><a href="https://github.com/h-enk/doks">DOKS</a></strong> Modern Documentation theme for <strong><a href="https://gohugo.io/">Hugo</a></strong> as our project example, where we will build and run our documentation website on a docker container, but more importantly make use of multistage builds to <strong>optimize the size</strong> of our <strong>container image</strong>.</p>

<h2>Our Build Strategy</h2>

<p>Since hugo is a static content generator, we will use a <strong><a href="https://hub.docker.com/_/node">node</a></strong> container image as our base. We will then build and generate the content using <code>npm run build</code> which will generate the static content to <code>/src/public</code> in our build stage.</p>

<p>Since we then have static content, we can utilize a second stage using a <strong><a href="https://hub.docker.com/_/nginx">nginx</a></strong> container image with the purpose of a <strong>web server</strong> to host our <strong>static content</strong>. We will copy the static content from our <code>build</code> stage into our second stage and place it under our defined path in our nginx config.</p>

<p>This way we only include the required content on our final container image.</p>

<h2>Building our Container Image</h2>

<p>First clone the <a href="https://github.com/h-enk/doks">docs github repository</a> and change to the directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone https://github.com/h-enk/doks
</span><span class='line'><span class="nb">cd </span>doks
</span></code></pre></td></tr></table></div></figure>


<p>Now create a <code>Dockerfile</code> in the root path with the following content:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='dockerfile'><span class='line'><span class="k">FROM</span> node:16.15.1 as build
</span><span class='line'><span class="k">WORKDIR</span> /src
</span><span class='line'><span class="k">ADD</span> . .
</span><span class='line'><span class="k">RUN</span> npm install
</span><span class='line'><span class="k">RUN</span> npm run build
</span><span class='line'>
</span><span class='line'><span class="k">FROM</span>  nginx:alpine
</span><span class='line'>LABEL demonstration.by Ruan Bekker &lt;@ruanbekker&gt;
</span><span class='line'>COPY  nginx/config/nginx.conf /etc/nginx/nginx.conf
</span><span class='line'>COPY  nginx/config/app.conf /etc/nginx/conf.d/app.conf
</span><span class='line'>COPY  --from<span class="o">=</span>build /src/public /usr/share/nginx/app
</span></code></pre></td></tr></table></div></figure>


<p>As we can see we are copying two nginx config files to our final image, which we will need to create.</p>

<p>Create the nginx config directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p nginx/config
</span></code></pre></td></tr></table></div></figure>


<p>The content for our main nginx config <code>nginx/config/nginx.conf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>user  nginx<span class="p">;</span>
</span><span class='line'>worker_processes  auto<span class="p">;</span>
</span><span class='line'>error_log  /var/log/nginx/error.log notice<span class="p">;</span>
</span><span class='line'>pid        /var/run/nginx.pid<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>    worker_connections  1024<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>    include       /etc/nginx/mime.types<span class="p">;</span>
</span><span class='line'>    default_type  application/octet-stream<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    log_format  main  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    access_log  /var/log/nginx/access.log  main<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    sendfile        on<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># timeouts</span>
</span><span class='line'>    client_body_timeout 12<span class="p">;</span>
</span><span class='line'>    client_header_timeout 12<span class="p">;</span>
</span><span class='line'>    keepalive_timeout  25<span class="p">;</span>
</span><span class='line'>    send_timeout 10<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># buffer size</span>
</span><span class='line'>    client_body_buffer_size 10K<span class="p">;</span>
</span><span class='line'>    client_header_buffer_size 1k<span class="p">;</span>
</span><span class='line'>    client_max_body_size 8m<span class="p">;</span>
</span><span class='line'>    large_client_header_buffers <span class="m">4</span> 4k<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># gzip compression</span>
</span><span class='line'>    gzip  on<span class="p">;</span>
</span><span class='line'>    gzip_vary on<span class="p">;</span>
</span><span class='line'>    gzip_min_length 10240<span class="p">;</span>
</span><span class='line'>    gzip_proxied expired no-cache no-store private auth<span class="p">;</span>
</span><span class='line'>    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml<span class="p">;</span>
</span><span class='line'>    gzip_disable <span class="s2">&quot;MSIE [1-6]\.&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    include /etc/nginx/conf.d/app.conf<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in our main nginx config we are including a virtual host config <code>app.conf</code>, which we will create locally, and the content of <code>nginx/config/app.conf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server <span class="o">{</span>
</span><span class='line'>    listen       80<span class="p">;</span>
</span><span class='line'>    server_name  localhost<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    location / <span class="o">{</span>
</span><span class='line'>        root   /usr/share/nginx/app<span class="p">;</span>
</span><span class='line'>        index  index.html index.htm<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#error_page  404              /404.html;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># redirect server error pages to the static page /50x.html</span>
</span><span class='line'>    error_page   <span class="m">500</span> <span class="m">502</span> <span class="m">503</span> <span class="m">504</span>  /50x.html<span class="p">;</span>
</span><span class='line'>    <span class="nv">location</span> <span class="o">=</span> /50x.html <span class="o">{</span>
</span><span class='line'>        root   /usr/share/nginx/html<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have our docker config in place, we can build our container image:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker build -t ruanbekker/hashnode-docs-blogpost:latest .
</span></code></pre></td></tr></table></div></figure>


<p>Then we can review the <strong>size</strong> of our container image, which is only <code>27.4MB</code> in size, pretty neat right.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker images --filter <span class="nv">reference</span><span class="o">=</span>ruanbekker/hashnode-docs-blogpost
</span><span class='line'>
</span><span class='line'>REPOSITORY                          TAG       IMAGE ID       CREATED          SIZE
</span><span class='line'>ruanbekker/hashnode-docs-blogpost   latest    5b60f30f40e6   <span class="m">21</span> minutes ago   27.4MB
</span></code></pre></td></tr></table></div></figure>


<h2>Running our Container</h2>

<p>Now that we&rsquo;ve built our container image, we can run our documentation site, by specifying our host port on the left to map to our container port on the right in <code>80:80</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker run -it -p 80:80 ruanbekker/hashnode-docs-blogpost:latest
</span></code></pre></td></tr></table></div></figure>


<p>When you don&rsquo;t have port 80 already listening prior to running the previous command, when you head to <a href="http://localhost">http://localhost</a> (if you are running this locally), you should see our documentation site up and running:</p>

<p><img src="https://user-images.githubusercontent.com/567298/182018773-ecf3cd6c-ce2c-487a-a1bf-4a84fe1b6a09.png" alt="image" /></p>

<h2>Thank You</h2>

<p>I have published this container image to <a href="https://hub.docker.com/r/ruanbekker/hashnode-docs-blogpost">ruanbekker/hashnode-docs-blogpost</a>.</p>

<p>Thanks for reading, feel free to check out my <strong><a href="https://ruan.dev">website</a></strong>, feel free to subscribe to my <strong><a href="http://digests.ruanbekker.com/?via=hashnode">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/07/14/remote-builds-with-docker-contexts/">Remote Builds With Docker Contexts</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-07-14T01:57:34-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>1:57 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://blog.ruanbekker.com/images/ruanbekker-docker-contexts.png" alt="using-docker-contexts" /></p>

<p>Often you want to save some battery life when you are doing docker builds and leverage a remote host to do the intensive work and we can utilise docker context over ssh to do just that.</p>

<h2>About</h2>

<p>In this tutorial I will show you how to use a remote docker engine to do docker builds, so you still run the docker client locally, but the context of your build will be sent to a remote docker engine via ssh.</p>

<p>We will setup password-less ssh, configure our ssh config, create the remote docker context, then use the remote docker context.</p>

<p><img src="https://user-images.githubusercontent.com/567298/178909518-26f580e9-2b96-41b3-bacd-a5ea5f848ebf.png" alt="image" /></p>

<h2>Password-less SSH</h2>

<p>I will be copying my public key to the remote host:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh-copy-id ruan@192.168.2.18
</span></code></pre></td></tr></table></div></figure>


<p>Setup my ssh config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat ~/.ssh/config
</span><span class='line'>Host home-server
</span><span class='line'>    Hostname 192.168.2.18
</span><span class='line'>    User ruan
</span><span class='line'>    IdentityFile ~/.ssh/id_rsa
</span><span class='line'>    StrictHostKeyChecking no
</span><span class='line'>    UserKnownHostsFile /dev/null
</span></code></pre></td></tr></table></div></figure>


<p>Test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh home-server whoami
</span><span class='line'>ruan
</span></code></pre></td></tr></table></div></figure>


<h2>Docker Context</h2>

<p>On the target host (192.168.2.18) we can verify that docker is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker version
</span><span class='line'>Client: Docker Engine - Community
</span><span class='line'> Version:           20.10.12
</span><span class='line'> API version:       1.41
</span><span class='line'> Go version:        go1.16.12
</span><span class='line'> Git commit:        e91ed57
</span><span class='line'> Built:             Mon Dec <span class="m">13</span> 11:45:37 2021
</span><span class='line'> OS/Arch:           linux/amd64
</span><span class='line'> Context:           default
</span><span class='line'> Experimental:      <span class="nb">true</span>
</span><span class='line'>
</span><span class='line'>Server: Docker Engine - Community
</span><span class='line'> Engine:
</span><span class='line'>  Version:          20.10.12
</span><span class='line'>  API version:      1.41 <span class="o">(</span>minimum version 1.12<span class="o">)</span>
</span><span class='line'>  Go version:       go1.16.12
</span><span class='line'>  Git commit:       459d0df
</span><span class='line'>  Built:            Mon Dec <span class="m">13</span> 11:43:46 2021
</span><span class='line'>  OS/Arch:          linux/amd64
</span><span class='line'>  Experimental:     <span class="nb">false</span>
</span><span class='line'><span class="nb"> </span>containerd:
</span><span class='line'>  Version:          1.4.12
</span><span class='line'>  GitCommit:        7b11cfaabd73bb80907dd23182b9347b4245eb5d
</span><span class='line'> runc:
</span><span class='line'>  Version:          1.0.2
</span><span class='line'>  GitCommit:        v1.0.2-0-g52b36a2
</span><span class='line'> docker-init:
</span><span class='line'>  Version:          0.19.0
</span><span class='line'>  GitCommit:        de40ad0
</span></code></pre></td></tr></table></div></figure>


<p>On the client (my laptop in this example), we will create a docker context called &ldquo;home-server&rdquo; and point it to our target host:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker context create home-server --docker <span class="s2">&quot;host=ssh://home-server&quot;</span>
</span><span class='line'>home-server
</span><span class='line'>Successfully created context <span class="s2">&quot;home-server&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can list our contexts:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker context ls
</span><span class='line'>NAME                TYPE                DESCRIPTION                               DOCKER ENDPOINT               KUBERNETES ENDPOINT                                  ORCHESTRATOR
</span><span class='line'>default *           moby                Current DOCKER_HOST based configuration   unix:///var/run/docker.sock   https://k3d-master.127.0.0.1.nip.io:6445 <span class="o">(</span>default<span class="o">)</span>   swarm
</span><span class='line'>home-server         moby                                                          ssh://home-server
</span></code></pre></td></tr></table></div></figure>


<h2>Using Contexts</h2>

<p>We can verify if this works by listing our cached docker images locally and on our remote host:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker --context<span class="o">=</span>default images <span class="p">|</span> wc -l
</span><span class='line'> 16
</span></code></pre></td></tr></table></div></figure>


<p>And listing the remote images by specifying the context:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker --context<span class="o">=</span>home-server images <span class="p">|</span> wc -l
</span><span class='line'> 70
</span></code></pre></td></tr></table></div></figure>


<p>We can set the default context to our target host:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker context use home-server
</span><span class='line'>home-server
</span></code></pre></td></tr></table></div></figure>


<h2>Running Containers over Contexts</h2>

<p>So running containers with remote contexts essentially becomes running containers on remote hosts. In the past, I had to setup a ssh tunnel, point the docker host env var to that endpoint, then run containers on the remote host.</p>

<p>Thats something of the past, we can just point our docker context to our remote host and run the container. If you haven&rsquo;t set the default context, you can specify the context, so running a docker container on a remote host with your docker client locally:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker --context<span class="o">=</span>home-server run -it -p 8002:8080 ruanbekker/hostname
</span><span class='line'>2022/07/14 05:44:04 Server listening on port 8080
</span></code></pre></td></tr></table></div></figure>


<p>Now from our client (laptop), we can test our container on our remote host:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://192.168.2.18:8002
</span><span class='line'>Hostname: 8605d292e2b4
</span></code></pre></td></tr></table></div></figure>


<p>The same way can be used to do remote docker builds, you have your Dockerfile locally, but when you build, you point the context to the remote host, and your context (dockerfile and files referenced in your dockerfile) will be sent to the remote host. This way you can save a lot of battery life as the computation is done on the remote docker engine.</p>

<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/06/29/create-a-raid5-array-with-mdadm-on-linux/">Create a RAID5 Array With Mdadm on Linux</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-06-29T05:02:13-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>5:02 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://blog.ruanbekker.com/images/ruanbekker-raid5-array-linux.png" alt="setup-raid5-array-ubuntu-linux" /></p>

<p>In this tutorial we will setup a <a href="https://en.wikipedia.org/wiki/Standard_RAID_levels#RAID_5">RAID5</a> array, which is striping across multiple drives with distributed paritiy, which is good for redundancy. We will be using Ubuntu for our Linux Distribution, but the technique applies to other Linux Distributions as well.</p>

<h2>What are we trying to achieve</h2>

<p>We will run a server with one root disk and 6 extra disks, where we will first create our raid5 array with three disks, then I will show you how to expand your raid5 array by adding three other disks.</p>

<p>Things fail all the time, and it&rsquo;s not fun when hard drives breaks, therefore we want to do our best to prevent our applications from going down due to hardware failures. To achieve data redundancy, we want to use three hard drives, which we want to add into a raid configuration that will proviide us:</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Data_striping">striping</a>, which is the technique of segmenting logically sequential data, so that consecutive segments are stored on different physical storage devices.</li>
<li><a href="https://en.wikipedia.org/wiki/Parity_bit#RAID">distributed parity</a>, where parity data are distributed between the physical disks, where there is only one parity block per disk, this provide protection against one physical disk failure, where the minimum number of disks are three.</li>
</ul>


<p>This is how a RAID5 array looks like (image from diskpart.com):</p>

<p><img src="https://user-images.githubusercontent.com/567298/176410333-0ff98867-dfb5-4fe3-a037-cc5d20014ab5.png" alt="raid5" /></p>

<h2>Hardware Overview</h2>

<p>We will have a Linux server with one root disk and six extra disks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsblk
</span><span class='line'>NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span><span class='line'>xvda    202:0    <span class="m">0</span>    8G  <span class="m">0</span> disk
</span><span class='line'>└─xvda1 202:1    <span class="m">0</span>    8G  <span class="m">0</span> part /
</span><span class='line'>xvdb    202:16   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>xvdc    202:32   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>xvdd    202:48   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>xvde    202:64   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>xvdf    202:80   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>xvdg    202:96   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span></code></pre></td></tr></table></div></figure>


<h2>Dependencies</h2>

<p>We require <code>mdadm</code> to create our raid configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update
</span><span class='line'><span class="nv">$ </span>sudo apt install mdadm -y
</span></code></pre></td></tr></table></div></figure>


<h2>Format Disks</h2>

<p>First we will format and partition the following disks: <code>/dev/xvdb</code>, <code>/dev/xvdc</code>, <code>/dev/xvdd</code>, I will demonstrate the process for one disk, but repeat them for the other as well:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fdisk /dev/xvdc
</span><span class='line'>
</span><span class='line'>Welcome to fdisk <span class="o">(</span>util-linux 2.34<span class="o">)</span>.
</span><span class='line'>Changes will remain in memory only, <span class="k">until</span> you decide to write them.
</span><span class='line'>Be careful before using the write command.
</span><span class='line'>
</span><span class='line'>The old ext4 signature will be removed by a write command.
</span><span class='line'>
</span><span class='line'>Device does not contain a recognized partition table.
</span><span class='line'>Created a new DOS disklabel with disk identifier 0x26a2d2f6.
</span><span class='line'>
</span><span class='line'>Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: n
</span><span class='line'>Partition <span class="nb">type</span>
</span><span class='line'><span class="nb">   </span>p   primary <span class="o">(</span><span class="m">0</span> primary, <span class="m">0</span> extended, <span class="m">4</span> free<span class="o">)</span>
</span><span class='line'>   e   extended <span class="o">(</span>container <span class="k">for</span> logical partitions<span class="o">)</span>
</span><span class='line'>Select <span class="o">(</span>default p<span class="o">)</span>: p
</span><span class='line'>Partition number <span class="o">(</span>1-4, default 1<span class="o">)</span>: 1
</span><span class='line'>First sector <span class="o">(</span>2048-20971519, default 2048<span class="o">)</span>:
</span><span class='line'>Last sector, +/-sectors or +/-size<span class="o">{</span>K,M,G,T,P<span class="o">}</span> <span class="o">(</span>2048-20971519, default 20971519<span class="o">)</span>:
</span><span class='line'>
</span><span class='line'>Created a new partition <span class="m">1</span> of <span class="nb">type</span> <span class="s1">&#39;Linux&#39;</span> and of size <span class="m">10</span> GiB.
</span><span class='line'>
</span><span class='line'>Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: t
</span><span class='line'>Selected partition 1
</span><span class='line'>Hex code <span class="o">(</span><span class="nb">type </span>L to list all codes<span class="o">)</span>: fd
</span><span class='line'>Changed <span class="nb">type </span>of partition <span class="s1">&#39;Linux&#39;</span> to <span class="s1">&#39;Linux raid autodetect&#39;</span>.
</span><span class='line'>
</span><span class='line'>Command <span class="o">(</span>m <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>: w
</span><span class='line'>The partition table has been altered.
</span><span class='line'>Calling ioctl<span class="o">()</span> to re-read partition table.
</span><span class='line'>Syncing disks.
</span></code></pre></td></tr></table></div></figure>


<h2>Create RAID5 Array</h2>

<p>Using <code>mdadm</code>, create the <code>/dev/md0</code> device, by specifying the raid level and the disks that we want to add to the array:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mdadm --create /dev/md0 --level<span class="o">=</span><span class="m">5</span> --raid-devices<span class="o">=</span><span class="m">3</span> /dev/xvdb1 /dev/xvdc1 /dev/xvdd1
</span><span class='line'>mdadm: Defaulting to version 1.2 metadata
</span><span class='line'>mdadm: array /dev/md0 started.
</span></code></pre></td></tr></table></div></figure>


<p>Now that our device has been added, we can monitor the process:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /proc/mdstat
</span><span class='line'>Personalities : <span class="o">[</span>raid6<span class="o">]</span> <span class="o">[</span>raid5<span class="o">]</span> <span class="o">[</span>raid4<span class="o">]</span>
</span><span class='line'>md0 : active raid5 xvdd1<span class="o">[</span>3<span class="o">]</span> xvdc1<span class="o">[</span>1<span class="o">]</span> xvdb1<span class="o">[</span>0<span class="o">]</span>
</span><span class='line'>      <span class="m">20951040</span> blocks super 1.2 level 5, 512k chunk, algorithm <span class="m">2</span> <span class="o">[</span>3/2<span class="o">]</span> <span class="o">[</span>UU_<span class="o">]</span>
</span><span class='line'>      <span class="o">[==</span>&gt;..................<span class="o">]</span>  <span class="nv">recovery</span> <span class="o">=</span> 11.5% <span class="o">(</span>1212732/10475520<span class="o">)</span> <span class="nv">finish</span><span class="o">=</span>4.7min <span class="nv">speed</span><span class="o">=</span>32103K/sec
</span><span class='line'>
</span><span class='line'>unused devices: &lt;none&gt;
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, currently its at 11.5%, give it some time to let it complete, you should treat the following as a completed state:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /proc/mdstat
</span><span class='line'>Personalities : <span class="o">[</span>raid6<span class="o">]</span> <span class="o">[</span>raid5<span class="o">]</span> <span class="o">[</span>raid4<span class="o">]</span>
</span><span class='line'>md0 : active raid5 xvdd1<span class="o">[</span>3<span class="o">]</span> xvdc1<span class="o">[</span>1<span class="o">]</span> xvdb1<span class="o">[</span>0<span class="o">]</span>
</span><span class='line'>      <span class="m">20951040</span> blocks super 1.2 level 5, 512k chunk, algorithm <span class="m">2</span> <span class="o">[</span>3/3<span class="o">]</span> <span class="o">[</span>UUU<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>unused devices: &lt;none&gt;
</span></code></pre></td></tr></table></div></figure>


<p>We can also inspect devices with <code>mdadm</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mdadm -E /dev/xvd<span class="o">[</span>b-d<span class="o">]</span>1
</span><span class='line'>/dev/xvdb1:
</span><span class='line'>          Magic : a92b4efc
</span><span class='line'>        Version : 1.2
</span><span class='line'>    Feature Map : 0x0
</span><span class='line'>     Array UUID : ea997bce:a530519c:ae41022e:0f4306bf
</span><span class='line'>           Name : ip-172-31-3-57:0  <span class="o">(</span><span class="nb">local </span>to host ip-172-31-3-57<span class="o">)</span>
</span><span class='line'>  Creation Time : Wed Jan <span class="m">12</span> 13:36:39 2022
</span><span class='line'>     Raid Level : raid5
</span><span class='line'>   Raid Devices : 3
</span><span class='line'>
</span><span class='line'> Avail Dev Size : <span class="m">20951040</span> <span class="o">(</span>9.99 GiB 10.73 GB<span class="o">)</span>
</span><span class='line'>     Array Size : <span class="m">20951040</span> <span class="o">(</span>19.98 GiB 21.45 GB<span class="o">)</span>
</span><span class='line'>    Data Offset : <span class="m">18432</span> sectors
</span><span class='line'>   Super Offset : <span class="m">8</span> sectors
</span><span class='line'>   Unused Space : <span class="nv">before</span><span class="o">=</span><span class="m">18280</span> sectors, <span class="nv">after</span><span class="o">=</span><span class="m">0</span> sectors
</span><span class='line'>          State : clean
</span><span class='line'>    Device UUID : 8305a179:3ef96520:6c7b41dd:bdc7401f
</span><span class='line'>
</span><span class='line'>    Update Time : Wed Jan <span class="m">12</span> 13:42:14 2022
</span><span class='line'>  Bad Block Log : <span class="m">512</span> entries available at offset <span class="m">136</span> sectors
</span><span class='line'>       Checksum : 1f9b4887 - correct
</span><span class='line'>         Events : 18
</span><span class='line'>
</span><span class='line'>         Layout : left-symmetric
</span><span class='line'>     Chunk Size : 512K
</span><span class='line'>
</span><span class='line'>   Device Role : Active device 0
</span><span class='line'>   Array State : AAA <span class="o">(</span><span class="s1">&#39;A&#39;</span> <span class="o">==</span> active, <span class="s1">&#39;.&#39;</span> <span class="o">==</span> missing, <span class="s1">&#39;R&#39;</span> <span class="o">==</span> replacing<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To get information about your raid5 device:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mdadm --detail /dev/md0
</span><span class='line'>/dev/md0:
</span><span class='line'>           Version : 1.2
</span><span class='line'>     Creation Time : Wed Jan <span class="m">12</span> 13:36:39 2022
</span><span class='line'>        Raid Level : raid5
</span><span class='line'>        Array Size : <span class="m">20951040</span> <span class="o">(</span>19.98 GiB 21.45 GB<span class="o">)</span>
</span><span class='line'>     Used Dev Size : <span class="m">10475520</span> <span class="o">(</span>9.99 GiB 10.73 GB<span class="o">)</span>
</span><span class='line'>      Raid Devices : 3
</span><span class='line'>     Total Devices : 3
</span><span class='line'>       Persistence : Superblock is persistent
</span><span class='line'>
</span><span class='line'>       Update Time : Wed Jan <span class="m">12</span> 13:42:14 2022
</span><span class='line'>             State : clean
</span><span class='line'>    Active Devices : 3
</span><span class='line'>   Working Devices : 3
</span><span class='line'>    Failed Devices : 0
</span><span class='line'>     Spare Devices : 0
</span><span class='line'>
</span><span class='line'>            Layout : left-symmetric
</span><span class='line'>        Chunk Size : 512K
</span><span class='line'>
</span><span class='line'>Consistency Policy : resync
</span><span class='line'>
</span><span class='line'>              Name : ip-172-31-3-57:0  <span class="o">(</span><span class="nb">local </span>to host ip-172-31-3-57<span class="o">)</span>
</span><span class='line'>              UUID : ea997bce:a530519c:ae41022e:0f4306bf
</span><span class='line'>            Events : 18
</span><span class='line'>
</span><span class='line'>    Number   Major   Minor   RaidDevice State
</span><span class='line'>       <span class="m">0</span>     <span class="m">202</span>       <span class="m">17</span>        <span class="m">0</span>      active sync   /dev/xvdb1
</span><span class='line'>       <span class="m">1</span>     <span class="m">202</span>       <span class="m">33</span>        <span class="m">1</span>      active sync   /dev/xvdc1
</span><span class='line'>       <span class="m">3</span>     <span class="m">202</span>       <span class="m">49</span>        <span class="m">2</span>      active sync   /dev/xvdd1
</span></code></pre></td></tr></table></div></figure>


<h2>Create Filesystems</h2>

<p>We will use our <code>/dev/md0</code> device and create a <code>ext4</code> filesystem:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkfs.ext4 /dev/md0
</span><span class='line'>mke2fs 1.45.5 <span class="o">(</span>07-Jan-2020<span class="o">)</span>
</span><span class='line'>Creating filesystem with <span class="m">5237760</span> 4k blocks and <span class="m">1310720</span> inodes
</span><span class='line'>Filesystem UUID: 579f045e-d270-4ff2-b36b-8dc506c27c5f
</span><span class='line'>Superblock backups stored on blocks:
</span><span class='line'>  32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
</span><span class='line'>  4096000
</span><span class='line'>
</span><span class='line'>Allocating group tables: <span class="k">done</span>
</span><span class='line'>Writing inode tables: <span class="k">done</span>
</span><span class='line'>Creating journal <span class="o">(</span><span class="m">32768</span> blocks<span class="o">)</span>: <span class="k">done</span>
</span><span class='line'>Writing superblocks and filesystem accounting information: <span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can then verify that by looking at our block devices using <code>lsblk</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsblk
</span><span class='line'>NAME    MAJ:MIN RM  SIZE RO TYPE  MOUNTPOINT
</span><span class='line'>xvda    202:0    <span class="m">0</span>    8G  <span class="m">0</span> disk
</span><span class='line'>└─xvda1 202:1    <span class="m">0</span>    8G  <span class="m">0</span> part  /
</span><span class='line'>xvdb    202:16   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>└─xvdb1 202:17   <span class="m">0</span>   10G  <span class="m">0</span> part
</span><span class='line'>  └─md0   9:0    <span class="m">0</span>   20G  <span class="m">0</span> raid5
</span><span class='line'>xvdc    202:32   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>└─xvdc1 202:33   <span class="m">0</span>   10G  <span class="m">0</span> part
</span><span class='line'>  └─md0   9:0    <span class="m">0</span>   20G  <span class="m">0</span> raid5
</span><span class='line'>xvdd    202:48   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>└─xvdd1 202:49   <span class="m">0</span>   10G  <span class="m">0</span> part
</span><span class='line'>  └─md0   9:0    <span class="m">0</span>   20G  <span class="m">0</span> raid5
</span><span class='line'>xvde    202:64   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>xvdf    202:80   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span><span class='line'>xvdg    202:96   <span class="m">0</span>   10G  <span class="m">0</span> disk
</span></code></pre></td></tr></table></div></figure>


<p>Now we can mount our device to <code>/mnt</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mount /dev/md0 /mnt
</span></code></pre></td></tr></table></div></figure>


<p>We can verify that the device is mounted by using <code>df</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/root       7.7G  1.5G  6.3G  19% /
</span><span class='line'>/dev/md0         20G   45M   19G   1% /mnt
</span></code></pre></td></tr></table></div></figure>


<p>To persist the device across reboots, add it to the <code>/etc/fstab</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/fstab
</span><span class='line'>/dev/md0                /mnt     ext4   defaults                <span class="m">0</span> 0
</span></code></pre></td></tr></table></div></figure>


<p>Now our filesystem which is mounted at <code>/mnt</code> is ready to be used.</p>

<h2>RAID Configuration (across reboots)</h2>

<p>By default RAID doesn’t have a config file, therefore we need to save it manually. If this step is not followed RAID device will not be in md0, but perhaps something else.</p>

<p>So, we must have to save the configuration to persist across reboots, when it reboot it gets loaded to the kernel and RAID will also get loaded.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mdadm --detail --scan --verbose &gt;&gt; /etc/mdadm.conf
</span></code></pre></td></tr></table></div></figure>


<p>Note: Saving the configuration will keep the RAID level stable in the md0 device.</p>

<h2>Adding Spare Devices</h2>

<p>Earlier I mentioned that we have spare disks that we can use to expand our raid device. After they have been formatted we can add them as spare devices to our raid setup:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mdadm --add /dev/md0 /dev/xvde1 /dev/xvdf1 /dev/xvdg1
</span><span class='line'>mdadm: added /dev/xvde1
</span><span class='line'>mdadm: added /dev/xvdf1
</span><span class='line'>mdadm: added /dev/xvdg1
</span></code></pre></td></tr></table></div></figure>


<p>Verify our change by viewing the detail of our device:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mdadm --detail /dev/md0
</span><span class='line'>/dev/md0:
</span><span class='line'>           Version : 1.2
</span><span class='line'>     Creation Time : Wed Jan <span class="m">12</span> 13:36:39 2022
</span><span class='line'>        Raid Level : raid5
</span><span class='line'>        Array Size : <span class="m">20951040</span> <span class="o">(</span>19.98 GiB 21.45 GB<span class="o">)</span>
</span><span class='line'>     Used Dev Size : <span class="m">10475520</span> <span class="o">(</span>9.99 GiB 10.73 GB<span class="o">)</span>
</span><span class='line'>      Raid Devices : 3
</span><span class='line'>     Total Devices : 6
</span><span class='line'>       Persistence : Superblock is persistent
</span><span class='line'>
</span><span class='line'>       Update Time : Wed Jan <span class="m">12</span> 14:28:23 2022
</span><span class='line'>             State : clean
</span><span class='line'>    Active Devices : 3
</span><span class='line'>   Working Devices : 6
</span><span class='line'>    Failed Devices : 0
</span><span class='line'>     Spare Devices : 3
</span><span class='line'>
</span><span class='line'>            Layout : left-symmetric
</span><span class='line'>        Chunk Size : 512K
</span><span class='line'>
</span><span class='line'>Consistency Policy : resync
</span><span class='line'>
</span><span class='line'>              Name : ip-172-31-3-57:0  <span class="o">(</span><span class="nb">local </span>to host ip-172-31-3-57<span class="o">)</span>
</span><span class='line'>              UUID : ea997bce:a530519c:ae41022e:0f4306bf
</span><span class='line'>            Events : 27
</span><span class='line'>
</span><span class='line'>    Number   Major   Minor   RaidDevice State
</span><span class='line'>       <span class="m">0</span>     <span class="m">202</span>       <span class="m">17</span>        <span class="m">0</span>      active sync   /dev/xvdb1
</span><span class='line'>       <span class="m">1</span>     <span class="m">202</span>       <span class="m">33</span>        <span class="m">1</span>      active sync   /dev/xvdc1
</span><span class='line'>       <span class="m">3</span>     <span class="m">202</span>       <span class="m">49</span>        <span class="m">2</span>      active sync   /dev/xvdd1
</span><span class='line'>
</span><span class='line'>       <span class="m">4</span>     <span class="m">202</span>       <span class="m">65</span>        -      spare   /dev/xvde1
</span><span class='line'>       <span class="m">5</span>     <span class="m">202</span>       <span class="m">81</span>        -      spare   /dev/xvdf1
</span><span class='line'>       <span class="m">6</span>     <span class="m">202</span>       <span class="m">97</span>        -      spare   /dev/xvdg1
</span></code></pre></td></tr></table></div></figure>


<p>As you can see it&rsquo;s only spares at this moment, we can use the spares for data storage, by growing our device:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mdadm --grow --raid-devices<span class="o">=</span><span class="m">6</span> /dev/md0
</span></code></pre></td></tr></table></div></figure>


<p>Verify:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mdadm --detail /dev/md0
</span><span class='line'>/dev/md0:
</span><span class='line'>           Version : 1.2
</span><span class='line'>     Creation Time : Wed Jan <span class="m">12</span> 13:36:39 2022
</span><span class='line'>        Raid Level : raid5
</span><span class='line'>        Array Size : <span class="m">20951040</span> <span class="o">(</span>19.98 GiB 21.45 GB<span class="o">)</span>
</span><span class='line'>     Used Dev Size : <span class="m">10475520</span> <span class="o">(</span>9.99 GiB 10.73 GB<span class="o">)</span>
</span><span class='line'>      Raid Devices : 6
</span><span class='line'>     Total Devices : 6
</span><span class='line'>       Persistence : Superblock is persistent
</span><span class='line'>
</span><span class='line'>       Update Time : Wed Jan <span class="m">12</span> 15:15:31 2022
</span><span class='line'>             State : clean, reshaping
</span><span class='line'>    Active Devices : 6
</span><span class='line'>   Working Devices : 6
</span><span class='line'>    Failed Devices : 0
</span><span class='line'>     Spare Devices : 0
</span><span class='line'>
</span><span class='line'>            Layout : left-symmetric
</span><span class='line'>        Chunk Size : 512K
</span><span class='line'>
</span><span class='line'>Consistency Policy : resync
</span><span class='line'>
</span><span class='line'>    Reshape Status : 0% <span class="nb">complete</span>
</span><span class='line'><span class="nb">     </span>Delta Devices : 3, <span class="o">(</span>3-&gt;6<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>              Name : ip-172-31-3-57:0  <span class="o">(</span><span class="nb">local </span>to host ip-172-31-3-57<span class="o">)</span>
</span><span class='line'>              UUID : ea997bce:a530519c:ae41022e:0f4306bf
</span><span class='line'>            Events : 36
</span><span class='line'>
</span><span class='line'>    Number   Major   Minor   RaidDevice State
</span><span class='line'>       <span class="m">0</span>     <span class="m">202</span>       <span class="m">17</span>        <span class="m">0</span>      active sync   /dev/xvdb1
</span><span class='line'>       <span class="m">1</span>     <span class="m">202</span>       <span class="m">33</span>        <span class="m">1</span>      active sync   /dev/xvdc1
</span><span class='line'>       <span class="m">3</span>     <span class="m">202</span>       <span class="m">49</span>        <span class="m">2</span>      active sync   /dev/xvdd1
</span><span class='line'>       <span class="m">6</span>     <span class="m">202</span>       <span class="m">97</span>        <span class="m">3</span>      active sync   /dev/xvdg1
</span><span class='line'>       <span class="m">5</span>     <span class="m">202</span>       <span class="m">81</span>        <span class="m">4</span>      active sync   /dev/xvdf1
</span><span class='line'>       <span class="m">4</span>     <span class="m">202</span>       <span class="m">65</span>        <span class="m">5</span>      active sync   /dev/xvde1
</span></code></pre></td></tr></table></div></figure>


<p>Wait for the raid to rebuild, by viewing the <code>mdstat</code>::</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /proc/mdstat
</span><span class='line'>Personalities : <span class="o">[</span>raid6<span class="o">]</span> <span class="o">[</span>raid5<span class="o">]</span> <span class="o">[</span>raid4<span class="o">]</span>
</span><span class='line'>md0 : active raid5 xvdg1<span class="o">[</span>6<span class="o">]</span> xvdf1<span class="o">[</span>5<span class="o">]</span> xvde1<span class="o">[</span>4<span class="o">]</span> xvdd1<span class="o">[</span>3<span class="o">]</span> xvdc1<span class="o">[</span>1<span class="o">]</span> xvdb1<span class="o">[</span>0<span class="o">]</span>
</span><span class='line'>      <span class="m">20951040</span> blocks super 1.2 level 5, 512k chunk, algorithm <span class="m">2</span> <span class="o">[</span>6/6<span class="o">]</span> <span class="o">[</span>UUUUUU<span class="o">]</span>
</span><span class='line'>      <span class="o">[</span>&gt;....................<span class="o">]</span>  <span class="nv">reshape</span> <span class="o">=</span>  0.7% <span class="o">(</span>76772/10475520<span class="o">)</span> <span class="nv">finish</span><span class="o">=</span>18.0min <span class="nv">speed</span><span class="o">=</span>9596K/sec
</span><span class='line'>
</span><span class='line'>unused devices: &lt;none&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Resizing our Filesystem</h2>

<p>Once we added the spares and growed our device, we need to run integrity checks, then we can resize the volume. But first, we need to unmount our filesystem:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>umount /mnt
</span></code></pre></td></tr></table></div></figure>


<p>Run a integrity check:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>e2fsck -f /dev/md0
</span><span class='line'>e2fsck 1.45.5 <span class="o">(</span>07-Jan-2020<span class="o">)</span>
</span><span class='line'>Pass 1: Checking inodes, blocks, and sizes
</span><span class='line'>Pass 2: Checking directory structure
</span><span class='line'>Pass 3: Checking directory connectivity
</span><span class='line'>Pass 4: Checking reference counts
</span><span class='line'>Pass 5: Checking group summary information
</span><span class='line'>/dev/md0: 12/1310720 files <span class="o">(</span>0.0% non-contiguous<span class="o">)</span>, 126323/5237760 blocks
</span></code></pre></td></tr></table></div></figure>


<p>Once that has passed, resize the file system:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>resize2fs /dev/md0
</span><span class='line'>resize2fs 1.45.5 <span class="o">(</span>07-Jan-2020<span class="o">)</span>
</span><span class='line'>Resizing the filesystem on /dev/md0 to <span class="m">13094400</span> <span class="o">(</span>4k<span class="o">)</span> blocks.
</span><span class='line'>The filesystem on /dev/md0 is now <span class="m">13094400</span> <span class="o">(</span>4k<span class="o">)</span> blocks long.
</span></code></pre></td></tr></table></div></figure>


<p>Then we remount our filesystem:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mount /dev/md0 /mnt
</span></code></pre></td></tr></table></div></figure>


<p>After the filesystem has been mounted, we can view the disk size and confirm that the size increased:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h /mnt
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/md0         50G   52M   47G   1% /mnt
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/06/23/install-a-specific-python-version-on-ubuntu/">Install a Specific Python Version on Ubuntu</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-06-23T17:53:46-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2022</span></span> <span class='time'>5:53 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://blog.ruanbekker.com/images/ruanbekker-install-specific-python-version.png" alt="install-specific-python-version" /></p>

<p>In this short tutorial, I will demonstrate how to install a spcific version of Python on Ubuntu Linux.</p>

<p><a href="https://ruan.dev"><img src="https://img.shields.io/badge/website-ruan.dev-red.svg" alt="" /></a> <a href="https://twitter.com/ruanbekker"><img src="https://img.shields.io/badge/twitter-@ruanbekker-00acee.svg" alt="" /></a> <a href="https://github.com/ruanbekker"><img src="https://img.shields.io/badge/github-cheatsheets-orange.svg" alt="" /></a> <a href="https://saythanks.io/to/ruanbekker"><img src="https://img.shields.io/badge/dm-saythanks.io-07B63F.svg" alt="Say Thanks!" /></a>  <a href="https://ko-fi.com/ruanbekker"><img src="https://img.shields.io/badge/-Buy%20Me%20a%20Coffee-ff5f5f?logo=ko-fi&amp;logoColor=white" alt="Ko-fi" /></a></p>

<h2>Dependencies</h2>

<p>Update the apt repositories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update
</span></code></pre></td></tr></table></div></figure>


<p>Then install the required dependencies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt install libssl-dev openssl wget build-essential zlib1g-dev -y
</span></code></pre></td></tr></table></div></figure>


<h2>Python Versions</h2>

<p>Head over to the <a href="https://www.python.org/downloads/">Python Downloads</a> section and select the version of your choice, in my case I will be using Python 3.8.13, once you have the download link, download it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://www.python.org/ftp/python/3.8.13/Python-3.8.13.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Then extract the tarball:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tar -xvf Python-3.8.13.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Once it completes, change to the directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>Python-3.8.13
</span></code></pre></td></tr></table></div></figure>


<h2>Installation</h2>

<p>Compile and add <code>--enable-optimizations</code> flag as an argument:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./configure --enable-optimizations
</span></code></pre></td></tr></table></div></figure>


<p>Run make and make install:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>make
</span><span class='line'><span class="nv">$ </span>sudo make install
</span></code></pre></td></tr></table></div></figure>


<p>Once it completes, you can symlink the python binary so that it&rsquo;s detected by your <code>PATH</code>, if you have no installed python versions or want to use it as the default, you can force overwriting the symlink:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo ln -fs /usr/local/bin/python3 /usr/bin/python3
</span></code></pre></td></tr></table></div></figure>


<p>Then we can test it by running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python3 --version
</span><span class='line'>Python 3.8.13
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/06/15/how-to-persist-iptables-rules-after-reboots/">How to Persist Iptables Rules After Reboots</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-06-15T06:10:12-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>6:10 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://blog.ruanbekker.com/images/ruanbekker-blog-persist-iptables.png" alt="persist-iptables-after-reboot" /></p>

<p>In this tutorial we will demonstrate how to persist iptables rules across reboots.</p>

<h2>Rules Peristence</h2>

<p>By default, when you create iptables rules its active, but as soon as you restart your server, the rules will be gone. Therefore we need to persist these rules across reboots.</p>

<h2>Dependencies</h2>

<p>We require the package <code>iptables-persistent</code> and I will install it on a debian system so I will be using <code>apt</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt update
</span><span class='line'>sudo apt install iptables-persistent -y
</span></code></pre></td></tr></table></div></figure>


<p>Ensure that the service is enabled to start on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo systemctl <span class="nb">enable </span>netfilter-persistent
</span></code></pre></td></tr></table></div></figure>


<h2>Creating Iptables Rules</h2>

<p>In this case I will allow port 80 on TCP from all sources:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo iptables -I INPUT -p tcp --dport <span class="m">80</span> -j ACCEPT
</span></code></pre></td></tr></table></div></figure>


<p>To persist our current rules, we need to save them to <code>/etc/iptables/rules.v4</code> with <code>iptables-save</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo iptables-save &gt; /etc/iptables/rules.v4
</span></code></pre></td></tr></table></div></figure>


<p>Now when we restart, our rules will be loaded and our previous defined rules will be active.</p>

<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/06/14/how-to-read-and-write-json-data-with-python/">How to Read and Write Json Data With Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-06-14T19:02:53-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>7:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a short tutorial on how to use python to write and read files.</p>

<h2>Example</h2>

<p>To write the following json data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ruan&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To a file named <code>/tmp/data.json</code>, we will be using this code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'>
</span><span class='line'><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;ruan&quot;</span><span class="p">}</span>
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;data.json&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we execute that code, we will find the data inside that file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /tmp/data.json
</span><span class='line'><span class="o">{</span><span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;ruan&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And if we want to use python to read the data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'>
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;data.json&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>    <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we execute that code, we will see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="err">&#39;name&#39;:</span> <span class="err">&#39;ruan&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/05/31/setup-linkding-bookmarks-manager-on-docker/">Setup Linkding Bookmarks Manager on Docker</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-05-31T15:50:24-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2022</span></span> <span class='time'>3:50 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Note</strong>:  <em>Originally posted on <a href="https://containers.fan/posts/setup-linkding-bookmarks-manager/">containers.fan</a></em></p>

<p>I&rsquo;ve stumbled upon a great bookmarks manager service called <strong><a href="https://github.com/sissbruecker/linkding/blob/master/README.md">Linkding</a></strong>. What I really like about it, it allows you to save your bookmarks, assign tags to it to search for it later, it has chrome and firefox browser extensions, and comes with an API.</p>

<h2>Installing Linkding</h2>

<p>We will be using Traefik to do SSL termination and host based routing, if you don’t have Traefik running already, you can follow this post to get that set up:</p>

<ul>
<li><a href="https://containers.fan/posts/setup-traefik-v2-docker-compose/">https://containers.fan/posts/setup-traefik-v2-docker-compose/</a></li>
</ul>


<p>You can follow the <a href="https://github.com/sissbruecker/linkding/blob/master/README.md">linkding documentation</a> for more detailed information.</p>

<p>The <code>docker-compose.yml</code> that I will be use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.8&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">linkding</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sissbruecker/linkding:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linkding</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./data:/etc/linkding/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LD_DISABLE_BACKGROUND_TASKS=False</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LD_DISABLE_URL_VALIDATION=False</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cpus</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0.5</span>
</span><span class='line'>    <span class="l-Scalar-Plain">mem_limit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">512m</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">public</span>
</span><span class='line'>    <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;traefik.enable=true&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;traefik.http.routers.linkding-app.rule=Host(`linkding.yourdomain.net`)&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;traefik.http.routers.linkding-app.entrypoints=https&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;traefik.http.routers.linkding-app.tls.certresolver=letsencrypt&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">public</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">public</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure to replace the FQDN of your choice, as I used <code>linkding.yourdomain.net</code> as an example.</p>

<p>Once everything is in place, boot the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>


<h2>Admin Account Registration</h2>

<p>Once your linkding container has booted, you can create a admin user with the following command (ensure to replace where needed):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose <span class="nb">exec </span>linkding python manage.py createsuperuser --username<span class="o">=</span>admin --email<span class="o">=</span>root@localhost
</span></code></pre></td></tr></table></div></figure>


<p>Once you head over to the linkding url that you provided and you logon, you should be able to see something like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/171265323-2b23515f-8535-4c89-a195-6ab9b63eab68.png" alt="linkding" /></p>

<h2>Creating Bookmarks</h2>

<p>When you select &ldquo;Add Bookmark&rdquo; and you provide the URL, linkding will retrieve the title and the description and populate it for you, and you can provide the tags (seperated by spaces):</p>

<p><img src="https://user-images.githubusercontent.com/567298/171266278-ab31afc0-4aca-48fc-9795-4d49ae9b3508.png" alt="linkding-bookmark" /></p>

<h2>Browser Extensions</h2>

<p>To add a browser extension, select &ldquo;Settings&rdquo;, then &ldquo;Integrations&rdquo;, then you will find the link to the browser extension for Chrome and Firefox:</p>

<p><img src="https://user-images.githubusercontent.com/567298/171266713-3e2b2e5d-2ff0-43be-9713-5dd69a15d0cd.png" alt="linkding-browser-extension" /></p>

<p>After you install the browser extension and click on it for the first time, it will ask you to set the Linkding Base URL and API Authentication Token:</p>

<p><img src="https://user-images.githubusercontent.com/567298/171267455-123cad06-3758-4991-bb7e-40dc43a62996.png" alt="linkding-configuration" /></p>

<p>You can find that at the bottom of the &ldquo;Integrations&rdquo; section:</p>

<p><img src="https://user-images.githubusercontent.com/567298/171269639-45e65ab0-b413-4879-9c8f-0b82f5884096.png" alt="linkding-rest-api-access" /></p>

<h2>REST API</h2>

<p>You can follow the <a href="https://github.com/sissbruecker/linkding/blob/master/docs/API.md">API Docs</a> for more information, using an example to search for bookmarks with the term &ldquo;docker&rdquo;:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -sL -H <span class="s2">&quot;Authorization: Token ${LINKDING_API_TOKEN}&quot;</span> <span class="s2">&quot;https://linkding.${DOMAIN}/api/bookmarks?q=docker&quot;</span> <span class="p">|</span> python3 -m json.tool
</span></code></pre></td></tr></table></div></figure>


<p>In my case returns a response like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;next&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;previous&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.docker.com/blog/deploying-web-applications-quicker-and-easier-with-caddy-2/&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;website_title&quot;</span><span class="p">:</span> <span class="s2">&quot;Deploying Web Applications Quicker and Easier with Caddy 2 - Docker&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;website_description&quot;</span><span class="p">:</span> <span class="s2">&quot;Deploying web apps can be tough, even with leading server technologies. Learn how you can use Caddy 2 and Docker simplify this process.&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;is_archived&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;tag_names&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;caddy&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;docker&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;date_added&quot;</span><span class="p">:</span> <span class="s2">&quot;2022-05-31T19:11:53.739002Z&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;date_modified&quot;</span><span class="p">:</span> <span class="s2">&quot;2022-05-31T19:11:53.739016Z&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/05/31/python-flask-forms-with-jinja-templating/">Python Flask Forms With Jinja Templating</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-05-31T02:39:30-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2022</span></span> <span class='time'>2:39 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/171112630-7fd74a3a-d216-4b4c-85a2-8d9de6428f45.png" alt="ruanbekker-blog" /></p>

<p>In this tutorial, we will demonstrate how to use <a href="https://flask.palletsprojects.com/en/2.1.x/">Python Flask</a> and <code>render_template</code> to use <a href="https://jinja.palletsprojects.com/en/3.1.x/">Jinja Templating</a> with our Form. The example is just a ui that accepts a firstname, lastname and email address and when we submit the form data, it renders on a table.</p>

<h2>Install Flask</h2>

<p>Create a virtual environment and install python flask</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python3 -m pip install virtualenv
</span><span class='line'>python3 -m virtualenv -p python3 .venv
</span><span class='line'><span class="nb">source</span> .venv/bin/activate
</span></code></pre></td></tr></table></div></figure>


<h2>The Code</h2>

<p>First we will create our application code in <code>app.py</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
</span><span class='line'>
</span><span class='line'><span class="n">app_version</span> <span class="o">=</span> <span class="s">&#39;1.1.0&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;form.html&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/result&#39;</span><span class="p">,</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">result</span><span class="p">():</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>
</span><span class='line'>        <span class="n">json_result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="n">json_result</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;result.html&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">app_version</span><span class="o">=</span><span class="n">app_version</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see our first route <code>/</code> will render the template in <code>form.html</code>. Our second route <code>/result</code> a couple of things are happening:</p>

<ul>
<li>If we received a POST method, we will capture the form data</li>
<li>We are then casting it to a dictionary data type</li>
<li>Print the results out of our form data (for debugging)</li>
<li>Then we are passing the result object and the app_version variable to our template where it will be parsed.</li>
</ul>


<p>When using <code>render_template</code> all html files resides under the <code>templates</code> directory, so let&rsquo;s first create our <code>base.html</code> file that we will use as a starting point in <code>templates/base.html</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">mkdir</span> <span class="n">templates</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then in your <code>templates/base.html</code>:</p>

<script src="https://gist.github.com/ruanbekker/4d6b3e91b629795b3429a15f5db72972.js"></script>


<p>In our <code>templates/form.html</code> we have our form template, and you can see we are referencing our <code>base.html</code> in our template to include the first bit:</p>

<script src="https://gist.github.com/ruanbekker/f9e0c78d12987e19862486e446378ed7.js"></script>


<p>Then our last template <code>templates/result.html</code> is used when we click on submit, when the form data is displayed in our table:</p>

<script src="https://gist.github.com/ruanbekker/ad40ae4c59a81e8c089e7df2d50c605a.js"></script>


<p>So our directory structure should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>├── app.py
</span><span class='line'>└── templates
</span><span class='line'>    ├── base.html
</span><span class='line'>    ├── form.html
</span><span class='line'>    └── result.html
</span><span class='line'>
</span><span class='line'><span class="m">1</span> directory, <span class="m">4</span> files
</span></code></pre></td></tr></table></div></figure>


<p>Then run the server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python app.py
</span></code></pre></td></tr></table></div></figure>


<h2>Screenshots</h2>

<p>It should look like the following when you access <a href="http://localhost:5000/">http://localhost:5000/</a></p>

<p><img src="https://user-images.githubusercontent.com/567298/171111587-915935a6-1557-4039-bbd0-d1d95070c2ae.png" alt="python-flask-forms" /></p>

<p>After entering your form data, select &ldquo;Submit&rdquo;, then you should see the following:</p>

<p><img src="https://user-images.githubusercontent.com/567298/171111868-9f8974d2-90cc-45c9-b930-da2d6ec96cbf.png" alt="python-flask-forms" /></p>

<p>So you can see that our request data was parsed through the template and our app version variable as well.</p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>

<p><a href="https://github.com/ruanbekker/cheatsheets" target="_blank"><img alt="ruanbekker-cheatsheets" src="https://user-images.githubusercontent.com/567298/169162832-ef3019de-bc49-4d6c-b2a6-8ac17c457d24.png"></a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/05/30/prometheus-relabel-config-examples/">Prometheus Relabel Config Examples</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-05-30T03:01:01-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>3:01 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a quick demonstration on how to use prometheus relabel configs, when you have scenarios for when example, you want to use a part of your hostname and assign it to a prometheus label.</p>

<h2>Prometheus Relabling</h2>

<p>Using a standard prometheus config to scrape two targets:
- <code>ip-192-168-64-29.multipass:9100</code>
- <code>ip-192-168-64-30.multipass:9100</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global:
</span><span class='line'>  scrape_interval:     15s
</span><span class='line'>  evaluation_interval: 15s
</span><span class='line'>  external_labels:
</span><span class='line'>    cluster: 'local'
</span><span class='line'>
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'prometheus'
</span><span class='line'>    scrape_interval: 15s
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['localhost:9090']
</span><span class='line'>
</span><span class='line'>  - job_name: 'multipass-nodes'
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['ip-192-168-64-29.multipass:9100']
</span><span class='line'>      labels:
</span><span class='line'>        test: 1
</span><span class='line'>    - targets: ['ip-192-168-64-30.multipass:9100']
</span><span class='line'>      labels:
</span><span class='line'>        test: 1</span></code></pre></td></tr></table></div></figure>


<p>The Result:</p>

<p><img width="924" alt="image" src="https://user-images.githubusercontent.com/567298/170823370-f2c6b3a3-68a8-4f5a-ad43-2f1b832c95e0.png"></p>

<p>When we want to relabel one of the source the prometheus <a href="https://grafana.com/blog/2022/03/21/how-relabeling-in-prometheus-works/#internal-labels">internal labels</a>, <code>__address__</code> which will be the given target including the port, then we apply regex: <code>(.*)</code> to catch everything from the source label, and since there is only one group we use the <code>replacement</code> as <code>${1}-randomtext</code> and use that value to apply it as the value of the given <code>target_label</code> which in this case is for <code>randomlabel</code>, which will be in this case:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global:
</span><span class='line'>  scrape_interval:     15s
</span><span class='line'>  evaluation_interval: 15s
</span><span class='line'>  external_labels:
</span><span class='line'>    cluster: 'local'
</span><span class='line'>
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'prometheus'
</span><span class='line'>    scrape_interval: 15s
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['localhost:9090']
</span><span class='line'>
</span><span class='line'>  - job_name: 'multipass-nodes'
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['ip-192-168-64-29.multipass:9100']
</span><span class='line'>      labels:
</span><span class='line'>        test: 3
</span><span class='line'>    - targets: ['ip-192-168-64-30.multipass:9100']
</span><span class='line'>      labels:
</span><span class='line'>        test: 3
</span><span class='line'>    relabel_configs:
</span><span class='line'>    - source_labels: [__address__]
</span><span class='line'>      regex: '(.+)'
</span><span class='line'>      replacement: '${1}-randomtext'
</span><span class='line'>      target_label: randomlabel</span></code></pre></td></tr></table></div></figure>


<p>The Result:</p>

<p><img width="1107" alt="image" src="https://user-images.githubusercontent.com/567298/170824588-44a79c3d-5131-4311-bcca-f5137d6acdad.png"></p>

<p>In this case we want to relabel the <code>__address__</code> and apply the value to the <code>instance</code> label, but we want to exclude the <code>:9100</code> from the <code>__address__</code> label:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Config: https://github.com/prometheus/prometheus/blob/release-2.36/config/testdata/conf.good.yml
</span><span class='line'>global:
</span><span class='line'>  scrape_interval:     15s
</span><span class='line'>  evaluation_interval: 15s
</span><span class='line'>  external_labels:
</span><span class='line'>    cluster: 'local'
</span><span class='line'>
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'prometheus'
</span><span class='line'>    scrape_interval: 15s
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['localhost:9090']
</span><span class='line'>
</span><span class='line'>  - job_name: 'multipass-nodes'
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['ip-192-168-64-29.multipass:9100']
</span><span class='line'>      labels:
</span><span class='line'>        test: 4
</span><span class='line'>    - targets: ['ip-192-168-64-30.multipass:9100']
</span><span class='line'>      labels:
</span><span class='line'>        test: 4
</span><span class='line'>    relabel_configs:
</span><span class='line'>    - source_labels: [__address__]
</span><span class='line'>      separator: ':'
</span><span class='line'>      regex: '(.*):(.*)'
</span><span class='line'>      replacement: '${1}'
</span><span class='line'>      target_label: instance</span></code></pre></td></tr></table></div></figure>


<p>The Result:</p>

<p><img width="950" alt="image" src="https://user-images.githubusercontent.com/567298/170824806-45f0f243-5fe7-4635-9e9a-335616a322da.png"></p>

<h2>AWS EC2 SD Configs</h2>

<p>On AWS EC2 you can make use of the <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#ec2_sd_config">ec2_sd_config</a> where you can make use of EC2 Tags, to set the values of your tags to prometheus label values.</p>

<p>In this scenario, on my EC2 instances I have 3 tags:
- Key: PrometheusScrape, Value: Enabled
- Key: Name, Value: pdn-server-1
- Key: Environment, Value: dev</p>

<p>In our config, we only apply a node-exporter scrape config to instances which are tagged <code>PrometheusScrape=Enabled</code>, then we use the <code>Name</code> tag, and assign it&rsquo;s value to the <code>instance</code> tag, and the similarly we assign the <code>Environment</code> tag value to the <code>environment</code> promtheus label value.</p>

<p>Because this prometheus instance resides in the same VPC, I am using the <code>__meta_ec2_private_ip</code> which is the private ip address of the EC2 instance to assign it to the address where it needs to scrape the node exporter metrics endpoint:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">scrape_configs</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">job_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">node-exporter</span>
</span><span class='line'>    <span class="l-Scalar-Plain">scrape_interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15s</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ec2_sd_configs</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">eu-west-1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9100</span>
</span><span class='line'>      <span class="l-Scalar-Plain">filters</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tag:PrometheusScrape</span>
</span><span class='line'>          <span class="l-Scalar-Plain">values</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Enabled</span>
</span><span class='line'>    <span class="l-Scalar-Plain">relabel_configs</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">source_labels</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">__meta_ec2_private_ip</span><span class="p-Indicator">]</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replacement</span><span class="p-Indicator">:</span> <span class="s">&#39;${1}:9100&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">target_label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">__address__</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">source_labels</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">__meta_ec2_tag_Name</span><span class="p-Indicator">]</span>
</span><span class='line'>      <span class="l-Scalar-Plain">target_label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">instance</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">source_labels</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">__meta_ec2_tag_Environment</span><span class="p-Indicator">]</span>
</span><span class='line'>      <span class="l-Scalar-Plain">target_label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">environment</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will need a EC2 Ready Only instance role (or access keys on the configuration) in order for prometheus to read the EC2 tags on your account.</p>

<p>See their <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#ec2_sd_config">documentation</a> for more info.</p>

<h2>Stack</h2>

<p>The docker-compose used:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.8&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">prometheus</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prom/prometheus</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="s">&#39;prometheus&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./prometheus.yml:/etc/prometheus/prometheus.yml</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">prometheus-data:/prometheus</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--config.file=/etc/prometheus/prometheus.yml&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--storage.tsdb.path=/prometheus&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--storage.tsdb.retention=14d&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--web.console.libraries=/etc/prometheus/console_libraries&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--web.console.templates=/etc/prometheus/consoles&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;--web.external-url=http://prometheus.127.0.0.1.nip.io&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">9090:9090</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">public</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">public</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">public</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">prometheus-data</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<p>Usful docs:</p>

<ul>
<li><a href="https://grafana.com/blog/2022/03/21/how-relabeling-in-prometheus-works/#internal-labels">https://grafana.com/blog/2022/03/21/how-relabeling-in-prometheus-works/#internal-labels</a></li>
<li><a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#ec2_sd_config">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#ec2_sd_config</a></li>
<li><a href="https://regexr.com/">https://regexr.com/</a></li>
</ul>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/05/27/create-a-aws-lambda-layer-with-docker/">Create a AWS Lambda Layer With Docker</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-05-27T06:19:05-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>6:19 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will be creating a AWS Lambda Python <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html">Layer</a> that will include the Python Requests package and we will compile the package with Docker and the LambCI image.</p>

<h2>Getting Started</h2>

<p>First we will create the directory where we will store the intermediate data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir lambda-layers
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>lambda-layers
</span></code></pre></td></tr></table></div></figure>


<p>Then we will create the directory structure, as you can see I will be using the python 3.8 runtime:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p requests/python/lib/python3.8
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>requests
</span></code></pre></td></tr></table></div></figure>


<p>Write the dependencies to the requirements file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;requests&quot;</span> &gt; requirements.txt
</span></code></pre></td></tr></table></div></figure>


<p>Install dependencies locally using docker, where we will be using the <code>lambci/lambda:build-python3.8</code> iamge and we are mounting our current working directory to <code>/var/task</code> inside the container, and then we will be running the command <code>pip install -r requirements.txt -t python/lib/python3.7/site-packages/; exit</code> inside the container, which will essentially dump the content to our working directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run -v <span class="nv">$PWD</span>:/var/task <span class="se">\</span>
</span><span class='line'>   lambci/lambda:build-python3.8 <span class="se">\</span>
</span><span class='line'>   sh -c <span class="s2">&quot;pip install -r requirements.txt -t python/lib/python3.8/site-packages/; exit&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Zip up the deployment package that we will push to AWS Lambda Layers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>zip -r package.zip python &gt; /dev/null
</span></code></pre></td></tr></table></div></figure>


<p>Publish the layer using the aws cli tools, by specifying the deployment package, the compatible runtime and a identifier:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile dev lambda <span class="se">\</span>
</span><span class='line'>   publish-layer-version --layer-name python-requests <span class="se">\</span>
</span><span class='line'>   --description <span class="s2">&quot;Python Requests using 3.8 Runtime&quot;</span> <span class="se">\</span>
</span><span class='line'>   --zip-file fileb://package.zip <span class="se">\</span>
</span><span class='line'>   --compatible-runtime <span class="s2">&quot;python3.8&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then when you want to reference the layer on the functio that you want to create, you can do it like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws lambda create-function --function-name <span class="nb">test</span>-requests <span class="se">\</span>
</span><span class='line'>   --runtime python3.8 <span class="se">\</span>
</span><span class='line'>   --handler lambda_function.lambda_handler <span class="se">\</span>
</span><span class='line'>   --role <span class="s2">&quot;&quot;</span> --layers <span class="s2">&quot;arn:aws:lambda:eu-west-1:xxxxxxxxxxxx:layer:test-requests&quot;</span> <span class="se">\</span>
</span><span class='line'>   --code <span class="s2">&quot;S3Bucket=string,S3Key=string&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>

<p>Credit to <a href="https://oznetnerd.com/2020/11/11/lambda-packaging-the-right-way/">oznetnerd.com</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Carbon</h1>
  <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CEAIP2JL&placement=blogruanbekkercom" id="_carbonads_js"></script>
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>

<section>
  <h1>Say Hi!</h1>
  Send me a note using the <a href="https://saythanks.io/to/ruanbekker">saythanks.io</a> project.
</section>

<section>
  <h1>Newsletter</h1>
  View my newsletter on <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog" target="_blank">digests.ruanbekker.com</a>
</section>

<section>
  <h1>Cheetsheet Repository</h1>
  Have a look at my <strong>Cheetsheets Github Repository</strong>:
  <p></p>
  <a href="https://github.com/ruanbekker/cheatsheets" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719365-1d8a05e2-a0d3-4078-a84f-c691544e4b8f.png" width="480" height="240"></a>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/07/31/docker-multistage-builds-for-hugo/">Docker Multistage Builds for Hugo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/07/14/remote-builds-with-docker-contexts/">Remote Builds With Docker Contexts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/29/create-a-raid5-array-with-mdadm-on-linux/">Create a RAID5 Array With Mdadm on Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/23/install-a-specific-python-version-on-ubuntu/">Install a Specific Python Version on Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/15/how-to-persist-iptables-rules-after-reboots/">How to Persist Iptables Rules After Reboots</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest elasticsearch cheatsheet in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719853-fe9a50a4-03f2-4a26-a422-0deb946ca09c.png" width="480" height="240"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ruanbekker" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
