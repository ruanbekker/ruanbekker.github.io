
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In this tutorial, we will be issuing Let&rsquo;s Encrypt certificates using cert-manager on Kubernetes and we will be using the DNS Challenge with &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script async defer data-website-id="2cfa7c36-c1f7-48fd-949c-2e5e8a1d873d" src="https://umami-analytics.ruan.dev/umami.js"></script>

  <!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1100086574264181"
     crossorigin="anonymous"></script>

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->


  <!-- TEST https://ruan.dev/blog/// -->
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/12/22/how-to-use-cert-manager-dns-challenge-with-cloudflare-on-kubernetes-with-helm/">How to Use Cert-Manager DNS Challenge With Cloudflare on Kubernetes With Helm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-12-22T08:04:02-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2023</span></span> <span class='time'>8:04 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial, we will be issuing <a href="https://letsencrypt.org/docs/challenge-types/">Let&rsquo;s Encrypt</a> certificates using <a href="https://cert-manager.io/docs/">cert-manager</a> on <a href="https://kubernetes.io/">Kubernetes</a> and we will be using the <a href="https://letsencrypt.org/docs/challenge-types/#dns-01-challenge">DNS Challenge</a> with <a href="https://www.cloudflare.com/en-gb/">Cloudflare</a>.</p>

<p>The reason I am using DNS Challenge instead of HTTP Challenge is because the Kubernetes environment is local on my laptop and there isn&rsquo;t a direct HTTP route into my environment from the internet and I would like to not expose the endpoints to the public internet.</p>

<h2>Summary of what we will be doing</h2>

<p>We would like to have Let&rsquo;s Encrypt Certificates on our web application that will be issued by Cert-Manager using the DNS Challenge from CloudFlare.</p>

<p>Our ingress controller will be ingress-nginx and our endpoints will be private, as they will resolve to private IP addresses, hence the reason why we are using DNS validation instead of HTTP.</p>

<h2>Pre-Requisites</h2>

<p>To follow along in this tutorial you will need the following</p>

<ul>
<li><p><a href="https://blog.ruanbekker.com/blog/2022/09/20/kind-for-local-kubernetes-clusters/">https://blog.ruanbekker.com/blog/2022/09/20/kind-for-local-kubernetes-clusters/</a></p></li>
<li><p><a href="https://helm.sh/docs/intro/install/">Helm</a></p></li>
<li><p><a href="https://kubernetes.io/docs/tasks/tools/">Kubectl</a></p></li>
<li><p><a href="https://www.cloudflare.com/en-gb/">Cloudflare</a> Account</p></li>
<li><p>Patience (just kidding, I will try my best to make it easy)</p></li>
</ul>


<h2>Install a Kubernetes Cluster</h2>

<p>If you already have a Kubernetes Cluster, you can skip this step.</p>

<p>Define the <code>kind-config.yaml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Cluster</span>
</span><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind.x-k8s.io/v1alpha4</span>
</span><span class='line'><span class="l-Scalar-Plain">nodes</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">control-plane</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kindest/node:v1.26.6@sha256:6e2d8b28a5b601defe327b98bd1c2d1930b49e5d8c512e1895099e4504007adb</span>
</span><span class='line'>  <span class="l-Scalar-Plain">extraPortMappings</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">hostPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">TCP</span>
</span><span class='line'>    <span class="l-Scalar-Plain">listenAddress</span><span class="p-Indicator">:</span> <span class="s">&quot;0.0.0.0&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">hostPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">TCP</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then create the cluster with <code>kind</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kind create cluster --name example --config kind-config.yaml
</span></code></pre></td></tr></table></div></figure>


<h2>Nginx Ingress Controller</h2>

<p>First we need to install a ingress controller and I am opting in to use ingress-nginx, so first we need to add the helm repository to our local repositories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
</span></code></pre></td></tr></table></div></figure>


<p>Then we need to update our repositories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>helm repo update
</span></code></pre></td></tr></table></div></figure>


<p>Then we can install the helm release:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx <span class="se">\</span>
</span><span class='line'>  --namespace ingress-nginx <span class="se">\</span>
</span><span class='line'>  --create-namespace <span class="se">\</span>
</span><span class='line'>  --set controller.kind<span class="o">=</span>DaemonSet <span class="se">\</span>
</span><span class='line'>  --set controller.hostPort.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class='line'>  --set controller.ingressClass<span class="o">=</span>nginx
</span></code></pre></td></tr></table></div></figure>


<p>You can view all the default values from their GitHub repository where the chart is hosted:</p>

<ul>
<li><a href="https://github.com/kubernetes/ingress-nginx/blob/main/charts/ingress-nginx/values.yaml"><strong>https://github.com/kubernetes/ingress-nginx/blob/main/charts/ingress-nginx/values.yaml</strong></a></li>
</ul>


<p>Once the release has been deployed, you should see the ingress-nginx pod running under the <code>ingress-nginx</code> namespace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get pods -n ingress-nginx
</span></code></pre></td></tr></table></div></figure>


<h2>Cert-Manager</h2>

<p>The next step is to install cert-manager using helm, first add the repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>helm repo add jetstack https://charts.jetstack.io
</span></code></pre></td></tr></table></div></figure>


<p>Update the repositories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>helm repo update
</span></code></pre></td></tr></table></div></figure>


<p>Then install the cert-manager release:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>helm upgrade --install cert-manager jetstack/cert-manager <span class="se">\</span>
</span><span class='line'>  --namespace cert-manager <span class="se">\</span>
</span><span class='line'>  --create-namespace <span class="se">\</span>
</span><span class='line'>  --version v1.13.1 <span class="se">\</span>
</span><span class='line'>  --set <span class="nv">installCRDs</span><span class="o">=</span><span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Cloudflare API Token</h2>

<p>We need to grant Cert-Manager access to make DNS changes on our Cloudflare account for DNS validation on our behalf, and in order to do that, we need to create a Cloudflare API Token.</p>

<p>As per the <a href="https://cert-manager.io/docs/configuration/acme/dns01/cloudflare/#api-tokens">cert-manager documentation</a>, from your profile select <a href="https://dash.cloudflare.com/profile/api-tokens">API Tokens</a>, create an API Token and select <code>Edit Zone DNS</code> template.</p>

<p>Then select the following:</p>

<ul>
<li><p>Permissions:</p>

<ul>
<li><p>Zone: DNS -&gt; Edit</p></li>
<li><p>Zone: Zone -&gt; Read</p></li>
</ul>
</li>
<li><p>Zone Resources:</p>

<ul>
<li>Include -&gt; All Zones</li>
</ul>
</li>
</ul>


<p><img src="https://gitlab.com/bekker-space/workshops/ingress-nginx/uploads/c19d741352f767a1bfb97ef4fd716364/image.png%20align=" title="left" alt="" /></p>

<p>Then create the token and save the value somewhere safe, as we will be using it in the next step.</p>

<h2>Cert-Manager ClusterIssuer</h2>

<p>First, we need to create a Kubernetes secret with the API Token that we created in the previous step.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl create secret generic cloudflare-api-key-secret <span class="se">\</span>
</span><span class='line'>  --from-literal<span class="o">=</span>api-key<span class="o">=[</span>YOUR_CLOUDFLARE_API_KEY<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then create the <code>clusterissuer.yaml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cert-manager.io/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ClusterIssuer</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">letsencrypt-dns01-issuer</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">acme</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">server</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://acme-v02.api.letsencrypt.org/directory</span>
</span><span class='line'>    <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">you@example.com</span>  <span class="c1"># your email address for updates</span>
</span><span class='line'>    <span class="l-Scalar-Plain">privateKeySecretRef</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">letsencrypt-dns01-private-key</span>
</span><span class='line'>    <span class="l-Scalar-Plain">solvers</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">dns01</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">cloudflare</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">you@example.com</span> <span class="c1"># your cloudflare account email address</span>
</span><span class='line'>          <span class="l-Scalar-Plain">apiTokenSecretRef</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cloudflare-api-key-secret</span>
</span><span class='line'>            <span class="l-Scalar-Plain">key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">api-key</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then create the cluster issuer:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl apply -f clusterissuer.yaml
</span></code></pre></td></tr></table></div></figure>


<h2>Request a Certificate</h2>

<p>Now that we have our <code>ClusterIssuer</code> created, we can request a certificate. In my scenario, I have a domain <code>example.com</code> which is hosted on CloudFlare and I would like to create a wildcard certificate on the sub-domain <code>*.workshop.example.com</code></p>

<p>Certificates are scoped on a namespace level, and ClusterIssuer&rsquo;s are cluster-wide, therefore I am prefixing my certificate with the namespace (just my personal preference).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cert-manager.io/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Certificate</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default-workshop-certificate</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secretName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default-workshop-example-tls</span>
</span><span class='line'>  <span class="l-Scalar-Plain">issuerRef</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">letsencrypt-dns01-issuer</span>
</span><span class='line'>    <span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ClusterIssuer</span>
</span><span class='line'>  <span class="l-Scalar-Plain">commonName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">workshop.example.com</span>
</span><span class='line'>  <span class="l-Scalar-Plain">dnsNames</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">workshop.example.com</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&#39;*.workshop.example.com&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before we create the certificate on CloudFlare, I have created private DNS to the names mentioned in the manifest above like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>- workshop.example.com -&gt; A Record -&gt; 10.5.24.254
</span><span class='line'>- *.workshop.example.com -&gt; CNAME -&gt; workshop.example.com
</span></code></pre></td></tr></table></div></figure>


<p>In the DNS configuration mentioned above, to explain why I am creating 2 entries:</p>

<ul>
<li><p><code>10.2.24.254</code> - This is my LoadBalancer IP Address</p></li>
<li><p>I have a static DNS entry to the name <code>workshop.example.com</code> so if my LoadBalancer IP Address ever change, I can just change this address</p></li>
<li><p>I am creating a wildcard DNS entry for <code>*.workshop.example.com</code> and I am creating a CNAME record for it to resolve to <code>workshop.example.com</code> so it will essentially respond to the LoadBalancer IP.</p></li>
<li><p>So lets say I create <code>test1.workshop.example.com</code> and <code>test2.workshop.example.com</code> then it will resolve to the LoadBalancer IP in <code>workshop.example.com</code> and as mentioned before, if the LoadBalancer IP ever changes, I only have to update the A Record of <code>workshop.example.com</code></p></li>
</ul>


<p>Then after DNS was created, I went ahead and created the certificate:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl apply -f certificate.yaml
</span></code></pre></td></tr></table></div></figure>


<p>You can view the progress by viewing the certificate status by running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get certificate -n default
</span></code></pre></td></tr></table></div></figure>


<h2>Specify the Certificate in your Ingress</h2>

<p>Let&rsquo;s deploy a <code>nginx</code> web server deployment and I have concatenated the following in one manifest called <code>deployment.yaml</code>:</p>

<ul>
<li><p><code>Deployment</code></p></li>
<li><p><code>Service</code></p></li>
<li><p><code>Ingress</code></p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apps/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deployment</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-web</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-web</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">matchLabels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-web</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-web</span>
</span><span class='line'>    <span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx:1.19</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Service</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-web-service</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-web</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ClusterIP</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">targetPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-web</span>
</span><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Ingress</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-web-ingress</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">annotations</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">kubernetes.io/ingress.class</span><span class="p-Indicator">:</span> <span class="s">&quot;nginx&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx.workshop.example.com</span>
</span><span class='line'>    <span class="l-Scalar-Plain">http</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/</span>
</span><span class='line'>        <span class="l-Scalar-Plain">pathType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Prefix</span>
</span><span class='line'>        <span class="l-Scalar-Plain">backend</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx-web-service</span>
</span><span class='line'>            <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span>
</span><span class='line'>              <span class="l-Scalar-Plain">number</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tls</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nginx.workshop.example.com</span>
</span><span class='line'>    <span class="l-Scalar-Plain">secretName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default-workshop-example-tls</span>
</span></code></pre></td></tr></table></div></figure>


<p>A few important things to notice on the ingress resource:</p>

<ul>
<li><p><code>host</code> the host needs to match the certificate</p></li>
<li><p><code>secretName</code> the secret needs to match the secret defined in the certificate</p></li>
</ul>


<p>Then create the deployment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl apply -f deployment.yaml
</span></code></pre></td></tr></table></div></figure>


<h2>Ensure DNS Challenges are successful</h2>

<p>Ensure that cert-manager can set DNS-01 challenge records correctly, if you encounter issues, you can inspect the cert-manager pod logs.</p>

<p>To view the pods for cert-manager:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get pods -n cert-manager
</span></code></pre></td></tr></table></div></figure>


<p>Then view the logs using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl logs -f pod &lt;pod-id&gt; -n cert-manager
</span></code></pre></td></tr></table></div></figure>


<h2>Test</h2>

<p>You can open up a browser and access the ingress on your browser, in my case it would be <code>https://nginx.workshop.example.com</code> and verify that you have a certificate issued from Lets Encrypt.</p>

<h2>Thank You</h2>

<p>Thanks for reading, if you enjoy my content please feel free to follow me on <a href="https://twitter.com/ruanbekker"><strong>Twitter -</strong></a> @<a href="@ruanbekker">@ruanbekker</a> or visit me on my <a href="https://ruan.dev/"><strong>website -</strong></a> <a href="http://ruan.dev"><strong>ruan.dev</strong></a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/12/22/how-to-deploy-ingress-nginx-controller-on-kubernetes-with-helm/">How to Deploy Ingress-Nginx Controller on Kubernetes With Helm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-12-22T07:56:22-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2023</span></span> <span class='time'>7:56 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will deploy the <a href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a> controller on kubernetes.</p>

<h2>Pre-Requisites</h2>

<p>I will be using kind to run a kubernetes cluster locally, if you want to follow along, have a look at my previous post on how to install <a href="https://kubernetes.io/docs/tasks/tools/">kubectl</a> and kind and the basic usage of kind:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2022/09/20/kind-for-local-kubernetes-clusters/">https://blog.ruanbekker.com/blog/2022/09/20/kind-for-local-kubernetes-clusters/</a></li>
</ul>


<p>You will also need <a href="https://helm.sh/docs/intro/install/">helm</a> to deploy the ingress-nginx release from their helm charts, you can see their documentation on how to install it:</p>

<ul>
<li><a href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a></li>
</ul>


<h2>Create the Kubernetes Cluster</h2>

<p>First we will define the kind configuration which will expose port 80 locally in a file name <code>kind-config.yaml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Cluster</span>
</span><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind.x-k8s.io/v1alpha4</span>
</span><span class='line'><span class="l-Scalar-Plain">nodes</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">control-plane</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kindest/node:v1.25.11@sha256:227fa11ce74ea76a0474eeefb84cb75d8dad1b08638371ecf0e86259b35be0c8</span>
</span><span class='line'>  <span class="l-Scalar-Plain">extraPortMappings</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">hostPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">TCP</span>
</span><span class='line'>    <span class="l-Scalar-Plain">listenAddress</span><span class="p-Indicator">:</span> <span class="s">&quot;0.0.0.0&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">hostPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">TCP</span>
</span><span class='line'>  <span class="l-Scalar-Plain">kubeadmConfigPatches</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>    <span class="no">kind: InitConfiguration</span>
</span><span class='line'>    <span class="no">nodeRegistration:</span>
</span><span class='line'>      <span class="no">kubeletExtraArgs:</span>
</span><span class='line'>        <span class="no">node-labels: &quot;ingress-ready=true&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then go ahead and create the kubernetes cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kind create cluster --name workshop --config kind-config.yaml
</span></code></pre></td></tr></table></div></figure>


<h2>Install ingress-nginx using Helm</h2>

<p>Install the ingress-nginx helm chart, by first adding the repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
</span></code></pre></td></tr></table></div></figure>


<p>Then update your local repositories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>helm repo update
</span></code></pre></td></tr></table></div></figure>


<p>Then install the helm release, and set a couple of overrides.</p>

<p>The reason we use NodePort is because our kubernetes cluster runs on docker containers, and from our kind config we have exposed port 80 locally, we are using the NodePort service so that we can make an HTTP request to port 80 to traverse to the port of the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx <span class="se">\</span>
</span><span class='line'>  --namespace ingress-nginx --create-namespace <span class="se">\</span>
</span><span class='line'>  --set controller.kind<span class="o">=</span>DaemonSet <span class="se">\</span>
</span><span class='line'>  --set controller.hostPort.enabled<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class='line'>  --set controller.ingressClass<span class="o">=</span>nginx
</span></code></pre></td></tr></table></div></figure>


<p>You can view all the default values from their GitHub repository where the chart is hosted:</p>

<ul>
<li><a href="https://github.com/kubernetes/ingress-nginx/blob/main/charts/ingress-nginx/values.yaml">https://github.com/kubernetes/ingress-nginx/blob/main/charts/ingress-nginx/values.yaml</a></li>
</ul>


<p>Once the release has been deployed, you should see the ingress-nginx pod running under the <code>ingress-nginx</code> namespace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get pods -n ingress-nginx
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy a Web Application</h2>

<p>We will create 3 files:</p>

<ul>
<li><p><code>example/deployment.yaml</code></p></li>
<li><p><code>example/service.yaml</code></p></li>
<li><p><code>example/ingress.yaml</code></p></li>
</ul>


<p>Create the example directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir example
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>example/deployment.yaml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apps/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Deployment</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">matchLabels</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>    <span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ruanbekker/web-center-name-v2</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http</span>
</span><span class='line'>          <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5000</span>
</span><span class='line'>        <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">APP_TITLE</span>
</span><span class='line'>          <span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="s">&quot;Runs</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Kind&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">requests</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="s">&quot;64Mi&quot;</span>
</span><span class='line'>            <span class="l-Scalar-Plain">cpu</span><span class="p-Indicator">:</span> <span class="s">&quot;250m&quot;</span>
</span><span class='line'>          <span class="l-Scalar-Plain">limits</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="s">&quot;256Mi&quot;</span>
</span><span class='line'>            <span class="l-Scalar-Plain">cpu</span><span class="p-Indicator">:</span> <span class="s">&quot;1000m&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>example/service.yaml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Service</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ClusterIP</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http</span>
</span><span class='line'>      <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">TCP</span>
</span><span class='line'>      <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'>      <span class="l-Scalar-Plain">targetPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5000</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>example/ingress.yaml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">networking.k8s.io/v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Ingress</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>  <span class="l-Scalar-Plain">namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ingressClassName</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">example.127.0.0.1.nip.io</span>
</span><span class='line'>      <span class="l-Scalar-Plain">http</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pathType</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Prefix</span>
</span><span class='line'>            <span class="l-Scalar-Plain">backend</span><span class="p-Indicator">:</span>
</span><span class='line'>              <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span>
</span><span class='line'>                <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webapp</span>
</span><span class='line'>                <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span>
</span><span class='line'>                  <span class="l-Scalar-Plain">number</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'>            <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/</span>
</span></code></pre></td></tr></table></div></figure>


<p>In summary, we are creating a deployment with a pod that listens on port 5000, and then we are creating a service with port 80 that will forward its connections to the container port of 5000.</p>

<p>Then we define our ingress that will match our hostname and forward its connections to our service on port 80, and also notice that we are defining our ingress class name, which we have set in our helm values.</p>

<p>Deploy this example with kubectl:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectly apply -f example/
</span></code></pre></td></tr></table></div></figure>


<p>Now you can access the web application at <a href="http://example.127.0.0.1.nip.io">http://example.127.0.0.1.nip.io</a></p>

<h2>Teardown</h2>

<p>You can delete the resources that we&rsquo;ve created using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl delete -f example/
</span></code></pre></td></tr></table></div></figure>


<p>Delete the cluster using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kind delete cluster --name workshop
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you enjoy my content please feel free to follow me on <a href="https://twitter.com/ruanbekker"><strong>Twitter - @ruanbekker</strong></a> or visit me on my <a href="https://ruan.dev/"><strong>website -</strong></a> <a href="http://ruan.dev"><strong>ruan.dev</strong></a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/08/03/creating-a-python-lambda-function-with-terraform-on-aws/">Creating a Python Lambda Function With Terraform on AWS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-08-03T11:29:35-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2023</span></span> <span class='time'>11:29 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial I will explain how to deploy a AWS Lambda Function with Terraform using the Python runtime. It will include the permissions it needs to write its logs to AWS CloudWatch as well as to get information from the AWS API&rsquo;s as a boilerplate for you to expand on it.</p>

<p>We will also use CloudWatch Events to trigger this lambda function every two hours.</p>

<h2>Pre-Requisites</h2>

<p>First you will need to have <a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli">Terraform</a> installed as well as authentication for Terraform to interact with your AWS account, I have written a post about it and you can follow that on &ldquo;<a href="https://blog.ruanbekker.com/blog/2023/07/15/how-to-use-the-aws-terraform-provider/">How to use the AWS Terraform Provider</a>&rdquo;.</p>

<h2>Project Structure</h2>

<p>The following code will be available on my <a href="https://github.com/ruanbekker/terraformfiles/tree/master/modules/aws-lambda-function">github repository</a>, but if you would like to follow along we will create everything step by step.</p>

<p>First create the project directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p ~/workspace/aws-lambda-terraform
</span></code></pre></td></tr></table></div></figure>


<p>Then change into the directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ~/workspace/aws-lambda-terraform
</span></code></pre></td></tr></table></div></figure>


<p>First we want to create our modules directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p modules/lambda-function
</span></code></pre></td></tr></table></div></figure>


<p>Then our environment directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p environment/test
</span></code></pre></td></tr></table></div></figure>


<p>We will also create the directory for our function code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p modules/lambda-function/functions
</span></code></pre></td></tr></table></div></figure>


<p>And we can create the file for our python function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch modules/lambda-function/functions/demo.py
</span></code></pre></td></tr></table></div></figure>


<p>Now we will create our files inside our modules directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch modules/lambda-function/<span class="o">{</span>main,versions,outputs,variables<span class="o">}</span>.tf
</span></code></pre></td></tr></table></div></figure>


<p>Then create the files inside our environments directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch environment/test/<span class="o">{</span>main,provider,output<span class="o">}</span>.tf
</span></code></pre></td></tr></table></div></figure>


<p>Then in summary our project structure should look more or less like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tree .
</span><span class='line'>.
</span><span class='line'> environment
</span><span class='line'>  <span class="nb">test</span>
</span><span class='line'>      main.tf
</span><span class='line'>      output.tf
</span><span class='line'>      provider.tf
</span><span class='line'> modules
</span><span class='line'>     lambda-function
</span><span class='line'>         functions
</span><span class='line'>          demo.py
</span><span class='line'>         main.tf
</span><span class='line'>         outputs.tf
</span><span class='line'>         variables.tf
</span><span class='line'>         versions.tf
</span><span class='line'>
</span><span class='line'><span class="m">5</span> directories, <span class="m">8</span> files
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform Code</h2>

<p>We will first start populating the modules bit, and start with <code>modules/lambda-function/main.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>data <span class="s2">&quot;aws_iam_policy_document&quot;</span> <span class="s2">&quot;lambda&quot;</span> <span class="o">{</span>
</span><span class='line'>  statement <span class="o">{</span>
</span><span class='line'>    <span class="nv">actions</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;sts:AssumeRole&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    principals <span class="o">{</span>
</span><span class='line'>      <span class="nb">type</span>        <span class="o">=</span> <span class="s2">&quot;Service&quot;</span>
</span><span class='line'>      <span class="nv">identifiers</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;lambda.amazonaws.com&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;aws_iam_policy_document&quot;</span> <span class="s2">&quot;lambda_execution&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span> <span class="o">=</span> var.logs_enabled ? <span class="m">1</span> : 0
</span><span class='line'>
</span><span class='line'>  statement <span class="o">{</span>
</span><span class='line'>    <span class="nv">sid</span>     <span class="o">=</span> <span class="s2">&quot;GetCallerIdentity&quot;</span>
</span><span class='line'>    <span class="nv">effect</span>  <span class="o">=</span> <span class="s2">&quot;Allow&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">actions</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;sts:GetCallerIdentity&quot;</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">resources</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;*&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  statement <span class="o">{</span>
</span><span class='line'>    <span class="nv">sid</span>     <span class="o">=</span> <span class="s2">&quot;DescribeFunctionsInRegion&quot;</span>
</span><span class='line'>    <span class="nv">effect</span>  <span class="o">=</span> <span class="s2">&quot;Allow&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">actions</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;lambda:GetFunction&quot;</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">resources</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;*&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    condition <span class="o">{</span>
</span><span class='line'>      <span class="nb">test</span>     <span class="o">=</span> <span class="s2">&quot;StringEquals&quot;</span>
</span><span class='line'>      <span class="nv">variable</span> <span class="o">=</span> <span class="s2">&quot;aws:RequestedRegion&quot;</span>
</span><span class='line'>      <span class="nv">values</span> <span class="o">=</span> <span class="o">[</span>var.aws_region<span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_iam_role_policy&quot;</span> <span class="s2">&quot;lambda_execution_policy&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>  <span class="o">=</span> var.logs_enabled ? <span class="m">1</span> : 0
</span><span class='line'>  <span class="nv">name</span>   <span class="o">=</span> <span class="s2">&quot;${var.project_name}-lambda-function-execution-policy&quot;</span>
</span><span class='line'>  <span class="nv">role</span>   <span class="o">=</span> aws_iam_role.lambda_role<span class="o">[</span>count.index<span class="o">]</span>.id
</span><span class='line'>  <span class="nv">policy</span> <span class="o">=</span> data.aws_iam_policy_document.lambda_execution<span class="o">[</span>count.index<span class="o">]</span>.json
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;archive_file&quot;</span> <span class="s2">&quot;lambda_zip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> <span class="s2">&quot;zip&quot;</span>
</span><span class='line'>  <span class="nv">source_file</span> <span class="o">=</span> <span class="s2">&quot;${path.module}/functions/demo.py&quot;</span>
</span><span class='line'>  <span class="nv">output_path</span> <span class="o">=</span> <span class="s2">&quot;${path.module}/lambda-archives/package.zip&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_iam_role&quot;</span> <span class="s2">&quot;lambda_role&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>              <span class="o">=</span> var.logs_enabled ? <span class="m">1</span> : 0
</span><span class='line'>  <span class="nv">name</span>               <span class="o">=</span> <span class="s2">&quot;${var.project_name}-lambda-function-role&quot;</span>
</span><span class='line'>  <span class="nv">assume_role_policy</span> <span class="o">=</span> data.aws_iam_policy_document.lambda.json
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_lambda_function&quot;</span> <span class="s2">&quot;lambda&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>            <span class="o">=</span> var.logs_enabled ? <span class="m">1</span> : 0
</span><span class='line'>  <span class="nv">filename</span>         <span class="o">=</span> data.archive_file.lambda_zip.output_path
</span><span class='line'>  <span class="nv">function_name</span>    <span class="o">=</span> <span class="s2">&quot;${var.project_name}-lambda-function&quot;</span>
</span><span class='line'>  <span class="nv">role</span>             <span class="o">=</span> aws_iam_role.lambda_role<span class="o">[</span>count.index<span class="o">]</span>.arn
</span><span class='line'>  <span class="nv">handler</span>          <span class="o">=</span> <span class="s2">&quot;demo.lambda_handler&quot;</span>
</span><span class='line'>  <span class="nv">source_code_hash</span> <span class="o">=</span> filebase64sha256<span class="o">(</span>data.archive_file.lambda_zip.output_path<span class="o">)</span>
</span><span class='line'>  <span class="nv">runtime</span>          <span class="o">=</span> <span class="s2">&quot;python3.8&quot;</span>
</span><span class='line'>  <span class="nv">timeout</span>          <span class="o">=</span> 30
</span><span class='line'>
</span><span class='line'>  environment <span class="o">{</span>
</span><span class='line'>    <span class="nv">variables</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nv">PROJECT_NAME</span>  <span class="o">=</span> var.project_name
</span><span class='line'>      <span class="nv">FUNCTION_NAME</span> <span class="o">=</span> <span class="s2">&quot;${var.project_name}-lambda-function&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">depends_on</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    data.archive_file.lambda_zip
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_cloudwatch_event_rule&quot;</span> <span class="s2">&quot;every_two_hours&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>               <span class="o">=</span> var.logs_enabled ? <span class="m">1</span> : 0
</span><span class='line'>  <span class="nv">name</span>                <span class="o">=</span> <span class="s2">&quot;${var.project_name}-every-two-hours&quot;</span>
</span><span class='line'>  <span class="nv">description</span>         <span class="o">=</span> <span class="s2">&quot;Fires every 2 hours&quot;</span>
</span><span class='line'>  <span class="nv">schedule_expression</span> <span class="o">=</span> <span class="s2">&quot;rate(2 hours)&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_lambda_permission&quot;</span> <span class="s2">&quot;allow_cloudwatch&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>         <span class="o">=</span> var.logs_enabled ? <span class="m">1</span> : 0
</span><span class='line'>  <span class="nv">statement_id</span>  <span class="o">=</span> <span class="s2">&quot;AllowExecutionFromCloudWatch&quot;</span>
</span><span class='line'>  <span class="nv">action</span>        <span class="o">=</span> <span class="s2">&quot;lambda:InvokeFunction&quot;</span>
</span><span class='line'>  <span class="nv">function_name</span> <span class="o">=</span> aws_lambda_function.lambda<span class="o">[</span>count.index<span class="o">]</span>.function_name
</span><span class='line'>  <span class="nv">principal</span>     <span class="o">=</span> <span class="s2">&quot;events.amazonaws.com&quot;</span>
</span><span class='line'>  <span class="nv">source_arn</span>    <span class="o">=</span> aws_cloudwatch_event_rule.every_two_hours<span class="o">[</span>count.index<span class="o">]</span>.arn
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_cloudwatch_event_target&quot;</span> <span class="s2">&quot;cloudwatch_event&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>     <span class="o">=</span> var.logs_enabled ? <span class="m">1</span> : 0
</span><span class='line'>  <span class="nv">rule</span>      <span class="o">=</span> aws_cloudwatch_event_rule.every_two_hours<span class="o">[</span>count.index<span class="o">]</span>.name
</span><span class='line'>  <span class="nv">target_id</span> <span class="o">=</span> <span class="s2">&quot;${var.project_name}-snapshot-retention-target&quot;</span>
</span><span class='line'>  <span class="nv">arn</span>       <span class="o">=</span> aws_lambda_function.lambda<span class="o">[</span>count.index<span class="o">]</span>.arn
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>// CloudWatch Logs
</span><span class='line'>resource <span class="s2">&quot;aws_cloudwatch_log_group&quot;</span> <span class="s2">&quot;cloudwatch_log_group&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>     <span class="o">=</span> var.logs_enabled ? <span class="m">1</span> : 0
</span><span class='line'>  <span class="nv">name</span>      <span class="o">=</span> <span class="s2">&quot;/aws/lambda/${aws_lambda_function.lambda[count.index].function_name}&quot;</span>
</span><span class='line'>  <span class="nv">retention_in_days</span> <span class="o">=</span> 5
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_iam_role_policy_attachment&quot;</span> <span class="s2">&quot;lambda_exec_policy&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>      <span class="o">=</span> var.logs_enabled ? <span class="m">1</span> : 0
</span><span class='line'>  <span class="nv">role</span>       <span class="o">=</span> aws_iam_role.lambda_role<span class="o">[</span>count.index<span class="o">]</span>.name
</span><span class='line'>  <span class="nv">policy_arn</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next one will be the <code>modules/lambda-function/variables.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>variable <span class="s2">&quot;aws_region&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;eu-west-1&quot;</span>
</span><span class='line'>  <span class="nb">type</span>    <span class="o">=</span> string
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;project_name&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;example&quot;</span>
</span><span class='line'>  <span class="nb">type</span>    <span class="o">=</span> string
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;logs_enabled&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="nb">  type</span>    <span class="o">=</span> bool
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then define the modules output in <code>modules/lambda-function/outputs.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>output <span class="s2">&quot;arn_string&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> aws_lambda_function.lambda<span class="o">[</span>*<span class="o">]</span>.arn
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we define our python function code in <code>modules/lambda-function/functions/demo.py</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">logging</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'>
</span><span class='line'><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
</span><span class='line'><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span><span class='line'>    <span class="n">client</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;lambda&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_function</span><span class="p">(</span>
</span><span class='line'>        <span class="n">FunctionName</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;FUNCTION_NAME&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;statusCode&#39;</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;body&#39;</span><span class="p">:</span> <span class="n">response</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For our environment we want to specify the source as our module in <code>environment/test/main.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">module</span> <span class="s">&quot;myfunction&quot;</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">source</span>       <span class="o">=</span> <span class="s">&quot;../../modules/lambda-function&quot;</span>
</span><span class='line'>  <span class="n">project_name</span> <span class="o">=</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>  <span class="n">logs_enabled</span> <span class="o">=</span> <span class="n">true</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our outputs in <code>environment/test/output.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">output</span> <span class="s">&quot;arn_string&quot;</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">value</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">myfunction</span><span class="o">.</span><span class="n">arn_string</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And since we are using AWS, we need to define our providers and the profile that we will use to authenticate against AWS, in my case, im using the default profile in <code>environment/test/provider.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">terraform</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">required_providers</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">aws</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">source</span> <span class="o">=</span> <span class="s">&quot;hashicorp/aws&quot;</span>
</span><span class='line'>      <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;4.23.0&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">provider</span> <span class="s">&quot;aws&quot;</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">region</span>                   <span class="o">=</span> <span class="s">&quot;eu-west-1&quot;</span>
</span><span class='line'>  <span class="n">profile</span>                  <span class="o">=</span> <span class="s">&quot;default&quot;</span>
</span><span class='line'>  <span class="n">shared_credentials_files</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;~/.aws/credentials&quot;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform Plan</h2>

<p>Now that we have defined our terraform code we can run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform plan
</span></code></pre></td></tr></table></div></figure>


<p>And it should return something more or less like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span><span class='line'>  + create
</span><span class='line'>
</span><span class='line'>Terraform will perform the following actions:
</span><span class='line'>
</span><span class='line'>  <span class="c"># module.myfunction.aws_cloudwatch_event_rule.every_two_hours[0] will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;aws_cloudwatch_event_rule&quot;</span> <span class="s2">&quot;every_two_hours&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">arn</span>                 <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">description</span>         <span class="o">=</span> <span class="s2">&quot;Fires every 2 hours&quot;</span>
</span><span class='line'>      + <span class="nv">event_bus_name</span>      <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span class='line'>      + <span class="nv">id</span>                  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">is_enabled</span>          <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>      + <span class="nv">name</span>                <span class="o">=</span> <span class="s2">&quot;test-every-two-hours&quot;</span>
</span><span class='line'>      + <span class="nv">name_prefix</span>         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">schedule_expression</span> <span class="o">=</span> <span class="s2">&quot;rate(2 hours)&quot;</span>
</span><span class='line'>      + <span class="nv">tags_all</span>            <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># module.myfunction.aws_cloudwatch_event_target.cloudwatch_event[0] will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;aws_cloudwatch_event_target&quot;</span> <span class="s2">&quot;cloudwatch_event&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">arn</span>            <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">event_bus_name</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span class='line'>      + <span class="nv">id</span>             <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">rule</span>           <span class="o">=</span> <span class="s2">&quot;test-every-two-hours&quot;</span>
</span><span class='line'>      + <span class="nv">target_id</span>      <span class="o">=</span> <span class="s2">&quot;test-snapshot-retention-target&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># module.myfunction.aws_cloudwatch_log_group.cloudwatch_log_group[0] will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;aws_cloudwatch_log_group&quot;</span> <span class="s2">&quot;cloudwatch_log_group&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">arn</span>               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">id</span>                <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">name</span>              <span class="o">=</span> <span class="s2">&quot;/aws/lambda/test-lambda-function&quot;</span>
</span><span class='line'>      + <span class="nv">retention_in_days</span> <span class="o">=</span> 5
</span><span class='line'>      + <span class="nv">tags_all</span>          <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># module.myfunction.aws_iam_role.lambda_role[0] will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;aws_iam_role&quot;</span> <span class="s2">&quot;lambda_role&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">arn</span>                   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">assume_role_policy</span>    <span class="o">=</span> jsonencode<span class="o">(</span>
</span><span class='line'>            <span class="o">{</span>
</span><span class='line'>              + <span class="nv">Statement</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>                  + <span class="o">{</span>
</span><span class='line'>                      + <span class="nv">Action</span>   <span class="o">=</span> <span class="s2">&quot;sts:GetCallerIdentity&quot;</span>
</span><span class='line'>                      + <span class="nv">Effect</span>   <span class="o">=</span> <span class="s2">&quot;Allow&quot;</span>
</span><span class='line'>                      + <span class="nv">Resource</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>                      + <span class="nv">Sid</span>      <span class="o">=</span> <span class="s2">&quot;GetCallerIdentity&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                  + <span class="o">{</span>
</span><span class='line'>                      + <span class="nv">Action</span>    <span class="o">=</span> <span class="s2">&quot;lambda:GetFunction&quot;</span>
</span><span class='line'>                      + <span class="nv">Condition</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>                          + <span class="nv">StringEquals</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>                              + <span class="s2">&quot;aws:RequestedRegion&quot;</span> <span class="o">=</span> <span class="s2">&quot;eu-west-1&quot;</span>
</span><span class='line'>                            <span class="o">}</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                      + <span class="nv">Effect</span>    <span class="o">=</span> <span class="s2">&quot;Allow&quot;</span>
</span><span class='line'>                      + <span class="nv">Resource</span>  <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>                      + <span class="nv">Sid</span>       <span class="o">=</span> <span class="s2">&quot;DescribeFunctionsInRegion&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                <span class="o">]</span>
</span><span class='line'>              + <span class="nv">Version</span>   <span class="o">=</span> <span class="s2">&quot;2012-10-17&quot;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">)</span>
</span><span class='line'>      + <span class="nv">create_date</span>           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">force_detach_policies</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">id</span>                    <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">managed_policy_arns</span>   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">max_session_duration</span>  <span class="o">=</span> 3600
</span><span class='line'>      + <span class="nv">name</span>                  <span class="o">=</span> <span class="s2">&quot;test-lambda-function-role&quot;</span>
</span><span class='line'>      + <span class="nv">name_prefix</span>           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">path</span>                  <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
</span><span class='line'>      + <span class="nv">tags_all</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">unique_id</span>             <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># module.myfunction.aws_iam_role_policy.lambda_execution_policy[0] will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;aws_iam_role_policy&quot;</span> <span class="s2">&quot;lambda_execution_policy&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">id</span>     <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">name</span>   <span class="o">=</span> <span class="s2">&quot;test-lambda-function-execution-policy&quot;</span>
</span><span class='line'>      + <span class="nv">policy</span> <span class="o">=</span> jsonencode<span class="o">(</span>
</span><span class='line'>            <span class="o">{</span>
</span><span class='line'>              + <span class="nv">Statement</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>                  + <span class="o">{</span>
</span><span class='line'>                      + <span class="nv">Action</span>   <span class="o">=</span> <span class="s2">&quot;sts:GetCallerIdentity&quot;</span>
</span><span class='line'>                      + <span class="nv">Effect</span>   <span class="o">=</span> <span class="s2">&quot;Allow&quot;</span>
</span><span class='line'>                      + <span class="nv">Resource</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>                      + <span class="nv">Sid</span>      <span class="o">=</span> <span class="s2">&quot;GetCallerIdentity&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                  + <span class="o">{</span>
</span><span class='line'>                      + <span class="nv">Action</span>    <span class="o">=</span> <span class="s2">&quot;lambda:GetFunction&quot;</span>
</span><span class='line'>                      + <span class="nv">Condition</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>                          + <span class="nv">StringEquals</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>                              + <span class="s2">&quot;aws:RequestedRegion&quot;</span> <span class="o">=</span> <span class="s2">&quot;eu-west-1&quot;</span>
</span><span class='line'>                            <span class="o">}</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                      + <span class="nv">Effect</span>    <span class="o">=</span> <span class="s2">&quot;Allow&quot;</span>
</span><span class='line'>                      + <span class="nv">Resource</span>  <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>                      + <span class="nv">Sid</span>       <span class="o">=</span> <span class="s2">&quot;DescribeFunctionsInRegion&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                <span class="o">]</span>
</span><span class='line'>              + <span class="nv">Version</span>   <span class="o">=</span> <span class="s2">&quot;2012-10-17&quot;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">)</span>
</span><span class='line'>      + <span class="nv">role</span>   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># module.myfunction.aws_iam_role_policy_attachment.lambda_exec_policy[0] will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;aws_iam_role_policy_attachment&quot;</span> <span class="s2">&quot;lambda_exec_policy&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">id</span>         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">policy_arn</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span>
</span><span class='line'>      + <span class="nv">role</span>       <span class="o">=</span> <span class="s2">&quot;test-lambda-function-role&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># module.myfunction.aws_lambda_function.lambda[0] will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;aws_lambda_function&quot;</span> <span class="s2">&quot;lambda&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">architectures</span>                  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">arn</span>                            <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">filename</span>                       <span class="o">=</span> <span class="s2">&quot;../../modules/lambda-function/lambda-archives/package.zip&quot;</span>
</span><span class='line'>      + <span class="nv">function_name</span>                  <span class="o">=</span> <span class="s2">&quot;test-lambda-function&quot;</span>
</span><span class='line'>      + <span class="nv">handler</span>                        <span class="o">=</span> <span class="s2">&quot;demo.lambda_handler&quot;</span>
</span><span class='line'>      + <span class="nv">id</span>                             <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">invoke_arn</span>                     <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">last_modified</span>                  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">memory_size</span>                    <span class="o">=</span> 128
</span><span class='line'>      + <span class="nv">package_type</span>                   <span class="o">=</span> <span class="s2">&quot;Zip&quot;</span>
</span><span class='line'>      + <span class="nv">publish</span>                        <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">qualified_arn</span>                  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">reserved_concurrent_executions</span> <span class="o">=</span> -1
</span><span class='line'>      + <span class="nv">role</span>                           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">runtime</span>                        <span class="o">=</span> <span class="s2">&quot;python3.8&quot;</span>
</span><span class='line'>      + <span class="nv">signing_job_arn</span>                <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">signing_profile_version_arn</span>    <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">source_code_hash</span>               <span class="o">=</span> <span class="s2">&quot;MI7FD/KHgxRFh7cmPjzxg+w494pmyRGgQIr9Ls8Yups=&quot;</span>
</span><span class='line'>      + <span class="nv">source_code_size</span>               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">tags_all</span>                       <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">timeout</span>                        <span class="o">=</span> 30
</span><span class='line'>      + <span class="nv">version</span>                        <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>      + environment <span class="o">{</span>
</span><span class='line'>          + <span class="nv">variables</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>              + <span class="s2">&quot;FUNCTION_NAME&quot;</span> <span class="o">=</span> <span class="s2">&quot;test-lambda-function&quot;</span>
</span><span class='line'>              + <span class="s2">&quot;PROJECT_NAME&quot;</span>  <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># module.myfunction.aws_lambda_permission.allow_cloudwatch[0] will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;aws_lambda_permission&quot;</span> <span class="s2">&quot;allow_cloudwatch&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">action</span>              <span class="o">=</span> <span class="s2">&quot;lambda:InvokeFunction&quot;</span>
</span><span class='line'>      + <span class="nv">function_name</span>       <span class="o">=</span> <span class="s2">&quot;test-lambda-function&quot;</span>
</span><span class='line'>      + <span class="nv">id</span>                  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">principal</span>           <span class="o">=</span> <span class="s2">&quot;events.amazonaws.com&quot;</span>
</span><span class='line'>      + <span class="nv">source_arn</span>          <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">statement_id</span>        <span class="o">=</span> <span class="s2">&quot;AllowExecutionFromCloudWatch&quot;</span>
</span><span class='line'>      + <span class="nv">statement_id_prefix</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">8</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + <span class="nv">arn_string</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      + <span class="o">(</span>known after apply<span class="o">)</span>,
</span><span class='line'>    <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create Resources</h2>

<p>If you are happy with the plan you can go ahead and run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform apply
</span></code></pre></td></tr></table></div></figure>


<p>Which will create the resources in AWS. Upon creation we should see something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Apply <span class="nb">complete</span>! Resources: <span class="m">0</span> added, <span class="m">1</span> changed, <span class="m">0</span> destroyed.
</span><span class='line'>
</span><span class='line'>Outputs:
</span><span class='line'>
</span><span class='line'><span class="nv">arn_string</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>  <span class="s2">&quot;arn:aws:lambda:eu-west-1:000000000000:function:test-lambda-function&quot;</span>,
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since we have our aws cli configured with a profile we can also test our lambda function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile default lambda invoke --function-name <span class="nb">test</span>-lambda-function --cli-binary-format raw-in-base64-out --payload <span class="s1">&#39;{&quot;name&quot;: &quot;ruan&quot;}&#39;</span> out.log
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;StatusCode&quot;</span>: 200,
</span><span class='line'>    <span class="s2">&quot;ExecutedVersion&quot;</span>: <span class="s2">&quot;$LATEST&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the response from the invocation can be seen in the file we defined:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat out.log
</span><span class='line'><span class="o">{</span><span class="s2">&quot;statusCode&quot;</span>: 200, <span class="s2">&quot;body&quot;</span>: <span class="o">{</span><span class="s2">&quot;ResponseMetadata&quot;</span>: <span class="o">{</span><span class="s2">&quot;RequestId&quot;</span>: <span class="s2">&quot;5171x&quot;</span>, <span class="s2">&quot;HTTPStatusCode&quot;</span>: 200, <span class="s2">&quot;HTTPHeaders&quot;</span>: <span class="o">{</span><span class="s2">&quot;date&quot;</span>: <span class="s2">&quot;Thu, 21 Dec 2023 06:34:13 GMT&quot;</span>, <span class="s2">&quot;content-type&quot;</span>: <span class="s2">&quot;application/json&quot;</span>, <span class="s2">&quot;content-length&quot;</span>: <span class="s2">&quot;3517&quot;</span>, <span class="s2">&quot;connection&quot;</span>: <span class="s2">&quot;keep-alive&quot;</span>, <span class="s2">&quot;x-amzn-requestid&quot;</span>: <span class="s2">&quot;5171x&quot;</span><span class="o">}</span>, <span class="s2">&quot;RetryAttempts&quot;</span>: 0<span class="o">}</span>, <span class="s2">&quot;Configuration&quot;</span>: <span class="o">{</span><span class="s2">&quot;FunctionName&quot;</span>: <span class="s2">&quot;test-lambda-function&quot;</span>, <span class="s2">&quot;FunctionArn&quot;</span>: <span class="s2">&quot;arn:aws:lambda:eu-west-1:000000000000:function:test-lambda-function&quot;</span>, <span class="s2">&quot;Runtime&quot;</span>: <span class="s2">&quot;python3.8&quot;</span>, <span class="s2">&quot;Role&quot;</span>: <span class="s2">&quot;arn:aws:iam::000000000000:role/test-lambda-function-role&quot;</span>, <span class="s2">&quot;Handler&quot;</span>: <span class="s2">&quot;demo.lambda_handler&quot;</span>, <span class="s2">&quot;CodeSize&quot;</span>: 401, <span class="s2">&quot;Description&quot;</span>: <span class="s2">&quot;&quot;</span>, <span class="s2">&quot;Timeout&quot;</span>: 30, <span class="s2">&quot;MemorySize&quot;</span>: 128, <span class="s2">&quot;LastModified&quot;</span>: <span class="s2">&quot;2023-12-21T06:26:46.000+0000&quot;</span>, <span class="s2">&quot;CodeSha256&quot;</span>: <span class="s2">&quot;x&quot;</span>, <span class="s2">&quot;Version&quot;</span>: <span class="s2">&quot;$LATEST&quot;</span>, <span class="s2">&quot;Environment&quot;</span>: <span class="o">{</span><span class="s2">&quot;Variables&quot;</span>: <span class="o">{</span><span class="s2">&quot;FUNCTION_NAME&quot;</span>: <span class="s2">&quot;test-lambda-function&quot;</span>, <span class="s2">&quot;PROJECT_NAME&quot;</span>: <span class="s2">&quot;test&quot;</span><span class="o">}}</span>, <span class="s2">&quot;TracingConfig&quot;</span>: <span class="o">{</span><span class="s2">&quot;Mode&quot;</span>: <span class="s2">&quot;PassThrough&quot;</span><span class="o">}</span>, <span class="s2">&quot;RevisionId&quot;</span>: <span class="s2">&quot;7faex&quot;</span>, <span class="s2">&quot;State&quot;</span>: <span class="s2">&quot;Active&quot;</span>, <span class="s2">&quot;LastUpdateStatus&quot;</span>: <span class="s2">&quot;Successful&quot;</span>, <span class="s2">&quot;PackageType&quot;</span>: <span class="s2">&quot;Zip&quot;</span>, <span class="s2">&quot;Architectures&quot;</span>: <span class="o">[</span><span class="s2">&quot;x86_64&quot;</span><span class="o">]</span>, <span class="s2">&quot;EphemeralStorage&quot;</span>: <span class="o">{</span><span class="s2">&quot;Size&quot;</span>: 512<span class="o">}</span>, <span class="s2">&quot;SnapStart&quot;</span>: <span class="o">{</span><span class="s2">&quot;ApplyOn&quot;</span>: <span class="s2">&quot;None&quot;</span>, <span class="s2">&quot;OptimizationStatus&quot;</span>: <span class="s2">&quot;Off&quot;</span><span class="o">}</span>, <span class="s2">&quot;RuntimeVersionConfig&quot;</span>: <span class="o">{</span><span class="s2">&quot;RuntimeVersionArn&quot;</span>: <span class="s2">&quot;arn:aws:lambda:eu-west-1::runtime:x&quot;</span><span class="o">}}</span>, <span class="s2">&quot;Code&quot;</span>: <span class="o">{</span><span class="s2">&quot;RepositoryType&quot;</span>: <span class="s2">&quot;S3&quot;</span>, <span class="s2">&quot;Location&quot;</span>: <span class="s2">&quot;https://awslambda-eu-west-1-tasks.s3.eu-west-1.amazonaws.com/snapshots/x/test-lambda-function-x?queryparameters&quot;</span><span class="o">}}}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Updating Lambda Function Code</h2>

<p>If we want to redeploy our function with updated code, we can change the content of <code>functions/demo.py</code> and then run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform apply
</span></code></pre></td></tr></table></div></figure>


<p>Since our terraform code defined that if the source has of the function code changes, it will trigger a redeploy, and from the computed plan we can see that it will redeploy our function code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span><span class='line'>  ~ update in-place
</span><span class='line'>
</span><span class='line'>Terraform will perform the following actions:
</span><span class='line'>
</span><span class='line'>  <span class="c"># module.myfunction.aws_lambda_function.lambda[0] will be updated in-place</span>
</span><span class='line'>  ~ resource <span class="s2">&quot;aws_lambda_function&quot;</span> <span class="s2">&quot;lambda&quot;</span> <span class="o">{</span>
</span><span class='line'>        <span class="nv">id</span>                             <span class="o">=</span> <span class="s2">&quot;test-lambda-function&quot;</span>
</span><span class='line'>      ~ <span class="nv">last_modified</span>                  <span class="o">=</span> <span class="s2">&quot;2023-12-21T06:26:46.000+0000&quot;</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      ~ <span class="nv">source_code_hash</span>               <span class="o">=</span> <span class="s2">&quot;8TLrm4GmTrfAxwfElmIjws1Vf9UDZ6k2w1+VEONJaCQ=&quot;</span> -&gt; <span class="s2">&quot;RIQ62KCcjlcHh5lLCOlrkB7GioBpLY1Y5vN4UZGyN+c=&quot;</span>
</span><span class='line'>        <span class="nv">tags</span>                           <span class="o">=</span> <span class="o">{}</span>
</span><span class='line'>        <span class="c"># (18 unchanged attributes hidden)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># (3 unchanged blocks hidden)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">0</span> to add, <span class="m">1</span> to change, <span class="m">0</span> to destroy.
</span><span class='line'>
</span><span class='line'>Do you want to perform these actions?
</span><span class='line'>  Terraform will perform the actions described above.
</span><span class='line'>  Only <span class="s1">&#39;yes&#39;</span> will be accepted to approve.
</span><span class='line'>
</span><span class='line'>  Enter a value:
</span></code></pre></td></tr></table></div></figure>


<p>After entering &ldquo;yes&rdquo; we will update our function code</p>

<h2>Discover AWS Console</h2>

<p>If we logon to the AWS Console and head to Lambda we can inspect our function code:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker/assets/567298/2326b074-fa5b-443c-8715-59451293ccb2" alt="image" /></p>

<p>If we manually want to trigger the function, select &ldquo;Test&rdquo;, then enter the &ldquo;Event name&rdquo; with something like &ldquo;testing&rdquo; then click &ldquo;Test&rdquo;:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker/assets/567298/76bcde33-185f-47ed-a70c-4d967df80e92" alt="image" /></p>

<p>If we follow the CloudWatch log link we can view the logs in CloudWatch:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker/assets/567298/f5483602-3144-48ce-98bf-d50f625cdd92" alt="image" /></p>

<h2>Destroy Infrastructure</h2>

<p>If you followed along and would like to destroy the created infrastructure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform destroy
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p>Terraform Examples</p>

<ul>
<li><a href="https://github.com/ruanbekker/terraformfiles/tree/master/modules/aws-lambda-function">https://github.com/ruanbekker/terraformfiles/tree/master/modules/aws-lambda-function</a></li>
</ul>


<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>

<ul>
<li>Linktree: <a href="https://go.ruan.dev/links">https://go.ruan.dev/links</a></li>
<li>Patreon: <a href="https://go.ruan.dev/patreon">https://go.ruan.dev/patreon</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/07/15/how-to-use-the-mysql-terraform-provider/">How to Use the MySQL Terraform Provider</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-07-15T20:55:23-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>8:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will provision a MySQL Server with Docker and then use Terraform to provision MySQL Users, Database Schemas and MySQL Grants with the MySQL Terraform Provider.</p>

<h2>About</h2>

<p>Terraform is super powerful and can do a lot of things. And it shines when it provisions Infrastructure. So in a scenario where we use Terraform to provision RDS MySQL Database Instances, we might still want to provision extra MySQL Users, or Database Schemas and the respective MySQL Grants.</p>

<p>Usually you will logon to the database and create them manually with sql syntax. But in this tutorial we want to make use of Docker to provision our MySQL Server and we would like to make use of Terraform to provision the MySQL Database Schemas, Grants and Users.</p>

<p>Instead of using AWS RDS, I will be provisioning a MySQL Server on Docker so that we can keep the costs free, for those who are following along.</p>

<p>We will also go through the steps on how to rotate the database password that we will be provisioning for our user.</p>

<h2>MySQL Server</h2>

<p>First we will provision a MySQL Server on Docker Containers, I have a <code>docker-compose.yaml</code> which is available in my <a href="https://github.com/ruanbekker/quick-starts/blob/main/docker/mysql/docker-compose.yaml">quick-starts</a> github repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.8&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">mysql</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql:8.0</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3306:3306</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_DATABASE=sample</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD=rootpassword</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you have saved that in your current working directory, you can start the container with docker compose:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>


<p>You can test the mysql container by logging onto the mysql server with the correct auth:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker <span class="nb">exec</span> -it mysql mysql -u root -prootpassword -e <span class="s1">&#39;show databases;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This should be more or less the output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">+</span><span class="c1">--------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="k">Database</span>           <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">--------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">sample</span>             <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">sys</span>                <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">--------------------+</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform</h2>

<p>If you don&rsquo;t have Terraform installed, you can install it from their <a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli">documentation</a>.</p>

<p>If you want the source code of this example, its available in my <a href="https://github.com/ruanbekker/quick-starts/tree/main/terraform/mysql/petoju-provider">terraform-mysql/petoju-provider</a> repository. Which you can clone and jump into the <code>terraform/mysql/petoju-provider</code> directory.</p>

<p>First we will define the <code>providers.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">mysql</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;petoju/mysql&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;3.0.37&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;mysql&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">alias</span>    <span class="o">=</span> <span class="s2">&quot;local&quot;</span>
</span><span class='line'>  <span class="nv">endpoint</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1:3306&quot;</span>
</span><span class='line'>  <span class="nv">username</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>  <span class="nv">password</span> <span class="o">=</span> <span class="s2">&quot;rootpassword&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then the <code>main.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;random_password&quot;</span> <span class="s2">&quot;user_password&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">length</span>           <span class="o">=</span> 24
</span><span class='line'>  <span class="nv">special</span>          <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">min_special</span>      <span class="o">=</span> 2
</span><span class='line'>  <span class="nv">override_special</span> <span class="o">=</span> <span class="s2">&quot;!#$%^&amp;*()-_=+[]{}&lt;&gt;:?&quot;</span>
</span><span class='line'>  <span class="nv">keepers</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">password_version</span> <span class="o">=</span> var.password_version
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;mysql_database&quot;</span> <span class="s2">&quot;user_db&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">provider</span> <span class="o">=</span> mysql.local
</span><span class='line'>  <span class="nv">name</span> <span class="o">=</span> var.database_name
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;mysql_user&quot;</span> <span class="s2">&quot;user_id&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">provider</span> <span class="o">=</span> mysql.local
</span><span class='line'>  <span class="nv">user</span> <span class="o">=</span> var.database_username
</span><span class='line'>  <span class="nv">plaintext_password</span> <span class="o">=</span> random_password.user_password.result
</span><span class='line'>  <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'>  <span class="nv">tls_option</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;mysql_grant&quot;</span> <span class="s2">&quot;user_id&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">provider</span> <span class="o">=</span> mysql.local
</span><span class='line'>  <span class="nv">user</span> <span class="o">=</span> var.database_username
</span><span class='line'>  <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'>  <span class="nv">database</span> <span class="o">=</span> var.database_name
</span><span class='line'>  <span class="nv">privileges</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;SELECT&quot;</span>, <span class="s2">&quot;UPDATE&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="nv">depends_on</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    mysql_user.user_id
</span><span class='line'>  <span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then the <code>variables.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>variable <span class="s2">&quot;database_name&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;The name of the database that you want created.&quot;</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">default</span>     <span class="o">=</span> null
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;database_username&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;The name of the database username that you want created.&quot;</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">default</span>     <span class="o">=</span> null
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;password_version&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;The password rotates when this value gets updated.&quot;</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> number
</span><span class='line'>  <span class="nv">default</span>     <span class="o">=</span> 0
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then our <code>outputs.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>output <span class="s2">&quot;user&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> mysql_user.user_id.user
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;password&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">sensitive</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">value</span> <span class="o">=</span> random_password.user_password.result
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>terraform.tfvars</code> that defines the values of our variables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">database_name</span>     <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
</span><span class='line'><span class="nv">database_username</span> <span class="o">=</span> <span class="s2">&quot;ruanb&quot;</span>
</span><span class='line'><span class="nv">password_version</span>  <span class="o">=</span> 0
</span></code></pre></td></tr></table></div></figure>


<p>Now we are ready to run our terraform code, which will ultimately create a database, user and grants. Outputs the encrypted string of your password which was encrypted with your <code>keybase_username</code>.</p>

<p>Initialise Terraform:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Run the plan to see what terraform wants to provision:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform plan
</span></code></pre></td></tr></table></div></figure>


<p>And we can see the following resources will be created:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span><span class='line'>  + create
</span><span class='line'>
</span><span class='line'>Terraform will perform the following actions:
</span><span class='line'>
</span><span class='line'>  <span class="c"># mysql_database.user_db will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;mysql_database&quot;</span> <span class="s2">&quot;user_db&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">default_character_set</span> <span class="o">=</span> <span class="s2">&quot;utf8mb4&quot;</span>
</span><span class='line'>      + <span class="nv">default_collation</span>     <span class="o">=</span> <span class="s2">&quot;utf8mb4_general_ci&quot;</span>
</span><span class='line'>      + <span class="nv">id</span>                    <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">name</span>                  <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># mysql_grant.user_id will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;mysql_grant&quot;</span> <span class="s2">&quot;user_id&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">database</span>   <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
</span><span class='line'>      + <span class="nv">grant</span>      <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">host</span>       <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'>      + <span class="nv">id</span>         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">privileges</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>          + <span class="s2">&quot;SELECT&quot;</span>,
</span><span class='line'>          + <span class="s2">&quot;UPDATE&quot;</span>,
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>      + <span class="nv">table</span>      <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>      + <span class="nv">tls_option</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>
</span><span class='line'>      + <span class="nv">user</span>       <span class="o">=</span> <span class="s2">&quot;ruanb&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># mysql_user.user_id will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;mysql_user&quot;</span> <span class="s2">&quot;user_id&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">host</span>               <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
</span><span class='line'>      + <span class="nv">id</span>                 <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">plaintext_password</span> <span class="o">=</span> <span class="o">(</span>sensitive value<span class="o">)</span>
</span><span class='line'>      + <span class="nv">tls_option</span>         <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>
</span><span class='line'>      + <span class="nv">user</span>               <span class="o">=</span> <span class="s2">&quot;ruanb&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># random_password.user_password will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;random_password&quot;</span> <span class="s2">&quot;user_password&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">bcrypt_hash</span>      <span class="o">=</span> <span class="o">(</span>sensitive value<span class="o">)</span>
</span><span class='line'>      + <span class="nv">id</span>               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">keepers</span>          <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>          + <span class="s2">&quot;password_version&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      + <span class="nv">length</span>           <span class="o">=</span> 24
</span><span class='line'>      + <span class="nv">lower</span>            <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>      + <span class="nv">min_lower</span>        <span class="o">=</span> 0
</span><span class='line'>      + <span class="nv">min_numeric</span>      <span class="o">=</span> 0
</span><span class='line'>      + <span class="nv">min_special</span>      <span class="o">=</span> 2
</span><span class='line'>      + <span class="nv">min_upper</span>        <span class="o">=</span> 0
</span><span class='line'>      + <span class="nv">number</span>           <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>      + <span class="nv">numeric</span>          <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>      + <span class="nv">override_special</span> <span class="o">=</span> <span class="s2">&quot;!#$%^&amp;*()-_=+[]{}&lt;&gt;:?&quot;</span>
</span><span class='line'>      + <span class="nv">result</span>           <span class="o">=</span> <span class="o">(</span>sensitive value<span class="o">)</span>
</span><span class='line'>      + <span class="nv">special</span>          <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>      + <span class="nv">upper</span>            <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">4</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + <span class="nv">password</span> <span class="o">=</span> <span class="o">(</span>sensitive value<span class="o">)</span>
</span><span class='line'>  + <span class="nv">user</span>     <span class="o">=</span> <span class="s2">&quot;ruanb&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the apply which will create the database, the user, sets the password and applies the grants:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform apply
</span></code></pre></td></tr></table></div></figure>


<p>Then our returned output should show something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Apply <span class="nb">complete</span>! Resources: <span class="m">4</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span><span class='line'>
</span><span class='line'>Outputs:
</span><span class='line'>
</span><span class='line'><span class="nv">password</span> <span class="o">=</span> &lt;sensitive&gt;
</span><span class='line'><span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;ruanb&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As our password is set as sensitive, we can access the value with <code>terraform output -raw password</code>, let&rsquo;s assign the password to a variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">DBPASS</span><span class="o">=</span><span class="k">$(</span>terraform output -raw password<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we can exec into the mysql container and logon to the mysql server with our new credentials:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker <span class="nb">exec</span> -it mysql mysql -u ruanb -p<span class="nv">$DBPASS</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we can see we are logged onto the mysql server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span><span class='line'>Your MySQL connection id is 14
</span><span class='line'>Server version: 8.0.33 MySQL Community Server - GPL
</span><span class='line'>
</span><span class='line'>mysql&gt;
</span></code></pre></td></tr></table></div></figure>


<p>If we run <code>show databases;</code> we should see the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">show</span> <span class="n">databases</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span><span class="c1">--------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="k">Database</span>           <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">--------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">foobar</span>             <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">--------------------+</span>
</span><span class='line'><span class="mi">3</span> <span class="k">rows</span> <span class="k">in</span> <span class="k">set</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">03</span> <span class="n">sec</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we want to rotate the mysql password for the user, we can update the <code>password_version</code> variable either in our <code>terraform.tfvars</code> or via the cli. Let&rsquo;s pass the variable in the cli and do a <code>terraform plan</code> to verify the changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform plan -var <span class="nv">password_version</span><span class="o">=</span>1
</span></code></pre></td></tr></table></div></figure>


<p>And due to our value for the random resource keepers parameter being updated, it will trigger the value of our password to be changed, and that will let terraform update our mysql user&rsquo;s password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span><span class='line'>  ~ update in-place
</span><span class='line'>-/+ destroy and <span class="k">then</span> create replacement
</span><span class='line'>
</span><span class='line'>Terraform will perform the following actions:
</span><span class='line'>
</span><span class='line'>  <span class="c"># mysql_user.user_id will be updated in-place</span>
</span><span class='line'>  ~ resource <span class="s2">&quot;mysql_user&quot;</span> <span class="s2">&quot;user_id&quot;</span> <span class="o">{</span>
</span><span class='line'>        <span class="nv">id</span>                 <span class="o">=</span> <span class="s2">&quot;ruanb@%&quot;</span>
</span><span class='line'>      ~ <span class="nv">plaintext_password</span> <span class="o">=</span> <span class="o">(</span>sensitive value<span class="o">)</span>
</span><span class='line'>        <span class="c"># (5 unchanged attributes hidden)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># random_password.user_password must be replaced</span>
</span><span class='line'>-/+ resource <span class="s2">&quot;random_password&quot;</span> <span class="s2">&quot;user_password&quot;</span> <span class="o">{</span>
</span><span class='line'>      ~ <span class="nv">bcrypt_hash</span>      <span class="o">=</span> <span class="o">(</span>sensitive value<span class="o">)</span>
</span><span class='line'>      ~ <span class="nv">id</span>               <span class="o">=</span> <span class="s2">&quot;none&quot;</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      ~ <span class="nv">keepers</span>          <span class="o">=</span> <span class="o">{</span> <span class="c"># forces replacement</span>
</span><span class='line'>          ~ <span class="s2">&quot;password_version&quot;</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> -&gt; <span class="s2">&quot;1&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      ~ <span class="nv">result</span>           <span class="o">=</span> <span class="o">(</span>sensitive value<span class="o">)</span>
</span><span class='line'>        <span class="c"># (11 unchanged attributes hidden)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">1</span> to add, <span class="m">1</span> to change, <span class="m">1</span> to destroy.
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s go ahead by updating our password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform apply -var <span class="nv">password_version</span><span class="o">=</span><span class="m">1</span> -auto-approve
</span></code></pre></td></tr></table></div></figure>


<p>To validate that the password has changed, we can try to logon to mysql by using the password variable that was created initially:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker <span class="nb">exec</span> -it mysql mysql -u ruanb -p<span class="nv">$DBPASS</span>
</span></code></pre></td></tr></table></div></figure>


<p>And as you can see authentication failed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mysql: <span class="o">[</span>Warning<span class="o">]</span> Using a password on the <span class="nb">command </span>line interface can be insecure.
</span><span class='line'>ERROR <span class="m">1045</span> <span class="o">(</span>28000<span class="o">)</span>: Access denied <span class="k">for</span> user <span class="s1">&#39;ruanb&#39;</span>@<span class="s1">&#39;localhost&#39;</span> <span class="o">(</span>using password: YES<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set the new password to the variable again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">DBPASS</span><span class="o">=</span><span class="k">$(</span>terraform output -raw password<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then try to logon again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker <span class="nb">exec</span> -it mysql mysql -u ruanb -p<span class="nv">$DBPASS</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we can see we are logged on again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span><span class='line'>Your MySQL connection id is 22
</span><span class='line'>Server version: 8.0.33 MySQL Community Server - GPL
</span><span class='line'>
</span><span class='line'>mysql&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p>The terraform mysql provider:
- <a href="https://registry.terraform.io/providers/petoju/mysql/latest/docs">https://registry.terraform.io/providers/petoju/mysql/latest/docs</a></p>

<p>The quick-starts repository:
- <a href="https://github.com/ruanbekker/quick-starts">https://github.com/ruanbekker/quick-starts</a></p>

<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>

<ul>
<li>Linktree: <a href="https://go.ruan.dev/links">https://go.ruan.dev/links</a></li>
<li>Patreon: <a href="https://go.ruan.dev/patreon">https://go.ruan.dev/patreon</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/07/15/how-to-use-the-aws-terraform-provider/">How to Use the AWS Terraform Provider</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-07-15T20:01:13-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>8:01 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we will be using the AWS Terraform provider, from how to install Terraform, create a AWS IAM User, configure the AWS Provider and deploy a EC2 instance using Terraform.</p>

<h2>AWS IAM User</h2>

<p>In order to authenticate against AWSs APIs, we need to create a AWS IAM User and create Access Keys for Terraform to use to authenticate.</p>

<p>From <a href="https://aws.amazon.com/">https://aws.amazon.com/</a> logon to your account, then search for IAM:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/c53d15d3-1af2-4e15-aafb-229cc4274bf5" alt="aws-iam-search-result" /></p>

<p>Select IAM, then select Users on the left hand side and select Create User, then provide the username for your AWS IAM User:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/35f74a94-98d3-44c4-9651-a504780e5a6e" alt="aws-iam-user-creation-wizard" /></p>

<p>Now we need to assign permissions to our new AWS IAM User. For this scenario I will be assigning a IAM Policy directly to the user and I will be selecting the AdministratorAccess policy. Keep in mind that this allows admin access to your whole AWS account:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/779f2dac-0da9-4751-8e89-2ff33c088ae8" alt="permissions-for-your-aws-iam-user" /></p>

<p>Once you select the policy, select Next and select Create User. Once the user has been created, select Users on the left hand side, search for your user that we created, in my case medium-terraform.</p>

<p>Select the user and click on Security credentials. If you scroll down to the Access keys section, you will notice we dont have any access keys for this user:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/45b5eb1f-999f-4e81-b439-9e8cd90f83a3" alt="aws-iam-access-keys" /></p>

<p>In order to allow Terraform access to our AWS Account, we need to create access keys that Terraform will use, and because we assigned full admin access to the user, Terraform will be able to manage resources in our AWS Account.</p>

<p>Click Create access key, then select the CLI option and select the confirmation at the bottom:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/22b13879-6256-4de8-ab5f-aecece3be432" alt="aws-iam-access-keys-wizard" /></p>

<p>Select Next and then select Create access key. I am providing a screenshot of the Access Key and Secret Access Key that has been provided, but by the time this post has been published, the key will be deleted.</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/a7a4124f-dc9c-4700-b0ed-d21d7df4fa6c" alt="retrieve-aws-iam-access-keys" /></p>

<p>Store your Access Key and Secret Access Key in a secure place and treat this like your passwords. If someone gets access to these keys they can manage your whole AWS Account.</p>

<p>I will be using the <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html">AWS CLI</a> to configure my Access Key and Secret Access Key, as I will configure Terraform later to read my Access Keys from the Credential Provider config.</p>

<p>First we need to configure the AWS CLI by passing the profile name, which I have chosen <code>medium</code> for this demonstration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>aws --profile medium configure
</span></code></pre></td></tr></table></div></figure>


<p>We will be asked to provide the access key, secret access key, aws region and the default output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>AWS Access Key ID <span class="o">[</span>None<span class="o">]</span>: AKIATPRT2G4SGXLAC3HJ
</span><span class='line'>AWS Secret Access Key <span class="o">[</span>None<span class="o">]</span>: KODnR<span class="o">[</span>............<span class="o">]</span>nYTYbd
</span><span class='line'>Default region name <span class="o">[</span>None<span class="o">]</span>: eu-west-1
</span><span class='line'>Default output format <span class="o">[</span>None<span class="o">]</span>: json
</span></code></pre></td></tr></table></div></figure>


<p>To verify if everything works as expected we can use the following command to verify:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>aws --profile medium sts get-caller-identity
</span></code></pre></td></tr></table></div></figure>


<p>The response should look something similar to the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;UserId&quot;</span><span class="p">:</span> <span class="s2">&quot;AIDATPRT2G4SOAO5Y7S5Z&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Account&quot;</span><span class="p">:</span> <span class="s2">&quot;000000000000&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Arn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iam::000000000000:user/medium-terraform&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform</h2>

<p>Now that we have our AWS IAM User configured, we can install Terraform, if you dont have Terraform installed yet, you can follow their <a href="https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli">Installation Documentation</a>.</p>

<p>Once you have Terraform installed, we can setup our workspace where we will ultimately deploy a EC2 instance, but before we get there we need to create our project directory and change to that directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir ~/terraform-demo
</span><span class='line'><span class="nb">cd</span> ~/terraform-demo
</span></code></pre></td></tr></table></div></figure>


<p>Then we will create 4 files with <code>.tf</code> extensions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch main.tf
</span><span class='line'>touch outputs.tf
</span><span class='line'>touch providers.tf
</span><span class='line'>touch variables.tf
</span></code></pre></td></tr></table></div></figure>


<p>We will define our Terraform definitions on how we want our desired infrastructure to look like. We will get to the content in the files soon.</p>

<p>I personally love Terraforms documentation as they are rich in examples and really easy to use.</p>

<p>Head over to the <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs">Terraform AWS Provider</a> documentation and you scroll a bit down, you can see the <a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs#authentication-and-configuration">Authentication and Configuration</a> section where they outline the order in how Terraform will look for credentials and we will be making use of the shared credentials file as that is where our access key and secret access key is stored.</p>

<p>If you look at the top right corner of the Terraform AWS Provider documentation, they show you how to use the AWS Provider:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/03a55c32-bb1c-4f48-a441-c09918c824db" alt="terraform-aws-provider-docs" /></p>

<p>We can copy that code snippet and paste it into our <code>providers.tf</code> file and configure the aws provider section with the <code>medium</code> profile that weve created earlier.</p>

<p>This will tell Terraform where to look for credentials in order to authenticate with AWS.</p>

<p>Open <code>providers.tf</code> with your editor of choice:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">aws</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/aws&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;5.8.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;aws&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">shared_credentials_files</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;~/.aws/credentials&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="nv">profile</span>                  <span class="o">=</span> <span class="s2">&quot;medium&quot;</span>
</span><span class='line'>  <span class="nv">region</span>                   <span class="o">=</span> <span class="s2">&quot;eu-west-1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we can open <code>main.tf</code> and populate the following to define the EC2 instance that we want to provision:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>data <span class="s2">&quot;aws_ami&quot;</span> <span class="s2">&quot;latest_ubuntu&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">most_recent</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">owners</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;099720109477&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  filter <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>   <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
</span><span class='line'>    <span class="nv">values</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-*-server-*&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  filter <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>   <span class="o">=</span> <span class="s2">&quot;architecture&quot;</span>
</span><span class='line'>    <span class="nv">values</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;x86_64&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_instance&quot;</span> <span class="s2">&quot;ec2&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">ami</span>           <span class="o">=</span> data.aws_ami.latest_ubuntu.id
</span><span class='line'>  <span class="nv">instance_type</span> <span class="o">=</span> var.instance_type
</span><span class='line'>  <span class="nv">tags</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&quot;${var.instance_name}-ec2-instance&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the above example we are filtering for the latest Ubuntu 22.04 64bit AMI then we are defining a EC2 instance and specifying the AMI ID that we filtered from our data source.</p>

<p>Note that we havent specified a SSH Keypair, as we are just focusing on how to provision a EC2 instance.</p>

<p>As you can see we are also referencing variables, which we need to define in <code>variables.tf</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>variable <span class="s2">&quot;instance_name&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;Instance Name for EC2.&quot;</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">default</span>     <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;instance_type&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;Instance Type for EC2.&quot;</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">default</span>     <span class="o">=</span> <span class="s2">&quot;t2.micro&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then lastly we need to define our <code>outputs.tf</code> which will be used to output the instance id and ip address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>output <span class="s2">&quot;instance_id&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> aws_instance.ec2.id
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> aws_instance.ec2.public_ip
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy our EC2 with Terraform</h2>

<p>Now that our infrastructure has been defined as code, we can first initialise terraform which will initialise the backend and download all the providers that has been defined:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Once that has done we can run a plan which will show us what Terraform will deploy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform plan
</span></code></pre></td></tr></table></div></figure>


<p>Now terraform will show us the difference in what we have defined, and what is actually in AWS, as we know its a new account with zero infrastructure, the diff should show us that it needs to create a EC2 instance.</p>

<p>The response from the <code>terraform plan</code> shows us the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span><span class='line'>  + create
</span><span class='line'>
</span><span class='line'>Terraform will perform the following actions:
</span><span class='line'>
</span><span class='line'>  <span class="c"># aws_instance.ec2 will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;aws_instance&quot;</span> <span class="s2">&quot;ec2&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">ami</span>                                  <span class="o">=</span> <span class="s2">&quot;ami-0f56955469757e5aa&quot;</span>
</span><span class='line'>      + <span class="nv">arn</span>                                  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">id</span>                                   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">instance_type</span>                        <span class="o">=</span> <span class="s2">&quot;t2.micro&quot;</span>
</span><span class='line'>      + <span class="nv">key_name</span>                             <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">private_ip</span>                           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">public_ip</span>                            <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">security_groups</span>                      <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">subnet_id</span>                            <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">tags</span>                                 <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>          + <span class="s2">&quot;Name&quot;</span> <span class="o">=</span> <span class="s2">&quot;test-ec2-instance&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      + <span class="nv">tags_all</span>                             <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>          + <span class="s2">&quot;Name&quot;</span> <span class="o">=</span> <span class="s2">&quot;test-ec2-instance&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      + <span class="nv">vpc_security_group_ids</span>               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">1</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + <span class="nv">instance_id</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>  + <span class="nv">ip</span>          <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see terraform has looked up the AMI ID using the data source, and we can see that terraform will provision 1 resource which is a EC2 instance. Once we hare happy with the plan, we can run a apply which will show us the same but this time prompt us if we want to proceed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Do you want to perform these actions?
</span><span class='line'>  Terraform will perform the actions described above.
</span><span class='line'>  Only <span class="s1">&#39;yes&#39;</span> will be accepted to approve.
</span><span class='line'>
</span><span class='line'>  Enter a value: yes
</span><span class='line'>
</span><span class='line'>aws_instance.ec2: Creating...
</span><span class='line'>aws_instance.ec2: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span><span class='line'>aws_instance.ec2: Still creating... <span class="o">[</span>20s elapsed<span class="o">]</span>
</span><span class='line'>aws_instance.ec2: Still creating... <span class="o">[</span>30s elapsed<span class="o">]</span>
</span><span class='line'>aws_instance.ec2: Creation <span class="nb">complete </span>after 35s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>i-005c08b899229fff0<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Apply <span class="nb">complete</span>! Resources: <span class="m">1</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span><span class='line'>
</span><span class='line'>Outputs:
</span><span class='line'>
</span><span class='line'><span class="nv">instance_id</span> <span class="o">=</span> <span class="s2">&quot;i-005c08b899229fff0&quot;</span>
</span><span class='line'><span class="nv">ip</span> <span class="o">=</span> <span class="s2">&quot;34.253.196.167&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now we can see our EC2 instance was provisioned and our outputs returned the instance id as well as the public ip address.</p>

<p>We can also confirm this by looking at the AWS EC2 Console:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/82b4d742-1c45-4d21-8766-10a5c0d074a1" alt="aws-ec2-instances-in-console" /></p>

<p>Note that Terraform Configuration is idempotent, so when we run a terraform apply again, terraform will check what we have defined as what we want our desired infrastructure to be like, and what we actually have in our AWS Account, and since we havent made any changes there should be no changes.</p>

<p>We can run a terraform apply to validate that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform apply
</span></code></pre></td></tr></table></div></figure>


<p>And we can see the response shows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>data.aws_vpc.selected: Reading...
</span><span class='line'>data.aws_ami.latest_ubuntu: Reading...
</span><span class='line'>data.aws_ami.latest_ubuntu: Read <span class="nb">complete </span>after 1s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>ami-0f56955469757e5aa<span class="o">]</span>
</span><span class='line'>data.aws_vpc.selected: Read <span class="nb">complete </span>after 1s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>vpc-063d7ac3124053dfa<span class="o">]</span>
</span><span class='line'>data.aws_subnet.selected: Reading...
</span><span class='line'>data.aws_subnet.selected: Read <span class="nb">complete </span>after 1s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>subnet-0b7acd7593611c1bb<span class="o">]</span>
</span><span class='line'>aws_instance.ec2: Refreshing state... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>i-005c08b899229fff0<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Apply <span class="nb">complete</span>! Resources: <span class="m">0</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span></code></pre></td></tr></table></div></figure>


<h2>Cleanup</h2>

<p>Destroy the infrastructure that we provisioned:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform destroy
</span></code></pre></td></tr></table></div></figure>


<p>It will show us what terraform will destroy, then upon confirming we should see the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Plan: <span class="m">0</span> to add, <span class="m">0</span> to change, <span class="m">1</span> to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  - <span class="nv">instance_id</span> <span class="o">=</span> <span class="s2">&quot;i-005c08b899229fff0&quot;</span> -&gt; null
</span><span class='line'>  - <span class="nv">ip</span>          <span class="o">=</span> <span class="s2">&quot;34.253.196.167&quot;</span> -&gt; null
</span><span class='line'>
</span><span class='line'>Do you really want to destroy all resources?
</span><span class='line'>  Terraform will destroy all your managed infrastructure, as shown above.
</span><span class='line'>  There is no undo. Only <span class="s1">&#39;yes&#39;</span> will be accepted to confirm.
</span><span class='line'>
</span><span class='line'>  Enter a value: yes
</span><span class='line'>
</span><span class='line'>aws_instance.ec2: Destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>i-005c08b899229fff0<span class="o">]</span>
</span><span class='line'>aws_instance.ec2: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>i-005c08b899229fff0, 10s elapsed<span class="o">]</span>
</span><span class='line'>aws_instance.ec2: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>i-005c08b899229fff0, 20s elapsed<span class="o">]</span>
</span><span class='line'>aws_instance.ec2: Still destroying... <span class="o">[</span><span class="nv">id</span><span class="o">=</span>i-005c08b899229fff0, 30s elapsed<span class="o">]</span>
</span><span class='line'>aws_instance.ec2: Destruction <span class="nb">complete </span>after 31s
</span><span class='line'>
</span><span class='line'>Destroy <span class="nb">complete</span>! Resources: <span class="m">1</span> destroyed.
</span></code></pre></td></tr></table></div></figure>


<p>If you followed along and you also want to clean up the AWS IAM user, head over to the AWS IAM Console and delete the medium-terraform IAM User.</p>

<h2>Thank You</h2>

<p>I hope you enjoyed this post, I will be posting more terraform related content.</p>

<p>Should you want to reach out to me, you can follow me on Twitter at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> or check out my website at <a href="https://ruan.dev">https://ruan.dev</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/06/14/getting-started-with-ferretdb-on-docker/">Getting Started With FerretDB on Docker</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-06-14T22:00:00-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>10:00 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://blog.ruanbekker.com/images/how-to-run-ferretdb-on-docker.png" alt="how-to-run-ferretdb-on-docker" /></p>

<p>In this post we will have a look at <strong>FerretDB</strong> which is a opensource proxy that translates MongoDB queries to SQL, where PostgreSQL being the database engine.</p>

<h2>More about FerretDB</h2>

<p>From <a href="https://www.ferretdb.io/">FerretDB</a> website, they describe FerretDB as:</p>

<blockquote><p>Initially built as open-source software, MongoDB was a game-changer for many developers, enabling them to build fast and robust applications. Its ease of use and extensive documentation made it a top choice for many developers looking for an open-source database. However, all this changed when they switched to an SSPL license, moving away from their open-source roots.</p>

<p>In light of this, FerretDB was founded to become the true open-source alternative to MongoDB, making it the go-to choice for most MongoDB users looking for an open-source alternative to MongoDB. With FerretDB, users can run the same MongoDB protocol queries without needing to learn a new language or command.</p></blockquote>

<h2>What can you expect from this tutorial</h2>

<p>We will be doing the following:</p>

<ul>
<li>deploying ferretdb and postgres on docker containers using docker compose</li>
<li>then use <code>mongosh</code> as a client to logon to ferretdb using the ferretdb endpoint</li>
<li>explore some example queries to insert and read data from ferretdb</li>
<li>use scripting to generate data into ferretedb</li>
<li>explore the embedded prometheus endpoint for metrics</li>
</ul>


<h2>Deploy FerretDB</h2>

<p>The following <code>docker-compose.yaml</code> defines a postgres container which will be used as the database engine for ferretdb, and then we define the ferretdb container, which connects to postgres via the environment variable <code>FERRETDB_POSTGRESQL_URL</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.9&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">postgres</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres:14.8-bullseye</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_USER=ferret</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_PASSWORD=password</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_DB=ferretdb</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pgvol:/var/lib/postgresql/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthcheck</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;CMD-SHELL&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;pg_isready&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;-d&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;db_prod&quot;</span><span class="p-Indicator">]</span>
</span><span class='line'>      <span class="l-Scalar-Plain">interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>      <span class="l-Scalar-Plain">start_period</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">60s</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ferretdb</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-file</span><span class="p-Indicator">:</span> <span class="s">&quot;1&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ferretdb</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ghcr.io/ferretdb/ferretdb:1.1.0</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ferretdb</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">27017:27017</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:8080</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">FERRETDB_POSTGRESQL_URL=postgres://postgres:5432/ferretdb</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">postgres</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">condition</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">service_healthy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ferretdb</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-file</span><span class="p-Indicator">:</span> <span class="s">&quot;1&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ferretdb</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ferretdb</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">pgvol</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you have the content above saved in <code>docker-compose.yaml</code> you can run the following to run the containers in a detached mode:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>


<h2>Connect to FerretDB</h2>

<p>Once the containers started, we can connect to our ferretdb server using mongosh, which is a shell utility to connect to the database). I will make use of a container to do this, where I will reference the network which we defined in our docker compose file, and set the endpoint that mongosh need to connect to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker run --rm -it --network<span class="o">=</span>ferretdb --entrypoint<span class="o">=</span>mongosh mongo:6.0 <span class="s2">&quot;mongodb://ferret:password@ferretdb/ferretdb?authMechanism=PLAIN&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once it successfully connects to ferretdb, we should see the following prompt:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Current Mongosh Log ID:  64626c5c259916d1a68b7dad
</span><span class='line'>Connecting to:        mongodb://&lt;credentials&gt;@ferretdb/ferretdb?authMechanism<span class="o">=</span>PLAIN<span class="p">&amp;</span><span class="nv">directConnection</span><span class="o">=</span><span class="nb">true</span><span class="p">&amp;</span><span class="nv">appName</span><span class="o">=</span>mongosh+1.8.2
</span><span class='line'>Using MongoDB:        6.0.42
</span><span class='line'>Using Mongosh:        1.8.2
</span><span class='line'>
</span><span class='line'>ferretdb&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Run example queries on FerretDB</h2>

<p>If you are familiar with MongoDB, you will find the following identical to MongoDB.</p>

<p>First we show the current databases:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; show dbs<span class="p">;</span>
</span><span class='line'>public  <span class="m">0</span> B
</span></code></pre></td></tr></table></div></figure>


<p>The we create and use the database named <code>mydb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; use mydb
</span><span class='line'>switched to db mydb
</span></code></pre></td></tr></table></div></figure>


<p>To see which database are we currently connected to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db
</span><span class='line'>mydb
</span></code></pre></td></tr></table></div></figure>


<p>Now we can create a collection named <code>mycol1</code> and <code>mycol2</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db.createCollection<span class="o">(</span><span class="s2">&quot;mycol1&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> ok: <span class="m">1</span> <span class="o">}</span>
</span><span class='line'>mydb&gt; db.createCollection<span class="o">(</span><span class="s2">&quot;mycol2&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> ok: <span class="m">1</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can view our collections by running the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; show collections
</span><span class='line'>mycol1
</span><span class='line'>mycol2
</span></code></pre></td></tr></table></div></figure>


<p>To write one document into our collection named <code>col1</code> with the following data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ruan&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;age&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;hobbies&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="s2">&quot;golf&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;programming&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;music&quot;</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can execute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db.mycol1.insertOne<span class="o">({</span><span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;ruan&quot;</span>, <span class="s2">&quot;age&quot;</span>: 32, <span class="s2">&quot;hobbies&quot;</span>: <span class="o">[</span><span class="s2">&quot;golf&quot;</span>, <span class="s2">&quot;programming&quot;</span>, <span class="s2">&quot;music&quot;</span><span class="o">]})</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  acknowledged: <span class="nb">true</span>,
</span><span class='line'>  insertedIds: <span class="o">{</span> <span class="s1">&#39;0&#39;</span>: ObjectId<span class="o">(</span><span class="s2">&quot;64626cea259916d1a68b7dae&quot;</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we can insert another document:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db.mycol1.insertOne<span class="o">({</span><span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;michelle&quot;</span>, <span class="s2">&quot;age&quot;</span>: 28, <span class="s2">&quot;hobbies&quot;</span>: <span class="o">[</span><span class="s2">&quot;art&quot;</span>, <span class="s2">&quot;music&quot;</span>, <span class="s2">&quot;reading&quot;</span><span class="o">]})</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  acknowledged: <span class="nb">true</span>,
</span><span class='line'>  insertedIds: <span class="o">{</span> <span class="s1">&#39;0&#39;</span>: ObjectId<span class="o">(</span><span class="s2">&quot;64626cf1259916d1a68b7daf&quot;</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can then use <code>countDocuments()</code> to view the number of documents in our collection named <code>mycol1</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; db.mycol1.countDocuments<span class="o">()</span>
</span><span class='line'>2
</span></code></pre></td></tr></table></div></figure>


<p>If we want to find all our documents in our <code>mycol1</code> collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db.mycol1.find<span class="o">()</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    _id: ObjectId<span class="o">(</span><span class="s2">&quot;64626cea259916d1a68b7dae&quot;</span><span class="o">)</span>,
</span><span class='line'>    name: <span class="s1">&#39;ruan&#39;</span>,
</span><span class='line'>    age: 32,
</span><span class='line'>    hobbies: <span class="o">[</span> <span class="s1">&#39;golf&#39;</span>, <span class="s1">&#39;programming&#39;</span>, <span class="s1">&#39;music&#39;</span> <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    _id: ObjectId<span class="o">(</span><span class="s2">&quot;64626cf1259916d1a68b7daf&quot;</span><span class="o">)</span>,
</span><span class='line'>    name: <span class="s1">&#39;michelle&#39;</span>,
</span><span class='line'>    age: 28,
</span><span class='line'>    hobbies: <span class="o">[</span> <span class="s1">&#39;art&#39;</span>, <span class="s1">&#39;music&#39;</span>, <span class="s1">&#39;reading&#39;</span> <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we want to only display specific fields in our response, such as name and age, we can project fields to return from our query:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db.mycol1.find<span class="o">({}</span>, <span class="o">{</span><span class="s2">&quot;name&quot;</span>: 1, <span class="s2">&quot;age&quot;</span>: 1<span class="o">})</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span> _id: ObjectId<span class="o">(</span><span class="s2">&quot;64626cea259916d1a68b7dae&quot;</span><span class="o">)</span>, name: <span class="s1">&#39;ruan&#39;</span>, age: <span class="m">32</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    _id: ObjectId<span class="o">(</span><span class="s2">&quot;64626cf1259916d1a68b7daf&quot;</span><span class="o">)</span>,
</span><span class='line'>    name: <span class="s1">&#39;michelle&#39;</span>,
</span><span class='line'>    age: 28
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can also suppress the <code>_id</code> field by setting the value to <code>0</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db.mycol1.find<span class="o">({}</span>, <span class="o">{</span><span class="s2">&quot;_id&quot;</span>: 0, <span class="s2">&quot;name&quot;</span>: 1, <span class="s2">&quot;age&quot;</span>: 1<span class="o">})</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span> name: <span class="s1">&#39;ruan&#39;</span>, age: <span class="m">32</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> name: <span class="s1">&#39;michelle&#39;</span>, age: <span class="m">28</span> <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we can return all the fields name and age from our collection where the age field is equals to 32:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db.mycol1.find<span class="o">({</span><span class="s2">&quot;age&quot;</span>: 32<span class="o">}</span>, <span class="o">{</span><span class="s2">&quot;_id&quot;</span>: 0, <span class="s2">&quot;name&quot;</span>: 1, <span class="s2">&quot;age&quot;</span>: 1<span class="o">})</span>
</span><span class='line'><span class="o">[</span> <span class="o">{</span> name: <span class="s1">&#39;ruan&#39;</span>, age: <span class="m">32</span> <span class="o">}</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can also find a specific document by its id as example, and return only the field value, like name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db.mycol1.findOne<span class="o">({</span>_id: ObjectId<span class="o">(</span><span class="s2">&quot;64626cea259916d1a68b7dae&quot;</span><span class="o">)})</span>.name
</span><span class='line'>ruan
</span></code></pre></td></tr></table></div></figure>


<p>Next we will find all documents where the age is greater than 30:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mydb&gt; db.mycol1.find<span class="o">({</span><span class="s2">&quot;age&quot;</span>: <span class="o">{</span><span class="s2">&quot;$gt&quot;</span>: 30<span class="o">}})</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    _id: ObjectId<span class="o">(</span><span class="s2">&quot;64626cea259916d1a68b7dae&quot;</span><span class="o">)</span>,
</span><span class='line'>    name: <span class="s1">&#39;ruan&#39;</span>,
</span><span class='line'>    age: 32,
</span><span class='line'>    hobbies: <span class="o">[</span> <span class="s1">&#39;golf&#39;</span>, <span class="s1">&#39;programming&#39;</span>, <span class="s1">&#39;music&#39;</span> <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s explore how to insert many documents at once using <code>insertMany()</code>, first create a new collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; db.createCollection<span class="o">(</span><span class="s2">&quot;mycol2&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> ok: <span class="m">1</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can then define the docs variable, and assign a array with 2 json documents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; var <span class="nv">docs</span> <span class="o">=</span> <span class="o">[{</span>name: <span class="s2">&quot;peter&quot;</span>, age: 34, hobbies: <span class="o">[</span><span class="s2">&quot;ski&quot;</span>, <span class="s2">&quot;programming&quot;</span>, <span class="s2">&quot;music&quot;</span><span class="o">]}</span>, <span class="o">{</span>name: <span class="s2">&quot;sam&quot;</span>, age: 39, hobbies: <span class="o">[</span><span class="s2">&quot;running&quot;</span>, <span class="s2">&quot;camping&quot;</span>, <span class="s2">&quot;music&quot;</span><span class="o">]}]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can insert our documents to ferretdb using <code>insertMany()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; db.mycol2.insertMany<span class="o">(</span>docs<span class="o">)</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  acknowledged: <span class="nb">true</span>,
</span><span class='line'>  insertedIds: <span class="o">{</span>
</span><span class='line'>    <span class="s1">&#39;0&#39;</span>: ObjectId<span class="o">(</span><span class="s2">&quot;6464ceb1413cee26e9bf709f&quot;</span><span class="o">)</span>,
</span><span class='line'>    <span class="s1">&#39;1&#39;</span>: ObjectId<span class="o">(</span><span class="s2">&quot;6464ceb1413cee26e9bf70a0&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can count the documents inside our collection using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; db.mycol2.countDocuments<span class="o">()</span>
</span><span class='line'>2
</span></code></pre></td></tr></table></div></figure>


<p>And we can search for all the documents inside the collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; db.mycol2.find<span class="o">()</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    _id: ObjectId<span class="o">(</span><span class="s2">&quot;6464ceb1413cee26e9bf709f&quot;</span><span class="o">)</span>,
</span><span class='line'>    name: <span class="s1">&#39;peter&#39;</span>,
</span><span class='line'>    age: 34,
</span><span class='line'>    hobbies: <span class="o">[</span> <span class="s1">&#39;ski&#39;</span>, <span class="s1">&#39;programming&#39;</span>, <span class="s1">&#39;music&#39;</span> <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    _id: ObjectId<span class="o">(</span><span class="s2">&quot;6464ceb1413cee26e9bf70a0&quot;</span><span class="o">)</span>,
</span><span class='line'>    name: <span class="s1">&#39;sam&#39;</span>,
</span><span class='line'>    age: 39,
</span><span class='line'>    hobbies: <span class="o">[</span> <span class="s1">&#39;running&#39;</span>, <span class="s1">&#39;camping&#39;</span>, <span class="s1">&#39;music&#39;</span> <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>And searching for any data using the name <code>peter</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; db.mycol2.find<span class="o">({</span>name: <span class="s2">&quot;peter&quot;</span><span class="o">})</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    _id: ObjectId<span class="o">(</span><span class="s2">&quot;6464ceb1413cee26e9bf709f&quot;</span><span class="o">)</span>,
</span><span class='line'>    name: <span class="s1">&#39;peter&#39;</span>,
</span><span class='line'>    age: 34,
</span><span class='line'>    hobbies: <span class="o">[</span> <span class="s1">&#39;ski&#39;</span>, <span class="s1">&#39;programming&#39;</span>, <span class="s1">&#39;music&#39;</span> <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Scripting</h2>

<p>We will create a script so that we can generate data that we want to write into FerretDB.</p>

<p>Create the following script, <code>write.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>var <span class="nv">txs</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="k">for</span> <span class="o">(</span>var <span class="nv">x</span> <span class="o">=</span> 0<span class="p">;</span> x &lt; <span class="m">1000</span> <span class="p">;</span> x++<span class="o">)</span> <span class="o">{</span>
</span><span class='line'> var <span class="nv">transaction_types</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;credit card&quot;</span>, <span class="s2">&quot;cash&quot;</span>, <span class="s2">&quot;account&quot;</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'> var <span class="nv">store_names</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;edgards&quot;</span>, <span class="s2">&quot;cna&quot;</span>, <span class="s2">&quot;makro&quot;</span>, <span class="s2">&quot;picknpay&quot;</span>, <span class="s2">&quot;checkers&quot;</span><span class="o">]</span><span class="p">;</span>
</span><span class='line'> var <span class="nv">random_transaction_type</span> <span class="o">=</span> Math.floor<span class="o">(</span>Math.random<span class="o">()</span> * <span class="o">(</span><span class="m">2</span> - <span class="m">0</span> + 1<span class="o">))</span> + 0<span class="p">;</span>
</span><span class='line'> var <span class="nv">random_store_name</span> <span class="o">=</span> Math.floor<span class="o">(</span>Math.random<span class="o">()</span> * <span class="o">(</span><span class="m">4</span> - <span class="m">0</span> + 1<span class="o">))</span> + 0<span class="p">;</span>
</span><span class='line'> var <span class="nv">random_age</span> <span class="o">=</span> Math.floor<span class="o">(</span>Math.random<span class="o">()</span> * <span class="o">(</span><span class="m">80</span> - 18<span class="o">)</span> + 18<span class="o">)</span>
</span><span class='line'> txs.push<span class="o">({</span>
</span><span class='line'>   transaction: <span class="s1">&#39;tx_&#39;</span> + x,
</span><span class='line'>   transaction_price: Math.round<span class="o">(</span>Math.random<span class="o">()</span>*1000<span class="o">)</span>,
</span><span class='line'>   transaction_type: transaction_types<span class="o">[</span>random_transaction_type<span class="o">]</span>,
</span><span class='line'>   store_name: store_names<span class="o">[</span>random_store_name<span class="o">]</span>,
</span><span class='line'>   age: random_age
</span><span class='line'>   <span class="o">})</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>console.log<span class="o">(</span><span class="s2">&quot;drop and recreate the collection&quot;</span><span class="o">)</span>
</span><span class='line'>db.mycollection1.drop<span class="o">()</span>
</span><span class='line'>db.createCollection<span class="o">(</span><span class="s2">&quot;mycollection1&quot;</span><span class="o">)</span>
</span><span class='line'>console.log<span class="o">(</span><span class="s2">&quot;insert documents into collection&quot;</span><span class="o">)</span>
</span><span class='line'>db.mycollection1.insertMany<span class="o">(</span>txs<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The script will loop a 1000 times and create documents that will include fields of <code>transaction_types</code>, <code>store_names</code>, <code>random_transaction_type</code>, <code>random_store_name</code> and <code>random_age</code>.</p>

<p>Use docker, mount the file inside the container, point the database endpoint to ferretdb and load the file that we want to execute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker run --rm -it --network<span class="o">=</span>ferretdb -v <span class="nv">$PWD</span>/write.js:/src/write.js --entrypoint<span class="o">=</span>mongosh mongo:6.0 <span class="s2">&quot;mongodb://ferret:password@ferretdb/ferretdb?authMechanism=PLAIN&quot;</span> --eval <span class="s1">&#39;load(&quot;/src/write.js&quot;)&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now when we run a mongosh client:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker run --rm -it --network<span class="o">=</span>ferretdb -v <span class="nv">$PWD</span>/write.js:/src/write.js --entrypoint<span class="o">=</span>mongosh mongo:6.0 <span class="s2">&quot;mongodb://ferret:password@ferretdb/ferretdb?authMechanism=PLAIN&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we query for the <code>store_name: picknpay</code> and only show the <code>transaction_type</code> and <code>transaction</code> fields:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb&gt; db.mycollection1.find<span class="o">({</span><span class="s2">&quot;store_name&quot;</span>: <span class="s2">&quot;picknpay&quot;</span><span class="o">}</span>, <span class="o">{</span>_id: 0, transaction_type: 1, transaction: 1<span class="o">})</span>
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;credit card&#39;</span>, transaction: <span class="s1">&#39;tx_3&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;cash&#39;</span>, transaction: <span class="s1">&#39;tx_9&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;account&#39;</span>, transaction: <span class="s1">&#39;tx_10&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;credit card&#39;</span>, transaction: <span class="s1">&#39;tx_15&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;credit card&#39;</span>, transaction: <span class="s1">&#39;tx_19&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;cash&#39;</span>, transaction: <span class="s1">&#39;tx_21&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;cash&#39;</span>, transaction: <span class="s1">&#39;tx_28&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;account&#39;</span>, transaction: <span class="s1">&#39;tx_31&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;cash&#39;</span>, transaction: <span class="s1">&#39;tx_37&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;cash&#39;</span>, transaction: <span class="s1">&#39;tx_39&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;account&#39;</span>, transaction: <span class="s1">&#39;tx_40&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;cash&#39;</span>, transaction: <span class="s1">&#39;tx_51&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;account&#39;</span>, transaction: <span class="s1">&#39;tx_52&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;cash&#39;</span>, transaction: <span class="s1">&#39;tx_58&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;credit card&#39;</span>, transaction: <span class="s1">&#39;tx_62&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;credit card&#39;</span>, transaction: <span class="s1">&#39;tx_65&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;account&#39;</span>, transaction: <span class="s1">&#39;tx_69&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;account&#39;</span>, transaction: <span class="s1">&#39;tx_71&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;cash&#39;</span>, transaction: <span class="s1">&#39;tx_72&#39;</span> <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span> transaction_type: <span class="s1">&#39;account&#39;</span>, transaction: <span class="s1">&#39;tx_74&#39;</span> <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can also use the <code>--eval</code> flag with the mongosh container to run ad-hoc queries such as counting documents for a collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker run --rm -it --network<span class="o">=</span>ferretdb <span class="se">\</span>
</span><span class='line'>  -v <span class="nv">$PWD</span>/write.js:/src/write.js:ro <span class="se">\</span>
</span><span class='line'>  --entrypoint<span class="o">=</span>mongosh mongo:6.0 <span class="se">\</span>
</span><span class='line'>  <span class="s2">&quot;mongodb://ferret:password@ferretdb/ferretdb?authMechanism=PLAIN&quot;</span> --eval <span class="s1">&#39;db.mycollection1.countDocuments()&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Prometheus Metrics</h2>

<p>FerretDB provides prometheus metrics out of the box, and outputs prometheus metrics on the <code>:8080/debug/metrics</code> endpoint:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl http://localhost:8080/debug/metrics
</span></code></pre></td></tr></table></div></figure>


<p>Which will output metrics more or less like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ferretdb_client_accepts_total<span class="o">{</span><span class="nv">error</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="o">}</span> 98
</span><span class='line'>ferretdb_client_connected 0
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;aggregate&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 5
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;atlasVersion&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;buildInfo&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;buildinfo&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 2
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;count&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 5
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;create&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 7
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;drop&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 3
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;dropDatabase&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 4
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;find&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;getCmdLineOpts&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;getFreeMonitoringStatus&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 20
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;getLog&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 20
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;getParameter&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 20
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;insert&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 15
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;ismaster&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 238
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;listCollections&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 49
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;listDatabases&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 12
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;ping&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 40
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;saslStart&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 70
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;setFreeMonitoring&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span><span class="o">}</span> 1
</span><span class='line'>ferretdb_client_requests_total<span class="o">{</span><span class="nb">command</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_QUERY&quot;</span><span class="o">}</span> 96
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;aggregate&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 5
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;atlasVersion&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;CommandNotFound&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;buildInfo&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;buildinfo&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 2
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;count&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 5
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;create&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 7
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;drop&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;NamespaceNotFound&quot;</span><span class="o">}</span> 2
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;drop&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 1
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;dropDatabase&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 4
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;find&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;getCmdLineOpts&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;getFreeMonitoringStatus&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 20
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;getLog&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 20
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;getParameter&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;Unset&quot;</span><span class="o">}</span> 27
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;hello&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 20
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;insert&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 15
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;ismaster&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 238
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;listCollections&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 49
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;listDatabases&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 12
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;ping&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 40
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;saslStart&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 70
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;setFreeMonitoring&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_MSG&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 1
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_REPLY&quot;</span>,result<span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="o">}</span> 93
</span><span class='line'>ferretdb_client_responses_total<span class="o">{</span><span class="nv">argument</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,command<span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,opcode<span class="o">=</span><span class="s2">&quot;OP_REPLY&quot;</span>,result<span class="o">=</span><span class="s2">&quot;unhandled&quot;</span><span class="o">}</span> 3
</span><span class='line'>ferretdb_up<span class="o">{</span><span class="nv">branch</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>,commit<span class="o">=</span><span class="s2">&quot;3344cbb98bb744dd044bcf2d51fe9ab65db22f0b&quot;</span>,debug<span class="o">=</span><span class="s2">&quot;false&quot;</span>,dirty<span class="o">=</span><span class="s2">&quot;true&quot;</span>,package<span class="o">=</span><span class="s2">&quot;docker&quot;</span>,telemetry<span class="o">=</span><span class="s2">&quot;disabled&quot;</span>,update_available<span class="o">=</span><span class="s2">&quot;false&quot;</span>,uuid<span class="o">=</span><span class="s2">&quot;08174d33-05fd-45ed-adb9-d2e343e0af83&quot;</span>,version<span class="o">=</span><span class="s2">&quot;v1.1.0&quot;</span><span class="o">}</span> 1
</span><span class='line'>process_cpu_seconds_total 16.98
</span><span class='line'>process_max_fds 1.048576e+06
</span><span class='line'>process_open_fds 13
</span><span class='line'>process_resident_memory_bytes 2.5714688e+07
</span><span class='line'>process_start_time_seconds 1.68425346762e+09
</span><span class='line'>process_virtual_memory_bytes 7.52529408e+08
</span><span class='line'>process_virtual_memory_max_bytes 1.8446744073709552e+19
</span><span class='line'>promhttp_metric_handler_errors_total<span class="o">{</span><span class="nv">cause</span><span class="o">=</span><span class="s2">&quot;encoding&quot;</span><span class="o">}</span> 0
</span><span class='line'>promhttp_metric_handler_errors_total<span class="o">{</span><span class="nv">cause</span><span class="o">=</span><span class="s2">&quot;gathering&quot;</span><span class="o">}</span> 0
</span><span class='line'>promhttp_metric_handler_requests_in_flight 1
</span><span class='line'>promhttp_metric_handler_requests_total<span class="o">{</span><span class="nv">code</span><span class="o">=</span><span class="s2">&quot;200&quot;</span><span class="o">}</span> 2
</span><span class='line'>promhttp_metric_handler_requests_total<span class="o">{</span><span class="nv">code</span><span class="o">=</span><span class="s2">&quot;500&quot;</span><span class="o">}</span> 0
</span><span class='line'>promhttp_metric_handler_requests_total<span class="o">{</span><span class="nv">code</span><span class="o">=</span><span class="s2">&quot;503&quot;</span><span class="o">}</span> 0
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p>Please see the follwoing resources for FerretDB:</p>

<ul>
<li><a href="https://docs.ferretdb.io/">https://docs.ferretdb.io/</a></li>
<li><a href="https://github.com/ferretdb/FerretDB/pkgs/container/ferretdb">https://github.com/ferretdb/FerretDB/pkgs/container/ferretdb</a></li>
<li><a href="https://docs.ferretdb.io/quickstart-guide/docker/">https://docs.ferretdb.io/quickstart-guide/docker/</a></li>
<li><a href="https://github.com/ruanbekker/cheatsheets/tree/master/mongodb/shell">https://github.com/ruanbekker/cheatsheets/tree/master/mongodb/shell</a></li>
</ul>


<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>

<ul>
<li>Linktree: <a href="https://go.ruan.dev/links">https://go.ruan.dev/links</a></li>
<li>Patreon: <a href="https://go.ruan.dev/patreon">https://go.ruan.dev/patreon</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/05/26/how-to-run-a-amd64-bit-linux-vm-on-a-mac-m1/">How to Run a AMD64 Bit Linux VM on a Mac M1</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-05-26T08:35:38-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>8:35 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This tutorial will show you how you can run 64bit Ubuntu Linux Virtual Machines on a Apple Mac M1 arm64 architecture macbook using <a href="https://github.com/utmapp/UTM">UTM</a>.</p>

<h2>Installation</h2>

<p>Head over to their <a href="https://docs.getutm.app/installation/ios/">documentation</a> and download the <code>UTM.dmg</code> file and install it, once it is installed and you have opened UTM, you should see this screen:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/a5303fc2-0925-4055-921e-78292d5b45e0" alt="image" /></p>

<h2>Creating a Virtual Machine</h2>

<p>In my case I would like to run a Ubuntu VM, so head over to the <a href="https://ubuntu.com/download/server">Ubuntu Server Download</a> page and download the version of choice, I will be downloading Ubuntu Server 22.04, once you have your ISO image downloaded, you can head over to the next step which is to &ldquo;Create a New Virtual Machine&rdquo;:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/3fa35dc5-982e-469b-822d-e9c548edf69f" alt="image" /></p>

<p>I will select &ldquo;Emulate&rdquo; as I want to run a amd64 bit architecture, then select &ldquo;Linux&rdquo;:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/58f1485c-9b6a-4703-a2fb-377263c4750c" alt="image" /></p>

<p>In the next step we want to select the Ubuntu ISO image that we downloaded, which we want to use to boot our VM from:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/676b6258-ccab-4e4e-a447-db012a2de1b3" alt="image" /></p>

<p>Browse and select the image that you downloaded, once you selected it, it should show something like this:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/c102f46e-e5df-45f5-9bec-727b67ec1bf2" alt="image" /></p>

<p>Select continue, then select the architecture to <code>x86_64</code>, the system I kept on defaults and the memory I have set to <code>2048MB</code> and cores to <code>2</code> but that is just my preference:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/2c79e154-5fef-46bb-8b10-17e4a837ce0c" alt="image" /></p>

<p>The next screen is to configure storage, as this is for testing I am setting mine to <code>8GB</code>:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/d62730e8-dda7-4324-95bd-6d01532af1da" alt="image" /></p>

<p>The next screen is shared directories, this is purely optional, I have created a directory for this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir ~/utm
</span></code></pre></td></tr></table></div></figure>


<p>Which I&rsquo;ve then defined for a shared directory, but this depends if you need to have shared directories from your local workstation.</p>

<p>The next screen is a summary of your choices and you can name your vm here:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/3dee86f1-8f09-4caa-8cb2-0470352c9e77" alt="image" /></p>

<p>Once you are happy select save, and you should see something like this:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/725951b7-d0ed-4b64-8418-1197415da91a" alt="image" /></p>

<p>You can then select the play button to start your VM.</p>

<p>The console should appear and you can select install or try this vm:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/bf8ed7fe-e7c2-4855-a4c0-cfd98857fbd0" alt="image" /></p>

<p>This will start the installation process of a Linux Server:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/09364ab8-be5a-4c51-9a0f-edea04707802" alt="image" /></p>

<p>Here you can select the options that you would like, I would just recommend to ensure that you select <code>Install OpenSSH Server</code> so that you can connect to your VM via SSH.</p>

<p>Once you get to this screen:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/8204583e-2175-4815-a96b-3c4d8063758a" alt="image" /></p>

<p>The installation process is busy and you will have to wait a couple of minutes for it to complete. Once you see the following screen the installation is complete:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/4c8add6a-fb1e-469e-967f-0c78228eb340" alt="image" /></p>

<p>On the right hand side select the circle, then select CD/DVD and select the ubuntu iso and select eject:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/4c17223e-a755-4742-9b95-ef64dc217264" alt="image" /></p>

<h2>Starting your VM</h2>

<p>Then power off the guest and power on again, then you should get a console login, then you can proceed to login, and view the ip address:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/51d56c64-2be2-4036-836d-579fd1bd6ac2" alt="" /></p>

<h2>SSH to your VM</h2>

<p>Now from your terminal you should be able to ssh to the VM:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/7ee94cb4-73bf-4ddc-9eb3-01fcee68a29f" alt="" /></p>

<p>We can also verify that we are running a 64bit vm, by running <code>uname --processor</code>:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/ed444a85-28c1-44af-88ac-5e956a742f59" alt="" /></p>

<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>

<ul>
<li>Linktree: <a href="https://go.ruan.dev/links">https://go.ruan.dev/links</a></li>
<li>Patreon: <a href="https://go.ruan.dev/patreon">https://go.ruan.dev/patreon</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/05/17/running-a-multi-broker-kafka-cluster-on-docker/">Running a Multi-Broker Kafka Cluster on Docker</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-05-17T10:50:57-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>10:50 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we will run a <a href="https://kafka.apache.org/">Kakfa</a> cluster with 3 kafka brokers on docker compose and using a producer to send messages to our topics and a consumer that will receive the messages from the topics, which we will develop in python and explore the <a href="https://github.com/provectus/kafka-ui">kafka-ui</a>.</p>

<h2>What is Kafka?</h2>

<p>Kafka is a distributed event store and stream processing platform. Kafka is used to build real-time streaming data pipelines and real-time streaming applications.</p>

<p>This is a fantastic resource if you want to understand the components better in detail:
- <a href="https://www.upsolver.com/blog/apache-kafka-architecture-what-you-need-to-know">apache-kafka-architecture-what-you-need-to-know</a></p>

<p>But on a high level, the components of a typical Kafka setup:</p>

<ol>
<li>Zookeeper: Kafka relies on Zookeeper to do leadership election of Kafka Brokers and Topic Partitions.</li>
<li>Broker: Kafka server that receives messages from producers, assigns them to offsets and commit the messages to disk storage. A offset is used for data consistency in a event of failure, so that consumers know from where to consume from their last message.</li>
<li>Topic: A topic can be thought of categories to organize messages. Producers writes messages to topics, consumers reads from those topics.</li>
<li>Partitions: A topic is split into multiple partitions. This improves scalability through parallelism (not just one broker). Kafka also does replication</li>
</ol>


<p>For great in detail information about kafka and its components, I encourage you to visit the <a href="https://www.upsolver.com/blog/apache-kafka-architecture-what-you-need-to-know">mentioned post</a> from above.</p>

<h2>Launch Kafka</h2>

<p>This is the <code>docker-compose.yaml</code> that we will be using to run a kafka cluster with 3 broker containers, 1 zookeeper container, 1 producer, 1 consumer and a kafka-ui.</p>

<p>All the source code is available on my <a href="https://github.com/ruanbekker/quick-starts/tree/main/docker/kafka">quick-starts github repository</a> .</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.9&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">zookeeper</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux/amd64</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">confluentinc/cp-zookeeper:${CONFLUENT_PLATFORM_VERSION:-7.4.0}</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zookeeper</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;32181:32181&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;2888:2888&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;3888:3888&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">ZOOKEEPER_SERVER_ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">ZOOKEEPER_CLIENT_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">32181</span>
</span><span class='line'>      <span class="l-Scalar-Plain">ZOOKEEPER_TICK_TIME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2000</span>
</span><span class='line'>      <span class="l-Scalar-Plain">ZOOKEEPER_INIT_LIMIT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>      <span class="l-Scalar-Plain">ZOOKEEPER_SYNC_LIMIT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>      <span class="l-Scalar-Plain">ZOOKEEPER_SERVERS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zookeeper:2888:3888</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthcheck</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo stat | nc localhost 32181</span>
</span><span class='line'>      <span class="l-Scalar-Plain">interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">kafka</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">kafka-ui</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kafka-ui</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">provectuslabs/kafka-ui:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:8080</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">broker-1</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">broker-2</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">broker-3</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_CLUSTERS_0_NAME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">broker-1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">broker-1:29091</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_CLUSTERS_0_METRICS_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">19101</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_CLUSTERS_1_NAME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">broker-2</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_CLUSTERS_1_BOOTSTRAPSERVERS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">broker-2:29092</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_CLUSTERS_1_METRICS_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">19102</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_CLUSTERS_2_NAME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">broker-3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_CLUSTERS_2_BOOTSTRAPSERVERS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">broker-3:29093</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_CLUSTERS_2_METRICS_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">19103</span>
</span><span class='line'>      <span class="l-Scalar-Plain">DYNAMIC_CONFIG_ENABLED</span><span class="p-Indicator">:</span> <span class="s">&#39;true&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">kafka</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">broker-1</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux/amd64</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">confluentinc/cp-kafka:${CONFLUENT_PLATFORM_VERSION:-7.4.0}</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">broker-1</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;9091:9091&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">zookeeper</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_BROKER_ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_ZOOKEEPER_CONNECT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zookeeper:32181</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_INTER_BROKER_LISTENER_NAME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INTERNAL</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_ADVERTISED_LISTENERS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INTERNAL://broker-1:29091,EXTERNAL://localhost:9091</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_DEFAULT_REPLICATION_FACTOR</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_NUM_PARTITIONS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_JMX_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">19101</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_JMX_HOSTNAME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthcheck</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nc -vz localhost 9091</span>
</span><span class='line'>      <span class="l-Scalar-Plain">interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">kafka</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">broker-2</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux/amd64</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">confluentinc/cp-kafka:${CONFLUENT_PLATFORM_VERSION:-7.4.0}</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">broker-2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;9092:9092&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">zookeeper</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_BROKER_ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_ZOOKEEPER_CONNECT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zookeeper:32181</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_INTER_BROKER_LISTENER_NAME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INTERNAL</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_ADVERTISED_LISTENERS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INTERNAL://broker-2:29092,EXTERNAL://localhost:9092</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_DEFAULT_REPLICATION_FACTOR</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_NUM_PARTITIONS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_JMX_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">19102</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_JMX_HOSTNAME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthcheck</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nc -vz localhost 9092</span>
</span><span class='line'>      <span class="l-Scalar-Plain">interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">kafka</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">broker-3</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux/amd64</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">confluentinc/cp-kafka:${CONFLUENT_PLATFORM_VERSION:-7.4.0}</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">broker-3</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;9093:9093&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">zookeeper</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_BROKER_ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_ZOOKEEPER_CONNECT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zookeeper:32181</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_INTER_BROKER_LISTENER_NAME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INTERNAL</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_ADVERTISED_LISTENERS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INTERNAL://broker-3:29093,EXTERNAL://localhost:9093</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_DEFAULT_REPLICATION_FACTOR</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_NUM_PARTITIONS</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_JMX_PORT</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">19103</span>
</span><span class='line'>      <span class="l-Scalar-Plain">KAFKA_JMX_HOSTNAME</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthcheck</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nc -vz localhost 9093</span>
</span><span class='line'>      <span class="l-Scalar-Plain">interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">kafka</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">producer</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux/amd64</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">producer</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ruanbekker/kafka-producer-consumer:2023-05-17</span>
</span><span class='line'>    <span class="c1"># source: https://github.com/ruanbekker/quick-starts/tree/main/docker/kafka/python-client</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ACTION=producer</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">BOOTSTRAP_SERVERS=broker-1:29091,broker-2:29092,broker-3:29093</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">TOPIC=my-topic</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">PYTHONUNBUFFERED=1</span> <span class="c1"># https://github.com/docker/compose/issues/4837#issuecomment-302765592</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">kafka</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">zookeeper</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">broker-1</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">broker-2</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">broker-3</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">consumer</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux/amd64</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">consumer</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ruanbekker/kafka-producer-consumer:2023-05-17</span>
</span><span class='line'>    <span class="c1"># source: https://github.com/ruanbekker/quick-starts/tree/main/docker/kafka/python-client</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ACTION=consumer</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">BOOTSTRAP_SERVERS=broker-1:29091,broker-2:29092,broker-3:29093</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">TOPIC=my-topic</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">CONSUMER_GROUP=cg-group-id</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">PYTHONUNBUFFERED=1</span> <span class="c1"># https://github.com/docker/compose/issues/4837#issuecomment-302765592</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">kafka</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">zookeeper</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">broker-1</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">broker-2</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">broker-3</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">producer</span>
</span><span class='line'>    <span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="s">&quot;json-file&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">max-size</span><span class="p-Indicator">:</span> <span class="s">&quot;1m&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">kafka</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kafka</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Note</strong>: This docker-compose yaml can be found in my <a href="https://github.com/ruanbekker/quick-starts/tree/main/docker/kafka">kafka quick-starts</a> repository.</p>

<p>In our compose file we defined our core stack:</p>

<ul>
<li>1 Zookeeper Container</li>
<li>3 Kafka Broker Containers</li>
<li>1 Kafka UI</li>
</ul>


<p>Then we have our clients:</p>

<ul>
<li>1 Producer that will send messages to our topics (source code: <a href="https://github.com/ruanbekker/quick-starts/blob/main/docker/kafka/python-client/produce.py">https://github.com/ruanbekker/quick-starts/blob/main/docker/kafka/python-client/produce.py</a> )</li>
<li>1 Consumer that will read the messages from our topics (source code: <a href="https://github.com/ruanbekker/quick-starts/blob/main/docker/kafka/python-client/consume.py">https://github.com/ruanbekker/quick-starts/blob/main/docker/kafka/python-client/consume.py</a> )</li>
</ul>


<p>We can boot the stack with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>


<p>You can verify that the brokers are passing their health checks with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose ps
</span><span class='line'>
</span><span class='line'>NAME                IMAGE                                           COMMAND                  SERVICE             CREATED             STATUS                   PORTS
</span><span class='line'>broker-1            confluentinc/cp-kafka:7.4.0                     <span class="s2">&quot;/etc/confluent/dock&quot;</span>   broker-1            <span class="m">5</span> minutes ago       Up <span class="m">4</span> minutes <span class="o">(</span>healthy<span class="o">)</span>   0.0.0.0:9091-&gt;9091/tcp, :::9091-&gt;9091/tcp, 9092/tcp
</span><span class='line'>broker-2            confluentinc/cp-kafka:7.4.0                     <span class="s2">&quot;/etc/confluent/dock&quot;</span>   broker-2            <span class="m">5</span> minutes ago       Up <span class="m">4</span> minutes <span class="o">(</span>healthy<span class="o">)</span>   0.0.0.0:9092-&gt;9092/tcp, :::9092-&gt;9092/tcp
</span><span class='line'>broker-3            confluentinc/cp-kafka:7.4.0                     <span class="s2">&quot;/etc/confluent/dock&quot;</span>   broker-3            <span class="m">5</span> minutes ago       Up <span class="m">4</span> minutes <span class="o">(</span>healthy<span class="o">)</span>   9092/tcp, 0.0.0.0:9093-&gt;9093/tcp, :::9093-&gt;9093/tcp
</span><span class='line'>consumer            ruanbekker/kafka-producer-consumer:2023-05-17   <span class="s2">&quot;sh /src/run.sh $ACT&quot;</span>   consumer            <span class="m">5</span> minutes ago       Up <span class="m">4</span> minutes
</span><span class='line'>kafka-ui            provectuslabs/kafka-ui:latest                   <span class="s2">&quot;/bin/sh -c &#39;java --&quot;</span>   kafka-ui            <span class="m">5</span> minutes ago       Up <span class="m">4</span> minutes             0.0.0.0:8080-&gt;8080/tcp, :::8080-&gt;8080/tcp
</span><span class='line'>producer            ruanbekker/kafka-producer-consumer:2023-05-17   <span class="s2">&quot;sh /src/run.sh $ACT&quot;</span>   producer            <span class="m">5</span> minutes ago       Up <span class="m">4</span> minutes
</span><span class='line'>zookeeper           confluentinc/cp-zookeeper:7.4.0                 <span class="s2">&quot;/etc/confluent/dock&quot;</span>   zookeeper           <span class="m">5</span> minutes ago       Up <span class="m">5</span> minutes <span class="o">(</span>healthy<span class="o">)</span>   0.0.0.0:2888-&gt;2888/tcp, :::2888-&gt;2888/tcp, 0.0.0.0:3888-&gt;3888/tcp, :::3888-&gt;3888/tcp, 2181/tcp, 0.0.0.0:32181-&gt;32181/tcp, :::32181-&gt;32181/tcp
</span></code></pre></td></tr></table></div></figure>


<h2>Producers and Consumers</h2>

<p>The producer generates random data and sends it to a topic, where the consumer will listen on the same topic and read messages from that topic.</p>

<p>To view the output of what the <code>producer</code> is doing, you can tail the logs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker logs -f producer
</span><span class='line'>
</span><span class='line'>setting up producer, checking <span class="k">if</span> brokers are available
</span><span class='line'>brokers not available yet
</span><span class='line'>brokers are available and ready to produce messages
</span><span class='line'>message sent to kafka with squence id of 1
</span><span class='line'>message sent to kafka with squence id of 2
</span><span class='line'>message sent to kafka with squence id of 3
</span></code></pre></td></tr></table></div></figure>


<p>And to view the output of what the <code>consumer</code> is doing, you can tail the logs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker logs -f consumer
</span><span class='line'>
</span><span class='line'>starting consumer, checks <span class="k">if</span> brokers are availabe
</span><span class='line'>brokers not availbe yet
</span><span class='line'>brokers are available and ready to consume messages
</span><span class='line'><span class="o">{</span><span class="s1">&#39;sequence_id&#39;</span>: 10, <span class="s1">&#39;user_id&#39;</span>: <span class="s1">&#39;20520&#39;</span>, <span class="s1">&#39;transaction_id&#39;</span>: <span class="s1">&#39;4026fd10-2aca-4d2e-8bd2-8ef0201af2dd&#39;</span>, <span class="s1">&#39;product_id&#39;</span>: <span class="s1">&#39;17974&#39;</span>, <span class="s1">&#39;address&#39;</span>: <span class="s1">&#39;71741 Lopez Throughway | South John | BT&#39;</span>, <span class="s1">&#39;signup_at&#39;</span>: <span class="s1">&#39;2023-05-11 06:54:52&#39;</span>, <span class="s1">&#39;platform_id&#39;</span>: <span class="s1">&#39;Tablet&#39;</span>, <span class="s1">&#39;message&#39;</span>: <span class="s1">&#39;transaction made by userid 119740995334901&#39;</span><span class="o">}</span>
</span><span class='line'><span class="o">{</span><span class="s1">&#39;sequence_id&#39;</span>: 11, <span class="s1">&#39;user_id&#39;</span>: <span class="s1">&#39;78172&#39;</span>, <span class="s1">&#39;transaction_id&#39;</span>: <span class="s1">&#39;4089cee1-0a58-4d9b-9489-97b6bc4b768f&#39;</span>, <span class="s1">&#39;product_id&#39;</span>: <span class="s1">&#39;21477&#39;</span>, <span class="s1">&#39;address&#39;</span>: <span class="s1">&#39;735 Jasmine Village Apt. 009 | South Deniseland | BN&#39;</span>, <span class="s1">&#39;signup_at&#39;</span>: <span class="s1">&#39;2023-05-17 09:54:10&#39;</span>, <span class="s1">&#39;platform_id&#39;</span>: <span class="s1">&#39;Tablet&#39;</span>, <span class="s1">&#39;message&#39;</span>: <span class="s1">&#39;transaction made by userid 159204336307945&#39;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Kafka UI</h2>

<p>The Kafka UI will be available on <a href="http://localhost:8080">http://localhost:8080</a></p>

<p>Where we can view lots of information, but in the below screenshot we can see our topics:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/5da40db5-a56a-4c7b-8f8c-929568e9eb81" alt="image" /></p>

<p>And when we look at the <code>my-topic</code>, we can see a overview dashboard of our topic information:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/f9feb32f-5828-41a5-91f5-9d614feb8e7c" alt="image" /></p>

<p>We can also look at the messages in our topic, and also search for messages:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/48f58970-d665-4bd5-8e76-5a770e885993" alt="image" /></p>

<p>And we can also look at the current consumers:</p>

<p><img src="https://github.com/ruanbekker/ruanbekker.github.io/assets/567298/68a25d64-9899-4073-ae02-76becc4c149a" alt="image" /></p>

<h2>Resources</h2>

<p>My Quick-Starts Github Repository:</p>

<ul>
<li><a href="https://github.com/ruanbekker/quick-starts">https://github.com/ruanbekker/quick-starts</a></li>
</ul>


<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>

<ul>
<li>Linktree: <a href="https://go.ruan.dev/links">https://go.ruan.dev/links</a></li>
<li>Patreon: <a href="https://go.ruan.dev/patreon">https://go.ruan.dev/patreon</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/03/09/manage-helm-releases-with-terraform/">Manage Helm Releases With Terraform</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-03-09T16:15:47-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>4:15 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/224163430-34e18f11-2182-4d2b-b7ab-f4683c187719.png" alt="helm-releases-with-terraform" /></p>

<p>In this post we will use terraform to deploy a helm release to kubernetes.</p>

<h2>Kubernetes</h2>

<p>For this demonstration I will be using <a href="https://kind.sigs.k8s.io/">kind</a> to deploy a local Kubernetes cluster to the operating system that I am running this on, which will be Ubuntu Linux. For a more in-depth tutorial on Kind, you can see my post on <a href="https://blog.ruanbekker.com/blog/2022/09/20/kind-for-local-kubernetes-clusters/">Kind for Local Kubernetes Clusters</a>.</p>

<h2>Installing the Pre-Requirements</h2>

<p>We will be installing terraform, docker, kind and kubectl on Linux.</p>

<p>Install terraform:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget https://releases.hashicorp.com/terraform/1.3.0/terraform_1.3.0_linux_amd64.zip
</span><span class='line'>unzip terraform_1.3.0_linux_amd64.zip
</span><span class='line'>rm terraform_1.3.0_linux_amd64.zip
</span><span class='line'>mv terraform /usr/bin/terraform
</span></code></pre></td></tr></table></div></figure>


<p>Verify that terraform has been installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform -version
</span></code></pre></td></tr></table></div></figure>


<p>Which in my case returns:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform v1.3.0
</span><span class='line'>on linux_amd64
</span></code></pre></td></tr></table></div></figure>


<p>Install Docker on Linux (be careful to curl pipe bash - trust the scripts that you are running):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl https://get.docker.com <span class="p">|</span> bash
</span></code></pre></td></tr></table></div></figure>


<p>Then running <code>docker ps</code> should return:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>CONTAINER ID   IMAGE        COMMAND         CREATED          STATUS          PORTS       NAMES
</span></code></pre></td></tr></table></div></figure>


<p>Install kind on Linux:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>apt update
</span><span class='line'>curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.17.0/kind-linux-amd64
</span><span class='line'>chmod +x ./kind
</span><span class='line'>sudo mv ./kind /usr/local/bin/kind
</span></code></pre></td></tr></table></div></figure>


<p>Then to verify that kind was installed with <code>kind --version</code> should return:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kind version 0.17.0
</span></code></pre></td></tr></table></div></figure>


<p>Create a kubernetes cluster using kind:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kind create cluster --name rbkr --image kindest/node:v1.24.0
</span></code></pre></td></tr></table></div></figure>


<p>Now install <a href="https://kubernetes.io/docs/tasks/tools/">kubectl</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -LO <span class="s2">&quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;</span>
</span><span class='line'>sudo install -o root -g root -m <span class="m">0755</span> kubectl /usr/local/bin/kubectl
</span></code></pre></td></tr></table></div></figure>


<p>Then to verify that kubectl was installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl version --client
</span></code></pre></td></tr></table></div></figure>


<p>Which in my case returns:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Client Version: version.Info<span class="o">{</span>Major:<span class="s2">&quot;1&quot;</span>, Minor:<span class="s2">&quot;26&quot;</span>, GitVersion:<span class="s2">&quot;v1.26.1&quot;</span>, GitCommit:<span class="s2">&quot;8f94681cd294aa8cfd3407b8191f6c70214973a4&quot;</span>, GitTreeState:<span class="s2">&quot;clean&quot;</span>, BuildDate:<span class="s2">&quot;2023-01-18T15:58:16Z&quot;</span>, GoVersion:<span class="s2">&quot;go1.19.5&quot;</span>, Compiler:<span class="s2">&quot;gc&quot;</span>, Platform:<span class="s2">&quot;linux/amd64&quot;</span><span class="o">}</span>
</span><span class='line'>Kustomize Version: v4.5.7
</span></code></pre></td></tr></table></div></figure>


<p>Now we can test if kubectl can communicate with the kubernetes api server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get nodes
</span></code></pre></td></tr></table></div></figure>


<p>In my case it returns:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>NAME                 STATUS   ROLES           AGE     VERSION
</span><span class='line'>rbkr-control-plane   Ready    control-plane   6m20s   v1.24.0
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform</h2>

<p>Now that our pre-requirements are sorted we can configure terraform to communicate with kubernetes. For that to happen, we need to consult the <a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs">terraform kubernetes provider</a>&rsquo;s documentation.</p>

<p>As per their documentation they provide us with this snippet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">kubernetes</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/kubernetes&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;2.18.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;kubernetes&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="c"># Configuration options</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And from their <a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs">main</a> page, it gives us a couple of options to configure the provider and the easiest is probably to read the <code>~/.kube/config</code> configuration file.</p>

<p>But in cases where you have multiple configurations in your kube config file, this might not be ideal, and I like to be precise, so I will extract the client certificate, client key and cluster ca certificate and endpoint from our <code>~/.kube/config</code> file.</p>

<p>If we run <code>cat ~/.kube/config</code> we will see something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">clusters</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">cluster</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">certificate-authority-data</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">LS0tLS1CRU......FURS0tLS0tCg==</span>
</span><span class='line'>    <span class="l-Scalar-Plain">server</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://127.0.0.1:40305</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'><span class="l-Scalar-Plain">contexts</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">context</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cluster</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'>    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'><span class="l-Scalar-Plain">current-context</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Config</span>
</span><span class='line'><span class="l-Scalar-Plain">preferences</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">users</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kind-rbkr</span>
</span><span class='line'>  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">client-certificate-data</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">LS0tLS1CRX......FURS0tLS0tCg==</span>
</span><span class='line'>    <span class="l-Scalar-Plain">client-key-data</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">LS0tLS1CRUejhKWUk2N2.....S0tCg==</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we will create a directory for our certificates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir ~/certs
</span></code></pre></td></tr></table></div></figure>


<p>I have truncated my kube config for readability, but for our first file <code>certs/client-cert.pem</code> we will copy the value of <code>client-certificate-data:</code>, which will look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat certs/client-cert.pem
</span><span class='line'>LS0tLS1CRX......FURS0tLS0tCg<span class="o">==</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we will copy the contents of <code>client-key-data:</code> into <code>certs/client-key.pem</code> and then lastly the content of <code>certificate-authority-data:</code> into <code>certs/cluster-ca-cert.pem</code>.</p>

<p>So then we should have the following files inside our <code>certs/</code> directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tree certs/
</span><span class='line'>certs/
</span><span class='line'> client-cert.pem
</span><span class='line'> client-key.pem
</span><span class='line'> cluster-ca-cert.pem
</span><span class='line'>
</span><span class='line'><span class="m">0</span> directories, <span class="m">3</span> files
</span></code></pre></td></tr></table></div></figure>


<p>Now make them read only:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>chmod <span class="m">400</span> ~/certs/*
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have that we can start writing our terraform configuration. In <code>providers.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">kubernetes</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/kubernetes&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;2.18.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;kubernetes&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">host</span>                   <span class="o">=</span> <span class="s2">&quot;https://127.0.0.1:40305&quot;</span>
</span><span class='line'>  <span class="nv">client_certificate</span>     <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="nv">client_key</span>             <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-key.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="nv">cluster_ca_certificate</span> <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/cluster-ca-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Your host might look different to mine, but you can find your host endpoint in <code>~/.kube/config</code>.</p>

<p>For a simple test we can list all our namespaces to ensure that our configuration is working. In a file called <code>namespaces.tf</code>, we can populate the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>data <span class="s2">&quot;kubernetes_all_namespaces&quot;</span> <span class="s2">&quot;allns&quot;</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;all-ns&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> data.kubernetes_all_namespaces.allns.namespaces
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to initialize terraform so that it can download the providers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Then we can run a plan which will reveal our namespaces:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform plan
</span><span class='line'>
</span><span class='line'>data.kubernetes_all_namespaces.allns: Reading...
</span><span class='line'>data.kubernetes_all_namespaces.allns: Read <span class="nb">complete </span>after 0s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>a0ff7e83ffd7b2d9953abcac9f14370e842bdc8f126db1b65a18fd09faa3347b<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + all-ns <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      + <span class="s2">&quot;default&quot;</span>,
</span><span class='line'>      + <span class="s2">&quot;kube-node-lease&quot;</span>,
</span><span class='line'>      + <span class="s2">&quot;kube-public&quot;</span>,
</span><span class='line'>      + <span class="s2">&quot;kube-system&quot;</span>,
</span><span class='line'>      + <span class="s2">&quot;local-path-storage&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now remove our <code>namespaces.tf</code> as our test worked:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rm namespaces.tf
</span></code></pre></td></tr></table></div></figure>


<h2>Helm Releases with Terraform</h2>

<p>We will need two things, we need to consult the <a href="https://registry.terraform.io/providers/hashicorp/helm/latest/docs/resources/release">terraform helm release provider</a> documentation and we also need to consult the helm chart documentation which we are interested in.</p>

<p>In my previous post I wrote about <a href="https://blog.ruanbekker.com/blog/2023/01/24/everything-you-need-to-know-about-helm/">Everything you need to know about Helm</a> and I used the <a href="https://artifacthub.io/packages/helm/bitnami/nginx">Bitnami Nginx Helm Chart</a>, so we will use that one again.</p>

<p>As we are working with helm releases, we need to configure the helm provider, I will just extend my configuration from my previous provider config in <code>providers.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">kubernetes</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/kubernetes&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;2.18.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="nv">helm</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/helm&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;2.9.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;kubernetes&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">host</span>                   <span class="o">=</span> <span class="s2">&quot;https://127.0.0.1:40305&quot;</span>
</span><span class='line'>  <span class="nv">client_certificate</span>     <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="nv">client_key</span>             <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-key.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="nv">cluster_ca_certificate</span> <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/cluster-ca-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;helm&quot;</span> <span class="o">{</span>
</span><span class='line'>  kubernetes <span class="o">{</span>
</span><span class='line'>    <span class="nv">host</span>                   <span class="o">=</span> <span class="s2">&quot;https://127.0.0.1:40305&quot;</span>
</span><span class='line'>    <span class="nv">client_certificate</span>     <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'>    <span class="nv">client_key</span>             <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/client-key.pem&quot;</span><span class="o">))</span>
</span><span class='line'>    <span class="nv">cluster_ca_certificate</span> <span class="o">=</span> base64decode<span class="o">(</span>file<span class="o">(</span><span class="s2">&quot;~/certs/cluster-ca-cert.pem&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will create three terraform files:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch <span class="o">{</span>main,outputs,variables<span class="o">}</span>.tf
</span></code></pre></td></tr></table></div></figure>


<p>And our values yaml in <code>helm-chart/nginx/values.yaml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir -p helm-chart/nginx
</span></code></pre></td></tr></table></div></figure>


<p>Then you can copy the values file from <a href="https://artifacthub.io/packages/helm/bitnami/nginx?modal=values">https://artifacthub.io/packages/helm/bitnami/nginx?modal=values</a> into <code>helm-chart/nginx/values.yaml</code>.</p>

<p>In our <code>main.tf</code> I will use two ways to override values in our <code>values.yaml</code> using <code>set</code> and <code>templatefile</code>. The reason for the templatefile, is when we want to fetch a value and want to replace the content with our values file, it could be used when we retrieve a value from a data source as an example. In my example im just using a variable.</p>

<p>We will have the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;helm_release&quot;</span> <span class="s2">&quot;nginx&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>             <span class="o">=</span> var.release_name
</span><span class='line'>  <span class="nv">version</span>          <span class="o">=</span> var.chart_version
</span><span class='line'>  <span class="nv">namespace</span>        <span class="o">=</span> var.namespace
</span><span class='line'>  <span class="nv">create_namespace</span> <span class="o">=</span> var.create_namespace
</span><span class='line'>  <span class="nv">chart</span>            <span class="o">=</span> var.chart_name
</span><span class='line'>  <span class="nv">repository</span>       <span class="o">=</span> var.chart_repository_url
</span><span class='line'>  <span class="nv">dependency_update</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">reuse_values</span>      <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">force_update</span>      <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">atomic</span>              <span class="o">=</span> var.atomic
</span><span class='line'>
</span><span class='line'>  <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>  <span class="o">=</span> <span class="s2">&quot;image.tag&quot;</span>
</span><span class='line'>    <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;1.23.3-debian-11-r3&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>  <span class="o">=</span> <span class="s2">&quot;service.type&quot;</span>
</span><span class='line'>    <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;ClusterIP&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">values</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    templatefile<span class="o">(</span><span class="s2">&quot;${path.module}/helm-chart/nginx/values.yaml&quot;</span>, <span class="o">{</span>
</span><span class='line'>      <span class="nv">NAME_OVERRIDE</span>   <span class="o">=</span> var.release_name
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">)]</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see we are referencing a <code>NAME_OVERRIDE</code> in our <code>values.yaml</code>, I have cleaned up the values file to the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">nameOverride</span><span class="p-Indicator">:</span> <span class="s">&quot;${NAME_OVERRIDE}&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## ref: https://hub.docker.com/r/bitnami/nginx/tags/</span>
</span><span class='line'><span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">registry</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker.io</span>
</span><span class='line'>  <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bitnami/nginx</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1.23.3-debian-11-r3</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>NAME_OVERRIDE</code> must be in a <code>${}</code> format.</p>

<p>In our <code>variables.tf</code> we will have the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">variable &quot;release_name&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;nginx&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The name of our release.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;chart_repository_url&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;https://charts.bitnami.com/bitnami&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The chart repository url.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;chart_name&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;nginx&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The name of of our chart that we want to install from the repository.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;chart_version&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;13.2.20&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The version of our chart.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;namespace&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = string</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = &quot;apps&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;The namespace where our release should be deployed into.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;create_namespace&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = bool</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;If it should create the namespace if it doesnt exist.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variable &quot;atomic&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type        = bool</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default     = false</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;If it should wait until release is deployed.&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And lastly our <code>outputs.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">output &quot;metadata&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">value = helm_release.nginx.metadata</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have all our configuration ready, we can initialize terraform:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Then we can run a plan to see what terraform wants to deploy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform plan
</span></code></pre></td></tr></table></div></figure>


<p>The plan output shows the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span><span class='line'>  + create
</span><span class='line'>
</span><span class='line'>Terraform will perform the following actions:
</span><span class='line'>
</span><span class='line'>  <span class="c"># helm_release.nginx will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;helm_release&quot;</span> <span class="s2">&quot;nginx&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">atomic</span>                     <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">chart</span>                      <span class="o">=</span> <span class="s2">&quot;nginx&quot;</span>
</span><span class='line'>      + <span class="nv">cleanup_on_fail</span>            <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">create_namespace</span>           <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>      + <span class="nv">dependency_update</span>          <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">disable_crd_hooks</span>          <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">disable_openapi_validation</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">disable_webhooks</span>           <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">force_update</span>               <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">id</span>                         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">lint</span>                       <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">manifest</span>                   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">max_history</span>                <span class="o">=</span> 0
</span><span class='line'>      + <span class="nv">metadata</span>                   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">name</span>                       <span class="o">=</span> <span class="s2">&quot;nginx&quot;</span>
</span><span class='line'>      + <span class="nv">namespace</span>                  <span class="o">=</span> <span class="s2">&quot;apps&quot;</span>
</span><span class='line'>      + <span class="nv">pass_credentials</span>           <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">recreate_pods</span>              <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">render_subchart_notes</span>      <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>      + <span class="nv">replace</span>                    <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">repository</span>                 <span class="o">=</span> <span class="s2">&quot;https://charts.bitnami.com/bitnami&quot;</span>
</span><span class='line'>      + <span class="nv">reset_values</span>               <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">reuse_values</span>               <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">skip_crds</span>                  <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">status</span>                     <span class="o">=</span> <span class="s2">&quot;deployed&quot;</span>
</span><span class='line'>      + <span class="nv">timeout</span>                    <span class="o">=</span> 300
</span><span class='line'>      + <span class="nv">values</span>                     <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>          + <span class="s">&lt;&lt;-EOT</span>
</span><span class='line'><span class="s">                nameOverride: &quot;nginx&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">                ## ref: https://hub.docker.com/r/bitnami/nginx/tags/</span>
</span><span class='line'><span class="s">                image:</span>
</span><span class='line'><span class="s">                  registry: docker.io</span>
</span><span class='line'><span class="s">                  repository: bitnami/nginx</span>
</span><span class='line'><span class="s">                  tag: 1.23.3-debian-11-r3</span>
</span><span class='line'><span class="s">            EOT</span>,
</span><span class='line'>        <span class="o">]</span>
</span><span class='line'>      + <span class="nv">verify</span>                     <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">version</span>                    <span class="o">=</span> <span class="s2">&quot;13.2.20&quot;</span>
</span><span class='line'>      + <span class="nb">wait</span>                       <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">wait_for_jobs</span>              <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>
</span><span class='line'>      + <span class="nb">set</span> <span class="o">{</span>
</span><span class='line'>          + <span class="nv">name</span>  <span class="o">=</span> <span class="s2">&quot;image.tag&quot;</span>
</span><span class='line'>          + <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;1.23.3-debian-11-r3&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">1</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + <span class="nv">metadata</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once we are happy with our plan, we can run a apply:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform apply
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">1</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + <span class="nv">metadata</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Do you want to perform these actions?
</span><span class='line'>  Terraform will perform the actions described above.
</span><span class='line'>  Only <span class="s1">&#39;yes&#39;</span> will be accepted to approve.
</span><span class='line'>
</span><span class='line'>  Enter a value: yes
</span><span class='line'>
</span><span class='line'>helm_release.nginx: Creating...
</span><span class='line'>helm_release.nginx: Still creating... <span class="o">[</span>10s elapsed<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="nv">metadata</span> <span class="o">=</span> tolist<span class="o">([</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;app_version&quot;</span> <span class="o">=</span> <span class="s2">&quot;1.23.3&quot;</span>
</span><span class='line'>    <span class="s2">&quot;chart&quot;</span> <span class="o">=</span> <span class="s2">&quot;nginx&quot;</span>
</span><span class='line'>    <span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="s2">&quot;nginx&quot;</span>
</span><span class='line'>    <span class="s2">&quot;namespace&quot;</span> <span class="o">=</span> <span class="s2">&quot;apps&quot;</span>
</span><span class='line'>    <span class="s2">&quot;revision&quot;</span> <span class="o">=</span> 1
</span><span class='line'>    <span class="s2">&quot;values&quot;</span> <span class="o">=</span> <span class="s2">&quot;{\&quot;image\&quot;:{\&quot;registry\&quot;:\&quot;docker.io\&quot;,\&quot;repository\&quot;:\&quot;bitnami/nginx\&quot;,\&quot;tag\&quot;:\&quot;1.23.3-debian-11-r3\&quot;},\&quot;nameOverride\&quot;:\&quot;nginx\&quot;}&quot;</span>
</span><span class='line'>    <span class="s2">&quot;version&quot;</span> <span class="o">=</span> <span class="s2">&quot;13.2.20&quot;</span>
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we can verify if the pod is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get pods -n apps
</span><span class='line'>NAME                    READY   STATUS    RESTARTS   AGE
</span><span class='line'>nginx-59bdc6465-xdbfh   1/1     Running   <span class="m">0</span>          2m35s
</span></code></pre></td></tr></table></div></figure>


<h2>Importing Helm Releases into Terraform State</h2>

<p>If you have an existing helm release that was deployed with helm and you want to transfer the ownership to terraform, you first need to write the terraform code, then import the resources into terraform state using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform import helm_release.nginx apps/nginx
</span></code></pre></td></tr></table></div></figure>


<p>Where the last argument is <code>&lt;namespace&gt;/&lt;release-name&gt;</code>. Once that is imported you can run terraform plan and apply.</p>

<p>If you want to discover all helm releases managed by helm you can use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl get all -A -l app.kubernetes.io/managed-by<span class="o">=</span>Helm
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>

<ul>
<li>Linktree: <a href="https://go.ruan.dev/links">https://go.ruan.dev/links</a></li>
<li>Patreon: <a href="https://go.ruan.dev/patreon">https://go.ruan.dev/patreon</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2023/03/05/persisting-terraform-remote-state-in-gitlab/">Persisting Terraform Remote State in Gitlab</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2023-03-05T01:43:54-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2023</span></span> <span class='time'>1:43 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/222946002-7cd88466-c584-4ea0-b190-54b1c3052865.png" alt="terraform-state-gitlab" /></p>

<p>In this tutorial we will demonstrate how to persist your terraform state in gitlab managed terraform state, using the terraform http backend.</p>

<p>For detailed information about this consult <a href="https://docs.gitlab.com/ee/user/infrastructure/iac/terraform_state.html">their documentation</a></p>

<h2>What are we doing?</h2>

<p>We will create a terraform pipeline which will run the plan step automatically and a manual step to run the apply step.</p>

<p>During these steps and different pipelines we need to persist our terraform state remotely so that new pipelines can read from our state what we last stored.</p>

<p>Gitlab offers a <a href="https://docs.gitlab.com/ee/user/infrastructure/iac/terraform_state.html">remote backend</a> for our terraform state which we can use, and we will use a basic example of using the random resource.</p>

<h2>Prerequisites</h2>

<p>If you don&rsquo;t see the &ldquo;Infrastructure&rdquo; menu on your left, you need to enable it at &ldquo;Settings&rdquo;, &ldquo;General&rdquo;, &ldquo;Visibility&rdquo;, &ldquo;Project features&rdquo;, &ldquo;Permissions&rdquo; and under &ldquo;Operations&rdquo;, turn on the toggle.</p>

<p>For more information on this see their <a href="https://docs.gitlab.com/ee/user/infrastructure/iac/terraform_state.html#prerequisites">documentation</a></p>

<h2>Authentication</h2>

<p>For this demonstration I created a token which is only scoped for this one project, for this we need a to create a token under, &ldquo;Settings&rdquo;, &ldquo;Access Tokens&rdquo;:</p>

<p><img src="https://user-images.githubusercontent.com/567298/222896148-6b0121fe-fceb-470e-a096-5db03ae0eab9.png" alt="image" /></p>

<p>Select the <code>api</code> under scope:</p>

<p><img src="https://user-images.githubusercontent.com/567298/222896298-fee26e1f-6bcf-4d7c-80eb-ed48ded33bf2.png" alt="image" /></p>

<p>Store the token name and token value as <code>TF_USERNAME</code> and <code>TF_PASSWORD</code> as a CICD variable under &ldquo;Settings&rdquo;, &ldquo;CI/CD&rdquo;, &ldquo;Variables&rdquo;.</p>

<h2>Terraform Code</h2>

<p>We will use a basic <code>random_uuid</code> resource for this demonstration, our <code>main.tf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "random_uuid" "uuid" {}
</span><span class='line'>
</span><span class='line'>output "uuid" {
</span><span class='line'>  value       = random_uuid.uuid.result
</span><span class='line'>  sensitive   = false
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Our <code>providers.tf</code>, you will notice the <code>backend "http" {}</code> is what is required for our gitlab remote state:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>terraform {
</span><span class='line'>  required_providers {
</span><span class='line'>    random = {
</span><span class='line'>      source = "hashicorp/random"
</span><span class='line'>      version = "3.4.3"
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>  backend "http" {}
</span><span class='line'>  required_version = "~&gt; 1.3.6"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>provider "random" {}</span></code></pre></td></tr></table></div></figure>


<p>Push that up to gitlab for now.</p>

<h2>Gitlab Pipeline</h2>

<p>Our <code>.gitlab-ci.yml</code> consists of a plan step and a apply step which is a manual step as we first want to review our plan step before we apply.</p>

<p>Our pipeline will only run on the default branch, which in my case is main:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hashicorp/terraform:1.3.6</span>
</span><span class='line'>  <span class="l-Scalar-Plain">entrypoint</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">cache</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">.terraform</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">workflow</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">rules</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">if</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">never</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">variables</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">TF_ADDRESS</span><span class="p-Indicator">:</span> <span class="s">&quot;https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/terraform/state/default-terraform.tfstate&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">stages</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">plan</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apply</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">.terraform_init</span><span class="p-Indicator">:</span> <span class="nl">&amp;terraform_init</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">terraform init</span>
</span><span class='line'>      <span class="l-Scalar-Plain">-backend-config=address=${TF_ADDRESS}</span>
</span><span class='line'>      <span class="l-Scalar-Plain">-backend-config=lock_address=${TF_ADDRESS}/lock</span>
</span><span class='line'>      <span class="l-Scalar-Plain">-backend-config=unlock_address=${TF_ADDRESS}/lock</span>
</span><span class='line'>      <span class="l-Scalar-Plain">-backend-config=username=${TF_USERNAME}</span>
</span><span class='line'>      <span class="l-Scalar-Plain">-backend-config=password=${TF_PASSWORD}</span>
</span><span class='line'>      <span class="l-Scalar-Plain">-backend-config=lock_method=POST</span>
</span><span class='line'>      <span class="l-Scalar-Plain">-backend-config=unlock_method=DELETE</span>
</span><span class='line'>      <span class="l-Scalar-Plain">-backend-config=retry_wait_min=5</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">terraform:plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">plan</span>
</span><span class='line'>  <span class="l-Scalar-Plain">artifacts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;**/*.tfplan&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;**/.terraform.lock.hcl&#39;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">before_script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="nv">*terraform_init</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">terraform validate</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">terraform plan -input=false -out default.tfplan</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">terraform:apply</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">stage</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apply</span>
</span><span class='line'>  <span class="l-Scalar-Plain">artifacts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;**/*.tfplan&#39;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&#39;**/.terraform.lock.hcl&#39;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">before_script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="nv">*terraform_init</span>
</span><span class='line'>  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">terraform apply -input=false -auto-approve default.tfplan</span>
</span><span class='line'>  <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">manual</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where the magic happens is in the <code>terraform init</code> step, that is where we will initialize the terraform state in gitlab, and as you can see we are taking the <code>TF_ADDRESS</code> variable to define the path of our state and in this case our state file will be named <code>default-terraform.tfstate</code>.</p>

<p>If it was a case where you are deploying multiple environments, you can use something like <code>${ENVIRONMENT}-terraform.tfstate</code>.</p>

<p>When we run our pipeline, we can look at our plan step:</p>

<p><img src="https://user-images.githubusercontent.com/567298/222947389-9d9d8d4f-a114-44b5-b183-a2b126ba82b8.png" alt="image" /></p>

<p>Once we are happy with this we can run the manual step and do the apply step, then our pipeline should look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/222930015-6445a5da-7887-47a6-989e-f33a33b9451a.png" alt="image" /></p>

<p>When we inspect our terraform state in the infrastructure menu, we can see the state file was created:</p>

<p><img src="https://user-images.githubusercontent.com/567298/222901200-2cd0a0f9-6e81-438f-bc74-286778b648d4.png" alt="image" /></p>

<h2>Thank You</h2>

<p>Thanks for reading, feel free to check out my <a href="https://ruan.dev/">website</a>, feel free to subscribe to my <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a> or follow me at <a href="https://twitter.com/ruanbekker">@ruanbekker</a> on Twitter.</p>

<ul>
<li>Linktree: <a href="https://go.ruan.dev/links">https://go.ruan.dev/links</a></li>
<li>Patreon: <a href="https://go.ruan.dev/patreon">https://go.ruan.dev/patreon</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Carbon</h1>
  <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CEAIP2JL&placement=blogruanbekkercom" id="_carbonads_js"></script>
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>

<section>
  <h1>Say Hi!</h1>
  Send me a note using the <a href="https://saythanks.io/to/ruanbekker">saythanks.io</a> project.
</section>

<section>
  <h1>Newsletter</h1>
  View my newsletter on <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog" target="_blank">digests.ruanbekker.com</a>
</section>

<section>
  <h1>Cheetsheet Repository</h1>
  Have a look at my <strong>Cheetsheets Github Repository</strong>:
  <p></p>
  <a href="https://github.com/ruanbekker/cheatsheets" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719365-1d8a05e2-a0d3-4078-a84f-c691544e4b8f.png" width="480" height="240"></a>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2023/12/22/how-to-use-cert-manager-dns-challenge-with-cloudflare-on-kubernetes-with-helm/">How to Use Cert-Manager DNS Challenge With Cloudflare on Kubernetes With Helm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/12/22/how-to-deploy-ingress-nginx-controller-on-kubernetes-with-helm/">How to Deploy Ingress-Nginx Controller on Kubernetes With Helm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/08/03/creating-a-python-lambda-function-with-terraform-on-aws/">Creating a Python Lambda Function With Terraform on AWS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/07/15/how-to-use-the-mysql-terraform-provider/">How to Use the MySQL Terraform Provider</a>
      </li>
    
      <li class="post">
        <a href="/blog/2023/07/15/how-to-use-the-aws-terraform-provider/">How to Use the AWS Terraform Provider</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest elasticsearch cheatsheet in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719853-fe9a50a4-03f2-4a26-a422-0deb946ca09c.png" width="480" height="240"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2024 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ruanbekker" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
