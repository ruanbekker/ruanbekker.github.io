
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="While looking into working with mongodb using golang, I found it quite frustrating getting it up and running and decided to make a quick post about &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/posts/11/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
<script>
(function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
})(document, window, '//fh-blog-ruanbekker-com.home.ruan.dev/tracker.js', 'fathom');
fathom('set', 'siteId', 'MWBHH');
fathom('trackPageview');
</script>
<!-- / Fathom -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/17/mongodb-examples-with-golang/">MongoDB Examples With Golang</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-17T08:51:35-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>8:51 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55478904-236e9200-561d-11e9-9382-f31b25a9ae03.png" alt="" /></p>

<p>While looking into working with mongodb using golang, I found it quite frustrating getting it up and running and decided to make a quick post about it.</p>

<p><a href="https://bekkerclothing.com/collections/developer?utm_source=blog.ruanbekker.com&utm_medium=blog&utm_campaign=leaderboard_ad" target="_blank"><img alt="bekker-clothing-developer-tshirts" src="https://user-images.githubusercontent.com/567298/70170981-7c278a80-16d6-11ea-9759-6621d02c1423.png"></a></p>

<h2>What are we doing?</h2>

<p>Examples using the golang driver for mongodb to connect, read, update and delete documents from mongodb.</p>

<h2>Environment:</h2>

<p>Provision a mongodb server in docker:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker network create container-net
</span><span class='line'>$ docker run -itd --name mongodb --network container-net -p 27017:27017 ruanbekker/mongodb</span></code></pre></td></tr></table></div></figure>


<p>Drop into a golang environment using docker:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run -it golang:alpine sh</span></code></pre></td></tr></table></div></figure>


<p>Get the dependencies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apk add --no-cache git</span></code></pre></td></tr></table></div></figure>


<p>Change to your project path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir $GOPATH/src/myapp
</span><span class='line'>$ cd $GOPATH/src/myapp</span></code></pre></td></tr></table></div></figure>


<p>Download the golang mongodb driver:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go get go.mongodb.org/mongo-driver</span></code></pre></td></tr></table></div></figure>


<h2>Connecting to MongoDB in Golang</h2>

<p>First example will be to connect to your mongodb instance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;context&quot;</span>
</span><span class='line'>    <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>    <span class="s">&quot;log&quot;</span>
</span><span class='line'>    <span class="s">&quot;go.mongodb.org/mongo-driver/mongo&quot;</span>
</span><span class='line'>    <span class="s">&quot;go.mongodb.org/mongo-driver/bson&quot;</span>
</span><span class='line'>    <span class="s">&quot;go.mongodb.org/mongo-driver/mongo/options&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">Name</span> <span class="kt">string</span>
</span><span class='line'>    <span class="nx">Age</span>  <span class="kt">int</span>
</span><span class='line'>    <span class="nx">City</span> <span class="kt">string</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">clientOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Client</span><span class="p">().</span><span class="nx">ApplyURI</span><span class="p">(</span><span class="s">&quot;mongodb://mongodb:27017&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">clientOptions</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Ping</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Connected to MongoDB!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running our app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Connected to MongoDB!
</span></code></pre></td></tr></table></div></figure>


<h2>Writing to MongoDB with Golang</h2>

<p>Let&rsquo;s insert a single document to MongoDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">..</span>
</span><span class='line'>    <span class="nx">collection</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Database</span><span class="p">(</span><span class="s">&quot;mydb&quot;</span><span class="p">).</span><span class="nx">Collection</span><span class="p">(</span><span class="s">&quot;persons&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">ruan</span> <span class="o">:=</span> <span class="nx">Person</span><span class="p">{</span><span class="s">&quot;Ruan&quot;</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="s">&quot;Cape Town&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">insertResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">InsertOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">ruan</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Inserted a Single Document: &quot;</span><span class="p">,</span> <span class="nx">insertResult</span><span class="p">.</span><span class="nx">InsertedID</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running it will produce:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Connected to MongoDB!
</span><span class='line'>Inserted a single document:  ObjectID<span class="o">(</span><span class="s2">&quot;5cb717dcf597b4411252341f&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Writing more than one document:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>func main<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    ..
</span><span class='line'>    collection :<span class="o">=</span> client.Database<span class="o">(</span><span class="s2">&quot;mydb&quot;</span><span class="o">)</span>.Collection<span class="o">(</span><span class="s2">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    ruan :<span class="o">=</span> Person<span class="o">{</span><span class="s2">&quot;Ruan&quot;</span>, 34, <span class="s2">&quot;Cape Town&quot;</span><span class="o">}</span>
</span><span class='line'>    james :<span class="o">=</span> Person<span class="o">{</span><span class="s2">&quot;James&quot;</span>, 32, <span class="s2">&quot;Nairobi&quot;</span><span class="o">}</span>
</span><span class='line'>    frankie :<span class="o">=</span> Person<span class="o">{</span><span class="s2">&quot;Frankie&quot;</span>, 31, <span class="s2">&quot;Nairobi&quot;</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    trainers :<span class="o">=</span> <span class="o">[]</span>interface<span class="o">{}{</span>james, frankie<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    insertManyResult, err :<span class="o">=</span> collection.InsertMany<span class="o">(</span>context.TODO<span class="o">()</span>, trainers<span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span><span class='line'>      log.Fatal<span class="o">(</span>err<span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>    fmt.Println<span class="o">(</span><span class="s2">&quot;Inserted multiple documents: &quot;</span>, insertManyResult.InsertedIDs<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will output in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Inserted Multiple Documents:  <span class="o">[</span>ObjectID<span class="o">(</span><span class="s2">&quot;5cb717dcf597b44112523420&quot;</span><span class="o">)</span> ObjectID<span class="o">(</span><span class="s2">&quot;5cb717dcf597b44112523421&quot;</span><span class="o">)]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Updating Documents in MongoDB using Golang</h2>

<p>Updating Frankie&rsquo;s age:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>func main<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    ..
</span><span class='line'>    filter :<span class="o">=</span> bson.D<span class="o"></span>
</span><span class='line'>    update :<span class="o">=</span> bson.D<span class="o">{</span>
</span><span class='line'>        <span class="o">{</span><span class="s2">&quot;$inc&quot;</span>, bson.D<span class="o">{</span>
</span><span class='line'>            <span class="o">{</span><span class="s2">&quot;age&quot;</span>, 1<span class="o">}</span>,
</span><span class='line'>        <span class="o">}}</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    updateResult, err :<span class="o">=</span> collection.UpdateOne<span class="o">(</span>context.TODO<span class="o">()</span>, filter, update<span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span><span class='line'>      log.Fatal<span class="o">(</span>err<span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>    fmt.Printf<span class="o">(</span><span class="s2">&quot;Matched %v documents and updated %v documents.\n&quot;</span>, updateResult.MatchedCount, updateResult.ModifiedCount<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running that will update Frankie&rsquo;s age:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Matched <span class="m">1</span> documents and updated <span class="m">1</span> documents.
</span></code></pre></td></tr></table></div></figure>


<h2>Reading Data from MongoDB</h2>

<p>Reading the data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">funct</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">..</span>
</span><span class='line'>    <span class="nx">filter</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p"></span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">result</span> <span class="nx">Trainer</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">FindOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">filter</span><span class="p">).</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Found a single document: %+v\n&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">findOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Find</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">findOptions</span><span class="p">.</span><span class="nx">SetLimit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Found a single document: <span class="o">{</span>Name:Frankie Age:32 City:Nairobi<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finding multiple documents and returning the cursor</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">..</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">results</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Trainer</span>
</span><span class='line'>  <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">Find</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">,</span> <span class="nx">findOptions</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">Next</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">elem</span> <span class="nx">Trainer</span>
</span><span class='line'>      <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">results</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">cur</span><span class="p">.</span><span class="nx">Close</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">())</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Found multiple documents (array of pointers): %+v\n&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="err">$</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span><span class='line'><span class="nx">Found</span> <span class="nx">multiple</span> <span class="nx">documents</span> <span class="p">(</span><span class="nx">array</span> <span class="nx">of</span> <span class="nx">pointers</span><span class="p">):</span> <span class="p">[</span><span class="mh">0xc0001215c0</span> <span class="mh">0xc0001215f0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deleting Data from MongoDB:</h2>

<p>Deleting our data and closing the connection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">(){</span>
</span><span class='line'>    <span class="p">..</span>
</span><span class='line'>    <span class="nx">deleteResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">DeleteMany</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Deleted %v documents in the trainers collection\n&quot;</span><span class="p">,</span> <span class="nx">deleteResult</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Connection to MongoDB closed.&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Deleted <span class="m">3</span> documents in the trainers collection
</span><span class='line'>Connection to MongoDB closed.
</span></code></pre></td></tr></table></div></figure>


<p>The code for this example can be found at <a href="https://github.com/ruanbekker/code-examples/blob/master/mongodb/golang/examples.go">github.com/ruanbekker/code-examples/mongodb/golang/examples.go</a></p>

<h2>Resources:</h2>

<ul>
<li><a href="https://www.mongodb.com/blog/post/mongodb-go-driver-tutorial">https://www.mongodb.com/blog/post/mongodb-go-driver-tutorial</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/06/sql-inner-joins-examples-with-sqlite/">SQL Inner Joins Examples With SQLite</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-06T15:47:38-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55704774-53cb7d00-59dd-11e9-9f43-65ec3aa857b5.png" alt="sqlite" /></p>

<h2>Overview</h2>

<p>In this tutorial we will get started with sqlite and use inner joins to query data from multiple tables to answer specific use case needs.</p>

<h2>Connecting to your Sqlite Database</h2>

<p>Connecting to your database uses the argument to the target database. You can use additional flags to set the properties that you want to enable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="err">$</span> <span class="n">sqlite3</span> <span class="o">-</span><span class="n">header</span> <span class="o">-</span><span class="k">column</span> <span class="n">mydatabase</span><span class="p">.</span><span class="n">db</span>
</span></code></pre></td></tr></table></div></figure>


<p>or you can specify the additional options to your config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &gt; ~/.sqliterc <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">.mode column</span>
</span><span class='line'><span class="s">.headers on</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then connecting to your database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sqlite3 mydatabase.db
</span><span class='line'>-- Loading resources from /Users/ruan/.sqliterc
</span><span class='line'>SQLite version 3.16.0 2016-11-04 19:09:39
</span><span class='line'>Enter <span class="s2">&quot;.help&quot;</span> <span class="k">for</span> usage hints.
</span><span class='line'>sqlite&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Tables</h2>

<p>Create the <code>users</code> table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">users</span> <span class="p">(</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">id</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">surname</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">city</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">age</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">credit_card_num</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">job_position</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the <code>transactions</code> table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">transactions</span> <span class="p">(</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">credit_card_num</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">transaction_id</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">shop_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">product_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">spent_total</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">purchase_option</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can view the tables using <code>.tables</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="p">.</span><span class="n">tables</span>
</span><span class='line'><span class="n">transactions</span>  <span class="n">users</span>
</span></code></pre></td></tr></table></div></figure>


<p>And view the schema of the tables using <code>.schema &lt;table-name&gt;</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="p">.</span><span class="k">schema</span> <span class="n">users</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="p">(</span>
</span><span class='line'><span class="n">id</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">surname</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">city</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'><span class="n">age</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">credit_card_num</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">job_position</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Write to Sqlite Database</h2>

<p>Now we will populate data to our tables. Insert a record to our users table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">users</span> <span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ruan&#39;</span><span class="p">,</span> <span class="s1">&#39;bekker&#39;</span><span class="p">,</span> <span class="s1">&#39;cape town&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;2345-8970-6712-4352&#39;</span><span class="p">,</span> <span class="s1">&#39;devops&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Insert a record to our transactions table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">transactions</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;2345-8970-6712-4352&#39;</span><span class="p">,</span> <span class="mi">981623</span><span class="p">,</span> <span class="s1">&#39;spaza01&#39;</span><span class="p">,</span> <span class="s1">&#39;burger&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">.</span><span class="mi">02</span><span class="p">,</span> <span class="s1">&#39;credit_card&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Read from the Sqlite Database</h2>

<p>Read the data from the users table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">users</span><span class="p">;</span>
</span><span class='line'><span class="n">id</span>          <span class="n">name</span>        <span class="n">surname</span>     <span class="n">city</span>        <span class="n">age</span>         <span class="n">credit_card_num</span>      <span class="n">job_position</span>
</span><span class='line'><span class="c1">----------  ----------  ----------  ----------  ----------  -------------------  ------------</span>
</span><span class='line'><span class="mi">1</span>           <span class="n">ruan</span>        <span class="n">bekker</span>      <span class="n">cape</span> <span class="n">town</span>   <span class="mi">31</span>          <span class="mi">2345</span><span class="o">-</span><span class="mi">8970</span><span class="o">-</span><span class="mi">6712</span><span class="o">-</span><span class="mi">4352</span>  <span class="n">devops</span>
</span></code></pre></td></tr></table></div></figure>


<p>Read the data from the transactions table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">transactions</span><span class="p">;</span>
</span><span class='line'><span class="n">credit_card_num</span>      <span class="n">transaction_id</span>  <span class="n">shop_name</span>   <span class="n">product_name</span>  <span class="n">spent_total</span>  <span class="n">purchase_option</span>
</span><span class='line'><span class="c1">-------------------  --------------  ----------  ------------  -----------  ---------------</span>
</span><span class='line'><span class="mi">2345</span><span class="o">-</span><span class="mi">8970</span><span class="o">-</span><span class="mi">6712</span><span class="o">-</span><span class="mi">4352</span>  <span class="mi">981623</span>          <span class="n">spaza01</span>     <span class="n">burger</span>        <span class="mi">101</span><span class="p">.</span><span class="mi">02</span>       <span class="n">credit_card</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Inner Joins with Sqlite</h2>

<p>This is where stuff gets interesting.</p>

<p>Let&rsquo;s say you want to join data from 2 tables, in this example we have a table with our userdata and a table with transaction data.</p>

<p>Say we want to see the user&rsquo;s name, transaction id, the product they purchased and the total amount spent, we will make use of inner joins.</p>

<p>Example looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">transaction_id</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">spent_total</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">from</span> <span class="n">users</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">a</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">transactions</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">credit_card_num</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">where</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="s1">&#39;2345-8970-6712-4352&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">name</span>        <span class="n">transaction_id</span>  <span class="n">product_name</span>  <span class="n">spent_total</span>
</span><span class='line'><span class="c1">----------  --------------  ------------  -----------</span>
</span><span class='line'><span class="n">ruan</span>        <span class="mi">981623</span>          <span class="n">burger</span>         <span class="mi">101</span><span class="p">.</span><span class="mi">02</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say you dont know the credit_card number but you would like to do a lookup the credit card number via the user&rsquo;s id, then pass the value to the where statement:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">transaction_id</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">spent_total</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">from</span> <span class="n">users</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">a</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">transactions</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">credit_card_num</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">where</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="n">credit_card_num</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="n">name</span>        <span class="n">transaction_id</span>  <span class="n">product_name</span>  <span class="n">spent_total</span>
</span><span class='line'><span class="c1">----------  --------------  ------------  -----------</span>
</span><span class='line'><span class="n">ruan</span>        <span class="mi">981623</span>          <span class="n">burger</span>         <span class="mi">101</span><span class="p">.</span><span class="mi">02</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s create another table called <code>products</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">products</span> <span class="p">(</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">product_id</span> <span class="nb">INTEGER</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span> <span class="n">product_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">product_category</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">product_price</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Write a record with product data to the table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">products</span> <span class="k">values</span><span class="p">(</span><span class="mi">0231</span><span class="p">,</span> <span class="s1">&#39;burger&#39;</span><span class="p">,</span> <span class="s1">&#39;fast foods&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">.</span><span class="mi">02</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, lets say the question will be that we need to display the users name, credit card number, product name as well as the product category and products price, by only giving you the credit card number</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">credit_card_num</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">product_category</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">product_price</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">from</span> <span class="n">users</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">a</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">transactions</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">products</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="k">c</span> <span class="k">on</span> <span class="n">b</span><span class="p">.</span><span class="n">product_name</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">product_name</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">where</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="s1">&#39;2345-8970-6712-4352&#39;</span> <span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">product_name</span> <span class="o">=</span> <span class="s1">&#39;burger&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">name</span>        <span class="n">credit_card_num</span>      <span class="n">product_name</span>  <span class="n">product_category</span>   <span class="n">product_price</span>
</span><span class='line'><span class="c1">----------  -------------------  ------------  -----------------  -------------</span>
</span><span class='line'><span class="n">ruan</span>        <span class="mi">2345</span><span class="o">-</span><span class="mi">8970</span><span class="o">-</span><span class="mi">6712</span><span class="o">-</span><span class="mi">4352</span>  <span class="n">burger</span>        <span class="n">fast</span> <span class="n">foods</span>         <span class="mi">101</span><span class="p">.</span><span class="mi">02</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/06/install-elasticsearch-with-ansible-tutorial/">Install Elasticsearch With Ansible Tutorial</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-06T15:45:09-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:45 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55700285-f3cdda00-59ce-11e9-9c00-a05b9d469e23.png" alt="" /></p>

<p>In this tutorial we will install a elasticsearch cluster with ansible (well rather a node)</p>

<p>Our inventory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat inventory.ini
</span><span class='line'>[newes]
</span><span class='line'>esnewnode
</span><span class='line'>
</span><span class='line'>[newes:vars]
</span><span class='line'>ansible_python_interpreter=/usr/bin/python3</span></code></pre></td></tr></table></div></figure>


<p>Our playbook to bootstrap our nodes with Python:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat bootstrap-python.yml
</span><span class='line'>---
</span><span class='line'>- hosts: newes
</span><span class='line'>  gather_facts: False
</span><span class='line'>
</span><span class='line'>  tasks:
</span><span class='line'>  - name: install python
</span><span class='line'>    raw: test -e /usr/bin/python || ( apt update && apt install python -y )</span></code></pre></td></tr></table></div></figure>


<p>Our playbook to provision users:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat provision-users.yml
</span><span class='line'>---
</span><span class='line'># Provisions User on Nodes
</span><span class='line'># Setup Passwordless SSH from Jumpbox
</span><span class='line'># Install Packages using APT
</span><span class='line'>- name: bootstrap python
</span><span class='line'>  hosts: newes
</span><span class='line'>  roles:
</span><span class='line'>    - bootstrap-python
</span><span class='line'>
</span><span class='line'>- name: setup pre-requisites
</span><span class='line'>  hosts: newes
</span><span class='line'>  roles:
</span><span class='line'>    - create-sudo-user
</span><span class='line'>    - install-modules
</span><span class='line'>    - configure-hosts-file
</span><span class='line'>
</span><span class='line'>#- name: setup ruan user on the nodes
</span><span class='line'>#  become: yes
</span><span class='line'>#  become_user: ruan
</span><span class='line'>#  hosts: admin
</span><span class='line'>#  roles:
</span><span class='line'>#    - configure-admin
</span><span class='line'>
</span><span class='line'>- name: copy public key to nodes
</span><span class='line'>  become: yes
</span><span class='line'>  become_user: ruan
</span><span class='line'>  hosts: newes
</span><span class='line'>  roles:
</span><span class='line'>    - copy-keys
</span><span class='line'>
</span><span class='line'>- name: install elasticsearch
</span><span class='line'>  hosts: newes
</span><span class='line'>  roles:
</span><span class='line'>    - elasticsearch</span></code></pre></td></tr></table></div></figure>


<p>Our roles that will be included in our playbooks from above:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/create-sudo-user/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: Create Sudo User
</span><span class='line'>  user: name=ruan
</span><span class='line'>        groups=sudo
</span><span class='line'>        shell=/bin/bash
</span><span class='line'>        generate_ssh_key=no
</span><span class='line'>        state=present
</span><span class='line'>
</span><span class='line'>- name: Set Passwordless SSH Access for ruan user
</span><span class='line'>  copy: src=sudoers
</span><span class='line'>        dest=/etc/sudoers.d
</span><span class='line'>        mode=0440</span></code></pre></td></tr></table></div></figure>


<p>Sudoers file for the create sudo role:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/create-sudo-user/files/sudoers
</span><span class='line'>ruan ALL=(ALL) NOPASSWD:ALL</span></code></pre></td></tr></table></div></figure>


<p>The role to install all the apt packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/install-modules/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: Install Packages
</span><span class='line'>  apt: name= state=latest update_cache=yes
</span><span class='line'>  with_items:
</span><span class='line'>    - apt-transport-https
</span><span class='line'>    - ntp
</span><span class='line'>    - python
</span><span class='line'>    - tcpdump
</span><span class='line'>    - wget
</span><span class='line'>    - openssl
</span><span class='line'>    - curl</span></code></pre></td></tr></table></div></figure>


<p>Role to configure hosts file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/configure-hosts-file/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: Configure Hosts File
</span><span class='line'>  lineinfile: path=/etc/hosts regexp='.*$' line=" " state=present
</span><span class='line'>  when: hostvars[item].ansible_default_ipv4.address is defined
</span><span class='line'>  with_items: ""</span></code></pre></td></tr></table></div></figure>


<p>The role to copy the ssh keys:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/copy-keys/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: Copy Public Key to Other Hosts
</span><span class='line'>  become: true
</span><span class='line'>  become_user: ruan
</span><span class='line'>  copy:
</span><span class='line'>    src: /tmp/id_rsa.pub
</span><span class='line'>    dest: /tmp/id_rsa.pub
</span><span class='line'>    mode: 0644
</span><span class='line'>- name: Append Public key in authorized_keys file
</span><span class='line'>  authorized_key:
</span><span class='line'>    user: ruan
</span><span class='line'>    state: present
</span><span class='line'>    key: ""</span></code></pre></td></tr></table></div></figure>


<p>The role to install elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/elasticsearch/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: get apt repo key
</span><span class='line'>  apt_key:
</span><span class='line'>    url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
</span><span class='line'>    state: present
</span><span class='line'>
</span><span class='line'>- name: install apt repo
</span><span class='line'>  apt_repository:
</span><span class='line'>    repo: deb https://artifacts.elastic.co/packages/6.x/apt stable main
</span><span class='line'>    state: present
</span><span class='line'>    filename: elastic-6.x.list
</span><span class='line'>    update_cache: yes
</span><span class='line'>
</span><span class='line'>- name: install java
</span><span class='line'>  apt:
</span><span class='line'>    name: openjdk-8-jre
</span><span class='line'>    state: present
</span><span class='line'>    update_cache: yes
</span><span class='line'>
</span><span class='line'>- name: install elasticsearch
</span><span class='line'>  apt:
</span><span class='line'>    name: elasticsearch
</span><span class='line'>    state: present
</span><span class='line'>    update_cache: yes
</span><span class='line'>
</span><span class='line'>- name: reload systemd config
</span><span class='line'>  systemd: daemon_reload=yes
</span><span class='line'>
</span><span class='line'>- name: enable service elasticsearch and ensure it is not masked
</span><span class='line'>  systemd:
</span><span class='line'>    name: elasticsearch
</span><span class='line'>    enabled: yes
</span><span class='line'>    masked: no
</span><span class='line'>
</span><span class='line'>- name: ensure elasticsearch is running
</span><span class='line'>  systemd: state=started name=elasticsearch</span></code></pre></td></tr></table></div></figure>


<h2>Deploy Elasticsearch</h2>

<p>Bootstrap python then deploy elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ansible-playbook -i inventory.ini -u root bootstrap-python.yml
</span><span class='line'>$ ansible-playbook -i inventory.ini -u root provision-users.yml</span></code></pre></td></tr></table></div></figure>


<p>Test out elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/
</span><span class='line'>{
</span><span class='line'>  "name" : "Z52AEZ7",
</span><span class='line'>  "cluster_name" : "elasticsearch",
</span><span class='line'>  "cluster_uuid" : "fUiYVjsSQpCbo9QKEiuvaA",
</span><span class='line'>  "version" : {
</span><span class='line'>    "number" : "6.3.0",
</span><span class='line'>    "build_flavor" : "default",
</span><span class='line'>    "build_type" : "deb",
</span><span class='line'>    "build_hash" : "424e937",
</span><span class='line'>    "build_date" : "2018-06-11T23:38:03.357887Z",
</span><span class='line'>    "build_snapshot" : false,
</span><span class='line'>    "lucene_version" : "7.3.1",
</span><span class='line'>    "minimum_wire_compatibility_version" : "5.6.0",
</span><span class='line'>    "minimum_index_compatibility_version" : "5.0.0"
</span><span class='line'>  },
</span><span class='line'>  "tagline" : "You Know, for Search"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/06/elasticsearch-templates-tutorial/">Elasticsearch Templates Tutorial</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-06T15:41:53-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:41 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53352581-b3892f80-392b-11e9-9532-5db5cbfc8f1c.jpg" alt="elasticsearch" /></p>

<p>Elasticsearch Index templates allow you to define templates that will automatically be applied on index creation time. The templates can include both settings and mappings..</p>

<h2>What are we doing?</h2>

<p>We want to create a template on how we would a target index to look like. It should consist of 1 primary shard and 2 replica shards and we want to update the mapping that we can make use of text and keyword string fields.</p>

<p>So then whenever we create an index which matches our template, the template will be applied on index creation.</p>

<h2>String Fields</h2>

<p>We will make use of the following string fields in our mappings which will be included in our templates:</p>

<p><strong>Text</strong>:</p>

<p>A field to index full-text values, such as the body of an email or the description of a product. These fields are analyzed, that is they are passed through an analyzer to convert the string into a list of individual terms before being indexed. The analysis process allows Elasticsearch to search for individual words within each full text field</p>

<p><strong>Keyword"</strong>:</p>

<p>A field to index structured content such as email addresses, hostnames, status codes, zip codes or tags.</p>

<p>They are typically used for filtering (Find me all blog posts where status is published), for sorting, and for aggregations. Keyword fields are only searchable by their exact value</p>

<h2>Note about templates:</h2>

<p>Couple of things to keep in mind:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Templates gets referenced on index creation and does not affect existing indexes
</span><span class='line'>2. When you update a template, you need to specify the exact template, the payload overwrites the whole template</span></code></pre></td></tr></table></div></figure>


<p>View your current templates in your cluster:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/templates?v
</span><span class='line'>name                          index_patterns             order      version
</span><span class='line'>.monitoring-kibana            [.monitoring-kibana-6-*]   0          6020099
</span><span class='line'>filebeat-6.3.1                [filebeat-6.3.1-*]         1</span></code></pre></td></tr></table></div></figure>


<p>Create the template <code>foobar_docs</code> which will match any indexes matching <code>foo-*</code> and <code>bar-*</code> which will inherit index settings of 1 primary shards and 2 replica shards and also apply a mapping template shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPUT http://localhost:9200/_template/foobar_docs -d '
</span><span class='line'>{
</span><span class='line'>  "index_patterns": [
</span><span class='line'>    "foo-*", "bar-*"
</span><span class='line'>  ], 
</span><span class='line'>  "settings": {
</span><span class='line'>    "number_of_shards": 1, 
</span><span class='line'>    "number_of_replicas": 2
</span><span class='line'>  }, 
</span><span class='line'>  "mappings": {
</span><span class='line'>    "type1": {
</span><span class='line'>      "_source": {"enabled": true}, 
</span><span class='line'>      "properties": {"created_at": {"type": "date"}, 
</span><span class='line'>      "title": {"type": "text"}, 
</span><span class='line'>      "status": {"type": "keyword"}, 
</span><span class='line'>      "content": {"type":"text"}, 
</span><span class='line'>      "first_name": {"type": "keyword"}, 
</span><span class='line'>      "last_name": {"type": "keyword"}, 
</span><span class='line'>      "age": {"type":"integer"}, 
</span><span class='line'>      "registered": {"type": "boolean"}
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}'
</span><span class='line'>{"acknowledged":true}</span></code></pre></td></tr></table></div></figure>


<p>View the template from the api:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/templates/foobar_docs?v
</span><span class='line'>name        index_patterns order version
</span><span class='line'>foobar_docs [foo-*, bar-*] 0</span></code></pre></td></tr></table></div></figure>


<p>Create a index that will match the templates definition:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPUT http://localhost:9200/test-2018.07.20
</span><span class='line'>{"acknowledged":true,"shards_acknowledged":true,"index":"test-2018.07.20"}</span></code></pre></td></tr></table></div></figure>


<p>Verify that the index has been created:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/indices/test-2018.07.20?v
</span><span class='line'>health status index           uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   test-2018.07.20 -5XOfl0GTEGeHycTwL51vQ   5   1          0            0        2kb          1.1kb</span></code></pre></td></tr></table></div></figure>


<p>We can also inspect the template like shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_template/foobar_docs?pretty
</span><span class='line'>{
</span><span class='line'>  "foobar_docs" : {
</span><span class='line'>    "order" : 0,
</span><span class='line'>    "index_patterns" : [
</span><span class='line'>      "foo-*",
</span><span class='line'>      "bar-*"
</span><span class='line'>    ],
</span><span class='line'>    "settings" : {
</span><span class='line'>      "index" : {
</span><span class='line'>        "number_of_shards" : "1",
</span><span class='line'>        "number_of_replicas" : "2"
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    "mappings" : {
</span><span class='line'>      "type1" : {
</span><span class='line'>        "_source" : {
</span><span class='line'>          "enabled" : true
</span><span class='line'>        },
</span><span class='line'>        "properties" : {
</span><span class='line'>          "created_at" : {
</span><span class='line'>            "type" : "date"
</span><span class='line'>          },
</span><span class='line'>          "title" : {
</span><span class='line'>            "type" : "text"
</span><span class='line'>          },
</span><span class='line'>          "status" : {
</span><span class='line'>            "type" : "keyword"
</span><span class='line'>          },
</span><span class='line'>          "content" : {
</span><span class='line'>            "type" : "text"
</span><span class='line'>          },
</span><span class='line'>          "first_name" : {
</span><span class='line'>            "type" : "keyword"
</span><span class='line'>          },
</span><span class='line'>          "last_name" : {
</span><span class='line'>            "type" : "keyword"
</span><span class='line'>          },
</span><span class='line'>          "age" : {
</span><span class='line'>            "type" : "integer"
</span><span class='line'>          },
</span><span class='line'>          "registered" : {
</span><span class='line'>            "type" : "boolean"
</span><span class='line'>          }
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    "aliases" : { }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Ingest a document to your index:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://localhost:9200/foo-2018.07.20/type1/ -d '
</span><span class='line'>{
</span><span class='line'>  "title": "this is a post", 
</span><span class='line'>  "status": "active", 
</span><span class='line'>  "content": "introduction post", 
</span><span class='line'>  "first_name": "ruan", 
</span><span class='line'>  "last_name": "bekker", 
</span><span class='line'>  "age": "31", 
</span><span class='line'>  "registered": "true"
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<p>Run a search against your elasticsearch index to view the data:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/foo-2018.07.20/_search?pretty
</span><span class='line'>{
</span><span class='line'>  "took" : 1,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "successful" : 1,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "ZYfotmQB9mQGWzJT7W2y",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "title" : "this is a post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "ruan",
</span><span class='line'>          "last_name" : "bekker",
</span><span class='line'>          "age" : "31",
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Create another document:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://localhost:9200/foo-2018.07.20/type1/ -d '
</span><span class='line'>{
</span><span class='line'>  "created_at": 1532077144, 
</span><span class='line'>  "title": "this is a another post", 
</span><span class='line'>  "status": "ae", 
</span><span class='line'>  "content": "introduction post", 
</span><span class='line'>  "first_name": "stefan", 
</span><span class='line'>  "last_name": "bester", 
</span><span class='line'>  "age": 34, 
</span><span class='line'>  "registered": "true"
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<p>As you guessed, executing another search against elasticsearch shows us both documents:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/foo-2018.07.20/_search?pretty
</span><span class='line'>{
</span><span class='line'>  "took" : 0,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "successful" : 1,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 2,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "ZYfotmQB9mQGWzJT7W2y",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "title" : "this is a post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "ruan",
</span><span class='line'>          "last_name" : "bekker",
</span><span class='line'>          "age" : "31",
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "rofrtmQB9mQGWzJTxnvp",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "created_at" : 1532077144,
</span><span class='line'>          "title" : "this is a another post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "stefan",
</span><span class='line'>          "last_name" : "bester",
</span><span class='line'>          "age" : 34,
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s run a search query for any documents matching people with the age between <strong>30</strong> and <strong>40</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XGET http://localhost:9200/foo-2018.07.20/_search?pretty -d '{"query": {"range": {"age": {"gte": 30, "lte": 40}}}}'
</span><span class='line'>{
</span><span class='line'>  "took" : 2,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "successful" : 1,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 2,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "ZYfotmQB9mQGWzJT7W2y",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "title" : "this is a post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "ruan",
</span><span class='line'>          "last_name" : "bekker",
</span><span class='line'>          "age" : "31",
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "rofrtmQB9mQGWzJTxnvp",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "created_at" : 1532077144,
</span><span class='line'>          "title" : "this is a another post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "stefan",
</span><span class='line'>          "last_name" : "bester",
</span><span class='line'>          "age" : 34,
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Search for people with the age between <strong>32</strong> and <strong>40</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XGET http://localhost:9200/foo-2018.07.20/_search?pretty -d '{"query": {"range": {"age": {"gte": 32, "lte": 40}}}}'
</span><span class='line'>{
</span><span class='line'>  "took" : 1,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "successful" : 1,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "rofrtmQB9mQGWzJTxnvp",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "created_at" : 1532077144,
</span><span class='line'>          "title" : "this is a another post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "stefan",
</span><span class='line'>          "last_name" : "bester",
</span><span class='line'>          "age" : 34,
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say we want to update our template with <code>refresh_interval</code>, primary shards of 2 and replicas of 1 settings:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPUT http://localhost:9200/_template/foobar_docs -d '
</span><span class='line'>{
</span><span class='line'>  "index_patterns": ["foo-*", "bar-*"], 
</span><span class='line'>  "settings": {"number_of_shards": 2, "number_of_replicas": 1, "refresh_interval": "15s"}
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<p>View the template, as you can see the target template will look exactly like the data body that we are posting to the template api:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_template/foobar_docs?pretty
</span><span class='line'>{
</span><span class='line'>  "foobar_docs" : {
</span><span class='line'>    "order" : 0,
</span><span class='line'>    "index_patterns" : [
</span><span class='line'>      "foo-*",
</span><span class='line'>      "bar-*"
</span><span class='line'>    ],
</span><span class='line'>    "settings" : {
</span><span class='line'>      "index" : {
</span><span class='line'>        "number_of_shards" : "2",
</span><span class='line'>        "number_of_replicas" : "1",
</span><span class='line'>        "refresh_interval" : "15s"
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    "mappings" : { },
</span><span class='line'>    "aliases" : { }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>View our current index, as you can see the index is unaffected of the template change as only new indexes will retrieve the update of the template:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/indices/foo-2018.07.20?v
</span><span class='line'>health status index          uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>yellow open   foo-2018.07.20 ol1pGugrQCKd0xES4R6oFg   1   2          2            0     20.4kb         10.2kb</span></code></pre></td></tr></table></div></figure>


<p>Create a new index to verify that the template&rsquo;s config is pulled into the new index:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPUT http://localhost:9200/foo-2018.07.20-new</span></code></pre></td></tr></table></div></figure>


<p>View the elasticsearch indexes to verify the behavior:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/indices/foo-2018.07.*?v
</span><span class='line'>health status index              uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>yellow open   foo-2018.07.20     ol1pGugrQCKd0xES4R6oFg   1   2          2            0     20.4kb         10.2kb
</span><span class='line'>green  open   foo-2018.07.20-new g6Ii8jtKRFa1zDVB2IsDBQ   2   1          0            0       920b           460b</span></code></pre></td></tr></table></div></figure>


<p>Delete the indexes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XDELETE http://localhost:9200/foo-*
</span><span class='line'>{"acknowledged":true}</span></code></pre></td></tr></table></div></figure>


<p>Delete the templates:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XDELETE 'http://localhost:9200/_template/foobar_docs'
</span><span class='line'>{"acknowledged":true}</span></code></pre></td></tr></table></div></figure>


<p>Verify that the templates are gone:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/templates/foobar_docs?v
</span><span class='line'>name index_patterns order version</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html</a>
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.3/mapping-types.html</a>
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/06/reindex-your-elasticsearch-indexes-tutorial/">Reindex Your Elasticsearch Indexes Tutorial</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-06T15:37:18-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53352581-b3892f80-392b-11e9-9532-5db5cbfc8f1c.jpg" alt="" /></p>

<p>At times you may find that the indexes in your cluster are not queried that often but you still want them around. But you also want to reduce the resource footprint by reducing the number of shards, and perhaps increase the refresh interval.</p>

<p>For refresh interval, if new data comes in and we dont care to have it available near real time, we can set the refresh interval for example to 60 seconds, so the index will only have the data available every 60 seconds. (default: 1s)</p>

<h2>Reindexing Elasticsearch Indexes</h2>

<p>In this example we will use the scenario where we have daily indexes with 5 primary shards and 1 set of replicas and we would like to create a weekly index with 1 primary shard, 1 replica and the refresh interval of 60 seconds, and reindex the previous weeks data into our weekly index.</p>

<p>Create the target weekly index with the mentioned configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H "Content-Type: application/json" -XPUT 'http://127.0.0.1:9200/my-index-2019.01.01-07' -d '
</span><span class='line'>{
</span><span class='line'>  "settings": {
</span><span class='line'>      "number_of_shards": "1",
</span><span class='line'>      "number_of_replicas": "1",
</span><span class='line'>      "refresh_interval" : "60s"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>'</span></code></pre></td></tr></table></div></figure>


<p>Ensure the index exist:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/indices/my-index-2019.01.01*?v'
</span><span class='line'>health status index                    uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   my-index-2019.01.01      wbFEJCApSpSlbOXzb1Tjxw   5   1      22007            0      6.6mb          3.2mb
</span><span class='line'>green  open   my-index-2019.01.02      cbDmJR7pbpRT3O2x46fj20   5   1      28031            0      7.2mb          3.4mb
</span><span class='line'>..
</span><span class='line'>green  open   my-index-2019.01.01-07   mJR7pJ9O4T3O9jzyI943ca   1   1          0            0       466b           233b</span></code></pre></td></tr></table></div></figure>


<p>Create the reindex job, specify the source indexes and the destination index where the data must be reindexed to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -H 'Content-Type: application/json' -XPOST 'http://127.0.0.1:9200/_reindex' -d '
</span><span class='line'>{
</span><span class='line'>  "source": {
</span><span class='line'>      "index": [
</span><span class='line'>          "my-index-2019.01.01",
</span><span class='line'>          "my-index-2019.01.02",
</span><span class='line'>          "my-index-2019.01.03",
</span><span class='line'>          "my-index-2019.01.04",
</span><span class='line'>          "my-index-2019.01.05",
</span><span class='line'>          "my-index-2019.01.06",
</span><span class='line'>          "my-index-2019.01.07"
</span><span class='line'>      ]
</span><span class='line'>  },
</span><span class='line'>  "dest": {
</span><span class='line'>      "index": "my-index-2019.01.01-07"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>'</span></code></pre></td></tr></table></div></figure>


<p>You can use the tasks api to monitor the progress:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/tasks?'
</span><span class='line'>indices:data/write/bulk        -3MIFskURPKxd1tg8P2j0w:912621270 -                                transport 1538459598188 22:53:18 3.1ms       x.x.x.x -3MIFsk
</span><span class='line'>indices:data/write/bulk[s]     -3MIFskURPKxd1tg8P2j0w:912621271 -3MIFskURPKxd1tg8P2j0w:816648230 transport 1538459598188 22:53:18 3.1ms       x.x.x.x -3MIFsk</span></code></pre></td></tr></table></div></figure>


<p>You manipulate the output of the tasks api by either fetching specific actions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_tasks?actions=*data/write/reindex&detailed&pretty'</span></code></pre></td></tr></table></div></figure>


<p>Or viewing detailed output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/tasks?detailed' | grep 'indices:data/write/reindex'
</span><span class='line'>indices:data/write/reindex     IvoqWoUqSgGCQ0ELG21nhg:740560815 -                                transport 1538462294714 23:38:14 1.7m        x.x.x.x IvoqWoU reindex from [my-index-2019.01.01] to [my-index-2019.01.01-07]</span></code></pre></td></tr></table></div></figure>


<p>Or you could get the json response:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_tasks?actions=*data/write/reindex&detailed&pretty'
</span><span class='line'>{
</span><span class='line'>  "nodes" : {
</span><span class='line'>    "xx" : {
</span><span class='line'>      "name" : "xx",
</span><span class='line'>      "roles" : [ "data", "ingest" ],
</span><span class='line'>      "tasks" : {
</span><span class='line'>        "xx:876452606" : {
</span><span class='line'>          "node" : "xx",
</span><span class='line'>          "id" : 776452606,
</span><span class='line'>          "type" : "transport",
</span><span class='line'>          "action" : "indices:data/write/reindex",
</span><span class='line'>          "status" : {
</span><span class='line'>            "total" : 4785475,
</span><span class='line'>            "updated" : 0,
</span><span class='line'>            "created" : 234000,
</span><span class='line'>            "deleted" : 0,
</span><span class='line'>            "batches" : 235,
</span><span class='line'>            "version_conflicts" : 0,
</span><span class='line'>            "noops" : 0,
</span><span class='line'>            "retries" : {
</span><span class='line'>              "bulk" : 0,
</span><span class='line'>              "search" : 0
</span><span class='line'>            },
</span><span class='line'>            "throttled_millis" : 0,
</span><span class='line'>            "requests_per_second" : -1.0,
</span><span class='line'>            "throttled_until_millis" : 0
</span><span class='line'>          },
</span><span class='line'>          "description" : "reindex from [my-index-2019.01.07] to [my-index-2019.01.01-07]",
</span><span class='line'>          "start_time_in_millis" : 1538462901120,
</span><span class='line'>          "running_time_in_nanos" : 64654161339,
</span><span class='line'>          "cancellable" : true
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Anyways, moving along. Reindex jobs will always be listed as a <code>data/write/reindex</code> action, so we can count the output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/tasks?'  | grep 'data/write/reindex' | wc -l</span></code></pre></td></tr></table></div></figure>


<p>If the response is 0 then all the tasks completed and we can have a look at our index again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/indices/my-index-2019.01.0*?v'
</span><span class='line'>health status index                    uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   my-index-2019.01.01      wbFEJCApSpSlbOXzb1Tjxw   5   1      22007            0      6.6mb          3.2mb
</span><span class='line'>green  open   my-index-2019.01.02      cbDmJR7pbpRT3O2x46fj20   5   1      28031            0      7.2mb          3.4mb
</span><span class='line'>..
</span><span class='line'>green  open   my-index-2019.01.01-07   mJR7pJ9O4T3O9jzyI943ca   1   1     322007            0     45.9mb         22.9mb</span></code></pre></td></tr></table></div></figure>


<p>Now that we can verify that the reindex tasks finished and we can see the aggregated result in our target index, we can delete our source indexes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XDELETE 'http://127.0.0.1:9200/my-index-2019.01.01,my-index-2019.01.02,my-index-2019.01.03,my-index-2019.01.04,my-index-2019.01.05,my-index-2019.01.06,my-index-2019.01.07'</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/06/shrink-your-elasticsearch-index-by-reducing-the-shard-count-with-the-shards-api/">Shrink Your Elasticsearch Index by Reducing the Shard Count With the Shards API</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-06T15:33:48-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:33 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53352581-b3892f80-392b-11e9-9532-5db5cbfc8f1c.jpg" alt="elasticsearch" /></p>

<p>Resize your Elasticsearch Index with fewer Primary Shards by using the Shrink API.</p>

<p>In Elasticsearch, every index consists of multiple shards and every shard in your elasticsearch cluster contributes to the usage of your cpu, memory, file descriptors etc. This definitely helps for performance in parallel processing. As for an example with time series data, you would write and read a lot to an index with ie the current date.</p>

<p>If that index drops in requests and only read from the index every now and then, we dont need that many shards anymore and if we have multiple indexes, they may build up and take up unessacary compute power.</p>

<p>For a scenario where we want to reduce the size of our indexes, we can use the Shrink API to reduce the number of primary shards.</p>

<h2>The Shrink API</h2>

<p>The shrink index API allows you to shrink an existing index into a new index with fewer primary shards. The requested number of primary shards in the target index must be a factor of the number of shards in the source index. For example an index with 8 primary shards can be shrunk into 4, 2 or 1 primary shards or an index with 15 primary shards can be shrunk into 5, 3 or 1. If the number of shards in the index is a prime number it can only be shrunk into a single primary shard. Before shrinking, a (primary or replica) copy of every shard in the index must be present on the same node.</p>

<p>Steps on Shrinking:</p>

<p>Create the target index with the same definition as the source index, but with a smaller number of primary shards.
Then it hard-links segments from the source index into the target index.
Finally, it recovers the target index as though it were a closed index which had just been re-opened.</p>

<h2>Reduce the Primary Shards of an Index.</h2>

<p>As you may know, you can only set the Primary Shards on Index Creation time and Replica Shards you can set on the fly.</p>

<p>In this example we have a source index: <code>my-index-2019.01.10</code> with 5 primary shards and 1 replica shard, which gives us 10 shards for that index, that we would like to shrink to an index named: <code>archive_my-index-2019.01.10</code> with 1 primary shard and 1 replica shard, which will give us 2 shards for that index.</p>

<p>Have a look at your index:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET "http://127.0.0.1:9200/_cat/indices/my-index-2019.01.*?v"
</span><span class='line'>health status index                                     uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   my-index-2019.01.10                       xAijUTSevXirdyTZTN3cuA   5   1   80795533            0      5.9gb          2.9gb
</span><span class='line'>green  open   my-index-2019.01.11                       yb8Cjy9eQwqde8mJhR_vlw   5   5   80590481            0      5.7gb          2.8gb
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>And have a look at the nodes, as we will relocate the shards to a specific node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/nodes?v
</span><span class='line'>ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>x.x.x.x             8          98   0    0.04    0.03     0.01 m         -      3E9yp60
</span><span class='line'>x.x.x.x            65          99   4    0.43    0.23     0.36 di        -      znFrs18</span></code></pre></td></tr></table></div></figure>


<p>In this demonstration we only have 2 nodes with a replication factor of 1, which means a index&rsquo;s shards will always reside on both nodes. In a case with more nodes, we need to ensure that we choose a node where a primary index reside on.</p>

<p>Look at the shards api, by passing the index name to get the index to shard allocation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/_cat/shards/my-index-2019.01.10?v'
</span><span class='line'>index               shard prirep state   docs  store ip       node
</span><span class='line'>my-index-2019.01.10 2     p      STARTED  193  101mb x.x.x.x  Lq9P7eP
</span><span class='line'>my-index-2019.01.10 2     r      STARTED  193  101mb x.x.x.x  F5edOwK
</span><span class='line'>my-index-2019.01.10 4     p      STARTED  197  101mb x.x.x.x  Lq9P7eP
</span><span class='line'>my-index-2019.01.10 4     r      STARTED  197  101mb x.x.x.x  F5edOwK
</span><span class='line'>my-index-2019.01.10 3     r      STARTED  184  101mb x.x.x.x  Lq9P7eP
</span><span class='line'>my-index-2019.01.10 3     p      STARTED  184  101mb x.x.x.x  F5edOwK
</span><span class='line'>my-index-2019.01.10 1     r      STARTED  180  101mb x.x.x.x  Lq9P7eP
</span><span class='line'>my-index-2019.01.10 1     p      STARTED  180  101mb x.x.x.x  F5edOwK
</span><span class='line'>my-index-2019.01.10 0     p      STARTED  187  101mb x.x.x.x  Lq9P7eP
</span><span class='line'>my-index-2019.01.10 0     r      STARTED  187  101mb x.x.x.x  F5edOwK</span></code></pre></td></tr></table></div></figure>


<p>Create the target index:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XPUT -H 'Content-Type: application/json' http://127.0.0.1:9200/archive_my-index-2019.01.10 -d '
</span><span class='line'>{
</span><span class='line'>  "settings": {
</span><span class='line'>      "number_of_shards": "1",
</span><span class='line'>      "number_of_replicas": "1"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>'</span></code></pre></td></tr></table></div></figure>


<p>Set the index as read only and relocate every copy of shard to node we indentified in a previous step:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XPUT -H 'Content-Type: application/json' http://127.0.0.1:9200/my-index-2019.01.10/_settings -d '
</span><span class='line'>{
</span><span class='line'>  "settings": {
</span><span class='line'>      "index.routing.allocation.require._name": "Lq9P7eP",
</span><span class='line'>      "index.blocks.write": true
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>'</span></code></pre></td></tr></table></div></figure>


<p>Now shrink the source index (my-index-2019.01.10) to the target index (archive_my-index-2019.01.10):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XPOST -H 'Content-Type: application/json' http://127.0.0.1:9200/my-index-2019.01.10/_shrink/archive_my-index-2019.01.10</span></code></pre></td></tr></table></div></figure>


<p>You can monitor the progress by using the Recovery API:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET "http://127.0.0.1:9200/_cat/recovery/my-index-2019.01.10?human&detailed=true"
</span><span class='line'>my-index-2019.01.10 0 23.3s peer done x.x.x.x  F5edOwK x.x.x.x Lq9P7eP n/a n/a 15 15 100.0% 15 635836677 635836677 100.0% 635836677 0 0 100.0%
</span><span class='line'>my-index-2019.01.10 1 22s   peer done x.x.x.x  Lq9P7eP x.x.x.x Lq9P7eP n/a n/a 15 15 100.0% 15 636392649 636392649 100.0% 636392649 0 0 100.0%
</span><span class='line'>my-index-2019.01.10 2 19.6s peer done x.x.x.x  F5edOwK x.x.x.x Lq9P7eP n/a n/a 15 15 100.0% 15 636809671 636809671 100.0% 636809671 0 0 100.0%
</span><span class='line'>my-index-2019.01.10 3 21.5s peer done x.x.x.x  Lq9P7eP x.x.x.x Lq9P7eP n/a n/a 15 15 100.0% 15 636378870 636378870 100.0% 636378870 0 0 100.0%
</span><span class='line'>my-index-2019.01.10 4 23.3s peer done x.x.x.x F5edOwK- x.x.x.x Lq9P7eP n/a n/a 15 15 100.0% 15 636545756 636545756 100.0% 636545756 0 0 100.0%</span></code></pre></td></tr></table></div></figure>


<p>You can also pass aliases as your table columns for output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET "http://127.0.0.1:9200/_cat/recovery/my-index-2019.01.10?v&detailed=true&h=index,shard,time,ty,st,shost,thost,f,fp,b,bp"
</span><span class='line'>index                            shard time  ty   st   shost         thost        f  fp     b         bp
</span><span class='line'>my-index-2019.01.10              0     23.3s peer done x.x.x.x x.x.x.x 15 100.0% 635836677 100.0%
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>When the job is done, have a look at your indexes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET "http://127.0.0.1:9200/_cat/indices/*my-index-2019.01.10?v"
</span><span class='line'>health status index                                     uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   archive_my-index-2019.01.10               PAijUTSeRvirdyTZTN3cuA   1   1   80795533            0      5.9gb          2.9gb
</span><span class='line'>green  open   my-index-2019.01.10                       Cb8Cjy9CQwqde8mJhR_vlw   5   1   80795533            0      2.9gb          2.9gb</span></code></pre></td></tr></table></div></figure>


<p>Remove the block on your old index in order to make it writable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XPUT -H 'Content-Type: application/json' http://127.0.0.1:9200/my-index-2019.01.10/_settings" -d '
</span><span class='line'>{
</span><span class='line'>  "settings": {
</span><span class='line'>      "index.routing.allocation.require._name": null,
</span><span class='line'>      "index.blocks.write": null
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>'</span></code></pre></td></tr></table></div></figure>


<p>Delete the old index:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XDELETE -H 'Content-Type: application/json' http://127.0.0.1:9200/my-index-2019.01.10</span></code></pre></td></tr></table></div></figure>


<p>Note:, On AWS Elasticsearch Service, if you dont remove the block and you trigger a redeployment, you will end up with something like this. Shard may still be constraint to a node.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET ${ES_HOST/_cat/allocation?v
</span><span class='line'>shards disk.indices disk.used disk.avail disk.total disk.percent host          ip  node
</span><span class='line'>     0           0b    51.2gb    956.5gb   1007.8gb            5 x.x.x.x  x.x.x.x  ap9Mx1R
</span><span class='line'>     1        3.6gb    54.9gb    952.8gb   1007.8gb            5 x.x.x.x  x.x.x.x  PqmoQpN   &lt;-----------
</span><span class='line'>     0           0b    51.2gb    956.5gb   1007.8gb            5 x.x.x.x  x.x.x.x  5p7x4Lc
</span><span class='line'>     0           0b    51.2gb    956.5gb   1007.8gb            5 x.x.x.x  x.x.x.x  c8kniP3
</span><span class='line'>     0           0b    51.2gb    956.5gb   1007.8gb            5 x.x.x.x  x.x.x.x  jPwlwsD
</span><span class='line'>     0           0b    51.2gb    956.5gb   1007.8gb            5 x.x.x.x  x.x.x.x  ljos4mu
</span><span class='line'>   481      904.1gb   990.3gb    521.3gb      1.4tb           65 x.x.x.x  x.x.x.x  qAF-gIU
</span><span class='line'>   481      820.2gb   903.6gb    608.1gb      1.4tb           59 x.x.x.x  x.x.x.x  dR3sNwA
</span><span class='line'>   481      824.6gb   909.1gb    602.6gb      1.4tb           60 x.x.x.x  x.x.x.x  fvL4A9X
</span><span class='line'>   481      792.7gb   876.5gb    635.2gb      1.4tb           57 x.x.x.x  x.x.x.x  lk4svht
</span><span class='line'>   481      779.2gb   864.4gb    647.3gb      1.4tb           57 x.x.x.x  x.x.x.x  uLsej9m
</span><span class='line'>     0           0b    51.2gb    956.5gb   1007.8gb            5 x.x.x.x  x.x.x.x  yM4Ka9l</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/master/indices-shrink-index.html">https://www.elastic.co/guide/en/elasticsearch/reference/master/indices-shrink-index.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/04/self-hosted-git-and-cicd-platform-with-gitea-and-drone-on-docker/">Self Hosted Git and CICD Platform With Gitea and Drone on Docker</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-04T17:57:16-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>5:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55591102-f57c7100-5734-11e9-96cf-8a60d091a769.png" alt="" /></p>

<p>Both gitea and drone is built on golang runs on multiple platforms including a raspberry pi and its super lightweight. Oh yes, and its awesome!</p>

<p>In this tutorial we will see how we can implement our own git service and cicd platform by setting up gitea and drone on docker and commit a python flask application to gitea and build a pipeline on drone.</p>

<h2>Some definition</h2>

<p><strong>Gitea</strong>: will be your self hosted git server</p>

<p><strong>Drone Server</strong>: will be server being responsible for the web service, repositories, secrets, users, etc.</p>

<p><strong>Drone Agent</strong>: will be the workers that runs your builds, jobs etc.</p>

<h2>Server Confguration</h2>

<p>We will change our host&rsquo;s ssh port to something else as our git server&rsquo;s ssh method will be listening on port 22 and we would like to add our ssh key to gitea so that we can commit to our git server via ssh.</p>

<p>Change your server&rsquo;s ssh port to 2222, by opening <code>/etc/ssh/sshd_config</code> and edit the port to <code>2222</code> then restart sshd with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ /etc/init.d/sshd restart</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Your ssh connection will still be established, but you can exit and ssh to your server by specifying the new port:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -p 2222 user@host</span></code></pre></td></tr></table></div></figure>


<h2>Pre-Requirements</h2>

<p>Make sure you have <a href="https://docs.docker.com/install/">docker and docker-compose</a> installed</p>

<h2>Deploy Gitea and Drone</h2>

<p>Below is the docker-compose file for our deployment. Note that we are running a postgres database which gitea will be configured on, you can also use other databases like mysql, sqlite etc. Visit their <a href="https://docs.gitea.io/en-us/">documentation</a> for more info.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;2&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">gitea-app</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gitea/gitea:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gitea-app</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">USER_UID=1000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">USER_GID=1000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ROOT_URL=http://gitea:3000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">SSH_DOMAIN=mydomain.com</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./volumes/gitea_app:/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;3000:3000&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;22:22&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">gitea-db</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres:alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gitea-db</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">5440:5432</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./volumes/gitea_db:/var/lib/postgresql/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_USER=postgres</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_PASSWORD=postgres</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_DB=gitea</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">drone-server</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">drone/drone:0.8</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">drone-server</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">80:8000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">9000</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./volumes/drone:/var/lib/drone/</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">gitea</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_OPEN=true</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_HOST=http://drone-server:8000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_GITEA=true</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_GITEA_URL=http://gitea:3000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_SECRET=secret</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_NETWORK=appnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">drone-agent</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">drone/agent:0.8</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">drone-agent</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">agent</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">drone-server</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_SERVER=drone-server:9000</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DRONE_SECRET=secret</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">gitea-app</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">gitea-db</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">appnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the volumes path:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ mkdir volumes</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the external network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker network create appnet</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some key configuration,</p>

<p>Our <code>SSH_DOMAIN</code> will be the domain that gets used for things like cloning a repository. When you register your gitea account, you will use the same credentials to logon to drone.</p>

<p>Deploy your stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker-compose up -d</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Register on Gitea</h2>

<p>When your deployment is done, access your gitea server which should be available on <code>http://your-docker-ip:3000/</code> complete the registration, if you decide to go with postgres your username/password will be <code>postgres</code> and your host will be <code>gitea-db:5432</code>.</p>

<p>Make sure to complete the administrator account to get your admin credentials.</p>

<h2>Setup SSH Key and Repo</h2>

<p>Generate a ssh key that you will use for communicating to git over ssh. If you have already have an ssh key you can skip this step.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa
</span><span class='line'><span class="c"># use the defaults</span>
</span></code></pre></td></tr></table></div></figure>


<p>Login on gitea, once you are logged in, head over to profile / settings / ssh keys: <code>http://your-docker-ip:3000/user/settings/keys</code>.</p>

<p>Add a new ssh key, go back to your terminal and copy the public key which we will provide to gitea:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat ~/.ssh/id_rsa.pub
</span><span class='line'>&lt;copy the contents to your clipboard&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Paste your public key and provide a descriptive title.</p>

<p>Head back to your dashboard and create your first repository:</p>

<p><img width="1277" alt="image" src="https://user-images.githubusercontent.com/567298/55589336-49388b80-5730-11e9-8ae5-2589fea7e2b2.png"></p>

<p>It should look more or less like this:</p>

<p><img width="1007" alt="image" src="https://user-images.githubusercontent.com/567298/55589473-9583cb80-5730-11e9-8124-3bdedc221a70.png"></p>

<h2>Enable Repo on Drone</h2>

<p>Head over to drone and select the repositores on the right hand side <a href="http://">http://</a><your-docker-ip>:80/account/repos and enable your repository by toggline the selector, it should look more or less like this:</p>

<p><img width="1275" alt="image" src="https://user-images.githubusercontent.com/567298/55589614-f3b0ae80-5730-11e9-9358-54a6be611198.png"></p>

<p>Once its enabled head back to gitea.</p>

<h2>Clone the repository</h2>

<p>On your repository select ssh and copy the ssh link for your repository:</p>

<p><img width="974" alt="image" src="https://user-images.githubusercontent.com/567298/55589710-3b373a80-5731-11e9-956b-c921c42e6a2d.png"></p>

<p>Then from your terminal add your private ssh key to your ssh agent and clone the repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">eval</span> <span class="k">$(</span>ssh-agent<span class="k">)</span>
</span><span class='line'><span class="nv">$ </span>ssh-add ~/.ssh/id_rsa
</span><span class='line'><span class="nv">$ </span>git clone git@your-docker-ip:your-user/your-repo.git
</span></code></pre></td></tr></table></div></figure>


<h2>Add Example Python Flask app to git</h2>

<p>I will use a basic python flask application with some tests.</p>

<p>Let&rsquo;s first add our pipeline definition for drone, so that drone understands how the pipeline should be run when gitea receives a commit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>touch .drone.yml
</span></code></pre></td></tr></table></div></figure>


<p>Our pipeline:</p>

<figure class='code'><figcaption><span>.drone.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">pipeline</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">python:3.5.1-alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">commands</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip install --upgrade pip setuptools wheel</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip wheel -r requirements.txt --wheel-dir=wheeldir --find-links=wheeldir</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">pip install --no-index --find-links=wheeldir -r requirements.txt</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">flake8 app</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir -p coverage</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nosetests -v tests/</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lets add that to git:</p>

<figure class='code'><figcaption><span>.drone.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ git add .drone.yml</span>
</span><span class='line'><span class="l-Scalar-Plain">$ git commit -m &quot;initial add of our pipeline&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">$ git push origin master</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our drone file should be in git, now our requirements dependency file for python:</p>

<figure class='code'><figcaption><span>requirements.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>flask
</span><span class='line'>nose
</span><span class='line'>flake8
</span></code></pre></td></tr></table></div></figure>


<p>Our blank file to make our application a module:</p>

<figure class='code'><figcaption><span>requirements.txt</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir app
</span><span class='line'><span class="nv">$ </span>touch app/__init__.py
</span></code></pre></td></tr></table></div></figure>


<p>And our flask app:</p>

<figure class='code'><figcaption><span>app/app.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;Hello, World!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our tests directory and our python init file:</p>

<figure class='code'><figcaption><span>app/app.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">mkdir</span> <span class="n">tests</span>
</span><span class='line'><span class="err">$</span> <span class="n">touch</span> <span class="n">tests</span><span class="o">/</span><span class="n">__init__</span><span class="o">.</span><span class="n">py</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have all our files ready, commit and push to git:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git add .
</span><span class='line'><span class="nv">$ </span>git commit -m <span class="s2">&quot;add python app&quot;</span>
</span><span class='line'><span class="nv">$ </span>git push origin master
</span></code></pre></td></tr></table></div></figure>


<h2>Look at Drone Running</h2>

<p>Head over to drone and look at the builds, you should see your build running at <code>http://&lt;docker-ip&gt;:80/&lt;user&gt;/&lt;repo-name&gt;</code>:</p>

<p><img width="1269" alt="image" src="https://user-images.githubusercontent.com/567298/55590369-f8766200-5732-11e9-82fb-2bda2c8ad40a.png"></p>

<p>If everything ran as expected you should see that it passed.</p>

<h2>Build Status Badges</h2>

<p>You can also include the build status badges from drone which will look like:</p>

<p><img width="1032" alt="image" src="https://user-images.githubusercontent.com/567298/55590552-82bec600-5733-11e9-91f2-a65c5a94fac5.png"></p>

<p>You can use the drone api: <code>http://drone-ip:80/api/badges/&lt;your-user&gt;/&lt;your-repo&gt;/status.svg</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>!<span class="o">[</span>Build Status<span class="o">](</span>http://your-ip/api/badges/your-user/your-repo/status.svg<span class="o">)</span>
</span><span class='line'><span class="o">[</span>!<span class="o">[](</span>https://images.microbadger.com/badges/image/gitea/gitea.svg<span class="o">)](</span>https://microbadger.com/images/gitea/gitea <span class="s2">&quot;Get your own image badge on microbadger.com&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">[</span>!<span class="o">[</span>GitHub release<span class="o">](</span>https://img.shields.io/github/release/go-gitea/gitea.svg<span class="o">)](</span>https://github.com/go-gitea/gitea/releases/latest<span class="o">)</span>
</span><span class='line'><span class="o">[</span>!<span class="o">[</span>Help Contribute to Open Source<span class="o">](</span>https://www.codetriage.com/go-gitea/gitea/badges/users.svg<span class="o">)](</span>https://www.codetriage.com/go-gitea/gitea<span class="o">)</span>
</span><span class='line'><span class="o">[</span>!<span class="o">[</span>Become a backer/sponsor of gitea<span class="o">](</span>https://opencollective.com/gitea/tiers/backer/badge.svg?label<span class="o">=</span>backer<span class="p">&amp;</span><span class="nv">color</span><span class="o">=</span>brightgreen<span class="o">)](</span>https://opencollective.com/gitea<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Overall gitea and drone is really amazing and quite impressed with it, especially from the low memory footprint and that its so easy to work with.</p>

<h2>Resources</h2>

<p>Have a look at this for more resources:</p>

<p><strong>Docs:</strong></p>

<ul>
<li><a href="https://github.com/drone/drone">https://github.com/drone/drone</a></li>
<li><a href="http://plugins.drone.io/drone-plugins/drone-docker/">http://plugins.drone.io/drone-plugins/drone-docker/</a></li>
<li><a href="https://docs.drone.io/reference/server/drone-user-create/">https://docs.drone.io/reference/server/drone-user-create/</a></li>
<li><a href="https://docs.gitea.io/en-us/install-with-docker/">https://docs.gitea.io/en-us/install-with-docker/</a></li>
</ul>


<p><strong>Examples:</strong></p>

<ul>
<li><a href="https://hackernoon.com/build-your-own-ci-cd-pipeline-with-drone-e43d7190989b">https://hackernoon.com/build-your-own-ci-cd-pipeline-with-drone-e43d7190989b</a></li>
<li><a href="https://github.com/drone-demos/drone-with-python">https://github.com/drone-demos/drone-with-python</a></li>
<li><a href="https://github.com/drone/awesome-drone">https://github.com/drone/awesome-drone</a></li>
<li><a href="https://github.com/juliantellez/drone-ci-pipeline">https://github.com/juliantellez/drone-ci-pipeline</a></li>
<li><a href="https://github.com/sguter90/docker-compose-gitea">https://github.com/sguter90/docker-compose-gitea</a></li>
<li><a href="https://gist.github.com/joffilyfe/1a99250cb74bb75e29cbe8d6ca8ceedb">https://gist.github.com/joffilyfe/1a99250cb74bb75e29cbe8d6ca8ceedb</a></li>
<li><a href="https://florian-latifi.at/2018/02/21/using-drone-to-build-and-deploy-a-jekyll-site/">https://florian-latifi.at/2018/02/21/using-drone-to-build-and-deploy-a-jekyll-site/</a></li>
<li><a href="https://angristan.xyz/host-your-own-ci-cd-server-with-drone/">https://angristan.xyz/host-your-own-ci-cd-server-with-drone/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/03/build-small-golang-docker-containers/">Build Small Golang Docker Containers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-03T08:24:08-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2019</span></span> <span class='time'>8:24 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55478306-aabb0600-561b-11e9-9cc6-730fadb4beeb.png" alt="" /></p>

<p>In this tutorial I will show you how to build really small docker containers for golang applications. And I mean the difference between 310MB down to 2MB</p>

<h2>But Alpine..</h2>

<p>So we thinking lets go with alpine right? Yeah sure lets build a small, app running on go with alpine.</p>

<p>Our application code:</p>

<figure class='code'><figcaption><span>app.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;math/rand&quot;</span>
</span><span class='line'>  <span class="s">&quot;time&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">lekkewords</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;dog&quot;</span><span class="p">,</span> <span class="s">&quot;cat&quot;</span><span class="p">,</span> <span class="s">&quot;fish&quot;</span><span class="p">,</span> <span class="s">&quot;giraffe&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;moo&quot;</span><span class="p">,</span> <span class="s">&quot;spider&quot;</span><span class="p">,</span> <span class="s">&quot;lion&quot;</span><span class="p">,</span> <span class="s">&quot;apple&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;tree&quot;</span><span class="p">,</span> <span class="s">&quot;moon&quot;</span><span class="p">,</span> <span class="s">&quot;snake&quot;</span><span class="p">,</span> <span class="s">&quot;mountain lion&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;trooper&quot;</span><span class="p">,</span> <span class="s">&quot;burger&quot;</span><span class="p">,</span> <span class="s">&quot;nasa&quot;</span><span class="p">,</span> <span class="s">&quot;yes&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">rand</span><span class="p">.</span><span class="nx">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">())</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">zelength</span> <span class="kt">int</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">lekkewords</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">indexnum</span> <span class="kt">int</span> <span class="p">=</span> <span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nx">zelength</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">word</span> <span class="o">:=</span> <span class="nx">lekkewords</span><span class="p">[</span><span class="nx">indexnum</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Number of words:&quot;</span><span class="p">,</span> <span class="nx">zelength</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Selected index number:&quot;</span><span class="p">,</span> <span class="nx">indexnum</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Selected word is:&quot;</span><span class="p">,</span> <span class="nx">word</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our Dockerfile:</p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'><span class="k">FROM</span> golang:alpine
</span><span class='line'>
</span><span class='line'><span class="k">WORKDIR</span> <span class="nv">$GOPATH</span>/src/mylekkepackage/mylekkeapp/
</span><span class='line'>COPY app.go .
</span><span class='line'><span class="k">RUN</span> go build -o /go/app
</span><span class='line'>
</span><span class='line'><span class="k">CMD</span> <span class="o">[</span><span class="s2">&quot;/go/app&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s package our app to an image:</p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'> docker build -t mygolangapp:using-alpine .
</span></code></pre></td></tr></table></div></figure>


<p>Inspect the size of our image, as you can see it being <strong>310MB</strong></p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'> docker images <span class="s2">&quot;mygolangapp:*&quot;</span>
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE
</span><span class='line'>mygolangapp         using-alpine        eea1d7bde218        About a minute ago   310MB
</span></code></pre></td></tr></table></div></figure>


<p>Just make sure it actually works:</p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'> docker run mygolangapp:using-alpine
</span><span class='line'>Number of words: <span class="m">16</span>
</span><span class='line'>Selected index number: <span class="m">11</span>
</span><span class='line'>Selected word is: mountain lion
</span></code></pre></td></tr></table></div></figure>


<p>But for something just returning random selected text, 310MB is a bit crazy.</p>

<h2>Multi Stage Builds</h2>

<p>As Go binaries are self-contained, we can make use of docker&rsquo;s multi stage builds, where we can build our application on alpine and use the binary on a scratch image:</p>

<p>Our multi stage Dockerfile:</p>

<figure class='code'><figcaption><span>Dockerfile.mult</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'><span class="k">FROM</span> golang:alpine AS builder
</span><span class='line'>
</span><span class='line'><span class="k">WORKDIR</span> <span class="nv">$GOPATH</span>/src/mylekkepackage/mylekkeapp/
</span><span class='line'>COPY app.go .
</span><span class='line'><span class="k">RUN</span> go build -o /go/app
</span><span class='line'>
</span><span class='line'><span class="k">FROM</span> scratch
</span><span class='line'>
</span><span class='line'>COPY --from<span class="o">=</span>builder /go/app /go/app
</span><span class='line'>
</span><span class='line'><span class="k">CMD</span> <span class="o">[</span><span class="s2">&quot;/go/app&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Build it:</p>

<figure class='code'><figcaption><span>Dockerfile.mult</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'> docker build -t mygolangapp:using-multistage -f Dockerfile.multi .
</span></code></pre></td></tr></table></div></figure>


<p>Notice that the image is only <strong>2.01MB</strong>, say w000t!</p>

<figure class='code'><figcaption><span>Dockerfile.mult</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'> docker images <span class="s2">&quot;mygolangapp:*&quot;</span>
</span><span class='line'>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
</span><span class='line'>mygolangapp         using-multistage    31474c61ba5b        <span class="m">15</span> seconds ago      2.01MB
</span><span class='line'>mygolangapp         using-alpine        eea1d7bde218        <span class="m">2</span> minutes ago       310MB
</span></code></pre></td></tr></table></div></figure>


<p>Run the app:</p>

<figure class='code'><figcaption><span>Dockerfile.mult</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'> docker run mygolangapp:using-multistage
</span><span class='line'>Number of words: <span class="m">16</span>
</span><span class='line'>Selected index number: <span class="m">5</span>
</span><span class='line'>Selected word is: spider
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p>Source code for this demonstration can be found at <a href="https://github.com/ruanbekker/golang-build-small-images">github.com/ruanbekker/golang-build-small-images</a></p>

<p><img src="https://user-images.githubusercontent.com/567298/55478904-236e9200-561d-11e9-9382-f31b25a9ae03.png" alt="" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/02/secure-your-elasticsearch-cluster-with-basic-auth-using-nginx/">Secure Your Elasticsearch Cluster With Basic Auth Using Nginx and SSL From Letsencrypt</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-02T14:55:58-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2019</span></span> <span class='time'>2:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will setup a reverse proxy using nginx to translate and load balance traffic through to our elasticsearch nodes. We will also protect our elasticsearch cluster with basic auth and use letsencrypt to retrieve free ssl certificates.</p>

<p>We want to allow certain requests to be bypassed from authentication such as getting status from the cluster and certain requests we want to enforce authentication, such as indexing and deleting data.</p>

<h2>Install Nginx:</h2>

<p>Install nginx and the dependency package to create basic auth:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install nginx apache2-utils -y
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Nginx for Reverse Proxy</h2>

<p>We want to access our nginx proxy on port 80: <code>0.0.0.0:80</code> and the requests should be proxied through to elasticsearch private addresses: <code>10.0.0.10:9200</code> and <code>10.0.0.11:9200</code>. Traffic will be load balanced between our 2 nodes.</p>

<p>Edit the main nginx configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim /etc/nginx/nginx.conf
</span></code></pre></td></tr></table></div></figure>


<p>and populate the information as shown below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>user www-data<span class="p">;</span>
</span><span class='line'>worker_processes auto<span class="p">;</span>
</span><span class='line'>pid /run/nginx.pid<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>  worker_connections 1024<span class="p">;</span>
</span><span class='line'>  <span class="c"># multi_accept on;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># basic Settings</span>
</span><span class='line'>  sendfile on<span class="p">;</span>
</span><span class='line'>  tcp_nopush on<span class="p">;</span>
</span><span class='line'>  tcp_nodelay on<span class="p">;</span>
</span><span class='line'>  keepalive_timeout 65<span class="p">;</span>
</span><span class='line'>  types_hash_max_size 2048<span class="p">;</span>
</span><span class='line'>  include /etc/nginx/mime.types<span class="p">;</span>
</span><span class='line'>  default_type application/octet-stream<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># ssl settings</span>
</span><span class='line'>  ssl_protocols TLSv1 TLSv1.1 TLSv1.2<span class="p">;</span>
</span><span class='line'>  ssl_prefer_server_ciphers on<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># logging settings</span>
</span><span class='line'>  access_log /var/log/nginx/access.log<span class="p">;</span>
</span><span class='line'>  error_log /var/log/nginx/error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># gzip settings</span>
</span><span class='line'>  gzip on<span class="p">;</span>
</span><span class='line'>  gzip_disable <span class="s2">&quot;msie6&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># virtual host configs</span>
</span><span class='line'>  include /etc/nginx/conf.d/*.conf<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, edit the virtual host config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim /etc/nginx/conf.d/elasticsearch.conf
</span></code></pre></td></tr></table></div></figure>


<p>And populate the following config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># https://gist.github.com/sahilsk/b16cb51387847e6c3329</span>
</span><span class='line'>
</span><span class='line'>upstream elasticsearch <span class="o">{</span>
</span><span class='line'>    <span class="c"># define your es nodes</span>
</span><span class='line'>    server 10.0.0.10:9200<span class="p">;</span>
</span><span class='line'>    server 10.0.0.11:9200<span class="p">;</span>
</span><span class='line'>    <span class="c"># persistent http connections</span>
</span><span class='line'>    <span class="c"># https://www.elastic.co/blog/playing-http-tricks-nginx</span>
</span><span class='line'>    keepalive 15<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>  listen 80<span class="p">;</span>
</span><span class='line'>  server_name elasticsearch.domain.com<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  auth_basic <span class="s2">&quot;server auth&quot;</span><span class="p">;</span>
</span><span class='line'>  auth_basic_user_file /etc/nginx/passwords<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  location / <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># deny node shutdown api</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="nv">$request_filename</span> ~ <span class="s2">&quot;_shutdown&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> 403<span class="p">;</span>
</span><span class='line'>      <span class="nb">break</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">location</span> <span class="o">=</span> / <span class="o">{</span>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;off&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location ~* ^<span class="o">(</span>/_cluster/health<span class="p">|</span>/_cat/health<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;off&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set your username and password to protect your endpoint:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>htpasswd -c /etc/nginx/passwords admin
</span></code></pre></td></tr></table></div></figure>


<p>Enable nginx on boot and restart the process:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>nginx
</span><span class='line'><span class="nv">$ </span>systemctl restart nginx
</span></code></pre></td></tr></table></div></figure>


<h2>Test it</h2>

<p>Now make requests to elasticsearch via your nginx reverse proxy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s1">&#39;admin:admin&#39;</span> http://myproxy.domain.com/_cat/indices?v
</span><span class='line'>health status index       uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   first-index 1o6yM7tCSqagqoeihKM7_g   <span class="m">5</span>   <span class="m">1</span>          <span class="m">3</span>            <span class="m">0</span>     40.6kb         20.3kb
</span></code></pre></td></tr></table></div></figure>


<h2>Letsencrypt SSL Certificates</h2>

<p>Add free SSL Certificates to your reverse proxy. Install certbot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt-get update
</span><span class='line'><span class="nv">$ </span>apt-get install software-properties-common -y
</span><span class='line'><span class="nv">$ </span>add-apt-repository universe
</span><span class='line'><span class="nv">$ </span>add-apt-repository ppa:certbot/certbot
</span><span class='line'><span class="nv">$ </span>apt-get update
</span><span class='line'><span class="nv">$ </span>apt-get install certbot python-certbot-nginx -y
</span></code></pre></td></tr></table></div></figure>


<p>Request a Certificate for your domain:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>certbot --manual certonly -d myproxy.domain.com -m my@email.com --preferred-challenges dns --agree-tos
</span><span class='line'>
</span><span class='line'>Obtaining a new certificate
</span><span class='line'>Performing the following challenges:
</span><span class='line'>dns-01 challenge <span class="k">for</span> myproxy.domain.com
</span></code></pre></td></tr></table></div></figure>


<p>You will be prompted to make a dns change, since we requested the dns challenge. While this screen is here, we can go our dns provider and make the TXT record change as shown below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Please deploy a DNS TXT record under the name
</span><span class='line'>_acme-challenge.myproxy.domain.com with the following value:
</span><span class='line'>
</span><span class='line'>xLP4y_YJvdAK7_aZMJ50gkudTDeIC3rX0x83aNJctGw
</span><span class='line'>
</span><span class='line'>Before continuing, verify the record is deployed.
</span><span class='line'>Press Enter to Continue
</span><span class='line'>Waiting <span class="k">for</span> verification...
</span><span class='line'>Cleaning up challenges
</span><span class='line'>
</span><span class='line'>IMPORTANT NOTES:
</span><span class='line'> - Congratulations! Your certificate and chain have been saved at:
</span><span class='line'>   /etc/letsencrypt/live/myproxy.domain.com/fullchain.pem
</span><span class='line'>   Your key file has been saved at:
</span><span class='line'>   /etc/letsencrypt/live/myproxy.domain.com/privkey.pem
</span><span class='line'>   Your cert will expire on 2019-07-01. To obtain a new or tweaked
</span><span class='line'>   version of this certificate in the future, simply run certbot
</span><span class='line'>   again. To non-interactively renew *all* of your certificates, run
</span><span class='line'>   <span class="s2">&quot;certbot renew&quot;</span>
</span><span class='line'> - If you like Certbot, please consider supporting our work by:
</span><span class='line'>
</span><span class='line'>   Donating to ISRG / Let<span class="err">&#39;</span>s Encrypt:   https://letsencrypt.org/donate
</span><span class='line'>   Donating to EFF:                    https://eff.org/donate-le
</span></code></pre></td></tr></table></div></figure>


<h2>Update Nginx Config</h2>

<p>Now that we have our ssl certificates, we need to update our nginx config to enable ssl, redirect http to https and point the ssl certificates and ssl private keys to the certificates that we retrieved from letsencrypt.</p>

<p>Open up the virtual host nginx configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim /etc/nginx/conf.d/elasticsearch.conf
</span></code></pre></td></tr></table></div></figure>


<p>Update the config like the one below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>upstream elasticsearch <span class="o">{</span>
</span><span class='line'>    server 10.0.0.10:9200<span class="p">;</span>
</span><span class='line'>    server 10.0.0.11:9200<span class="p">;</span>
</span><span class='line'>    keepalive 15<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>  listen 80<span class="p">;</span>
</span><span class='line'>  server_name myproxy.domain.com<span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="m">301</span> https://<span class="nv">$host$request_uri</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>  listen <span class="m">443</span> ssl<span class="p">;</span>
</span><span class='line'>  server_name myproxy.domain.com<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  ssl_certificate /etc/letsencrypt/live/myproxy.domain.com/fullchain.pem<span class="p">;</span>
</span><span class='line'>  ssl_certificate_key /etc/letsencrypt/live/myproxy.domain.com/privkey.pem<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  auth_basic <span class="s2">&quot;server auth&quot;</span><span class="p">;</span>
</span><span class='line'>  auth_basic_user_file /etc/nginx/passwords<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  location ^~ /.well-known/acme-challenge/ <span class="o">{</span>
</span><span class='line'>    auth_basic off<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location / <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># deny node shutdown api</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="nv">$request_filename</span> ~ <span class="s2">&quot;_shutdown&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> 403<span class="p">;</span>
</span><span class='line'>      <span class="nb">break</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">location</span> <span class="o">=</span> / <span class="o">{</span>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;off&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location ~* ^<span class="o">(</span>/_cluster/health<span class="p">|</span>/_cat/health<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    proxy_pass http://elasticsearch<span class="p">;</span>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
</span><span class='line'>    proxy_redirect off<span class="p">;</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;off&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Restart the nginx process:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl restart nginx
</span></code></pre></td></tr></table></div></figure>


<h2>Test the Nginx Proxy with SSL</h2>

<p>Test the proxy with HTTP so that we can see that our nginx config redirects us to <a href="HTTPS:">HTTPS:</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -iL -u <span class="s1">&#39;admin:admin&#39;</span> http://myproxy.domain.com/_cat/nodes?v
</span><span class='line'>HTTP/1.1 <span class="m">301</span> Moved Permanently
</span><span class='line'>Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span><span class='line'>Date: Tue, <span class="m">02</span> Apr <span class="m">2019</span> 21:40:09 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 194
</span><span class='line'>Connection: keep-alive
</span><span class='line'>Location: https://myproxy.domain.com/_cat/nodes?v
</span><span class='line'>
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span><span class='line'>Date: Tue, <span class="m">02</span> Apr <span class="m">2019</span> 21:40:10 GMT
</span><span class='line'>Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
</span><span class='line'>Content-Length: 276
</span><span class='line'>Connection: keep-alive
</span><span class='line'>
</span><span class='line'>ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>10.0.0.10               <span class="m">40</span>          <span class="m">97</span>   <span class="m">3</span>    0.15    0.10     0.08 mdi       -      Lq9P7eP
</span><span class='line'>10.0.0.11               <span class="m">44</span>          <span class="m">96</span>   <span class="m">3</span>    0.21    0.10     0.09 mdi       *      F5edOwK
</span></code></pre></td></tr></table></div></figure>


<p>Test the proxy with <a href="HTTPS:">HTTPS:</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i -u <span class="s1">&#39;admin:admin&#39;</span> https://myproxy.domain.com/_cat/nodes?v
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span><span class='line'>Date: Tue, <span class="m">02</span> Apr <span class="m">2019</span> 21:40:22 GMT
</span><span class='line'>Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
</span><span class='line'>Content-Length: 276
</span><span class='line'>Connection: keep-alive
</span><span class='line'>
</span><span class='line'>ip            heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
</span><span class='line'>10.0.0.10               <span class="m">44</span>          <span class="m">96</span>   <span class="m">4</span>    0.18    0.10     0.09 mdi       *      F5edOwK
</span><span class='line'>10.0.0.11               <span class="m">39</span>          <span class="m">97</span>   <span class="m">5</span>    0.13    0.09     0.08 mdi       -      Lq9P7eP
</span></code></pre></td></tr></table></div></figure>


<p>Setup a cronjob to auto renew the certificates:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>crontab -e
</span></code></pre></td></tr></table></div></figure>


<p>Populate the following line:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="m">6</span> 1,13 * * * /usr/bin/certbot renew --post-hook <span class="s2">&quot;systemctl restart nginx&quot;</span> --quiet
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://certbot.eff.org/lets-encrypt/ubuntuxenial-nginx.html">https://certbot.eff.org/lets-encrypt/ubuntuxenial-nginx.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/02/setup-kibana-dashboards-for-nginx-log-data-to-understand-the-behavior/">Setup Kibana Dashboards for Nginx Log Data to Understand the Behavior</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-02T12:34:18-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2019</span></span> <span class='time'>12:34 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55418811-b8b54c00-5573-11e9-810d-d244d27c4fb3.png" alt="kibana" /></p>

<p>In this tutorial we will setup a Basic Kibana Dashboard for a Web Server that is running a Blog on Nginx.</p>

<h2>What do we want to achieve?</h2>

<p>We will setup common visualizations to give us an idea on how our blog/website is doing.</p>

<p>In some situations we need to create visualizations to understand the behavior of our log data in order to answer these type of questions:</p>

<table>
<thead>
<tr>
<th> <strong>Number</strong> </th>
<th> <strong>Scenario</strong>                                                         </th>
</tr>
</thead>
<tbody>
<tr>
<td> 1          </td>
<td> Geographical map to see where people are connecting from             </td>
</tr>
<tr>
<td> 2          </td>
<td> Piechart that represents the percentage of cities accessing my blog  </td>
</tr>
<tr>
<td> 3          </td>
<td> Top 10 Most Accessed Pages                                           </td>
</tr>
<tr>
<td> 4          </td>
<td> Top 5 HTTP Status Codes                                              </td>
</tr>
<tr>
<td> 5          </td>
<td> Top 10 Pages that returned 404 Responses                             </td>
</tr>
<tr>
<td> 6          </td>
<td> The Top 10 User Agents                                               </td>
</tr>
<tr>
<td> 7          </td>
<td> Timeseries: Status Codes Over Time                                   </td>
</tr>
<tr>
<td> 8          </td>
<td> Timeseries: Successfull Website Hits over time                       </td>
</tr>
<tr>
<td> 9          </td>
<td> Counter with Website Hits                                            </td>
</tr>
<tr>
<td> 10         </td>
<td> Average Bytes Returned                                               </td>
</tr>
<tr>
<td> 11         </td>
<td> Tag Cloud with the City Names that Accessed my Blog                  </td>
</tr>
</tbody>
</table>


<h2>Pre-Requirements</h2>

<p>I am consuming my nginx access logs with filebeat and shipping them to elasticsearch. You can check out <a href="https://blog.ruanbekker.com/blog/2019/03/27/ship-your-logs-to-elasticsearch-with-filebeat/">this blogpost</a> to set that up.</p>

<p>The GeoIP Processor plugin is installed on elasticsearch to enrich our data with geographical information. You can check out <a href="https://blog.ruanbekker.com/blog/2018/09/12/using-the-geoip-processor-plugin-with-elasticsearch-to-enrich-your-location-based-data/">this blogpost</a> to setup geoip.</p>

<p>You can setup <a href="https://blog.ruanbekker.com/blog/2018/04/29/running-a-3-node-elasticsearch-cluster-with-docker-compose-on-your-laptop-for-testing/">Kibana and Elasticsearch on Docker</a> or setup a <a href="https://blog.ruanbekker.com/blog/2019/04/02/setup-a-5-node-highly-available-elasticsearch-cluster/">5 Node Elasticsearch Cluster</a></p>

<h2>Setup Kibana Visulizations</h2>

<p>Head over to Kibana, make sure that you have added the <code>filebeat-*</code> index patterns. If not, head over to Management -> Index Patterns -> Create Index -> Enter filebeat-* as you Index Pattern, select Next, select your @timestamp as your timestamp field, select create.</p>

<p>Now from the visualization section we will add 11 Visualizations. Everytime that you create a visualization, make sure that you select filebeat as your pattern (thats if you are using filebeat).</p>

<p>When configuring your visualization it will look like the configuration box from below:</p>

<p><img width="337" alt="image" src="https://user-images.githubusercontent.com/567298/55053831-1aeaea00-5066-11e9-93cf-edfd2ac98e44.png"></p>

<h2>Geomap: Map to see where people are connecting from</h2>

<p><img width="728" alt="kibana geomap" src="https://user-images.githubusercontent.com/567298/55258476-9cf83000-526b-11e9-8560-014098c435ee.png"></p>

<p>Select New Visualization: Coordinate Map</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics, Value: Count. 
</span><span class='line'>     Buckets, Geo Coordinates, Aggregation: Geohash, 
</span><span class='line'>     Field: nginx.access.geoip.location. </span></code></pre></td></tr></table></div></figure>


<p>Save the visualization, in my case Nginx:GeoMap:Filebeat</p>

<h2>Piechart: Cities</h2>

<p>This can give us a quick overview on the percentage of people interested in our website grouped per city.</p>

<p><img width="688" alt="image" src="https://user-images.githubusercontent.com/567298/55258529-c44efd00-526b-11e9-900a-e93ed7eed11e.png"></p>

<p>Select New Visualization, Pie</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> -&gt; Metrics: Slice Size, Aggregation: Count
</span><span class='line'> -&gt; Buckets: Split Slices, 
</span><span class='line'>    Aggregation: Terms, Field: nginx.access.geoip.city_name, 
</span><span class='line'>    Order by: metric: count, 
</span><span class='line'>    Order: Descending, Size: 20</span></code></pre></td></tr></table></div></figure>


<p>Save Visualization.</p>

<h2>Top 10 Accessed Pages</h2>

<p>Great for seeing which page is popular, and Kibana makes it easy to see which page is doing good over a specific time.</p>

<p><img width="750" alt="image" src="https://user-images.githubusercontent.com/567298/55258583-f2ccd800-526b-11e9-98b8-4f1da917cb52.png"></p>

<p>New Visualization: Vertical</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: X-Axis, Aggregation: Terms, 
</span><span class='line'>     Field: nginx.access.url, 
</span><span class='line'>     Ordery by: Metric count, 
</span><span class='line'>     Order: Descending, Size 10</span></code></pre></td></tr></table></div></figure>


<p>I would like to remove <code>/rss</code> and <code>/</code> from my results, so in the search box:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>NOT (nginx.access.url:"/" OR nginx.access.url:"/rss/" OR nginx.access.url:"/subscribe/" OR nginx.access.url:*.txt)</span></code></pre></td></tr></table></div></figure>


<p>Save Visualization.</p>

<h2>Top 5 HTTP Status Codes</h2>

<p>A Grouping of Status Codes (You should see more 200&rsquo;s) but its quick to identify when 404&rsquo;s spike etc.</p>

<p><img width="692" alt="image" src="https://user-images.githubusercontent.com/567298/55258695-44756280-526c-11e9-887c-bd58e9b25750.png"></p>

<p>Select new visualization: Vertical Bar</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: X-Axis, Aggregation: Terms, 
</span><span class='line'>     Field: nginx.access.response_code, 
</span><span class='line'>     Ordery by: Metric count, 
</span><span class='line'>     Order: Descending, Size 5</span></code></pre></td></tr></table></div></figure>


<p>Save Visualization</p>

<h2>Top 404 Pages</h2>

<p>So when people are requesting pages that does not exist, it could most probably be bots trying to attack your site, or trying to gain access etc. This is a great view to see which ones are they trying and then you can handle it from there.</p>

<p><img width="699" alt="image" src="https://user-images.githubusercontent.com/567298/55259089-5b688480-526d-11e9-963d-936a61285507.png"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: X-Axis, Aggregation: Terms, 
</span><span class='line'>     Terms, Field: nginx.access.url, 
</span><span class='line'>     Order by: Metric count, 
</span><span class='line'>     Order: Descending, Size 20</span></code></pre></td></tr></table></div></figure>


<h2>Top 10 User Agents</h2>

<p>Some insights to see the top 10 browsers.</p>

<p><img width="611" alt="image" src="https://user-images.githubusercontent.com/567298/55258763-74246a80-526c-11e9-9873-da2766e4a518.png"></p>

<p>New Visualization: Data Table</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: Split Rows, 
</span><span class='line'>     Aggregation: Terms, 
</span><span class='line'>     Field: nginx.access.user_agent.name, 
</span><span class='line'>     Ordery by: Metric count, 
</span><span class='line'>     Order: Descending, Size 10</span></code></pre></td></tr></table></div></figure>


<p>Save Visualization</p>

<h2>Timeseries: Status Codes over Time</h2>

<p>With timeseries data its great to see when there was a spike in status codes, when you identify the time, you can further investigate why that happened.</p>

<p>New Visualization: Timelion</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(index=filebeat*, timefield='@timestamp', q=nginx.access.response_code:200).label('OK'), .es(index=filebeat*, timefield='@timestamp', q=nginx.access.response_code:404).label('Page Not Found')</span></code></pre></td></tr></table></div></figure>


<h2>Timeseries: Successfull Website Hits over Time</h2>

<p>This is a good view to see how your website is serving traffic over time.</p>

<p><img width="734" alt="image" src="https://user-images.githubusercontent.com/567298/55258920-eac16800-526c-11e9-85ca-5ebff8978b2b.png"></p>

<p>New Visualization: Timelion</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>.es(index=filebeat*, timefield='@timestamp', q=nginx.access.response_code:200).label('200')</span></code></pre></td></tr></table></div></figure>


<h2>Count Metric: Website Hits</h2>

<p>A counter to see the number of website hits over time.</p>

<p><img width="606" alt="image" src="https://user-images.githubusercontent.com/567298/55258980-17757f80-526d-11e9-8664-91afda3db62c.png"></p>

<p>New Visualization: Metric</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Search Query: fields.blog_name:sysadmins AND nginx.access.response_code:200
</span><span class='line'>  -&gt; Metrics: Y-Axis, Aggregation: Count</span></code></pre></td></tr></table></div></figure>


<h2>Average Bytes Transferred</h2>

<p>Line chart with the amount of bandwidth being transferred.</p>

<p><img width="677" alt="image" src="https://user-images.githubusercontent.com/567298/55259036-3c69f280-526d-11e9-90fe-0853d2c0313d.png"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>New Visualization: Line
</span><span class='line'>
</span><span class='line'>-&gt; Metrics: Y-Axis, Aggregation: Average, Field: nginx.access.body_sent.bytes
</span><span class='line'>-&gt; Buckets: X-Axis, Aggregation: Date Histogram, Field: @timestamp</span></code></pre></td></tr></table></div></figure>


<h2>Tag Cloud with Most Popular Cities</h2>

<p>I&rsquo;ve used cities here, but its a nice looking visualization to group the most accessed fields. With server logs you can use this for the usernames failed in ssh attempts for example.</p>

<p><img width="646" alt="image" src="https://user-images.githubusercontent.com/567298/55259343-14c75a00-526e-11e9-88dd-7c3a3f396280.png"></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  -&gt; Metrics: Tag size, Aggregation: Count
</span><span class='line'>  -&gt; Buckets: Tags, 
</span><span class='line'>     Aggregation: Terms, 
</span><span class='line'>     Field: nginx.access.geoip.city_name, 
</span><span class='line'>     Ordery by: Metric count, 
</span><span class='line'>     Order: Descending, Size 10</span></code></pre></td></tr></table></div></figure>


<h2>Create the Dashboard</h2>

<p>Now that we have all our visualizations, lets build the dashboard that hosts all our visualizations.</p>

<p>Select Dashboard -> Create New Dashboard -> Add -> Select your visualizations -> Reorder and Save</p>

<p>The visualizations in my dashboard looks like this:</p>

<p><img width="1266" alt="image" src="https://user-images.githubusercontent.com/567298/55418811-b8b54c00-5573-11e9-810d-d244d27c4fb3.png"></p>

<p>This is a basic dashboard but its just enough so that you can get your hands dirty and build some awesome visualizations.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/12">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/10">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2021/07/12/install-java-11-and-maven-on-ubuntu-linux/">Install Java 11 and Maven on Ubuntu Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/05/03/setup-a-crypto-digibyte-full-node-on-linux/">Setup a Crypto Digibyte Full Node on Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/04/06/install-concourse-ci-v6-on-ubuntu-20-dot-04/">Install Concourse CI V6 on Ubuntu 20.04</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/wireguard-vpn-with-unbound-ads-blocking-dns/">Wireguard VPN With Unbound ADS Blocking DNS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/ssh-using-aws-ssm-session-manager/">SSH Using AWS SSM Session Manager</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest cheatsheets in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com"><img src="https://user-images.githubusercontent.com/567298/97010485-c2334a00-1545-11eb-9e1d-2333e5148da1.png" width="290" height="900"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
