
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="This is a post on a example of how to hash a password with a salt. A salt in cryptography is a method that applies a one way function to hash data &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="http://blog.ruanbekker.com/posts/12/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/07/04/salt-and-hash-example-using-python-with-bcrypt-on-alpine/">Salt and Hash Example Using Python With Bcrypt on Alpine</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-07-04T05:05:00-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>5:05 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a post on a example of how to hash a password with a salt. A salt in cryptography is a method that applies a one way function to hash data like passwords. The advantage of using salts is to protect your sensitive data against dictionary attacks, etc. Everytime a salt is applied to the same string, the hashed string will provide a different result.</p>

<h2>Installing Bcrypt</h2>

<p>I will be using bcrypt to hash my password. I always use alpine images and this is how I got bcrypt running on alpine:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run -it apline sh
</span><span class='line'><span class="nv">$ </span>apk add python python-dev py2-pip autoconf automake g++ make --no-cache
</span><span class='line'><span class="nv">$ </span>pip install py-bcrypt
</span></code></pre></td></tr></table></div></figure>


<p>This command should produce a <code>0 exit code</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python -c <span class="s1">&#39;import bcrypt&#39;</span><span class="p">;</span> <span class="nb">echo</span> <span class="nv">$?</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>Bcrypt Example to Hash a Password</h2>

<p>Here is a example to show you the output when a salt is applied to a string, such as a password. First we will define our very weak password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">bcrypt</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">password</span> <span class="o">=</span> <span class="s">&#39;pass123&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">password</span>
</span><span class='line'><span class="s">&#39;pass123&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The bcrypt package has a function called <code>gensalt()</code> that accepts a parameter <code>log_rounds</code> which defines the complexity of the hashing. Lets create a hash for our password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
</span><span class='line'><span class="s">&#39;$2a$12$iquyyyJAlA9nZwlGo0CYK.J37Qn.to/0mTtiCspNAyO8778006XZG&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
</span><span class='line'><span class="s">&#39;$2a$12$UzNjJ1W/cWqBrt5rzNkb..j.gUvrW64DbvVkNbhRDzBtbRvNInaqq&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the hashed string was different when we called it for the second time.</p>

<h2>Bcrypt Salt Hash and Verification Example:</h2>

<p>Thanks to <a href="https://stackoverflow.com/questions/9594125/salt-and-hash-a-password-in-python">this</a> post, here is a example on how to hash strings and how to verify the plain text password with the provided salt.</p>

<p>Our functions to create the hash and to verify the password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">bcrypt</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">get_hashed_password</span><span class="p">(</span><span class="n">plain_text_password</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>     <span class="k">return</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">plain_text_password</span><span class="p">,</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">())</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="n">plain_text_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>     <span class="k">return</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">plain_text_password</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a hashed string:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">get_hashed_password</span><span class="p">(</span><span class="s">&#39;mynewpassword&#39;</span><span class="p">))</span>
</span><span class='line'><span class="err">$</span><span class="mi">2</span><span class="n">a</span><span class="err">$</span><span class="mi">12</span><span class="err">$</span><span class="o">/</span><span class="n">MemcgbnwJLN8XE86VQZseVxopU6tY76KxnH</span><span class="o">/</span><span class="n">AJ0I9T9y1Ldko5gm</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify the hash with your plain text password and the salt that was created:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">check_password</span><span class="p">(</span><span class="s">&#39;mynewpassword&#39;</span><span class="p">,</span> <span class="s">&#39;$2a$12$/MemcgbnwJLN8XE86VQZseVxopU6tY76KxnH/AJ0I9T9y1Ldko5gm&#39;</span><span class="p">))</span>
</span><span class='line'><span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you you provide the wrong password, with the correct salt, the verification will fail:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">check_password</span><span class="p">(</span><span class="s">&#39;myOLDpassword&#39;</span><span class="p">,</span> <span class="s">&#39;$2a$12$/MemcgbnwJLN8XE86VQZseVxopU6tY76KxnH/AJ0I9T9y1Ldko5gm&#39;</span><span class="p">))</span>
</span><span class='line'><span class="bp">False</span>
</span></code></pre></td></tr></table></div></figure>


<p>When you provide the correct password with the incorrect salt, the verification will also fail:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">check_password</span><span class="p">(</span><span class="s">&#39;mynewpassword&#39;</span><span class="p">,</span> <span class="s">&#39;$2a$12$/MemcgbnwJLN8XE86VQZseVxopU6tY76KxnH/AJ0I9T9y1Ldko5gmX&#39;</span><span class="p">))</span>
</span><span class='line'><span class="bp">False</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/27/setup-a-pptp-vpn-on-ubuntu/">Setup a PPTP VPN on Ubuntu</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-06-27T04:18:51-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>4:18 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we will setup a <a href="https://en.wikipedia.org/wiki/Point-to-Point_Tunneling_Protocol">PPTP</a> VPN on Ubuntu 16.04</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>Disable IPv6 Networking:</h2>

<p>Edit the grub config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi /etc/default/grub
</span></code></pre></td></tr></table></div></figure>


<p>Make the following changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">&quot;ipv6.disable=1&quot;</span>
</span><span class='line'><span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;ipv6.disable=1&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Update Grub and Reboot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>update-grub
</span><span class='line'><span class="nv">$ </span>reboot
</span></code></pre></td></tr></table></div></figure>


<h2>Updates and Install PPTP:</h2>

<p>Update Repositories and install PPTPD:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install pptpd -y
</span></code></pre></td></tr></table></div></figure>


<p>Configure your Authentication</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi /etc/ppp/chap-secrets
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># client server  secret          IP addresses</span>
</span><span class='line'>youruser      pptpd   yourpass        *
</span></code></pre></td></tr></table></div></figure>


<p>Configure Local and Remote IP, in this case I want 10.1.1.2 to 10.1.5.1-254</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi /etc/pptpd.conf
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>option /etc/ppp/pptpd-options
</span><span class='line'>logwtmp
</span><span class='line'>connections 10000
</span><span class='line'>localip 10.1.1.1
</span><span class='line'>remoteip 10.1.1.2-254,10.1.2.1-254,10.1.3.2-254,10.1.4.1-254,10.1.5.1-254
</span><span class='line'><span class="c"># for a /24 you can set</span>
</span><span class='line'><span class="c"># remoteip 10.1.1.2-254</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Enable IP Forwarding:</h2>

<p>Edit the sysctl.conf and enable IP Forwarding:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim /etc/sysctl.conf
</span></code></pre></td></tr></table></div></figure>


<p>Populate the following value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>net.ipv4.ip_forward<span class="o">=</span>1
</span></code></pre></td></tr></table></div></figure>


<p>Update the Changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sysctl -p
</span></code></pre></td></tr></table></div></figure>


<h2>Enable and Start PPTPD:</h2>

<p>Enable the service on boot and start the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>pptpd
</span><span class='line'><span class="nv">$ </span>systemctl start pptpd
</span><span class='line'><span class="nv">$ </span>systemctl status pptpd
</span></code></pre></td></tr></table></div></figure>


<p>Connect to your VPN.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://www.vultr.com/docs/setup-a-pptp-vpn-server-on-ubuntu">https://www.vultr.com/docs/setup-a-pptp-vpn-server-on-ubuntu</a></li>
<li><a href="https://github.com/viljoviitanen/setup-simple-pptp-vpn">https://github.com/viljoviitanen/setup-simple-pptp-vpn</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/14/deploy-docker-swarm-using-ansible/">Deploy Docker Swarm Using Ansible</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-06-14T06:05:46-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>6:05 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg" alt="" /></p>

<p>In this setup we will use Ansible to Deploy Docker Swarm.</p>

<p>With this setup, I have a client node, which will be my jump box, as it will be used to ssh with the docker user to my swarm nodes with passwordless ssh access.</p>

<p>The repository for the source code can be found on my <a href="https://github.com/ruanbekker/ansible-docker-swarm">Github Repository</a></p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>Pre-Check</h2>

<p>Hosts file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/hosts
</span><span class='line'>10.0.8.2 client
</span><span class='line'>192.168.1.10 swarm-manager
</span><span class='line'>192.168.1.11 swarm-worker-1
</span><span class='line'>192.168.1.12 swarm-worker-2</span></code></pre></td></tr></table></div></figure>


<p>SSH Config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.ssh/config 
</span><span class='line'>Host client
</span><span class='line'>  Hostname client
</span><span class='line'>  User root
</span><span class='line'>  IdentityFile /tmp/key.pem
</span><span class='line'>  StrictHostKeyChecking no
</span><span class='line'>  UserKnownHostsFile /dev/null
</span><span class='line'>
</span><span class='line'>Host swarm-manager
</span><span class='line'>  Hostname swarm-manager
</span><span class='line'>  User root
</span><span class='line'>  IdentityFile /tmp/key.pem
</span><span class='line'>  StrictHostKeyChecking no
</span><span class='line'>  UserKnownHostsFile /dev/null
</span><span class='line'>
</span><span class='line'>Host swarm-worker-1
</span><span class='line'>  Hostname swarm-worker-1
</span><span class='line'>  User root
</span><span class='line'>  IdentityFile /tmp/key.pem
</span><span class='line'>  StrictHostKeyChecking no
</span><span class='line'>  UserKnownHostsFile /dev/null
</span><span class='line'>
</span><span class='line'>Host swarm-worker-2
</span><span class='line'>  Hostname swarm-worker-2
</span><span class='line'>  User root
</span><span class='line'>  IdentityFile /tmp/key.pem
</span><span class='line'>  StrictHostKeyChecking no
</span><span class='line'>  UserKnownHostsFile /dev/null</span></code></pre></td></tr></table></div></figure>


<p>Install Ansible:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install python-setuptools -y
</span><span class='line'>$ easy_install pip
</span><span class='line'>$ pip install ansible</span></code></pre></td></tr></table></div></figure>


<p>Ensure passwordless ssh is working:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ansible -i inventory.ini -u root -m ping all
</span><span class='line'>client | SUCCESS =&gt; {
</span><span class='line'>    "changed": false, 
</span><span class='line'>    "ping": "pong"
</span><span class='line'>}
</span><span class='line'>swarm-manager | SUCCESS =&gt; {
</span><span class='line'>    "changed": false, 
</span><span class='line'>    "ping": "pong"
</span><span class='line'>}
</span><span class='line'>swarm-worker-2 | SUCCESS =&gt; {
</span><span class='line'>    "changed": false, 
</span><span class='line'>    "ping": "pong"
</span><span class='line'>}
</span><span class='line'>swarm-worker-1 | SUCCESS =&gt; {
</span><span class='line'>    "changed": false, 
</span><span class='line'>    "ping": "pong"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Deploy Docker Swarm</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ansible-playbook -i inventory.ini -u root deploy-swarm.yml 
</span><span class='line'>PLAY RECAP 
</span><span class='line'>
</span><span class='line'>client                     : ok=11   changed=3    unreachable=0    failed=0   
</span><span class='line'>swarm-manager              : ok=18   changed=4    unreachable=0    failed=0   
</span><span class='line'>swarm-worker-1             : ok=15   changed=1    unreachable=0    failed=0   
</span><span class='line'>swarm-worker-2             : ok=15   changed=1    unreachable=0    failed=0   </span></code></pre></td></tr></table></div></figure>


<p>SSH to the Swarm Manager and List the Nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker node ls
</span><span class='line'>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
</span><span class='line'>0ead0jshzkpyrw7livudrzq9o *   swarm-manager       Ready               Active              Leader              18.03.1-ce
</span><span class='line'>iwyp6t3wcjdww0r797kwwkvvy     swarm-worker-1      Ready               Active                                  18.03.1-ce
</span><span class='line'>ytcc86ixi0kuuw5mq5xxqamt1     swarm-worker-2      Ready               Active                                  18.03.1-ce</span></code></pre></td></tr></table></div></figure>


<h2>Test Application on Swarm</h2>

<p>Create a Nginx Demo Service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker network create --driver overlay appnet
</span><span class='line'>$ docker service create --name nginx --publish 80:80 --network appnet --replicas 6 nginx
</span><span class='line'>$ docker service ls
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
</span><span class='line'>k3vwvhmiqbfk        nginx               replicated          6/6                 nginx:latest        *:80-&gt;80/tcp
</span><span class='line'>
</span><span class='line'>$ docker service ps nginx
</span><span class='line'>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
</span><span class='line'>tspsypgis3qe        nginx.1             nginx:latest        swarm-manager       Running             Running 34 seconds ago                       
</span><span class='line'>g2f0ytwb2jjg        nginx.2             nginx:latest        swarm-worker-1      Running             Running 34 seconds ago                       
</span><span class='line'>clcmew8bcvom        nginx.3             nginx:latest        swarm-manager       Running             Running 34 seconds ago                       
</span><span class='line'>q293r8zwu692        nginx.4             nginx:latest        swarm-worker-2      Running             Running 34 seconds ago                       
</span><span class='line'>sv7bqa5e08zw        nginx.5             nginx:latest        swarm-worker-1      Running             Running 34 seconds ago                       
</span><span class='line'>r7qg9nk0a9o2        nginx.6             nginx:latest        swarm-worker-2      Running             Running 34 seconds ago   </span></code></pre></td></tr></table></div></figure>


<p>Test the Application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -i http://192.168.1.10
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Server: nginx/1.15.0
</span><span class='line'>Date: Thu, 14 Jun 2018 10:01:34 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 612
</span><span class='line'>Last-Modified: Tue, 05 Jun 2018 12:00:18 GMT
</span><span class='line'>Connection: keep-alive
</span><span class='line'>ETag: "5b167b52-264"
</span><span class='line'>Accept-Ranges: bytes</span></code></pre></td></tr></table></div></figure>


<p>Delete the Service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>$ docker service rm nginx
</span><span class='line'>nginx</span></code></pre></td></tr></table></div></figure>


<h2>Delete the Swarm:</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ansible-playbook -i inventory.ini -u root delete-swarm.yml 
</span><span class='line'>
</span><span class='line'>PLAY RECAP 
</span><span class='line'>swarm-manager              : ok=2    changed=1    unreachable=0    failed=0   
</span><span class='line'>swarm-worker-1             : ok=2    changed=1    unreachable=0    failed=0   
</span><span class='line'>swarm-worker-2             : ok=2    changed=1    unreachable=0    failed=0   </span></code></pre></td></tr></table></div></figure>


<p>Ensure the Nodes is removed from the Swarm, SSH to your Swarm Manager:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker node ls
</span><span class='line'>Error response from daemon: This node is not a swarm manager. Use "docker swarm init" or "docker swarm join" to connect this node to swarm and try again.</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/13/setup-a-3-node-ceph-storage-cluster-on-ubuntu-16/">Setup a 3 Node Ceph Storage Cluster on Ubuntu 16</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-06-13T18:22:06-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>6:22 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://ceph.com/wp-content/uploads/2016/07/Ceph_Logo_Standard_RGB_120411_fa.png" alt="" /></p>

<p>For some time now, I wanted to do a setup of Ceph, and I finally got the time to do it. This setup was done on Ubuntu 16.04</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>What is Ceph</h2>

<p>Ceph is a storage platform that implements object storage on a single distributed computer cluster and provides interfaces for object, block and file-level storage.</p>

<ul>
<li>Object Storage:</li>
</ul>


<p>Ceph provides seemless access to objects via native language bindings or via the REST interface, RadosGW and also compatible for applications written for S3 and Swift.</p>

<ul>
<li>Block Storage:</li>
</ul>


<p>Ceph&rsquo;s Rados Block Device (RBD) provides access to block device images that are replicated and striped across the storage cluster.</p>

<ul>
<li>File System:</li>
</ul>


<p>Ceph provides a network file system (CephFS) that aims for high performance.</p>

<h2>Our Setup</h2>

<p>We will have 4 nodes. 1 Admin node where we will deploy our cluster with, and 3 nodes that will hold the data:</p>

<ul>
<li>ceph-admin (10.0.8.2)</li>
<li>ceph-node1 (10.0.8.3)</li>
<li>ceph-node2 (10.0.8.4)</li>
<li>ceph-node3 (10.0.8.5)</li>
</ul>


<h2>Host Entries</h2>

<p>If you don&rsquo;t have dns for your servers, setup the <code>/etc/hosts</code> file so that the names can resolves to the ip addresses:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>10.0.8.2 ceph-admin
</span><span class='line'>10.0.8.3 ceph-node1
</span><span class='line'>10.0.8.4 ceph-node2
</span><span class='line'>10.0.8.5 ceph-node3
</span></code></pre></td></tr></table></div></figure>


<h2>User Accounts and Passwordless SSH</h2>

<p>Setup the <code>ceph-system</code> user accounts on all the servers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>useradd -d /home/ceph-system -s /bin/bash -m ceph-system
</span><span class='line'><span class="nv">$ </span>passwd ceph-system
</span></code></pre></td></tr></table></div></figure>


<p>Setup the created user part of the sudoers that is able to issue sudo commands without a pssword:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;ceph-system ALL = (root) NOPASSWD:ALL&quot;</span> <span class="p">|</span> sudo tee /etc/sudoers.d/ceph-system
</span><span class='line'><span class="nv">$ </span>chmod <span class="m">0440</span> /etc/sudoers.d/ceph-system
</span></code></pre></td></tr></table></div></figure>


<p>Switch user to <code>ceph-system</code> and generate SSH keys and copy the keys from the <code>ceph-admin</code> server to the ceph-nodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo su - ceph-system
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -f ~/.ssh/id_rsa -P <span class="s2">&quot;&quot;</span>
</span><span class='line'><span class="nv">$ </span>ssh-copy-id ceph-system@ceph-node1
</span><span class='line'><span class="nv">$ </span>ssh-copy-id ceph-system@ceph-node2
</span><span class='line'><span class="nv">$ </span>ssh-copy-id ceph-system@ceph-node3
</span><span class='line'><span class="nv">$ </span>ssh-copy-id ceph-system@ceph-admin
</span></code></pre></td></tr></table></div></figure>


<h2>Pre-Requisite Software:</h2>

<p>Install Python and Ceph Deploy on each node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-get install python -y
</span><span class='line'><span class="nv">$ </span>sudo apt install ceph-deploy -y
</span></code></pre></td></tr></table></div></figure>


<p>Note: Please skip this section if you have additional disks on your servers.</p>

<p>The instances that im using to test this setup only has one disk, so I will be creating loop block devices using allocated files. This is not recommended as when the disk fails, all the (files/block device images) will be gone with that. But since im demonstrating this, I will create the block devices from a file:</p>

<p>I will be creating a 12GB file on each node</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo mkdir /raw-disks
</span><span class='line'><span class="nv">$ </span>sudo dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>/raw-disks/rd0 <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span>12288
</span></code></pre></td></tr></table></div></figure>


<p>The use losetup to create the loop0 block device:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo losetup /dev/loop0 /raw-disks/rd0
</span></code></pre></td></tr></table></div></figure>


<p>As you can see the loop device is showing when listing the block devices:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsblk
</span><span class='line'>NAME      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span><span class='line'>loop0       7:0    <span class="m">0</span>   12G  <span class="m">0</span> loop
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>Install Ceph</h2>

<p>Now let&rsquo;s install ceph using ceph-deploy to all our nodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span><span class='line'><span class="nv">$ </span>ceph-deploy install ceph-admin ceph-node1 ceph-node2 ceph-node3
</span></code></pre></td></tr></table></div></figure>


<p>The version I was running at the time:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph --version
</span><span class='line'>ceph version 10.2.9
</span></code></pre></td></tr></table></div></figure>


<h2>Initialize Ceph</h2>

<p>Initialize the Cluster with 3 Monitors:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph-deploy new ceph-node1 ceph-node2 ceph-node3
</span></code></pre></td></tr></table></div></figure>


<p>Add the initial monitors and gather the keys from the previous command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph-deploy mon create-initial
</span></code></pre></td></tr></table></div></figure>


<p>At this point, we should be able to scan the block devices on our nodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph-deploy disk list ceph-node3
</span><span class='line'><span class="o">[</span>ceph-node3<span class="o">][</span>INFO  <span class="o">]</span> Running <span class="nb">command</span>: sudo /usr/sbin/ceph-disk list
</span><span class='line'><span class="o">[</span>ceph-node3<span class="o">][</span>DEBUG <span class="o">]</span> /dev/loop0 other
</span></code></pre></td></tr></table></div></figure>


<h2>Prepare the Disks:</h2>

<p>First we will zap the block devices and then prepare to create the partitions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph-deploy disk zap ceph-node1:/dev/loop0 ceph-node2:/dev/loop0 ceph-node3:/dev/loop0
</span><span class='line'><span class="nv">$ </span>ceph-deploy osd prepare ceph-node1:/dev/loop0 ceph-node2:/dev/loop0 ceph-node3:/dev/loop0
</span><span class='line'><span class="o">[</span>ceph_deploy.osd<span class="o">][</span>DEBUG <span class="o">]</span> Host ceph-node1 is now ready <span class="k">for</span> osd use.
</span><span class='line'><span class="o">[</span>ceph_deploy.osd<span class="o">][</span>DEBUG <span class="o">]</span> Host ceph-node2 is now ready <span class="k">for</span> osd use.
</span><span class='line'><span class="o">[</span>ceph_deploy.osd<span class="o">][</span>DEBUG <span class="o">]</span> Host ceph-node3 is now ready <span class="k">for</span> osd use.
</span></code></pre></td></tr></table></div></figure>


<p>When you scan the nodes for their disks, you will notice that the partitions has been created:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph-deploy disk list ceph-node1
</span><span class='line'><span class="o">[</span>ceph-node1<span class="o">][</span>DEBUG <span class="o">]</span> /dev/loop0p2 ceph journal, <span class="k">for</span> /dev/loop0p1
</span><span class='line'><span class="o">[</span>ceph-node1<span class="o">][</span>DEBUG <span class="o">]</span> /dev/loop0p1 ceph data, active, cluster ceph, osd.0, journal /dev/loop0p2
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s activate the OSD&rsquo;s by using the data partitions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph-deploy osd activate ceph-node1:/dev/loop0p1 ceph-node2:/dev/loop0p1 ceph-node3:/dev/loop0p1
</span></code></pre></td></tr></table></div></figure>


<h2>Redistribute Keys:</h2>

<p>Copy the configuration files and admin key to your admin node and ceph data nodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph-deploy admin ceph-admin ceph-node1 ceph-node2 ceph-node3
</span></code></pre></td></tr></table></div></figure>


<p>If you would like to add more OSD&rsquo;s (not tested):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph-deploy disk zap ceph-node1:/dev/loop1 ceph-node2:/dev/loop1 ceph-node3:/dev/loop1
</span><span class='line'><span class="nv">$ </span>ceph-deploy osd prepare ceph-node1:/dev/loop1 ceph-node2:/dev/loop1 ceph-node3:/dev/loop1
</span><span class='line'><span class="nv">$ </span>ceph-deploy osd activate ceph-node2:/dev/loop1p1:/dev/loop1p2 ceph-node2:/dev/loop1p1:/dev/loop1p2 ceph-node3:/dev/loop1p1:/dev/loop1p2
</span><span class='line'><span class="nv">$ </span>ceph-deploy admin ceph-node1 ceph-node2 ceph-node3
</span></code></pre></td></tr></table></div></figure>


<h2>Ceph Status:</h2>

<p>Have a look at your cluster status:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo ceph -s
</span><span class='line'>    cluster 8d704c8a-ac19-4454-a89f-89a5d5b7d94d
</span><span class='line'>     health HEALTH_OK
</span><span class='line'>     monmap e1: <span class="m">3</span> mons at <span class="o">{</span>ceph-node1<span class="o">=</span>10.0.8.3:6789/0,ceph-node2<span class="o">=</span>10.0.8.4:6789/0,ceph-node3<span class="o">=</span>10.0.8.5:6789/0<span class="o">}</span>
</span><span class='line'>            election epoch 10, quorum 0,1,2 ceph-node2,ceph-node3,ceph-node1
</span><span class='line'>     osdmap e14: <span class="m">3</span> osds: <span class="m">3</span> up, <span class="m">3</span> in
</span><span class='line'>            flags sortbitwise,require_jewel_osds
</span><span class='line'>      pgmap v29: <span class="m">64</span> pgs, <span class="m">1</span> pools, <span class="m">0</span> bytes data, <span class="m">0</span> objects
</span><span class='line'>            <span class="m">100</span> MB used, <span class="m">18298</span> MB / <span class="m">18398</span> MB avail
</span><span class='line'>                  <span class="m">64</span> active+clean
</span></code></pre></td></tr></table></div></figure>


<p>Everything looks good. Also change the permissions on this file, on all the nodes in order to execute the ceph, rados commands:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo chmod +r /etc/ceph/ceph.client.admin.keyring
</span></code></pre></td></tr></table></div></figure>


<h2>Storage Pools:</h2>

<p>List your pool in your Ceph Cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rados lspools
</span><span class='line'>rbd
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s create a new storage pool called <code>mypool</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph osd pool create mypool <span class="m">32</span> <span class="m">32</span>
</span><span class='line'>pool <span class="s1">&#39;mypool&#39;</span> created
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s the list the storage pools again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rados lspools
</span><span class='line'>rbd
</span><span class='line'>mypool
</span></code></pre></td></tr></table></div></figure>


<p>You can also use the ceph command to list the pools:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph osd pool ls
</span><span class='line'>rbd
</span><span class='line'>mypool
</span></code></pre></td></tr></table></div></figure>


<p>Create a Block Device Image:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rbd create --size <span class="m">1024</span> mypool/disk1 --image-feature layering
</span></code></pre></td></tr></table></div></figure>


<p>List the Block Device Images under your Pool:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rbd list mypool
</span><span class='line'>disk1
</span></code></pre></td></tr></table></div></figure>


<p>Retrieve information from your image:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rbd info mypool/disk1
</span><span class='line'>rbd image <span class="s1">&#39;disk1&#39;</span>:
</span><span class='line'>        size <span class="m">1024</span> MB in <span class="m">256</span> objects
</span><span class='line'>        order <span class="m">22</span> <span class="o">(</span><span class="m">4096</span> kB objects<span class="o">)</span>
</span><span class='line'>        block_name_prefix: rbd_data.1021643c9869
</span><span class='line'>        format: 2
</span><span class='line'>        features: layering
</span><span class='line'>        flags:
</span><span class='line'>        create_timestamp: Thu Jun  <span class="m">7</span> 23:48:23 2018
</span></code></pre></td></tr></table></div></figure>


<p>Create a local mapping of the image to a block device:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo rbd map mypool/disk1
</span><span class='line'>/dev/rbd0
</span></code></pre></td></tr></table></div></figure>


<p>Now we have a block device available at <code>/dev/rbd0</code>. Go ahead and mount it to <code>/mnt</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo mount /dev/rbd0 /mnt
</span></code></pre></td></tr></table></div></figure>


<p>We can then see it when we list our mounted disk partitions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/sda1        19G   13G  5.2G  72% /
</span><span class='line'>/dev/rbd0       976M  1.3M  908M   1% /mnt
</span></code></pre></td></tr></table></div></figure>


<p>We can also resize the disk on the fly, let&rsquo;s resize it from 1GB to 2GB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rbd resize mypool/disk1 --size 2048
</span><span class='line'>Resizing image: 100% complete...done.
</span></code></pre></td></tr></table></div></figure>


<p>To grow the space we can use resize2fs for ext4 partitions and xfs_growfs for xfs partitions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo resize2fs /dev/rbd0
</span><span class='line'>resize2fs 1.42.13 <span class="o">(</span>17-May-2015<span class="o">)</span>
</span><span class='line'>Filesystem at /dev/rbd0 is mounted on /mnt<span class="p">;</span> on-line resizing required
</span><span class='line'><span class="nv">old_desc_blocks</span> <span class="o">=</span> 1, <span class="nv">new_desc_blocks</span> <span class="o">=</span> 1
</span><span class='line'>The filesystem on /dev/rbd0 is now <span class="m">524288</span> <span class="o">(</span>4k<span class="o">)</span> blocks long.
</span></code></pre></td></tr></table></div></figure>


<p>When we look at our mounted partitions, you will notice that the size of our mounted partition has been increased in size:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/sda1        19G   13G  5.2G   72% /
</span><span class='line'>/dev/rbd0       2.0G  1.5M  1.9G   1% /mnt
</span></code></pre></td></tr></table></div></figure>


<h2>Object Storage RadosGW</h2>

<p>Let&rsquo;s create a new pool where we will store our objects:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ceph osd pool create object-pool <span class="m">32</span> 32
</span><span class='line'>pool <span class="s1">&#39;object-pool&#39;</span> created
</span></code></pre></td></tr></table></div></figure>


<p>We will now create a local file, push the file to our object storage service, then delete our local file, download the file as a file with a different name, and read the contents:</p>

<p>Create the local file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;ok&quot;</span> &gt; test.txt
</span></code></pre></td></tr></table></div></figure>


<p>Push the local file to our pool in our object storage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rados put objects/data/test.txt ./test.txt --pool object-pool
</span></code></pre></td></tr></table></div></figure>


<p>List the pool (note that this can be executed from any node):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ $ </span>rados ls --pool object-pool
</span><span class='line'>objects/data/test.txt
</span></code></pre></td></tr></table></div></figure>


<p>Delete the local file, download the file from our object storage and read the contents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rm -rf test.txt
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>rados get objects/data/test.txt ./newfile.txt --pool object-pool
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>cat ./newfile.txt
</span><span class='line'>ok
</span></code></pre></td></tr></table></div></figure>


<p>View the disk space from our storage-pool:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rados df --pool object-pool
</span><span class='line'>pool name                 KB      objects       clones     degraded      unfound           rd        rd KB           wr        wr KB
</span><span class='line'>object-pool                <span class="m">1</span>            <span class="m">1</span>            <span class="m">0</span>            <span class="m">0</span>            <span class="m">0</span>            <span class="m">0</span>            <span class="m">0</span>            <span class="m">1</span>            1
</span><span class='line'>  total used          <span class="m">261144</span>           37
</span><span class='line'>  total avail       18579372
</span><span class='line'>  total space       18840516
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://stackoverflow.com/questions/39589696/ceph-too-many-pgs-per-osd-all-you-need-to-know">https://stackoverflow.com/questions/39589696/ceph-too-many-pgs-per-osd-all-you-need-to-know</a></li>
<li><a href="https://github.com/lucj/swarm-rexray-ceph">https://github.com/lucj/swarm-rexray-ceph</a></li>
<li><a href="http://docs.ceph.com/docs/mimic/rbd/">http://docs.ceph.com/docs/mimic/rbd/</a></li>
<li><a href="http://docs.ceph.com/docs/mimic/radosgw/">http://docs.ceph.com/docs/mimic/radosgw/</a></li>
</ul>


<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/09/hello-world-programs-in-different-languages/">Hello World Programs in Different Languages</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-06-09T21:11:00-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>9:11 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post will demonstrate running hello world programs in different languages and also providing return time statistics</p>

<h2>C++</h2>

<p>Code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="n">using</span> <span class="n">namespace</span> <span class="n">std</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello, World!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>c++ hello_cpp.cpp -o hello_cpp
</span></code></pre></td></tr></table></div></figure>


<p>Run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">time</span> ./hello_cpp
</span><span class='line'>Hello, World!
</span><span class='line'>
</span><span class='line'>real  0m0.005s
</span><span class='line'>user  0m0.001s
</span><span class='line'>sys     0m0.001s
</span></code></pre></td></tr></table></div></figure>


<h2>Golang:</h2>

<p>Code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go build hello_golang.go
</span></code></pre></td></tr></table></div></figure>


<p>Run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">time</span> ./hello_golang
</span><span class='line'>Hello, World!
</span><span class='line'>
</span><span class='line'>real  0m0.006s
</span><span class='line'>user  0m0.001s
</span><span class='line'>sys     0m0.003s
</span></code></pre></td></tr></table></div></figure>


<h2>Python</h2>

<p>Code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make it executable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x ./hello_python.py
</span></code></pre></td></tr></table></div></figure>


<p>Run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">time</span> ./hello_python.py
</span><span class='line'>Hello, World!
</span><span class='line'>
</span><span class='line'>real  0m0.033s
</span><span class='line'>user  0m0.015s
</span><span class='line'>sys     0m0.010s
</span></code></pre></td></tr></table></div></figure>


<h2>Ruby</h2>

<p>Code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make it executable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x ./hello_ruby.rb
</span></code></pre></td></tr></table></div></figure>


<p>Run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">time</span> ./hello_ruby.rb
</span><span class='line'>Hello, World!
</span><span class='line'>
</span><span class='line'>real  0m0.136s
</span><span class='line'>user  0m0.080s
</span><span class='line'>sys     0m0.024s
</span></code></pre></td></tr></table></div></figure>


<h2>Java</h2>

<p>Code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">hello_java</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello, World!&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>javac hello_java.java
</span></code></pre></td></tr></table></div></figure>


<p>Run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">time </span>java hello_java
</span><span class='line'>Hello, World!
</span><span class='line'>
</span><span class='line'>real  0m0.114s
</span><span class='line'>user  0m0.086s
</span><span class='line'>sys     0m0.023s
</span></code></pre></td></tr></table></div></figure>


<h2>Resource:</h2>

<ul>
<li><a href="https://www.lifewire.com/command-return-time-command-4054237">https://www.lifewire.com/command-return-time-command-4054237</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/02/setup-a-peer-to-peer-vpn-with-vpncloud-on-ubuntu/">Setup a Peer to Peer VPN With VPNCloud on Ubuntu</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-06-02T14:15:33-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2018</span></span> <span class='time'>2:15 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So I got 3 Dedicated Servers each having its own Static IP and I wanted a way to build a private network between these servers.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>The Scenario:</h2>

<p>3 Servers with the following IP&rsquo;s (not real IP addresses):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- Server 1: 52.1.99.10
</span><span class='line'>- Server 2: 52.1.84.20
</span><span class='line'>- Server 3: 52.1.49.30</span></code></pre></td></tr></table></div></figure>


<p>So I want to have a private network, so that I can have the following internal network:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- Server 1: 10.0.1.1
</span><span class='line'>- Server 2: 10.0.1.2
</span><span class='line'>- Server 3: 10.0.1.3</span></code></pre></td></tr></table></div></figure>


<p>A couple of years ago, I accomplished the end goal using GRE Tunnels, which works well, but wanted to try something different.</p>

<h2>VPNCloud</h2>

<p>So I stumbled upon VPNCloud.rs, which is a peer to peer VPN. Their description, quoted from their Github page:</p>

<p>&ldquo;VpnCloud is a simple VPN over UDP. It creates a virtual network interface on the host and forwards all received data via UDP to the destination. VpnCloud establishes a fully-meshed VPN network in a peer-to-peer manner. It can work on TUN devices (IP based) and TAP devices (Ethernet based).&rdquo;</p>

<p>This is exactly what I was looking for.</p>

<h2>Setting up a 3 node Private Network:</h2>

<p>Given the IP configuration above, we will setup a Private network between our 3 hosts.</p>

<p>Do some updates then grab the package from <a href="https://github.com/dswd/vpncloud.rs/releases">Github</a> and install VPNCloud:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt ugprade -y
</span><span class='line'><span class="nv">$ </span>wget https://github.com/dswd/vpncloud.rs/releases/download/v0.8.1/vpncloud_0.8.1_amd64.deb
</span><span class='line'><span class="nv">$ </span>dpkg -i ./vpncloud_0.8.1_amd64.deb
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s start the configuration on Server-1, this config should also be setup on the other 2 servers, the config will remain the same, except for the <code>ifup</code> command. The other servers will look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Server-2: -&gt; ifup: <span class="s2">&quot;ifconfig $IFNAME 10.0.1.2/24 mtu 1400&quot;</span>
</span><span class='line'>Server-3: -&gt; ifup: <span class="s2">&quot;ifconfig $IFNAME 10.0.1.3/24 mtu 1400&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Getting back to the Server-1 config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim /etc/vpncloud/private.net
</span></code></pre></td></tr></table></div></figure>


<p>Example Config that I am using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># each vpn running on their own port</span>
</span><span class='line'>port: 3210
</span><span class='line'>
</span><span class='line'><span class="c"># members of our private network</span>
</span><span class='line'>peers:
</span><span class='line'>  - srv2.domain.com:3210
</span><span class='line'>  - srv3.domain.com:3210
</span><span class='line'>
</span><span class='line'><span class="c"># timeouts</span>
</span><span class='line'>peer_timeout: 1800
</span><span class='line'>dst_timeout: 300
</span><span class='line'>
</span><span class='line'><span class="c"># token that identifies the network and helps to distinguish from other networks</span>
</span><span class='line'>magic: <span class="s2">&quot;76706e01&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># pre shared key</span>
</span><span class='line'>shared_key: <span class="s2">&quot;VeryStrongPreSharedKey_ThatShouldBeChanged&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># encryption</span>
</span><span class='line'>crypto: aes256
</span><span class='line'>
</span><span class='line'><span class="c"># device info</span>
</span><span class='line'>device_name: <span class="s2">&quot;vpncloud%d&quot;</span>
</span><span class='line'>device_type: tap
</span><span class='line'>
</span><span class='line'><span class="c"># vpn modes: hub / switch / router / normal</span>
</span><span class='line'>mode: normal
</span><span class='line'>
</span><span class='line'><span class="c"># subnet to be used for our private network</span>
</span><span class='line'>subnets:
</span><span class='line'>  - 10.0.1.0/24
</span><span class='line'>
</span><span class='line'><span class="c"># command to setup the network</span>
</span><span class='line'>ifup: <span class="s2">&quot;ifconfig $IFNAME 10.0.1.1/24 mtu 1400&quot;</span>
</span><span class='line'>ifdown: <span class="s2">&quot;ifconfig $IFNAME down&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># user/group owning the process</span>
</span><span class='line'>user: <span class="s2">&quot;root&quot;</span>
</span><span class='line'>group: <span class="s2">&quot;root&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Repeat the config on the other servers.</p>

<h2>Start the VPN Service:</h2>

<p>Restart the VPNCloud Service on all the Servers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>service vpncloud@private start
</span></code></pre></td></tr></table></div></figure>


<p>Check the status:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>service vpncloud@private status
</span></code></pre></td></tr></table></div></figure>


<p>Check if the interface is up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ifconfig vpncloud0
</span><span class='line'>vpncloud0 Link encap:Ethernet  HWaddr aa:bb:cc:dd:ee:ff
</span><span class='line'>          inet addr:10.0.1.1  Bcast:10.0.1.255  Mask:255.255.255.0
</span><span class='line'>          UP BROADCAST RUNNING MULTICAST  MTU:1400  Metric:1
</span><span class='line'>          RX packets:55 errors:0 dropped:0 overruns:0 frame:0
</span><span class='line'>          TX packets:71 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>          collisions:0 txqueuelen:1000
</span><span class='line'>          RX bytes:5046 <span class="o">(</span>5.0 KB<span class="o">)</span>  TX bytes:5526 <span class="o">(</span>5.5 KB<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ping the 3rd server via the private network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ping -c <span class="m">3</span> 10.0.1.3
</span><span class='line'>PING 10.0.1.2 <span class="o">(</span>10.0.1.3<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span><span class='line'><span class="m">64</span> bytes from 10.0.1.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nb">time</span><span class="o">=</span>0.852 ms
</span><span class='line'><span class="m">64</span> bytes from 10.0.1.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nb">time</span><span class="o">=</span>0.831 ms
</span><span class='line'><span class="m">64</span> bytes from 10.0.1.3: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nb">time</span><span class="o">=</span>0.800 ms
</span><span class='line'>
</span><span class='line'>--- 10.0.1.3 ping statistics ---
</span><span class='line'><span class="m">3</span> packets transmitted, <span class="m">3</span> received, 0% packet loss, <span class="nb">time </span>2028ms
</span><span class='line'>rtt min/avg/max/mdev <span class="o">=</span> 0.800/0.827/0.852/0.039 ms
</span></code></pre></td></tr></table></div></figure>


<p>Awesome service, please check their <a href="https://github.com/dswd/vpncloud.rs">Github Repo</a> out.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/01/add-a-authentication-header-to-your-python-flask-app/">Add a Authentication Header to Your Python Flask App</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-06-01T03:28:05-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2018</span></span> <span class='time'>3:28 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53351527-18dc2100-392a-11e9-9e50-48f738046a68.jpg" alt="" /></p>

<p>We will write a simple Python Flask application that requires authentication in order to respond with a 200 HTTP Status code.</p>

<h2>Python Flask Application:</h2>

<p>Our Python Flask application will require the Header <code>x-api-key dhuejso2dj3d0</code> in the HTTP Request, to give us a 200 HTTP Status code, if not, we will respond with a 401 Unauthorized Response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span><span class='line'>    <span class="n">headers</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span>
</span><span class='line'>    <span class="n">auth</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;X-Api-Key&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">auth</span> <span class="o">==</span> <span class="s">&#39;asoidewfoef&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;OK: Authorized&quot;</span><span class="p">}),</span> <span class="mi">200</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;ERROR: Unauthorized&quot;</span><span class="p">}),</span> <span class="mi">401</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>To get the headers, you can use <code>headers.get("X-Api-Key")</code> or <code>headers["X-Api-Key"]</code></p>

<p>Create a virtual environment, install flask and run the app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virtualenv .venv
</span><span class='line'><span class="nv">$ </span><span class="nb">source</span> .venv/bin/activate
</span><span class='line'><span class="nv">$ </span>python app.py
</span><span class='line'> * Serving Flask app <span class="s2">&quot;app&quot;</span> <span class="o">(</span>lazy loading<span class="o">)</span>
</span><span class='line'> * Environment: production
</span><span class='line'>   WARNING: Do not use the development server in a production environment.
</span><span class='line'>   Use a production WSGI server instead.
</span><span class='line'> * Debug mode: off
</span><span class='line'> * Running on http://127.0.0.1:5000/ <span class="o">(</span>Press CTRL+C to quit<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Requests to our App:</h2>

<p>Let&rsquo;s first make a request with no headers, which should then give us a 401 Unautorhized response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i http://localhost:5000
</span><span class='line'>
</span><span class='line'>HTTP/1.0 <span class="m">401</span> UNAUTHORIZED
</span><span class='line'>Content-Type: application/json
</span><span class='line'>Content-Length: 33
</span><span class='line'>Server: Werkzeug/0.14.1 Python/3.6.5
</span><span class='line'>Date: Fri, <span class="m">01</span> Jun <span class="m">2018</span> 07:26:25 GMT
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;ERROR: Unauthorized&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Now let&rsquo;s include the authentication token in our headers. If the string is the same as the one in the code, we should see a 200 HTTP Response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i -H <span class="s1">&#39;x-api-key: asoidewfoef&#39;</span> http://localhost:5000
</span><span class='line'>
</span><span class='line'>HTTP/1.0 <span class="m">200</span> OK
</span><span class='line'>Content-Type: application/json
</span><span class='line'>Content-Length: 29
</span><span class='line'>Server: Werkzeug/0.14.1 Python/3.6.5
</span><span class='line'>Date: Fri, <span class="m">01</span> Jun <span class="m">2018</span> 07:27:03 GMT
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;OK: Authorized&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Note:</h2>

<p>From a best practice, its not a good decision to hard code sensitive details in your code, but rather read that from an encrypted database and store that in your applications environment variables, and let your application read from the environment variables, something like that :D</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/06/01/clearing-up-disk-space-on-docker-swarm-by-removing-unused-data-with-prune/">Clearing Up Disk Space on Docker Swarm by Removing Unused Data With Prune</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-06-01T02:19:21-04:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2018</span></span> <span class='time'>2:19 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg" alt="" /></p>

<p>After some time, your system can run out of disk space when running a lot of containers / volumes etc. You will find that at times, you will have a lot of unused containers, stopped containers, unused images, unused networks that is just sitting there, which consumes data on your nodes.</p>

<p>One way to clean them is by using <code>docker system prune</code>.</p>

<h2>Check Docker Disk Space</h2>

<p>The command below will show the amount of disk space consumed, and how much is reclaimable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker system df
</span><span class='line'>TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE
</span><span class='line'>Images              <span class="m">229</span>                 <span class="m">125</span>                 23.94GB             14.65GB <span class="o">(</span>61%<span class="o">)</span>
</span><span class='line'>Containers          <span class="m">322</span>                 <span class="m">16</span>                  8.229GB             8.222GB <span class="o">(</span>99%<span class="o">)</span>
</span><span class='line'>Local Volumes       <span class="m">77</span>                  <span class="m">41</span>                  698MB               19.13MB <span class="o">(</span>2%<span class="o">)</span>
</span><span class='line'>Build Cache                                                 0B                  0B
</span></code></pre></td></tr></table></div></figure>


<h2>Removing Unsued Data:</h2>

<p>By using Prune, we can remove the unused resources that is consuming data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker system prune
</span><span class='line'>
</span><span class='line'>WARNING! This will remove:
</span><span class='line'>        - all stopped containers
</span><span class='line'>        - all networks not used by at least one container
</span><span class='line'>        - all dangling images
</span><span class='line'>        - all build cache
</span><span class='line'>Are you sure you want to <span class="k">continue</span>? <span class="o">[</span>y/N<span class="o">]</span> y
</span><span class='line'>
</span><span class='line'>Deleted Containers:
</span><span class='line'>a3d7db158e065d0c86160fd5d688875f8b7435848ea91db57ed007
</span><span class='line'>47890dcfea4a105f43e790dd8ad3c6d7c4ad7e738186c034d7a46b
</span><span class='line'>
</span><span class='line'>Deleted Networks:
</span><span class='line'>traefik-net
</span><span class='line'>app_appnet
</span><span class='line'>
</span><span class='line'>Deleted Images:
</span><span class='line'>deleted: sha256:5b9909c10e93afec
</span><span class='line'>deleted: sha256:d81eesdfihweo3rk
</span><span class='line'>
</span><span class='line'>Total reclaimed space: 14.18GB
</span></code></pre></td></tr></table></div></figure>


<p>For related <a href="https://goo.gl/L2NYxU">Docker</a> posts.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/05/31/ssh-tools-that-comes-in-handy-when-dealing-with-multiple-servers/">SSH Tools That Comes in Handy When Dealing With Multiple Servers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-05-31T05:18:11-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2018</span></span> <span class='time'>5:18 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://objects.ruanbekker.com/assets/images/header-ssh-tips.png" alt="" /></p>

<p>When dealing with a lot of servers where you need to ssh to different servers and especially if they require different authentication from different private ssh keys, it kinda gets annoying specifying the private key you need, when you want to SSH to them.</p>

<h2>SSH Config</h2>

<p>SSH Config: <code>~/.ssh/config</code> is powerful!</p>

<p>In this config file, you can specify the remote host, the key, user and the alias, so that when you want to SSH to it, you dont have to use the fully qualified domain name or IP address.</p>

<p>Let&rsquo;s take for example our server-a with the following details:</p>

<ul>
<li>FQDN: host1.eu.compute.domain.coom</li>
<li>User: james</li>
<li>PrivateKeyFile: /path/to/key.pem</li>
<li>Disable Strict Host Checking</li>
</ul>


<p>So to access that host, you would use the following command (without ssh config):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh -oStrictHostKeyChecking<span class="o">=</span>no -oUserKnownHostsFile<span class="o">=</span>/dev/null -i /path/to/key.pem james@host1.eu.compute.domain.com
</span></code></pre></td></tr></table></div></figure>


<p>Now with SSH Config, open up the config file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim ~/.ssh/config
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>and declare the host details:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Host host1
</span><span class='line'>  Hostname host1.eu.compute.domain.com
</span><span class='line'>  User james
</span><span class='line'>  IdentityFile /path/to/key.pem
</span><span class='line'>  StrictHostKeyChecking no
</span><span class='line'>  UserKnownHostsFile /dev/null
</span></code></pre></td></tr></table></div></figure>


<p>Now, if we need to SSH to it, we can do it as simply as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh host1
</span></code></pre></td></tr></table></div></figure>


<p>as it will pull in the configs from the config that is described from the host alias that you calling from the argument of the ssh binary.</p>

<h2>SSH Timeout</h2>

<p>Appending to our SSH Config, we can configure either our client or server to prevent SSH Timeouts due to inactivity.</p>

<ul>
<li>SSH Timeout on our Client:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim ~/.ssh/config
</span></code></pre></td></tr></table></div></figure>


<p>Here we can set how often a NULL Packet is sent to the SSH Connections to keep the connection alive, in this case every 120 seconds:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ServerAliveInterval 120
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>SSH Timeout on the Servers:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim /etc/ssh/sshd_config
</span></code></pre></td></tr></table></div></figure>


<p>Below we have 2 properties, the interval of how often to instruct the client connected to send a NULL packet to keep the connection alive and the max number of intervals, so for a idle connection to timeout in 24 hours, we will take 86400 seconds which is 24 hours, divide into 120 second intervals, which gives as 720 intervals.</p>

<p>So the config will look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ClientAliveInterval 120
</span><span class='line'>ClientAliveCountMax 720
</span></code></pre></td></tr></table></div></figure>


<p>The restart the sshd service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/etc/init.d/sshd restart
</span></code></pre></td></tr></table></div></figure>


<h2>SSH Agent</h2>

<p>Another handy tool is <code>ssh-agent</code>, if you have password encryption on your key, everytime you need to ssh, a password will be prompted. A way to get around this is to use the ssh-agent.</p>

<p>We also want to set a TTL to the ssh-agent, as we don&rsquo;t want it to run forever (unless you want it to). In this case I will let the ssh-agent exit after 2 hours. It will also only run in the shell session from where you execute it. Lets start up our ssh-agent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">eval</span> <span class="k">$(</span>ssh-agent -t 7200<span class="k">)</span>
</span><span class='line'>Agent pid <span class="m">88760</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now add the private key to the ssh-agent. If your private key is password protected, it will prompt you for the password and after successful verification the key will be added:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh-add /path/to/key.pem
</span><span class='line'>Identity added: /path/to/key.pem <span class="o">(</span>/path/to/key.pem<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Multiple Github Accounts:</h2>

<p>Here is a great post on how to work with different GitHub Accounts:
- <a href="https://gist.github.com/jexchan/2351996">https://gist.github.com/jexchan/2351996</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/05/28/wildcard-ssl-certificate-with-letsencrypt-on-docker-swarm-using-traefik/">Wildcard SSL Certificate With Letsencrypt on Docker Swarm Using Traefik</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-05-28T17:36:17-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>5:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53352817-2d211d80-392c-11e9-93f4-b3284f0b6c20.jpg" alt="" /></p>

<p>With Letsencrypt supporting Wildcard certificates is really awesome. Now, we can setup traefik to listen on 443, acting as a reverse proxy and is doing HTTPS Termination to our Applications thats running in our Swarm.</p>

<h2>Architectural Design:</h2>

<p>At the moment we have 3 Manager Nodes, and 5 Worker Nodes:</p>

<ul>
<li>Using a Dummy Domain example.com which is set to the 3 Public IP&rsquo;s of our Manager Nodes</li>
<li>DNS is set for: <code>example.com</code> A Record to: <code>52.10.1.10</code>, <code>52.10.1.11</code>, <code>52.10.1.12</code></li>
<li>DNS is set for: <code>*.example.com</code> CNAME to <code>example.com</code></li>
<li>Any application that is spawned into our Swarm, will be labeled with a <code>traefik.frontend.rule</code> which will be routed to the service and redirected from HTTP to HTTPS</li>
</ul>


<h2>Create the Overlay Network:</h2>

<p>Create the overlay network that will be used for our stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create --driver overlay appnet
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Compose Files for our Stacks:</h2>

<p>Create the Traefik Service Compose file, we will deploy it in Global Mode, constraint to our Manager Nodes, so that every manager node has a copy of traefik running.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; traefik-compose.yml <span class="s">&lt;&lt; EOF</span>
</span><span class='line'>
</span><span class='line'><span class="s">version: &quot;3.4&quot;</span>
</span><span class='line'><span class="s">services:</span>
</span><span class='line'><span class="s">  proxy:</span>
</span><span class='line'><span class="s">    image: traefik:latest</span>
</span><span class='line'><span class="s">    command:</span>
</span><span class='line'><span class="s">      - &quot;--api&quot;</span>
</span><span class='line'><span class="s">      - &quot;--entrypoints=Name:http Address::80 Redirect.EntryPoint:https&quot;</span>
</span><span class='line'><span class="s">      - &quot;--entrypoints=Name:https Address::443 TLS&quot;</span>
</span><span class='line'><span class="s">      - &quot;--defaultentrypoints=http,https&quot;</span>
</span><span class='line'><span class="s">      - &quot;--acme&quot;</span>
</span><span class='line'><span class="s">      - &quot;--acme.storage=/etc/traefik/acme/acme.json&quot;</span>
</span><span class='line'><span class="s">      - &quot;--acme.entryPoint=https&quot;</span>
</span><span class='line'><span class="s">      - &quot;--acme.httpChallenge.entryPoint=http&quot;</span>
</span><span class='line'><span class="s">      - &quot;--acme.onHostRule=true&quot;</span>
</span><span class='line'><span class="s">      - &quot;--acme.onDemand=false&quot;</span>
</span><span class='line'><span class="s">      - &quot;--acme.email=me@example.com&quot;</span>
</span><span class='line'><span class="s">      - &quot;--docker&quot;</span>
</span><span class='line'><span class="s">      - &quot;--docker.swarmMode&quot;</span>
</span><span class='line'><span class="s">      - &quot;--docker.domain=example.com&quot;</span>
</span><span class='line'><span class="s">      - &quot;--docker.watch&quot;</span>
</span><span class='line'><span class="s">    volumes:</span>
</span><span class='line'><span class="s">      - /var/run/docker.sock:/var/run/docker.sock</span>
</span><span class='line'><span class="s">      - /mnt/traefik/acme.json:/etc/traefik/acme/acme.json</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'><span class="s">    ports:</span>
</span><span class='line'><span class="s">      - target: 80</span>
</span><span class='line'><span class="s">        published: 80</span>
</span><span class='line'><span class="s">        mode: host</span>
</span><span class='line'><span class="s">      - target: 443</span>
</span><span class='line'><span class="s">        published: 443</span>
</span><span class='line'><span class="s">        mode: host</span>
</span><span class='line'><span class="s">      - target: 8080</span>
</span><span class='line'><span class="s">        published: 8080</span>
</span><span class='line'><span class="s">        mode: host</span>
</span><span class='line'><span class="s">    deploy:</span>
</span><span class='line'><span class="s">      mode: global</span>
</span><span class='line'><span class="s">      placement:</span>
</span><span class='line'><span class="s">        constraints:</span>
</span><span class='line'><span class="s">          - node.role == manager</span>
</span><span class='line'><span class="s">      update_config:</span>
</span><span class='line'><span class="s">        parallelism: 1</span>
</span><span class='line'><span class="s">        delay: 10s</span>
</span><span class='line'><span class="s">      restart_policy:</span>
</span><span class='line'><span class="s">        condition: on-failure</span>
</span><span class='line'><span class="s">networks:</span>
</span><span class='line'><span class="s">  appnet:</span>
</span><span class='line'><span class="s">    external: true</span>
</span><span class='line'>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the Application Compose file, in this example we will be deploying a Ghost Blog:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; ghost-compose.yml <span class="s">&lt;&lt; EOF</span>
</span><span class='line'>
</span><span class='line'><span class="s">version: &#39;3.4&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="s">services:</span>
</span><span class='line'><span class="s">  blog:</span>
</span><span class='line'><span class="s">    image: ghost:1.22.7-alpine</span>
</span><span class='line'><span class="s">    networks:</span>
</span><span class='line'><span class="s">      - appnet</span>
</span><span class='line'><span class="s">    deploy:</span>
</span><span class='line'><span class="s">      mode: replicated</span>
</span><span class='line'><span class="s">      replicas: 1</span>
</span><span class='line'><span class="s">      placement:</span>
</span><span class='line'><span class="s">        constraints: </span>
</span><span class='line'><span class="s">          - node.role == worker</span>
</span><span class='line'><span class="s">      labels:</span>
</span><span class='line'><span class="s">        - &quot;traefik.backend.loadbalancer.sticky=false&quot;</span>
</span><span class='line'><span class="s">        - &quot;traefik.backend.loadbalancer.swarm=true&quot;</span>
</span><span class='line'><span class="s">        - &quot;traefik.backend=blog-1&quot;</span>
</span><span class='line'><span class="s">        - &quot;traefik.docker.network=appnet&quot;</span>
</span><span class='line'><span class="s">        - &quot;traefik.entrypoints=https&quot;</span>
</span><span class='line'><span class="s">        - &quot;traefik.frontend.passHostHeader=true&quot;</span>
</span><span class='line'><span class="s">        - &quot;traefik.frontend.rule=Host:blog.example.com&quot;</span>
</span><span class='line'><span class="s">        - &quot;traefik.port=2368&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">networks:</span>
</span><span class='line'><span class="s">  appnet:</span>
</span><span class='line'><span class="s">    external: true</span>
</span><span class='line'>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Prepare the Path for Traefik:</h2>

<p>We have a <a href="https://sysadmins.co.za/tag/glusterfs/">replicated volume</a> under our <code>/mnt</code> partition, so that all our managers can read from that path, create the file and provide the sufficient permissions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /mnt/traefik
</span><span class='line'><span class="nv">$ </span>touch /mnt/traefik/acme.json
</span><span class='line'><span class="nv">$ </span>chmod <span class="m">600</span> /mnt/traefik/acme.json
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy the Stacks:</h2>

<p>Deploy the Traefik Stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c traefik-compose.yml traefik
</span></code></pre></td></tr></table></div></figure>


<p>Wait until the services are deployed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack services traefik
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
</span><span class='line'>f8ru5gbcgd2v        traefik_proxy       global              3/3                 traefik:latest
</span></code></pre></td></tr></table></div></figure>


<p>Deploy the Application Stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c ghost-compose.yml apps
</span></code></pre></td></tr></table></div></figure>


<p>Verify that the Application Stack has been deployed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack services apps
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE                          PORTS
</span><span class='line'>516zlfs2cfdv        apps_blog           replicated          1/1                 ghost:1.22.7-alpine
</span></code></pre></td></tr></table></div></figure>


<p>At the moment we will have 2 stacks in our Swarm:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack ls
</span><span class='line'>NAME                SERVICES
</span><span class='line'>apps                1
</span><span class='line'>traefik             1
</span></code></pre></td></tr></table></div></figure>


<h2>Test the Application:</h2>

<p>Let&rsquo;s test our blog to see if we get redirected to <a href="HTTPS:">HTTPS:</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -iL http://blog.example.com
</span><span class='line'>HTTP/1.1 <span class="m">302</span> Found
</span><span class='line'>Location: https://blog.example.com:443/
</span><span class='line'>Date: Mon, <span class="m">28</span> May <span class="m">2018</span> 22:02:41 GMT
</span><span class='line'>Content-Length: 5
</span><span class='line'>Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span><span class='line'>
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Cache-Control: public, max-age<span class="o">=</span>0
</span><span class='line'>Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span><span class='line'>Date: Mon, <span class="m">28</span> May <span class="m">2018</span> 22:02:42 GMT
</span><span class='line'>Etag: W/<span class="s2">&quot;4166-J2ooSIa8gtTkYjbnr7vnPUFlRJI&quot;</span>
</span><span class='line'>Vary: Accept-Encoding
</span><span class='line'>X-Powered-By: Express
</span><span class='line'>Transfer-Encoding: chunked
</span></code></pre></td></tr></table></div></figure>


<p>Works like a charm! Traefik FTW!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/13">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/11">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/05/10/running-a-ha-mysql-galera-cluster-on-docker-swarm/">Running a HA MySQL Galera Cluster on Docker Swarm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/05/07/create-secrets-with-vaults-transits-secret-engine/">Create Secrets With Vaults Transits Secret Engine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/05/07/use-the-vault-api-to-provision-app-keys-and-create-kv-pairs/">Use the Vault API to Provision App Keys and Create KV Pairs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/05/07/persist-vault-data-with-amazon-s3-as-a-storage-backend/">Persist Vault Data With Amazon S3 as a Storage Backend</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">Setup Prometheus and Node Exporter on Ubuntu for Epic Monitoring</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>

</body>
</html>
