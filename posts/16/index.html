
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="With automation in mind, when you want to execute docker commands remotely, you want to do it in a secure manner, as you don&rsquo;t want to expose &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="http://blog.ruanbekker.com/posts/16/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.ruan.dev/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/30/forwarding-the-docker-socket-via-a-ssh-tunnel-to-execute-docker-commands-locally/">Forwarding the Docker Socket via a SSH Tunnel to Execute Docker Commands Locally</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-30T14:30:23+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>2:30 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>With automation in mind, when you want to execute docker commands remotely, you want to do it in a secure manner, as you don&rsquo;t want to expose your Docker port to the whole world.</p>

<p>One way in doing that, is forwarding the remote docker socket via a local port over a SSH Tunnel. With this way, you can execute docker commands locally on your workstation, as if the swarm is running on your workstation/laptop/node/bastion host etc.</p>

<p>Without the tunnel, I have a swarm on my laptop with no running services:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ls
</span><span class='line'>ID                  NAME                   MODE                REPLICAS            IMAGE                                                               PORTS
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, we have no services running, but the remote swarm has a couple, so after forwarding the connection, we should see our remote services.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>Setting up the SSH Tunnel:</h2>

<p>Here we will forward the remote docker socket: <code>/var/run/docker.sock</code> to a local port bound to localhost: <code>localhost:2377</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>screen -S docker
</span><span class='line'><span class="nv">$ </span>ssh -oStrictHostKeyChecking<span class="o">=</span>no -oUserKnownHostsFile<span class="o">=</span>/dev/null -i ~/path/to/key.pem -NL localhost:2377:/var/run/docker.sock root@docker-managers.mydomain.com
</span></code></pre></td></tr></table></div></figure>


<p>Now the SSH Tunnel will be established, and you can detach your screen session, or open a new shell session. To detach your screen session: <code>'ctrl + a' then d</code></p>

<h2>Verifying that the tunnel is established:</h2>

<p>You can use netstat to verify that the port is listening:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -ant <span class="p">|</span> grep 2377
</span><span class='line'>tcp4       <span class="m">0</span>      <span class="m">0</span>  127.0.0.1.2377         *.*                    LISTEN
</span></code></pre></td></tr></table></div></figure>


<h2>Inform the Docker Client to use the Port:</h2>

<p>Now we need to inform the docker client, to use the new port to talk to the docker daemon. We do that by setting the <code>DOCKER_HOST</code> environment variable to point to <code>localhost:2377</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">DOCKER_HOST</span><span class="o">=</span><span class="s2">&quot;localhost:2377&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will remain for the lifetime of the shell session.</p>

<h2>Testing it Out:</h2>

<p>Now we can run our commands locally, and we should see the output of our remote swarm:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ls
</span><span class='line'>ID                  NAME                   MODE                REPLICAS            IMAGE                                                               PORTS
</span><span class='line'>xjta8e3ek2u2        apps_flask_reminders   replicated          3/3                 rbekker87/flask-reminders:debian
</span><span class='line'>0l7ruktbqj99        apps_kibana            replicated          1/1                 kibana:latest
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<h2>Terminating our SSH Tunnel:</h2>

<p>To terminate our SSH Tunnel, reconnect to your shell session, and hit <code>ctrl + c</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>screen -ls
</span><span class='line'>There is a screen on:
</span><span class='line'>  50413.docker    <span class="o">(</span>Detached<span class="o">)</span>
</span><span class='line'><span class="nv">$ </span>screen -r 50413
</span></code></pre></td></tr></table></div></figure>


<p>Hit <code>ctrl + c</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>CKilled by signal 2.
</span></code></pre></td></tr></table></div></figure>


<p>And exit the screen session:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this way, you can do lots of automation with docker swarm, not limited to swarm, but one of them.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/30/encryption-and-decryption-with-the-pycrypto-module-using-the-aes-cipher-in-python/">Encryption and Decryption With the PyCrypto Module Using the AES Cipher in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-30T07:43:26+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>7:43 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/0MaLsx.jpg" alt="" /></p>

<p>While I&rsquo;m learning a lot about encryption at the moment, I wanted to test out encryption with the PyCrypto module in Python using the <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">Advanced Encryption Standard (AES)</a> Symmetric Block Cipher.</p>

<h2>Installing PyCrypto:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install pycrypto --user
</span></code></pre></td></tr></table></div></figure>


<h2>PyCrypto Example:</h2>

<p>Our AES Key needs to be either 16, 24 or 32 bytes long and our Initialization Vector needs to be 16 Bytes long. That will be generated using the random and string modules.</p>

<p>Encrypting:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">base64</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">iv</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="s">&#39;BLhgpCL81fdLBk23HkZp8BgbT913cqt0&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">iv</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iv</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="s">&#39;OWFJATh1Zowac2xr&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">enc_s</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CFB</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">cipher_text</span> <span class="o">=</span> <span class="n">enc_s</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s">&#39;this is a super important message&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">encoded_cipher_text</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">cipher_text</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">encoded_cipher_text</span><span class="p">)</span>
</span><span class='line'><span class="s">&#39;AtBa6zVB0UQ3U/50ogOb6g09FlyPdpmJB7UzoCqxhsQ6&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Decrypting:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">base64</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;BLhgpCL81fdLBk23HkZp8BgbT913cqt0&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">iv</span> <span class="o">=</span> <span class="s">&#39;OWFJATh1Zowac2xr&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">decryption_suite</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CFB</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">plain_text</span> <span class="o">=</span> <span class="n">decryption_suite</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encoded_cipher_text</span><span class="p">))</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">plain_text</span><span class="p">)</span>
</span><span class='line'><span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="nb">super</span> <span class="n">important</span> <span class="n">message</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s not needed to use base64, but to have the ability to stay away from strange characters I decided to encode them with base64 :D</p>

<h2>References:</h2>

<ul>
<li><a href="http://docs.python-guide.org/en/latest/scenarios/crypto/">PyCrypto</a></li>
<li><a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">Wiki - AES</a></li>
<li><a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Cipher_Feedback_(CFB">Wiki - CFB Mode</a>)</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/29/running-a-3-node-elasticsearch-cluster-with-docker-compose-on-your-laptop-for-testing/">Running a 3 Node Elasticsearch Cluster With Docker Compose on Your Laptop for Testing</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-29T19:43:35+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>7:43 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Having a Elasticsearch cluster on your laptop with Docker for testing is great. And in this post I will show you how quick and easy it is, to have a 3 node elasticsearch cluster running on docker for testing.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>Pre-Requisites</h2>

<p>We need to set the <code>vm.max_map_count</code> kernel parameter:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo sysctl -w vm.max_map_count<span class="o">=</span>262144
</span></code></pre></td></tr></table></div></figure>


<p>To set this permanently, add it to <code>/etc/sysctl.conf</code> and reload with <code>sudo sysctl -p</code></p>

<h2>Docker Compose:</h2>

<p>The docker compose file that we will reference:</p>

<script src="https://gist.github.com/ruanbekker/410538a0e38c3df5c3ba76e7171f2eda.js"></script>


<p>The data of our elasticsearch container volumes will reside under /var/lib/docker, if you want them to persist in another location, you can use the <code>driver_opts</code> setting for the local volume driver.</p>

<h2>Deploy</h2>

<p>Deploy your elasticsearch cluster with docker compose:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-compose up
</span></code></pre></td></tr></table></div></figure>


<p>This will run in the foreground, and you should see console output.</p>

<h2>Testing Elasticsearch</h2>

<p>Let&rsquo;s run a couple of queries, first up, check the cluster health api:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://127.0.0.1:9200/_cluster/health?pretty
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;cluster_name&quot;</span> : <span class="s2">&quot;docker-cluster&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;status&quot;</span> : <span class="s2">&quot;green&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;timed_out&quot;</span> : <span class="nb">false</span>,
</span><span class='line'>  <span class="s2">&quot;number_of_nodes&quot;</span> : 3,
</span><span class='line'>  <span class="s2">&quot;number_of_data_nodes&quot;</span> : 3,
</span><span class='line'>  <span class="s2">&quot;active_primary_shards&quot;</span> : 1,
</span><span class='line'>  <span class="s2">&quot;active_shards&quot;</span> : 2,
</span><span class='line'>  <span class="s2">&quot;relocating_shards&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;initializing_shards&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;unassigned_shards&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;delayed_unassigned_shards&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;number_of_pending_tasks&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;number_of_in_flight_fetch&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;task_max_waiting_in_queue_millis&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;active_shards_percent_as_number&quot;</span> : 100.0
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create a index with replication count of 2:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -XPUT http://127.0.0.1:9200/test -d <span class="s1">&#39;{&quot;number_of_replicas&quot;: 2}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ingest a document to elasticsearch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -XPUT http://127.0.0.1:9200/test/docs/1 -d <span class="s1">&#39;{&quot;name&quot;: &quot;ruan&quot;}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;_index&quot;</span>:<span class="s2">&quot;test&quot;</span>,<span class="s2">&quot;_type&quot;</span>:<span class="s2">&quot;docs&quot;</span>,<span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;1&quot;</span>,<span class="s2">&quot;_version&quot;</span>:1,<span class="s2">&quot;result&quot;</span>:<span class="s2">&quot;created&quot;</span>,<span class="s2">&quot;_shards&quot;</span>:<span class="o">{</span><span class="s2">&quot;total&quot;</span>:3,<span class="s2">&quot;successful&quot;</span>:3,<span class="s2">&quot;failed&quot;</span>:0<span class="o">}</span>,<span class="s2">&quot;_seq_no&quot;</span>:0,<span class="s2">&quot;_primary_term&quot;</span>:1<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>View the indices:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://127.0.0.1:9200/_cat/indices?v
</span><span class='line'>health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   <span class="nb">test                        </span>w4p2Q3fTR4uMSYBfpNVPqw   <span class="m">5</span>   <span class="m">2</span>          <span class="m">1</span>            <span class="m">0</span>      3.3kb          1.1kb
</span><span class='line'>green  open   .monitoring-es-6-2018.04.29 W69lql-rSbORVfHZrj4vug   <span class="m">1</span>   <span class="m">1</span>       <span class="m">1601</span>           <span class="m">38</span>        4mb            2mb
</span></code></pre></td></tr></table></div></figure>


<h2>Kibana</h2>

<p>Kibana is also included in the stack and is accessible via <a href="http://localhost:5601/">http://localhost:5601/</a> and you it should look more or less like:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/kibana-local-home.png" alt="" /></p>

<h2>Elasticsearch Head UI</h2>

<p>I always prefer working directly with the RESTFul API, but if you would like to use a UI to interact with Elasticsearch, you can access it via <a href="http://localhost:9100/">http://localhost:9100/</a> and should look like this:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/elasticsearch-head-ui.png" alt="" /></p>

<h2>Deleting the Cluster:</h2>

<p>As its running in the foreground, you can just hit ctrl + c and as we persisted data in our compose, when you spin up the cluster again, the data will still be there.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html</a></li>
</ul>


<p>Update (2019.06) - I am preparing a full elasticsearch course available on <a href="https://github.com/ruanbekker/elasticsearch-demo">https://github.com/ruanbekker/elasticsearch-demo</a> and a <a href="https://gist.github.com/ruanbekker/e8a09604b14f37e8d2f743a87b930f93">Elasticsearch Cheetsheat</a>, feel free to check it out.</p>

<center>
        <script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Buy Me a Coffee', '#46b798', 'A6423ZIQ');kofiwidget2.draw();</script>
</center>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/29/using-the-bulk-api-with-elasticsearch/">Using the Bulk API With Elasticsearch</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-29T19:32:21+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>7:32 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This tutorial will guide you how to use the Bulk API with Elasticsearch, this is great for when having a dataset that contains a lot of documents, where you want to insert them into elasticsearch in bulk uploads.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>The Dataset</h2>

<p>We will be using a dataset from elastic that contains 1000 documents that holds account data.</p>

<p>Getting the Dataset:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget -O accounts.json https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json?raw<span class="o">=</span><span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Preview the data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>head -10  accounts.json
</span><span class='line'><span class="o">{</span><span class="s2">&quot;index&quot;</span>:<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;1&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;account_number&quot;</span>:1,<span class="s2">&quot;balance&quot;</span>:39225,<span class="s2">&quot;firstname&quot;</span>:<span class="s2">&quot;Amber&quot;</span>,<span class="s2">&quot;lastname&quot;</span>:<span class="s2">&quot;Duke&quot;</span>,<span class="s2">&quot;age&quot;</span>:32,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;M&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;880 Holmes Lane&quot;</span>,<span class="s2">&quot;employer&quot;</span>:<span class="s2">&quot;Pyrami&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;amberduke@pyrami.com&quot;</span>,<span class="s2">&quot;city&quot;</span>:<span class="s2">&quot;Brogan&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;IL&quot;</span><span class="o">}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;index&quot;</span>:<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;6&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;account_number&quot;</span>:6,<span class="s2">&quot;balance&quot;</span>:5686,<span class="s2">&quot;firstname&quot;</span>:<span class="s2">&quot;Hattie&quot;</span>,<span class="s2">&quot;lastname&quot;</span>:<span class="s2">&quot;Bond&quot;</span>,<span class="s2">&quot;age&quot;</span>:36,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;M&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;671 Bristol Street&quot;</span>,<span class="s2">&quot;employer&quot;</span>:<span class="s2">&quot;Netagy&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;hattiebond@netagy.com&quot;</span>,<span class="s2">&quot;city&quot;</span>:<span class="s2">&quot;Dante&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;TN&quot;</span><span class="o">}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;index&quot;</span>:<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;13&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;account_number&quot;</span>:13,<span class="s2">&quot;balance&quot;</span>:32838,<span class="s2">&quot;firstname&quot;</span>:<span class="s2">&quot;Nanette&quot;</span>,<span class="s2">&quot;lastname&quot;</span>:<span class="s2">&quot;Bates&quot;</span>,<span class="s2">&quot;age&quot;</span>:28,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;F&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;789 Madison Street&quot;</span>,<span class="s2">&quot;employer&quot;</span>:<span class="s2">&quot;Quility&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;nanettebates@quility.com&quot;</span>,<span class="s2">&quot;city&quot;</span>:<span class="s2">&quot;Nogal&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;VA&quot;</span><span class="o">}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;index&quot;</span>:<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;18&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;account_number&quot;</span>:18,<span class="s2">&quot;balance&quot;</span>:4180,<span class="s2">&quot;firstname&quot;</span>:<span class="s2">&quot;Dale&quot;</span>,<span class="s2">&quot;lastname&quot;</span>:<span class="s2">&quot;Adams&quot;</span>,<span class="s2">&quot;age&quot;</span>:33,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;M&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;467 Hutchinson Court&quot;</span>,<span class="s2">&quot;employer&quot;</span>:<span class="s2">&quot;Boink&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;daleadams@boink.com&quot;</span>,<span class="s2">&quot;city&quot;</span>:<span class="s2">&quot;Orick&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;MD&quot;</span><span class="o">}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;index&quot;</span>:<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;20&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;account_number&quot;</span>:20,<span class="s2">&quot;balance&quot;</span>:16418,<span class="s2">&quot;firstname&quot;</span>:<span class="s2">&quot;Elinor&quot;</span>,<span class="s2">&quot;lastname&quot;</span>:<span class="s2">&quot;Ratliff&quot;</span>,<span class="s2">&quot;age&quot;</span>:36,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;M&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;282 Kings Place&quot;</span>,<span class="s2">&quot;employer&quot;</span>:<span class="s2">&quot;Scentric&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;elinorratliff@scentric.com&quot;</span>,<span class="s2">&quot;city&quot;</span>:<span class="s2">&quot;Ribera&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;WA&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Using the Bulk API:</h2>

<p>We will ingest the data to our <code>bank_accounts</code> index, and to the <code>account</code> type:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -XPOST localhost:9200/accounts/docs/_bulk --data-binary <span class="s2">&quot;@accounts.json&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>When it&rsquo;s done, have a look at the indices:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://127.0.0.1:9200/_cat/indices/bank_accounts?v
</span><span class='line'>health status index         uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   bank_accounts BK_OJYOFTD67tqsQBUWSuQ   <span class="m">5</span>   <span class="m">1</span>       <span class="m">1000</span>            <span class="m">0</span>    950.3kb        475.1kb
</span></code></pre></td></tr></table></div></figure>


<p>Doing a search and display one document:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET <span class="s1">&#39;http://127.0.0.1:9200/bank_accounts/_search?pretty&amp;size=1&#39;</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;took&quot;</span> : 3,
</span><span class='line'>  <span class="s2">&quot;timed_out&quot;</span> : <span class="nb">false</span>,
</span><span class='line'>  <span class="s2">&quot;_shards&quot;</span> : <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;total&quot;</span> : 5,
</span><span class='line'>    <span class="s2">&quot;successful&quot;</span> : 5,
</span><span class='line'>    <span class="s2">&quot;skipped&quot;</span> : 0,
</span><span class='line'>    <span class="s2">&quot;failed&quot;</span> : 0
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="s2">&quot;hits&quot;</span> : <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;total&quot;</span> : 1000,
</span><span class='line'>    <span class="s2">&quot;max_score&quot;</span> : 1.0,
</span><span class='line'>    <span class="s2">&quot;hits&quot;</span> : <span class="o">[</span>
</span><span class='line'>      <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;_index&quot;</span> : <span class="s2">&quot;bank_accounts&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;_type&quot;</span> : <span class="s2">&quot;account&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;25&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;_score&quot;</span> : 1.0,
</span><span class='line'>        <span class="s2">&quot;_source&quot;</span> : <span class="o">{</span>
</span><span class='line'>          <span class="s2">&quot;account_number&quot;</span> : 25,
</span><span class='line'>          <span class="s2">&quot;balance&quot;</span> : 40540,
</span><span class='line'>          <span class="s2">&quot;firstname&quot;</span> : <span class="s2">&quot;Virginia&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;lastname&quot;</span> : <span class="s2">&quot;Ayala&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;age&quot;</span> : 39,
</span><span class='line'>          <span class="s2">&quot;gender&quot;</span> : <span class="s2">&quot;F&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;address&quot;</span> : <span class="s2">&quot;171 Putnam Avenue&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;employer&quot;</span> : <span class="s2">&quot;Filodyne&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;email&quot;</span> : <span class="s2">&quot;virginiaayala@filodyne.com&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;city&quot;</span> : <span class="s2">&quot;Nicholson&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;state&quot;</span> : <span class="s2">&quot;PA&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Demo Recording:</h2>

<p>This has also been reccored, which can be viewed here:</p>

<ul>
<li><a href="https://asciinema.org/a/BYmZQ0pBiyI8ogVF9t0smczRu">https://asciinema.org/a/BYmZQ0pBiyI8ogVF9t0smczRu</a></li>
</ul>


<h2>Using Bulk with Auto Generated ID&rsquo;s</h2>

<p>As you might know when you do a POST request to the type, the <code>_id</code> field gets auto populated. Timo, one of my friends had the requirement to use the Bulk API to post auto generated Id&rsquo;s and not the static id&rsquo;s that is given in the example dataset.</p>

<p>I have answered this on Elastic&rsquo;s discuss page: <a href="https://discuss.elastic.co/t/looking-for-working-example-data-set-to-bulk-index-into-es6/128678/3">https://discuss.elastic.co/t/looking-for-working-example-data-set-to-bulk-index-into-es6/128678/3</a></p>

<p>I will provide the steps below as well:</p>

<figure class='code'><figcaption><span>convert.py </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/env python</span>
</span><span class='line'>
</span><span class='line'><span class="n">src_file</span> <span class="o">=</span> <span class="s">&#39;src_file.json&#39;</span>
</span><span class='line'><span class="n">dest_file</span> <span class="o">=</span> <span class="s">&#39;dest_file.json&#39;</span>
</span><span class='line'><span class="n">metadata</span> <span class="o">=</span> <span class="s">&#39;{&quot;index&quot;: {&quot;_index&quot;: &quot;bank_accounts&quot;, &quot;_type&quot;: &quot;account&quot;}}&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">open_file</span><span class="p">:</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">=</span> <span class="n">open_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">each_line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span><span class='line'>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">metadata</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">each_line</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The original file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>head -4 file.json
</span><span class='line'><span class="o">{</span><span class="s2">&quot;index&quot;</span>:<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;1&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;account_number&quot;</span>:1,<span class="s2">&quot;balance&quot;</span>:39225,<span class="s2">&quot;firstname&quot;</span>:<span class="s2">&quot;Amber&quot;</span>,<span class="s2">&quot;lastname&quot;</span>:<span class="s2">&quot;Duke&quot;</span>,<span class="s2">&quot;age&quot;</span>:32,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;M&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;880 Holmes Lane&quot;</span>,<span class="s2">&quot;employer&quot;</span>:<span class="s2">&quot;Pyrami&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;amberduke@pyrami.com&quot;</span>,<span class="s2">&quot;city&quot;</span>:<span class="s2">&quot;Brogan&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;IL&quot;</span><span class="o">}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;index&quot;</span>:<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;6&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;account_number&quot;</span>:6,<span class="s2">&quot;balance&quot;</span>:5686,<span class="s2">&quot;firstname&quot;</span>:<span class="s2">&quot;Hattie&quot;</span>,<span class="s2">&quot;lastname&quot;</span>:<span class="s2">&quot;Bond&quot;</span>,<span class="s2">&quot;age&quot;</span>:36,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;M&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;671 Bristol Street&quot;</span>,<span class="s2">&quot;employer&quot;</span>:<span class="s2">&quot;Netagy&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;hattiebond@netagy.com&quot;</span>,<span class="s2">&quot;city&quot;</span>:<span class="s2">&quot;Dante&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;TN&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Removing the initial metadata:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat file.json <span class="p">|</span> grep account_number &gt;&gt; src_file.json
</span><span class='line'><span class="nv">$ </span>./convert.py
</span></code></pre></td></tr></table></div></figure>


<p>Previewing the destination file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>head -4 dest_file.json
</span><span class='line'><span class="o">{</span><span class="s2">&quot;index&quot;</span>: <span class="o">{</span><span class="s2">&quot;_index&quot;</span>: <span class="s2">&quot;bank_accounts&quot;</span>, <span class="s2">&quot;_type&quot;</span>: <span class="s2">&quot;account&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;account_number&quot;</span>:1,<span class="s2">&quot;balance&quot;</span>:39225,<span class="s2">&quot;firstname&quot;</span>:<span class="s2">&quot;Amber&quot;</span>,<span class="s2">&quot;lastname&quot;</span>:<span class="s2">&quot;Duke&quot;</span>,<span class="s2">&quot;age&quot;</span>:32,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;M&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;880HolmesLane&quot;</span>,<span class="s2">&quot;employer&quot;</span>:<span class="s2">&quot;Pyrami&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;amberduke@pyrami.com&quot;</span>,<span class="s2">&quot;city&quot;</span>:<span class="s2">&quot;Brogan&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;IL&quot;</span><span class="o">}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;index&quot;</span>: <span class="o">{</span><span class="s2">&quot;_index&quot;</span>: <span class="s2">&quot;bank_accounts&quot;</span>, <span class="s2">&quot;_type&quot;</span>: <span class="s2">&quot;account&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;account_number&quot;</span>:6,<span class="s2">&quot;balance&quot;</span>:5686,<span class="s2">&quot;firstname&quot;</span>:<span class="s2">&quot;Hattie&quot;</span>,<span class="s2">&quot;lastname&quot;</span>:<span class="s2">&quot;Bond&quot;</span>,<span class="s2">&quot;age&quot;</span>:36,<span class="s2">&quot;gender&quot;</span>:<span class="s2">&quot;M&quot;</span>,<span class="s2">&quot;address&quot;</span>:<span class="s2">&quot;671BristolStreet&quot;</span>,<span class="s2">&quot;employer&quot;</span>:<span class="s2">&quot;Netagy&quot;</span>,<span class="s2">&quot;email&quot;</span>:<span class="s2">&quot;hattiebond@netagy.com&quot;</span>,<span class="s2">&quot;city&quot;</span>:<span class="s2">&quot;Dante&quot;</span>,<span class="s2">&quot;state&quot;</span>:<span class="s2">&quot;TN&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking at my current indices:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://localhost:9200/_cat/indices?v
</span><span class='line'>health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   .monitoring-es-6-2018.05.06 3OgdIbDWQWCR8WJlQTXr9Q   <span class="m">1</span>   <span class="m">1</span>     <span class="m">114715</span>            <span class="m">6</span>      104mb           50mb
</span></code></pre></td></tr></table></div></figure>


<p>Ingesting the data via Bulk API:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -XPOST localhost:9200/_bulk --data-binary @dest_file.json
</span></code></pre></td></tr></table></div></figure>


<p>Looking at my indices to verify that the index exist:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://localhost:9200/_cat/indices?v
</span><span class='line'>health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   bank_accounts               u37MQvzhSPe97BJzp1u49Q   <span class="m">5</span>   <span class="m">1</span>       <span class="m">1000</span>            <span class="m">0</span>    296.4kb           690b
</span><span class='line'>green  open   .monitoring-es-6-2018.05.06 3OgdIbDWQWCR8WJlQTXr9Q   <span class="m">1</span>   <span class="m">1</span>     <span class="m">114750</span>            <span class="m">6</span>    103.9mb         49.9mb
</span></code></pre></td></tr></table></div></figure>


<p>Looking at one document: :smiley:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl <span class="s1">&#39;http://localhost:9200/bank_accounts/_search?pretty&amp;size=1&#39;</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;took&quot;</span> : 641,
</span><span class='line'>  <span class="s2">&quot;timed_out&quot;</span> : <span class="nb">false</span>,
</span><span class='line'>  <span class="s2">&quot;_shards&quot;</span> : <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;total&quot;</span> : 5,
</span><span class='line'>    <span class="s2">&quot;successful&quot;</span> : 5,
</span><span class='line'>    <span class="s2">&quot;skipped&quot;</span> : 0,
</span><span class='line'>    <span class="s2">&quot;failed&quot;</span> : 0
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="s2">&quot;hits&quot;</span> : <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;total&quot;</span> : 1000,
</span><span class='line'>    <span class="s2">&quot;max_score&quot;</span> : 1.0,
</span><span class='line'>    <span class="s2">&quot;hits&quot;</span> : <span class="o">[</span>
</span><span class='line'>      <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;_index&quot;</span> : <span class="s2">&quot;bank_accounts&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;_type&quot;</span> : <span class="s2">&quot;account&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;cohJN2MBCa89A-FEmiJs&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;_score&quot;</span> : 1.0,
</span><span class='line'>        <span class="s2">&quot;_source&quot;</span> : <span class="o">{</span>
</span><span class='line'>          <span class="s2">&quot;account_number&quot;</span> : 6,
</span><span class='line'>          <span class="s2">&quot;balance&quot;</span> : 5686,
</span><span class='line'>          <span class="s2">&quot;firstname&quot;</span> : <span class="s2">&quot;Hattie&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;lastname&quot;</span> : <span class="s2">&quot;Bond&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;age&quot;</span> : 36,
</span><span class='line'>          <span class="s2">&quot;gender&quot;</span> : <span class="s2">&quot;M&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;address&quot;</span> : <span class="s2">&quot;671BristolStreet&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;employer&quot;</span> : <span class="s2">&quot;Netagy&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;email&quot;</span> : <span class="s2">&quot;hattiebond@netagy.com&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;city&quot;</span> : <span class="s2">&quot;Dante&quot;</span>,
</span><span class='line'>          <span class="s2">&quot;state&quot;</span> : <span class="s2">&quot;TN&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/29/encryption-and-decryption-with-simple-crypt-using-python/">Encryption and Decryption With Simple Crypt Using Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-29T16:50:46+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>4:50 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I wanted to encrypt sensitive information to not expose passwords, hostnames etc. I wanted to have a way to encrypt my strings with a master password and stumbled upon Simple Crypt.</p>

<p><a href="https://bekkerclothing.com/collections/developer?utm_source=blog.ruanbekker.com&utm_medium=blog&utm_campaign=leaderboard_ad" target="_blank"><img alt="bekker-clothing-developer-tshirts" src="https://user-images.githubusercontent.com/567298/70170981-7c278a80-16d6-11ea-9759-6621d02c1423.png"></a></p>

<h2>Simple Crypt</h2>

<p>Why simple-crypt? Referenced from their <a href="https://pypi.org/project/simple-crypt/">docs</a>:</p>

<ul>
<li>Simple Crypt uses standard, well-known algorithms following the recommendations from <a href="http://www.daemonology.net/blog/2009-06-11-cryptographic-right-answers.html">this</a> link.</li>
<li>The PyCrypto library provides the algorithm implementation, where AES256 cipher is used.</li>
<li>It includes a check (an HMAC with SHA256) to warn when ciphertext data are modified.</li>
<li>It tries to make things as secure as possible when poor quality passwords are used (PBKDF2 with SHA256, a 256 bit random salt, and 100,000 rounds).</li>
<li>Using a library, rather than writing your own code, means that we have less solutions to the same problem.</li>
</ul>


<h2>Installing Simple-Crypt:</h2>

<p>From a base alpine image:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apk update
</span><span class='line'><span class="nv">$ </span>apk add python python-dev py2-pip
</span><span class='line'><span class="nv">$ </span>apk add gcc g++ make libffi-dev openssl-dev
</span><span class='line'><span class="nv">$ </span>pip install simple-crypt
</span></code></pre></td></tr></table></div></figure>


<h2>Simple Examples:</h2>

<p>Two simple examples to encrypt and decrypt data with simple-crypt. We will use a password <code>sekret</code> and we will encrypt the string: <code>this is a secure message</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">simplecrypt</span> <span class="kn">import</span> <span class="n">encrypt</span><span class="p">,</span> <span class="n">decrypt</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">password</span> <span class="o">=</span> <span class="s">&#39;sekret&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;this is a secret message&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">)</span>
</span><span class='line'><span class="n">sc</span><span class="c">#$%^&amp;*(..........</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have our encrypted string, lets decrypt it. First we will use the wrong password, so that you will see how the expected output should look when using a different password, than was used when it was encrypted:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">decrypt</span><span class="p">(</span><span class="s">&#39;badpass&#39;</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">))</span>
</span><span class='line'><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;/usr/lib/python2.7/site-packages/simplecrypt/__init__.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">72</span><span class="p">,</span> <span class="ow">in</span> <span class="n">decrypt</span>
</span><span class='line'>    <span class="n">_assert_hmac</span><span class="p">(</span><span class="n">hmac_key</span><span class="p">,</span> <span class="n">hmac</span><span class="p">,</span> <span class="n">hmac2</span><span class="p">)</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;/usr/lib/python2.7/site-packages/simplecrypt/__init__.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">116</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_assert_hmac</span>
</span><span class='line'>    <span class="k">raise</span> <span class="n">DecryptionException</span><span class="p">(</span><span class="s">&#39;Bad password or corrupt / modified data.&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">simplecrypt</span><span class="o">.</span><span class="n">DecryptionException</span><span class="p">:</span> <span class="n">Bad</span> <span class="n">password</span> <span class="ow">or</span> <span class="n">corrupt</span> <span class="o">/</span> <span class="n">modified</span> <span class="n">data</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now using the correct password to decrypt:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">decrypt</span><span class="p">(</span><span class="s">&#39;sekret&#39;</span><span class="p">,</span> <span class="n">ciphertext</span><span class="p">))</span>
</span><span class='line'><span class="n">this</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">secret</span> <span class="n">message</span>
</span></code></pre></td></tr></table></div></figure>


<h2>SimpleCrypt Base64 and Getpass</h2>

<p>I wanted to store the encrypted string in a database, but the ciphertext has a combination of random special characters, so I decided to encode the ciphertext with base64. And the password input will be used with the getpass module.</p>

<p>Our encryption app:</p>

<figure class='code'><figcaption><span>encrypt.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">simplecrypt</span> <span class="kn">import</span> <span class="n">encrypt</span><span class="p">,</span> <span class="n">decrypt</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span>
</span><span class='line'>
</span><span class='line'><span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">()</span>
</span><span class='line'><span class="n">message</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">cipher</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="n">encoded_cipher</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="n">cipher</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">encoded_cipher</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our decryption app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">simplecrypt</span> <span class="kn">import</span> <span class="n">encrypt</span><span class="p">,</span> <span class="n">decrypt</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span><span class="p">,</span> <span class="n">b64decode</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">getpass</span> <span class="kn">import</span> <span class="n">getpass</span>
</span><span class='line'>
</span><span class='line'><span class="n">password</span> <span class="o">=</span> <span class="n">getpass</span><span class="p">()</span>
</span><span class='line'><span class="n">encoded_cipher</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">cipher</span> <span class="o">=</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">encoded_cipher</span><span class="p">)</span>
</span><span class='line'><span class="n">plaintext</span> <span class="o">=</span> <span class="n">decrypt</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">cipher</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Encrypt and Decrypting Data using our Scripts:</h2>

<p>Encrypting the string <code>this is a secret message</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python encrypt.py <span class="s2">&quot;this is a secret message&quot;</span>
</span><span class='line'>Password:
</span><span class='line'>c2MAAnyfWIfOBV43vxo3sVCEYMG4C6hx69hv2Ii1JKlVHJUgBAlADJPOsD5cJO6MMI9faTDm1As/VfesvBzIe5S16mNyg2q7xfnP5iJ0RlK92vMNRbKOvNibg3M<span class="o">=</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have our encoded ciphertext, lets decrypt it with the password that we encrypted it with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python decrypt.py <span class="s1">&#39;c2MAAnyfWIfOBV43vxo3sVCEYMG4C6hx69hv2Ii1JKlVHJUgBAlADJPOsD5cJO6MMI9faTDm1As/VfesvBzIe5S16mNyg2q7xfnP5iJ0RlK92vMNRbKOvNibg3M=&#39;</span>
</span><span class='line'>Password:
</span><span class='line'>this is a secret message
</span></code></pre></td></tr></table></div></figure>


<p>This is one way of working with sensitive info that you would like to encrypt/decrypt.</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/23/using-paramiko-module-in-python-to-execute-remote-bash-commands/">Using Paramiko Module in Python to Execute Remote Bash Commands</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-23T18:16:59+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2018</span></span> <span class='time'>6:16 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Paramiko is a python implementation of the sshv2 protocol.</p>

<h2>Paramiko to execute Remote Commands:</h2>

<p>We will use paramiko module in python to execute a command on our remote server.</p>

<p>Client side will be referenced as (side-a) and Server side will be referenced as (side-b)</p>

<h2>Getting the Dependencies:</h2>

<p>Install Paramiko via pip on side-a:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install paramiko --user
</span></code></pre></td></tr></table></div></figure>


<h2>Using Paramiko in our Code:</h2>

<p>Our Python Code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">paramiko</span>
</span><span class='line'>
</span><span class='line'><span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
</span><span class='line'><span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
</span><span class='line'><span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s">&#39;192.168.10.10&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&#39;ubuntu&#39;</span><span class="p">,</span> <span class="n">key_filename</span><span class="o">=</span><span class="s">&#39;/home/ubuntu/.ssh/mykey.pem&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s">&#39;lsb_release -a&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Execute our Command Remotely:</h2>

<p>Now we will attempt to establish the ssh connection from side-a, then run <code>lsb_release -a</code> on our remote server, side-b:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python execute.py
</span><span class='line'>
</span><span class='line'>Distributor ID:   Ubuntu
</span><span class='line'>Description:  Ubuntu 16.04.4 LTS
</span><span class='line'>Release:  16.04
</span><span class='line'>Codename: xenial
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/23/setup-a-ssh-tunnel-with-the-sshtunnel-module-in-python/">Setup a SSH Tunnel With the Sshtunnel Module in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-23T17:56:46+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2018</span></span> <span class='time'>5:56 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes we need to restrict access to a port, where a port should listen on localhost, but you want to access that port from a remote source. One secure way of doing that, is to establish a SSH Tunnel to the remote side, and forward to port via the SSH Tunnel.</p>

<p>Today we will setup a Flask Web Service on our Remote Server (Side B) which will be listening on <code>127.0.0.1:5000</code> and setup the SSH Tunnel with the <code>sshtunnel</code> module in Python from our client side (Side A). Then we will make a GET request on our client side to the port that we are forwarding via the tunnel to our remote side.</p>

<h2>Remote Side:</h2>

<p>Our Demo Python Flask Application:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;OK&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python app.py
</span><span class='line'>Listening on 127.0.0.1:5000
</span></code></pre></td></tr></table></div></figure>


<h2>Client Side:</h2>

<p>From our client side we first need to install sshtunnel via pip:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install sshtunnel requests --user
</span></code></pre></td></tr></table></div></figure>


<p>Our code for our client that will establish the tunnel and do the GET request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">sshtunnel</span> <span class="kn">import</span> <span class="n">SSHTunnelForwarder</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'><span class="n">remote_user</span> <span class="o">=</span> <span class="s">&#39;ubuntu&#39;</span>
</span><span class='line'><span class="n">remote_host</span> <span class="o">=</span> <span class="s">&#39;192.168.10.10&#39;</span>
</span><span class='line'><span class="n">remote_port</span> <span class="o">=</span> <span class="mi">22</span>
</span><span class='line'><span class="n">local_host</span> <span class="o">=</span> <span class="s">&#39;127.0.0.1&#39;</span>
</span><span class='line'><span class="n">local_port</span> <span class="o">=</span> <span class="mi">5000</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="o">=</span> <span class="n">SSHTunnelForwarder</span><span class="p">(</span>
</span><span class='line'>   <span class="p">(</span><span class="n">remote_host</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">),</span>
</span><span class='line'>   <span class="n">ssh_username</span><span class="o">=</span><span class="n">remote_user</span><span class="p">,</span>
</span><span class='line'>   <span class="n">ssh_private_key</span><span class="o">=</span><span class="s">&#39;/home/ubuntu/.ssh/mykey.pem&#39;</span><span class="p">,</span>
</span><span class='line'>   <span class="n">remote_bind_address</span><span class="o">=</span><span class="p">(</span><span class="n">local_host</span><span class="p">,</span> <span class="n">local_port</span><span class="p">),</span>
</span><span class='line'>   <span class="n">local_bind_address</span><span class="o">=</span><span class="p">(</span><span class="n">local_host</span><span class="p">,</span> <span class="n">local_port</span><span class="p">),</span>
</span><span class='line'>   <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s">&#39;Mozilla/5.0 (Windows NT 6.0; WOW64; rv:24.0) Gecko/20100101 Firefox/24.0&#39;</span><span class="p">}</span>
</span><span class='line'><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;http://127.0.0.1:5000&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span><span class='line'><span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running our app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python ssh_tunnel.py
</span><span class='line'>OK
</span></code></pre></td></tr></table></div></figure>


<p>So we have sucessfully established our ssh tunnel to our remote side, and able to access the network restricted port via the tunnel.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://pypi.org/project/sshtunnel/">SSHTunnel</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/22/basic-restful-api-server-with-python-flask/">Basic RESTFul API Server With Python Flask</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-22T01:35:34+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2018</span></span> <span class='time'>1:35 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53351527-18dc2100-392a-11e9-9e50-48f738046a68.jpg" alt="" /></p>

<p>A Basic RESTFul API Service with Python Flask. We will be using the Flask, jsonify and request classes to build our API service.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>Description of this demonstration:</h2>

<p>Our API will be able to do the following:</p>

<ul>
<li>Create, Read, Update, Delete</li>
</ul>


<p>In this demonstration, we will add some information about people to our API, then go through each method that is mentioned above.</p>

<h2>Getting the Dependencies:</h2>

<p>Setup the virtualenv and install the dependencies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virtualenv .venv
</span><span class='line'><span class="nv">$ </span><span class="nb">source</span> .venv/bin/activate
</span><span class='line'><span class="nv">$ </span>pip install flask
</span></code></pre></td></tr></table></div></figure>


<h2>The API Server Code:</h2>

<p>Here&rsquo;s the complete code, as you can see I have a couple of decorators for each url endpoint, and a <code>id_generator</code> function, that will generate id&rsquo;s for each document. The id will be used for getting users information, updates and deletes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Value</span>
</span><span class='line'>
</span><span class='line'><span class="n">counter</span> <span class="o">=</span> <span class="n">Value</span><span class="p">(</span><span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="n">help_message</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">API Usage:</span>
</span><span class='line'><span class="s"> </span>
</span><span class='line'><span class="s">- GET    /api/list</span>
</span><span class='line'><span class="s">- POST   /api/add data={&quot;key&quot;: &quot;value&quot;}</span>
</span><span class='line'><span class="s">- GET    /api/get/&lt;id&gt;</span>
</span><span class='line'><span class="s">- PUT    /api/update/&lt;id&gt; data={&quot;key&quot;: &quot;value_to_replace&quot;}</span>
</span><span class='line'><span class="s">- DELETE /api/delete/&lt;id&gt; </span>
</span><span class='line'>
</span><span class='line'><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">id_generator</span><span class="p">():</span>
</span><span class='line'>    <span class="k">with</span> <span class="n">counter</span><span class="o">.</span><span class="n">get_lock</span><span class="p">():</span>
</span><span class='line'>        <span class="n">counter</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">counter</span><span class="o">.</span><span class="n">value</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">help</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">help_message</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/list&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">list</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/add&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;POST&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span><span class='line'>    <span class="n">payload</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
</span><span class='line'>    <span class="n">payload</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_generator</span><span class="p">()</span>
</span><span class='line'>    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;Created: {} </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/get&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_none</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;ID Required: /api/get/&lt;id&gt; </span><span class="se">\n</span><span class="s">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/get/&lt;int:_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">_id</span><span class="p">):</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">_id</span> <span class="o">==</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]:</span>
</span><span class='line'>            <span class="n">selected_user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">selected_user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/update&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;PUT&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">update_none</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;ID and Desired K/V in Payload required: /api/update/&lt;id&gt; -d </span><span class="se">\&#39;</span><span class="s">{&quot;name&quot;: &quot;john&quot;}</span><span class="se">\&#39;</span><span class="s"> </span><span class="se">\n</span><span class="s">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/update/&lt;int:_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;PUT&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">_id</span><span class="p">):</span>
</span><span class='line'>    <span class="n">update_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
</span><span class='line'>    <span class="n">key_to_update</span> <span class="o">=</span> <span class="n">update_req</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">update_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">_id</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="n">key_to_update</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_req</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">update_resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">_id</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;Updated: {} </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">update_resp</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/api/delete/&lt;int:_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;DELETE&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">_id</span><span class="p">):</span>
</span><span class='line'>    <span class="n">deleted_user</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">a</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">_id</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</span><span class='line'>    <span class="n">a</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">deleted_user</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;Deleted: {} </span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">deleted_user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Demo Time:</h2>

<p>Retrieving the Help output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api
</span><span class='line'>
</span><span class='line'>API Usage:
</span><span class='line'>
</span><span class='line'>- GET    /api/list
</span><span class='line'>- POST   /api/add <span class="nv">data</span><span class="o">={</span><span class="s2">&quot;key&quot;</span>: <span class="s2">&quot;value&quot;</span><span class="o">}</span>
</span><span class='line'>- GET    /api/get/&lt;id&gt;
</span><span class='line'>- PUT    /api/update/&lt;id&gt; <span class="nv">data</span><span class="o">={</span><span class="s2">&quot;key&quot;</span>: <span class="s2">&quot;value_to_replace&quot;</span><span class="o">}</span>
</span><span class='line'>- DELETE /api/delete/&lt;id&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Doing a list, to list all the users, its expected for it to be empty as we have not added any info to our API:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api/list
</span><span class='line'><span class="o">[]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Adding our first user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api/add -d <span class="s1">&#39;{&quot;name&quot;: &quot;ruan&quot;, &quot;country&quot;: &quot;south africa&quot;, &quot;age&quot;: 30}&#39;</span>
</span><span class='line'>Created: <span class="o">{</span>u<span class="s1">&#39;country&#39;</span>: u<span class="s1">&#39;south africa&#39;</span>, u<span class="s1">&#39;age&#39;</span>: 30, u<span class="s1">&#39;name&#39;</span>: u<span class="s1">&#39;ruan&#39;</span>, <span class="s1">&#39;id&#39;</span>: 1<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Adding our second user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api/add -d <span class="s1">&#39;{&quot;name&quot;: &quot;stefan&quot;, &quot;country&quot;: &quot;south africa&quot;, &quot;age&quot;: 29}&#39;</span>
</span><span class='line'>Created: <span class="o">{</span>u<span class="s1">&#39;country&#39;</span>: u<span class="s1">&#39;south africa&#39;</span>, u<span class="s1">&#39;age&#39;</span>: 29, u<span class="s1">&#39;name&#39;</span>: u<span class="s1">&#39;stefan&#39;</span>, <span class="s1">&#39;id&#39;</span>: 2<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing a list again, will retrieve all our users:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api/list
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;age&quot;</span>: 30,
</span><span class='line'>    <span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;south africa&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;id&quot;</span>: 1,
</span><span class='line'>    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;ruan&quot;</span>
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;age&quot;</span>: 29,
</span><span class='line'>    <span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;south africa&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;id&quot;</span>: 2,
</span><span class='line'>    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;stefan&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing a GET on the userid, to only display the users info:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api/get/2
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;age&quot;</span>: 29,
</span><span class='line'>  <span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;south africa&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;id&quot;</span>: 2,
</span><span class='line'>  <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;stefan&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s update some details. Let&rsquo;s say that Stefan relocated to New Zealand. We will need to provide his <code>id</code> and also the key/value that we want to update:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPUT -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api/update/2 -d <span class="s1">&#39;{&quot;country&quot;: &quot;new zealand&quot;}&#39;</span>
</span><span class='line'>Updated: <span class="o">{</span>u<span class="s1">&#39;country&#39;</span>: u<span class="s1">&#39;new zealand&#39;</span>, u<span class="s1">&#39;age&#39;</span>: 29, u<span class="s1">&#39;name&#39;</span>: u<span class="s1">&#39;stefan&#39;</span>, <span class="s1">&#39;id&#39;</span>: 2<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see the response confirmed that the value was updated, but let&rsquo;s verify the output, by doing a get on his id:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api/get/2
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;age&quot;</span>: 29,
</span><span class='line'>  <span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;new zealand&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;id&quot;</span>: 2,
</span><span class='line'>  <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;stefan&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And lastly, lets delete our user, which will only require the userid:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XDELETE -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api/delete/2
</span><span class='line'>Deleted: <span class="o">{</span>u<span class="s1">&#39;country&#39;</span>: u<span class="s1">&#39;new zealand&#39;</span>, u<span class="s1">&#39;age&#39;</span>: 29, u<span class="s1">&#39;name&#39;</span>: u<span class="s1">&#39;stefan&#39;</span>, <span class="s1">&#39;id&#39;</span>: 2<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To verify this, list all the users:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://localhost:5000/api/list
</span><span class='line'><span class="o">[</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;age&quot;</span>: 30,
</span><span class='line'>    <span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;south africa&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;id&quot;</span>: 1,
</span><span class='line'>    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;ruan&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Using Python Requests:</h2>

<p>We can also use python&rsquo;s requests module to do the same, to give a demonstration I will create a new user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install requests
</span><span class='line'><span class="nv">$ </span>python
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">base_url</span> <span class="o">=</span> <span class="s">&#39;http://localhost:5000/api/add&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s">&quot;application/json&quot;</span><span class="p">}</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;shaun&quot;</span><span class="p">,</span> <span class="s">&quot;country&quot;</span><span class="p">:</span> <span class="s">&quot;australia&quot;</span><span class="p">,</span> <span class="s">&quot;age&quot;</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span>
</span><span class='line'><span class="n">Created</span><span class="p">:</span> <span class="p">{</span><span class="s">u&#39;country&#39;</span><span class="p">:</span> <span class="s">u&#39;australia&#39;</span><span class="p">,</span> <span class="s">u&#39;age&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;shaun&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thats it. I&rsquo;ve stumbled upon <a href="https://flask-restful.readthedocs.io/en/latest/">Flask-Restful</a> which I still want to check out, and as soon as I do, I will do a post on it, maybe baked with a NoSQL db or something like that.</p>

<p>Cheers!</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://stackoverflow.com/a/8653568">Python Generator Expressions</a></li>
<li><a href="http://flask.pocoo.org/docs/0.12/api/#flask.Request">Flask Docs</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/18/basic-introduction-to-use-arguments-with-argparse-on-python/">Basic Introduction to Use Arguments With Argparse on Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-18T19:35:28+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>7:35 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I used to work a lot with <code>sys.argv</code> for using arguments in my applications, until I stumbled upon the <code>argparse</code> module! (Thanks Donovan!)</p>

<p>What I like about argparse, is that it builds up the help menu for you, and you also have a lot of options, as you can set the argument to be required, set the datatypes, addtional help context etc.</p>

<h2>The Basic Demonstration:</h2>

<p>Today we will just run through a very basic example on how to use <code>argparse</code>:</p>

<ul>
<li>Return the generated help menu</li>
<li>Return the required value</li>
<li>Return the additional arguments</li>
<li>Compare arguments with a IF statement</li>
</ul>


<h2>The Python Argparse Tutorial Code:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">argparse</span>
</span><span class='line'>
</span><span class='line'><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">&#39;argparse demo&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-w&#39;</span><span class="p">,</span> <span class="s">&#39;--word&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;a word (required)&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--sentence&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;a sentence (not required)&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--comparison&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;a word to compare (not required)&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;Word: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">word</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">sentence</span><span class="p">:</span>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Sentence: :{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sentence</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">comparison</span><span class="p">:</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">comparison</span> <span class="o">==</span> <span class="n">args</span><span class="o">.</span><span class="n">word</span><span class="p">:</span>
</span><span class='line'>      <span class="k">print</span><span class="p">(</span><span class="s">&quot;Comparison: the provided word argument and provided comparison argument is the same&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>      <span class="k">print</span><span class="p">(</span><span class="s">&quot;Comparison: the provided word argument and provided comparison argument is NOT the same&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Seeing it in action:</h2>

<p>To return a usage/help info, run it with the <code>-h</code> or <code>--help</code> argument:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python foo.py -h
</span><span class='line'>usage: foo.py <span class="o">[</span>-h<span class="o">]</span> -w WORD <span class="o">[</span>-s SENTENCE<span class="o">]</span> <span class="o">[</span>-c COMPARISON<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>argparse demo
</span><span class='line'>
</span><span class='line'>optional arguments:
</span><span class='line'>  -h, --help            show this <span class="nb">help </span>message and <span class="nb">exit</span>
</span><span class='line'>  -w WORD, --word WORD  a word <span class="o">(</span>required<span class="o">)</span>
</span><span class='line'>  -s SENTENCE, --sentence SENTENCE
</span><span class='line'>                        a sentence <span class="o">(</span>not required<span class="o">)</span>
</span><span class='line'>  -c COMPARISON, --comparison COMPARISON
</span><span class='line'>                        a word to compare <span class="o">(</span>not required<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>For this to work, the application is expecting the <code>word</code> argument to run, as we declared it as <code>required=True</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python foo.py -w hello
</span><span class='line'>Word: hello
</span></code></pre></td></tr></table></div></figure>


<p>Now to use the arguments that is not required, which makes it optional:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python foo.py -w hello -s <span class="s2">&quot;hello, world&quot;</span>
</span><span class='line'>Word: hello
</span><span class='line'>Sentence: :hello, world
</span></code></pre></td></tr></table></div></figure>


<p>We can also implement some if statements into our application to compare if arguments are the same (as a basic example):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python foo.py -w hello -s <span class="s2">&quot;hello, world&quot;</span> -c goodbye
</span><span class='line'>Word: hello
</span><span class='line'>Sentence: :hello, world
</span><span class='line'>Comparison: the provided word argument and provided comparison argument is NOT the same
</span></code></pre></td></tr></table></div></figure>


<p>We can see that the word and comparison arguments are not the same. When they match up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python foo.py -w hello -s <span class="s2">&quot;hello, world&quot;</span> -c hello
</span><span class='line'>Word: hello
</span><span class='line'>Sentence: :hello, world
</span><span class='line'>Comparison: the provided word argument and provided comparison argument is the same
</span></code></pre></td></tr></table></div></figure>


<p>This was a very basic demonstration on the <code>argparse</code> module.</p>

<h2>Resource:</h2>

<ul>
<li><a href="https://docs.python.org/3/library/argparse.html">Python Docs: Argparse</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/04/16/how-to-monitor-a-amazon-elasticsearch-service-cluster-update-process/">How to Monitor a Amazon Elasticsearch Service Cluster Update Process</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-04-16T09:24:09+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>9:24 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When you make a configuration change on Amazon&rsquo;s Elasticsearch, it does a blue/green deployment. So new nodes will be allocated to the cluster (which you will notice from CloudWatch when looking at the nodes metrics). Once these nodes are deployed, data gets copied accross to the new nodes, and traffic gets directed to the new nodes, and once its done, the old nodes gets terminated.</p>

<p>Note: While there will be more nodes in the cluster, you will not get billed for the extra nodes.</p>

<p>While this process is going, you can monitor your cluster to see the progress:</p>

<h2>The Shards API:</h2>

<p>Using the <code>/_cat/shards</code> API, you will find that the shards are in a RELOCATING state (keeping in mind, this is when the change is still busy)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -s -XGET <span class="s1">&#39;https://search-example-elasticsearch-cluster-6-abc123defghijkl5airxticzvjaqy.eu-west-1.es.amazonaws.com/_cat/shards?v&#39;</span> <span class="p">|</span> grep -v <span class="s1">&#39;STARTED&#39;</span>
</span><span class='line'>index                                   shard prirep state         docs    store ip            node
</span><span class='line'>example-app1-2018.02.23                 <span class="m">4</span>     r      RELOCATING  <span class="m">323498</span> 1018.3mb x.x.x.x x2mKoe_ -&gt; x.x.x.x GyNiRJyeSTifN_9JZisGuQ GyNiRJy
</span><span class='line'>example-app1-2018.02.28                 <span class="m">2</span>     p      RELOCATING  <span class="m">477609</span>    1.5gb x.x.x.x x2mKoe_ -&gt; x.x.x.x sOihejw1SrKtag_LO1RGIA sOihejw
</span><span class='line'>example-app1-2018.03.01                 <span class="m">3</span>     r      RELOCATING  <span class="m">463143</span>    1.5gb x.x.x.x  ZZfv-Ha -&gt; x.x.x.x jOchdCZWQq-TAPZNTadNoA jOchdCZ
</span><span class='line'>fortinet-syslog-2018.02                 <span class="m">0</span>     p      RELOCATING <span class="m">1218556</span>  462.2mb x.x.x.x  moQA57Y -&gt; x.x.x.x sOihejw1SrKtag_LO1RGIA sOihejw
</span><span class='line'>example-app1-2018.03.23                 <span class="m">3</span>     r      RELOCATING  <span class="m">821254</span>    2.4gb x.x.x.x  moQA57Y -&gt; x.x.x.x GyNiRJyeSTifN_9JZisGuQ GyNiRJy
</span><span class='line'>example-app1-2018.04.02                 <span class="m">2</span>     p      RELOCATING <span class="m">1085279</span>    3.4gb x.x.x.x x2mKoe_ -&gt; x.x.x.x jOchdCZWQq-TAPZNTadNoA jOchdCZ
</span><span class='line'>example-app1-2018.02.08                 <span class="m">3</span>     p      RELOCATING  <span class="m">136321</span>    125mb x.x.x.x ZUZSFWu -&gt; x.x.x.x tyU_V_KLS5mZXEwnF-YEAQ tyU_V_K
</span><span class='line'>fortinet-syslog-2018.04                 <span class="m">4</span>     r      RELOCATING <span class="m">7513842</span>    2.8gb x.x.x.x  ZZfv-Ha -&gt; x.x.x.x il1WsroNSgGmXJugds_aMQ il1Wsro
</span><span class='line'>example-app1-2018.04.09                 <span class="m">1</span>     r      RELOCATING <span class="m">1074581</span>    3.5gb x.x.x.x  ZRzKGe5 -&gt; x.x.x.x il1WsroNSgGmXJugds_aMQ il1Wsro
</span><span class='line'>example-app1-2018.04.09                 <span class="m">0</span>     p      RELOCATING <span class="m">1074565</span>    3.5gb x.x.x.x  moQA57Y -&gt; x.x.x.x tyU_V_KLS5mZXEwnF-YEAQ tyU_V_K
</span></code></pre></td></tr></table></div></figure>


<h2>The Recovery API:</h2>

<p>We can then use the <code>/_cat/recovery</code> API, which will show the progress of the shards transferring to the other nodes, you will find the following:</p>

<ul>
<li><code>index, shard, time, type, stage, source_host, target_host, files, files_percent, bytes, bytes_percent</code></li>
</ul>


<p>As Amazon masks their node ip addresses, we will find that the ips are not available. To make it more human readable, we will only pass the columns that we are interested in and not to show the shards that has been set to <code>done</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -XGET <span class="s1">&#39;https://search-example-elasticsearch-cluster-6-abc123defghijkl5airxticzvjaqy.eu-west-1.es.amazonaws.com/_cat/recovery?v&amp;h=i,s,t,ty,st,shost,thost,f,fp,b,bp&#39;</span> <span class="p">|</span> grep -v <span class="s1">&#39;done&#39;</span>
</span><span class='line'>i                                       s t     ty          st       shost         thost         f   fp     b          bp
</span><span class='line'>example-app1-2018.04.11                 <span class="m">1</span> 2m    peer        index    x.x.x.x x.x.x.x  <span class="m">139</span> 97.1%  <span class="m">3435483673</span> 65.9%
</span><span class='line'>web-syslog-2018.04                 <span class="m">4</span> 7.6m  peer        finalize x.x.x.x x.x.x.x  <span class="m">109</span> 100.0% <span class="m">2854310892</span> 100.0%
</span><span class='line'>example-app1-2018.04.16                 <span class="m">3</span> 2.9m  peer        translog x.x.x.x x.x.x.x  <span class="m">130</span> 100.0% <span class="m">446180036</span>  100.0%
</span><span class='line'>example-app1-2018.03.30                 <span class="m">3</span> 2.1m  peer        index    x.x.x.x  x.x.x.x  <span class="m">127</span> 97.6%  <span class="m">3862498583</span> 62.5%
</span><span class='line'>example-app1-2018.04.01                 <span class="m">0</span> 4.4m  peer        index    x.x.x.x  x.x.x.x  <span class="m">140</span> 99.3%  <span class="m">3410543270</span> 87.9%
</span><span class='line'>example-app1-2018.04.06                 <span class="m">0</span> 5.1m  peer        index    x.x.x.x x.x.x.x  <span class="m">128</span> 97.7%  <span class="m">4291421948</span> 66.3%
</span><span class='line'>example-app1-2018.04.07                 <span class="m">0</span> 52.2s peer        index    x.x.x.x x.x.x.x <span class="m">149</span> 91.9%  <span class="m">3969581277</span> 27.4%
</span><span class='line'>network-capture-2018.04.01               <span class="m">2</span> 11.4s peer        index    x.x.x.x  x.x.x.x <span class="m">107</span> 95.3%  <span class="m">359987163</span>  55.0%
</span><span class='line'>example-app1-2018.03.17                 <span class="m">1</span> 1.7m  peer        index    x.x.x.x  x.x.x.x <span class="m">117</span> 98.3%  <span class="m">2104196548</span> 74.5%
</span><span class='line'>example-app1-2018.02.25                 <span class="m">3</span> 58.4s peer        index    x.x.x.x  x.x.x.x <span class="m">102</span> 98.0%  <span class="m">945437614</span>  74.7%
</span></code></pre></td></tr></table></div></figure>


<p>We can also see the human readable output, which is displayed in json format, with much more detail:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -XGET <span class="s1">&#39;https://search-example-elasticsearch-cluster-6-abc123defghijkl5airxticzvjaqy.eu-west-1.es.amazonaws.com/example-app1-2018.04.03/_recovery?human&#39;</span> <span class="p">|</span> python -m json.tool
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;example-app1-2018.04.03&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;shards&quot;</span>: <span class="o">[</span>
</span><span class='line'>            <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;id&quot;</span>: 0,
</span><span class='line'>                <span class="s2">&quot;index&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;files&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;percent&quot;</span>: <span class="s2">&quot;100.0%&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;recovered&quot;</span>: 103,
</span><span class='line'>                        <span class="s2">&quot;reused&quot;</span>: 0,
</span><span class='line'>                        <span class="s2">&quot;total&quot;</span>: 103
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;size&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;percent&quot;</span>: <span class="s2">&quot;100.0%&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;recovered&quot;</span>: <span class="s2">&quot;3.6gb&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;recovered_in_bytes&quot;</span>: 3926167091,
</span><span class='line'>                        <span class="s2">&quot;reused&quot;</span>: <span class="s2">&quot;0b&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;reused_in_bytes&quot;</span>: 0,
</span><span class='line'>                        <span class="s2">&quot;total&quot;</span>: <span class="s2">&quot;3.6gb&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;total_in_bytes&quot;</span>: 3926167091
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;source_throttle_time&quot;</span>: <span class="s2">&quot;2m&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;source_throttle_time_in_millis&quot;</span>: 121713,
</span><span class='line'>                    <span class="s2">&quot;target_throttle_time&quot;</span>: <span class="s2">&quot;2.1m&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;target_throttle_time_in_millis&quot;</span>: 126170,
</span><span class='line'>                    <span class="s2">&quot;total_time&quot;</span>: <span class="s2">&quot;7.2m&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;total_time_in_millis&quot;</span>: 434142
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;primary&quot;</span>: <span class="nb">true</span>,
</span><span class='line'>                <span class="s2">&quot;source&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;host&quot;</span>: <span class="s2">&quot;x.x.x.x&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;ZRzKGe5WSg2SzilZGb3RbA&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;ip&quot;</span>: <span class="s2">&quot;x.x.x.x&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;ZRzKGe5&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;transport_address&quot;</span>: <span class="s2">&quot;x.x.x.x:9300&quot;</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;stage&quot;</span>: <span class="s2">&quot;DONE&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;start_time&quot;</span>: <span class="s2">&quot;2018-04-10T19:26:48.668Z&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;start_time_in_millis&quot;</span>: 1523388408668,
</span><span class='line'>                <span class="s2">&quot;stop_time&quot;</span>: <span class="s2">&quot;2018-04-10T19:34:04.980Z&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;stop_time_in_millis&quot;</span>: 1523388844980,
</span><span class='line'>                <span class="s2">&quot;target&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;host&quot;</span>: <span class="s2">&quot;x.x.x.x&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;x2mKoe_GTpe3b1CnXOKisA&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;ip&quot;</span>: <span class="s2">&quot;x.x.x.x&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;x2mKoe_&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;transport_address&quot;</span>: <span class="s2">&quot;x.x.x.x:9300&quot;</span>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;total_time&quot;</span>: <span class="s2">&quot;7.2m&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;total_time_in_millis&quot;</span>: 436311,
</span><span class='line'>                <span class="s2">&quot;translog&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;percent&quot;</span>: <span class="s2">&quot;100.0%&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;recovered&quot;</span>: 0,
</span><span class='line'>                    <span class="s2">&quot;total&quot;</span>: 0,
</span><span class='line'>                    <span class="s2">&quot;total_on_start&quot;</span>: 0,
</span><span class='line'>                    <span class="s2">&quot;total_time&quot;</span>: <span class="s2">&quot;1.1s&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;total_time_in_millis&quot;</span>: 1154
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;PEER&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;verify_index&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;check_index_time&quot;</span>: <span class="s2">&quot;0s&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;check_index_time_in_millis&quot;</span>: 0,
</span><span class='line'>                    <span class="s2">&quot;total_time&quot;</span>: <span class="s2">&quot;0s&quot;</span>,
</span><span class='line'>                    <span class="s2">&quot;total_time_in_millis&quot;</span>: 0
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>,
</span></code></pre></td></tr></table></div></figure>


<h2>The Cluster Health API:</h2>

<p>Amazon restricts most of the <code>/_cluster</code> API actions, but we can however see the health endpoint, where we can see the number of <code>nodes</code>, <code>active_shards</code>, <code>relocating_shards</code>, <code>number_of_pending_tasks</code> etc:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET https://search-example-elasticsearch-cluster-6-abc123defghijkl5airxticzvjaqy.eu-west-1.es.amazonaws.com/_cluster/health?pretty
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;cluster_name&quot;</span> : <span class="s2">&quot;0123456789012:example-elasticsearch-cluster-6&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;status&quot;</span> : <span class="s2">&quot;green&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;timed_out&quot;</span> : <span class="nb">false</span>,
</span><span class='line'>  <span class="s2">&quot;number_of_nodes&quot;</span> : 16,
</span><span class='line'>  <span class="s2">&quot;number_of_data_nodes&quot;</span> : 10,
</span><span class='line'>  <span class="s2">&quot;active_primary_shards&quot;</span> : 803,
</span><span class='line'>  <span class="s2">&quot;active_shards&quot;</span> : 1606,
</span><span class='line'>  <span class="s2">&quot;relocating_shards&quot;</span> : 10,
</span><span class='line'>  <span class="s2">&quot;initializing_shards&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;unassigned_shards&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;delayed_unassigned_shards&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;number_of_pending_tasks&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;number_of_in_flight_fetch&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;task_max_waiting_in_queue_millis&quot;</span> : 0,
</span><span class='line'>  <span class="s2">&quot;active_shards_percent_as_number&quot;</span> : 100.0
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The Pending Tasks API:</h2>

<p>We also have some insights into the <code>/_cat/pending_tasks</code> API:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -XGET <span class="s1">&#39;https://search-example-elasticsearch-cluster-6-abc123defghijkl5airxticzvjaqy.eu-west-1.es.amazonaws.com/_cat/pending_tasks?v&#39;</span>
</span><span class='line'>insertOrder timeInQueue priority <span class="nb">source</span>
</span><span class='line'><span class="m">1757</span>        53ms URGENT   shard-started shard id <span class="o">[[</span>network-metrics-2018.04.13<span class="o">][</span>0<span class="o">]]</span>, allocation id <span class="o">[</span>Qh91o_OGRX-lFnY8KxYgQw<span class="o">]</span>, primary term <span class="o">[</span>0<span class="o">]</span>, message <span class="o">[</span>after peer recovery<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-recovery.html#cat-recovery">https://www.elastic.co/guide/en/elasticsearch/reference/current/cat-recovery.html#cat-recovery</a></li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-recovery.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-recovery.html</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/17">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/15">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/11/26/setup-aws-s3-cross-account-access/">Setup AWS S3 Cross Account Access</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/11/23/how-to-setup-vpc-peering-on-aws/">How to Setup VPC Peering on AWS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/11/17/how-to-deploy-a-webapp-on-a-aws-eks-kubernetes-cluster/">How to Deploy a Webapp on a AWS EKS Kubernetes Cluster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/11/16/how-to-setup-a-aws-eks-kubernetes-cluster/">How to Setup a AWS EKS Kubernetes Cluster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/11/14/testing-aws-lambda-functions-locally-on-docker-with-lambci/">Testing AWS Lambda Functions Locally on Docker With LambCi</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
