
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="Quick post on how to setup HTTP Basic Authentication and whitelist IP Based Sources to not get prompted for Authentication. This could be useful for &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="http://blog.ruanbekker.com/posts/19/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.ruan.dev/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="/about-me/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/03/19/nginx-basic-authentication-with-source-ip-whitelisting/">Nginx Basic Authentication With Source IP Whitelisting</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-03-19T16:57:36+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>4:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Quick post on how to setup HTTP Basic Authentication and whitelist IP Based Sources to not get prompted for Authentication.</p>

<p>This could be useful for systems interacting with Nginx, so that they don&rsquo;t have to provide authentication.</p>

<h2>Dependencies:</h2>

<p>Install nginx and the package required to create the auth file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install nginx apache2-utils -y</span></code></pre></td></tr></table></div></figure>


<p>Create the Password file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ htpasswd -c /etc/ngins/secrets admin</span></code></pre></td></tr></table></div></figure>


<h2>Configuration:</h2>

<p>Create the site config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rm -rf /etc/nginx/conf.d/*.conf
</span><span class='line'>$ vim /etc/nginx/conf.d/default.conf</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>    listen       80;
</span><span class='line'>    server_name  localhost;
</span><span class='line'>
</span><span class='line'>    location / {
</span><span class='line'>        satisfy any;
</span><span class='line'>        allow 127.0.0.1;
</span><span class='line'>        deny all;
</span><span class='line'>
</span><span class='line'>        auth_basic "restricted";
</span><span class='line'>        auth_basic_user_file /etc/nginx/secrets;
</span><span class='line'>        root   /usr/share/nginx/html;
</span><span class='line'>        index  index.html index.htm;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    error_page   500 502 503 504  /50x.html;
</span><span class='line'>    location = /50x.html {
</span><span class='line'>        root   /usr/share/nginx/html;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reload the Changes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nginx -s reload</span></code></pre></td></tr></table></div></figure>


<h2>Testing:</h2>

<p>Testing from our Whitelisted location (localhost):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -i http://127.0.0.1 
</span><span class='line'>HTTP/1.1 200 OK</span></code></pre></td></tr></table></div></figure>


<p>Testing from remote location:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -i http://localhost
</span><span class='line'>HTTP/1.1 401 Unauthorized
</span><span class='line'>
</span><span class='line'>$ curl -i http://admin:password@localhost
</span><span class='line'>HTTP/1.1 200 OK</span></code></pre></td></tr></table></div></figure>


<p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/03/13/populate-environment-variables-from-docker-secrets-with-a-flask-demo-app/">Populate Environment Variables From Docker Secrets With a Flask Demo App</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-03-13T00:16:42+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>12:16 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg" alt="" /></p>

<p>In this post we will create a basic Python Flask WebApp on Docker Swarm, but we will read our Flask Host, and Flask Port from Environment Variables, which will be populated from Docker Secrets, which we will read in from a python script.</p>

<h2>Our Directory Setup:</h2>

<p>This can be retrieved from <a href="https://github.com/ruanbekker/docker-swarm-apps/tree/master/tools-secrets-env-exporter">github.com/ruanbekker/docker-swarm-apps/tool-secrets-env-exporter</a>, but I will place the code in here as well.</p>

<figure class='code'><figcaption><span>Dockerfile:</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM alpine:edge
</span><span class='line'>RUN apk add --no-cache python2 py2-pip <span class="o">&amp;&amp;</span> pip install flask
</span><span class='line'>ADD exporter.py /exporter.py
</span><span class='line'>ADD boot.sh /boot.sh
</span><span class='line'>ADD app.py /app.py
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;/bin/sh&quot;</span>, <span class="s2">&quot;/boot.sh&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>exporter.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s">&#39;/run/secrets/*&#39;</span><span class="p">):</span>
</span><span class='line'>    <span class="n">k</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>    <span class="n">v</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;export {key}={value}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">v</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span><span class='line'>
</span><span class='line'><span class="n">flask_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;flask_host&#39;</span><span class="p">])</span>
</span><span class='line'><span class="n">flask_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;flask_port&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;ok</span><span class="se">\n</span><span class="s">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">flask_host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">flask_port</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>boot.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'><span class="nb">eval</span> <span class="k">$(</span>python /exporter.py<span class="k">)</span>
</span><span class='line'>python /app.py
</span></code></pre></td></tr></table></div></figure>


<h2>Flow Information:</h2>

<p>The exporter script checks all the secrets that is mounted to the container, then formats the secrets to a key/value pair, which then exports the environment variables to the current shell, which thereafter gets read by the flask application.</p>

<h2>Usage:</h2>

<p>Create Docker Secrets:</p>

<figure class='code'><figcaption><span>boot.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo </span><span class="m">5001</span> <span class="p">|</span> docker secret create flask_port -
</span><span class='line'><span class="nv">$ </span><span class="nb">echo </span>0.0.0.0 <span class="p">|</span> docker secret create flask_host -
</span></code></pre></td></tr></table></div></figure>


<p>Build and Push the Image:</p>

<figure class='code'><figcaption><span>boot.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker build -t registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/&lt;image&gt;:&lt;tag&gt;
</span><span class='line'><span class="nv">$ </span>docker push registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/&lt;image&gt;:&lt;tag&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Create the Service, and specify the secrets that we created earlier:</p>

<figure class='code'><figcaption><span>boot.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service create --name webapp <span class="se">\</span>
</span><span class='line'>--secret <span class="nb">source</span><span class="o">=</span>flask_host,target<span class="o">=</span>flask_host <span class="se">\</span>
</span><span class='line'>--secret <span class="nb">source</span><span class="o">=</span>flask_port,target<span class="o">=</span>flask_port <span class="se">\</span>
</span><span class='line'>registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/&lt;image&gt;:&lt;tag&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Exec into the container, list to see where the secrets got populated:</p>

<figure class='code'><figcaption><span>boot.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls /run/secrets/
</span><span class='line'>flask_host  flask_port
</span></code></pre></td></tr></table></div></figure>


<p>Do a netstat, to see that the value from the created secret is listening:</p>

<figure class='code'><figcaption><span>boot.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -tulpn
</span><span class='line'>Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:5001            0.0.0.0:*               LISTEN      7/python
</span></code></pre></td></tr></table></div></figure>


<p>Do a GET request on the Flask Application:</p>

<figure class='code'><figcaption><span>boot.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://0.0.0.0:5001/
</span><span class='line'>ok
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/03/03/send-sms-messages-with-python-and-twilio-via-their-api/">Send SMS Messages With Python and Twilio via Their API</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-03-03T00:09:56+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2018</span></span> <span class='time'>12:09 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post will guide you through the steps on how to send SMS messages with Python and Twilio. We will use <code>talaikis.com</code> API to get a random quote that we will include in the body of the sms.</p>

<h2>Signup for a Trail Account:</h2>

<p>Sign up for a trail account at <a href="https://www.twilio.com">Twilio</a> then create a number, which I will refer to as the <code>sender number</code>, take note of your accountid and token.</p>

<h2>Create the Config:</h2>

<p>Create the config, that will keep the accountid, token, sender number and recipient number:</p>

<figure class='code'><figcaption><span>config.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">secrets</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&#39;account&#39;</span><span class="p">:</span> <span class="s">&#39;xxxxxxxx&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;token&#39;</span><span class="p">:</span> <span class="s">&#39;xxxxxxx&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;sender&#39;</span><span class="p">:</span> <span class="s">&#39;+1234567890&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;receiver&#39;</span><span class="p">:</span> <span class="s">&#39;+0987654321&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Client:</h2>

<p>We will get a random quote via talaikis.com&rsquo;s API which we will be using for the body of our text message, and then use twilio&rsquo;s API to send the text message:</p>

<figure class='code'><figcaption><span>sms_client.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">secrets</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">twilio.rest</span> <span class="kn">import</span> <span class="n">Client</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'><span class="n">twilio_acountid</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;account&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">twilio_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;token&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">twilio_receiver</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;receiver&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">twilio_sender</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;sender&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">quote_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;https://talaikis.com/api/quotes/random&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span>
</span><span class='line'>    <span class="n">twilio_acountid</span><span class="p">,</span>
</span><span class='line'>    <span class="n">twilio_token</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">message</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span class='line'>    <span class="n">to</span><span class="o">=</span><span class="n">twilio_receiver</span><span class="p">,</span>
</span><span class='line'>    <span class="n">from_</span><span class="o">=</span><span class="n">twilio_sender</span><span class="p">,</span>
</span><span class='line'>    <span class="n">body</span><span class="o">=</span><span class="n">quote_response</span><span class="p">[</span><span class="s">&#39;quote&#39;</span><span class="p">]</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Message Preview:</h2>

<p>Then within a couple of seconds your message should look something more or less like this:</p>

<p><img src="https://i.snag.gy/Oqj2cP.jpg" alt="" /></p>

<p>For more info, have a look at their docs:
- <a href="https://www.twilio.com/docs/">https://www.twilio.com/docs/</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/03/02/golang-reading-from-files-and-writing-to-disk-with-arguments/">Golang: Reading From Files and Writing to Disk With Arguments</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-03-02T14:11:13+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2018</span></span> <span class='time'>2:11 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/VJmUZz.jpg" alt="" /></p>

<p>From our <a href="https://goo.gl/ih43uv">Previous Post</a> we wrote a basic golang app that reads the contents of a file and writes it back to disk, but in a static way as we defined the source and destination filenames in the code.</p>

<p>Today we will use arguments to specify what the source and destination filenames should be instead of hardcoding it.</p>

<h2>Our Golang Application:</h2>

<p>We will be using if statements to determine if the number of arguments provided is as expected, if not, then a usage string should be returned to stdout. Then we will loop through the list of arguments to determine what the values for our source and destination file should be.</p>

<p>Once it completes, it prints out the coice of filenames that was used:</p>

<figure class='code'><figcaption><span>app.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;io/ioutil&quot;</span>
</span><span class='line'>    <span class="s">&quot;os&quot;</span>
</span><span class='line'>    <span class="s">&quot;fmt&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="p">(</span>
</span><span class='line'>    <span class="nx">input_filename</span> <span class="kt">string</span>
</span><span class='line'>    <span class="nx">output_filename</span> <span class="kt">string</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">5</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Usage: (-i/--input) &#39;input_filename&#39; (-o/--output) &#39;output_filename&#39; \n&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">arg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="nx">arg</span> <span class="o">==</span> <span class="s">&quot;-i&quot;</span> <span class="o">||</span> <span class="nx">arg</span> <span class="o">==</span> <span class="s">&quot;--input&quot;</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">input_filename</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="nx">arg</span> <span class="o">==</span> <span class="s">&quot;-o&quot;</span> <span class="o">||</span> <span class="nx">arg</span> <span class="o">==</span> <span class="s">&quot;--output&quot;</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">output_filename</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">input_file_content</span><span class="p">,</span> <span class="kt">error</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="nx">input_filename</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="kt">error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">panic</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;File used for reading:&quot;</span><span class="p">,</span> <span class="nx">input_filename</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">output_filename</span><span class="p">,</span> <span class="nx">input_file_content</span><span class="p">,</span> <span class="mo">0644</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;File used for writing:&quot;</span><span class="p">,</span> <span class="nx">output_filename</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Build your application:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go build app.go
</span></code></pre></td></tr></table></div></figure>


<p>Run your application with no additional arguments to determine the expected behaviour:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./app
</span><span class='line'>Usage: <span class="o">(</span>-i/--input<span class="o">)</span> <span class="s1">&#39;input_filename&#39;</span> <span class="o">(</span>-o/--output<span class="o">)</span> <span class="s1">&#39;output_file-to-write&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>It works as expected, now create a source file, then run the application:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$RANDOM</span> &gt; myfile.txt
</span></code></pre></td></tr></table></div></figure>


<p>Run the application, and in this run, we will set the destination file as newfile.txt:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./app -i myfile.txt -o newfile.txt
</span><span class='line'>File used <span class="k">for</span> reading: myfile.txt
</span><span class='line'>File used <span class="k">for</span> writing: newfile.txt
</span></code></pre></td></tr></table></div></figure>


<p>Checking out the new file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat newfile.txt
</span><span class='line'>8568
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/03/02/golang-reading-from-files-and-writing-to-disk-with-golang/">Golang: Reading From Files and Writing to Disk With Golang</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-03-02T13:44:59+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2018</span></span> <span class='time'>1:44 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="![](https://i.snag.gy/VJmUZz.jpg" alt="" />)</p>

<p>Today we will create a very basic application to read content from a file, and write the content from the file back to disk, but to another filename.</p>

<p>Basically, doing a copy of the file to another filename.</p>

<h2>Golang Environment: Golang Docker Image</h2>

<p>Dropping into a Golang Environment using Docker:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run -it golang:alpine sh
</span></code></pre></td></tr></table></div></figure>


<h2>Our Golang Application</h2>

<p>After we are in our container, lets write our app:</p>

<figure class='code'><figcaption><span>app.go</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;io/ioutil&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">content</span><span class="p">,</span> <span class="kt">error</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">ReadFile</span><span class="p">(</span><span class="s">&quot;source-data.txt&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="kt">error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">panic</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">error</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="s">&quot;destination-data.txt&quot;</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="mo">0644</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="kt">error</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">panic</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Building our application to a binary:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go build app.go
</span></code></pre></td></tr></table></div></figure>


<p>Creating our <code>source-data.txt</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;foo&quot;</span> &gt; <span class="nb">source</span>-data.txt
</span></code></pre></td></tr></table></div></figure>


<h2>Running the Golang App:</h2>

<p>When we run this app, it will read the content of <code>source-data.txt</code> and write it to <code>destination-data.txt</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./app.go
</span></code></pre></td></tr></table></div></figure>


<p>We can see that the file has been written to disk:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls <span class="p">|</span> grep data
</span><span class='line'>destination-data.txt
</span><span class='line'><span class="nb">source</span>-data.txt
</span></code></pre></td></tr></table></div></figure>


<p>Making sure the data is the same, we can do a <code>md5sum hash</code> function on them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>md5sum <span class="nb">source</span>-data.txt
</span><span class='line'>d3b07384d113edec49eaa6238ad5ff00  <span class="nb">source</span>-data.txt
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>md5sum destination-data.txt
</span><span class='line'>d3b07384d113edec49eaa6238ad5ff00  destination-data.txt
</span></code></pre></td></tr></table></div></figure>


<h2>Next:</h2>

<p>This was a very static way of doing it, as you need to hardcode the filenames. In the <a href="https://goo.gl/t8fasN">next post</a> I will show how to use arguments to make it more dynamic.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/02/20/setup-a-kvm-hypervisor-on-ubuntu-to-host-virtual-machines/">Setup a KVM Hypervisor on Ubuntu to Host Virtual Machines</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-02-20T13:21:56+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>1:21 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today we will setup a KVM (Kernel Virtual Machine) Hypervisor, where we can host Virtual Machines. In order to do so, your host needs to Support Hardware Virtualization.</p>

<h2>What we will be doing today:</h2>

<ul>
<li>Check if your host supports Hardware Virtualization</li>
<li>Setup the KVM Hypervisor</li>
<li>Setup a Alpine VM</li>
</ul>


<h2>Check for Hardware Virtualization Support:</h2>

<p>We will install the package required to do the check:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update <span class="o">&amp;&amp;</span> sudo apt install cpu-checker -y
</span></code></pre></td></tr></table></div></figure>


<p>Once that is installed, run <code>kvm-ok</code> and if its supported, your output should look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>kvm-ok
</span><span class='line'>INFO: /dev/kvm exists
</span><span class='line'>KVM acceleration can be used
</span></code></pre></td></tr></table></div></figure>


<h2>Installing KVM</h2>

<p>Update your System and get the Packages required to Setup KVM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install bridge-utils qemu-kvm libvirt-bin virtinst -y
</span></code></pre></td></tr></table></div></figure>


<p>Add your user to the libvirtd group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo usermod -G libvirtd <span class="nv">$USER</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check that the libvirtd service is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl is-active libvirtd
</span><span class='line'>active
</span></code></pre></td></tr></table></div></figure>


<p>You will also find that there is a new interface configured called <code>virbr0</code> in my case.</p>

<h2>Provision the Alpine VM and Setup OpenSSH:</h2>

<p>Get the ISO:</p>

<ul>
<li><a href="https://alpinelinux.org/downloads/">https://alpinelinux.org/downloads/</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget http://dl-cdn.alpinelinux.org/alpine/v3.7/releases/x86_64/alpine-virt-3.7.0-x86_64.iso
</span></code></pre></td></tr></table></div></figure>


<p>Provision the VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virt-install <span class="se">\</span>
</span><span class='line'>--name alpine1 <span class="se">\</span>
</span><span class='line'>--ram <span class="m">256</span> <span class="se">\</span>
</span><span class='line'>--disk <span class="nv">path</span><span class="o">=</span>/var/lib/libvirt/images/alpine1.img,size<span class="o">=</span><span class="m">8</span> <span class="se">\</span>
</span><span class='line'>--vcpus <span class="m">1</span> <span class="se">\</span>
</span><span class='line'>--os-type linux <span class="se">\</span>
</span><span class='line'>--os-variant generic <span class="se">\</span>
</span><span class='line'>--network bridge:virbr0,model<span class="o">=</span>virtio <span class="se">\</span>
</span><span class='line'>--graphics none <span class="se">\</span>
</span><span class='line'>--console pty,target_type<span class="o">=</span>serial <span class="se">\</span>
</span><span class='line'>--cdrom ./alpine-virt-3.7.0-x86_64.iso
</span></code></pre></td></tr></table></div></figure>


<p>After this, you will be dropped into the console:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Starting install...
</span><span class='line'>Allocating <span class="s1">&#39;alpine1.img&#39;</span>                                                                                                           <span class="p">|</span>   <span class="m">8</span> GB  00:00:01
</span><span class='line'>Creating domain...                                                                                                                 <span class="p">|</span>    <span class="m">0</span> B  00:00:00
</span><span class='line'>Connected to domain alpine1
</span><span class='line'>Escape character is ^<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>ISOLINUX 6.04 6.04-pre1  Copyright <span class="o">(</span>C<span class="o">)</span> 1994-2015 H. Peter Anvin et al
</span><span class='line'>boot:
</span><span class='line'>
</span><span class='line'>   OpenRC 0.24.1.a941ee4a0b is starting up Linux 4.9.65-1-virthardened <span class="o">(</span>x86_64<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Welcome to Alpine Linux 3.7
</span><span class='line'>Kernel 4.9.65-1-virthardened on an x86_64 <span class="o">(</span>/dev/ttyS0<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>localhost login:
</span></code></pre></td></tr></table></div></figure>


<p>Login with the <code>root</code> user and no password, then setup the VM by running <code>setup-alpine</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>localhost login: root
</span><span class='line'>Welcome to Alpine!
</span><span class='line'>
</span><span class='line'>localhost:~# setup-alpine
</span></code></pre></td></tr></table></div></figure>


<p>After completing the prompts reboot the VM by running <code>reboot</code>, then you will be dropped out of the console. Check the status of the reboot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virsh list
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> <span class="m">2</span>     alpine1                        running
</span></code></pre></td></tr></table></div></figure>


<p>As we can see our guest is running, lets console to our guest, provide the root user and password that you provided during the setup phase:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virsh console 2
</span><span class='line'>Connected to domain alpine1
</span><span class='line'>Escape character is ^<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>alpine1 login: root
</span><span class='line'>Password:
</span><span class='line'>Welcome to Alpine!
</span></code></pre></td></tr></table></div></figure>


<p>Setup OpenSSH so that we can SSH to our guest over the network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apk update
</span><span class='line'><span class="nv">$ </span>apk add openssh
</span></code></pre></td></tr></table></div></figure>


<p>Configure SSH to accept Root Passwords, this is not advisable for production environments, but for testing this is okay. For Production servers, we will rather look at Key Based Authentication etc.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sed -i <span class="s1">&#39;s/#PermitRootLogin prohibit-password/PermitRootLogin yes/g&#39;</span> /etc/ssh/sshd_config
</span><span class='line'><span class="nv">$ </span>/etc/init.d/sshd restart
</span></code></pre></td></tr></table></div></figure>


<p>Get the IP Address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ifconfig
</span><span class='line'>eth0      Link encap:Ethernet  HWaddr 52:54:00:D0:48:0C
</span><span class='line'>          inet addr:192.168.122.176  Bcast:192.168.122.255  Mask:255.255.255.0
</span><span class='line'>          inet6 addr: fe80::5054:ff:fed0:480c/64 Scope:Link
</span><span class='line'>          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
</span><span class='line'>          RX packets:55 errors:0 dropped:28 overruns:0 frame:0
</span><span class='line'>          TX packets:34 errors:0 dropped:0 overruns:0 carrier:0
</span><span class='line'>          collisions:0 txqueuelen:1000
</span><span class='line'>          RX bytes:4545 <span class="o">(</span>4.4 KiB<span class="o">)</span>  TX bytes:3345 <span class="o">(</span>3.2 KiB<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Exit the guest by running <code>exit</code> and <code>Ctrl + ]</code> to exit the console session.</p>

<p>Now SSH to your Alpine VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh root@192.168.122.176
</span><span class='line'>root@192.168.122.176<span class="err">&#39;</span>s password:
</span><span class='line'>Welcome to Alpine!
</span></code></pre></td></tr></table></div></figure>


<h2>Some Useful Commands:</h2>

<p>List Running VMs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virsh list
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> <span class="m">3</span>     alpine1                        running
</span></code></pre></td></tr></table></div></figure>


<p>Shutdown a VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virsh shutdown alpine1
</span><span class='line'>Domain alpine1 is being shutdown
</span></code></pre></td></tr></table></div></figure>


<p>List all VMs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virsh list --all
</span><span class='line'> Id    Name                           State
</span><span class='line'>----------------------------------------------------
</span><span class='line'> -     alpine1                        shut off
</span></code></pre></td></tr></table></div></figure>


<p>Delete a VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virsh shutdown alpine1 <span class="c">#or to force shutdown:</span>
</span><span class='line'><span class="nv">$ </span>virsh destroy alpine1
</span><span class='line'><span class="nv">$ </span>virsh undefine alpine1
</span></code></pre></td></tr></table></div></figure>


<p>Any future KVM posts will be tagged under <a href="http://blog.ruanbekker.com/blog/categories/kvm?source_site=blog.ruanbekker.com?source_category=kvm">KVM</a> and Alpine posts will be available under the <a href="http://blog.ruanbekker.com/blog/categories/alpine?source_site=blog.ruanbekker.com?source_category=kvm">Alpine</a> tag.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/02/16/guide-to-setup-docker-convoy-volume-driver-for-docker-swarm-with-nfs/">Guide to Setup Docker Convoy Volume Driver for Docker Swarm With NFS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-02-16T15:51:59+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>3:51 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg" alt="" /></p>

<p>In this post we will setup <a href="https://github.com/rancher/convoy">Rancher&rsquo;s Convoy Storage Plugin</a> with NFS, to provide data persistence in Docker Swarm.</p>

<h2>The Overview:</h2>

<p>This essentially means that we will have a NFS Volume, when the service gets created on Docker Swarm, the cluster creates these volumes with path mapping, so when a container gets spawned, restarted, scaled etc, the container that gets started on the new node will be aware of the volume, and will get the data that its expecting.</p>

<p>Its also good to note that our NFS Server will be a single point of failure, therefore its also good to look at a Distributed Volume like <a href="https://sysadmins.co.za/tag/glusterfs">GlusterFS</a>, <a href="https://sysadmins.co.za/tag/xtreemfs/">XtreemFS</a>, <a href="">Ceph</a>, etc.</p>

<ul>
<li>NFS Server (10.8.133.83)</li>
<li>Rancher Convoy Plugin on Each Docker Node in the Swarm (10.8.133.83, 10.8.166.19, 10.8.142.195)</li>
</ul>


<h2>Setup NFS:</h2>

<p>Setup the NFS Server</p>

<p><em>Update:</em></p>

<p>In order for the containers to be able to change permissions, you need to set <code>(rw,async,no_subtree_check,no_wdelay,crossmnt,insecure,all_squash,insecure_locks,sec=sys,anonuid=0,anongid=0)</code></p>

<ul>
<li><a href="https://github.com/rancher/rancher/issues/6452">https://github.com/rancher/rancher/issues/6452</a></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-get install nfs-kernel-server nfs-common -y
</span><span class='line'><span class="nv">$ </span>mkdir /vol
</span><span class='line'><span class="nv">$ </span>chown -R nobody:nogroup /vol
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/vol 10.8.133.83(rw,sync,no_subtree_check) 10.8.166.19(rw,sync,no_subtree_check) 10.8.142.195(rw,sync,no_subtree_check)&#39;</span> &gt;&gt; /etc/exports
</span><span class='line'><span class="nv">$ </span>sudo systemctl restart nfs-kernel-server
</span><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>nfs-kernel-server
</span></code></pre></td></tr></table></div></figure>


<p>Setup the NFS Clients on each Docker Node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-get install nfs-common -y
</span><span class='line'><span class="nv">$ </span>mount 10.8.133.83:/vol /mnt
</span><span class='line'><span class="nv">$ </span>umount /mnt
</span><span class='line'><span class="nv">$ </span>df -h
</span></code></pre></td></tr></table></div></figure>


<p>If you can see tht the volume is mounted, unmount it and add it to the <code>fstab</code> so the volume can be mounted on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo bash -c <span class="s2">&quot;echo &#39;10.8.133.83:/vol /mnt nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0&#39; &gt;&gt; /etc/fstab&quot;</span>
</span><span class='line'><span class="nv">$ </span>sudo mount -a
</span></code></pre></td></tr></table></div></figure>


<h2>Install Rancher Convoy Plugin:</h2>

<p>The Plugin needs to be installed on each docker node that will be part of the swarm:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /tmp
</span><span class='line'><span class="nv">$ </span>wget https://github.com/rancher/convoy/releases/download/v0.5.0/convoy.tar.gz
</span><span class='line'><span class="nv">$ </span>tar xzf convoy.tar.gz
</span><span class='line'><span class="nv">$ </span>sudo cp convoy/convoy convoy/convoy-pdata_tools /usr/local/bin/
</span><span class='line'><span class="nv">$ </span>sudo mkdir -p /etc/docker/plugins/
</span><span class='line'><span class="nv">$ </span>sudo bash -c <span class="s1">&#39;echo &quot;unix:///var/run/convoy/convoy.sock&quot; &gt; /etc/docker/plugins/convoy.spec&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create the init script:</h2>

<p>Thanks to <a href="https://gist.github.com/deviantony/557984d62e867e6f505577b207db6ffc">deviantony</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="c">### BEGIN INIT INFO</span>
</span><span class='line'><span class="c"># Provides:</span>
</span><span class='line'><span class="c"># Required-Start:    $remote_fs $syslog</span>
</span><span class='line'><span class="c"># Required-Stop:     $remote_fs $syslog</span>
</span><span class='line'><span class="c"># Default-Start:     2 3 4 5</span>
</span><span class='line'><span class="c"># Default-Stop:      0 1 6</span>
</span><span class='line'><span class="c"># Short-Description: Start daemon at boot time</span>
</span><span class='line'><span class="c"># Description:       Enable service provided by daemon.</span>
</span><span class='line'><span class="c">### END INIT INFO</span>
</span><span class='line'>
</span><span class='line'><span class="nv">dir</span><span class="o">=</span><span class="s2">&quot;/usr/local/bin&quot;</span>
</span><span class='line'><span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;convoy daemon --drivers vfs --driver-opts vfs.path=/mnt/docker/volumes&quot;</span>
</span><span class='line'><span class="nv">user</span><span class="o">=</span><span class="s2">&quot;root&quot;</span>
</span><span class='line'><span class="nv">name</span><span class="o">=</span><span class="s2">&quot;convoy&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">pid_file</span><span class="o">=</span><span class="s2">&quot;/var/run/$name.pid&quot;</span>
</span><span class='line'><span class="nv">stdout_log</span><span class="o">=</span><span class="s2">&quot;/var/log/$name.log&quot;</span>
</span><span class='line'><span class="nv">stderr_log</span><span class="o">=</span><span class="s2">&quot;/var/log/$name.err&quot;</span>
</span><span class='line'>
</span><span class='line'>get_pid<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    cat <span class="s2">&quot;$pid_file&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>is_running<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">[</span> -f <span class="s2">&quot;$pid_file&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> ps <span class="sb">`</span>get_pid<span class="sb">`</span> &gt; /dev/null 2&gt;<span class="p">&amp;</span>1
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
</span><span class='line'>    start<span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> is_running<span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Already started&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Starting $name&quot;</span>
</span><span class='line'>        <span class="nb">cd</span> <span class="s2">&quot;$dir&quot;</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$user&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>            sudo <span class="nv">$cmd</span> &gt;&gt; <span class="s2">&quot;$stdout_log&quot;</span> 2&gt;&gt; <span class="s2">&quot;$stderr_log&quot;</span> <span class="p">&amp;</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            sudo -u <span class="s2">&quot;$user&quot;</span> <span class="nv">$cmd</span> &gt;&gt; <span class="s2">&quot;$stdout_log&quot;</span> 2&gt;&gt; <span class="s2">&quot;$stderr_log&quot;</span> <span class="p">&amp;</span>
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="nv">$!</span> &gt; <span class="s2">&quot;$pid_file&quot;</span>
</span><span class='line'>        <span class="k">if</span> ! is_running<span class="p">;</span> <span class="k">then</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;Unable to start, see $stdout_log and $stderr_log&quot;</span>
</span><span class='line'>            <span class="nb">exit </span>1
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'>    <span class="p">;;</span>
</span><span class='line'>    stop<span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> is_running<span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="nb">echo</span> -n <span class="s2">&quot;Stopping $name..&quot;</span>
</span><span class='line'>        <span class="nb">kill</span> <span class="sb">`</span>get_pid<span class="sb">`</span>
</span><span class='line'>        <span class="k">for</span> i in <span class="o">{</span>1..10<span class="o">}</span>
</span><span class='line'>        <span class="k">do</span>
</span><span class='line'>            <span class="k">if</span> ! is_running<span class="p">;</span> <span class="k">then</span>
</span><span class='line'>                <span class="nb">break</span>
</span><span class='line'><span class="nb">            </span><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>            <span class="nb">echo</span> -n <span class="s2">&quot;.&quot;</span>
</span><span class='line'>            sleep 1
</span><span class='line'>        <span class="k">done</span>
</span><span class='line'>        <span class="nb">echo</span>
</span><span class='line'>
</span><span class='line'><span class="nb">        </span><span class="k">if</span> is_running<span class="p">;</span> <span class="k">then</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;Not stopped; may still be shutting down or shutdown may have failed&quot;</span>
</span><span class='line'>            <span class="nb">exit </span>1
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;Stopped&quot;</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$pid_file&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>                rm <span class="s2">&quot;$pid_file&quot;</span>
</span><span class='line'>            <span class="k">fi</span>
</span><span class='line'>        <span class="k">fi</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Not running&quot;</span>
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'>    <span class="p">;;</span>
</span><span class='line'>    restart<span class="o">)</span>
</span><span class='line'>    <span class="nv">$0</span> stop
</span><span class='line'>    <span class="k">if</span> is_running<span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Unable to stop, will not attempt to start&quot;</span>
</span><span class='line'>        <span class="nb">exit </span>1
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'>    <span class="nv">$0</span> start
</span><span class='line'>    <span class="p">;;</span>
</span><span class='line'>    status<span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> is_running<span class="p">;</span> <span class="k">then</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Running&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Stopped&quot;</span>
</span><span class='line'>        <span class="nb">exit </span>1
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'>    <span class="p">;;</span>
</span><span class='line'>    *<span class="o">)</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 {start|stop|restart|status}&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'>    <span class="p">;;</span>
</span><span class='line'><span class="k">esac</span>
</span><span class='line'>
</span><span class='line'><span class="nb">exit </span>0
</span></code></pre></td></tr></table></div></figure>


<p>Make the script executable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x /etc/init.d/convoy
</span></code></pre></td></tr></table></div></figure>


<p>Enable the service on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>convoy
</span></code></pre></td></tr></table></div></figure>


<p>Start the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo /etc/init.d/convoy start
</span></code></pre></td></tr></table></div></figure>


<p>This should be done on all the nodes.</p>

<h2>Externally Managed Convoy Volumes</h2>

<p>One thing to note is that, after your delete a volume, you will still need to delete the directory from the path where its hosted, as the application does not do that by itself.</p>

<p>Creating the Volume Before hand:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>convoy create test1
</span><span class='line'>test1
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>docker volume ls
</span><span class='line'>DRIVER              VOLUME NAME
</span><span class='line'>convoy              test1
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>cat /mnt/docker/volumes/config/vfs_volume_test1.json
</span><span class='line'><span class="o">{</span><span class="s2">&quot;Name&quot;</span>:<span class="s2">&quot;test1&quot;</span>,<span class="s2">&quot;Size&quot;</span>:0,<span class="s2">&quot;Path&quot;</span>:<span class="s2">&quot;/mnt/docker/volumes/test1&quot;</span>,<span class="s2">&quot;MountPoint&quot;</span>:<span class="s2">&quot;&quot;</span>,<span class="s2">&quot;PrepareForVM&quot;</span>:false,<span class="s2">&quot;CreatedTime&quot;</span>:<span class="s2">&quot;Mon Feb 05 13:07:05 +0000 2018&quot;</span>,<span class="s2">&quot;Snapshots&quot;</span>:<span class="o">{}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Viewing the volume from another node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker volume ls
</span><span class='line'>DRIVER              VOLUME NAME
</span><span class='line'>convoy              test1
</span></code></pre></td></tr></table></div></figure>


<h2>Creating a Test Service:</h2>

<p>Create a test service to test the data persistence, our docker-compose.yml:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>version: <span class="s1">&#39;3.4&#39;</span>
</span><span class='line'>
</span><span class='line'>volumes:
</span><span class='line'>  test1:
</span><span class='line'>    external: <span class="nb">true</span>
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  appnet:
</span><span class='line'>    external: <span class="nb">true</span>
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  <span class="nb">test</span>:
</span><span class='line'>    image: alpine:edge
</span><span class='line'>    <span class="nb">command</span>: sh -c <span class="s2">&quot;ping 127.0.0.1&quot;</span>
</span><span class='line'>    volumes:
</span><span class='line'>      - test1:/data
</span><span class='line'>    networks:
</span><span class='line'>      - appnet
</span></code></pre></td></tr></table></div></figure>


<p>Creating the Overlay Network and Deploying the Stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create -d overlay appnet
</span><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml apps
</span><span class='line'>Creating service apps_test
</span></code></pre></td></tr></table></div></figure>


<p>Write data to the volume in the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it apps_test.1.iojo7fpw8jirqjs3iu8qr7qpe sh
</span><span class='line'>/ <span class="c"># echo &quot;ok&quot; &gt; /data/file.txt</span>
</span><span class='line'>/ <span class="c"># cat /data/file.txt</span>
</span><span class='line'>ok
</span></code></pre></td></tr></table></div></figure>


<p>Scale the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service scale <span class="nv">apps_test</span><span class="o">=</span>2
</span><span class='line'>apps_test scaled to 2
</span></code></pre></td></tr></table></div></figure>


<p>Inspect to see if the new replica is on another node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ps apps_test
</span><span class='line'>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE               ERROR                         PORTS
</span><span class='line'>myrq2pc3z26z        apps_test.1         alpine:edge         scw-docker-1        Running             Running <span class="m">45</span> seconds ago
</span><span class='line'>ny8t97l2q00c         <span class="se">\_</span> apps_test.1     alpine:edge         scw-docker-1        Shutdown            Failed <span class="m">51</span> seconds ago       <span class="s2">&quot;task: non-zero exit (137)&quot;</span>
</span><span class='line'>iojo7fpw8jir         <span class="se">\_</span> apps_test.1     alpine:edge         scw-docker-1        Shutdown            Failed about a minute ago   <span class="s2">&quot;task: non-zero exit (137)&quot;</span>
</span><span class='line'>tt0nuusvgeki        apps_test.2         alpine:edge         scw-docker-2        Running             Running <span class="m">15</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>Logon to the new container and test if the data is persisted:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it apps_test.2.tt0nuusvgekirw1c5myu720ga sh
</span><span class='line'>/ <span class="c"># cat /data/file.txt</span>
</span><span class='line'>ok
</span></code></pre></td></tr></table></div></figure>


<p>Delete the Stack and Redeploy and have a look at the data we created earlier, and you will notice the data is persisted:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack rm apps
</span><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml apps
</span><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it apps_test.1.la4w2sbuu8cmv6xamwxl7n0ip cat /data/file.txt
</span><span class='line'>ok
</span><span class='line'><span class="nv">$ </span>docker stack rm apps
</span></code></pre></td></tr></table></div></figure>


<h2>Create Volume via Compose:</h2>

<p>You can also create the volume on service/stack creation level, so you dont need to create the volume before hand, the compose file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.4&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">test2</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">convoy</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver_opts</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">appnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine:edge</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sh -c &quot;ping 127.0.0.1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test2:/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploy the Stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose-new.yml apps
</span><span class='line'>Creating service apps_test
</span></code></pre></td></tr></table></div></figure>


<p>List the volumes and you will notice that the volume was created:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker volume ls
</span><span class='line'>DRIVER              VOLUME NAME
</span><span class='line'>convoy              apps_test2
</span><span class='line'>convoy              test1
</span></code></pre></td></tr></table></div></figure>


<p>Lets inspect the volume, to see more details about it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker volume inspect apps_test2
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;CreatedAt&quot;</span>: <span class="s2">&quot;0001-01-01T00:00:00Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Driver&quot;</span>: <span class="s2">&quot;convoy&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Labels&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;com.docker.stack.namespace&quot;</span>: <span class="s2">&quot;apps&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;Mountpoint&quot;</span>: <span class="s2">&quot;/mnt/docker/volumes/apps_test2&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;apps_test2&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Options&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;size&quot;</span>: <span class="s2">&quot;10&quot;</span>
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;Scope&quot;</span>: <span class="s2">&quot;local&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>As mentioned earlier, if you delete the volume, you need to delete the data directories as well</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker volume rm test1
</span><span class='line'>test1
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>ls /mnt/docker/volumes/
</span><span class='line'>apps_test2  config  test1
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>rm -rf /mnt/docker/volumes/test1
</span></code></pre></td></tr></table></div></figure>


<p>More info about the project:
- <a href="https://github.com/rancher/convoy">https://github.com/rancher/convoy</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/02/12/setup-a-nfs-server-on-ubuntu/">Setup a NFS Server on Ubuntu</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-02-12T00:26:56+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>12:26 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/3sUALo.jpg" alt="" /></p>

<p>Quick post on how to setup a NFS Server on Ubuntu and how to setup the client to interact with the NFS Server.</p>

<h2>Setup the Dependencies:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span><span class='line'><span class="nv">$ </span>sudo apt-get install nfs-kernel-server nfs-common -y
</span></code></pre></td></tr></table></div></figure>


<p>Create the Directory for NFS and set permissions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir /vol
</span><span class='line'>chown -R nobody:nogroup /vol
</span></code></pre></td></tr></table></div></figure>


<h2>Allow the Clients:</h2>

<p>We need to set in the <code>exports</code> file, the clients we would like to allow:</p>

<ul>
<li><code>rw</code>: Allows Client R/W Access to the Volume.</li>
<li><code>sync</code>: This option forces NFS to write changes to disk before replying. More stable and Consistent. Note, it does reduce the speed of file operations.</li>
<li><code>no_subtree_check</code>: This prevents subtree checking, which is a process where the host must check whether the file is actually still available in the exported tree for every request. This can cause many problems when a file is renamed while the client has it opened. In almost all cases, it is better to disable subtree checking.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/vol 10.8.133.83(rw,sync,no_subtree_check) 10.8.166.19(rw,sync,no_subtree_check) 10.8.142.195(rw,sync,no_subtree_check)&#39;</span> &gt;&gt; /etc/exports
</span></code></pre></td></tr></table></div></figure>


<h2>Start the NFS Server:</h2>

<p>Restart the service and enable the service on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl restart nfs-kernel-server
</span><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>nfs-kernel-server
</span></code></pre></td></tr></table></div></figure>


<h2>Client Side:</h2>

<p>We will mount the NFS Volume to our Clients <code>/mnt</code> partition.</p>

<p>Install the dependencies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-get install nfs-common -y
</span></code></pre></td></tr></table></div></figure>


<p>Test if we can mount the volume, then unmount it, as we will set the config in our <code>fstab</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo mount 10.8.133.83:/vol /mnt
</span><span class='line'><span class="nv">$ </span>sudo umount /mnt
</span><span class='line'><span class="nv">$ </span>df -h
</span></code></pre></td></tr></table></div></figure>


<p>Set the config in your <code>fstab</code>, then mount it from there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo bash -c <span class="s2">&quot;echo &#39;10.8.133.83:/vol /mnt nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0&#39; &gt;&gt; /etc/fstab&quot;</span>
</span><span class='line'><span class="nv">$ </span>sudo mount -a
</span><span class='line'><span class="nv">$ </span>df -h
</span></code></pre></td></tr></table></div></figure>


<p>Now you shoule be able to write to your NFS Volume from your client.</p>

<p>Sources:
- <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nfs-mount-on-ubuntu-16-04">1</a> <a href="https://gist.github.com/deviantony/557984d62e867e6f505577b207db6ffc%">2</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/02/11/setup-a-site-to-site-ipsec-vpn-with-strongswan-and-preshared-key-authentication/">Setup a Site to Site IPsec VPN With Strongswan and PreShared Key Authentication</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-02-11T23:09:37+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>11:09 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/sWn8zc.jpg" alt="" /></p>

<p>Today we will setup a Site to Site ipsec VPN with Strongswan, which will be configured with PreShared Key Authentication.</p>

<p>After our tunnels are established, we will be able to reach the private ips over the vpn tunnels.</p>

<p><a href="https://bekkerclothing.com/collections/developer?utm_source=blog.ruanbekker.com&utm_medium=blog&utm_campaign=leaderboard_ad" target="_blank"><img alt="bekker-clothing-developer-tshirts" src="https://user-images.githubusercontent.com/567298/70170981-7c278a80-16d6-11ea-9759-6621d02c1423.png"></a></p>

<h2>Get the Dependencies:</h2>

<p>Update your repository indexes and install strongswan:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install strongswan -y
</span></code></pre></td></tr></table></div></figure>


<p>Set the following kernel parameters:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt;&gt; /etc/sysctl.conf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">net.ipv4.ip_forward = 1 </span>
</span><span class='line'><span class="s">net.ipv4.conf.all.accept_redirects = 0 </span>
</span><span class='line'><span class="s">net.ipv4.conf.all.send_redirects = 0</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sysctl -p /etc/sysctl.conf
</span></code></pre></td></tr></table></div></figure>


<h2>Generate Preshared Key:</h2>

<p>We will need a preshared key that both servers will use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>openssl rand -base64 64
</span><span class='line'>87zRQqylaoeF5I8o4lRhwvmUzf+pYdDpsCOlesIeFA/2xrtxKXJTbCPZgqplnXgPX5uprL+aRgxD8ua7MmdWaQ
</span></code></pre></td></tr></table></div></figure>


<h2>Details of our 2 Sites:</h2>

<p>Site A:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Location: Paris, France
</span><span class='line'>External IP: 51.15.139.201
</span><span class='line'>Internal IP: 10.10.27.1/24
</span></code></pre></td></tr></table></div></figure>


<p>Site B:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Location: Amsterdam, Netherlands
</span><span class='line'>External IP: 51.15.44.48
</span><span class='line'>Internal IP: 10.9.141.1/24
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Site A:</h2>

<p>We will setup our VPN Gateway in Site A (Paris), first to setup the <code>/etc/ipsec.secrets</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/ipsec.secrets
</span><span class='line'><span class="c"># source      destination</span>
</span><span class='line'>51.15.139.201 51.15.44.48 : PSK <span class="s2">&quot;87zRQqylaoeF5I8o4lRhwvmUzf+pYdDpsCOlesIeFA/2xrtxKXJTbCPZgqplnXgPX5uprL+aRgxD8ua7MmdWaQ&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now to setup our VPN configuration in <code>/etc/ipsec.conf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat /etc/ipsec.conf
</span><span class='line'><span class="c"># basic configuration</span>
</span><span class='line'>config setup
</span><span class='line'>        <span class="nv">charondebug</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
</span><span class='line'>        <span class="nv">uniqueids</span><span class="o">=</span>yes
</span><span class='line'>        <span class="nv">strictcrlpolicy</span><span class="o">=</span>no
</span><span class='line'>
</span><span class='line'><span class="c"># connection to amsterdam datacenter</span>
</span><span class='line'>conn paris-to-amsterdam
</span><span class='line'>  <span class="nv">authby</span><span class="o">=</span>secret
</span><span class='line'>  <span class="nv">left</span><span class="o">=</span>%defaultroute
</span><span class='line'>  <span class="nv">leftid</span><span class="o">=</span>51.15.139.201
</span><span class='line'>  <span class="nv">leftsubnet</span><span class="o">=</span>10.10.27.1/24
</span><span class='line'>  <span class="nv">right</span><span class="o">=</span>51.15.44.48
</span><span class='line'>  <span class="nv">rightsubnet</span><span class="o">=</span>10.9.141.1/24
</span><span class='line'>  <span class="nv">ike</span><span class="o">=</span>aes256-sha2_256-modp1024!
</span><span class='line'>  <span class="nv">esp</span><span class="o">=</span>aes256-sha2_256!
</span><span class='line'>  <span class="nv">keyingtries</span><span class="o">=</span>0
</span><span class='line'>  <span class="nv">ikelifetime</span><span class="o">=</span>1h
</span><span class='line'>  <span class="nv">lifetime</span><span class="o">=</span>8h
</span><span class='line'>  <span class="nv">dpddelay</span><span class="o">=</span>30
</span><span class='line'>  <span class="nv">dpdtimeout</span><span class="o">=</span>120
</span><span class='line'>  <span class="nv">dpdaction</span><span class="o">=</span>restart
</span><span class='line'>  <span class="nv">auto</span><span class="o">=</span>start
</span></code></pre></td></tr></table></div></figure>


<p>Firewall Rules:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo iptables -t nat -A POSTROUTING -s 10.9.141.0/24 -d 10.10.27.0/24 -j MASQUERADE
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Site B:</h2>

<p>We will setup our VPN Gateway in Site B (Amsterdam), setup the <code>/etc/ipsec.secrets</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/ipsec.secrets
</span><span class='line'>51.15.44.48 51.15.139.201 : PSK <span class="s2">&quot;87zRQqylaoeF5I8o4lRhwvmUzf+pYdDpsCOlesIeFA/2xrtxKXJTbCPZgqplnXgPX5uprL+aRgxD8ua7MmdWaQ&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next to setup our VPN Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat /etc/ipsec.conf
</span><span class='line'><span class="c"># basic configuration</span>
</span><span class='line'>config setup
</span><span class='line'>        <span class="nv">charondebug</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
</span><span class='line'>        <span class="nv">uniqueids</span><span class="o">=</span>yes
</span><span class='line'>        <span class="nv">strictcrlpolicy</span><span class="o">=</span>no
</span><span class='line'>
</span><span class='line'><span class="c"># connection to paris datacenter</span>
</span><span class='line'>conn amsterdam-to-paris
</span><span class='line'>  <span class="nv">authby</span><span class="o">=</span>secret
</span><span class='line'>  <span class="nv">left</span><span class="o">=</span>%defaultroute
</span><span class='line'>  <span class="nv">leftid</span><span class="o">=</span>51.15.44.48
</span><span class='line'>  <span class="nv">leftsubnet</span><span class="o">=</span>10.9.141.1/24
</span><span class='line'>  <span class="nv">right</span><span class="o">=</span>51.15.139.201
</span><span class='line'>  <span class="nv">rightsubnet</span><span class="o">=</span>10.10.27.1/24
</span><span class='line'>  <span class="nv">ike</span><span class="o">=</span>aes256-sha2_256-modp1024!
</span><span class='line'>  <span class="nv">esp</span><span class="o">=</span>aes256-sha2_256!
</span><span class='line'>  <span class="nv">keyingtries</span><span class="o">=</span>0
</span><span class='line'>  <span class="nv">ikelifetime</span><span class="o">=</span>1h
</span><span class='line'>  <span class="nv">lifetime</span><span class="o">=</span>8h
</span><span class='line'>  <span class="nv">dpddelay</span><span class="o">=</span>30
</span><span class='line'>  <span class="nv">dpdtimeout</span><span class="o">=</span>120
</span><span class='line'>  <span class="nv">dpdaction</span><span class="o">=</span>restart
</span><span class='line'>  <span class="nv">auto</span><span class="o">=</span>start
</span></code></pre></td></tr></table></div></figure>


<p>Firewall Rules:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo iptables -t nat -A POSTROUTING -s 10.10.27.0/24 -d 10.9.41.0/24 -J MASQUERADE
</span></code></pre></td></tr></table></div></figure>


<h2>Start the VPN:</h2>

<p>Start the VPN on both ends:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo ipsec restart
</span></code></pre></td></tr></table></div></figure>


<p>Get the status of the tunnel, in this case we are logged onto our Site A (Paris) Server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo ipsec status
</span><span class='line'>Security Associations <span class="o">(</span><span class="m">1</span> up, <span class="m">0</span> connecting<span class="o">)</span>:
</span><span class='line'>paris-to-amsterdam<span class="o">[</span>2<span class="o">]</span>: ESTABLISHED <span class="m">14</span> minutes ago, 10.10.27.161<span class="o">[</span>51.15.139.201<span class="o">]</span>...51.15.44.48<span class="o">[</span>51.15.44.48<span class="o">]</span>
</span><span class='line'>paris-to-amsterdam<span class="o">{</span>1<span class="o">}</span>:  INSTALLED, TUNNEL, reqid 1, ESP in UDP SPIs: c8c868ee_i c9d58dbd_o
</span><span class='line'>paris-to-amsterdam<span class="o">{</span>1<span class="o">}</span>:   10.10.27.1/24 <span class="o">===</span> 10.9.141.1/24
</span></code></pre></td></tr></table></div></figure>


<p>Test if we can see the remote end on its private range:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ping 10.9.141.97
</span><span class='line'>PING 10.9.141.97 <span class="o">(</span>10.9.141.97<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span><span class='line'><span class="m">64</span> bytes from 10.9.141.97: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nb">time</span><span class="o">=</span>14.6 ms
</span></code></pre></td></tr></table></div></figure>


<p>Set the service to start on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>strongswan
</span></code></pre></td></tr></table></div></figure>


<p>Then your VPN should be setup correctly.</p>

<h2>Other useful commands:</h2>

<p>Start / Stop / Status:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo ipsec up connection-name
</span><span class='line'><span class="nv">$ </span>sudo ipsec down connection-name
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sudo ipsec restart
</span><span class='line'><span class="nv">$ </span>sudo ipsec status
</span><span class='line'><span class="nv">$ </span>sudo ipsec statusall
</span></code></pre></td></tr></table></div></figure>


<p>Get the Policies and States of the IPsec Tunnel:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo ip xfrm state
</span><span class='line'><span class="nv">$ </span>sudo ip xfrm policy
</span></code></pre></td></tr></table></div></figure>


<p>Reload the secrets, while the service is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo ipsec rereadsecrets
</span></code></pre></td></tr></table></div></figure>


<p>Check if traffic flows through the tunnel:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo tcpdump esp
</span></code></pre></td></tr></table></div></figure>


<h2>Adding more connections to your config:</h2>

<p>If you have to add another site to your config, the example of the <code>ipsec.secrets</code> will look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/ipsec.secrets
</span><span class='line'>51.15.139.201 51.15.44.48 : PSK <span class="s2">&quot;87zRQqylaoeF5I8o4lRhwvmUzf+pYdDpsCOlesIeFA/2xrtxKXJTbCPZgqplnXgPX5uprL+aRgxD8ua7MmdWaQ&quot;</span>
</span><span class='line'>51.15.139.201 51.15.87.41  : PSK <span class="s2">&quot;87zRQqylaoeF5I8o4lRhwvmUzf+pYdDpsCOlesIeFA/2xrtxKXJTbCPZgqplnXgPX5uprL+aRgxD8ua7MmdWaQ&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the <code>ipsec.conf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat /etc/ipsec.conf
</span><span class='line'><span class="c"># basic configuration</span>
</span><span class='line'>config setup
</span><span class='line'>        <span class="nv">charondebug</span><span class="o">=</span><span class="s2">&quot;all&quot;</span>
</span><span class='line'>        <span class="nv">uniqueids</span><span class="o">=</span>yes
</span><span class='line'>        <span class="nv">strictcrlpolicy</span><span class="o">=</span>no
</span><span class='line'>
</span><span class='line'><span class="c"># connection to amsterdam datacenter</span>
</span><span class='line'>conn paris-to-amsterdam
</span><span class='line'>  <span class="nv">authby</span><span class="o">=</span>secret
</span><span class='line'>  <span class="nv">left</span><span class="o">=</span>%defaultroute
</span><span class='line'>  <span class="nv">leftid</span><span class="o">=</span>51.15.139.201
</span><span class='line'>  <span class="nv">leftsubnet</span><span class="o">=</span>10.10.27.161/32
</span><span class='line'>  <span class="nv">right</span><span class="o">=</span>51.15.44.48
</span><span class='line'>  <span class="nv">rightsubnet</span><span class="o">=</span>10.9.141.97/32
</span><span class='line'>  <span class="nv">ike</span><span class="o">=</span>aes256-sha2_256-modp1024!
</span><span class='line'>  <span class="nv">esp</span><span class="o">=</span>aes256-sha2_256!
</span><span class='line'>  <span class="nv">keyingtries</span><span class="o">=</span>0
</span><span class='line'>  <span class="nv">ikelifetime</span><span class="o">=</span>1h
</span><span class='line'>  <span class="nv">lifetime</span><span class="o">=</span>8h
</span><span class='line'>  <span class="nv">dpddelay</span><span class="o">=</span>30
</span><span class='line'>  <span class="nv">dpdtimeout</span><span class="o">=</span>120
</span><span class='line'>  <span class="nv">dpdaction</span><span class="o">=</span>restart
</span><span class='line'>  <span class="nv">auto</span><span class="o">=</span>start
</span><span class='line'>
</span><span class='line'><span class="c"># connection to frankfurt datacenter</span>
</span><span class='line'>conn paris-to-frankfurt
</span><span class='line'>  <span class="nv">authby</span><span class="o">=</span>secret
</span><span class='line'>  <span class="nv">left</span><span class="o">=</span>%defaultroute
</span><span class='line'>  <span class="nv">leftid</span><span class="o">=</span>51.15.139.201
</span><span class='line'>  <span class="nv">leftsubnet</span><span class="o">=</span>10.10.27.1/24
</span><span class='line'>  <span class="nv">right</span><span class="o">=</span>51.15.87.41
</span><span class='line'>  <span class="nv">rightsubnet</span><span class="o">=</span>10.9.137.1/24
</span><span class='line'>  <span class="nv">ike</span><span class="o">=</span>aes256-sha2_256-modp1024!
</span><span class='line'>  <span class="nv">esp</span><span class="o">=</span>aes256-sha2_256!
</span><span class='line'>  <span class="nv">keyingtries</span><span class="o">=</span>0
</span><span class='line'>  <span class="nv">ikelifetime</span><span class="o">=</span>1h
</span><span class='line'>  <span class="nv">lifetime</span><span class="o">=</span>8h
</span><span class='line'>  <span class="nv">dpddelay</span><span class="o">=</span>30
</span><span class='line'>  <span class="nv">dpdtimeout</span><span class="o">=</span>120
</span><span class='line'>  <span class="nv">dpdaction</span><span class="o">=</span>restart
</span><span class='line'>  <span class="nv">auto</span><span class="o">=</span>start
</span></code></pre></td></tr></table></div></figure>


<p>Just remember to configure the config on the Frankfurt VPN Gateway, and the example of the status output will look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo ipsec status
</span><span class='line'>Security Associations <span class="o">(</span><span class="m">2</span> up, <span class="m">0</span> connecting<span class="o">)</span>:
</span><span class='line'>paris-to-frankfurt<span class="o">[</span>2<span class="o">]</span>: ESTABLISHED <span class="m">102</span> seconds ago, 10.10.27.161<span class="o">[</span>51.15.139.201<span class="o">]</span>...51.15.87.41<span class="o">[</span>51.15.87.41<span class="o">]</span>
</span><span class='line'>paris-to-frankfurt<span class="o">{</span>1<span class="o">}</span>:  INSTALLED, TUNNEL, reqid 2, ESP in UDP SPIs: cbc62a1f_i c95b8f78_o
</span><span class='line'>paris-to-frankfurt<span class="o">{</span>1<span class="o">}</span>:   10.10.27.1/24 <span class="o">===</span> 10.9.137.1/24
</span><span class='line'>paris-to-amsterdam<span class="o">[</span>1<span class="o">]</span>: ESTABLISHED <span class="m">102</span> seconds ago, 10.10.27.161<span class="o">[</span>51.15.139.201<span class="o">]</span>...51.15.44.48<span class="o">[</span>51.15.44.48<span class="o">]</span>
</span><span class='line'>paris-to-amsterdam<span class="o">{</span>2<span class="o">}</span>:  INSTALLED, TUNNEL, reqid 1, ESP in UDP SPIs: c7b36756_i cc54053c_o
</span><span class='line'>paris-to-amsterdam<span class="o">{</span>2<span class="o">}</span>:   10.10.27.1/24 <span class="o">===</span> 10.9.141.1/24
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/01/30/authenticate-to-your-aws-mysql-rds-instance-via-iam/">Authenticate to Your AWS MySQL RDS Instance via IAM</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-01-30T17:02:05+02:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>5:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>On Amazon Web Services with RDS for MySQL or Aurora with MySQL compatibility, you can authenticate to your Database instance or cluster using IAM for database authentication. The benefit of using this authentication method is that you don&rsquo;t need to use a password when you connect to your database, but you use your authentication token instead</p>

<p><em>Update:</em>
- <a href="https://aws.amazon.com/about-aws/whats-new/2018/09/amazon-rds-postgresql-now-supports-iam-authentication/">Amazon Supports IAM Authentication for PostgreSQL</a></p>

<ul>
<li>More info from their <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.Connecting.html">docs</a></li>
</ul>


<h2>What we will be doing today:</h2>

<p>We will do the following:</p>

<ul>
<li>Create RDS MySQL Database</li>
<li>Create IAM Policy that allows a user to connect via a MySQL User</li>
<li>Create IAM User and associate IAM Policy</li>
<li>Configure the new user credentials in the awscli credential provider</li>
<li>Bash script to generate the auth token and authenticate to RDS via Token instead of password</li>
</ul>


<h2>Create the RDS Database:</h2>

<p>In this tutorial I will spin up a <code>db.t2.micro</code> in <code>eu-west-1</code> with <code>IAMDatabaseAuthentication Enabled</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>aws rds create-db-instance <span class="se">\</span>
</span><span class='line'>    --db-instance-identifier rbtest <span class="se">\</span>
</span><span class='line'>    --db-instance-class db.t2.micro <span class="se">\</span>
</span><span class='line'>    --engine MySQL <span class="se">\</span>
</span><span class='line'>    --allocated-storage <span class="m">20</span> <span class="se">\</span>
</span><span class='line'>    --master-username dbadmin <span class="se">\</span>
</span><span class='line'>    --master-user-password mysuperpassword <span class="se">\</span>
</span><span class='line'>    --region eu-west-1 <span class="se">\</span>
</span><span class='line'>    --enable-iam-database-authentication
</span></code></pre></td></tr></table></div></figure>


<p>Give it some time to spin up, then get your database endpoint:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws rds describe-db-instances --db-instance-identifier rbtest <span class="p">|</span> jq -r <span class="s2">&quot;.DBInstances[].Endpoint.Address&quot;</span>
</span><span class='line'>rbtest.abcdefgh.eu-west-1.rds.amazonaws.com
</span></code></pre></td></tr></table></div></figure>


<p>If you need to have SSL Enabled, get the bundled certificate as described in the <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL.html">Using SSL with RDS</a> docs.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget -O /tmp/rds.pem https://s3.amazonaws.com/rds-downloads/rds-combined-ca-bundle.pem
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Database Account:</h2>

<p>Create the database account on the MySQL RDS instance as described from their <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.DBAccounts.html">docs</a>. IAM handles the authentication via AWSAuthenticationPlugin, therefore we do not need to set passwords on the database.</p>

<p>Connect to the database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mysql -u dbadmin -h rbtest.abcdefgh.eu-west-1.rds.amazonaws.com -p
</span></code></pre></td></tr></table></div></figure>


<p>Create the database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">USER</span> <span class="n">mydbaccount</span> <span class="n">IDENTIFIED</span> <span class="k">WITH</span> <span class="n">AWSAuthenticationPlugin</span> <span class="k">AS</span> <span class="s1">&#39;RDS&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the Databases and Granting Permissions</h2>

<p>While you are on the database, create 2 databases (<code>db1</code> and <code>db2</code>) with some tables, which we will use for our user to have read only access to, and create one database (<code>db3</code>) which the user will not have access to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">db1</span><span class="p">;</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">db2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">db1</span><span class="p">;</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">foo</span> <span class="p">(</span><span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">age</span> <span class="nb">INT</span><span class="p">);</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;ruan&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;james&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">db2</span><span class="p">;</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">foo</span> <span class="p">(</span><span class="k">location</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">));</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;south africa&#39;</span><span class="p">);</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;new zealand&#39;</span><span class="p">);</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;australia&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">grant</span> <span class="k">select</span> <span class="k">on</span> <span class="n">db1</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">&#39;mydbuser&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">grant</span> <span class="k">select</span> <span class="k">on</span> <span class="n">db2</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">&#39;mydbuser&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">db3</span><span class="p">;</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">db3</span><span class="p">;</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">foo</span> <span class="p">(</span><span class="n">passwords</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">));</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;superpassword&#39;</span><span class="p">);</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;sekret&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="k">privileges</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>IAM Permissions to allow our user to authenticate to our RDS.</h2>

<p>First to create the user and configure awscli tools. My default profile has administrative access, so we will create our db user in its own profile and configure our awscli tools with its new access key and secret key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws configure --profile dbuser
</span><span class='line'>AWS Access Key ID <span class="o">[</span>None<span class="o">]</span>: xxxxxxxxxxxxx
</span><span class='line'>AWS Secret Access Key <span class="o">[</span>None<span class="o">]</span>: xxxxxxxxxxxxxxxxxx
</span><span class='line'>Default region name <span class="o">[</span>None<span class="o">]</span>: eu-west-1
</span><span class='line'>Default output format <span class="o">[</span>None<span class="o">]</span>: json
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to create a IAM policy to allow our user to authenticate to our RDS Instance via IAM, which we will associate with our Users account.</p>

<p>We need the AWS Account ID, the Database Identifier Resource ID, and the User Account that we created on MySQL.</p>

<p>To get the DB ResourceId:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws rds describe-db-instances --db-instance-identifier rbtest <span class="p">|</span> jq -r <span class="err">&quot;</span>.DBInstances<span class="o">[]</span>.DbiResourceId
</span><span class='line'>db-123456789ABCDEFGH
</span></code></pre></td></tr></table></div></figure>


<p>Create the IAM Policy and associate it with the new user account:</p>

<ul>
<li><a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.IAMPolicy.html">More info from the Docs</a>:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>           <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;RDSIAMAUTH&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>             <span class="s2">&quot;rds-db:connect&quot;</span>
</span><span class='line'>         <span class="p">],</span>
</span><span class='line'>         <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>             <span class="s2">&quot;arn:aws:rds-db:eu-west-1:123456789012:dbuser:db-123456789ABCDEFGH/mydbaccount&quot;</span>
</span><span class='line'>         <span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The bash script will get the authentication token which will be used as the password. Note that the authentication token will expire after 15 minutes after creation. The <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.Connecting.html">docs</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nv">db_endpoint</span><span class="o">=</span><span class="s2">&quot;rbtest.abcdefgh.eu-west-1.rds.amazonaws.com&quot;</span>
</span><span class='line'><span class="nv">local_mysql_user</span><span class="o">=</span><span class="s2">&quot;mydbaccount&quot;</span>
</span><span class='line'><span class="nv">auth_token</span><span class="o">=</span><span class="s2">&quot;$(aws --profile dbuser rds generate-db-auth-token --hostname ${RDSHOST} --port 3306 --username ${local_mysql_user} )&quot;</span>
</span><span class='line'>mysql --host<span class="o">=</span><span class="k">${</span><span class="nv">db_endpoint</span><span class="k">}</span> --port<span class="o">=</span><span class="m">3306</span> --enable-cleartext-plugin --user<span class="o">=</span><span class="k">${</span><span class="nv">local_mysql_user</span><span class="k">}</span> --password<span class="o">=</span><span class="k">${</span><span class="nv">auth_token</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing it out:</h2>

<p>Now that our policies are in place, credentials from the credential provider has been set and our bash script is setup, lets connect to our database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./conn-mysql.sh
</span><span class='line'>
</span><span class='line'>mysql&gt; show databases<span class="p">;</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> Database           <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> information_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> db1                <span class="p">|</span>
</span><span class='line'><span class="p">|</span> db2                <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="m">3</span> rows in <span class="nb">set</span> <span class="o">(</span>0.16 sec<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>mysql&gt; <span class="k">select</span> * from db2.foo<span class="p">;</span>
</span><span class='line'>+--------------+
</span><span class='line'><span class="p">|</span> location     <span class="p">|</span>
</span><span class='line'>+--------------+
</span><span class='line'><span class="p">|</span> south africa <span class="p">|</span>
</span><span class='line'><span class="p">|</span> new zealand  <span class="p">|</span>
</span><span class='line'><span class="p">|</span> australia    <span class="p">|</span>
</span><span class='line'>+--------------+
</span><span class='line'>
</span><span class='line'>mysql&gt; <span class="k">select</span> * from db3.foo<span class="p">;</span>
</span><span class='line'>ERROR <span class="m">1044</span> <span class="o">(</span>42000<span class="o">)</span>: Access denied <span class="k">for</span> user <span class="s1">&#39;mydbaccount&#39;</span>@<span class="s1">&#39;*&#39;</span> to database <span class="s1">&#39;db3&#39;</span>
</span><span class='line'>
</span><span class='line'>mysql&gt; create database test123<span class="p">;</span>
</span><span class='line'>ERROR <span class="m">1044</span> <span class="o">(</span>42000<span class="o">)</span>: Access denied <span class="k">for</span> user <span class="s1">&#39;mydbaccount&#39;</span>@<span class="s1">&#39;%&#39;</span> to database <span class="s1">&#39;test123&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Changing the IAM Policy to revoke access:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./conn-mysql.sh
</span><span class='line'>mysql: <span class="o">[</span>Warning<span class="o">]</span> Using a password on the <span class="nb">command </span>line interface can be insecure.
</span><span class='line'>ERROR <span class="m">1045</span> <span class="o">(</span>28000<span class="o">)</span>: Access denied <span class="k">for</span> user <span class="s1">&#39;mydbaccount&#39;</span>@<span class="s1">&#39;10.0.0.10&#39;</span> <span class="o">(</span>using password: YES<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating a MySQL Client Wrapper Script:</h2>

<p>Using bash we can create a wrapper script so we can connect to our database like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mysql-iam prod rbtest.eu-west-1.amazonaws.com mydbaccount
</span><span class='line'>mysql&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Here is the script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Wrapper MySQL Client for IAM Based Authentication for MySQL and Amazon Aurora on RDS</span>
</span><span class='line'><span class="c"># Read: https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.html</span>
</span><span class='line'><span class="c"># Usage: [app] [aws_profile] [rds_endpoint] [rds_mysql_username]</span>
</span><span class='line'>
</span><span class='line'>command_exists<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span> <span class="s2">&quot;$1&quot;</span> <span class="p">&amp;</span>&gt; /dev/null <span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>check_required_parameters<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">aws_profile</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
</span><span class='line'>  <span class="nv">rds_hostname</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>
</span><span class='line'>  <span class="nv">rds_username</span><span class="o">=</span><span class="s2">&quot;$3&quot;</span>
</span><span class='line'>  <span class="k">if</span> ! <span class="o">[[</span> -n <span class="s2">&quot;$aws_profile&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;$rds_username&quot;</span> <span class="o">&amp;&amp;</span> -n <span class="s2">&quot;$rds_username&quot;</span> <span class="o">]]</span>
</span><span class='line'>    <span class="k">then</span>
</span><span class='line'>      <span class="nb">echo</span> <span class="s2">&quot;Error: Missing Parameters&quot;</span>
</span><span class='line'>      <span class="nb">echo</span> <span class="s2">&quot;Expected: $0 aws_profile_name rds_endpoint_name rds_db_username&quot;</span>
</span><span class='line'>      <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 prod dbname.eu-west-1.amazonaws.com dba&quot;</span>
</span><span class='line'>      <span class="nb">exit </span>1
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>get_auth_token<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">aws_bin</span><span class="o">=</span><span class="k">$(</span>which aws <span class="p">|</span> head -1<span class="k">)</span>
</span><span class='line'>  <span class="nv">auth_token</span><span class="o">=</span><span class="s2">&quot;$($aws_bin --profile $aws_profile rds generate-db-auth-token --hostname $rds_hostname --port 3306 --username $rds_username )&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>connect_to_rds<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">mysql_bin</span><span class="o">=</span><span class="k">$(</span>which mysql <span class="p">|</span> head -1<span class="k">)</span>
</span><span class='line'>  <span class="k">${</span><span class="nv">mysql_bin</span><span class="k">}</span> --host<span class="o">=</span><span class="k">${</span><span class="nv">rds_hostname</span><span class="k">}</span> --port<span class="o">=</span><span class="m">3306</span> --enable-cleartext-plugin --user<span class="o">=</span><span class="k">${</span><span class="nv">rds_username</span><span class="k">}</span> --password<span class="o">=</span><span class="k">${</span><span class="nv">auth_token</span><span class="k">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$1&quot;</span> <span class="o">==</span> <span class="s2">&quot;help&quot;</span> <span class="o">]</span>
</span><span class='line'>  <span class="k">then</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;Help&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;Expected: $0 aws_profile_name rds_endpoint_name rds_db_username&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;Usage: $0 prod dbname.eu-west-1.amazonaws.com dba_user&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>0
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> command_exists aws <span class="o">&amp;&amp;</span> command_exists mysql
</span><span class='line'><span class="k">then</span>
</span><span class='line'>  check_required_parameters <span class="nv">$1</span> <span class="nv">$2</span> <span class="nv">$3</span>
</span><span class='line'>  get_auth_token
</span><span class='line'>  connect_to_rds
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;Error: Make sure aws-cli and mysql client is installed&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>For more information on this, have a look at the <a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.IAMDBAuth.html">docs</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/20">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/18">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/02/04/run-localstack-as-a-service-container-for-aws-mock-services-on-drone-ci/">Run Localstack as a Service Container for AWS Mock Services on Drone CI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/02/04/run-kubernetes-k3s-as-a-service-container-on-drone-ci/">Run Kubernetes (K3s) as a Service Container on Drone CI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/02/04/setup-gitea-and-drone-on-docker-2020-edition/">Setup Gitea and Drone on Docker 2020 Edition</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/02/01/setup-thanos-on-docker-a-highly-available-prometheus/">Setup Thanos on Docker: A Highly Available Prometheus</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/24/save-output-to-local-file-with-ansible/">Save Output to Local File With Ansible</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>T-Shirts</h1>
  <ul id=""></ul>
  <p></p>
<div id='product-component-1575492115972'></div>
<script type="text/javascript">
/*<![CDATA[*/
(function () {
  var scriptURL = 'https://sdks.shopifycdn.com/buy-button/latest/buy-button-storefront.min.js';
  if (window.ShopifyBuy) {
    if (window.ShopifyBuy.UI) {
      ShopifyBuyInit();
    } else {
      loadScript();
    }
  } else {
    loadScript();
  }
  function loadScript() {
    var script = document.createElement('script');
    script.async = true;
    script.src = scriptURL;
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(script);
    script.onload = ShopifyBuyInit;
  }
  function ShopifyBuyInit() {
    var client = ShopifyBuy.buildClient({
      domain: 'bekkerclothing.com',
      storefrontAccessToken: '68eb29a6d90539cb0321ea90bb043fae',
    });
    ShopifyBuy.UI.onReady(client).then(function (ui) {
      ui.createComponent('product', {
        id: '4392613544020',
        node: document.getElementById('product-component-1575492115972'),
        moneyFormat: '%24%7B%7Bamount%7D%7D',
        options: {
  "product": {
    "styles": {
      "product": {
        "@media (min-width: 601px)": {
          "max-width": "calc(25% - 20px)",
          "margin-left": "20px",
          "margin-bottom": "50px"
        }
      }
    },
    "text": {
      "button": "Add to cart"
    }
  },
  "productSet": {
    "styles": {
      "products": {
        "@media (min-width: 601px)": {
          "margin-left": "-20px"
        }
      }
    }
  },
  "modalProduct": {
    "contents": {
      "img": false,
      "imgWithCarousel": true,
      "button": false,
      "buttonWithQuantity": true
    },
    "styles": {
      "product": {
        "@media (min-width: 601px)": {
          "max-width": "100%",
          "margin-left": "0px",
          "margin-bottom": "0px"
        }
      }
    },
    "text": {
      "button": "Add to cart"
    }
  },
  "cart": {
    "text": {
      "total": "Subtotal",
      "button": "Checkout"
    }
  }
},
      });
    });
  }
})();
/*]]>*/
</script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
