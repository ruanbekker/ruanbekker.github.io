
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In this tutorial we will develop our own Discord bot using Python. The source code for this bot will be stored in my github repository About the bot &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/posts/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script async defer data-website-id="2cfa7c36-c1f7-48fd-949c-2e5e8a1d873d" src="https://umami-analytics.ruan.dev/umami.js"></script>

  <!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1100086574264181"
     crossorigin="anonymous"></script>

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/05/05/create-a-discord-bot-in-python/">Create a Discord Bot in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-05-05T04:32:12-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>4:32 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/166907630-cfd0760e-ddff-46b4-9b82-f163fb90f0ee.png" alt="discord-logo" /></p>

<p>In this tutorial we will develop our own <strong><a href="https://discord.com/">Discord</a></strong> bot using <strong>Python</strong>.</p>

<p>The source code for this bot will be stored in my <a href="https://github.com/ruanbekker/discord-minecraft-python-bot">github repository</a></p>

<h2>About the bot</h2>

<p>First we will create a basic discord bot that will greet the message sender, and then we will create a Minecraft Bot, that will enable us to do the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>:: Bot Usage ::
</span><span class='line'>!mc help          : shows help
</span><span class='line'>!mc serverusage   : shows system load in percentage
</span><span class='line'>!mc serverstatus  : shows if the server is online or offline
</span><span class='line'>!mc whoisonline   : shows who is online at the moment</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s get into it.</p>

<h2>Dependencies</h2>

<p>Create a python virtual environment and install the dependent packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python3 -m virtualenv .venv
</span><span class='line'>$ source .venv/bin/activate
</span><span class='line'>$ pip install discord
</span><span class='line'>$ pip install python-dotenv</span></code></pre></td></tr></table></div></figure>


<h2>Create the Discord Application</h2>

<p>We first need to create the application on discord and retrieve a token that our python app will require.</p>

<p>Create a application on discord:</p>

<ul>
<li><a href="https://discordapp.com/developers/applications">https://discordapp.com/developers/applications</a></li>
</ul>


<p>You should see:</p>

<p><img width="1782" alt="image" src="https://user-images.githubusercontent.com/567298/165783157-0747c6f1-af2d-434a-9e3f-1e554f7e69ef.png"></p>

<p>Click &ldquo;New Application&rdquo; and provide it a name:</p>

<p><img width="478" alt="image" src="https://user-images.githubusercontent.com/567298/165783246-68899cd9-c796-41a9-ae9d-88764a83ec0d.png"></p>

<p>Once you create the application you will get a screen to upload a logo, provide a description and most importantly get your application id as well as your public key:</p>

<p><img src="https://user-images.githubusercontent.com/567298/165911250-0fd11a0b-b851-4d65-a898-7049dd73aa60.png" alt="image" /></p>

<p>Then select the Bot section:</p>

<p><img width="1756" alt="image" src="https://user-images.githubusercontent.com/567298/165911940-a85498bd-d572-455b-b38a-50114e6b4144.png"></p>

<p>Then select &ldquo;Add Bot&rdquo;:</p>

<p><img width="717" alt="image" src="https://user-images.githubusercontent.com/567298/165912066-6cd72b29-e0fe-4c4f-b73d-269e48da61d6.png"></p>

<p>Select OAuth2 and select the &ldquo;bot&rdquo; scope:</p>

<p><img width="1751" alt="image" src="https://user-images.githubusercontent.com/567298/165912862-a51a9f29-d876-4ba7-b226-be78214c934d.png"></p>

<p>At the bottom of the page it will provide you with a URL that looks something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://discord.com/api/oauth2/authorize?client_id=xxxxxxxxxxx&permissions=0&scope=bot</span></code></pre></td></tr></table></div></figure>


<p>Paste the link in your browser and authorize the bot to your server of choice:</p>

<p><img src="https://user-images.githubusercontent.com/567298/165917380-6e8fbbed-9237-4017-a8bd-c27d58bcdc6d.png" alt="image" /></p>

<p>Then click authorize, and you should see your bot appearing on Discord:</p>

<p><img src="https://user-images.githubusercontent.com/567298/165917760-d8c132e9-18d4-4428-b551-c895d4a5102c.png" alt="image" /></p>

<h2>Developing the Discord Bot</h2>

<p>Now we will be building our python discord bot, head back to the &ldquo;Bot&rdquo; section and select &ldquo;Reset Token&rdquo;, then copy and store the token value to a file <code>.env</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DISCORD_TOKEN=xxxxxxxxx</span></code></pre></td></tr></table></div></figure>


<p>So in our current working directory, we should have a file <code>.env</code> with the following content:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat .env
</span><span class='line'>DISCORD_TOKEN=your-unique-token-value-will-be-here</span></code></pre></td></tr></table></div></figure>


<p>For this demonstration, I will create a private channel in discord called <code>minecraft-test</code> and add the bot <code>MinecraftBot</code> to the channel (this is only for testing, after testing you can add your bot to your other channels for other people to use):</p>

<p><img src="https://user-images.githubusercontent.com/567298/166233812-2596960b-5142-4ad1-809e-96d884ea5c58.png" alt="image" /></p>

<p>For our first test, a basic bot, where we would like to type <code>hello</code> and the bot should greet us by our username, in our <code>mc_discord_bot.py</code> file we will have:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">discord</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span class='line'>
</span><span class='line'><span class="n">BOT_NAME</span> <span class="o">=</span> <span class="s">&quot;MinecraftBot&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">load_dotenv</span><span class="p">()</span>
</span><span class='line'><span class="n">DISCORD_TOKEN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;DISCORD_TOKEN&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">bot</span> <span class="o">=</span> <span class="n">discord</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@bot.event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">on_ready</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;{bot.user} has logged in.&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@bot.event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">bot</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="s">&#39;hello&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">message</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;Hey {message.author}&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="s">&#39;goodbye&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">message</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;Goodbye {message.author}&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">bot</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">DISCORD_TOKEN</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then run the bot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python</span> <span class="n">mc_discord_bot</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="n">MinecraftBot</span> <span class="n">has</span> <span class="n">logged</span> <span class="ow">in</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>And when we type <code>hello</code> and <code>goodbye</code> you can see our bot responds on those values:</p>

<p><img src="https://user-images.githubusercontent.com/567298/166235388-7240a66c-2be4-4343-8f36-398077c4fcf6.png" alt="image" /></p>

<p>Now that we tested our bot, we can clear the <code>mc_discord_bot.py</code> and write our minecraft bot, the requirements of this bot is simple, but we would like the following:</p>

<ul>
<li>use the command <code>!mc</code> to trigger our bot and subcommands for what we want</li>
<li>able to see who is playing minecraft on our server at the moment</li>
<li>able to get the status if the minecraft server is online</li>
<li>able to get the server load percentage (as the bot runs on the minecraft server)</li>
</ul>


<p>This is our complete <code>mc_discord_bot.py</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">discord</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">discord.ext</span> <span class="kn">import</span> <span class="n">commands</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">multiprocessing</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Variables</span>
</span><span class='line'><span class="n">BOT_NAME</span> <span class="o">=</span> <span class="s">&quot;MinecraftBot&quot;</span>
</span><span class='line'><span class="n">load_dotenv</span><span class="p">()</span>
</span><span class='line'><span class="n">DISCORD_TOKEN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;DISCORD_TOKEN&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">minecraft_server_url</span> <span class="o">=</span> <span class="s">&quot;lightmc.fun&quot;</span> <span class="c"># this is just an example, and you should use your own minecraft server</span>
</span><span class='line'>
</span><span class='line'><span class="n">bot_help_message</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">:: Bot Usage ::</span>
</span><span class='line'><span class="s">`!mc help`                   : shows help</span>
</span><span class='line'><span class="s">`!mc serverusage`   : shows system load in percentage</span>
</span><span class='line'><span class="s">`!mc serverstatus` : shows if the server is online or offline</span>
</span><span class='line'><span class="s">`!mc whoisonline`   : shows who is online at the moment</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">available_commands</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;help&#39;</span><span class="p">,</span> <span class="s">&#39;serverusage&#39;</span><span class="p">,</span> <span class="s">&#39;serverstatus&#39;</span><span class="p">,</span> <span class="s">&#39;whoisonline&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Set the bot command prefix</span>
</span><span class='line'><span class="n">bot</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">Bot</span><span class="p">(</span><span class="n">command_prefix</span><span class="o">=</span><span class="s">&quot;!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Executes when the bot is ready</span>
</span><span class='line'><span class="nd">@bot.event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">on_ready</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;{bot.user} succesfully logged in!&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Executes whenever there is an incoming message event</span>
</span><span class='line'><span class="nd">@bot.event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;Guild: {message.guild.name}, User: {message.author}, Message: {message.content}&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">bot</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="s">&#39;!mc&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">message</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bot_help_message</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;whosonline&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;{message.author} used {message.content}&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">process_commands</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Executes when the command mc is used and we trigger specific functions</span>
</span><span class='line'><span class="c"># when specific arguments are caught in our if statements</span>
</span><span class='line'><span class="nd">@bot.command</span><span class="p">()</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">mc</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s">&#39;help&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bot_help_message</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s">&#39;serverusage&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
</span><span class='line'>        <span class="n">one</span><span class="p">,</span> <span class="n">five</span><span class="p">,</span> <span class="n">fifteen</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getloadavg</span><span class="p">()</span>
</span><span class='line'>        <span class="n">load_percentage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">five</span> <span class="o">/</span> <span class="n">cpu_count</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;Server load is at {load_percentage}%&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s">&#39;serverstatus&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;https://api.mcsrvstat.us/2/{minecraft_server_url}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span class='line'>        <span class="n">server_status</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;online&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">server_status</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>            <span class="n">server_status</span> <span class="o">=</span> <span class="s">&#39;online&#39;</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;Server is {server_status}&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s">&#39;whoisonline&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;https://api.mcsrvstat.us/2/{minecraft_server_url}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span class='line'>        <span class="n">players_status</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;players&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">players_status</span><span class="p">[</span><span class="s">&#39;online&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>            <span class="n">players_online_message</span> <span class="o">=</span> <span class="s">&#39;No one is online&#39;</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">players_status</span><span class="p">[</span><span class="s">&#39;online&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>            <span class="n">players_online_username</span> <span class="o">=</span> <span class="n">players_status</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>            <span class="n">players_online_message</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;1 player is online: {players_online_username}&#39;</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">players_status</span><span class="p">[</span><span class="s">&#39;online&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span class='line'>            <span class="n">po</span> <span class="o">=</span> <span class="n">players_status</span><span class="p">[</span><span class="s">&#39;online&#39;</span><span class="p">]</span>
</span><span class='line'>            <span class="n">players_online_usernames</span> <span class="o">=</span> <span class="n">players_status</span><span class="p">[</span><span class="s">&#39;list&#39;</span><span class="p">]</span>
</span><span class='line'>            <span class="n">joined_usernames</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">players_online_usernames</span><span class="p">)</span>
</span><span class='line'>            <span class="n">players_online_message</span> <span class="o">=</span> <span class="n">f</span><span class="s">&#39;{po} players are online: {joined_usernames}&#39;</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">ctx</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">f</span><span class="s">&#39;{players_online_message}&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">bot</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">DISCORD_TOKEN</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now we can start our bot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python mc_discord_bot.py
</span></code></pre></td></tr></table></div></figure>


<p>And we can run our help command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>!mc <span class="nb">help</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which will prompt our help message, and then test out the others:</p>

<p><img src="https://user-images.githubusercontent.com/567298/166237617-c2df1dd1-99bc-4558-8eb8-b1159e850836.png" alt="image" /></p>

<h2>Resources</h2>

<p>Thank you to the following authors, which really helped me doing this:</p>

<ul>
<li><a href="https://www.freecodecamp.org/news/create-a-discord-bot-with-python/">https://www.freecodecamp.org/news/create-a-discord-bot-with-python/</a></li>
<li><a href="https://betterprogramming.pub/coding-a-discord-bot-with-python-64da9d6cade7">https://betterprogramming.pub/coding-a-discord-bot-with-python-64da9d6cade7</a></li>
<li><a href="https://dev.to/codesphere/create-a-discord-bot-in-minutes-with-python-2jgp">https://dev.to/codesphere/create-a-discord-bot-in-minutes-with-python-2jgp</a></li>
</ul>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>

<p>The source code for this bot will be stored in my github repository:
- <a href="https://github.com/ruanbekker/discord-minecraft-python-bot">https://github.com/ruanbekker/discord-minecraft-python-bot</a></p>

<p>I&rsquo;ve started a brand new Discord server, not much happening at the moment, but planning to share and distribute tech content and a place for like minded people to hang out. If that&rsquo;s something you are interested in, feel free to join on <strong><a href="https://discord.gg/bPmc4Stchd">this link</a></strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/04/19/publish-and-use-your-ansible-role-from-git/">Publish and Use Your Ansible Role From Git</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-04-19T04:35:09-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>4:35 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will be creating a ansible role, publish our ansible role to github, then we will install the role locally and create a ansible playbook to use the ansible role.</p>

<p>The source code for this blog post will be available on my <a href="https://blog.ruanbekker.com/blog/2022/04/19/publish-and-use-your-ansible-role-from-git/">github</a> repository.</p>

<h2>Ansible Installation</h2>

<p>Create a virtual environment with Python:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virtualenv .venv -p python3
</span><span class='line'>$ source .venv/bin/activate</span></code></pre></td></tr></table></div></figure>


<p>Install ansible with pip:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip install ansible==4.4.0</span></code></pre></td></tr></table></div></figure>


<p>Now that we have ansible installed, we can create our role.</p>

<h2>Initialize Ansible Role</h2>

<p>A Ansible Role consists of a couple of files, and using <code>ansible-galaxy</code> makes it easy initializing a boilerplate structure to begin with::</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ansible-galaxy init --init-path roles ssh_config
</span><span class='line'>- Role ssh_config was created successfully</span></code></pre></td></tr></table></div></figure>


<p>The role that we created is named <code>ssh_config</code> and will be placed under the directory <code>roles</code> under our current working directory.</p>

<h2>Define Role Tasks</h2>

<p>Create the dummy task under <code>roles/ssh_config/tasks/main.yml</code>:</p>

<script src="https://gist.github.com/ruanbekker/4971be45476915ba877bb444a9ff1c0b.js"></script>


<p>Then define the defaults environment values in the file <code>roles/ssh_config/defaults/main.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="c1"># defaults file for ssh_config</span>
</span><span class='line'><span class="l-Scalar-Plain">ssh_port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">22</span>
</span></code></pre></td></tr></table></div></figure>


<p>The value of <code>ssh_port</code> will default to <code>22</code> if we don&rsquo;t define it in our variables.</p>

<h2>Commit to Git</h2>

<p>The assumption is made here that you already created a git repository and that your access is sorted. Add the files and commit it to git:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ git add .</span>
</span><span class='line'><span class="l-Scalar-Plain">$ git commit -m &quot;Your message&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">$ git push origin main</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now your ansible role should be commited and visible in git.</p>

<h2>SSH Config Client Side</h2>

<p>I will be referencing the git source url via SSH, and since I am using my default ssh key, the ssh config isn&rsquo;t really needed, but if you are using a different version control system, with different ports or different ssh keys, the following ssh config snippet may be useful:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ cat ~/.ssh/config</span>
</span><span class='line'><span class="l-Scalar-Plain">Host github.com</span>
</span><span class='line'>    <span class="l-Scalar-Plain">User git</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Port 22</span>
</span><span class='line'>    <span class="l-Scalar-Plain">IdentityFile ~/.ssh/id_rsa</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you won&rsquo;t be using SSH as the source url in your ansible setup for your role, you can skip the SSH setup.</p>

<h2>Installing the Ansible Role from Git</h2>

<p>When installing roles, ansible installs them by default under: <code>~/.ansible/roles</code>, <code>/usr/share/ansible/roles</code> or <code>/etc/ansible/roles</code>.</p>

<p>From our previous steps, we still have the ansible role content locally (not under the default installed directory), so by saying installing the role kinda sounds like we are doing double the work. But the intention is that you have your ansible role centralized and versioned on git, and on new servers or workstations where you want to consume the role from, that specific role, won&rsquo;t be present on that source.</p>

<p>To install the role from Git, we need to populate the <code>requirements.yml</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ mkdir ~/my-project</span>
</span><span class='line'><span class="l-Scalar-Plain">$ cd ~/my-project</span>
</span></code></pre></td></tr></table></div></figure>


<p>The requirements file is used to define where our role is located, which version and the type of version control, the <code>requirements.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ssh_config</span>
</span><span class='line'>    <span class="l-Scalar-Plain">src</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ssh://git@github.com/ruanbekker/ansible-demo-role.git</span>
</span><span class='line'>    <span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">main</span>
</span><span class='line'>    <span class="l-Scalar-Plain">scm</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git</span>
</span></code></pre></td></tr></table></div></figure>


<p>For other variations of using the requirements file, you can have a look at their <a href="https://galaxy.ansible.com/docs/using/installing.html#installing-multiple-roles-from-a-file">documentation</a></p>

<p>Then install the ansible role from our requirements file (I have used <code>--force</code> to overwrite my current one while testing):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ ansible-galaxy install -r requirements.yml --force</span>
</span><span class='line'><span class="l-Scalar-Plain">Starting galaxy role install process</span>
</span><span class='line'><span class="l-Scalar-Plain">- changing role ssh_config from main to main</span>
</span><span class='line'><span class="l-Scalar-Plain">- extracting ssh_config to /Users/ruan/.ansible/roles/ssh_config</span>
</span><span class='line'><span class="l-Scalar-Plain">- ssh_config (main) was installed successfully</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Ansible Playbook</h2>

<p>Define the ansible playbook to use the role that we installed from git, in a file called <code>playbook.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'>  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh_config</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ssh_port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2202</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the ansible playbook:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ ansible-playbook playbook.yml</span>
</span><span class='line'><span class="l-Scalar-Plain">PLAY [localhost] *********************************************************************************************</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [Gathering Facts] ***************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">TASK [ssh_config</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Dummy task] *******************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">ok</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">localhost</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">=&gt; {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">&quot;msg&quot;</span><span class="p-Indicator">:</span> <span class="s">&quot;This</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">dummy</span><span class="nv"> </span><span class="s">task</span><span class="nv"> </span><span class="s">changing</span><span class="nv"> </span><span class="s">ssh</span><span class="nv"> </span><span class="s">port</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">2202.&quot;</span>
</span><span class='line'><span class="err">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">PLAY RECAP ***************************************************************************************************</span>
</span><span class='line'><span class="l-Scalar-Plain">localhost</span>                  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/04/16/provision-a-aws-ec2-instance-with-terraform/">Provision a AWS EC2 Instance With Terraform</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-04-16T19:04:08-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>7:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial I will demonstrate how to use Terraform (a Infrastructure as Code Tool), to provision a AWS EC2 Instance and the source code that we will be using in this tutorial will be published to my <a href="https://github.com/ruanbekker/terraformfiles/tree/master/aws-ec2-instance">terraformfiles github repository</a>.</p>

<h2>Requirements</h2>

<p>To follow along this tutorial, you will need an AWS Account and Terraform installed</p>

<h2>Terraform</h2>

<p>To install Terraform for your operating system, you can follow <a href="https://learn.hashicorp.com/tutorials/terraform/install-cli">Terraform Installation Documentation</a>, I am using Mac OSx, so for me it will be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew tap hashicorp/tap
</span><span class='line'>brew install hashicorp/tap/terraform
</span></code></pre></td></tr></table></div></figure>


<p>To verify the installation, we can run <code>terraform version</code> and my output shows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Terraform v1.1.8
</span><span class='line'>on darwin_amd64
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform Project Structure</h2>

<p>Create the directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir terraform-aws-ec2
</span><span class='line'><span class="nb">cd </span>terraform-aws-ec2
</span></code></pre></td></tr></table></div></figure>


<p>Create the following files: <code>main.tf</code>, <code>providers.tf</code>, <code>variables.tf</code>, <code>outputs.tf</code>, <code>locals.tf</code> and <code>terraform.tfvars</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>touch main.tf providers.tf variables.tf outputs.tf locals.tf terraform.tfvars
</span></code></pre></td></tr></table></div></figure>


<h2>Define Terraform Configuration Code</h2>

<p>First we need to define the aws provider, which we will do in <code>providers.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">aws</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;~&gt; 3.27&quot;</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;hashicorp/aws&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;aws&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">region</span>  <span class="o">=</span> <span class="s2">&quot;eu-west-1&quot;</span>
</span><span class='line'>  <span class="nv">profile</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
</span><span class='line'>  <span class="nv">shared_credentials_file</span> <span class="o">=</span> <span class="s2">&quot;~/.aws/credentials&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will notice that I am defining my profile name <code>default</code> from the <code>~/.aws/credentials</code> credential provider in order for terraform to authenticate with AWS.</p>

<p>Next I am defining the <code>main.tf</code> which will be the file where we define our aws resources:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>data <span class="s2">&quot;aws_ami&quot;</span> <span class="s2">&quot;latest_ubuntu&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">most_recent</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">owners</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;099720109477&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  filter <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>   <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
</span><span class='line'>    <span class="nv">values</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;ubuntu/images/hvm-ssd/ubuntu-focal-20.04-*-server-*&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  filter <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>   <span class="o">=</span> <span class="s2">&quot;virtualization-type&quot;</span>
</span><span class='line'>    <span class="nv">values</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;hvm&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  filter <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>   <span class="o">=</span> <span class="s2">&quot;root-device-type&quot;</span>
</span><span class='line'>    <span class="nv">values</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;ebs&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  filter <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>   <span class="o">=</span> <span class="s2">&quot;architecture&quot;</span>
</span><span class='line'>    <span class="nv">values</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;x86_64&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;aws_iam_policy_document&quot;</span> <span class="s2">&quot;assume_role_policy&quot;</span> <span class="o">{</span>
</span><span class='line'>  statement <span class="o">{</span>
</span><span class='line'>    <span class="nv">actions</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;sts:AssumeRole&quot;</span><span class="o">]</span>
</span><span class='line'>    principals <span class="o">{</span>
</span><span class='line'>      <span class="nb">type</span>        <span class="o">=</span> <span class="s2">&quot;Service&quot;</span>
</span><span class='line'>      <span class="nv">identifiers</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;ec2.amazonaws.com&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;aws_iam_policy&quot;</span> <span class="s2">&quot;ec2_read_only_access&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">arn</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_iam_role&quot;</span> <span class="s2">&quot;ec2_access_role&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>               <span class="o">=</span> <span class="s2">&quot;${local.project_name}-ec2-role&quot;</span>
</span><span class='line'>  <span class="nv">assume_role_policy</span> <span class="o">=</span> data.aws_iam_policy_document.assume_role_policy.json
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_iam_policy_attachment&quot;</span> <span class="s2">&quot;readonly_role_policy_attach&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>       <span class="o">=</span> <span class="s2">&quot;${local.project_name}-ec2-role-attachment&quot;</span>
</span><span class='line'>  <span class="nv">roles</span>      <span class="o">=</span> <span class="o">[</span>aws_iam_role.ec2_access_role.name<span class="o">]</span>
</span><span class='line'>  <span class="nv">policy_arn</span> <span class="o">=</span> data.aws_iam_policy.ec2_read_only_access.arn
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_iam_instance_profile&quot;</span> <span class="s2">&quot;instance_profile&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>  <span class="o">=</span> <span class="s2">&quot;${local.project_name}-ec2-instance-profile&quot;</span>
</span><span class='line'>  <span class="nv">role</span> <span class="o">=</span> aws_iam_role.ec2_access_role.name
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_security_group&quot;</span> <span class="s2">&quot;ec2&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">name</span>        <span class="o">=</span> <span class="s2">&quot;${local.project_name}-ec2-sg&quot;</span>
</span><span class='line'>    <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;${local.project_name}-ec2-sg&quot;</span>
</span><span class='line'>    <span class="nv">vpc_id</span>      <span class="o">=</span> var.vpc_id
</span><span class='line'>
</span><span class='line'>    <span class="nv">tags</span> <span class="o">=</span> merge<span class="o">(</span>
</span><span class='line'>      var.default_tags,
</span><span class='line'>      <span class="o">{</span>
</span><span class='line'>       <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&quot;${local.project_name}-ec2-sg&quot;</span>
</span><span class='line'>      <span class="o">}</span>,
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_security_group_rule&quot;</span> <span class="s2">&quot;ssh&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">description</span>       <span class="o">=</span> <span class="s2">&quot;allows public ssh access to ec2&quot;</span>
</span><span class='line'>    <span class="nv">security_group_id</span> <span class="o">=</span> aws_security_group.ec2.id
</span><span class='line'>    <span class="nb">type</span>              <span class="o">=</span> <span class="s2">&quot;ingress&quot;</span>
</span><span class='line'>    <span class="nv">protocol</span>          <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>
</span><span class='line'>    <span class="nv">from_port</span>         <span class="o">=</span> 22
</span><span class='line'>    <span class="nv">to_port</span>           <span class="o">=</span> 22
</span><span class='line'>    <span class="nv">cidr_blocks</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_security_group_rule&quot;</span> <span class="s2">&quot;egress&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">description</span>       <span class="o">=</span> <span class="s2">&quot;allows egress&quot;</span>
</span><span class='line'>    <span class="nv">security_group_id</span> <span class="o">=</span> aws_security_group.ec2.id
</span><span class='line'>    <span class="nb">type</span>              <span class="o">=</span> <span class="s2">&quot;egress&quot;</span>
</span><span class='line'>    <span class="nv">protocol</span>          <span class="o">=</span> <span class="s2">&quot;-1&quot;</span>
</span><span class='line'>    <span class="nv">from_port</span>         <span class="o">=</span> 0
</span><span class='line'>    <span class="nv">to_port</span>           <span class="o">=</span> 0
</span><span class='line'>    <span class="nv">cidr_blocks</span>       <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_instance&quot;</span> <span class="s2">&quot;ec2&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">ami</span>                         <span class="o">=</span> data.aws_ami.latest_ubuntu.id
</span><span class='line'>  <span class="nv">instance_type</span>               <span class="o">=</span> var.instance_type
</span><span class='line'>  <span class="nv">subnet_id</span>                   <span class="o">=</span> var.subnet_id
</span><span class='line'>  <span class="nv">key_name</span>                    <span class="o">=</span> var.ssh_keyname
</span><span class='line'>  <span class="nv">vpc_security_group_ids</span>      <span class="o">=</span> <span class="o">[</span>aws_security_group.ec2.id<span class="o">]</span>
</span><span class='line'>  <span class="nv">associate_public_ip_address</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">monitoring</span>                  <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nb">  </span><span class="nv">iam_instance_profile</span>        <span class="o">=</span> aws_iam_instance_profile.instance_profile.name
</span><span class='line'>
</span><span class='line'>  lifecycle <span class="o">{</span>
</span><span class='line'>    <span class="nv">ignore_changes</span>            <span class="o">=</span> <span class="o">[</span>subnet_id, ami<span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  root_block_device <span class="o">{</span>
</span><span class='line'>      <span class="nv">volume_type</span>           <span class="o">=</span> <span class="s2">&quot;gp2&quot;</span>
</span><span class='line'>      <span class="nv">volume_size</span>           <span class="o">=</span> var.ebs_root_size_in_gb
</span><span class='line'>      <span class="nv">encrypted</span>             <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="nb">      </span><span class="nv">delete_on_termination</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">tags</span> <span class="o">=</span> merge<span class="o">(</span>
</span><span class='line'>    var.default_tags,
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>     <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&quot;${local.project_name}&quot;</span>
</span><span class='line'>    <span class="o">}</span>,
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A couple of things are defined here:</p>

<ul>
<li>A data resource to fetch the latest Ubuntu 20.04 AMI</li>
<li>The IAM Role and Policy that we will use to associate to our EC2 Instance Profile</li>
<li>The EC2 Security Group</li>
<li>The EC2 Instance</li>
<li>The VPC ID and Subnet ID are required variables which we will set in <code>terraform.tfvars</code></li>
</ul>


<p>The next file will be our <code>variables.tf</code> file where we will define all our variable definitions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>variable <span class="s2">&quot;default_tags&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">Environment</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
</span><span class='line'>    <span class="nv">Owner</span>       <span class="o">=</span> <span class="s2">&quot;ruan.bekker&quot;</span>
</span><span class='line'>    <span class="nv">Project</span>     <span class="o">=</span> <span class="s2">&quot;terraform-blogpost&quot;</span>
</span><span class='line'>    <span class="nv">CostCenter</span>  <span class="o">=</span> <span class="s2">&quot;engineering&quot;</span>
</span><span class='line'>    <span class="nv">ManagedBy</span>   <span class="o">=</span> <span class="s2">&quot;terraform&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;aws_region&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">default</span>     <span class="o">=</span> <span class="s2">&quot;eu-west-1&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;the region to use in aws&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;vpc_id&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;the vpc to use&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;ssh_keyname&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;ssh key to use&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;subnet_id&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;the subnet id where the ec2 instance needs to be placed in&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;instance_type&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">default</span>     <span class="o">=</span> <span class="s2">&quot;t3.nano&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;the instance type to use&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;project_id&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">default</span>     <span class="o">=</span> <span class="s2">&quot;terraform-blogpost&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;the project name&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;ebs_root_size_in_gb&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> number
</span><span class='line'>  <span class="nv">default</span>     <span class="o">=</span> 10
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;the size in GB for the root disk&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;environment_name&quot;</span> <span class="o">{</span>
</span><span class='line'>   <span class="nb">type</span>    <span class="o">=</span> string
</span><span class='line'>   <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;dev&quot;</span>
</span><span class='line'>   <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;the environment this resource will go to (assumption being made theres one account)&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next file is our <code>locals.tf</code> which just concatenates our project id and environment name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>locals <span class="o">{</span>
</span><span class='line'>  <span class="nv">project_name</span> <span class="o">=</span> <span class="s2">&quot;${var.project_id}-${var.environment_name}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then our <code>outputs.tf</code> for the values that terraform should output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>output <span class="s2">&quot;id&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;The ec2 instance id&quot;</span>
</span><span class='line'>  <span class="nv">value</span>       <span class="o">=</span> aws_instance.ec2.id
</span><span class='line'>  <span class="nv">sensitive</span>   <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;The ec2 instance public ip address&quot;</span>
</span><span class='line'>  <span class="nv">value</span>       <span class="o">=</span> aws_instance.ec2.public_ip
</span><span class='line'>  <span class="nv">sensitive</span>   <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;subnet_id&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;the subnet id which will be used&quot;</span>
</span><span class='line'>  <span class="nv">value</span>       <span class="o">=</span> var.subnet_id
</span><span class='line'>  <span class="nv">sensitive</span>   <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then lastly our <code>terraform.tfvars</code>, which you will need to supply your own values to match your AWS Account:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># required</span>
</span><span class='line'><span class="nv">vpc_id</span> <span class="o">=</span> <span class="s2">&quot;vpc-063d7xxxxxxxxxxxx&quot;</span>
</span><span class='line'><span class="nv">ssh_keyname</span> <span class="o">=</span> <span class="s2">&quot;ireland-key&quot;</span>
</span><span class='line'><span class="nv">subnet_id</span> <span class="o">=</span> <span class="s2">&quot;subnet-04b3xxxxxxxxxxxxx&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy EC2 Instance</h2>

<p>Now that all our configuration is in place, we need to intialize terraform by downloading the providers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Once the terraform init has completed, we can run a <code>terraform plan</code> which will show us what terraform will do. Since the <code>terraform.tfvars</code> are the default file for variables, we don&rsquo;t have to specify the name of the file, but since I want to be excplicit, I will include it (should you want to change the file name):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform plan -var-file<span class="o">=</span><span class="s2">&quot;terraform.tfvars&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now it&rsquo;s a good time to review what terraform wants to action by viewing the plan output, once you are happy you can deploy the changes by running a <code>terraform apply</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform apply -var-file<span class="o">=</span><span class="s2">&quot;terraform.tfvars&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Optional: You can override variables by either updating the <code>terraform.tfvars</code> or you can append them with terraform apply <code>-var-file="terraform.tfvars" -var="ssh_key=default_key"</code>, a successful output should show something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Outputs:
</span><span class='line'><span class="nv">id</span> <span class="o">=</span> <span class="s2">&quot;i-0dgacxxxxxxxxxxxx&quot;</span>
</span><span class='line'><span class="nv">ip</span> <span class="o">=</span> <span class="s2">&quot;18.26.xxx.92&quot;</span>
</span><span class='line'><span class="nv">subnet</span> <span class="o">=</span> <span class="s2">&quot;subnet-04b3xxxxxxxxxxxxx&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Access your EC2 Instance</h2>

<p>You can access the instance by SSH'ing to the IP that was returned by the output as well as the SSH key name that you provided, or you can make use of the <code>terraform output</code> to access the output value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ssh -i ~/.ssh/id_rsa ubuntu@<span class="k">$(</span>terraform output -raw ip<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Cleanup</h2>

<p>To delete the infrastructure that Terraform provisioned:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform destroy
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/03/29/matrix-bot-using-simplematrixbotlib-in-python/">Matrix Bot Using SimpleMatrixBotlib in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-03-29T18:50:43-04:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>6:50 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will setup a python bot for our matrix chat server. We will only do a couple of basic commands, so that you have a solid base to build from.</p>

<h2>Matrix Server</h2>

<p>In our <a href="https://blog.ruanbekker.com/blog/2022/03/29/setup-matrix-and-element-chat-server/">previous post</a> we&rsquo;ve setup a matrix and element server, so if you are following along, head over to that post to setup your matrix server before continuing.</p>

<h2>Matrix Python Bot</h2>

<p>We will be using <a href="https://simple-matrix-bot-lib.readthedocs.io/en/latest/index.html">simple-matrix-bot-lib</a> as our bot, so first we need to install it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python3 -m pip install simplematrixbotlib
</span><span class='line'>python3 -m pip install requests
</span></code></pre></td></tr></table></div></figure>


<p>We will need to authenticate with a user, so I will create a dedicated bot user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it matrix_synapse_1 bash
</span><span class='line'>&gt; register_new_matrix_user -c /data/homeserver.yaml http://localhost:8008
</span><span class='line'>
</span><span class='line'>New user localpart <span class="o">[</span>root<span class="o">]</span>: bot
</span><span class='line'>Password:
</span><span class='line'>Confirm password:
</span><span class='line'>Make admin <span class="o">[</span>no<span class="o">]</span>: no
</span><span class='line'>Sending registration request...
</span><span class='line'>Success!
</span></code></pre></td></tr></table></div></figure>


<p>The most basic bot is the echo bot, which just returns your message:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">subprocess</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">simplematrixbotlib</span> <span class="kn">as</span> <span class="nn">botlib</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">ssl</span><span class="p">,</span> <span class="n">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">smtplib</span>
</span><span class='line'>
</span><span class='line'><span class="n">MATRIX_URL</span><span class="o">=</span><span class="s">&quot;https://matrix.foodmain.co.za&quot;</span>
</span><span class='line'><span class="n">MATRIX_USER</span><span class="o">=</span><span class="s">&quot;@foobot:matrix.foodmain.co.za&quot;</span>
</span><span class='line'><span class="n">MATRIX_PASS</span><span class="o">=</span><span class="s">&quot;foo&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">creds</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">Creds</span><span class="p">(</span><span class="n">MATRIX_URL</span><span class="p">,</span> <span class="n">MATRIX_USER</span><span class="p">,</span> <span class="n">MATRIX_PASS</span><span class="p">)</span>
</span><span class='line'><span class="n">bot</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">Bot</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">PREFIX</span> <span class="o">=</span> <span class="s">&#39;!&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Help</span>
</span><span class='line'><span class="nd">@bot.listener.on_message_event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span class='line'>    <span class="n">match</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">MessageMatch</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">PREFIX</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">is_not_from_this_bot</span><span class="p">()</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">prefix</span><span class="p">()</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&quot;help&quot;</span><span class="p">):</span>
</span><span class='line'>        <span class="n">help_message</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">        Help:</span>
</span><span class='line'><span class="s">         - !help</span>
</span><span class='line'><span class="s">        Echo</span>
</span><span class='line'><span class="s">         - !echo your message</span>
</span><span class='line'><span class="s">        &quot;&quot;&quot;</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">send_markdown_message</span><span class="p">(</span><span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">,</span> <span class="n">help_message</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Echo</span>
</span><span class='line'><span class="nd">@bot.listener.on_message_event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Example function that &quot;echoes&quot; arguements.</span>
</span><span class='line'><span class="sd">    Usage:</span>
</span><span class='line'><span class="sd">    user:  !echo say something</span>
</span><span class='line'><span class="sd">    bot:   say something</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">match</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">MessageMatch</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">PREFIX</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">is_not_from_this_bot</span><span class="p">()</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">prefix</span><span class="p">()</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&quot;echo&quot;</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Room: {r}, User: {u}, Message: {m}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">send_text_message</span><span class="p">(</span><span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">args</span><span class="p">()))</span>
</span><span class='line'>
</span><span class='line'><span class="n">bot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run the bot, invite the bot user to a room and test it with <code>!echo hi</code></p>

<p>For a bot having to use the requests library, such as getting a quote from an api, we can use the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">subprocess</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">simplematrixbotlib</span> <span class="kn">as</span> <span class="nn">botlib</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">ssl</span><span class="p">,</span> <span class="n">socket</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">smtplib</span>
</span><span class='line'>
</span><span class='line'><span class="n">MATRIX_URL</span><span class="o">=</span><span class="s">&quot;https://matrix.foodmain.co.za&quot;</span>
</span><span class='line'><span class="n">MATRIX_USER</span><span class="o">=</span><span class="s">&quot;@foobot:matrix.foodmain.co.za&quot;</span>
</span><span class='line'><span class="n">MATRIX_PASS</span><span class="o">=</span><span class="s">&quot;foo&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">creds</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">Creds</span><span class="p">(</span><span class="n">MATRIX_URL</span><span class="p">,</span> <span class="n">MATRIX_USER</span><span class="p">,</span> <span class="n">MATRIX_PASS</span><span class="p">)</span>
</span><span class='line'><span class="n">bot</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">Bot</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">PREFIX</span> <span class="o">=</span> <span class="s">&#39;!&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Help</span>
</span><span class='line'><span class="nd">@bot.listener.on_message_event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span class='line'>    <span class="n">match</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">MessageMatch</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">PREFIX</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">is_not_from_this_bot</span><span class="p">()</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">prefix</span><span class="p">()</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&quot;help&quot;</span><span class="p">):</span>
</span><span class='line'>        <span class="n">help_message</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">        Help:</span>
</span><span class='line'><span class="s">         - !help</span>
</span><span class='line'><span class="s">        Echo</span>
</span><span class='line'><span class="s">         - !echo msg</span>
</span><span class='line'><span class="s">        Fortune:</span>
</span><span class='line'><span class="s">         - !fortune</span>
</span><span class='line'><span class="s">        Quote:</span>
</span><span class='line'><span class="s">         - !quote</span>
</span><span class='line'><span class="s">        &quot;&quot;&quot;</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">send_markdown_message</span><span class="p">(</span><span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">,</span> <span class="n">help_message</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Echo</span>
</span><span class='line'><span class="nd">@bot.listener.on_message_event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">    Example function that &quot;echoes&quot; arguements.</span>
</span><span class='line'><span class="sd">    Usage:</span>
</span><span class='line'><span class="sd">    user: !echo say something</span>
</span><span class='line'><span class="sd">    bot:  say something</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">match</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">MessageMatch</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">PREFIX</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">is_not_from_this_bot</span><span class="p">()</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">prefix</span><span class="p">()</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&quot;echo&quot;</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Room: {r}, User: {u}, Message: {m}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">send_text_message</span><span class="p">(</span><span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">args</span><span class="p">()))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Fortune</span>
</span><span class='line'><span class="nd">@bot.listener.on_message_event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">fortune</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span class='line'>    <span class="n">match</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">MessageMatch</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">bot</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">is_not_from_this_bot</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;!fortune&#39;</span><span class="p">):</span>
</span><span class='line'>        <span class="n">fortune</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s">&#39;/usr/games/fortune&#39;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="n">fortune</span><span class="p">)</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">send_text_message</span><span class="p">(</span><span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">,</span> <span class="n">fortune</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Quotes</span>
</span><span class='line'><span class="nd">@bot.listener.on_message_event</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">quote</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span class='line'>    <span class="n">match</span> <span class="o">=</span> <span class="n">botlib</span><span class="o">.</span><span class="n">MessageMatch</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">bot</span><span class="p">,</span> <span class="n">PREFIX</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">is_not_from_this_bot</span><span class="p">()</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">prefix</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span>
</span><span class='line'>            <span class="n">match</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&quot;quote&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">match</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&quot;q&quot;</span><span class="p">)):</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;https://goquotes-api.herokuapp.com/api/v1/random?count=1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">&#39;quotes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>        <span class="n">quote</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;text&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="n">author</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="n">tag</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;tag&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="n">formatted_message</span> <span class="o">=</span> <span class="n">f</span><span class="s">&quot;&quot;&quot;{quote}</span>
</span><span class='line'><span class="s">        - {author}</span>
</span><span class='line'><span class="s">        &quot;&quot;&quot;</span>
</span><span class='line'>        <span class="c">#await bot.api.send_text_message(room.room_id, formatted_message)</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">bot</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">send_markdown_message</span><span class="p">(</span><span class="n">room</span><span class="o">.</span><span class="n">room_id</span><span class="p">,</span>  <span class="n">formatted_message</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">bot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p>For more information, have a look at their <a href="https://simple-matrix-bot-lib.readthedocs.io/en/latest/index.html">documentation</a></p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/03/29/setup-matrix-and-element-chat-server/">Setup Matrix and Element Chat Server</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-03-29T18:33:49-04:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>6:33 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will setup a Matrix and Element Chat Server using Docker on Ubuntu.</p>

<h2>What is Matrix?</h2>

<p>Matrix is an open standard and communication protocol for secure, decentralised, real-time communication. For more information on Matrix, see their <a href="https://matrix.org/">website</a></p>

<h2>Install Docker</h2>

<p>I will assume that docker and docker compose is installed, if not, follow this resource to install them:
- <a href="https://docs.docker.com/get-docker/">https://docs.docker.com/get-docker/</a></p>

<h2>Install Matrix Server</h2>

<p>Create the directory structure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create --driver<span class="o">=</span>bridge --subnet<span class="o">=</span>10.10.10.0/24 --gateway<span class="o">=</span>10.10.10.1 matrix_net
</span><span class='line'><span class="nv">$ </span>mkdir matrix
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>matrix/
</span></code></pre></td></tr></table></div></figure>


<p>The <code>docker-compose.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.8&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">element</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vectorim/element-web:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./element-config.json:/app/config.json</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ipv4_address</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10.10.10.3</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">synapse</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">matrixdotorg/synapse:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ipv4_address</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10.10.10.4</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./synapse:/data</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">postgres</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres:11</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unless-stopped</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ipv4_address</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10.10.10.2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./postgresdata:/var/lib/postgresql/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_DB=synapse</span>
</span><span class='line'>     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_USER=synapse</span>
</span><span class='line'>     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_PASSWORD=STRONGPASSWORD</span>
</span><span class='line'>     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">POSTGRES_INITDB_ARGS=--lc-collate C --lc-ctype C --encoding UTF8</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">matrix</span>
</span></code></pre></td></tr></table></div></figure>


<p>Download a sample config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://develop.element.io/config.json
</span><span class='line'><span class="nv">$ </span>mv config.json element-config.json
</span></code></pre></td></tr></table></div></figure>


<p>And adjust the bits where needed in <code>element-config.json</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;default_server_config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;m.homeserver&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://matrix.domain.co.za&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;server_name&quot;</span><span class="p">:</span> <span class="s2">&quot;matrix.domain.co.za&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;m.identity_server&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;base_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://vector.im&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;brand&quot;</span><span class="p">:</span> <span class="s2">&quot;Element&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;integrations_ui_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://scalar.vector.im/&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;integrations_rest_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://scalar.vector.im/api&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;integrations_widgets_urls&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;https://scalar.vector.im/_matrix/integrations/v1&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;https://scalar.vector.im/api&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;https://scalar-staging.vector.im/_matrix/integrations/v1&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;https://scalar-staging.vector.im/api&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;https://scalar-staging.riot.im/scalar/api&quot;</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;hosting_signup_link&quot;</span><span class="p">:</span> <span class="s2">&quot;https://element.io/matrix-services?utm_source=element-web&amp;utm_medium=web&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;bug_report_endpoint_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://element.io/bugreports/submit&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;uisi_autorageshake_app&quot;</span><span class="p">:</span> <span class="s2">&quot;element-auto-uisi&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;showLabsSettings&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;piwik&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://piwik.riot.im/&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;siteId&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;policyUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;https://element.io/cookie-policy&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;roomDirectory&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;servers&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s2">&quot;matrix.org&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;gitter.im&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;libera.chat&quot;</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;enable_presence_by_hs_url&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;https://matrix.org&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;https://matrix-client.matrix.org&quot;</span><span class="p">:</span> <span class="kc">false</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;terms_and_conditions_links&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://element.io/privacy&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Privacy Policy&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://element.io/cookie-policy&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Cookie Policy&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="nt">&quot;hostSignup&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;brand&quot;</span><span class="p">:</span> <span class="s2">&quot;Element Home&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;cookiePolicyUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;https://element.io/cookie-policy&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;domains&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>          <span class="s2">&quot;matrix.org&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;privacyPolicyUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;https://element.io/privacy&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;termsOfServiceUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;https://element.io/terms-of-service&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ems.element.io/element-home/in-app-loader&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;sentry&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;dsn&quot;</span><span class="p">:</span> <span class="s2">&quot;https://xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxc5@sentry.matrix.org/6&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;environment&quot;</span><span class="p">:</span> <span class="s2">&quot;develop&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;posthog&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;projectApiKey&quot;</span><span class="p">:</span> <span class="s2">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;apiHost&quot;</span><span class="p">:</span> <span class="s2">&quot;https://posthog.hss.element.io&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;features&quot;</span><span class="p">:</span> <span class="p">{},</span>
</span><span class='line'>    <span class="nt">&quot;map_style_url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://api.maptiler.com/maps/streets/style.json?key=xxxxxxxxxxxxx&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Generate the homeserver config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run -it --rm -v <span class="s2">&quot;$HOME/matrix/synapse:/data&quot;</span> -e <span class="nv">SYNAPSE_SERVER_NAME</span><span class="o">=</span>matrix.domain.co.za -e <span class="nv">SYNAPSE_REPORT_STATS</span><span class="o">=</span>yes matrixdotorg/synapse:latest generate
</span></code></pre></td></tr></table></div></figure>


<p>Verify the generated config in <code>synapse/homeserver.yaml</code> (I only changed server name and database):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">server_name</span><span class="p-Indicator">:</span> <span class="s">&quot;matrix.domain.co.za&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">psycopg2</span>
</span><span class='line'>  <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">synapse</span>
</span><span class='line'>    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">STRONGPASSWORD</span>
</span><span class='line'>    <span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">synapse</span>
</span><span class='line'>    <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cp_min</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cp_max</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
</span></code></pre></td></tr></table></div></figure>


<p>Boot the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>


<h2>Caddy Reverse Proxy</h2>

<p>Install caddy as a reverse proxy (includes letsencrypt out of the box):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install -y debian-keyring debian-archive-keyring apt-transport-https
</span><span class='line'><span class="nv">$ </span>curl -1sLf <span class="s1">&#39;https://dl.cloudsmith.io/public/caddy/stable/gpg.key&#39;</span> <span class="p">|</span> sudo tee /etc/apt/trusted.gpg.d/caddy-stable.asc
</span><span class='line'><span class="nv">$ </span>curl -1sLf <span class="s1">&#39;https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt&#39;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/caddy-stable.list
</span><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>apt install caddy -y
</span></code></pre></td></tr></table></div></figure>


<p>Create the <code>/etc/caddy/Caddyfile</code> with the following content:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>matrix.domain.co.za <span class="o">{</span>
</span><span class='line'>        reverse_proxy /_matrix/* 10.10.10.4:8008
</span><span class='line'>        reverse_proxy /_synapse/client/* 10.10.10.4:8008
</span><span class='line'>
</span><span class='line'>        header <span class="o">{</span>
</span><span class='line'>                X-Content-Type-Options nosniff
</span><span class='line'>                Referrer-Policy strict-origin-when-cross-origin
</span><span class='line'>                Strict-Transport-Security <span class="s2">&quot;max-age=63072000; includeSubDomains;&quot;</span>
</span><span class='line'>                Permissions-Policy <span class="s2">&quot;accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), interest-cohort=()&quot;</span>
</span><span class='line'>                X-Frame-Options SAMEORIGIN
</span><span class='line'>                X-XSS-Protection 1
</span><span class='line'>                X-Robots-Tag none
</span><span class='line'>                -server
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>element.domain.co.za <span class="o">{</span>
</span><span class='line'>        encode zstd gzip
</span><span class='line'>        reverse_proxy 10.10.10.3:80
</span><span class='line'>
</span><span class='line'>        header <span class="o">{</span>
</span><span class='line'>                X-Content-Type-Options nosniff
</span><span class='line'>                Referrer-Policy strict-origin-when-cross-origin
</span><span class='line'>                Strict-Transport-Security <span class="s2">&quot;max-age=63072000; includeSubDomains;&quot;</span>
</span><span class='line'>                Permissions-Policy <span class="s2">&quot;accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), interest-cohort=()&quot;</span>
</span><span class='line'>                X-Frame-Options SAMEORIGIN
</span><span class='line'>                X-XSS-Protection 1
</span><span class='line'>                X-Robots-Tag none
</span><span class='line'>                -server
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Change to the <code>/etc/caddy</code> directory then reload:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">pushd</span> /etc/caddy
</span><span class='line'><span class="nv">$ </span>caddy fmt
</span><span class='line'><span class="nv">$ </span>caddy reload
</span><span class='line'><span class="nv">$ </span><span class="nb">popd</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wait a couple of minutes and visit element on <a href="https://element.domain.co.za/">https://element.domain.co.za/</a></p>

<h2>Admin Element User</h2>

<p>Create your admin user on the docker container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it matrix_synapse_1 bash
</span><span class='line'>&gt; register_new_matrix_user -c /data/homeserver.yaml http://localhost:8008
</span><span class='line'>
</span><span class='line'>New user localpart <span class="o">[</span>root<span class="o">]</span>: ruan
</span><span class='line'>Password:
</span><span class='line'>Confirm password:
</span><span class='line'>Make admin <span class="o">[</span>no<span class="o">]</span>: yes
</span><span class='line'>Sending registration request...
</span><span class='line'>Success!
</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<p>Thanks to <a href="https://cyberhost.uk/element-matrix-setup/">cyberhost.uk</a> for credit on helping me with this post.</p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/03/22/load-environment-variables-from-file-in-python/">Load Environment Variables From File in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-03-22T07:34:11-04:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2022</span></span> <span class='time'>7:34 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this quick tutorial we will demonstrate how to load additional environment variables from file into your python application.</p>

<p>It loads key value pairs from a file and append it to its current runtime environment variables, so your current environment is unaffected.</p>

<h2>python-dotenv</h2>

<p>We will make use of the package <a href="https://pypi.org/project/python-dotenv">python-dotenv</a> so we will need to install the python package with pip:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python3 -m pip install python-dotenv
</span></code></pre></td></tr></table></div></figure>


<h2>The env file</h2>

<p>I will create the <code>.env</code> in my current working directory with the content:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">APPLICATION_NAME</span><span class="o">=</span>foo
</span><span class='line'><span class="nv">APPLICATION_OWNER</span><span class="o">=</span>bar
</span></code></pre></td></tr></table></div></figure>


<h2>The application</h2>

<p>This is a basic demonstration of a python application which loads the additional environment variables from file, then we will use <code>json.dumps(.., indent=2)</code> so that we can get a pretty print of all our environment variables:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span class='line'>
</span><span class='line'><span class="n">load_dotenv</span><span class="p">(</span><span class="s">&#39;.env&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When we run the application the output will look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;SHELL&quot;</span><span class="p">:</span> <span class="s2">&quot;/bin/bash&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;PWD&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/ubuntu/env-vars&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;LOGNAME&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;HOME&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;LANG&quot;</span><span class="p">:</span> <span class="s2">&quot;C.UTF-8&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;TERM&quot;</span><span class="p">:</span> <span class="s2">&quot;xterm-256color&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;USER&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;LC_CTYPE&quot;</span><span class="p">:</span> <span class="s2">&quot;C.UTF-8&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;PATH&quot;</span><span class="p">:</span> <span class="s2">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;SSH_TTY&quot;</span><span class="p">:</span> <span class="s2">&quot;/dev/pts/0&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;OLDPWD&quot;</span><span class="p">:</span> <span class="s2">&quot;/home/ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;APPLICATION_NAME&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;APPLICATION_OWNER&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we can see our two environment variables was added to the environment. If you would like to access your two environment variables, we can do the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
</span><span class='line'>
</span><span class='line'><span class="n">load_dotenv</span><span class="p">(</span><span class="s">&#39;.env&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">APPLICATION_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APPLICATION_NAME&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">APPLICATION_OWNER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;APPLICATION_OWNER&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&#39;Name: {0}, Owner: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">APPLICATION_NAME</span><span class="p">,</span> <span class="n">APPLICATION_OWNER</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And when we run that, the output should be the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Name: foo, Owner: bar
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/03/20/run-a-basic-python-flask-restful-api/">Run a Basic Python Flask Restful API</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-03-20T17:33:17-04:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>5:33 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will run a basic api using flask-restful, it will only have two routes which will be a get and post method for the purpose of demonstration.</p>

<h2>What is Flask Restful</h2>

<p><a href="https://flask-restful.readthedocs.io/en/latest/index.html">Flask-RESTful</a> is an extension for <a href="https://flask.palletsprojects.com/en/2.0.x/">Flask</a> that adds support for quickly building REST APIs. It is a lightweight abstraction that works with your existing ORM/libraries. Flask-RESTful encourages best practices with minimal setup.</p>

<p>If you want to see a basic Flask API post, you can follow the link below:
- <a href="https://blog.ruanbekker.com/blog/2018/11/27/python-flask-tutorial-series-create-a-hello-world-app-p1/">https://blog.ruanbekker.com/blog/2018/11/27/python-flask-tutorial-series-create-a-hello-world-app-p1/</a></p>

<h2>Installation</h2>

<p>Install Flask and Flask Restful:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python3 -m pip install flask
</span><span class='line'>python3 -m pip install flask-restful
</span></code></pre></td></tr></table></div></figure>


<h2>Code</h2>

<p>The basic code that we have, is to have two methods available (get and post):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">flask</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">flask_restful</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'><span class="n">api</span> <span class="o">=</span> <span class="n">flask_restful</span><span class="o">.</span><span class="n">Api</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">HelloWorld</span><span class="p">(</span><span class="n">flask_restful</span><span class="o">.</span><span class="n">Resource</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;hello&#39;</span><span class="p">:</span> <span class="s">&#39;world&#39;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>        <span class="n">firstname</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;firstname&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="n">lastname</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s">&#39;lastname&#39;</span><span class="p">]</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">firstname</span><span class="o">=</span><span class="n">firstname</span><span class="p">,</span> <span class="n">lastname</span><span class="o">=</span><span class="n">lastname</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">api</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">HelloWorld</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Run the Server</h2>

<p>Run the server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python api.py
</span></code></pre></td></tr></table></div></figure>


<p>Then make a get request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl http://localhost:5000/
</span></code></pre></td></tr></table></div></figure>


<p>The response should be the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;hello&quot;</span><span class="p">:</span> <span class="s2">&quot;world&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then make a post request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -XPOST http://localhost:5000/ -d <span class="s1">&#39;{&quot;firstname&quot;: &quot;ruan&quot;, &quot;lastname&quot;: &quot;bekker&quot;}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The response should look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;firstname&quot;</span><span class="p">:</span> <span class="s2">&quot;ruan&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;lastname&quot;</span><span class="p">:</span> <span class="s2">&quot;bekker&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Integration Tests</h2>

<p>We can setup integration tests with <code>unittest</code> by creating <code>test_api.py</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">unittest</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">app</span> <span class="kn">as</span> <span class="nn">api</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">TestFlaskApi</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">test_get_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
</span><span class='line'>            <span class="n">response</span><span class="o">.</span><span class="n">get_json</span><span class="p">(),</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&quot;hello&quot;</span><span class="p">:</span> <span class="s">&quot;world&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">test_post_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="c"># request payload</span>
</span><span class='line'>        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span><span class='line'>            <span class="s">&quot;firstname&quot;</span><span class="p">:</span> <span class="s">&quot;ruan&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;lastname&quot;</span><span class="p">:</span> <span class="s">&quot;bekker&quot;</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># make request</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s">&quot;application/json&quot;</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># assert</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&#39;lastname&#39;</span><span class="p">]))</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="c"># delete if anything was created</span>
</span><span class='line'>        <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we can run our test with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python -m unittest discover -p test_app.py -v
</span></code></pre></td></tr></table></div></figure>


<p>Since our first test is expecting <code>{"hello": "world"}</code> our test will pass, and our second test we are validating that our post request returns a 200 response code and that our lastname field is of string type.</p>

<p>The output of our tests will show something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>test_get_request <span class="o">(</span>test_app.TestFlaskApi<span class="o">)</span> ... ok
</span><span class='line'>test_post_request <span class="o">(</span>test_app.TestFlaskApi<span class="o">)</span> ... ok
</span><span class='line'>
</span><span class='line'>----------------------------------------------------------------------
</span><span class='line'>Ran <span class="m">2</span> tests in 0.009s
</span><span class='line'>
</span><span class='line'>OK
</span></code></pre></td></tr></table></div></figure>


<h2>More on Flask-Restful</h2>

<p>This was a very basic example and their <a href="https://flask-restful.readthedocs.io/en/latest/quickstart.html">documentation</a> provides a great tutorial on how to extend from this example. This is also a <a href="https://dev.to/paurakhsharma/flask-rest-api-part-6-testing-rest-apis-4lla">great blogpost</a> on testing rest api&rsquo;s.</p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/03/20/run-openldap-with-a-ui-on-docker/">Run OpenLDAP With a UI on Docker</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-03-20T16:55:39-04:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>4:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will setup two containers, openldap and a openldap ui to manage our users on openldap.</p>

<h2>What is OpenLDAP</h2>

<p>OpenLDAP is an open source implementation of the Lightweight Directory Access Protocol, which makes it possible for organizations to use centralized authentication and directory access services over a network.</p>

<h2>Configuration</h2>

<p>This stack will boot a openldap and openldap-ui container container with the following <code>docker-compose.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.8&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">openldap</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">osixia/openldap:1.5.0</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openldap</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./storage/ldap_db:/var/lib/ldap</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./storage/ldap_config:/etc/ldap/slapd.d</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_ORGANISATION=example-org</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_DOMAIN=example.org</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_ADMIN_PASSWORD=admin</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_CONFIG_PASSWORD=config</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_RFC2307BIS_SCHEMA=true</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_REMOVE_CONFIG_AFTER_SETUP=true</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_TLS_VERIFY_CLIENT=never</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openldap</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">openldap-ui</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wheelybird/ldap-user-manager:v1.5</span>
</span><span class='line'>    <span class="l-Scalar-Plain">container_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openldap-ui</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_URI=ldap://openldap</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_BASE_DN=dc=example,dc=org</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_REQUIRE_STARTTLS=FALSE</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_ADMINS_GROUP=admins</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_ADMIN_BIND_DN=cn=admin,dc=example,dc=org</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_ADMIN_BIND_PWD=admin</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">LDAP_IGNORE_CERT_ERRORS=true</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">NO_HTTPS=TRUE</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">PASSWORD_HASH=SSHA</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">SERVER_HOSTNAME=localhost:18080</span>
</span><span class='line'>    <span class="l-Scalar-Plain">depends_on</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openldap</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">18080:80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openldap</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">openldap</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openldap</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Boot</h2>

<p>Boot the stack with docker-compose:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>


<p>You can access OpenLDAP-UI on port <code>18080</code> and the admin password will be <code>admin</code>. You will have admin access to create users.</p>

<h2>Verify Users</h2>

<p>Access the openldap container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose <span class="nb">exec </span>openldap bash
</span></code></pre></td></tr></table></div></figure>


<p>You can use <code>ldapsearch</code> to verify our user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ldapsearch -x -h openldap -D <span class="s2">&quot;uid=ruan,ou=people,dc=example,dc=org&quot;</span> -b <span class="s2">&quot;ou=people,dc=example,dc=org&quot;</span> -w <span class="s2">&quot;$PASSWORD&quot;</span> -s base <span class="s1">&#39;uid=ruan&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or we can use <code>ldapwhoami</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ldapwhoami -vvv -h ldap://openldap:389 -p <span class="m">389</span> -D <span class="s1">&#39;uid=ruan,ou=people,dc=example,dc=org&#39;</span> -x -w <span class="s2">&quot;$PASSWORD&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which will provide a output with something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ldap_initialize<span class="o">(</span> &lt;DEFAULT&gt; <span class="o">)</span>
</span><span class='line'>dn:uid<span class="o">=</span>ruan,ou<span class="o">=</span>people,dc<span class="o">=</span>example,dc<span class="o">=</span>org
</span><span class='line'>Result: Success <span class="o">(</span>0<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong>, read my <strong><a href="http://digests.ruanbekker.com/?via=ruanbekker-blog">newsletter</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/02/20/create-dns-records-with-terraform-on-cloudflare/">Create DNS Records With Terraform on Cloudflare</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2022-02-20T13:11:06-05:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2022</span></span> <span class='time'>1:11 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will use <strong>Terraform</strong> to create DNS records on <strong>Cloudflare</strong>.</p>

<h2>Installing Terraform</h2>

<p>I will be installing terraform for linux, but you can follow terraform&rsquo;s documentation if you are using a different operating system:
- <a href="https://learn.hashicorp.com/tutorials/terraform/install-cli">https://learn.hashicorp.com/tutorials/terraform/install-cli</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; curl -fsSL https://apt.releases.hashicorp.com/gpg <span class="p">|</span> sudo apt-key add -
</span><span class='line'>&gt; sudo apt-add-repository <span class="s2">&quot;deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main&quot;</span>
</span><span class='line'>&gt; sudo apt update <span class="o">&amp;&amp;</span> sudo apt install terraform -y
</span></code></pre></td></tr></table></div></figure>


<p>Verify that terraform was installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; terraform version
</span><span class='line'>Terraform v1.1.6
</span><span class='line'>on linux_amd64
</span></code></pre></td></tr></table></div></figure>


<h2>Cloudflare Authentication</h2>

<p>We need to create an API Token in order to authenticate terraform to make the required API calls to create the DNS Record.</p>

<p>They have a great post on this, which you can follow below:
- <a href="https://developers.cloudflare.com/api/tokens/create">https://developers.cloudflare.com/api/tokens/create</a></p>

<p>You will need access to &ldquo;Edit DNS Zones&rdquo; and also include the Domain that you would like to edit.</p>

<p>Ensure that you save the API Token in a safe place.</p>

<h2>Terraform Code</h2>

<p>First we will create a project directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; mkdir terraform-cloudflare-dns
</span><span class='line'>&gt; <span class="nb">cd </span>terraform-cloudflare-dns
</span></code></pre></td></tr></table></div></figure>


<p>First we will create the <code>providers.tf</code> which we define our provider and the required parameters for the provider:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>terraform <span class="o">{</span>
</span><span class='line'>  required_providers <span class="o">{</span>
</span><span class='line'>    <span class="nv">cloudflare</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="nb">source</span> <span class="o">=</span> <span class="s2">&quot;cloudflare/cloudflare&quot;</span>
</span><span class='line'>      <span class="nv">version</span> <span class="o">=</span> <span class="s2">&quot;~&gt; 3.0&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>provider <span class="s2">&quot;cloudflare&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">email</span>   <span class="o">=</span> var.cloudflare_email
</span><span class='line'>  <span class="nv">api_token</span> <span class="o">=</span> var.cloudflare_api_token
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, we are referencing <code>email</code> and <code>api_token</code> as variables, therefore we need to define those variables in <code>variables.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>variable <span class="s2">&quot;cloudflare_email&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;clouflare email address&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;cloudflare_api_token&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">type</span>        <span class="o">=</span> string
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;cloudflare api token&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our <code>main.tf</code>, we are first using a data resource to query cloudflare for our domain <code>rbkr.xyz</code> and then access the attribute <code>id</code> which we will be using in our <code>cloudflare_record</code> resource so that it knows which domain to add the DNS record for.</p>

<p>Then we are going to create the A record <code>foobar</code> and provide the value of <code>127.0.0.1</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>data <span class="s2">&quot;cloudflare_zone&quot;</span> <span class="s2">&quot;this&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;rbkr.xyz&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;cloudflare_record&quot;</span> <span class="s2">&quot;foobar&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">zone_id</span> <span class="o">=</span> data.cloudflare_zone.this.id
</span><span class='line'>  <span class="nv">name</span>    <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
</span><span class='line'>  <span class="nv">value</span>   <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span class='line'>  <span class="nb">type</span>    <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
</span><span class='line'>  <span class="nv">proxied</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we are defining our outputs in <code>outputs.tf</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>output <span class="s2">&quot;record&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> cloudflare_record.foobar.hostname
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;metadata&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span>       <span class="o">=</span> cloudflare_record.foobar.metadata
</span><span class='line'>  <span class="nv">sensitive</span>   <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the Record</h2>

<p>Once our configuration code is in place we can run a <code>init</code> which will download the providers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Once that is done, we can run a <code>plan</code> so we can see what will be deployed, but since our <code>variables.tf</code> has no <code>default</code> values, we will either have to define this in <code>terraform.tfvars</code> or use it in-line.</p>

<p>I will be using it in-line for this demonstration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; terraform plan -var <span class="s2">&quot;cloudflare_email=$EMAIL&quot;</span> -var <span class="s2">&quot;cloudflare_api_token=$API_TOKEN&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you are happy, you can run a <code>apply</code> which will deploy the changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; terraform apply -var <span class="s2">&quot;cloudflare_email=$EMAIL&quot;</span> -var <span class="s2">&quot;cloudflare_api_token=$API_TOKEN&quot;</span>
</span><span class='line'>
</span><span class='line'>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span><span class='line'>  + create
</span><span class='line'>
</span><span class='line'>Terraform will perform the following actions:
</span><span class='line'>
</span><span class='line'>  <span class="c"># cloudflare_record.foobar will be created</span>
</span><span class='line'>  + resource <span class="s2">&quot;cloudflare_record&quot;</span> <span class="s2">&quot;foobar&quot;</span> <span class="o">{</span>
</span><span class='line'>      + <span class="nv">allow_overwrite</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">created_on</span>      <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">hostname</span>        <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">id</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">metadata</span>        <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">modified_on</span>     <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">name</span>            <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
</span><span class='line'>      + <span class="nv">proxiable</span>       <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nv">proxied</span>         <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>      + <span class="nv">ttl</span>             <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>      + <span class="nb">type</span>            <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
</span><span class='line'>      + <span class="nv">value</span>           <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span class='line'>      + <span class="nv">zone_id</span>         <span class="o">=</span> <span class="s2">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>Plan: <span class="m">1</span> to add, <span class="m">0</span> to change, <span class="m">0</span> to destroy.
</span><span class='line'>
</span><span class='line'>Changes to Outputs:
</span><span class='line'>  + <span class="nv">metadata</span> <span class="o">=</span> <span class="o">(</span>sensitive value<span class="o">)</span>
</span><span class='line'>  + <span class="nv">record</span>   <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Do you want to perform these actions?
</span><span class='line'>  Terraform will perform the actions described above.
</span><span class='line'>  Only <span class="s1">&#39;yes&#39;</span> will be accepted to approve.
</span><span class='line'>
</span><span class='line'>  Enter a value: yes
</span><span class='line'>
</span><span class='line'>cloudflare_record.foobar: Creating...
</span><span class='line'>cloudflare_record.foobar: Creation <span class="nb">complete </span>after 4s <span class="o">[</span><span class="nv">id</span><span class="o">=</span>xxxxxxxxxxxxxxxxxxxxx<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>Apply <span class="nb">complete</span>! Resources: <span class="m">1</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span><span class='line'>
</span><span class='line'>Outputs:
</span><span class='line'>
</span><span class='line'><span class="nv">metadata</span> <span class="o">=</span> &lt;sensitive&gt;
</span><span class='line'><span class="nv">record</span> <span class="o">=</span> <span class="s2">&quot;foobar.rbkr.xyz&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Test DNS</h2>

<p>We can now test if this is working as expected with a dns utility like dig:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; dig foobar.rbkr.xyz
</span><span class='line'>
</span><span class='line'><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; foobar.rbkr.xyz
</span><span class='line'><span class="p">;;</span> global options: +cmd
</span><span class='line'><span class="p">;;</span> Got answer:
</span><span class='line'><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: 20800
</span><span class='line'><span class="p">;;</span> flags: qr rd ra<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
</span><span class='line'>
</span><span class='line'><span class="p">;;</span> OPT PSEUDOSECTION:
</span><span class='line'><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: 4096
</span><span class='line'><span class="p">;;</span> QUESTION SECTION:
</span><span class='line'><span class="p">;</span>foobar.rbkr.xyz.       IN      A
</span><span class='line'>
</span><span class='line'><span class="p">;;</span> ANSWER SECTION:
</span><span class='line'>foobar.rbkr.xyz. <span class="m">300</span>    IN      A       127.0.0.1
</span><span class='line'>
</span><span class='line'><span class="p">;;</span> Query <span class="nb">time</span>: <span class="m">262</span> msec
</span><span class='line'><span class="p">;;</span> SERVER: 172.31.0.2#53<span class="o">(</span>172.31.0.2<span class="o">)</span>
</span><span class='line'><span class="p">;;</span> WHEN: Wed Feb <span class="m">02</span> 13:57:59 SAST 2022
</span><span class='line'><span class="p">;;</span> MSG SIZE  rcvd: 68
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/12/05/blockchain-basics/">Blockchain Basics</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-12-05T08:12:10-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>8:12 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial, we will cover the <strong>basics of blockchain</strong> and why you would want to run a full-node such as bitcoin, ethereum, etc.</p>

<h2>Blockchain Basics</h2>

<p>Before we start setting up our bitcoin full-node, we first need to get through some blockchain basics, if you already aware of it, you can skip the the setup section of this post.</p>

<h2>Block</h2>

<p>Transaction data is <strong>permanently recorded</strong> into files called <strong>blocks</strong>. You can think of it as a <strong>transaction ledger</strong>. Blocks are organised into a linear sequence over time.</p>

<p>New transactions are <strong>constantly being processed</strong> by <strong>miners</strong> into new blocks which are added to the <strong>end of the chain</strong>. As blocks are buried deeper and deeper into the blockchain they <strong>become harder</strong> and harder to change or remove, this gives rise of <strong><a href="https://en.bitcoin.it/wiki/Irreversible_Transactions">Bitcoin&rsquo;s Irreversible Transactions</a></strong>.</p>

<p>The first block added to the blockchain is referred to as the <strong><a href="https://en.bitcoin.it/wiki/Genesis_block">genesis block</a></strong></p>

<h2>Blockchain</h2>

<p>A blockchain is a transaction database shared by <strong>all nodes participating</strong> in a system based on the bitcoin protocol. A <strong>full copy</strong> of a currency&rsquo;s blockchain contains <strong>every</strong> transaction ever executed in the currency. With this information, one can find out how much value belonged to each address at any point in history.</p>

<p>Every block contains a hash of the previous block. This has the effect of creating a chain of blocks from the genesis block to the current block. <strong>Each block</strong> is guaranteed to come after the <strong>previous block</strong> chronologically because the previous block&rsquo;s hash would otherwise not be known. Each block is also computationally impractical to modify once it has been in the chain for a while because every block after it would also have to be regenerated. <strong>These properties are what make bitcoins transactions irreversible</strong>. The blockchain is the main innovation of Bitcoin.</p>

<h2>Mining</h2>

<p>Mining is the <strong>process</strong> of <strong>adding transaction records</strong> to bitcoin&rsquo;s public ledger of past transactions. The term &ldquo;mining rig&rdquo; is referred to where as a single computer system that performs the necessary computations for &ldquo;mining&rdquo;.</p>

<p>The blockchain serves to confirm transactions to the rest of the network as having taken place. Bitcoin nodes use the blockchain to <strong>distinguish legitimate Bitcoin transactions</strong> from attempts to re-spend coins that have already been spent elsewhere.</p>

<h2>Node</h2>

<p>Any <strong>computer</strong> that connects to the <strong>bitcoin network</strong> is called a <strong>node</strong>. Nodes that fully verify all of the rules of bitcoin are called full nodes. The most popular software implementation of full nodes is called bitcoin-core, its releases can be found on their <strong><a href="https://github.com/bitcoin/bitcoin/releases">github page</a></strong></p>

<h2>What is a Full Node</h2>

<p>A full node is a node (computer system with bitcoin-core running on it) which <strong>downloads every block and transaction</strong> and check them against <strong>bitcoin&rsquo;s consensus rules</strong>. which fully validates transactions and blocks. Almost all full nodes also help the network by accepting transactions and blocks from other full nodes, validating those transactions and blocks, and then relaying them to further full nodes.</p>

<p>Some <strong>examples</strong> of <strong>consensus rules</strong>:</p>

<ul>
<li>Blocks may only <a href="https://en.bitcoin.it/wiki/Controlled_supply">create</a> a certain number of bitcoins. (Currently 6.25 BTC per block.)</li>
<li>Transactions must have correct signatures for the bitcoins being spent.</li>
<li>Transactions/blocks must be in the correct data format.</li>
<li>Within a single <a href="https://en.bitcoin.it/wiki/Block_chain">blockchain</a>, a transaction output cannot be double-spent.</li>
</ul>


<p>At minimum, a full node must download every transaction that has ever taken place, all new transactions, and all block headers. Additionally, full nodes must store information about every unspent transaction output until it is spent.</p>

<p>By default full nodes are inefficient in that they download each new transaction at least twice, and they store the entire block chain (more than 165 GB as of 20180214) forever, even though only the unspent transaction outputs (&lt;2 GB) are required. Performance can improved by enabling <a href="https://bitcointalk.org/index.php?topic=1377345.0">-blocksonly</a> mode and enabling <a href="https://bitcoin.org/en/release/v0.12.0#wallet-pruning">pruning</a></p>

<h2>Archival Nodes</h2>

<p>A subset of full nodes also <strong>accept incoming connections</strong> and <strong>upload old blocks</strong> to other peers on the network. This happens if the software is run with -listen=1 as is default.</p>

<p>Contrary to some popular misconceptions, being an archival node is not necessary to being a full node. If a user&rsquo;s bandwidth is constrained then they can use -listen=0, if their disk space is constrained they can use pruning, all the while still being a fully-validating node that enforces bitcoin&rsquo;s consensus rules and contributing to bitcoin&rsquo;s overall security.</p>

<p>Most information was referenced from <strong><a href="https://en.bitcoin.it/wiki/Full_node">this</a></strong> wiki.</p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/3">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/index.html">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>

<section>
  <h1>Say Hi!</h1>
  Send me a note using the <a href="https://saythanks.io/to/ruanbekker">saythanks.io</a> project.
</section>

<section>
  <h1>Newsletter</h1>
  View my newsletter on <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog" target="_blank">digests.ruanbekker.com</a>
</section>

<section>
  <h1>Cheetsheet Repository</h1>
  Have a look at my <strong>Cheetsheets Github Repository</strong>:
  <p></p>
  <a href="https://github.com/ruanbekker/cheatsheets" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719365-1d8a05e2-a0d3-4078-a84f-c691544e4b8f.png" width="480" height="240"></a>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/07/14/remote-builds-with-docker-contexts/">Remote Builds With Docker Contexts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/29/create-a-raid5-array-with-mdadm-on-linux/">Create a RAID5 Array With Mdadm on Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/23/install-a-specific-python-version-on-ubuntu/">Install a Specific Python Version on Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/15/how-to-persist-iptables-rules-after-reboots/">How to Persist Iptables Rules After Reboots</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/14/how-to-read-and-write-json-data-with-python/">How to Read and Write Json Data With Python</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest elasticsearch cheatsheet in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719853-fe9a50a4-03f2-4a26-a422-0deb946ca09c.png" width="480" height="240"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ruanbekker" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
