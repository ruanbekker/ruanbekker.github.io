
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="Today we will setup a 3 Node Replica Set for MongoDB on Ubuntu 16. A Replica Set is a form of data replication, so that your data resides on more &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="http://blog.ruanbekker.com/posts/24/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.ruan.dev/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/03/setup-a-3-node-mongodb-replica-set-on-ubuntu-16/">Setup a 3 Node MongoDB Replica Set on Ubuntu 16</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-03T01:29:10+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2017</span></span> <span class='time'>1:29 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today we will setup a 3 Node Replica Set for MongoDB on Ubuntu 16. A Replica Set is a form of data replication, so that your data resides on more than one node for data durability. We will setup the 1st node as the primary node, the second as the secondary node and the 3rd node will act as an arbiter.</p>

<p>The arbiter node can almost be mentioned as a voter node, as it will be set in place to prevent split brain.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://eladnava.com/deploy-a-highly-available-mongodb-replica-set-on-aws/">https://eladnava.com/deploy-a-highly-available-mongodb-replica-set-on-aws/</a></li>
<li><a href="https://stackoverflow.com/questions/38524150/mongodb-replica-set-with-simple-password-authentication">https://stackoverflow.com/questions/38524150/mongodb-replica-set-with-simple-password-authentication</a> (auth)</li>
<li><a href="https://stackoverflow.com/questions/14789622/mongodb-keyfile-too-open-permissions">https://stackoverflow.com/questions/14789622/mongodb-keyfile-too-open-permissions</a></li>
</ul>


<h2>Installing MongoDB on our 3 Nodes:</h2>

<p>Our case, using Ubuntu 16.04, setting up our repository and installing mongodb from our repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse&quot;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list
</span><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>apt install -y mongodb-org -y
</span></code></pre></td></tr></table></div></figure>


<p>Preparing our Directories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /srv/mongodb/rs0-0 /srv/mongodb/rs0-1 /srv/mongodb/rs0-2
</span><span class='line'><span class="nv">$ </span>mkdir -p /var/log/mongodb/rs0-0 /var/log/mongodb/rs0-1 /var/log/mongodb/rs0-2
</span></code></pre></td></tr></table></div></figure>


<p>Populating our MongoDB Configuration:</p>

<ul>
<li>MongoDB Prefers XFS File Systems when using WiredTiger.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; /etc/mongod.conf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">storage:</span>
</span><span class='line'><span class="s">  dbPath: /var/lib/mongodb</span>
</span><span class='line'><span class="s">  journal:</span>
</span><span class='line'><span class="s">    enabled: false</span>
</span><span class='line'>
</span><span class='line'><span class="s">storage:</span>
</span><span class='line'><span class="s">  mmapv1:</span>
</span><span class='line'><span class="s">    smallFiles: true</span>
</span><span class='line'>
</span><span class='line'><span class="s">systemLog:</span>
</span><span class='line'><span class="s">  destination: file</span>
</span><span class='line'><span class="s">  logAppend: true</span>
</span><span class='line'><span class="s">  path: /var/log/mongodb/mongod.log</span>
</span><span class='line'>
</span><span class='line'><span class="s">net:</span>
</span><span class='line'><span class="s">  port: 27017</span>
</span><span class='line'><span class="s">  bindIp: 0.0.0.0</span>
</span><span class='line'>
</span><span class='line'><span class="s">replication:</span>
</span><span class='line'><span class="s">  replSetName: rs0</span>
</span><span class='line'>
</span><span class='line'><span class="s">security:</span>
</span><span class='line'><span class="s">  authorization: enabled</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Enable MongoDB On Startup and Start MongoDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>mongod
</span><span class='line'><span class="nv">$ </span>systemctl restart mongod
</span></code></pre></td></tr></table></div></figure>


<h2>Setup MongoDB Replica Sets:</h2>

<p>In our setup we will have 3 nodes: (mongodb-1, mongodb-2, mongodb3) From our Primary Node, connect to MongoDB and inititalize our replica set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mongo
</span><span class='line'>MongoDB shell version v3.4.7
</span><span class='line'>connecting to: mongodb://127.0.0.1:27017
</span><span class='line'>MongoDB server version: 3.4.7
</span><span class='line'>&gt; rs.initiate<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;info2&quot;</span> : <span class="s2">&quot;no configuration specified. Using a default configuration for the set&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;me&quot;</span> : <span class="s2">&quot;mysql-1:27017&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;ok&quot;</span> : 1
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, add our 2 other MongoDB Nodes, remember <code>mongodb-3</code> is our arbiter node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:SECONDARY&gt; rs.add<span class="o">(</span><span class="s2">&quot;mongodb-2&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;ok&quot;</span> : <span class="m">1</span> <span class="o">}</span>
</span><span class='line'>rs0:PRIMARY&gt; rs.add<span class="o">(</span><span class="s2">&quot;mongodb-3&quot;</span>, <span class="nb">true</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;ok&quot;</span> : <span class="m">1</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify the Replica Set Status:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; rs.status<span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;set&quot;</span> <span class="p">:</span> <span class="s2">&quot;rs0&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;date&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:42.469Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;myState&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;term&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;heartbeatIntervalMillis&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">2000</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;optimes&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;lastCommittedOpTime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">0</span><span class="p">,</span> <span class="err">0),</span>
</span><span class='line'>                        <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">-1</span><span class="err">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;appliedOpTime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839853</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;durableOpTime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839722</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">-1</span><span class="err">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;members&quot;</span> <span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;mysql-1:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;health&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;stateStr&quot;</span> <span class="p">:</span> <span class="s2">&quot;PRIMARY&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uptime&quot;</span> <span class="p">:</span> <span class="mi">422</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839853</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:33Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;electionTime&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839723</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;electionDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:15:23Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;configVersion&quot;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;self&quot;</span> <span class="p">:</span> <span class="kc">true</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;mongodb-2:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;health&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;stateStr&quot;</span> <span class="p">:</span> <span class="s2">&quot;SECONDARY&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uptime&quot;</span> <span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839853</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDurable&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">0</span><span class="p">,</span> <span class="err">0),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">-1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:33Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDurableDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;1970-01-01T00:00:00Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeat&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:41.707Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeatRecv&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:40.699Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;pingMs&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">4</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;syncingTo&quot;</span> <span class="p">:</span> <span class="s2">&quot;mysql-1:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;configVersion&quot;</span> <span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;mongodb-3:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;health&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;stateStr&quot;</span> <span class="p">:</span> <span class="s2">&quot;ARBITER&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uptime&quot;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeat&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:41.721Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeatRecv&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:38.749Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;pingMs&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">2</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;configVersion&quot;</span> <span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;ok&quot;</span> <span class="p">:</span> <span class="mi">1</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">rs</span><span class="mi">0</span><span class="err">:PRIMARY&gt;</span> <span class="err">exit</span>
</span><span class='line'><span class="err">bye</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setup Auth:</h2>

<p>Setup Authentication on our MongoDB Database, we will create the user <code>adminuser</code> and setup the password to <code>secret</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; use admin
</span><span class='line'>switched to db admin
</span><span class='line'>
</span><span class='line'>rs0:PRIMARY&gt; db.createUser<span class="o">({</span>user: <span class="s2">&quot;adminuser&quot;</span>, <span class="nb">pwd</span>: <span class="s2">&quot;secret&quot;</span>, roles:<span class="o">[{</span>role: <span class="s2">&quot;root&quot;</span>, db: <span class="s2">&quot;admin&quot;</span><span class="o">}]})</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">Successfully</span> <span class="err">added</span> <span class="err">user:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;user&quot;</span> <span class="p">:</span> <span class="s2">&quot;adminuser&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;roles&quot;</span> <span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;role&quot;</span> <span class="p">:</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;db&quot;</span> <span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">rs</span><span class="mi">0</span><span class="err">:PRIMARY&gt;</span> <span class="err">exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>Restart MongoDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl restart mongod
</span></code></pre></td></tr></table></div></figure>


<h2>Connect and Authenticate against MongoDB:</h2>

<p>Connect to your MongoDB Cluster with auth:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mongo --host mongodb.example.com --port <span class="m">27017</span> -u &lt;username&gt; -p --authenticationDatabase admin
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/01/setup-haproxy-load-balancer-for-mysql-galera-with-ip-whitelisting-and-backup-servers/">Setup HAProxy Load Balancer for MySQL Galera With IP Whitelisting and Backup Servers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-01T01:15:50+02:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>1:15 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today we will setup a HAProxy Service for our 3 Node MySQL Galera Cluster</p>

<h2>Our Setup:</h2>

<ul>
<li>3 Node Galera MySQL Cluster</li>
<li>3 HAProxy Services (Each HAProxy Service Running on the MySQL Nodes)</li>
<li>MySQL Listens on Port 3307</li>
<li>HAProxy Listens on Port 3306 and Proxies through to 3307</li>
</ul>


<p>I have setup HAProxy on the same node as the MySQL Servers for my use case, but you can also setup HAProxy on a node outside the MySQL Host.</p>

<p>So essentially our MySQL Galera Cluster is a Multi Master Setup, but for now we will only accept connections from Node-A, and have Node-B and Node-C as Backup servers. Should Node-A go down, HAProxy will route connections to Node-B, and if Node-B also goes down, connections will be routed to Node-C.</p>

<p>If the Primary Node, which is Node-A recovers, connections will be restored to Node-A.</p>

<h2>Security:</h2>

<p>We use iptables to allow traffic between the nodes for port TCP/3307 and allow all traffic for Port TCP/3306, as HAProxy will allow the IP Based Access:</p>

<figure class='code'><figcaption><span>Iptables for Each Node</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>iptables -I INPUT -s <span class="o">{</span>Node-A<span class="o">}</span> -p tcp --dport <span class="m">3307</span> -j ACCEPT
</span><span class='line'><span class="nv">$ </span>iptables -I INPUT -s <span class="o">{</span>Node-B<span class="o">}</span> -p tcp --dport <span class="m">3307</span> -j ACCEPT
</span><span class='line'><span class="nv">$ </span>iptables -I INPUT -s <span class="o">{</span>Node-C<span class="o">}</span> -p tcp --dport <span class="m">3307</span> -j ACCEPT
</span><span class='line'><span class="nv">$ </span>iptables -A INPUT -p tcp --dport <span class="m">3306</span> -j ACCEPT
</span><span class='line'><span class="nv">$ </span>iptables -A INPUT -p tcp --dport <span class="m">3307</span> -j DROP
</span></code></pre></td></tr></table></div></figure>


<h2>HAProxy:</h2>

<p>Installing HAProxy on Ubuntu:</p>

<figure class='code'><figcaption><span>Install HAProxy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update
</span><span class='line'><span class="nv">$ </span>sudo apt install haproxy -y
</span></code></pre></td></tr></table></div></figure>


<p>Configure HAProxy with a Port 3306 listener, specify your source addresses that you would like to be authorized to communicate with MySQL and then specify the servers to proxy the connections to our MySQL Galera Cluster, specifying 2 backup servers:</p>

<figure class='code'><figcaption><span>/etc/haproxy/haproxy.cfg</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>global
</span><span class='line'>  log         127.0.0.1 local2
</span><span class='line'>  chroot      /var/lib/haproxy
</span><span class='line'>  pidfile     /var/run/haproxy.pid
</span><span class='line'>  maxconn     1020
</span><span class='line'>  user        haproxy
</span><span class='line'>  group       haproxy
</span><span class='line'>  daemon
</span><span class='line'>
</span><span class='line'>  stats socket /var/lib/haproxy/stats.sock mode <span class="m">600</span> level admin
</span><span class='line'>  stats timeout 2m
</span><span class='line'>
</span><span class='line'>defaults
</span><span class='line'>  mode    tcp
</span><span class='line'>  log     global
</span><span class='line'>  option  dontlognull
</span><span class='line'>  option  redispatch
</span><span class='line'>  retries                   3
</span><span class='line'>  timeout queue             45s
</span><span class='line'>  timeout connect           5s
</span><span class='line'>  timeout client            1m
</span><span class='line'>  timeout server            1m
</span><span class='line'>  timeout check             10s
</span><span class='line'>  maxconn                   1020
</span><span class='line'>
</span><span class='line'>listen stats
</span><span class='line'>  <span class="nb">bind</span>    *:80
</span><span class='line'>  mode    http
</span><span class='line'>  stats   <span class="nb">enable</span>
</span><span class='line'><span class="nb">  </span>stats   show-legends
</span><span class='line'>  stats   refresh           5s
</span><span class='line'>  stats   uri               /
</span><span class='line'>  stats   realm             Haproxy<span class="se">\ </span>Statistics
</span><span class='line'>  stats   auth              admin:secret
</span><span class='line'>  stats   admin             <span class="k">if</span> TRUE
</span><span class='line'>
</span><span class='line'>listen galera-lb
</span><span class='line'>  <span class="nb">bind</span>    *:3306
</span><span class='line'>  mode    tcp
</span><span class='line'>  acl     network_allowed src 10.10.1.0/24 10.32.15.2/32
</span><span class='line'>  tcp-request               content accept <span class="k">if</span> network_allowed
</span><span class='line'>  tcp-request               content reject
</span><span class='line'>  default_backend           galera-cluster
</span><span class='line'>
</span><span class='line'>backend galera-cluster
</span><span class='line'>  balance roundrobin
</span><span class='line'>  server  scw-mysql-1 10.0.0.2:3307  check
</span><span class='line'>  server  scw-mysql-2 10.0.0.3:3307  check backup
</span><span class='line'>  server  scw-mysql-3 10.0.0.4:3307  check backup
</span></code></pre></td></tr></table></div></figure>


<p>Start HAProxy:</p>

<figure class='code'><figcaption><span>Start HAProxy Service</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>haproxy
</span><span class='line'><span class="nv">$ </span>sudo systemctl restart haproxy
</span></code></pre></td></tr></table></div></figure>


<h2>Authorize HAProxy Hostnames to Connect to MySQL:</h2>

<p>In this case we need to allow the Hostnames to be able to connect to mysql:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">&#39;root&#39;</span><span class="o">@</span><span class="s1">&#39;%&#39;</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">&#39;secrets&#39;</span> <span class="k">WITH</span> <span class="k">GRANT</span> <span class="k">OPTION</span><span class="p">;</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://raymii.org/s/snippets/haproxy_restrict_specific_urls_to_specific_ip_addresses.html">https://raymii.org/s/snippets/haproxy_restrict_specific_urls_to_specific_ip_addresses.html</a></li>
</ul>


<center>
        <script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Buy Me a Coffee', '#46b798', 'A6423ZIQ');kofiwidget2.draw();</script>
</center>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/31/secure-your-access-to-kibana-5-and-elasticsearch-5-with-nginx-for-aws/">Secure Your Access to Kibana 5 and Elasticsearch 5 With Nginx for AWS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-31T16:40:09+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>4:40 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As <del>until now, AWS does not offer VPC Support for Elasticsearch</del>, so this make things a bit difficult authorizing Private IP Ranges.</p>

<p>One workaround would be to setup a Nginx Reverse Proxy on AWS within the your Private VPC, associate a EIP on your Nginx EC2 Instance, then authorize your EIP on your Elasticsearch IP Access Policy.</p>

<p><strong>Update</strong>:</p>

<ul>
<li><a href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-vpc.html">Elasticsearch Announced VPC Support for Elasticsearch</a></li>
</ul>


<h2>Our Setup:</h2>

<p>In this setup, we will have an Internal ELB (Elastic Load Balancer), which we will associate 1 or more EC2 Nginx Instances behind the ELB, then setup our Nginx to Revere Proxy our connections through to our Elasticsearch Endpoint.</p>

<p>We will also setup Basic HTTP Authentication for our <code>/</code> elasticsearch endpoint, and our <code>/kibana</code> endpoint. But we will keep the authentication seperate from each other, so that credentials for ES and Kibana is not the same, but depending on your use case, you can allow both endpoints to reference the same credential file.</p>

<h2>Install Nginx</h2>

<p>Depending on your Linux Distribution, the package manager may differ, I am using Amazon Linux:</p>

<figure class='code'><figcaption><span>Install Nginx</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo yum update -y
</span><span class='line'><span class="nv">$ </span>sudo yum install nginx httpd-tools -y
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Nginx:</h2>

<p>Remove the default configuration and replace the <code>nginx.conf</code> with the following:</p>

<figure class='code'><figcaption><span>Remove Default Nginx Config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo rm -r /etc/nginx/nginx.conf
</span></code></pre></td></tr></table></div></figure>


<p>Main Nginx Configuration:</p>

<figure class='code'><figcaption><span>/etc/nginx/nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>user nginx<span class="p">;</span>
</span><span class='line'>worker_processes auto<span class="p">;</span>
</span><span class='line'>pid /run/nginx.pid<span class="p">;</span>
</span><span class='line'>error_log /var/log/nginx/error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>  worker_connections 1024<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Basic Settings</span>
</span><span class='line'>  sendfile on<span class="p">;</span>
</span><span class='line'>  tcp_nopush on<span class="p">;</span>
</span><span class='line'>  tcp_nodelay on<span class="p">;</span>
</span><span class='line'>  keepalive_timeout 65<span class="p">;</span>
</span><span class='line'>  types_hash_max_size 2048<span class="p">;</span>
</span><span class='line'>  server_names_hash_bucket_size 128<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  include /etc/nginx/mime.types<span class="p">;</span>
</span><span class='line'>  default_type application/octet-stream<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Logging Settings</span>
</span><span class='line'>        log_format  main  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  access_log /var/log/nginx/access.log main<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Gzip Settings</span>
</span><span class='line'>  gzip on<span class="p">;</span>
</span><span class='line'>  gzip_disable <span class="s2">&quot;msie6&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Elasticsearch Config</span>
</span><span class='line'>  include /etc/nginx/conf.d/elasticsearch.conf<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Reverse Proxy Configuration:</p>

<figure class='code'><figcaption><span>/etc/nginx/conf.d/elasticsearch.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  listen 80<span class="p">;</span>
</span><span class='line'>  server_name elk.mydomain.com<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># error logging</span>
</span><span class='line'>  error_log /var/log/nginx/elasticsearch_error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># authentication: server wide</span>
</span><span class='line'>  <span class="c">#auth_basic &quot;Auth&quot;;</span>
</span><span class='line'>  <span class="c">#auth_basic_user_file /etc/nginx/.secrets;</span>
</span><span class='line'>
</span><span class='line'>  location / <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># authentication: elasticsearch</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;Elasticsearch Auth&quot;</span><span class="p">;</span>
</span><span class='line'>    auth_basic_user_file /etc/nginx/.secrets_elasticsearch<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Host https://search.eu-west-1.es.amazonaws.com<span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="o">{</span>NGINX-EIP<span class="o">}</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Authorization <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass https://search.eu-west-1.es.amazonaws.com/<span class="p">;</span>
</span><span class='line'>    proxy_redirect https://search.eu-west-1.es.amazonaws.com/ http://<span class="o">{</span>NGINX-EIP<span class="o">}</span>/<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location /kibana <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># authentication: kibana</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;Kibana Auth&quot;</span><span class="p">;</span>
</span><span class='line'>    auth_basic_user_file /etc/nginx/.secrets_kibana<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Host https://search.eu-west-1.es.amazonaws.com<span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="o">{</span>NGINX-EIP<span class="o">}</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Authorization <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass https://search.eu-west-1.es.amazonaws.com/_plugin/kibana/<span class="p">;</span>
</span><span class='line'>    proxy_redirect https://search.eu-west-1.es.amazonaws.com/_plugin/kibana/ http://<span class="o">{</span>NGINX_EIP<span class="o">}</span>/kibana/<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># elb checks</span>
</span><span class='line'>  location /status <span class="o">{</span>
</span><span class='line'>    root /usr/share/nginx/html/<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setup Authentication:</h2>

<p>Setup the authentication for elasticsearch and kibana:</p>

<figure class='code'><figcaption><span>Create Auth for Kibana and Elasticsearch</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo htpasswd -c /etc/nginx/.secrets_elasticsearch admin
</span><span class='line'><span class="nv">$ </span>sudo htpasswd -c /etc/nginx/.secrets_kibana admin
</span></code></pre></td></tr></table></div></figure>


<h2>Restart Nginx and Enable on Startup</h2>

<p>Restart the nginx process and enable the process on boot:</p>

<figure class='code'><figcaption><span>Restart Nginx</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo /etc/init.d/nginx restart
</span><span class='line'><span class="nv">$ </span>sudo chkconfig nginx on
</span></code></pre></td></tr></table></div></figure>


<h2>Configure ELB:</h2>

<p>Create a New Internal ELB, set the Backend Instances on Port 80, and the healthcheck should point to <code>/status/index.html</code> as this location block does not require authentication and our ELB will be able to get a 200 reponse if all is good.
Next you can configure your Route 53 Hosted Zone, <code>elk.mydomain.com</code> to map to your ELB.</p>

<h2>End Result</h2>

<p>Now you should be able to access Elasticsearch on <code>http://elk.mydomain.com/</code> and Kibana on <code>http://elk.mydomain.com/kibana</code> after authenticating.</p>

<p><p>
<script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init(&lsquo;Buy Me a Coffee&rsquo;, &lsquo;#46b798&rsquo;, &lsquo;A6423ZIQ&rsquo;);kofiwidget2.draw();</script></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/31/reference-credentials-outside-your-main-application-in-python/">Reference Credentials Outside Your Main Application in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-31T09:00:58+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>9:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post I will show one way of referencing credentials from your application in Python, without setting them in your applications code. We will create a seperate python file which will hold our credentials, and then call them from our main application.</p>

<h2>Our Main Application</h2>

<p>This app will print our username, just for the sake of this example:</p>

<figure class='code'><figcaption><span>app.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">credentials</span> <span class="k">as</span> <span class="n">secrets</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_username</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;APP1&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">my_password</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;APP1&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;Hello, your username is: {username}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">my_username</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Our Credentials File</h2>

<p>Then we have our file which will hold our credentials:</p>

<figure class='code'><figcaption><span>config.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">credentials</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;APP1&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;foo&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;bar&#39;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That is at least one way of doing it, you could also use environment variables using the <code>os</code> module, which is described <a href="https://stackoverflow.com/a/4907053">here</a></p>

<h2>References:</h2>

<ul>
<li><a href="https://docs.python.org/2/tutorial/inputoutput.html">https://docs.python.org/2/tutorial/inputoutput.html</a></li>
<li><a href="https://docs.python.org/2/library/os.html#os.environ">https://docs.python.org/2/library/os.html#os.environ</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/29/change-iam-username-with-aws-cli/">Change IAM Username With AWS CLI</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-29T00:27:21+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>12:27 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You may find yourself in a position where you need to rename more than one IAM Username, and one way of doing this is using the AWS CLI tools to rename the username.</p>

<p>The benefit of this is that the user&rsquo;s access keys remains the same, any policies associated to the user, will stay on the user after the username gets renamed.</p>

<p>The only thing that changes, is ofcourse the username that the user will use when logging onto the AWS Management Console:</p>

<h2>Details of our User:</h2>

<p>We will change the IAM User <code>peter</code> to <code>peter.franklin</code>. Currently Peter&rsquo;s ACCESS_KEY will be <code>AKIA123456ABCDEF1234</code> which is configured with the profile name <code>peter</code>.</p>

<p>Lets first get details of our user before changing it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile admin iam get-user --user-name peter
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;User&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;UserName&quot;</span>: <span class="s2">&quot;peter&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;PasswordLastUsed&quot;</span>: <span class="s2">&quot;2017-08-28T13:17:22Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;CreateDate&quot;</span>: <span class="s2">&quot;2017-08-28T13:11:25Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;UserId&quot;</span>: <span class="s2">&quot;ABCDEFGHIJKLMNOPQRST&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;/&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Arn&quot;</span>: <span class="s2">&quot;arn:aws:iam::123456789012:user/peter&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Rename the IAM User</h2>

<p>Update user peter to peter.franklin:</p>

<figure class='code'><figcaption><span>Rename the IAM User</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile aws iam update-user --user-name peter --new-user-name peter.franklin
</span></code></pre></td></tr></table></div></figure>


<p>Describe peter&rsquo;s new username:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile aws iam get-user --user-name peter.franklin
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;User&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;UserName&quot;</span>: <span class="s2">&quot;peter.franklin&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;PasswordLastUsed&quot;</span>: <span class="s2">&quot;2017-08-28T13:23:18Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;CreateDate&quot;</span>: <span class="s2">&quot;2017-08-28T13:11:25Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;UserId&quot;</span>: <span class="s2">&quot;ABCDEFGHIJKLNMOPQRST&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;/&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Arn&quot;</span>: <span class="s2">&quot;arn:aws:iam::123456789012:user/peter.franklin&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify that access keys are the same:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile aws iam list-access-keys --user-name peter.franklin
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;AccessKeyMetadata&quot;</span>: <span class="o">[</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;UserName&quot;</span>: <span class="s2">&quot;peter.franklin&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Status&quot;</span>: <span class="s2">&quot;Active&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;CreateDate&quot;</span>: <span class="s2">&quot;2017-08-28T13:11:27Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;AccessKeyId&quot;</span>: <span class="s2">&quot;AKIA123456ABCDEF1234&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this momemnt we can see that Peter&rsquo;s AccessKeyId is still the same, which means he does not have to update his credentials on his end.</p>

<h2>Some Useful CLI Commands:</h2>

<p>Get only the Access Key for a User:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile admin iam list-access-keys --user-name peter.franklin <span class="p">|</span> jq -r <span class="s1">&#39;.[][].AccessKeyId&#39;</span>
</span><span class='line'>AKIA123456ABCDEF1234
</span></code></pre></td></tr></table></div></figure>


<h2>Determine when the AccessKey was last used, and for which Service:</h2>

<p>For auditing, or verifying if a AccessKeyId is being used, we can call the <code>get-access-key-last-used</code>, which will give us the last time the key was used, and also see for which service in question.</p>

<p>Let Peter create a DynamoDB Table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile peter dynamodb <span class="se">\</span>
</span><span class='line'>create-table --table-name test01 <span class="se">\</span>
</span><span class='line'>--attribute-definitions <span class="s2">&quot;AttributeName=username,AttributeType=S&quot;</span> <span class="se">\</span>
</span><span class='line'>--key-schema <span class="s2">&quot;AttributeName=username,KeyType=HASH&quot;</span> <span class="se">\</span>
</span><span class='line'>--provisioned-throughput <span class="s2">&quot;ReadCapacityUnits=1,WriteCapacityUnits=1&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;TableDescription&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;TableArn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:dynamodb:eu-west-1:123456789012:table/test01&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;AttributeDefinitions&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;AttributeName&quot;</span><span class="p">:</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;AttributeType&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;ProvisionedThroughput&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;NumberOfDecreasesToday&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;WriteCapacityUnits&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;ReadCapacityUnits&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;TableSizeBytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;TableName&quot;</span><span class="p">:</span> <span class="s2">&quot;test01&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;TableStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;CREATING&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;KeySchema&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;KeyType&quot;</span><span class="p">:</span> <span class="s2">&quot;HASH&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;AttributeName&quot;</span><span class="p">:</span> <span class="s2">&quot;username&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;ItemCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;CreationDateTime&quot;</span><span class="p">:</span> <span class="mf">1503928537.671</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Get Detail on LastUsedDate:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile admin iam get-access-key-last-used  --access-key <span class="k">$(</span>aws --profile aws iam list-access-keys --user-name peter.franklin <span class="p">|</span> jq -r <span class="s1">&#39;.[][].AccessKeyId&#39;</span><span class="k">)</span> <span class="p">|</span> jq -r <span class="s1">&#39;.[]&#39;</span>
</span><span class='line'>peter.franklin
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;Region&quot;</span>: <span class="s2">&quot;eu-west-1&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;ServiceName&quot;</span>: <span class="s2">&quot;dynamodb&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;LastUsedDate&quot;</span>: <span class="s2">&quot;2017-08-28T13:55:00Z&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Only getting the LastUsedDate of the AccessKeyId:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile admin iam get-access-key-last-used  --access-key <span class="k">$(</span>aws --profile aws iam list-access-keys --user-name peter.franklin <span class="p">|</span> jq -r <span class="s1">&#39;.[][].AccessKeyId&#39;</span><span class="k">)</span> <span class="p">|</span> jq <span class="s1">&#39;.AccessKeyLastUsed.LastUsedDate&#39;</span>
</span><span class='line'><span class="s2">&quot;2017-08-28T13:55:00Z&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><ul>
<li><a href="http://docs.aws.amazon.com/cli/latest/reference/iam/update-user.html?shortFooter=true">http://docs.aws.amazon.com/cli/latest/reference/iam/update-user.html?shortFooter=true</a></li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/27/using-the-python-api-for-mongodb-using-pymongo/">Using the Python API for MongoDB Using PyMongo</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-27T22:19:48+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>10:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Using the Python API for MongoDB using Pymongo</p>

<h2>Requirements:</h2>

<p>You will need to install the <code>pymongo</code> driver using pip:</p>

<figure class='code'><figcaption><span>Install Pymongo</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install pymongo
</span></code></pre></td></tr></table></div></figure>


<p>A configuration file with your access credentials, which I like to use outside my code:</p>

<figure class='code'><figcaption><span>config.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">credentials</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;mongodb&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;HOSTNAME&quot;</span>: <span class="s2">&quot;host.domain.com&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;USERNAME&quot;</span>: <span class="s2">&quot;username&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;PASSWORD&quot;</span>: <span class="s2">&quot;password&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Connecting to MongoDB:</h2>

<p>From the python interpreter, connect to MongoDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">credentials</span> <span class="k">as</span> <span class="n">secrets</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongo_host</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;mongodb&#39;</span><span class="p">][</span><span class="s">&#39;HOSTNAME&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongo_username</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;mongodb&#39;</span><span class="p">][</span><span class="s">&#39;USERNAME&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongo_password</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;mongodb&#39;</span><span class="p">][</span><span class="s">&#39;PASSWORD&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongodb_client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s">&#39;mongodb://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">:27017/admin?authMechanism=SCRAM-SHA-1&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mongo_username</span><span class="p">,</span> <span class="n">mongo_password</span><span class="p">,</span> <span class="n">mongo_host</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find the Database that you are connected to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="s">u&#39;admin&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find all the databases that is currently on your MongoDB Server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dbs</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">database_names</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">admin</span>
</span><span class='line'><span class="n">flask_reminders</span>
</span><span class='line'><span class="n">local</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create a Database, Collection and Write a Document into your Database:</h2>

<p>Let&rsquo;s create a database, in my case it will be <code>ruan-test</code>, and my collection name <code>mycollection</code> and the write one item into it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="p">[</span><span class="s">&#39;ruan-test&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span> <span class="o">=</span> <span class="n">newdb</span><span class="p">[</span><span class="s">&#39;mycollection&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;frank&quot;</span><span class="p">,</span> <span class="s">&quot;surname&quot;</span><span class="p">:</span> <span class="s">&quot;jeffreys&quot;</span><span class="p">,</span> <span class="s">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;person&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">]}</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">doc_id</span> <span class="o">=</span> <span class="n">newdb_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span><span class="o">.</span><span class="n">inserted_id</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
</span><span class='line'><span class="mi">59</span><span class="n">a319ec1f15a5088ba3a339</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note: you can also connect to your collection like the following</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="p">[</span><span class="s">&#39;ruan-test&#39;</span><span class="p">][</span><span class="s">&#39;mycollection&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have inserted one item into our database, which we can verify with <code>count()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span class='line'><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see I have the value of the item&rsquo;s id, we can use that to find it from our collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;_id&quot;</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">})</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a319ec1f15a5088ba3a339&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;jeffreys&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;frank&#39;</span><span class="p">,</span> <span class="s">u&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">u&#39;person&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we only have one item in our database, we can also use <code>find_one()</code> which will give us the exact same data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a319ec1f15a5088ba3a339&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;jeffreys&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;frank&#39;</span><span class="p">,</span> <span class="s">u&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">u&#39;person&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can write some more data to our database, but this time, lets write to a different collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection2</span> <span class="o">=</span> <span class="n">newdb</span><span class="p">[</span><span class="s">&#39;new-collection-2&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">item</span> <span class="o">=</span> <span class="n">newdb_collection2</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;ruby&quot;</span><span class="p">,</span> <span class="s">&quot;surname&quot;</span><span class="p">:</span> <span class="s">&quot;james&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">inserted_id</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">item2</span> <span class="o">=</span> <span class="n">newdb_collection2</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;ruby&quot;</span><span class="p">,</span> <span class="s">&quot;surname&quot;</span><span class="p">:</span> <span class="s">&quot;james&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">inserted_id</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we captured the items <code>_id</code>, we can view the:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="mi">59</span><span class="n">a31acf1f15a5088ba3a33b</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">item2</span><span class="p">)</span>
</span><span class='line'><span class="mi">59</span><span class="n">a31a8a1f15a5088ba3a33a</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Query Data from MongoDB:</h2>

<p>We can then query for this data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb2</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;ruby&quot;</span><span class="p">})</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a31acf1f15a5088ba3a33b&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;james&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;ruby&#39;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb2</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;_id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">})</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a31acf1f15a5088ba3a33b&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;james&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;ruby&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also scan for all items in the collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">scan</span> <span class="o">=</span> <span class="n">newdb_collection2</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scan</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a31a8a1f15a5088ba3a33a&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;james&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;phillip&#39;</span><span class="p">}</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a31acf1f15a5088ba3a33b&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;james&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;ruby&#39;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span class='line'><span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now verify that we have 2 collections in our database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb</span><span class="o">.</span><span class="n">collection_names</span><span class="p">()</span>
</span><span class='line'><span class="p">[</span><span class="s">u&#39;mycollection-2&#39;</span><span class="p">,</span> <span class="s">u&#39;mycollection&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Connecting to an existing Database:</h2>

<p>Let&rsquo;s connect to an existing database on our MongoDB Server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="p">[</span><span class="s">&#39;flask_reminders&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>List the collections:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">collection_names</span><span class="p">()</span>
</span><span class='line'><span class="p">[</span><span class="s">u&#39;reminders&#39;</span><span class="p">,</span> <span class="s">u&#39;usersessions&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Count the number of items in our <code>reminders</code> Collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">reminders</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span class='line'><span class="mi">624</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find a Random Item:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">reminders</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;category&#39;</span><span class="p">:</span> <span class="s">u&#39;Python&#39;</span><span class="p">,</span> <span class="s">u&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Chatbot with SQLite&#39;</span><span class="p">,</span> <span class="s">u&#39;link&#39;</span><span class="p">:</span> <span class="s">u&#39;http://rodic.fr/blog/python-chatbot-1/&#39;</span><span class="p">,</span> <span class="s">u&#39;date&#39;</span><span class="p">:</span> <span class="s">u&#39;2017-01-03&#39;</span><span class="p">,</span> <span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;586bb6dd0269103671afce32&#39;</span><span class="p">),</span> <span class="s">u&#39;type&#39;</span><span class="p">:</span> <span class="s">u&#39;Discovered Service&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find One Item, with a Specific Value, for example the value <code>AWS</code> for our <code>Category key</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">reminders</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;category&quot;</span><span class="p">:</span> <span class="s">&quot;AWS&quot;</span><span class="p">})</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;category&#39;</span><span class="p">:</span> <span class="s">u&#39;AWS&#39;</span><span class="p">,</span> <span class="s">u&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Elasticsearch Documentation Access Policies&#39;</span><span class="p">,</span> <span class="s">u&#39;link&#39;</span><span class="p">:</span> <span class="s">u&#39;http://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-createupdatedomains.html#es-createdomain-configure-access-policies&#39;</span><span class="p">,</span> <span class="s">u&#39;date&#39;</span><span class="p">:</span> <span class="s">u&#39;2017-02-13&#39;</span><span class="p">,</span> <span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;58a1d45202691070616947c3&#39;</span><span class="p">),</span> <span class="s">u&#39;type&#39;</span><span class="p">:</span> <span class="s">u&#39;Documentation&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find All Items, with a specific value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">reminders</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;category&quot;</span><span class="p">:</span> <span class="s">&quot;AWS&quot;</span><span class="p">})</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;category&#39;</span><span class="p">:</span> <span class="s">u&#39;Python&#39;</span><span class="p">,</span> <span class="s">u&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Chatbot with SQLite&#39;</span><span class="p">,</span> <span class="s">u&#39;link&#39;</span><span class="p">:</span> <span class="s">u&#39;http://rodic.fr/blog/python-chatbot-1/&#39;</span><span class="p">,</span> <span class="s">u&#39;date&#39;</span><span class="p">:</span> <span class="s">u&#39;2017-01-03&#39;</span><span class="p">,</span> <span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;586bb6dd0269103671afce32&#39;</span><span class="p">),</span> <span class="s">u&#39;type&#39;</span><span class="p">:</span> <span class="s">u&#39;Discovered Service&#39;</span><span class="p">}</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;category&#39;</span><span class="p">:</span> <span class="s">u&#39;Python&#39;</span><span class="p">,</span> <span class="s">u&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Boto: Kinesis List&#39;</span><span class="p">,</span> <span class="s">u&#39;link&#39;</span><span class="p">:</span> <span class="s">u&#39;https://gitlab.com/rbekker87/code-examples/blob/master/kinesis/firehose/python/firehose.list.py&#39;</span><span class="p">,</span> <span class="s">u&#39;date&#39;</span><span class="p">:</span> <span class="s">u&#39;2017-01-05&#39;</span><span class="p">,</span> <span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;586dde1e0269103671afce36&#39;</span><span class="p">),</span> <span class="s">u&#39;type&#39;</span><span class="p">:</span> <span class="s">u&#39;Stuff Done&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deleting Databases:</h2>

<p>Cleaning up, deleting the database that we created, when a database is delete, the collections within that database also gets removed.</p>

<p>First list the databases:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dbs</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">database_names</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">admin</span>
</span><span class='line'><span class="n">flask_reminders</span>
</span><span class='line'><span class="n">local</span>
</span><span class='line'><span class="n">ruan</span><span class="o">-</span><span class="n">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then delete the database that you want to delete:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">drop_database</span><span class="p">(</span><span class="s">&quot;ruan-test&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then verify if the database was removed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dbs</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">database_names</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">admin</span>
</span><span class='line'><span class="n">flask_reminders</span>
</span><span class='line'><span class="n">local</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="http://api.mongodb.com/python/current/tutorial.html">http://api.mongodb.com/python/current/tutorial.html</a></li>
<li><a href="https://docs.mongodb.com/getting-started/python/client/">https://docs.mongodb.com/getting-started/python/client/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/27/setup-a-local-mongodb-development-3-member-replica-set/">Setup a Local MongoDB Development 3 Member Replica Set</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-27T07:10:16+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>7:10 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Setup a Development Environment of a MongoDB Replica Set consisting of 3 mongod MongoDB Instances.</p>

<p>This is purely aimed for a testing or development environment, as one of the key points is that security is disabled, and that for this post, all 3 instances will be running on the same node.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/</a></li>
<li><a href="https://docs.mongodb.com/manual/tutorial/deploy-replica-set-for-testing/">https://docs.mongodb.com/manual/tutorial/deploy-replica-set-for-testing/</a></li>
</ul>


<h2>Installation:</h2>

<p>I am using Ubuntu 16.04, for other distributions, have a look at <a href="https://docs.mongodb.com/manual/administration/install-community/">MongoDBs Installation Page</a></p>

<figure class='code'><figcaption><span>MongoDB Installation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse&quot;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list
</span><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>apt install -y mongodb-org -y
</span></code></pre></td></tr></table></div></figure>


<h2>Prepare Directories:</h2>

<p>Prepare the data directories, and as I am planning to use the <code>--fork</code> option, I need to specify the the <code>--logpath</code>, so therefore I will create the log directories as well:</p>

<figure class='code'><figcaption><span>Create the Directory Paths</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /srv/mongodb/rs0-0 /srv/mongodb/rs0-1 /srv/mongodb/rs0-2
</span><span class='line'><span class="nv">$ </span>mkdir -p /var/log/mongodb/rs0-0 /var/log/mongodb/rs0-1 /var/log/mongodb/rs0-2
</span></code></pre></td></tr></table></div></figure>


<h2>Run 3 MongoDB Instances:</h2>

<p>Create 3 MongoDB Instances, each instance listening on it&rsquo;s unique port.</p>

<p>From MongoDB&rsquo;s Documentation:</p>

<blockquote><p>&ldquo;The &ndash;smallfiles and &ndash;oplogSize settings reduce the disk space that each mongod instance uses&rdquo;</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mongod --port <span class="m">27017</span> --dbpath /srv/mongodb/rs0-0 --replSet rs0 --smallfiles --oplogSize <span class="m">128</span> --logpath /var/log/mongodb/rs0-0/server.log --fork
</span><span class='line'><span class="nv">$ </span>mongod --port <span class="m">27018</span> --dbpath /srv/mongodb/rs0-1 --replSet rs0 --smallfiles --oplogSize <span class="m">128</span> --logpath /var/log/mongodb/rs0-1/server.log --fork
</span><span class='line'><span class="nv">$ </span>mongod --port <span class="m">27019</span> --dbpath /srv/mongodb/rs0-2 --replSet rs0 --smallfiles --oplogSize <span class="m">128</span> --logpath /var/log/mongodb/rs0-2/server.log --fork
</span></code></pre></td></tr></table></div></figure>


<h2>Cofirm:</h2>

<p>Confirm that the processes are listening on the ports that we defined:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -tulpn
</span><span class='line'>Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:27017           0.0.0.0:*               LISTEN      1100/mongod
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:27018           0.0.0.0:*               LISTEN      1127/mongod
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:27019           0.0.0.0:*               LISTEN      1154/mongod
</span></code></pre></td></tr></table></div></figure>


<h2>Connect to the first MongoDB Instnace:</h2>

<p>Connect to our first MongoDB Instance, where we will setup the replica set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mongo --port 27017
</span><span class='line'><span class="se">\&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the Replica Set Configuration Object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; <span class="nv">rsconf</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>             _id: <span class="s2">&quot;rs0&quot;</span>,
</span><span class='line'>             members: <span class="o">[</span>
</span><span class='line'>                        <span class="o">{</span>
</span><span class='line'>                         _id: 0,
</span><span class='line'>                         host: <span class="s2">&quot;10.78.1.24:27017&quot;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                      <span class="o">]</span>
</span><span class='line'>           <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Initiate the replica set configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; rs.initiate<span class="o">(</span> rsconf <span class="o">)</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;ok&quot;</span> : <span class="m">1</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Display the Replica Configuration with <code>rs.conf()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:SECONDARY&gt; rs.conf<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;rs0&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;version&quot;</span> : 1,
</span><span class='line'>        <span class="s2">&quot;protocolVersion&quot;</span> : NumberLong<span class="o">(</span>1<span class="o">)</span>,
</span><span class='line'>        <span class="s2">&quot;members&quot;</span> : <span class="o">[</span>
</span><span class='line'>                <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;_id&quot;</span> : 0,
</span><span class='line'>                        <span class="s2">&quot;host&quot;</span> : <span class="s2">&quot;10.78.1.24:27017&quot;</span>,
</span><span class='line'>                        <span class="s2">&quot;arbiterOnly&quot;</span> : <span class="nb">false</span>,
</span><span class='line'>                        <span class="s2">&quot;buildIndexes&quot;</span> : <span class="nb">true</span>,
</span><span class='line'>                        <span class="s2">&quot;hidden&quot;</span> : <span class="nb">false</span>,
</span><span class='line'>                        <span class="s2">&quot;priority&quot;</span> : 1,
</span><span class='line'>                        <span class="s2">&quot;tags&quot;</span> : <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>                        <span class="o">}</span>,
</span><span class='line'>                        <span class="s2">&quot;slaveDelay&quot;</span> : NumberLong<span class="o">(</span>0<span class="o">)</span>,
</span><span class='line'>                        <span class="s2">&quot;votes&quot;</span> : 1
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>        <span class="o">]</span>,
</span><span class='line'>        <span class="s2">&quot;settings&quot;</span> : <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;chainingAllowed&quot;</span> : <span class="nb">true</span>,
</span><span class='line'>                <span class="s2">&quot;heartbeatIntervalMillis&quot;</span> : 2000,
</span><span class='line'>                <span class="s2">&quot;heartbeatTimeoutSecs&quot;</span> : 10,
</span><span class='line'>                <span class="s2">&quot;electionTimeoutMillis&quot;</span> : 10000,
</span><span class='line'>                <span class="s2">&quot;catchUpTimeoutMillis&quot;</span> : 60000,
</span><span class='line'>                <span class="s2">&quot;getLastErrorModes&quot;</span> : <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;getLastErrorDefaults&quot;</span> : <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;w&quot;</span> : 1,
</span><span class='line'>                        <span class="s2">&quot;wtimeout&quot;</span> : 0
</span><span class='line'>                <span class="o">}</span>,
</span><span class='line'>                <span class="s2">&quot;replicaSetId&quot;</span> : ObjectId<span class="o">(</span><span class="s2">&quot;59a2339f5ff27709a1645d28&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the other two mongodb instances to the replica set using <code>rs.add()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; rs.add<span class="o">(</span><span class="s2">&quot;10.78.1.24:27018&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;ok&quot;</span> : <span class="m">1</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>rs0:PRIMARY&gt; rs.add<span class="o">(</span><span class="s2">&quot;10.78.1.24:27019&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;ok&quot;</span> : <span class="m">1</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>View the status of our MongoDB Replica Set with <code>rs.status()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; rs.status<span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;set&quot;</span> <span class="p">:</span> <span class="s2">&quot;rs0&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;date&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:52:08.106Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;myState&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;term&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;heartbeatIntervalMillis&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">2000</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;optimes&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;lastCommittedOpTime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503802316</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;appliedOpTime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503802316</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;durableOpTime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503802316</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;members&quot;</span> <span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;10.78.1.24:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;health&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;stateStr&quot;</span> <span class="p">:</span> <span class="s2">&quot;PRIMARY&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uptime&quot;</span> <span class="p">:</span> <span class="mi">890</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503802316</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:51:56Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;infoMessage&quot;</span> <span class="p">:</span> <span class="s2">&quot;could not find member to sync from&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;electionTime&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503802272</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;electionDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:51:12Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;configVersion&quot;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;self&quot;</span> <span class="p">:</span> <span class="kc">true</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;10.78.1.24:27018&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;health&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;stateStr&quot;</span> <span class="p">:</span> <span class="s2">&quot;SECONDARY&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uptime&quot;</span> <span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503802316</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDurable&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503802316</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:51:56Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDurableDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:51:56Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeat&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:52:06.638Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeatRecv&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:52:07.638Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;pingMs&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">0</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;syncingTo&quot;</span> <span class="p">:</span> <span class="s2">&quot;10.78.1.24:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;configVersion&quot;</span> <span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;10.78.1.24:27019&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;health&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;stateStr&quot;</span> <span class="p">:</span> <span class="s2">&quot;SECONDARY&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uptime&quot;</span> <span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503802316</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDurable&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503802316</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:51:56Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDurableDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:51:56Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeat&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:52:06.638Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeatRecv&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T02:52:07.241Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;pingMs&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">0</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;configVersion&quot;</span> <span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;ok&quot;</span> <span class="p">:</span> <span class="mi">1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Write some Data to MongoDB:</h2>

<p>Create a Database named <code>mydb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; use mydb
</span><span class='line'>switched to db mydb
</span></code></pre></td></tr></table></div></figure>


<p>Create a Collection, named <code>mycol1</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; db.createCollection<span class="o">(</span><span class="s2">&quot;mycol1&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;ok&quot;</span> : <span class="m">1</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>rs0:PRIMARY&gt; show collections
</span><span class='line'>mycol1
</span></code></pre></td></tr></table></div></figure>


<p>Write 2 documents with:</p>

<ul>
<li>Name: James, Home Address: Country => South Africa, City => Cape Town</li>
<li>Name: Frank, Home Address: Country => Ireland, City => Dublin</li>
</ul>


<figure class='code'><figcaption><span>Write some Data</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; db.mycol1.insert<span class="o">({</span><span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;james&quot;</span>, <span class="s2">&quot;home address&quot;</span>: <span class="o">{</span><span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;south africa&quot;</span>, <span class="s2">&quot;city&quot;</span>: <span class="s2">&quot;cape town&quot;</span><span class="o">}})</span>
</span><span class='line'>WriteResult<span class="o">({</span> <span class="s2">&quot;nInserted&quot;</span> : <span class="m">1</span> <span class="o">})</span>
</span><span class='line'>
</span><span class='line'>rs0:PRIMARY&gt; db.mycol1.insert<span class="o">({</span><span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;frank&quot;</span>, <span class="s2">&quot;home address&quot;</span>: <span class="o">{</span><span class="s2">&quot;country&quot;</span>: <span class="s2">&quot;ireland&quot;</span>, <span class="s2">&quot;city&quot;</span>: <span class="s2">&quot;dublin&quot;</span><span class="o">}})</span>
</span><span class='line'>WriteResult<span class="o">({</span> <span class="s2">&quot;nInserted&quot;</span> : <span class="m">1</span> <span class="o">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Count all Documents in our Database:</p>

<figure class='code'><figcaption><span>Counting</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; db.mycol1.find<span class="o">()</span>.count<span class="o">()</span>
</span><span class='line'>2
</span></code></pre></td></tr></table></div></figure>


<p>Scan through all documents, and show the in <code>pretty print</code>:</p>

<figure class='code'><figcaption><span>Pretty Print</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; db.mycol1.find<span class="o">()</span>.pretty<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;_id&quot;</span> : ObjectId<span class="o">(</span><span class="s2">&quot;59a23d26c0c3824694f79ff6&quot;</span><span class="o">)</span>,
</span><span class='line'>        <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;james&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;home address&quot;</span> : <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;country&quot;</span> : <span class="s2">&quot;south africa&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;city&quot;</span> : <span class="s2">&quot;cape town&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;_id&quot;</span> : ObjectId<span class="o">(</span><span class="s2">&quot;59a23dbdc0c3824694f79ff7&quot;</span><span class="o">)</span>,
</span><span class='line'>        <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;frank&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;home address&quot;</span> : <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;country&quot;</span> : <span class="s2">&quot;ireland&quot;</span>,
</span><span class='line'>                <span class="s2">&quot;city&quot;</span> : <span class="s2">&quot;dublin&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find Information about <code>Frank</code>:</p>

<figure class='code'><figcaption><span>Franks Info</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; db.mycol1.find<span class="o">({</span><span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;frank&quot;</span><span class="o">})</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;_id&quot;</span> : ObjectId<span class="o">(</span><span class="s2">&quot;59a23dbdc0c3824694f79ff7&quot;</span><span class="o">)</span>, <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;frank&quot;</span>, <span class="s2">&quot;home address&quot;</span> : <span class="o">{</span> <span class="s2">&quot;country&quot;</span> : <span class="s2">&quot;ireland&quot;</span>, <span class="s2">&quot;city&quot;</span> : <span class="s2">&quot;dublin&quot;</span> <span class="o">}</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Delete the Database, but confirm which database your are logged on, the delete using <code>dropDatabase()</code>:</p>

<figure class='code'><figcaption><span>Drop Database</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; db
</span><span class='line'>mydb
</span><span class='line'>
</span><span class='line'>rs0:PRIMARY&gt; db.dropDatabase<span class="o">()</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;dropped&quot;</span> : <span class="s2">&quot;mydb&quot;</span>, <span class="s2">&quot;ok&quot;</span> : <span class="m">1</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>rs0:PRIMARY&gt; <span class="nb">exit</span>
</span><span class='line'>bye
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/27/building-a-alpine-nginx-php-fpm-image-on-docker-for-php-applications/">Building a Alpine Nginx PHP-Fpm Image on Docker for PHP Applications</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-27T02:41:16+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:41 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A Post on Building a Alpine Based Image that will serve PHP Pages, using Nginx and PHP-FPM5.</p>

<p>I have a lot of modules enabled, which might not be neccesary, but in my case I wanted to have a couple of them enabled, for testing.</p>

<h2>One of the Requirements:</h2>

<p>One of the requirements was that I needed SMTP support from the container as I am using <a href="https://startbootstrap.com/template-overviews/freelancer/">Startbootstrap Freelancer Theme</a>, which I configured to relay mail from the contact from to one of my external relay hosts.</p>

<h2>Our Directory Structure:</h2>

<p>Our data that we will be working with will consist of our <code>Dockerfile</code>, our <code>website files</code>, <code>nginx config</code>, and a <code>wrapper script</code> that will control nginx and php-fpm5 processes:</p>

<figure class='code'><figcaption><span>Directory Structure</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>.
</span><span class='line'><span class="p">|</span>-- Dockerfile
</span><span class='line'><span class="p">|</span>-- README.md
</span><span class='line'><span class="p">|</span>-- html
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- css
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- fonts
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- img
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- index.html
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- js
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- mail
</span><span class='line'><span class="p">|</span>       <span class="sb">`</span>-- contact.php
</span><span class='line'><span class="p">|</span>-- nginx.conf
</span><span class='line'><span class="p">|</span>-- start_nginx.sh
</span><span class='line'><span class="p">|</span>-- start_php-fpm5.sh
</span><span class='line'><span class="sb">`</span>-- wrapper.sh
</span></code></pre></td></tr></table></div></figure>


<h2>Going into Some Detail:</h2>

<p>First, our <code>Dockerfile</code>, which you will see I started the image from Apline:</p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class='docker'><span class='line'><span class="k">FROM</span> alpine:edge
</span><span class='line'>
</span><span class='line'><span class="k">RUN</span> apk update <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> apk add nginx <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> adduser -D -u <span class="m">1000</span> -g <span class="s1">&#39;www&#39;</span> www <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> mkdir /www <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> chown -R www:www /var/lib/nginx <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> chown -R www:www /www <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> rm -rf /etc/nginx/nginx.conf
</span><span class='line'>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_FPM_USER</span><span class="o">=</span><span class="s2">&quot;www&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_FPM_GROUP</span><span class="o">=</span><span class="s2">&quot;www&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_FPM_LISTEN_MODE</span><span class="o">=</span><span class="s2">&quot;0660&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_MEMORY_LIMIT</span><span class="o">=</span><span class="s2">&quot;512M&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_MAX_UPLOAD</span><span class="o">=</span><span class="s2">&quot;50M&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_MAX_FILE_UPLOAD</span><span class="o">=</span><span class="s2">&quot;200&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_MAX_POST</span><span class="o">=</span><span class="s2">&quot;100M&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_DISPLAY_ERRORS</span><span class="o">=</span><span class="s2">&quot;On&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_DISPLAY_STARTUP_ERRORS</span><span class="o">=</span><span class="s2">&quot;On&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_ERROR_REPORTING</span><span class="o">=</span><span class="s2">&quot;E_COMPILE_ERROR\|E_RECOVERABLE_ERROR\|E_ERROR\|E_CORE_ERROR&quot;</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">PHP_CGI_FIX_PATHINFO</span><span class="o">=</span><span class="m">0</span>
</span><span class='line'><span class="k">ENV</span> <span class="nv">TIMEZONE</span><span class="o">=</span><span class="s2">&quot;Africa/Johannesburg&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">RUN</span> apk add curl <span class="err">\</span>
</span><span class='line'>    ssmtp <span class="err">\</span>
</span><span class='line'>    tzdata <span class="err">\</span>
</span><span class='line'>    php5-fpm <span class="err">\</span>
</span><span class='line'>    php5-mcrypt <span class="err">\</span>
</span><span class='line'>    php5-soap <span class="err">\</span>
</span><span class='line'>    php5-openssl <span class="err">\</span>
</span><span class='line'>    php5-gmp <span class="err">\</span>
</span><span class='line'>    php5-pdo_odbc <span class="err">\</span>
</span><span class='line'>    php5-json <span class="err">\</span>
</span><span class='line'>    php5-dom <span class="err">\</span>
</span><span class='line'>    php5-pdo <span class="err">\</span>
</span><span class='line'>    php5-zip <span class="err">\</span>
</span><span class='line'>    php5-mysql <span class="err">\</span>
</span><span class='line'>    php5-mysqli <span class="err">\</span>
</span><span class='line'>    php5-sqlite3 <span class="err">\</span>
</span><span class='line'>    php5-pdo_pgsql <span class="err">\</span>
</span><span class='line'>    php5-bcmath <span class="err">\</span>
</span><span class='line'>    php5-gd <span class="err">\</span>
</span><span class='line'>    php5-odbc <span class="err">\</span>
</span><span class='line'>    php5-pdo_mysql <span class="err">\</span>
</span><span class='line'>    php5-pdo_sqlite <span class="err">\</span>
</span><span class='line'>    php5-gettext <span class="err">\</span>
</span><span class='line'>    php5-xmlreader <span class="err">\</span>
</span><span class='line'>    php5-xmlrpc <span class="err">\</span>
</span><span class='line'>    php5-bz2 <span class="err">\</span>
</span><span class='line'>    php5-iconv <span class="err">\</span>
</span><span class='line'>    php5-pdo_dblib <span class="err">\</span>
</span><span class='line'>    php5-curl <span class="err">\</span>
</span><span class='line'>    php5-ctype
</span><span class='line'>
</span><span class='line'><span class="k">RUN</span> sed -i <span class="s2">&quot;s|;listen.owner\s*=\s*nobody|listen.owner = ${PHP_FPM_USER}|g&quot;</span> /etc/php5/php-fpm.conf <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|;listen.group\s*=\s*nobody|listen.group = ${PHP_FPM_GROUP}|g&quot;</span> /etc/php5/php-fpm.conf <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|;listen.mode\s*=\s*0660|listen.mode = ${PHP_FPM_LISTEN_MODE}|g&quot;</span> /etc/php5/php-fpm.conf <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|user\s*=\s*nobody|user = ${PHP_FPM_USER}|g&quot;</span> /etc/php5/php-fpm.conf <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|group\s*=\s*nobody|group = ${PHP_FPM_GROUP}|g&quot;</span> /etc/php5/php-fpm.conf <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|;log_level\s*=\s*notice|log_level = notice|g&quot;</span> /etc/php5/php-fpm.conf <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/include\ \=\ \/etc\/php5\/fpm.d\/\*.conf/\;include\ \=\ \/etc\/php5\/fpm.d\/\*.conf/g&#39;</span> /etc/php5/php-fpm.conf
</span><span class='line'>
</span><span class='line'><span class="k">RUN</span> sed -i <span class="s2">&quot;s|display_errors\s*=\s*Off|display_errors = ${PHP_DISPLAY_ERRORS}|i&quot;</span> /etc/php5/php.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|display_startup_errors\s*=\s*Off|display_startup_errors = ${PHP_DISPLAY_STARTUP_ERRORS}|i&quot;</span> /etc/php5/php.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|error_reporting\s*=\s*E_ALL &amp; ~E_DEPRECATED &amp; ~E_STRICT|error_reporting = ${PHP_ERROR_REPORTING}|i&quot;</span> /etc/php5/php.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|;*memory_limit =.*|memory_limit = ${PHP_MEMORY_LIMIT}|i&quot;</span> /etc/php5/php.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|;*upload_max_filesize =.*|upload_max_filesize = ${PHP_MAX_UPLOAD}|i&quot;</span> /etc/php5/php.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|;*max_file_uploads =.*|max_file_uploads = ${PHP_MAX_FILE_UPLOAD}|i&quot;</span> /etc/php5/php.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|;*post_max_size =.*|post_max_size = ${PHP_MAX_POST}|i&quot;</span> /etc/php5/php.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|;*cgi.fix_pathinfo=.*|cgi.fix_pathinfo= ${PHP_CGI_FIX_PATHINFO}|i&quot;</span> /etc/php5/php.ini
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/smtp_port\ =\ 25/smtp_port\ =\ 81/g&#39;</span> /etc/php5/php.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/SMTP\ =\ localhost/SMTP\ =\ mail.bekkersolutions.com/g&#39;</span> /etc/php5/php.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/;sendmail_path\ =/sendmail_path\ =\ \/usr\/sbin\/sendmail\ -t/g&#39;</span> /etc/php5/php.ini
</span><span class='line'>
</span><span class='line'><span class="k">RUN</span> rm -rf /etc/localtime <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> ln -s /usr/share/zoneinfo/<span class="k">${</span><span class="nv">TIMEZONE</span><span class="k">}</span> /etc/localtime <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;${TIMEZONE}&quot;</span> &gt; /etc/timezone <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s2">&quot;s|;*date.timezone =.*|date.timezone = ${TIMEZONE}|i&quot;</span> /etc/php5/php.ini <span class="se">\ </span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s1">&#39;sendmail_path = &quot;/usr/sbin/ssmtp -t &quot;&#39;</span> &gt; /etc/php5/conf.d/mail.ini <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> sed -i <span class="s1">&#39;s/mailhub=mail/mailhub=mail.domain.com\:81/g&#39;</span> /etc/ssmtp/ssmtp.conf
</span><span class='line'>
</span><span class='line'>COPY nginx.conf /etc/nginx/nginx.conf
</span><span class='line'>COPY index.php /www/index.php
</span><span class='line'>COPY test.html /www/test.html
</span><span class='line'>COPY start_nginx.sh /start_nginx.sh
</span><span class='line'>COPY start_php-fpm5.sh /start_php-fpm5.sh
</span><span class='line'>COPY wrapper.sh /wrapper.sh
</span><span class='line'>
</span><span class='line'><span class="k">RUN</span> chmod +x /start_nginx.sh /start_php-fpm5.sh /wrapper.sh
</span><span class='line'>
</span><span class='line'><span class="k">CMD</span> <span class="o">[</span><span class="s2">&quot;/wrapper.sh&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, our <code>nginx.conf</code> configuration file:</p>

<figure class='code'><figcaption><span>nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='nginx'><span class='line'><span class="k">user</span>                            <span class="s">www</span><span class="p">;</span>
</span><span class='line'><span class="k">worker_processes</span>                <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">error_log</span>                       <span class="s">/var/log/nginx/error.log</span> <span class="s">warn</span><span class="p">;</span>
</span><span class='line'><span class="k">pid</span>                             <span class="s">/var/run/nginx.pid</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">events</span> <span class="p">{</span>
</span><span class='line'>    <span class="kn">worker_connections</span>          <span class="mi">1024</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">http</span> <span class="p">{</span>
</span><span class='line'>    <span class="kn">include</span>                     <span class="s">/etc/nginx/mime.types</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">default_type</span>                <span class="s">application/octet-stream</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">sendfile</span>                    <span class="no">on</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">access_log</span>                  <span class="s">/var/log/nginx/access.log</span><span class="p">;</span>
</span><span class='line'>    <span class="kn">keepalive_timeout</span>           <span class="mi">3000</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kn">server</span> <span class="p">{</span>
</span><span class='line'>        <span class="kn">listen</span>                  <span class="mi">80</span><span class="p">;</span>
</span><span class='line'>        <span class="kn">root</span>                    <span class="s">/www</span><span class="p">;</span>
</span><span class='line'>        <span class="kn">index</span>                   <span class="s">index.html</span> <span class="s">index.htm</span> <span class="s">index.php</span><span class="p">;</span>
</span><span class='line'>        <span class="kn">server_name</span>             <span class="s">_</span><span class="p">;</span>
</span><span class='line'>        <span class="kn">client_max_body_size</span>    <span class="mi">32m</span><span class="p">;</span>
</span><span class='line'>        <span class="kn">error_page</span>              <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span>  <span class="s">/50x.html</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kn">location</span> <span class="p">=</span> <span class="s">/50x.html</span> <span class="p">{</span>
</span><span class='line'>              <span class="kn">root</span>              <span class="s">/var/lib/nginx/html</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
</span><span class='line'>              <span class="kn">fastcgi_pass</span>      <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9000</span><span class="p">;</span>
</span><span class='line'>              <span class="kn">fastcgi_index</span>     <span class="s">index.php</span><span class="p">;</span>
</span><span class='line'>              <span class="kn">include</span>           <span class="s">fastcgi.conf</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then our directory, <code>html</code>  that will consist our websites data, for a simple example, I will create a sample <code>index.php</code> page which can be used:</p>

<figure class='code'><figcaption><span>html/index.php</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'><span class="nv">$word</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">echo</span> <span class="s2">&quot;The word is: </span><span class="si">$word\n</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, following our <code>wrapper.sh</code> script that will start our <code>php-fpm5</code>, and <code>nginx</code> processes, and then monitor these processes, if one of the processes have to exit, the wrapper script will return a exit code, which will result the container to exit, if there is anything wrong with the service:</p>

<p>The PHP-FPM script:</p>

<figure class='code'><figcaption><span>start_php-fpm5.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>/usr/bin/php-fpm5
</span></code></pre></td></tr></table></div></figure>


<p>The Nginx Script:</p>

<figure class='code'><figcaption><span>start_nginx.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>/usr/sbin/nginx -c /etc/nginx/nginx.conf
</span></code></pre></td></tr></table></div></figure>


<p>The Wrapper Script:</p>

<figure class='code'><figcaption><span>wrapper.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'>/start_php-fpm5.sh -D
</span><span class='line'><span class="nv">status</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$status</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;php-fpm5 Failed: $status&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="nv">$status</span>
</span><span class='line'>  <span class="k">else</span> <span class="nb">echo</span> <span class="s2">&quot;Starting PHP-FPM: OK&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>sleep 2
</span><span class='line'>
</span><span class='line'>/start_nginx.sh -D
</span><span class='line'><span class="nv">status</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$status</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;Nginx Failed: $status&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="nv">$status</span>
</span><span class='line'>  <span class="k">else</span> <span class="nb">echo</span> <span class="s2">&quot;Starting Nginx: OK&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>sleep 2
</span><span class='line'>
</span><span class='line'><span class="k">while</span> /bin/true<span class="p">;</span> <span class="k">do</span>
</span><span class='line'>  ps aux <span class="p">|</span> grep <span class="s1">&#39;php-fpm: master process&#39;</span> <span class="p">|</span> grep -q -v grep
</span><span class='line'>  <span class="nv">PHP_FPM_STATUS</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;Checking PHP-FPM, Status Code: $PHP_FPM_STATUS&quot;</span>
</span><span class='line'>  sleep 2
</span><span class='line'>
</span><span class='line'>  ps aux <span class="p">|</span> grep <span class="s1">&#39;nginx: master process&#39;</span> <span class="p">|</span> grep -q -v grep
</span><span class='line'>  <span class="nv">NGINX_STATUS</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;Checking NGINX, Status Code: $NGINX_STATUS&quot;</span>
</span><span class='line'>  sleep 2
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="o">[</span> <span class="nv">$PHP_FPM_STATUS</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span>
</span><span class='line'>    <span class="k">then</span>
</span><span class='line'>      <span class="nb">echo</span> <span class="s2">&quot;$(date +%F_%T) FATAL: PHP-FPM Raised a Status Code of $PHP_FPM_STATUS and exited&quot;</span>
</span><span class='line'>      <span class="nb">exit</span> -1
</span><span class='line'>
</span><span class='line'>   <span class="k">elif</span> <span class="o">[</span> <span class="nv">$NGINX_STATUS</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span>
</span><span class='line'>     <span class="k">then</span>
</span><span class='line'>       <span class="nb">echo</span> <span class="s2">&quot;$(date +%F_%T) FATAL: NGINX Raised a Status Code of $NGINX_STATUS and exited&quot;</span>
</span><span class='line'>       <span class="nb">exit</span> -1
</span><span class='line'>
</span><span class='line'>   <span class="k">else</span>
</span><span class='line'>     sleep 2
</span><span class='line'>        <span class="nb">echo</span> <span class="s2">&quot;$(date +%F_%T) - HealtCheck: NGINX and PHP-FPM: OK&quot;</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'>  sleep 60
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Building the Image:</h2>

<p>I am primarily using docker swarm, so I am building the image, and pushing to a private registry:</p>

<figure class='code'><figcaption><span>Build and Push the Image</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker build -t registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/alpine:php5 .
</span><span class='line'><span class="nv">$ </span>docker push registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/alpine:php5
</span></code></pre></td></tr></table></div></figure>


<p>Create the PHP Service:</p>

<figure class='code'><figcaption><span>Create a Docker Service</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service create <span class="se">\</span>
</span><span class='line'>--name php-app <span class="se">\</span>
</span><span class='line'>--network appnet <span class="se">\</span>
</span><span class='line'>--replicas <span class="m">3</span> <span class="se">\</span>
</span><span class='line'>--with-registry-auth registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/alpine:php5
</span></code></pre></td></tr></table></div></figure>


<p>For a Container from the Image on the Host:</p>

<figure class='code'><figcaption><span>Run a Container from the Image</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run -itd --name php-app -p 80:80 registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/alpine:php5
</span></code></pre></td></tr></table></div></figure>


<p>Test the Web App:</p>

<figure class='code'><figcaption><span>Make a GET Request</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1:80/
</span><span class='line'>The word is: foo
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/26/create-a-lightweight-webserver-service-with-lighttpd-on-alpine-running-on-docker-swarm/">Create a Lightweight Webserver (Service) With Lighttpd on Alpine Running on Docker Swarm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-26T17:37:19+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>5:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we will create a docker service that will host a static html website. We are using the <code>alpine:edge</code> image and using the <code>lighttpd</code> package as our webserver application.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>The Directory Structure:</h2>

<p>Our working directory consists of:</p>

<figure class='code'><figcaption><span>Directory Tree</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tree
</span><span class='line'>.
</span><span class='line'><span class="p">|</span>-- Dockerfile
</span><span class='line'><span class="sb">`</span>-- htdocs
</span><span class='line'>    <span class="sb">`</span>-- index.html
</span><span class='line'>
</span><span class='line'><span class="m">1</span> directory, <span class="m">2</span> files
</span></code></pre></td></tr></table></div></figure>


<p>First, our <code>Dockerfile</code>:</p>

<figure class='code'><figcaption><span>Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM alpine:edge
</span><span class='line'>
</span><span class='line'>RUN apk update <span class="se">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> apk add lighttpd <span class="se">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> rm -rf /var/cache/apk/*
</span><span class='line'>
</span><span class='line'>ADD htdocs /var/www/localhost/htdocs
</span><span class='line'>
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;lighttpd&quot;</span>, <span class="s2">&quot;-D&quot;</span>, <span class="s2">&quot;-f&quot;</span>, <span class="s2">&quot;/etc/lighttpd/lighttpd.conf&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then our <code>htdocs/index.html</code> which is based off bootstrap:</p>

<figure class='code'><figcaption><span>index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">content=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;author&quot;</span> <span class="na">content=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>Bare - Start Bootstrap Template<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- Bootstrap core CSS --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">&quot;https://objects.ruanbekker.com/assets/css/bootstrap/start-bootstrap-template/bootstrap.min.css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- Custom styles for this template --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;style&gt;</span>
</span><span class='line'>      <span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">padding-top</span><span class="o">:</span> <span class="m">54px</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">@media</span> <span class="o">(</span><span class="nt">min-width</span><span class="o">:</span> <span class="nt">992px</span><span class="o">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">padding-top</span><span class="o">:</span> <span class="m">56px</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- Navigation --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-expand-lg navbar-dark bg-dark fixed-top&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;navbar-brand&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Start Bootstrap<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;navbar-toggler&quot;</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;#navbarResponsive&quot;</span> <span class="na">aria-controls=</span><span class="s">&quot;navbarResponsive&quot;</span> <span class="na">aria-expanded=</span><span class="s">&quot;false&quot;</span> <span class="na">aria-label=</span><span class="s">&quot;Toggle navigation&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;navbar-toggler-icon&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/button&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;collapse navbar-collapse&quot;</span> <span class="na">id=</span><span class="s">&quot;navbarResponsive&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;navbar-nav ml-auto&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;nav-item active&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>              <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;nav-link&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Home
</span><span class='line'>                <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;sr-only&quot;</span><span class="nt">&gt;</span>(current)<span class="nt">&lt;/span&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/a&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;nav-item&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>              <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;nav-link&quot;</span> <span class="na">href=</span><span class="s">&quot;https://startbootstrap.com/template-overviews/bare/&quot;</span><span class="nt">&gt;</span>About<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;nav-item&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>              <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;nav-link&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Services<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;nav-item&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>              <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;nav-link&quot;</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Contact<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/nav&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- Page Content --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-lg-12 text-center&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">&quot;mt-5&quot;</span><span class="nt">&gt;</span>A Bootstrap 4 Starter Template<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>          <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;lead&quot;</span><span class="nt">&gt;</span>Complete with pre-defined file paths and responsive navigation!<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>          <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;list-unstyled&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;li&gt;</span>Bootstrap 4.0.0-beta<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>            <span class="nt">&lt;li&gt;</span>jQuery 3.2.1<span class="nt">&lt;/li&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- Bootstrap core JavaScript --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://objects.ruanbekker.com/assets/js/bootstrap/start-bootstrap-template/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://objects.ruanbekker.com/assets/js/bootstrap/start-bootstrap-template/popper.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://objects.ruanbekker.com/assets/js/bootstrap/start-bootstrap-template/bootstrap.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating the Service:</h2>

<p>First we will need to build the image, for my personal projects, I like to use gitlab&rsquo;s private registry, but there are many to choose from:</p>

<figure class='code'><figcaption><span>Build the Image</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker login registry.gitlab.com
</span><span class='line'><span class="nv">$ </span>docker build -t registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/lighttpd:bootstrap .
</span><span class='line'><span class="nv">$ </span>docker push registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/lighttpd:bootstrap
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s many ways we can create the service, like using this service as a backend application, where nginx or traefik can proxy the requests through, but in this case we have nothing listening on port 80, so we will create the service and publish port 80 to the service, from the host:</p>

<figure class='code'><figcaption><span>Create the Service</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service create <span class="se">\</span>
</span><span class='line'>--name web-bootstrap <span class="se">\</span>
</span><span class='line'>--replicas <span class="m">1</span> <span class="se">\</span>
</span><span class='line'>--network appnet <span class="se">\</span>
</span><span class='line'>--with-registry-auth registry.gitlab.com/&lt;user&gt;/&lt;repo&gt;/lighttpd:bootstrap
</span></code></pre></td></tr></table></div></figure>


<h2>Accessing your Website:</h2>

<p>As this service will serve as our website, it should look more or less like the following:</p>

<p><img src="https://user-images.githubusercontent.com/567298/53353187-dd8f2180-392c-11e9-93fe-fce614068866.jpg" alt="" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/26/structured-search-with-elasticsearch/">Structured Search With Elasticsearch</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-26T05:42:19+02:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>5:42 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/structured-search.html">Structured Search</a> with Elasticsearch:</p>

<p><img src="https://dl.dropboxusercontent.com/u/31991539/images/sysadmins/elasticsearch-logo.png" alt="" /></p>

<p>In this post we will ingest some dummy data into elasticsearch, then we will perform some queries to get the following info:</p>

<ul>
<li>Student Names</li>
<li>Student Ages</li>
<li>Include / Exclude</li>
<li>Marks greater than</li>
<li>Finding Students with Specific marks, etc.</li>
</ul>


<h2>Create the Mapping for our Index:</h2>

<p>for our Data as we wont use the <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/dynamic-mapping.html">Dynamic Mapping</a> that comes with by default:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XPUT http://127.0.0.1:9200/school -d '
</span><span class='line'>{
</span><span class='line'>  "mappings": {
</span><span class='line'>    "students": {
</span><span class='line'>      "properties": {
</span><span class='line'>        "name": {"type": "string"},
</span><span class='line'>        "marks": {"type": "short"},
</span><span class='line'>        "gender": {"type": "string"},
</span><span class='line'>        "age": {"type": "short"}
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<h2>Ingesting the Data into Elasticsearch:</h2>

<p>You can either using the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPOST http://127.0.0.1:9200/school/students/ -d ' {"name": "james", "marks": 60, "gender": "male", "age": 14} '
</span><span class='line'>curl -XPOST http://127.0.0.1:9200/school/students/ -d ' {"name": "simon", "marks": 70, "gender": "male", "age": 15} '
</span><span class='line'>curl -XPOST http://127.0.0.1:9200/school/students/ -d ' {"name": "samantha", "marks": 70, "gender": "female", "age": 14} '
</span><span class='line'>curl -XPOST http://127.0.0.1:9200/school/students/ -d ' {"name": "john", "marks": 60, "gender": "male", "age": 14} '
</span><span class='line'>curl -XPOST http://127.0.0.1:9200/school/students/ -d ' {"name": "michelle", "marks": 30, "gender": "female", "age": 14} '
</span><span class='line'>curl -XPOST http://127.0.0.1:9200/school/students/ -d ' {"name": "max", "marks": 75, "gender": "female", "age": 15} '
</span><span class='line'>curl -XPOST http://127.0.0.1:9200/school/students/ -d ' {"name": "frank", "marks": 79, "gender": "male", "age": 15} '</span></code></pre></td></tr></table></div></figure>


<p>or using the Bulk API:</p>

<p>Save the following as <code>bulk.json</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{"index" : {"_index" : "school", "_type" : "students", "_id" : "AV4cYob6VgXGdBeaBa1c" } }
</span><span class='line'>{"name": "james", "marks": 60, "gender": "male", "age": 14}
</span><span class='line'>{"index" : {"_index" : "school", "_type" : "students", "_id" : "AV4cYqU3VgXGdBeaBa1d" } }
</span><span class='line'>{"name": "simon", "marks": 70, "gender": "male", "age": 15}
</span><span class='line'>{"index" : {"_index" : "school", "_type" : "students", "_id" : "AV4cYrzFVgXGdBeaBa1v" } }
</span><span class='line'>{"name": "samantha", "marks": 70, "gender": "female", "age": 14}
</span><span class='line'>{"index" : {"_index" : "school", "_type" : "students", "_id" : "AV4cYtuUVgXGdBeaBa2I" } }
</span><span class='line'>{"name": "john", "marks": 60, "gender": "male", "age": 14}
</span><span class='line'>{"index" : {"_index" : "school", "_type" : "students", "_id" : "AV4cYvMOVgXGdBeaBa2K" } }
</span><span class='line'>{"name": "michelle", "marks": 30, "gender": "female", "age": 14}
</span><span class='line'>{"index" : {"_index" : "school", "_type" : "students", "_id" : "AV4cYwwnVgXGdBeaBa2j" } }
</span><span class='line'>{"name": "max", "marks": 75, "gender": "female", "age": 15}
</span><span class='line'>{"index" : {"_index" : "school", "_type" : "students", "_id" : "AV4cYyXYVgXGdBeaBa29" } }
</span><span class='line'>{"name": "frank", "marks": 79, "gender": "male", "age": 15}</span></code></pre></td></tr></table></div></figure>


<p>Then use the Bulk API to Ingest into Elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XPOST http://127.0.0.1:9200/_bulk --data-binary @bulk.json</span></code></pre></td></tr></table></div></figure>


<p>Then you should have 7 documents ingested into Elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://10.4.156.13:9200/_cat/indices/school?v
</span><span class='line'>health status index  pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>yellow open   school   5   1          7            0     19.4kb         19.4kb</span></code></pre></td></tr></table></div></figure>


<p>You should notice that I have a yellow state, as this is a single instance where I am running elasticsearch on, so there will be unassigned shards.</p>

<h2>Query Student Names:</h2>

<p>Let&rsquo;s search for the Student with the Name <code>Max</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://10.4.156.13:9200/school/students/_search?pretty -d '{"query": {"term" : {"name" : "max"}}}'</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "took" : 5,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [ {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cRqaLVgXGdBeaBaWD",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "max",
</span><span class='line'>        "marks" : 75,
</span><span class='line'>        "gender" : "female",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    } ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Search Student Ages:</h2>

<p>Search for all students with the age of <code>15</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://10.4.156.13:9200/school/students/_search?pretty -d '{"query": {"term" : {"age" : 15}}}'</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "took" : 14,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 3,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [ {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cRWPPVgXGdBeaBaVF",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "simon",
</span><span class='line'>        "marks" : 70,
</span><span class='line'>        "gender" : "male",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    }, {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cRqaLVgXGdBeaBaWD",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "max",
</span><span class='line'>        "marks" : 75,
</span><span class='line'>        "gender" : "female",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    }, {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cRxayVgXGdBeaBaWg",
</span><span class='line'>      "_score" : 0.30685282,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "frank",
</span><span class='line'>        "marks" : 79,
</span><span class='line'>        "gender" : "male",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    } ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Query, Include but also Exclude:</h2>

<p>Query everyone that is 14, and which is males, except the Student called John:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://10.4.156.13:9200/school/students/_search?pretty -d '
</span><span class='line'>{
</span><span class='line'>   "query" : {
</span><span class='line'>      "constant_score" : {
</span><span class='line'>         "filter" : {
</span><span class='line'>            "bool" : {
</span><span class='line'>              "should" : [
</span><span class='line'>                 { "term" : {"age" : 14}},
</span><span class='line'>                 { "term" : {"gender" : "male"}}
</span><span class='line'>              ],
</span><span class='line'>              "must_not" : {
</span><span class='line'>                 "term" : {"name" : "john"}
</span><span class='line'>              }
</span><span class='line'>           }
</span><span class='line'>         }
</span><span class='line'>      }
</span><span class='line'>   }
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"hits" : {
</span><span class='line'>  "total" : 5,
</span><span class='line'>  "max_score" : 1.0,
</span><span class='line'>  "hits" : [ {
</span><span class='line'>    "_index" : "school",
</span><span class='line'>    "_type" : "students",
</span><span class='line'>    "_id" : "AV4cYob6VgXGdBeaBa1c",
</span><span class='line'>    "_score" : 1.0,
</span><span class='line'>    "_source" : {
</span><span class='line'>      "name" : "james",
</span><span class='line'>      "marks" : 60,
</span><span class='line'>      "gender" : "male",
</span><span class='line'>      "age" : 14
</span><span class='line'>    }
</span><span class='line'>  }, {
</span><span class='line'>    "_index" : "school",
</span><span class='line'>    "_type" : "students",
</span><span class='line'>    "_id" : "AV4cYvMOVgXGdBeaBa2K",
</span><span class='line'>    "_score" : 1.0,
</span><span class='line'>    "_source" : {
</span><span class='line'>      "name" : "michelle",
</span><span class='line'>      "marks" : 30,
</span><span class='line'>      "gender" : "female",
</span><span class='line'>      "age" : 14
</span><span class='line'>    }
</span><span class='line'>  }, {
</span><span class='line'>    "_index" : "school",
</span><span class='line'>    "_type" : "students",
</span><span class='line'>    "_id" : "AV4cYyXYVgXGdBeaBa29",
</span><span class='line'>    "_score" : 1.0,
</span><span class='line'>    "_source" : {
</span><span class='line'>      "name" : "frank",
</span><span class='line'>      "marks" : 79,
</span><span class='line'>      "gender" : "male",
</span><span class='line'>      "age" : 15
</span><span class='line'>    }
</span><span class='line'>  }, {
</span><span class='line'>    "_index" : "school",
</span><span class='line'>    "_type" : "students",
</span><span class='line'>    "_id" : "AV4cYqU3VgXGdBeaBa1d",
</span><span class='line'>    "_score" : 1.0,
</span><span class='line'>    "_source" : {
</span><span class='line'>      "name" : "simon",
</span><span class='line'>      "marks" : 70,
</span><span class='line'>      "gender" : "male",
</span><span class='line'>      "age" : 15
</span><span class='line'>    }
</span><span class='line'>  }, {
</span><span class='line'>    "_index" : "school",
</span><span class='line'>    "_type" : "students",
</span><span class='line'>    "_id" : "AV4cYrzFVgXGdBeaBa1v",
</span><span class='line'>    "_score" : 1.0,
</span><span class='line'>    "_source" : {
</span><span class='line'>      "name" : "samantha",
</span><span class='line'>      "marks" : 70,
</span><span class='line'>      "gender" : "female",
</span><span class='line'>      "age" : 14
</span><span class='line'>    }
</span><span class='line'>  } ]
</span><span class='line'>}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Query for Age, Gender with High Grades:</h2>

<p>Show me everyone thats 14 years old, including males, but only with scores better than 70 and up</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://10.4.156.13:9200/school/students/_search?pretty -d '
</span><span class='line'>{
</span><span class='line'>   "query" : {
</span><span class='line'>      "constant_score" : {
</span><span class='line'>         "filter" : {
</span><span class='line'>            "bool" : {
</span><span class='line'>              "should" : [
</span><span class='line'>                 { "term" : {"age" : 14}},
</span><span class='line'>                 { "term" : {"gender" : "male"}}
</span><span class='line'>              ],
</span><span class='line'>              "must_not" : {
</span><span class='line'>                 "range" : {"marks": {"lt": 70, "gte": 0}}
</span><span class='line'>              }
</span><span class='line'>           }
</span><span class='line'>         }
</span><span class='line'>      }
</span><span class='line'>   }
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<h2>Everyone that got 70 and more:</h2>

<p>Show me all the students that has marks of 70 and above:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://10.4.156.13:9200/school/students/_search?pretty -d '
</span><span class='line'>{
</span><span class='line'>   "query" : {
</span><span class='line'>      "constant_score" : {
</span><span class='line'>         "filter" : {
</span><span class='line'>            "bool" : {
</span><span class='line'>            "must" : [
</span><span class='line'>              { "range" : {"marks" : {"lt": 100, "gte": 70}}}
</span><span class='line'>            ]
</span><span class='line'>          }
</span><span class='line'>        }              
</span><span class='line'>     }
</span><span class='line'>   }
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "took" : 6,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 4,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [ {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYwwnVgXGdBeaBa2j",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "max",
</span><span class='line'>        "marks" : 75,
</span><span class='line'>        "gender" : "female",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    }, {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYyXYVgXGdBeaBa29",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "frank",
</span><span class='line'>        "marks" : 79,
</span><span class='line'>        "gender" : "male",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    }, {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYqU3VgXGdBeaBa1d",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "simon",
</span><span class='line'>        "marks" : 70,
</span><span class='line'>        "gender" : "male",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    }, {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYrzFVgXGdBeaBa1v",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "samantha",
</span><span class='line'>        "marks" : 70,
</span><span class='line'>        "gender" : "female",
</span><span class='line'>        "age" : 14
</span><span class='line'>      }
</span><span class='line'>    } ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Or you can do it like this:</p>

<h2>Query Range only with <code>gt</code>:</h2>

<p>Show me everyone that got more than 70:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://10.4.156.13:9200/school/students/_search?pretty -d '
</span><span class='line'>{
</span><span class='line'>   "query" : {
</span><span class='line'>      "constant_score" : {
</span><span class='line'>         "filter" : {
</span><span class='line'>            "bool" : {
</span><span class='line'>              "must" : [
</span><span class='line'>                { "range" : {"marks" : {"gt": 70}}}
</span><span class='line'>            ]
</span><span class='line'>          }
</span><span class='line'>        }              
</span><span class='line'>     }
</span><span class='line'>   }
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "took" : 7,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 2,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [ {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYwwnVgXGdBeaBa2j",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "max",
</span><span class='line'>        "marks" : 75,
</span><span class='line'>        "gender" : "female",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    }, {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYyXYVgXGdBeaBa29",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "frank",
</span><span class='line'>        "marks" : 79,
</span><span class='line'>        "gender" : "male",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    } ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Gender Specific, with Grades more than 70:</h2>

<p>Show me females that has more than 70:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://10.4.156.13:9200/school/students/_search?pretty -d '
</span><span class='line'>{
</span><span class='line'>   "query" : {
</span><span class='line'>      "constant_score" : {
</span><span class='line'>         "filter" : {
</span><span class='line'>            "bool" : {
</span><span class='line'>            "must" : [
</span><span class='line'>              { "range" : {"marks" : {"lt": 100, "gte": 70}}}
</span><span class='line'>            ],
</span><span class='line'>            "must_not": [
</span><span class='line'>              {"term": {"gender": "male"}}
</span><span class='line'>            ]
</span><span class='line'>          }
</span><span class='line'>        }              
</span><span class='line'>     }
</span><span class='line'>   }
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "took" : 13,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 2,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [ {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYwwnVgXGdBeaBa2j",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "max",
</span><span class='line'>        "marks" : 75,
</span><span class='line'>        "gender" : "female",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    }, {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYrzFVgXGdBeaBa1v",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "samantha",
</span><span class='line'>        "marks" : 70,
</span><span class='line'>        "gender" : "female",
</span><span class='line'>        "age" : 14
</span><span class='line'>      }
</span><span class='line'>    } ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Grade Specific:</h2>

<p>Show me the ones that got 30 and 75:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://10.4.156.13:9200/school/students/_search?pretty -d '
</span><span class='line'>{
</span><span class='line'>   "query" : {
</span><span class='line'>      "constant_score" : {
</span><span class='line'>         "filter" : {
</span><span class='line'>            "terms" : {
</span><span class='line'>              "marks": [30, 75]
</span><span class='line'>            }
</span><span class='line'>         }
</span><span class='line'>      }
</span><span class='line'>   }
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "took" : 6,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 2,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [ {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYwwnVgXGdBeaBa2j",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "max",
</span><span class='line'>        "marks" : 75,
</span><span class='line'>        "gender" : "female",
</span><span class='line'>        "age" : 15
</span><span class='line'>      }
</span><span class='line'>    }, {
</span><span class='line'>      "_index" : "school",
</span><span class='line'>      "_type" : "students",
</span><span class='line'>      "_id" : "AV4cYvMOVgXGdBeaBa2K",
</span><span class='line'>      "_score" : 1.0,
</span><span class='line'>      "_source" : {
</span><span class='line'>        "name" : "michelle",
</span><span class='line'>        "marks" : 30,
</span><span class='line'>        "gender" : "female",
</span><span class='line'>        "age" : 14
</span><span class='line'>      }
</span><span class='line'>    } ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>For more information on this, have a look at <a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/structured-search.html">Elasticsearch: Structured Search</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/25">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/23">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/09/08/reindex-elasticsearch-indices-with-logstash/">Reindex Elasticsearch Indices With Logstash</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/09/05/deploy-a-monitoring-stack-on-docker-swarm-with-grafana-and-prometheus/">Deploy a Monitoring Stack on Docker Swarm With Grafana and Prometheus</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/09/04/deploy-traefik-using-bekker-stacks/">Deploy Traefik Using Bekker Stacks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/09/04/aws-s3-kms-and-python-for-secrets-management/">AWS S3 KMS and Python for Secrets Management</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/07/making-deploying-functions-even-easier-with-faas-cli-up-using-openfaas/">Making Deploying Functions Even Easier With Faas-cli Up Using OpenFaaS</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>

</body>
</html>
