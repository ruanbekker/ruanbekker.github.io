
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="Beeline Error: FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.tez.TezTask (state=08S01,code=1) Issue: Some time ago, I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="http://blog.ruanbekker.com/posts/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.ruan.dev/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/28/queries-failing-via-beeline-due-to-anonymous-user/">Queries Failing via Beeline Due to Anonymous User</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-28T12:25:12-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>12:25 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Beeline Error: <code>FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.tez.TezTask (state=08S01,code=1)</code></p>

<h2>Issue:</h2>

<p>Some time ago, I assisted a customer who was trying to do a select count(*) via beeline and failed with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[hadoop@ip-10-10-9-226 ~]$ beeline -u jdbc:hive2://nn-emr.sysint.dxone.local:10000/default --silent=true --outputformat=csv2 -e "select count(*) from basetables_rms.rms_site"
</span><span class='line'>19/04/26 06:41:15 [main]: WARN jdbc.HiveConnection: Request to set autoCommit to false; Hive does not support autoCommit=false.
</span><span class='line'>Error: Error while processing statement: FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.tez.TezTask (state=08S01,code=1)</span></code></pre></td></tr></table></div></figure>


<p>When reproducing this I found a jira: <a href="https://issues.apache.org/jira/browse/HIVE-14631">https://issues.apache.org/jira/browse/HIVE-14631</a> which related to the same issue and the workaround was to switch your execution engine to mapreduce. By doing that, it worked, but wanted a better resolution for the customer.</p>

<h2>Debugging:</h2>

<p>When setting enabling debugging, I found that the error is related to permissions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ beeline  -u jdbc:hive2://172.31.31.247:10000/default --silent=false --outputformat=csv2 -e "select count(*) from testdb.users"
</span><span class='line'>Connecting to jdbc:hive2://172.31.31.247:10000/default
</span><span class='line'>Connected to: Apache Hive (version 2.1.1-amzn-0)
</span><span class='line'>Driver: Hive JDBC (version 2.1.1-amzn-0)
</span><span class='line'>19/04/26 10:24:01 [main]: WARN jdbc.HiveConnection: Request to set autoCommit to false; Hive does not support autoCommit=false.
</span><span class='line'>...
</span><span class='line'>ERROR : Failed to execute tez graph.
</span><span class='line'>org.apache.hadoop.security.AccessControlException: Permission denied: user=anonymous, access=WRITE, inode="/user/anonymous":hdfs:hadoop:drwxr-xr-x</span></code></pre></td></tr></table></div></figure>


<p>So it seems that when the client (anonymous) is trying to copy the hive execution jar to is home path in HDFS, in this case (/home/anonymous/.hiveJars/) it fails due to permissions.</p>

<h2>Resolution:</h2>

<p>By passing the hadoop user, I was able to get the expected results:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ beeline -n hadoop -u jdbc:hive2://172.31.31.247:10000/default --silent=false --outputformat=csv2 -e "select count(*) from testdb.users"
</span><span class='line'>INFO  : Completed executing command(queryId=hive_20190426103246_33253d86-3ebc-462f-a5a1-f01877dd00a8); Time taken: 17.08 seconds
</span><span class='line'>INFO  : OK
</span><span class='line'>c0
</span><span class='line'>1
</span><span class='line'>1 row selected (17.282 seconds)</span></code></pre></td></tr></table></div></figure>


<p>Listing the mentioned jar:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ hdfs dfs -ls /user/hadoop/.hiveJars/
</span><span class='line'>Found 1 items
</span><span class='line'>-rw-r--r--   1 hadoop hadoop   32447131 2019-04-26 09:51 /user/hadoop/.hiveJars/hive-exec-2.1.1-amzn-0-ac46be4721493d9e62fd1b132ecee3d20fd283680edbc0cfa9809c656a493469.jar</span></code></pre></td></tr></table></div></figure>


<p>Hope this might help someone facing the same issue</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/23/using-drone-ci-to-build-a-jekyll-site-and-deploy-to-docker-swarm/">Using Drone CI to Build a Jekyll Site and Deploy to Docker Swarm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-23T17:57:02-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2019</span></span> <span class='time'>5:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/56618556-3de7ca00-6623-11e9-995f-c22792f0ab21.png" alt="image" /></p>

<p>CICD Pipelines! &lt;3</p>

<p>In this post I will show you how to setup a cicd pipeline using drone to build a jekyll site and deploy to docker swarm.</p>

<h2>Environment Overview</h2>

<p><strong>Jekyll&rsquo;s Codebase</strong>: Our code will be hosted on Github (I will demonstrate how to set it up from scratch)</p>

<p><strong>Secret Store</strong>: Our secrets such as ssh key, swarm host address etc will be stored in drones secrets manager</p>

<p><strong>Docker Swarm</strong>: Docker Swarm has Traefik as a HTTP Loadbalancer</p>

<p><strong>Drone Server and Agent</strong>: If you dont have drone, you can setup <a href="https://blog.ruanbekker.com/blog/2019/04/18/setup-a-drone-cicd-environment-on-docker-with-letsencrypt/">drone server and agent on docker</a> or have a look at <a href="https://cloud.drone.io">cloud.drone.io</a></p>

<p><strong>Workflow:</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* Whenever a push to master is receive on github, the pipeline will be triggered
</span><span class='line'>* The content from our github repository will be cloned to the agent on a container
</span><span class='line'>* Jekyll will build and the output will be transferred to docker swarm using rsync
</span><span class='line'>* The docker-compose.yml will be transferred to the docker swarm host using scp
</span><span class='line'>* A docker stack deploy is ran via ssh</span></code></pre></td></tr></table></div></figure>


<h2>Install Jekyll Locally</h2>

<p>Install Jekyll locally, as we will use it to create the initial site. I am using a mac, so I will be using <code>brew</code>. For other operating systems, have a look at <a href="https://jekyllrb.com/docs/installation/">this post</a>.</p>

<p>I will be demonstrating with a weightloss blog as an example.</p>

<p>Install jekyll:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew install jekyll</span></code></pre></td></tr></table></div></figure>


<p>Go ahead and create a new site which will host the data for your jekyll site:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ jekyll new blog-weightloss</span></code></pre></td></tr></table></div></figure>


<h2>Create a Github Repository</h2>

<p>First we need to create an empty github repository, in my example it was <code>github.com/ruanbekker/blog-weightloss.git</code>. Once you create the repo change into the directory created by the <code>jekyll new</code> command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd blog-weightloss</span></code></pre></td></tr></table></div></figure>


<p>Now initialize git, set the remote, add the jekyll data and push to github:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git init
</span><span class='line'>$ git remote add origin git@github.com:ruanbekker/blog-weightloss.git # &lt;== change to your repository
</span><span class='line'>$ git add .
</span><span class='line'>$ git commit -m "first commit"
</span><span class='line'>$ git push origin master</span></code></pre></td></tr></table></div></figure>


<p>You should see your data on your github repository.</p>

<h2>Create Secrets on Drone</h2>

<p>Logon to the Drone UI, sync repositories, activate the new repository and head over to settings where you will find the secrets section.</p>

<p>Add the following secrets:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Secret Name: swarm_host
</span><span class='line'>Secret Value: ip address of your swarm
</span><span class='line'>
</span><span class='line'>Secret Name: swarm_key
</span><span class='line'>Secret Value: contents of your private ssh key
</span><span class='line'>
</span><span class='line'>Secret Name: swarm_user
</span><span class='line'>Secret Value: the user that is allowed to ssh</span></code></pre></td></tr></table></div></figure>


<p>You should see the following:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56619871-5c4fc480-6627-11e9-8820-c9d4ddff698c.png" alt="image" /></p>

<h2>Add the Drone Config</h2>

<p>Drone looks from a <code>.drone.yml</code> file in the root directory for instructions on how to do its tasks. Lets go ahead and declare our pipeline:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim .drone.yml</span></code></pre></td></tr></table></div></figure>


<p>And populate the drone config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pipeline:
</span><span class='line'>  jekyll-build:
</span><span class='line'>    image: jekyll/jekyll:latest
</span><span class='line'>    commands:
</span><span class='line'>      - touch Gemfile.lock
</span><span class='line'>      - chmod a+w Gemfile.lock
</span><span class='line'>      - chown -R jekyll:jekyll /drone
</span><span class='line'>      - gem update --system
</span><span class='line'>      - gem install bundler
</span><span class='line'>      - bundle install
</span><span class='line'>      - bundle exec jekyll build
</span><span class='line'>
</span><span class='line'>  transfer-build:
</span><span class='line'>    image: drillster/drone-rsync
</span><span class='line'>    hosts:
</span><span class='line'>      from_secret: swarm_host
</span><span class='line'>    key:
</span><span class='line'>      from_secret: swarm_key
</span><span class='line'>    user:
</span><span class='line'>      from_secret: swarm_user
</span><span class='line'>    source: ./*
</span><span class='line'>    target: ~/my-weightloss-blog.com
</span><span class='line'>    recursive: true
</span><span class='line'>    delete: true
</span><span class='line'>    when:
</span><span class='line'>      branch: [master]
</span><span class='line'>      event: [push]
</span><span class='line'>
</span><span class='line'>  transfer-compose:
</span><span class='line'>    image: appleboy/drone-scp
</span><span class='line'>    host:
</span><span class='line'>      from_secret: swarm_host
</span><span class='line'>    username:
</span><span class='line'>      from_secret: swarm_user
</span><span class='line'>    key:
</span><span class='line'>      from_secret: swarm_key
</span><span class='line'>    target: /root/my-weightloss-blog.com
</span><span class='line'>    source:
</span><span class='line'>      - docker-compose.yml
</span><span class='line'>    when:
</span><span class='line'>      branch: [master]
</span><span class='line'>      event: [push]
</span><span class='line'>
</span><span class='line'>  deploy-jekyll-to-swarm:
</span><span class='line'>    image: appleboy/drone-ssh
</span><span class='line'>    host:
</span><span class='line'>      from_secret: swarm_host
</span><span class='line'>    username:
</span><span class='line'>      from_secret: swarm_user
</span><span class='line'>    key:
</span><span class='line'>      from_secret: swarm_key
</span><span class='line'>    port: 22
</span><span class='line'>    script:
</span><span class='line'>      - docker stack deploy --prune -c /root/my-weightloss-blog.com/docker-compose.yml apps
</span><span class='line'>    when:
</span><span class='line'>      branch: [master]
</span><span class='line'>      event: [push]</span></code></pre></td></tr></table></div></figure>


<h2>Notifications?</h2>

<p>If you want to be notified about your builds, you can add a slack notification step as the last step.</p>

<p>To do that, create a new webhook integration, you can <a href="https://blog.ruanbekker.com/blog/2019/04/18/setup-a-slack-webhook-for-sending-messages-from-applications/">follow this post for a step by step guide</a>. After you have the webhook, go to secrets and create a <code>slack_webhook</code> secret.</p>

<p>Then apply the notification step as shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  notify-via-slack:
</span><span class='line'>    image: plugins/slack
</span><span class='line'>    webhook:
</span><span class='line'>      from_secret: slack_webhook
</span><span class='line'>    channel: system_events
</span><span class='line'>    template: &gt;
</span><span class='line'>      
</span><span class='line'>        [DRONE CI]: ** : /
</span><span class='line'>        ( -  | )
</span><span class='line'>
</span><span class='line'>      
</span><span class='line'>        [DRONE CI]: ** : /
</span><span class='line'>        ( -  | )
</span><span class='line'>      </span></code></pre></td></tr></table></div></figure>


<p>Based on the status, you should get a notification similar like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56622206-6e356580-662f-11e9-8d93-286c9c126d24.png" alt="image" /></p>

<h2>Add the Docker Compose</h2>

<p>Next we need to declare our docker compose file which is needed to deploy our jekyll service to the swarm:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim docker-compose.yml</span></code></pre></td></tr></table></div></figure>


<p>And populate this info (just change the values for your own environment/settings):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.5&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">myweightlossblog</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ruanbekker/jekyll:contrast</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">jekyll serve --watch --force_polling --verbose</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/root/my-weightloss-blog.com:/srv/jekyll</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">replicated</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.backend.loadbalancer.sticky=false&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.backend.loadbalancer.swarm=true&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.backend=myweightlossblog&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.docker.network=appnet&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.entrypoints=https&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.frontend.passHostHeader=true&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.frontend.rule=Host:www.my-weightloss-blog.com,my-weightloss-blog.com&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.port=4000&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">update_config</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">parallelism</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>        <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">restart_policy</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">condition</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">on-failure</span>
</span><span class='line'>      <span class="l-Scalar-Plain">placement</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">node.role == manager</span>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">appnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Push to Github</h2>

<p>Now we need to push our <code>.drone.yml</code> and <code>docker-compose.yml</code> to github. Since the repository is activated on drone, any push to master will trigger the pipeline, so after this push we should go to drone to look at our pipeline running.</p>

<p>Add the untracked files and push to github:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ git add .drone.yml</span>
</span><span class='line'><span class="l-Scalar-Plain">$ git add docker-compose.yml</span>
</span><span class='line'><span class="l-Scalar-Plain">$ git commit -m &quot;add drone and docker config&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">$ git push origin master</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you head over to your drone ui, you should see your pipeline output which will look more or less like this (just look how pretty it is! :D )</p>

<p><img src="https://user-images.githubusercontent.com/567298/56620236-91a8e200-6628-11e9-9278-38e3305fdcd7.png" alt="image" /></p>

<h2>Test Jekyll</h2>

<p>If your deployment has completed you should be able to access your application on the configured domain. A screenshot of my response when accessing Jekyll:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56620280-af764700-6628-11e9-9d4f-c2592e6cf561.png" alt="image" /></p>

<p>Absolutely Amazingness! I really love drone!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/23/setup-a-blog-with-hugo/">Setup a Blog With Hugo</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-23T05:41:10-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2019</span></span> <span class='time'>5:41 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/30043398/56571367-13632600-65bd-11e9-816e-a18785233e38.png" alt="image" /></p>

<p>In this post we will setup a blog on <a href="https://gohugo.io">hugo</a> and using the theme <a href="https://github.com/mismith0227/hugo_theme_pickles">pickles</a>.</p>

<h2>What is Hugo</h2>

<p>Hugo is a Open-Source Static Site Generator which runs on Golang.</p>

<h2>Installing Hugo</h2>

<p>Im using a mac so I will be installing hugo with brew, for other operating systems, you can have a look at <a href="https://gohugo.io/getting-started/installing/">their documentation</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ brew install hugo</span></code></pre></td></tr></table></div></figure>


<p>Create your new site:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ hugo new site myblog</span></code></pre></td></tr></table></div></figure>


<h2>Install a Theme</h2>

<p>We will use a 3rd party theme, go ahead and install the pickles theme:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone -b release https://github.com/mismith0227/hugo_theme_pickles themes/pickles</span></code></pre></td></tr></table></div></figure>


<h2>Custom Syntax Highlighting</h2>

<p>Generate syntax highlight css, for a list of other styles <a href="https://help.farbox.com/pygments.html">see this post</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p static/css
</span><span class='line'>$ hugo gen chromastyles --style=colorful &gt; static/css/syntax.css</span></code></pre></td></tr></table></div></figure>


<p>Append this below <code>style.css</code> in <code>themes/pickles/layouts/partials/head.html</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;link rel="stylesheet" href="/css/syntax.css"/&gt;</span></code></pre></td></tr></table></div></figure>


<p>set pygments settings in <code>config.toml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>baseURL = "http://example.org/"
</span><span class='line'>languageCode = "en-us"
</span><span class='line'>pygmentsCodeFences = true
</span><span class='line'>pygmentsUseClasses = true
</span><span class='line'>title = "My Hugo Site"</span></code></pre></td></tr></table></div></figure>


<h2>Create your First Blogpost</h2>

<p>Create your first post:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ hugo new posts/my-first-post.md
</span><span class='line'>/Users/ruan/myblog/content/posts/my-first-post.md created</span></code></pre></td></tr></table></div></figure>


<p>Populate your page with some data:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---
</span><span class='line'>title: "My First Post"
</span><span class='line'>date: 2019-04-23T09:39:23+02:00
</span><span class='line'>description: This is an introduction post to showcase Hugo.
</span><span class='line'>slug: hello-world-my-first-post
</span><span class='line'>categories:
</span><span class='line'>- hugo
</span><span class='line'>- blog
</span><span class='line'>tags:
</span><span class='line'>- helloworld
</span><span class='line'>- hugo
</span><span class='line'>- blog
</span><span class='line'>draft: false
</span><span class='line'>---
</span><span class='line'>
</span><span class='line'>![](https://hugo-simple-blog.work/images/uploads/gopher_hugo.png)
</span><span class='line'>
</span><span class='line'>Hello world and welcome to my first post
</span><span class='line'>
</span><span class='line'>## New Beginning
</span><span class='line'>
</span><span class='line'>This is a new beginning on my blog on hugo and this seems pretty cool so im adding random text here because I dont know **what** to add here. So im adding a lot more random text here.
</span><span class='line'>
</span><span class='line'>This is another test.
</span><span class='line'>
</span><span class='line'>## Code
</span><span class='line'>
</span><span class='line'>This is python code:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>from random import randint
</span><span class='line'>from faker import Fake
</span><span class='line'>randint(1, 2)
</span><span class='line'>
</span><span class='line'>destFile = "largedataset-" + timestart + ".txt"
</span><span class='line'>file_object = open(destFile,"a")
</span><span class='line'>file_object.write("uuid" + "," + "username" + "," + "name" + "," + "country" + "\n")
</span><span class='line'>
</span><span class='line'>def create_names(fake):
</span><span class='line'>    for x in range(numberRuns):
</span><span class='line'>        genUname = fake.slug()
</span><span class='line'>        genName =  fake.first_name()
</span><span class='line'>        genCountry = fake.country()
</span><span class='line'>file_object.write(genUname + "," + genName + "," + genCountry + "\n")
</span><span class='line'>..
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>This is bash code:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>#!/usr/bin/env bash
</span><span class='line'>var="ruan"
</span><span class='line'>echo "Hello, ${var}"
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>## Tweets
</span><span class='line'>
</span><span class='line'>This is one of my tweets, see [configuration](https://gohugo.io/content-management/shortcodes/#highlight) for more shortcodes:
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>## Tables
</span><span class='line'>
</span><span class='line'>This is a table:
</span><span class='line'>
</span><span class='line'>|**id**    |**name**|**surname**|**age**| **city**     |
</span><span class='line'>|----------|--------|-----------|-------|--------------|
</span><span class='line'>|20-1232091|ruan    |bekker     |32     |cape town     |
</span><span class='line'>|20-2531020|stefan  |bester     |32     |kroonstad     |
</span><span class='line'>|20-4835056|michael |le roux    |35     |port elizabeth|
</span><span class='line'>
</span><span class='line'>## Lists
</span><span class='line'>
</span><span class='line'>This is a list:
</span><span class='line'>
</span><span class='line'>* one
</span><span class='line'>* two
</span><span class='line'>* [three](https://example.com)
</span><span class='line'>
</span><span class='line'>This is another list:
</span><span class='line'>
</span><span class='line'>1. one
</span><span class='line'>2. two
</span><span class='line'>3. [three](https://example.com)
</span><span class='line'>
</span><span class='line'>## Images
</span><span class='line'>
</span><span class='line'>This is an embedded photo:
</span><span class='line'>
</span><span class='line'>![](https://images.pexels.com/photos/248797/pexels-photo-248797.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500)</span></code></pre></td></tr></table></div></figure>


<h2>Run the Server</h2>

<p>You can set the flags in your main config as well. Go ahead and run the server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ hugo server \
</span><span class='line'>  --baseURL "http://localhost/" \
</span><span class='line'>  --themesDir=themes --theme=pickles \
</span><span class='line'>  --bind=0.0.0.0 --port=8080 --appendPort=true \
</span><span class='line'>  --buildDrafts --watch --environment production</span></code></pre></td></tr></table></div></figure>


<h2>Screenshots</h2>

<p>When you access your blog on port 8080 you should see your post. Some screenshots below:</p>

<p><img width="1227" alt="image" src="https://user-images.githubusercontent.com/30043398/56570645-9e432100-65bb-11e9-9ea4-dd89be65bed4.png"></p>

<p><img width="1143" alt="image" src="https://user-images.githubusercontent.com/30043398/56570670-aac77980-65bb-11e9-830d-4424e6d92beb.png"></p>

<p><img width="1110" alt="image" src="https://user-images.githubusercontent.com/30043398/56570707-b74bd200-65bb-11e9-8df2-8aa1372e2922.png"></p>

<p><img width="1196" alt="image" src="https://user-images.githubusercontent.com/30043398/56570734-c16dd080-65bb-11e9-92fc-55c7ace373e8.png"></p>

<h2>References:</h2>

<ul>
<li><a href="https://gohugo.io/getting-started/installing/">https://gohugo.io/getting-started/installing/</a></li>
<li><a href="https://gohugo.io/content-management/syntax-highlighting/">https://gohugo.io/content-management/syntax-highlighting/</a></li>
<li><a href="https://willschenk.com/articles/2018/building-a-hugo-site/">https://willschenk.com/articles/2018/building-a-hugo-site/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/18/setup-a-drone-cicd-environment-on-docker-with-letsencrypt/">Setup a Drone CICD Environment on Docker With Letsencrypt</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-18T12:53:49-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>12:53 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/56378979-ed313500-620e-11e9-9ac0-4fcd1df803e8.png" alt="drone-ci" /></p>

<h2>What is Drone?</h2>

<p>Drone is a self-service continuous delivery platform which can be used for CICD pipelines, devopsy stuff which is really awesome.</p>

<p>With Configuration as Code, Pipelines are configured with a simple, easy‑to‑read file that you commit to your git repository such as github, gitlab, gogs, gitea etc.</p>

<p>Each Pipeline step is executed inside an isolated Docker container that is automatically downloaded at runtime, if not found in cache.</p>

<h2>Show me pipelines!</h2>

<p>A pipeline can look as easy as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pipeline</span>
</span><span class='line'><span class="l-Scalar-Plain">steps</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">node</span>
</span><span class='line'>  <span class="l-Scalar-Plain">commands</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">npm install</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">npm test</span>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">database</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3306</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Open for Testing!</h2>

<p>I have enabled public access, so please go ahead and launch your cicd pipelines on my drone setup as I want to test the stability of it:</p>

<p>==> <a href="https://drone.rbkr.xyz/">https://drone.rbkr.xyz/</a></p>

<h2>What are we doing?</h2>

<p>We will deploy a drone server which is responsible for the actual server and 2 drone agents which will receive instructions from the server whenever steps need to be executed. Steps run on agents.</p>

<h2>Deploy the Servers</h2>

<p>I&rsquo;m using VULTR to deploy 3 nodes on coreos, 1 drone server and 2 drone agents as seen below:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56371668-d0403600-61fd-11e9-8396-01c07c136518.png" alt="image" /></p>

<p>Documentation:
<a href="https://docs.drone.io/installation/github/multi-machine/">https://docs.drone.io/installation/github/multi-machine/</a>
<a href="https://github.com/settings/developers">https://github.com/settings/developers</a></p>

<p>We will use Github for version control and to delegate auth, therefore we need to register a new application on Github.</p>

<p>Register New Application on Github at <a href="https://github.com/settings/developer">https://github.com/settings/developer</a> :</p>

<p><img src="https://user-images.githubusercontent.com/567298/56375985-22398980-6207-11e9-911d-9595f8f85db9.png" alt="register-application" /></p>

<p>Get your Drone-Server Host Endpoint, and update the fields:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56374721-287a3680-6204-11e9-837f-a7751651c29a.png" alt="image" /></p>

<p>You will receive a Github Client ID, Secret which we will need later, which will look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">Client ID</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">xx</span>
</span><span class='line'><span class="l-Scalar-Plain">Client Secret</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">yyy</span>
</span></code></pre></td></tr></table></div></figure>


<p>Generate the shared secret which will be used on the server and agent:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ openssl rand -hex 16</span>
</span><span class='line'><span class="l-Scalar-Plain">eb83xxe19a3497f597f53044250df6yy</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the Startup Script for Drone Server, which will just be a docker container running in detached mode. Note that you should use your own domain at <code>SERVER_HOST</code> and if you want to issue an certificate automatically keep <code>DRONE_TLS_AUTOCERT</code> to true.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ cat &gt; start_drone-server.sh &lt;&lt; EOF</span>
</span><span class='line'><span class="l-Scalar-Plain">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">set -ex</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">GITHUB_CLIENT_ID=xx</span>
</span><span class='line'><span class="l-Scalar-Plain">GITHUB_CLIENT_SECRET=yyy</span>
</span><span class='line'><span class="l-Scalar-Plain">SHARED_SECRET=eb83xxe19a3497f597f53044250df6yy</span>
</span><span class='line'><span class="l-Scalar-Plain">SERVER_HOST=drone.yourdomain.com</span>
</span><span class='line'><span class="l-Scalar-Plain">SERVER_PROTOCOL=https</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">docker run \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--volume=/var/run/docker.sock:/var/run/docker.sock \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--volume=/var/lib/drone:/data \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_GITHUB_SERVER=https://github.com \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID} \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET} \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_AGENTS_ENABLED=true \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_RPC_SECRET=${SHARED_SECRET} \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_SERVER_HOST=${SERVER_HOST} \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_SERVER_PROTO=${SERVER_PROTOCOL} \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_TLS_AUTOCERT=true \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_USER_CREATE=username:&lt;your-github-username&gt;,admin:true \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--publish=80:80 \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--publish=443:443 \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--restart=always \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--detach=true \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--name=drone \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">drone/drone:1</span>
</span><span class='line'><span class="l-Scalar-Plain">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the startup script for the drone agent, note that this script needs to be placed on the agent nodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ cat &gt; start_drone-agent.sh &lt;&lt; EOF</span>
</span><span class='line'><span class="l-Scalar-Plain">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">set -ex</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">SHARED_SECRET=eb83xxe19a3497f597f53044250df6yy</span>
</span><span class='line'><span class="l-Scalar-Plain">AGENT_SERVER_HOST=https://drone.yourdomain.com</span>
</span><span class='line'><span class="l-Scalar-Plain">SERVER_PROTOCOL=https</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">docker run \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--volume=/var/run/docker.sock:/var/run/docker.sock \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_RPC_SERVER=${AGENT_SERVER_HOST} \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_RPC_SECRET=${SHARED_SECRET} \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_RUNNER_CAPACITY=2 \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--env=DRONE_RUNNER_NAME=${HOSTNAME} \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--restart=always \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--detach=true \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">--name=drone-agent-02 \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">drone/agent:1</span>
</span><span class='line'><span class="l-Scalar-Plain">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Logon to the server node and start the drone server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ bash start_drone-agent.sh</span>
</span></code></pre></td></tr></table></div></figure>


<p>Login to the agent nodes and start the agents:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ bash start_drone-agent.sh</span>
</span></code></pre></td></tr></table></div></figure>


<p>The server should show that it&rsquo;s listening on port 80 and 443:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker ps</span>
</span><span class='line'><span class="l-Scalar-Plain">CONTAINER ID        IMAGE               COMMAND               CREATED             STATUS              PORTS                                      NAMES</span>
</span><span class='line'><span class="l-Scalar-Plain">8ea70fc7b967        drone/drone:1       &quot;/bin/drone-server&quot;   12 minutes ago      Up 12 minutes       0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp   drone</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Access Drone</h2>

<p>Access your Drone instance on port 80 eg. <a href="http://drone.yourdomain.com">http://drone.yourdomain.com</a> you should be automatically redirected to port 443, which should direct you to a login page, which will look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56375632-5eb8b580-6206-11e9-9ae8-92b2cd29abec.png" alt="drone-authorize" /></p>

<p>Login with your github account and allow drone some time to sync your repositories:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56373131-9e7c9e80-6200-11e9-83ce-e486b399468e.png" alt="image" /></p>

<h2>Add drone config to your repository:</h2>

<p>Clone this repository: <a href="https://github.com/ruanbekker/drone-ci-testing">https://github.com/ruanbekker/drone-ci-testing</a> which will contain the <code>.drone.yml</code> config which drone gets its instructions from.</p>

<p>Select a repository to activate, (drone-ci-testing in this case) head over to settings:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56373298-f1565600-6200-11e9-8262-ac3162fed4f2.png" alt="image" /></p>

<p>Adding secret:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56373209-c5d36b80-6200-11e9-90de-68c131480672.png" alt="image" /></p>

<p>Add more secrets:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56373443-3da19600-6201-11e9-85a9-083bfcbd604a.png" alt="image" /></p>

<p>Your build list should be empty:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56373533-6fb2f800-6201-11e9-8fa0-ab05e546c36e.png" alt="image" /></p>

<h2>Trigger a Build</h2>

<p>Edit any of the files in the clone repository and you should see your build running:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56374465-85c1b800-6203-11e9-8542-acd1d5729447.png" alt="image" /></p>

<p>When your build has completed:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56374511-a25df000-6203-11e9-9eb8-d94a777a8b4a.png" alt="image" /></p>

<p>You can also find out where the step ran:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56374667-084a7780-6204-11e9-9c5b-6672f6882411.png" alt="image" /></p>

<p>Run a couple of tests:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56376356-e3f09a00-6207-11e9-8ca0-16e06e7c0379.png" alt="image" /></p>

<p>Get notified via slack:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56376376-eeab2f00-6207-11e9-9af9-194cb5a3023b.png" alt="image" /></p>

<h2>Debugging</h2>

<p>If your build fails, its most likely that you need the <code>slack_webhook</code> secret. You can remove the slack step which shouldhelp you get going with drone.</p>

<h2>More on Drone</h2>

<p>Have a look at <a href="https://github.com/ruanbekker/drone-ci-testing/blob/master/README.md">this document</a> for more examples or have a look at their <a href="https://docs.drone.io/">documentation</a> as well as their extensive list of <a href="http://plugins.drone.io/">plugins</a> and their <a href="https://docs.drone.io/installation/github/multi-machine/">setup documentation</a> to become familiar with their configuration.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/18/setup-a-slack-webhook-for-sending-messages-from-applications/">Setup a Slack Webhook for Sending Messages From Applications</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-18T06:07:42-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>6:07 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/56354543-55165a00-61d4-11e9-9101-f979dcb4cdb3.png" alt="slack" /></p>

<p>Slack is amazing and I cant live without it.</p>

<p>We can also use custom webhook integrations to allow applications to notify us via slack in response of events.</p>

<h2>What we will be doing</h2>

<p>We will be configuring a custom slack webhook integration and test out the api to show you how easy it is to use it to inform us via slack, whenever something is happening.</p>

<h2>Configuration</h2>

<p>Head over to:
- <a href="https://">https://</a>{your-team}.slack.com/apps/manage/custom-integrations</p>

<p>Select Incoming Webhooks:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56352324-49746480-61cf-11e9-8dd2-e4482fc16f9e.png" alt="" /></p>

<p>Select Add Configuration:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56352369-6ad55080-61cf-11e9-9d98-4193a7aeb321.png" alt="" /></p>

<p>Select the channel it should post to:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56352447-90625a00-61cf-11e9-8f94-098b2c088159.png" alt="" /></p>

<p>Select Add Incoming Webhook Integration.</p>

<p>Save the webhook url that will look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://hooks.slack.com/services/ABCDEFGHI/ZXCVBNMAS/AbCdEfGhJiKlOpRQwErTyUiO</span></code></pre></td></tr></table></div></figure>


<p>You can then further configure the integration.</p>

<h2>Sending Messages</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPOST -d 'payload={"channel": "#system_events", "username": "My-WebhookBot", "text": "This is posted to #general and comes from a bot named &lt;https://alert-system.com/alerts/1234|webhookbot&gt; for details!", "icon_emoji": ":borat:"}' https://hooks.slack.com/services/xx/xx/xx</span></code></pre></td></tr></table></div></figure>


<p>Will result in:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56353019-be946980-61d0-11e9-874c-56074b8d2da7.png" alt="image" /></p>

<p>Message Attachment, Error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPOST -d 'payload={"channel": "#system_events", "username": "My-WebhookBot", "text": "*Incoming Alert!*", "icon_emoji": ":borat:", "attachments":[{"fallback":"New open task [Urgent]: &lt;http://url_to_task|Test out Slack message attachments&gt;","pretext":"New open task [Urgent]: &lt;http://url_to_task|Test out Slack message attachments&gt;","color":"#D00000","fields":[{"title":"Notes","value":"This is much easier than I thought it would be.","short":false}]}]}}' https://hooks.slack.com/services/xx/xx/xx</span></code></pre></td></tr></table></div></figure>


<p>Results in:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56353534-df10f380-61d1-11e9-92f5-f14a75c19049.png" alt="image" /></p>

<p>Message Attachment, OK:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPOST -d 'payload={"channel": "#system_events", "username": "My-WebhookBot", "text": "*Status Update:*", "icon_emoji": ":borat:", "attachments":[{"fallback":"New open task has been closed [OK]: &lt;http://url_to_task|Test out Slack message attachments&gt;","pretext":"Task has been closed [OK]: &lt;http://url_to_task|Test out Slack message attachments&gt;","color":"#28B463","fields":[{"title":"Notes","value":"The error has been resolved and the status is OK","short":false}]}]}}' https://hooks.slack.com/services/xx/xx/xx</span></code></pre></td></tr></table></div></figure>


<p>Results in:</p>

<p><img src="https://user-images.githubusercontent.com/567298/56353591-f819a480-61d1-11e9-8810-3586f56dd0f3.png" alt="image" /></p>

<h2>Join my Slack</h2>

<p>If you want to join my slack workspace, use <a href="https://join.slack.com/t/linux-hackers/shared_invite/enQtNjE0NDMzODI1OTI2LTFhYTRkNTQxYzAyMjQwNTNhMmE5ZmZkYjU2MDg2NGFlOTYyNmM2MjdkMzg1NTMwOTM0MGY1MjVmMTdhYjkxZTk">this invite link</a></p>

<h2>Resources:</h2>

<ul>
<li><a href="https://htmlcolorcodes.com/">https://htmlcolorcodes.com/</a></li>
<li><a href="https://api.slack.com/docs/message-attachments">https://api.slack.com/docs/message-attachments</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/17/mongodb-examples-with-golang/">MongoDB Examples With Golang</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-17T08:51:35-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>8:51 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55478904-236e9200-561d-11e9-9382-f31b25a9ae03.png" alt="" /></p>

<p>While looking into working with mongodb using golang, I found it quite frustrating getting it up and running and decided to make a quick post about it.</p>

<h2>What are we doing?</h2>

<p>Examples using the golang driver for mongodb to connect, read, update and delete documents from mongodb.</p>

<h2>Environment:</h2>

<p>Provision a mongodb server in docker:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker network create container-net
</span><span class='line'>$ docker run -itd --name mongodb --network container-net -p 27017:27017 ruanbekker/mongodb</span></code></pre></td></tr></table></div></figure>


<p>Drop into a golang environment using docker:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run -it golang:alpine sh</span></code></pre></td></tr></table></div></figure>


<p>Get the dependencies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apk add --no-cache git</span></code></pre></td></tr></table></div></figure>


<p>Change to your project path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir $GOPATH/src/myapp
</span><span class='line'>$ cd $GOPATH/src/myapp</span></code></pre></td></tr></table></div></figure>


<p>Download the golang mongodb driver:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go get go.mongodb.org/mongo-driver</span></code></pre></td></tr></table></div></figure>


<h2>Connecting to MongoDB in Golang</h2>

<p>First example will be to connect to your mongodb instance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;context&quot;</span>
</span><span class='line'>    <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>    <span class="s">&quot;log&quot;</span>
</span><span class='line'>    <span class="s">&quot;go.mongodb.org/mongo-driver/mongo&quot;</span>
</span><span class='line'>    <span class="s">&quot;go.mongodb.org/mongo-driver/bson&quot;</span>
</span><span class='line'>    <span class="s">&quot;go.mongodb.org/mongo-driver/mongo/options&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">Name</span> <span class="kt">string</span>
</span><span class='line'>    <span class="nx">Age</span>  <span class="kt">int</span>
</span><span class='line'>    <span class="nx">City</span> <span class="kt">string</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">clientOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Client</span><span class="p">().</span><span class="nx">ApplyURI</span><span class="p">(</span><span class="s">&quot;mongodb://mongodb:27017&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">clientOptions</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Ping</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Connected to MongoDB!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running our app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Connected to MongoDB!
</span></code></pre></td></tr></table></div></figure>


<h2>Writing to MongoDB with Golang</h2>

<p>Let&rsquo;s insert a single document to MongoDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">..</span>
</span><span class='line'>    <span class="nx">collection</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Database</span><span class="p">(</span><span class="s">&quot;mydb&quot;</span><span class="p">).</span><span class="nx">Collection</span><span class="p">(</span><span class="s">&quot;persons&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">ruan</span> <span class="o">:=</span> <span class="nx">Person</span><span class="p">{</span><span class="s">&quot;Ruan&quot;</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="s">&quot;Cape Town&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">insertResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">InsertOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">ruan</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Inserted a Single Document: &quot;</span><span class="p">,</span> <span class="nx">insertResult</span><span class="p">.</span><span class="nx">InsertedID</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running it will produce:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Connected to MongoDB!
</span><span class='line'>Inserted a single document:  ObjectID<span class="o">(</span><span class="s2">&quot;5cb717dcf597b4411252341f&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Writing more than one document:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>func main<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    ..
</span><span class='line'>    collection :<span class="o">=</span> client.Database<span class="o">(</span><span class="s2">&quot;mydb&quot;</span><span class="o">)</span>.Collection<span class="o">(</span><span class="s2">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    ruan :<span class="o">=</span> Person<span class="o">{</span><span class="s2">&quot;Ruan&quot;</span>, 34, <span class="s2">&quot;Cape Town&quot;</span><span class="o">}</span>
</span><span class='line'>    james :<span class="o">=</span> Person<span class="o">{</span><span class="s2">&quot;James&quot;</span>, 32, <span class="s2">&quot;Nairobi&quot;</span><span class="o">}</span>
</span><span class='line'>    frankie :<span class="o">=</span> Person<span class="o">{</span><span class="s2">&quot;Frankie&quot;</span>, 31, <span class="s2">&quot;Nairobi&quot;</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    trainers :<span class="o">=</span> <span class="o">[]</span>interface<span class="o">{}{</span>james, frankie<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    insertManyResult, err :<span class="o">=</span> collection.InsertMany<span class="o">(</span>context.TODO<span class="o">()</span>, trainers<span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span><span class='line'>      log.Fatal<span class="o">(</span>err<span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>    fmt.Println<span class="o">(</span><span class="s2">&quot;Inserted multiple documents: &quot;</span>, insertManyResult.InsertedIDs<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will output in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Inserted Multiple Documents:  <span class="o">[</span>ObjectID<span class="o">(</span><span class="s2">&quot;5cb717dcf597b44112523420&quot;</span><span class="o">)</span> ObjectID<span class="o">(</span><span class="s2">&quot;5cb717dcf597b44112523421&quot;</span><span class="o">)]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Updating Documents in MongoDB using Golang</h2>

<p>Updating Frankie&rsquo;s age:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>func main<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    ..
</span><span class='line'>    filter :<span class="o">=</span> bson.D<span class="o"></span>
</span><span class='line'>    update :<span class="o">=</span> bson.D<span class="o">{</span>
</span><span class='line'>        <span class="o">{</span><span class="s2">&quot;$inc&quot;</span>, bson.D<span class="o">{</span>
</span><span class='line'>            <span class="o">{</span><span class="s2">&quot;age&quot;</span>, 1<span class="o">}</span>,
</span><span class='line'>        <span class="o">}}</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    updateResult, err :<span class="o">=</span> collection.UpdateOne<span class="o">(</span>context.TODO<span class="o">()</span>, filter, update<span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> err !<span class="o">=</span> nil <span class="o">{</span>
</span><span class='line'>      log.Fatal<span class="o">(</span>err<span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>    fmt.Printf<span class="o">(</span><span class="s2">&quot;Matched %v documents and updated %v documents.\n&quot;</span>, updateResult.MatchedCount, updateResult.ModifiedCount<span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running that will update Frankie&rsquo;s age:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Matched <span class="m">1</span> documents and updated <span class="m">1</span> documents.
</span></code></pre></td></tr></table></div></figure>


<h2>Reading Data from MongoDB</h2>

<p>Reading the data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">funct</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">..</span>
</span><span class='line'>    <span class="nx">filter</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p"></span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">result</span> <span class="nx">Trainer</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">FindOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">filter</span><span class="p">).</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Found a single document: %+v\n&quot;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">findOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">Find</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">findOptions</span><span class="p">.</span><span class="nx">SetLimit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Found a single document: <span class="o">{</span>Name:Frankie Age:32 City:Nairobi<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finding multiple documents and returning the cursor</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">..</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">results</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Trainer</span>
</span><span class='line'>  <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">Find</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">,</span> <span class="nx">findOptions</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">Next</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">elem</span> <span class="nx">Trainer</span>
</span><span class='line'>      <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">results</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">cur</span><span class="p">.</span><span class="nx">Close</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">())</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Found multiple documents (array of pointers): %+v\n&quot;</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="err">$</span> <span class="k">go</span> <span class="nx">run</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</span><span class='line'><span class="nx">Found</span> <span class="nx">multiple</span> <span class="nx">documents</span> <span class="p">(</span><span class="nx">array</span> <span class="nx">of</span> <span class="nx">pointers</span><span class="p">):</span> <span class="p">[</span><span class="mh">0xc0001215c0</span> <span class="mh">0xc0001215f0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deleting Data from MongoDB:</h2>

<p>Deleting our data and closing the connection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">(){</span>
</span><span class='line'>    <span class="p">..</span>
</span><span class='line'>    <span class="nx">deleteResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">DeleteMany</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Deleted %v documents in the trainers collection\n&quot;</span><span class="p">,</span> <span class="nx">deleteResult</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Connection to MongoDB closed.&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>go run main.go
</span><span class='line'>Deleted <span class="m">3</span> documents in the trainers collection
</span><span class='line'>Connection to MongoDB closed.
</span></code></pre></td></tr></table></div></figure>


<p>The code for this example can be found at <a href="https://github.com/ruanbekker/code-examples/blob/master/mongodb/golang/examples.go">github.com/ruanbekker/code-examples/mongodb/golang/examples.go</a></p>

<h2>Resources:</h2>

<ul>
<li><a href="https://www.mongodb.com/blog/post/mongodb-go-driver-tutorial">https://www.mongodb.com/blog/post/mongodb-go-driver-tutorial</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/06/sql-inner-joins-examples-with-sqlite/">SQL Inner Joins Examples With SQLite</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-06T15:47:38-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55704774-53cb7d00-59dd-11e9-9f43-65ec3aa857b5.png" alt="sqlite" /></p>

<h2>Overview</h2>

<p>In this tutorial we will get started with sqlite and use inner joins to query data from multiple tables to answer specific use case needs.</p>

<h2>Connecting to your Sqlite Database</h2>

<p>Connecting to your database uses the argument to the target database. You can use additional flags to set the properties that you want to enable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="err">$</span> <span class="n">sqlite3</span> <span class="o">-</span><span class="n">header</span> <span class="o">-</span><span class="k">column</span> <span class="n">mydatabase</span><span class="p">.</span><span class="n">db</span>
</span></code></pre></td></tr></table></div></figure>


<p>or you can specify the additional options to your config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &gt; ~/.sqliterc <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">.mode column</span>
</span><span class='line'><span class="s">.headers on</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then connecting to your database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sqlite3 mydatabase.db
</span><span class='line'>-- Loading resources from /Users/ruan/.sqliterc
</span><span class='line'>SQLite version 3.16.0 2016-11-04 19:09:39
</span><span class='line'>Enter <span class="s2">&quot;.help&quot;</span> <span class="k">for</span> usage hints.
</span><span class='line'>sqlite&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Tables</h2>

<p>Create the <code>users</code> table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">users</span> <span class="p">(</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">id</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">surname</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">city</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">age</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">credit_card_num</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">job_position</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the <code>transactions</code> table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">transactions</span> <span class="p">(</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">credit_card_num</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">transaction_id</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">shop_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">product_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">spent_total</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">purchase_option</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can view the tables using <code>.tables</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="p">.</span><span class="n">tables</span>
</span><span class='line'><span class="n">transactions</span>  <span class="n">users</span>
</span></code></pre></td></tr></table></div></figure>


<p>And view the schema of the tables using <code>.schema &lt;table-name&gt;</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="p">.</span><span class="k">schema</span> <span class="n">users</span>
</span><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="p">(</span>
</span><span class='line'><span class="n">id</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">surname</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">city</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'><span class="n">age</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">credit_card_num</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">job_position</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Write to Sqlite Database</h2>

<p>Now we will populate data to our tables. Insert a record to our users table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">users</span> <span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;ruan&#39;</span><span class="p">,</span> <span class="s1">&#39;bekker&#39;</span><span class="p">,</span> <span class="s1">&#39;cape town&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;2345-8970-6712-4352&#39;</span><span class="p">,</span> <span class="s1">&#39;devops&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Insert a record to our transactions table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">transactions</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;2345-8970-6712-4352&#39;</span><span class="p">,</span> <span class="mi">981623</span><span class="p">,</span> <span class="s1">&#39;spaza01&#39;</span><span class="p">,</span> <span class="s1">&#39;burger&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">.</span><span class="mi">02</span><span class="p">,</span> <span class="s1">&#39;credit_card&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Read from the Sqlite Database</h2>

<p>Read the data from the users table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">users</span><span class="p">;</span>
</span><span class='line'><span class="n">id</span>          <span class="n">name</span>        <span class="n">surname</span>     <span class="n">city</span>        <span class="n">age</span>         <span class="n">credit_card_num</span>      <span class="n">job_position</span>
</span><span class='line'><span class="c1">----------  ----------  ----------  ----------  ----------  -------------------  ------------</span>
</span><span class='line'><span class="mi">1</span>           <span class="n">ruan</span>        <span class="n">bekker</span>      <span class="n">cape</span> <span class="n">town</span>   <span class="mi">31</span>          <span class="mi">2345</span><span class="o">-</span><span class="mi">8970</span><span class="o">-</span><span class="mi">6712</span><span class="o">-</span><span class="mi">4352</span>  <span class="n">devops</span>
</span></code></pre></td></tr></table></div></figure>


<p>Read the data from the transactions table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">transactions</span><span class="p">;</span>
</span><span class='line'><span class="n">credit_card_num</span>      <span class="n">transaction_id</span>  <span class="n">shop_name</span>   <span class="n">product_name</span>  <span class="n">spent_total</span>  <span class="n">purchase_option</span>
</span><span class='line'><span class="c1">-------------------  --------------  ----------  ------------  -----------  ---------------</span>
</span><span class='line'><span class="mi">2345</span><span class="o">-</span><span class="mi">8970</span><span class="o">-</span><span class="mi">6712</span><span class="o">-</span><span class="mi">4352</span>  <span class="mi">981623</span>          <span class="n">spaza01</span>     <span class="n">burger</span>        <span class="mi">101</span><span class="p">.</span><span class="mi">02</span>       <span class="n">credit_card</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Inner Joins with Sqlite</h2>

<p>This is where stuff gets interesting.</p>

<p>Let&rsquo;s say you want to join data from 2 tables, in this example we have a table with our userdata and a table with transaction data.</p>

<p>Say we want to see the user&rsquo;s name, transaction id, the product they purchased and the total amount spent, we will make use of inner joins.</p>

<p>Example looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">transaction_id</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">spent_total</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">from</span> <span class="n">users</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">a</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">transactions</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">credit_card_num</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">where</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="s1">&#39;2345-8970-6712-4352&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">name</span>        <span class="n">transaction_id</span>  <span class="n">product_name</span>  <span class="n">spent_total</span>
</span><span class='line'><span class="c1">----------  --------------  ------------  -----------</span>
</span><span class='line'><span class="n">ruan</span>        <span class="mi">981623</span>          <span class="n">burger</span>         <span class="mi">101</span><span class="p">.</span><span class="mi">02</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say you dont know the credit_card number but you would like to do a lookup the credit card number via the user&rsquo;s id, then pass the value to the where statement:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">transaction_id</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">spent_total</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">from</span> <span class="n">users</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">a</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">transactions</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">credit_card_num</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">where</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="n">credit_card_num</span> <span class="k">from</span> <span class="n">users</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="n">name</span>        <span class="n">transaction_id</span>  <span class="n">product_name</span>  <span class="n">spent_total</span>
</span><span class='line'><span class="c1">----------  --------------  ------------  -----------</span>
</span><span class='line'><span class="n">ruan</span>        <span class="mi">981623</span>          <span class="n">burger</span>         <span class="mi">101</span><span class="p">.</span><span class="mi">02</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s create another table called <code>products</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">products</span> <span class="p">(</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">product_id</span> <span class="nb">INTEGER</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span> <span class="n">product_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="n">product_category</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">product_price</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Write a record with product data to the table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">products</span> <span class="k">values</span><span class="p">(</span><span class="mi">0231</span><span class="p">,</span> <span class="s1">&#39;burger&#39;</span><span class="p">,</span> <span class="s1">&#39;fast foods&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">.</span><span class="mi">02</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, lets say the question will be that we need to display the users name, credit card number, product name as well as the product category and products price, by only giving you the credit card number</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sqlite</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">credit_card_num</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">product_category</span><span class="p">,</span> <span class="k">c</span><span class="p">.</span><span class="n">product_price</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">from</span> <span class="n">users</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">a</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">transactions</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">b</span> <span class="k">on</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="k">inner</span> <span class="k">join</span> <span class="n">products</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">as</span> <span class="k">c</span> <span class="k">on</span> <span class="n">b</span><span class="p">.</span><span class="n">product_name</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">product_name</span>
</span><span class='line'>   <span class="p">...</span><span class="o">&gt;</span> <span class="k">where</span> <span class="n">a</span><span class="p">.</span><span class="n">credit_card_num</span> <span class="o">=</span> <span class="s1">&#39;2345-8970-6712-4352&#39;</span> <span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">product_name</span> <span class="o">=</span> <span class="s1">&#39;burger&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">name</span>        <span class="n">credit_card_num</span>      <span class="n">product_name</span>  <span class="n">product_category</span>   <span class="n">product_price</span>
</span><span class='line'><span class="c1">----------  -------------------  ------------  -----------------  -------------</span>
</span><span class='line'><span class="n">ruan</span>        <span class="mi">2345</span><span class="o">-</span><span class="mi">8970</span><span class="o">-</span><span class="mi">6712</span><span class="o">-</span><span class="mi">4352</span>  <span class="n">burger</span>        <span class="n">fast</span> <span class="n">foods</span>         <span class="mi">101</span><span class="p">.</span><span class="mi">02</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/06/install-elasticsearch-with-ansible-tutorial/">Install Elasticsearch With Ansible Tutorial</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-06T15:45:09-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:45 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55700285-f3cdda00-59ce-11e9-9c00-a05b9d469e23.png" alt="" /></p>

<p>In this tutorial we will install a elasticsearch cluster with ansible (well rather a node)</p>

<p>Our inventory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat inventory.ini
</span><span class='line'>[newes]
</span><span class='line'>esnewnode
</span><span class='line'>
</span><span class='line'>[newes:vars]
</span><span class='line'>ansible_python_interpreter=/usr/bin/python3</span></code></pre></td></tr></table></div></figure>


<p>Our playbook to bootstrap our nodes with Python:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat bootstrap-python.yml
</span><span class='line'>---
</span><span class='line'>- hosts: newes
</span><span class='line'>  gather_facts: False
</span><span class='line'>
</span><span class='line'>  tasks:
</span><span class='line'>  - name: install python
</span><span class='line'>    raw: test -e /usr/bin/python || ( apt update && apt install python -y )</span></code></pre></td></tr></table></div></figure>


<p>Our playbook to provision users:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat provision-users.yml
</span><span class='line'>---
</span><span class='line'># Provisions User on Nodes
</span><span class='line'># Setup Passwordless SSH from Jumpbox
</span><span class='line'># Install Packages using APT
</span><span class='line'>- name: bootstrap python
</span><span class='line'>  hosts: newes
</span><span class='line'>  roles:
</span><span class='line'>    - bootstrap-python
</span><span class='line'>
</span><span class='line'>- name: setup pre-requisites
</span><span class='line'>  hosts: newes
</span><span class='line'>  roles:
</span><span class='line'>    - create-sudo-user
</span><span class='line'>    - install-modules
</span><span class='line'>    - configure-hosts-file
</span><span class='line'>
</span><span class='line'>#- name: setup ruan user on the nodes
</span><span class='line'>#  become: yes
</span><span class='line'>#  become_user: ruan
</span><span class='line'>#  hosts: admin
</span><span class='line'>#  roles:
</span><span class='line'>#    - configure-admin
</span><span class='line'>
</span><span class='line'>- name: copy public key to nodes
</span><span class='line'>  become: yes
</span><span class='line'>  become_user: ruan
</span><span class='line'>  hosts: newes
</span><span class='line'>  roles:
</span><span class='line'>    - copy-keys
</span><span class='line'>
</span><span class='line'>- name: install elasticsearch
</span><span class='line'>  hosts: newes
</span><span class='line'>  roles:
</span><span class='line'>    - elasticsearch</span></code></pre></td></tr></table></div></figure>


<p>Our roles that will be included in our playbooks from above:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/create-sudo-user/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: Create Sudo User
</span><span class='line'>  user: name=ruan
</span><span class='line'>        groups=sudo
</span><span class='line'>        shell=/bin/bash
</span><span class='line'>        generate_ssh_key=no
</span><span class='line'>        state=present
</span><span class='line'>
</span><span class='line'>- name: Set Passwordless SSH Access for ruan user
</span><span class='line'>  copy: src=sudoers
</span><span class='line'>        dest=/etc/sudoers.d
</span><span class='line'>        mode=0440</span></code></pre></td></tr></table></div></figure>


<p>Sudoers file for the create sudo role:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/create-sudo-user/files/sudoers
</span><span class='line'>ruan ALL=(ALL) NOPASSWD:ALL</span></code></pre></td></tr></table></div></figure>


<p>The role to install all the apt packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/install-modules/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: Install Packages
</span><span class='line'>  apt: name= state=latest update_cache=yes
</span><span class='line'>  with_items:
</span><span class='line'>    - apt-transport-https
</span><span class='line'>    - ntp
</span><span class='line'>    - python
</span><span class='line'>    - tcpdump
</span><span class='line'>    - wget
</span><span class='line'>    - openssl
</span><span class='line'>    - curl</span></code></pre></td></tr></table></div></figure>


<p>Role to configure hosts file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/configure-hosts-file/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: Configure Hosts File
</span><span class='line'>  lineinfile: path=/etc/hosts regexp='.*$' line=" " state=present
</span><span class='line'>  when: hostvars[item].ansible_default_ipv4.address is defined
</span><span class='line'>  with_items: ""</span></code></pre></td></tr></table></div></figure>


<p>The role to copy the ssh keys:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/copy-keys/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: Copy Public Key to Other Hosts
</span><span class='line'>  become: true
</span><span class='line'>  become_user: ruan
</span><span class='line'>  copy:
</span><span class='line'>    src: /tmp/id_rsa.pub
</span><span class='line'>    dest: /tmp/id_rsa.pub
</span><span class='line'>    mode: 0644
</span><span class='line'>- name: Append Public key in authorized_keys file
</span><span class='line'>  authorized_key:
</span><span class='line'>    user: ruan
</span><span class='line'>    state: present
</span><span class='line'>    key: ""</span></code></pre></td></tr></table></div></figure>


<p>The role to install elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat roles/elasticsearch/tasks/main.yml
</span><span class='line'>---
</span><span class='line'>- name: get apt repo key
</span><span class='line'>  apt_key:
</span><span class='line'>    url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
</span><span class='line'>    state: present
</span><span class='line'>
</span><span class='line'>- name: install apt repo
</span><span class='line'>  apt_repository:
</span><span class='line'>    repo: deb https://artifacts.elastic.co/packages/6.x/apt stable main
</span><span class='line'>    state: present
</span><span class='line'>    filename: elastic-6.x.list
</span><span class='line'>    update_cache: yes
</span><span class='line'>
</span><span class='line'>- name: install java
</span><span class='line'>  apt:
</span><span class='line'>    name: openjdk-8-jre
</span><span class='line'>    state: present
</span><span class='line'>    update_cache: yes
</span><span class='line'>
</span><span class='line'>- name: install elasticsearch
</span><span class='line'>  apt:
</span><span class='line'>    name: elasticsearch
</span><span class='line'>    state: present
</span><span class='line'>    update_cache: yes
</span><span class='line'>
</span><span class='line'>- name: reload systemd config
</span><span class='line'>  systemd: daemon_reload=yes
</span><span class='line'>
</span><span class='line'>- name: enable service elasticsearch and ensure it is not masked
</span><span class='line'>  systemd:
</span><span class='line'>    name: elasticsearch
</span><span class='line'>    enabled: yes
</span><span class='line'>    masked: no
</span><span class='line'>
</span><span class='line'>- name: ensure elasticsearch is running
</span><span class='line'>  systemd: state=started name=elasticsearch</span></code></pre></td></tr></table></div></figure>


<h2>Deploy Elasticsearch</h2>

<p>Bootstrap python then deploy elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ansible-playbook -i inventory.ini -u root bootstrap-python.yml
</span><span class='line'>$ ansible-playbook -i inventory.ini -u root provision-users.yml</span></code></pre></td></tr></table></div></figure>


<p>Test out elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9200/
</span><span class='line'>{
</span><span class='line'>  "name" : "Z52AEZ7",
</span><span class='line'>  "cluster_name" : "elasticsearch",
</span><span class='line'>  "cluster_uuid" : "fUiYVjsSQpCbo9QKEiuvaA",
</span><span class='line'>  "version" : {
</span><span class='line'>    "number" : "6.3.0",
</span><span class='line'>    "build_flavor" : "default",
</span><span class='line'>    "build_type" : "deb",
</span><span class='line'>    "build_hash" : "424e937",
</span><span class='line'>    "build_date" : "2018-06-11T23:38:03.357887Z",
</span><span class='line'>    "build_snapshot" : false,
</span><span class='line'>    "lucene_version" : "7.3.1",
</span><span class='line'>    "minimum_wire_compatibility_version" : "5.6.0",
</span><span class='line'>    "minimum_index_compatibility_version" : "5.0.0"
</span><span class='line'>  },
</span><span class='line'>  "tagline" : "You Know, for Search"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/06/elasticsearch-templates-tutorial/">Elasticsearch Templates Tutorial</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-06T15:41:53-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:41 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53352581-b3892f80-392b-11e9-9532-5db5cbfc8f1c.jpg" alt="elasticsearch" /></p>

<p>Elasticsearch Index templates allow you to define templates that will automatically be applied on index creation time. The templates can include both settings and mappings..</p>

<h2>What are we doing?</h2>

<p>We want to create a template on how we would a target index to look like. It should consist of 1 primary shard and 2 replica shards and we want to update the mapping that we can make use of text and keyword string fields.</p>

<p>So then whenever we create an index which matches our template, the template will be applied on index creation.</p>

<h2>String Fields</h2>

<p>We will make use of the following string fields in our mappings which will be included in our templates:</p>

<p><strong>Text</strong>:</p>

<p>A field to index full-text values, such as the body of an email or the description of a product. These fields are analyzed, that is they are passed through an analyzer to convert the string into a list of individual terms before being indexed. The analysis process allows Elasticsearch to search for individual words within each full text field</p>

<p><strong>Keyword"</strong>:</p>

<p>A field to index structured content such as email addresses, hostnames, status codes, zip codes or tags.</p>

<p>They are typically used for filtering (Find me all blog posts where status is published), for sorting, and for aggregations. Keyword fields are only searchable by their exact value</p>

<h2>Note about templates:</h2>

<p>Couple of things to keep in mind:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1. Templates gets referenced on index creation and does not affect existing indexes
</span><span class='line'>2. When you update a template, you need to specify the exact template, the payload overwrites the whole template</span></code></pre></td></tr></table></div></figure>


<p>View your current templates in your cluster:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/templates?v
</span><span class='line'>name                          index_patterns             order      version
</span><span class='line'>.monitoring-kibana            [.monitoring-kibana-6-*]   0          6020099
</span><span class='line'>filebeat-6.3.1                [filebeat-6.3.1-*]         1</span></code></pre></td></tr></table></div></figure>


<p>Create the template <code>foobar_docs</code> which will match any indexes matching <code>foo-*</code> and <code>bar-*</code> which will inherit index settings of 1 primary shards and 2 replica shards and also apply a mapping template shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPUT http://localhost:9200/_template/foobar_docs -d '
</span><span class='line'>{
</span><span class='line'>  "index_patterns": [
</span><span class='line'>    "foo-*", "bar-*"
</span><span class='line'>  ], 
</span><span class='line'>  "settings": {
</span><span class='line'>    "number_of_shards": 1, 
</span><span class='line'>    "number_of_replicas": 2
</span><span class='line'>  }, 
</span><span class='line'>  "mappings": {
</span><span class='line'>    "type1": {
</span><span class='line'>      "_source": {"enabled": true}, 
</span><span class='line'>      "properties": {"created_at": {"type": "date"}, 
</span><span class='line'>      "title": {"type": "text"}, 
</span><span class='line'>      "status": {"type": "keyword"}, 
</span><span class='line'>      "content": {"type":"text"}, 
</span><span class='line'>      "first_name": {"type": "keyword"}, 
</span><span class='line'>      "last_name": {"type": "keyword"}, 
</span><span class='line'>      "age": {"type":"integer"}, 
</span><span class='line'>      "registered": {"type": "boolean"}
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}'
</span><span class='line'>{"acknowledged":true}</span></code></pre></td></tr></table></div></figure>


<p>View the template from the api:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/templates/foobar_docs?v
</span><span class='line'>name        index_patterns order version
</span><span class='line'>foobar_docs [foo-*, bar-*] 0</span></code></pre></td></tr></table></div></figure>


<p>Create a index that will match the templates definition:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPUT http://localhost:9200/test-2018.07.20
</span><span class='line'>{"acknowledged":true,"shards_acknowledged":true,"index":"test-2018.07.20"}</span></code></pre></td></tr></table></div></figure>


<p>Verify that the index has been created:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/indices/test-2018.07.20?v
</span><span class='line'>health status index           uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   test-2018.07.20 -5XOfl0GTEGeHycTwL51vQ   5   1          0            0        2kb          1.1kb</span></code></pre></td></tr></table></div></figure>


<p>We can also inspect the template like shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_template/foobar_docs?pretty
</span><span class='line'>{
</span><span class='line'>  "foobar_docs" : {
</span><span class='line'>    "order" : 0,
</span><span class='line'>    "index_patterns" : [
</span><span class='line'>      "foo-*",
</span><span class='line'>      "bar-*"
</span><span class='line'>    ],
</span><span class='line'>    "settings" : {
</span><span class='line'>      "index" : {
</span><span class='line'>        "number_of_shards" : "1",
</span><span class='line'>        "number_of_replicas" : "2"
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    "mappings" : {
</span><span class='line'>      "type1" : {
</span><span class='line'>        "_source" : {
</span><span class='line'>          "enabled" : true
</span><span class='line'>        },
</span><span class='line'>        "properties" : {
</span><span class='line'>          "created_at" : {
</span><span class='line'>            "type" : "date"
</span><span class='line'>          },
</span><span class='line'>          "title" : {
</span><span class='line'>            "type" : "text"
</span><span class='line'>          },
</span><span class='line'>          "status" : {
</span><span class='line'>            "type" : "keyword"
</span><span class='line'>          },
</span><span class='line'>          "content" : {
</span><span class='line'>            "type" : "text"
</span><span class='line'>          },
</span><span class='line'>          "first_name" : {
</span><span class='line'>            "type" : "keyword"
</span><span class='line'>          },
</span><span class='line'>          "last_name" : {
</span><span class='line'>            "type" : "keyword"
</span><span class='line'>          },
</span><span class='line'>          "age" : {
</span><span class='line'>            "type" : "integer"
</span><span class='line'>          },
</span><span class='line'>          "registered" : {
</span><span class='line'>            "type" : "boolean"
</span><span class='line'>          }
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    "aliases" : { }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Ingest a document to your index:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://localhost:9200/foo-2018.07.20/type1/ -d '
</span><span class='line'>{
</span><span class='line'>  "title": "this is a post", 
</span><span class='line'>  "status": "active", 
</span><span class='line'>  "content": "introduction post", 
</span><span class='line'>  "first_name": "ruan", 
</span><span class='line'>  "last_name": "bekker", 
</span><span class='line'>  "age": "31", 
</span><span class='line'>  "registered": "true"
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<p>Run a search against your elasticsearch index to view the data:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/foo-2018.07.20/_search?pretty
</span><span class='line'>{
</span><span class='line'>  "took" : 1,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "successful" : 1,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "ZYfotmQB9mQGWzJT7W2y",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "title" : "this is a post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "ruan",
</span><span class='line'>          "last_name" : "bekker",
</span><span class='line'>          "age" : "31",
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Create another document:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPOST http://localhost:9200/foo-2018.07.20/type1/ -d '
</span><span class='line'>{
</span><span class='line'>  "created_at": 1532077144, 
</span><span class='line'>  "title": "this is a another post", 
</span><span class='line'>  "status": "ae", 
</span><span class='line'>  "content": "introduction post", 
</span><span class='line'>  "first_name": "stefan", 
</span><span class='line'>  "last_name": "bester", 
</span><span class='line'>  "age": 34, 
</span><span class='line'>  "registered": "true"
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<p>As you guessed, executing another search against elasticsearch shows us both documents:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/foo-2018.07.20/_search?pretty
</span><span class='line'>{
</span><span class='line'>  "took" : 0,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "successful" : 1,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 2,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "ZYfotmQB9mQGWzJT7W2y",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "title" : "this is a post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "ruan",
</span><span class='line'>          "last_name" : "bekker",
</span><span class='line'>          "age" : "31",
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "rofrtmQB9mQGWzJTxnvp",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "created_at" : 1532077144,
</span><span class='line'>          "title" : "this is a another post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "stefan",
</span><span class='line'>          "last_name" : "bester",
</span><span class='line'>          "age" : 34,
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s run a search query for any documents matching people with the age between <strong>30</strong> and <strong>40</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XGET http://localhost:9200/foo-2018.07.20/_search?pretty -d '{"query": {"range": {"age": {"gte": 30, "lte": 40}}}}'
</span><span class='line'>{
</span><span class='line'>  "took" : 2,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "successful" : 1,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 2,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "ZYfotmQB9mQGWzJT7W2y",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "title" : "this is a post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "ruan",
</span><span class='line'>          "last_name" : "bekker",
</span><span class='line'>          "age" : "31",
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "rofrtmQB9mQGWzJTxnvp",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "created_at" : 1532077144,
</span><span class='line'>          "title" : "this is a another post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "stefan",
</span><span class='line'>          "last_name" : "bester",
</span><span class='line'>          "age" : 34,
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Search for people with the age between <strong>32</strong> and <strong>40</strong>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XGET http://localhost:9200/foo-2018.07.20/_search?pretty -d '{"query": {"range": {"age": {"gte": 32, "lte": 40}}}}'
</span><span class='line'>{
</span><span class='line'>  "took" : 1,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "successful" : 1,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 1,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "foo-2018.07.20",
</span><span class='line'>        "_type" : "type1",
</span><span class='line'>        "_id" : "rofrtmQB9mQGWzJTxnvp",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "created_at" : 1532077144,
</span><span class='line'>          "title" : "this is a another post",
</span><span class='line'>          "status" : "active",
</span><span class='line'>          "content" : "introduction post",
</span><span class='line'>          "first_name" : "stefan",
</span><span class='line'>          "last_name" : "bester",
</span><span class='line'>          "age" : 34,
</span><span class='line'>          "registered" : "true"
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say we want to update our template with <code>refresh_interval</code>, primary shards of 2 and replicas of 1 settings:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPUT http://localhost:9200/_template/foobar_docs -d '
</span><span class='line'>{
</span><span class='line'>  "index_patterns": ["foo-*", "bar-*"], 
</span><span class='line'>  "settings": {"number_of_shards": 2, "number_of_replicas": 1, "refresh_interval": "15s"}
</span><span class='line'>}'</span></code></pre></td></tr></table></div></figure>


<p>View the template, as you can see the target template will look exactly like the data body that we are posting to the template api:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_template/foobar_docs?pretty
</span><span class='line'>{
</span><span class='line'>  "foobar_docs" : {
</span><span class='line'>    "order" : 0,
</span><span class='line'>    "index_patterns" : [
</span><span class='line'>      "foo-*",
</span><span class='line'>      "bar-*"
</span><span class='line'>    ],
</span><span class='line'>    "settings" : {
</span><span class='line'>      "index" : {
</span><span class='line'>        "number_of_shards" : "2",
</span><span class='line'>        "number_of_replicas" : "1",
</span><span class='line'>        "refresh_interval" : "15s"
</span><span class='line'>      }
</span><span class='line'>    },
</span><span class='line'>    "mappings" : { },
</span><span class='line'>    "aliases" : { }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>View our current index, as you can see the index is unaffected of the template change as only new indexes will retrieve the update of the template:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/indices/foo-2018.07.20?v
</span><span class='line'>health status index          uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>yellow open   foo-2018.07.20 ol1pGugrQCKd0xES4R6oFg   1   2          2            0     20.4kb         10.2kb</span></code></pre></td></tr></table></div></figure>


<p>Create a new index to verify that the template&rsquo;s config is pulled into the new index:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H 'Content-Type: application/json' -XPUT http://localhost:9200/foo-2018.07.20-new</span></code></pre></td></tr></table></div></figure>


<p>View the elasticsearch indexes to verify the behavior:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/indices/foo-2018.07.*?v
</span><span class='line'>health status index              uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>yellow open   foo-2018.07.20     ol1pGugrQCKd0xES4R6oFg   1   2          2            0     20.4kb         10.2kb
</span><span class='line'>green  open   foo-2018.07.20-new g6Ii8jtKRFa1zDVB2IsDBQ   2   1          0            0       920b           460b</span></code></pre></td></tr></table></div></figure>


<p>Delete the indexes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XDELETE http://localhost:9200/foo-*
</span><span class='line'>{"acknowledged":true}</span></code></pre></td></tr></table></div></figure>


<p>Delete the templates:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XDELETE 'http://localhost:9200/_template/foobar_docs'
</span><span class='line'>{"acknowledged":true}</span></code></pre></td></tr></table></div></figure>


<p>Verify that the templates are gone:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XGET http://localhost:9200/_cat/templates/foobar_docs?v
</span><span class='line'>name index_patterns order version</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-templates.html</a>
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.3/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/6.3/mapping-types.html</a>
<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/04/06/reindex-your-elasticsearch-indexes-tutorial/">Reindex Your Elasticsearch Indexes Tutorial</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-04-06T15:37:18-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53352581-b3892f80-392b-11e9-9532-5db5cbfc8f1c.jpg" alt="" /></p>

<p>At times you may find that the indexes in your cluster are not queried that often but you still want them around. But you also want to reduce the resource footprint by reducing the number of shards, and perhaps increase the refresh interval.</p>

<p>For refresh interval, if new data comes in and we dont care to have it available near real time, we can set the refresh interval for example to 60 seconds, so the index will only have the data available every 60 seconds. (default: 1s)</p>

<h2>Reindexing Elasticsearch Indexes</h2>

<p>In this example we will use the scenario where we have daily indexes with 5 primary shards and 1 set of replicas and we would like to create a weekly index with 1 primary shard, 1 replica and the refresh interval of 60 seconds, and reindex the previous weeks data into our weekly index.</p>

<p>Create the target weekly index with the mentioned configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H "Content-Type: application/json" -XPUT 'http://127.0.0.1:9200/my-index-2019.01.01-07' -d '
</span><span class='line'>{
</span><span class='line'>  "settings": {
</span><span class='line'>      "number_of_shards": "1",
</span><span class='line'>      "number_of_replicas": "1",
</span><span class='line'>      "refresh_interval" : "60s"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>'</span></code></pre></td></tr></table></div></figure>


<p>Ensure the index exist:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/indices/my-index-2019.01.01*?v'
</span><span class='line'>health status index                    uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   my-index-2019.01.01      wbFEJCApSpSlbOXzb1Tjxw   5   1      22007            0      6.6mb          3.2mb
</span><span class='line'>green  open   my-index-2019.01.02      cbDmJR7pbpRT3O2x46fj20   5   1      28031            0      7.2mb          3.4mb
</span><span class='line'>..
</span><span class='line'>green  open   my-index-2019.01.01-07   mJR7pJ9O4T3O9jzyI943ca   1   1          0            0       466b           233b</span></code></pre></td></tr></table></div></figure>


<p>Create the reindex job, specify the source indexes and the destination index where the data must be reindexed to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -H 'Content-Type: application/json' -XPOST 'http://127.0.0.1:9200/_reindex' -d '
</span><span class='line'>{
</span><span class='line'>  "source": {
</span><span class='line'>      "index": [
</span><span class='line'>          "my-index-2019.01.01",
</span><span class='line'>          "my-index-2019.01.02",
</span><span class='line'>          "my-index-2019.01.03",
</span><span class='line'>          "my-index-2019.01.04",
</span><span class='line'>          "my-index-2019.01.05",
</span><span class='line'>          "my-index-2019.01.06",
</span><span class='line'>          "my-index-2019.01.07"
</span><span class='line'>      ]
</span><span class='line'>  },
</span><span class='line'>  "dest": {
</span><span class='line'>      "index": "my-index-2019.01.01-07"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>'</span></code></pre></td></tr></table></div></figure>


<p>You can use the tasks api to monitor the progress:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/tasks?'
</span><span class='line'>indices:data/write/bulk        -3MIFskURPKxd1tg8P2j0w:912621270 -                                transport 1538459598188 22:53:18 3.1ms       x.x.x.x -3MIFsk
</span><span class='line'>indices:data/write/bulk[s]     -3MIFskURPKxd1tg8P2j0w:912621271 -3MIFskURPKxd1tg8P2j0w:816648230 transport 1538459598188 22:53:18 3.1ms       x.x.x.x -3MIFsk</span></code></pre></td></tr></table></div></figure>


<p>You manipulate the output of the tasks api by either fetching specific actions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_tasks?actions=*data/write/reindex&detailed&pretty'</span></code></pre></td></tr></table></div></figure>


<p>Or viewing detailed output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/tasks?detailed' | grep 'indices:data/write/reindex'
</span><span class='line'>indices:data/write/reindex     IvoqWoUqSgGCQ0ELG21nhg:740560815 -                                transport 1538462294714 23:38:14 1.7m        x.x.x.x IvoqWoU reindex from [my-index-2019.01.01] to [my-index-2019.01.01-07]</span></code></pre></td></tr></table></div></figure>


<p>Or you could get the json response:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_tasks?actions=*data/write/reindex&detailed&pretty'
</span><span class='line'>{
</span><span class='line'>  "nodes" : {
</span><span class='line'>    "xx" : {
</span><span class='line'>      "name" : "xx",
</span><span class='line'>      "roles" : [ "data", "ingest" ],
</span><span class='line'>      "tasks" : {
</span><span class='line'>        "xx:876452606" : {
</span><span class='line'>          "node" : "xx",
</span><span class='line'>          "id" : 776452606,
</span><span class='line'>          "type" : "transport",
</span><span class='line'>          "action" : "indices:data/write/reindex",
</span><span class='line'>          "status" : {
</span><span class='line'>            "total" : 4785475,
</span><span class='line'>            "updated" : 0,
</span><span class='line'>            "created" : 234000,
</span><span class='line'>            "deleted" : 0,
</span><span class='line'>            "batches" : 235,
</span><span class='line'>            "version_conflicts" : 0,
</span><span class='line'>            "noops" : 0,
</span><span class='line'>            "retries" : {
</span><span class='line'>              "bulk" : 0,
</span><span class='line'>              "search" : 0
</span><span class='line'>            },
</span><span class='line'>            "throttled_millis" : 0,
</span><span class='line'>            "requests_per_second" : -1.0,
</span><span class='line'>            "throttled_until_millis" : 0
</span><span class='line'>          },
</span><span class='line'>          "description" : "reindex from [my-index-2019.01.07] to [my-index-2019.01.01-07]",
</span><span class='line'>          "start_time_in_millis" : 1538462901120,
</span><span class='line'>          "running_time_in_nanos" : 64654161339,
</span><span class='line'>          "cancellable" : true
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Anyways, moving along. Reindex jobs will always be listed as a <code>data/write/reindex</code> action, so we can count the output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/tasks?'  | grep 'data/write/reindex' | wc -l</span></code></pre></td></tr></table></div></figure>


<p>If the response is 0 then all the tasks completed and we can have a look at our index again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET 'http://127.0.0.1:9200/_cat/indices/my-index-2019.01.0*?v'
</span><span class='line'>health status index                    uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   my-index-2019.01.01      wbFEJCApSpSlbOXzb1Tjxw   5   1      22007            0      6.6mb          3.2mb
</span><span class='line'>green  open   my-index-2019.01.02      cbDmJR7pbpRT3O2x46fj20   5   1      28031            0      7.2mb          3.4mb
</span><span class='line'>..
</span><span class='line'>green  open   my-index-2019.01.01-07   mJR7pJ9O4T3O9jzyI943ca   1   1     322007            0     45.9mb         22.9mb</span></code></pre></td></tr></table></div></figure>


<p>Now that we can verify that the reindex tasks finished and we can see the aggregated result in our target index, we can delete our source indexes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XDELETE 'http://127.0.0.1:9200/my-index-2019.01.01,my-index-2019.01.02,my-index-2019.01.03,my-index-2019.01.04,my-index-2019.01.05,my-index-2019.01.06,my-index-2019.01.07'</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/07/06/using-openfaas-with-amazon-dynamodb/">Using OpenFaas With Amazon DynamoDB</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/22/play-with-kinesis-data-streams-for-free/">Play With Kinesis Data Streams for Free</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/10/setup-traefik-as-an-ingress-controller-on-kubernetes/">Setup Traefik as an Ingress Controller on Kubernetes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/10/testing-out-scaleways-kapsule-their-kubernetes-as-a-service-offering/">Testing Out Scaleways Kapsule Their Kubernetes as a Service Offering</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/04/setup-a-logstash-server-for-amazon-elasticsearch-service-and-auth-with-iam/">Setup a Logstash Server for Amazon Elasticsearch Service and Auth With IAM</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>

</body>
</html>
