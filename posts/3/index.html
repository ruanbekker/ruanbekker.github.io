
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In this tutorial we will generate Loki Log links from selected dropdown template variables in a Grafana Dashboard. Context To give more context, we &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/posts/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
<script>
(function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
})(document, window, '//fh-blog-ruanbekker-com.home.ruan.dev/tracker.js', 'fathom');
fathom('set', 'siteId', 'MWBHH');
fathom('trackPageview');
</script>
<!-- / Fathom -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/generate-grafana-loki-log-links-from-metric-label-values/">Generate Grafana Loki Log Links From Metric Label Values</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:34:04-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:34 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will generate Loki Log links from selected dropdown template variables in a Grafana Dashboard.</p>

<h2>Context</h2>

<p>To give more context, we have a Grafana Dashboard with all our services, and when you select that service you see all the metrics of that service, now if you want to see the logs of that service, the selected label values will be parsed to a log link which you can click and it will take you to the Loki Explorer and parse the label values to the log link, so your logql will already be generated for you.</p>

<p>In order to achieve this, our metrics and logs need to share the same labels and label values (environment, container_name) etc.</p>

<h2>Dashboard Variables</h2>

<p>First we have our environment variable:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668240-a6862300-7b79-11eb-85ce-d381edfbe78e.png" alt="image" /></p>

<p>And here we have our service variable:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668438-dc2b0c00-7b79-11eb-9b17-629e9b1716a9.png" alt="image" /></p>

<p>Then for our container_name we have:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668632-05e43300-7b7a-11eb-97a0-8ff81f0c929c.png" alt="image" /></p>

<p>Notice the <code>/^(.*?)-[0-9]/</code> thats just to strip the end, if we remove it it will be:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668778-27451f00-7b7a-11eb-976f-a7d0b473cd1b.png" alt="image" /></p>

<h2>Grafana Dashboard</h2>

<p>Now when we select the environment, service, we get presented with a Loki LogURL:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668970-552a6380-7b7a-11eb-8c72-b284cf0f5eec.png" alt="image" /></p>

<p>If we look at our dashboard links, under the dashboard settings:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109669065-6b382400-7b7a-11eb-8a29-34b492fef327.png" alt="image" /></p>

<p>The Logs Uri is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://grafana.mydomain.com/explore?orgId=1&left=%5B%22now-1h%22,%22now%22,%22Loki%22,%7B%22expr%22:%22%7Bcontainer_name%3D~%5C%22.*$container_name.*%5C%22%7D%22%7D,%7B%22mode%22:%22Logs%22%7D,%7B%22ui%22:%5Btrue,true,true,%22none%22%5D%7D%5D</span></code></pre></td></tr></table></div></figure>


<p>Now when we select our label values from the dropdown for our service and we follow the link we will get:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109669297-a33f6700-7b7a-11eb-8205-f021467af751.png" alt="image" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/visualize-weather-data-with-grafana-and-the-dht22-sensor/">Visualize Weather Data With Grafana and the DHT22 Sensor</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:06:31-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:06 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial, we will connect the <a href="https://learn.adafruit.com/dht">DHT22</a> sensor to the Raspberry Pi Zero via the GPIO pins to measure temperature and humidity and visualize it with Grafana.</p>

<p><em>Note</em>: This post was originally posted on my <a href="https://blog.pistack.co.za/monitor-temperature-with-the-dht22-sensor-on-the-raspberry-pi/">RaspberryPi Blog</a></p>

<p>Then we will write a Python exporter for prometheus to expose our metrics so that we can visualize it in Grafana.</p>

<h2>The Endgoal</h2>

<p><img src="https://user-images.githubusercontent.com/30043398/104296987-fd9d3f00-54ca-11eb-8623-f3fd4a63e3cc.png" alt="image" /></p>

<h2>The Hardware</h2>

<p>This is how the sensor looks like (I got it from <a href="https://www.communica.co.za/products/bmt-temp-humd-snsr-dht22-on-pcb">Communica</a>)</p>

<p><img src="https://user-images.githubusercontent.com/567298/103872941-ba605c00-50d7-11eb-9f60-531995a185e6.png" alt="image" /></p>

<h2>Connecting the Sensor</h2>

<p>You can use the following graphic to connect your sensor to your raspberry pi:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103873892-27c0bc80-50d9-11eb-9c41-3f3b2ff5aee2.png" alt="image" /></p>

<h2>Installing Software</h2>

<p>To install the required software, we will be using pip:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip3 install Adafruit_DHT --user</span></code></pre></td></tr></table></div></figure>


<p>Once we installed the software we can configure it</p>

<h2>Interact with the Sensor</h2>

<p>Enter your python interpreter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python3
</span><span class='line'>&gt;&gt;&gt;</span></code></pre></td></tr></table></div></figure>


<p>Then import the library, and get the current temperature and humidity:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; import Adafruit_DHT as dht
</span><span class='line'>&gt;&gt;&gt; humidity, temperature = dht.read_retry(dht.DHT22, 4)
</span><span class='line'>&gt;&gt;&gt; humidity = format(humidity, ".2f") + "%"
</span><span class='line'>&gt;&gt;&gt; humidity
</span><span class='line'>'47.20%'
</span><span class='line'>&gt;&gt;&gt; temperature = format(temperature, ".2f") + "C"
</span><span class='line'>&gt;&gt;&gt; temperature
</span><span class='line'>'29.10C'</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s create a python script for it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat temps.py
</span><span class='line'>#!/usr/bin/env python3
</span><span class='line'>
</span><span class='line'>import Adafruit_DHT as dht_sensor
</span><span class='line'>import time
</span><span class='line'>
</span><span class='line'>def get_temperature_readings():
</span><span class='line'>    humidity, temperature = dht_sensor.read_retry(dht_sensor.DHT22, 4)
</span><span class='line'>    humidity = format(humidity, ".2f") + "%"
</span><span class='line'>    temperature = format(temperature, ".2f") + "C"
</span><span class='line'>    return {"temperature": temperature, "humidity": humidity}
</span><span class='line'>
</span><span class='line'>while True:
</span><span class='line'>    print(get_temperature_readings())
</span><span class='line'>    time.sleep(30)</span></code></pre></td></tr></table></div></figure>


<p>And run it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python3 temps.py
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.40%'}
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.30%'}
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.70%'}
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.40%'}
</span><span class='line'>{'temperature': '28.00C', 'humidity': '47.60%'}</span></code></pre></td></tr></table></div></figure>


<h2>Visualize with Grafana</h2>

<p>Let&rsquo;s visualize our data with Grafana. For this, we need to write an exporter so that Prometheus can scrape the data.</p>

<p>Let&rsquo;s create a python flask application with the prometheus client library for python to expose the metrics to prometheus with a <code>/metrics</code> endpoint.</p>

<p>Note: I have used <a href="https://openweathermap.org/api">OpenWeatherMap</a>&rsquo;s API to get the outside temperature for my location.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat flask_temps.py
</span><span class='line'>#!/usr/bin/env python3
</span><span class='line'>
</span><span class='line'>import Adafruit_DHT as dht_sensor
</span><span class='line'>import time
</span><span class='line'>from flask import Flask, Response
</span><span class='line'>from prometheus_client import Counter, Gauge, start_http_server, generate_latest
</span><span class='line'>import requests
</span><span class='line'>
</span><span class='line'>params = {"lat": "-xx.xxxxx", "lon": "xx.xxxx", "units": "metric", "appid": "your-api-key"}
</span><span class='line'>baseurl = "https://api.openweathermap.org/data/2.5/weather"
</span><span class='line'>content_type = str('text/plain; version=0.0.4; charset=utf-8')
</span><span class='line'>
</span><span class='line'>def get_temperature_readings():
</span><span class='line'>    humidity, temperature = dht_sensor.read_retry(dht_sensor.DHT22, 4)
</span><span class='line'>    humidity = format(humidity, ".2f")
</span><span class='line'>    temperature = format(temperature, ".2f")
</span><span class='line'>    outside_temp = get_outside_weather()
</span><span class='line'>    if all(v is not None for v in [humidity, temperature, outside_temp]):
</span><span class='line'>        response = {"temperature": temperature, "humidity": humidity, "outside_temp": outside_temp}
</span><span class='line'>        return response
</span><span class='line'>    else:
</span><span class='line'>        time.sleep(0.2)
</span><span class='line'>        humidity, temperature = dht_sensor.read_retry(dht_sensor.DHT22, 4)
</span><span class='line'>        humidity = format(humidity, ".2f")
</span><span class='line'>        temperature = format(temperature, ".2f")
</span><span class='line'>        outside_temp = get_outside_weather()
</span><span class='line'>        response = {"temperature": temperature, "humidity": humidity, "outside_temp": outside_temp}
</span><span class='line'>        return response
</span><span class='line'>
</span><span class='line'>def get_outside_weather():
</span><span class='line'>    response = requests.get(baseurl, params=params)
</span><span class='line'>    temp = response.json()['main']['temp']
</span><span class='line'>    return temp
</span><span class='line'>
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>
</span><span class='line'>current_humidity = Gauge(
</span><span class='line'>        'current_humidity',
</span><span class='line'>        'the current humidity percentage, this is a gauge as the value can increase or decrease',
</span><span class='line'>        ['room']
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>current_temperature = Gauge(
</span><span class='line'>        'current_temperature',
</span><span class='line'>        'the current temperature in celsius, this is a gauge as the value can increase or decrease',
</span><span class='line'>        ['room']
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>current_temperature_outside = Gauge(
</span><span class='line'>        'current_temperature_outside',
</span><span class='line'>        'the current outside temperature in celsius, this is a gauge as the value can increase or decrease',
</span><span class='line'>        ['location']
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>@app.route('/metrics')
</span><span class='line'>def metrics():
</span><span class='line'>    metrics = get_temperature_readings()
</span><span class='line'>    current_humidity.labels('study').set(metrics['humidity'])
</span><span class='line'>    current_temperature.labels('study').set(metrics['temperature'])
</span><span class='line'>    current_temperature_outside.labels('za_ct').set(metrics['outside_temp'])
</span><span class='line'>    return Response(generate_latest(), mimetype=content_type)
</span><span class='line'>
</span><span class='line'>if __name__ == '__main__':
</span><span class='line'>    app.run(host='0.0.0.0', port=5000)</span></code></pre></td></tr></table></div></figure>


<p>Then install the flask and prometheus_client package:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python3 -m pip install flask prometheus_client --user</span></code></pre></td></tr></table></div></figure>


<p>When you run the program, you should be able to retrieve metrics from the exporter by making a request on port 5000 on the <code>/metrics</code> request path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://localhost:5000/metrics
</span><span class='line'># HELP python_gc_objects_collected_total Objects collected during gc
</span><span class='line'># TYPE python_gc_objects_collected_total counter
</span><span class='line'>python_gc_objects_collected_total{generation="0"} 646.0
</span><span class='line'>python_gc_objects_collected_total{generation="1"} 129.0
</span><span class='line'>python_gc_objects_collected_total{generation="2"} 0.0
</span><span class='line'># HELP python_gc_objects_uncollectable_total Uncollectable object found during GC
</span><span class='line'># TYPE python_gc_objects_uncollectable_total counter
</span><span class='line'>python_gc_objects_uncollectable_total{generation="0"} 0.0
</span><span class='line'>python_gc_objects_uncollectable_total{generation="1"} 0.0
</span><span class='line'>python_gc_objects_uncollectable_total{generation="2"} 0.0
</span><span class='line'># HELP python_gc_collections_total Number of times this generation was collected
</span><span class='line'># TYPE python_gc_collections_total counter
</span><span class='line'>python_gc_collections_total{generation="0"} 104.0
</span><span class='line'>python_gc_collections_total{generation="1"} 9.0
</span><span class='line'>python_gc_collections_total{generation="2"} 0.0
</span><span class='line'># HELP python_info Python platform information
</span><span class='line'># TYPE python_info gauge
</span><span class='line'>python_info{implementation="CPython",major="3",minor="7",patchlevel="3",version="3.7.3"} 1.0
</span><span class='line'># HELP process_virtual_memory_bytes Virtual memory size in bytes.
</span><span class='line'># TYPE process_virtual_memory_bytes gauge
</span><span class='line'>process_virtual_memory_bytes 4.4761088e+07
</span><span class='line'># HELP process_resident_memory_bytes Resident memory size in bytes.
</span><span class='line'># TYPE process_resident_memory_bytes gauge
</span><span class='line'>process_resident_memory_bytes 2.7267072e+07
</span><span class='line'># HELP process_start_time_seconds Start time of the process since unix epoch in seconds.
</span><span class='line'># TYPE process_start_time_seconds gauge
</span><span class='line'>process_start_time_seconds 1.61044381853e+09
</span><span class='line'># HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.
</span><span class='line'># TYPE process_cpu_seconds_total counter
</span><span class='line'>process_cpu_seconds_total 5.86
</span><span class='line'># HELP process_open_fds Number of open file descriptors.
</span><span class='line'># TYPE process_open_fds gauge
</span><span class='line'>process_open_fds 6.0
</span><span class='line'># HELP process_max_fds Maximum number of open file descriptors.
</span><span class='line'># TYPE process_max_fds gauge
</span><span class='line'>process_max_fds 1024.0
</span><span class='line'># HELP current_humidity the current humidity percentage, this is a gauge as the value can increase or decrease
</span><span class='line'># TYPE current_humidity gauge
</span><span class='line'>current_humidity{room="study"} 47.0
</span><span class='line'># HELP current_temperature the current temperature in celsius, this is a gauge as the value can increase or decrease
</span><span class='line'># TYPE current_temperature gauge
</span><span class='line'>current_temperature{room="study"} 25.7
</span><span class='line'># HELP current_temperature_outside the current outside temperature in celsius, this is a gauge as the value can increase or decrease
</span><span class='line'># TYPE current_temperature_outside gauge
</span><span class='line'>current_temperature_outside{location="za_ct"} 27.97</span></code></pre></td></tr></table></div></figure>


<p>Now to configure our prometheus scrape config to scrape our endpoint:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/prometheus/prometheus.yml
</span><span class='line'>...
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'temperature-exporter'
</span><span class='line'>    scrape_interval: 15s
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['192.168.0.5:5000']
</span><span class='line'>      labels:
</span><span class='line'>        instance: 'pi-zero'
</span><span class='line'>        room: 'study'</span></code></pre></td></tr></table></div></figure>


<p>Then restart prometheus and head over to Grafana.</p>

<p>We will be adding a new panel with a graph visualization, and from our prometheus datasource, we will be referencing the 2 metrics (different from the screenshot):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>current_humidity{room="study"} 47.0
</span><span class='line'>current_temperature{room="study"} 25.7
</span><span class='line'>current_temperature_outside{location="za_ct"} 27.97</span></code></pre></td></tr></table></div></figure>


<p>As can be seen below:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103987136-a169b080-5194-11eb-8a61-6d36f45caf5c.png" alt="image" /></p>

<p>After a bit of customization, you can get something more or less like this:</p>

<p><img src="https://user-images.githubusercontent.com/30043398/104296987-fd9d3f00-54ca-11eb-8623-f3fd4a63e3cc.png" alt="image" /></p>

<h2>Thank You</h2>

<p>Thanks for reading, if you like my content feel free to visit my website <strong><a href="https://ruan.dev">ruan.dev</a></strong> or follow me on Twitter <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/09/cicd-with-droneci-and-gitea-using-docker-compose/">CICD With DroneCI and Gitea Using Docker Compose</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-09T01:10:10-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>1:10 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we wil set up a drone-ci and gitea stack using docker-compose and then running a test pipeline.</p>

<p>I have posted a few times about this topic, but this post will be used when I create other examples and wanting to use this post for the ones not having the stack booted yet.</p>

<h2>The Source Code</h2>

<p>All the code will be in my <a href="https://github.com/ruanbekker/drone-gitea-on-docker">github repository</a>.</p>

<p>For our <code>docker-compose.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: '3.6'
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  gitea:
</span><span class='line'>    container_name: gitea
</span><span class='line'>    image: gitea/gitea:${GITEA_VERSION:-1.10.6}
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    environment:
</span><span class='line'>      # https://docs.gitea.io/en-us/install-with-docker/#environments-variables
</span><span class='line'>      - APP_NAME="Gitea"
</span><span class='line'>      - USER_UID=1000
</span><span class='line'>      - USER_GID=1000
</span><span class='line'>      - RUN_MODE=prod
</span><span class='line'>      - DOMAIN=${IP_ADDRESS}
</span><span class='line'>      - SSH_DOMAIN=${IP_ADDRESS}
</span><span class='line'>      - HTTP_PORT=3000
</span><span class='line'>      - ROOT_URL=http://${IP_ADDRESS}:3000
</span><span class='line'>      - SSH_PORT=222
</span><span class='line'>      - SSH_LISTEN_PORT=22
</span><span class='line'>      - DB_TYPE=sqlite3
</span><span class='line'>    ports:
</span><span class='line'>      - "3000:3000"
</span><span class='line'>      - "222:22"
</span><span class='line'>    networks:
</span><span class='line'>      - cicd_net
</span><span class='line'>    volumes:
</span><span class='line'>      - ./gitea:/data
</span><span class='line'>
</span><span class='line'>  drone:
</span><span class='line'>    container_name: drone
</span><span class='line'>    image: drone/drone:${DRONE_VERSION:-1.6.4}
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    depends_on:
</span><span class='line'>      - gitea
</span><span class='line'>    environment:
</span><span class='line'>      # https://docs.drone.io/server/provider/gitea/
</span><span class='line'>      - DRONE_DATABASE_DRIVER=sqlite3
</span><span class='line'>      - DRONE_DATABASE_DATASOURCE=/data/database.sqlite
</span><span class='line'>      - DRONE_GITEA_SERVER=http://${IP_ADDRESS}:3000/
</span><span class='line'>      - DRONE_GIT_ALWAYS_AUTH=false
</span><span class='line'>      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
</span><span class='line'>      - DRONE_SERVER_PROTO=http
</span><span class='line'>      - DRONE_SERVER_HOST=${IP_ADDRESS}:3001
</span><span class='line'>      - DRONE_TLS_AUTOCERT=false
</span><span class='line'>      - DRONE_USER_CREATE=${DRONE_USER_CREATE}
</span><span class='line'>      - DRONE_GITEA_CLIENT_ID=${DRONE_GITEA_CLIENT_ID}
</span><span class='line'>      - DRONE_GITEA_CLIENT_SECRET=${DRONE_GITEA_CLIENT_SECRET}
</span><span class='line'>    ports:
</span><span class='line'>      - "3001:80"
</span><span class='line'>      - "9001:9000"
</span><span class='line'>    networks:
</span><span class='line'>      - cicd_net
</span><span class='line'>    volumes:
</span><span class='line'>      - /var/run/docker.sock:/var/run/docker.sock
</span><span class='line'>      - ./drone:/data
</span><span class='line'>
</span><span class='line'>  drone-runner:
</span><span class='line'>    container_name: drone-runner
</span><span class='line'>    image: drone/drone-runner-docker:${DRONE_RUNNER_VERSION:-1}
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    depends_on:
</span><span class='line'>      - drone
</span><span class='line'>    environment:
</span><span class='line'>      # https://docs.drone.io/runner/docker/installation/linux/
</span><span class='line'>      # https://docs.drone.io/server/metrics/
</span><span class='line'>      - DRONE_RPC_PROTO=http
</span><span class='line'>      - DRONE_RPC_HOST=drone
</span><span class='line'>      - DRONE_RPC_SECRET=${DRONE_RPC_SECRET}
</span><span class='line'>      - DRONE_RUNNER_NAME="${HOSTNAME}-runner"
</span><span class='line'>      - DRONE_RUNNER_CAPACITY=2
</span><span class='line'>      - DRONE_RUNNER_NETWORKS=cicd_net
</span><span class='line'>      - DRONE_DEBUG=false
</span><span class='line'>      - DRONE_TRACE=false
</span><span class='line'>    ports:
</span><span class='line'>      - "3002:3000"
</span><span class='line'>    networks:
</span><span class='line'>      - cicd_net
</span><span class='line'>    volumes:
</span><span class='line'>      - /var/run/docker.sock:/var/run/docker.sock
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  cicd_net:
</span><span class='line'>    name: cicd_net</span></code></pre></td></tr></table></div></figure>


<p>Our <code>boot.sh</code> which we will use to override environment variables:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env bash
</span><span class='line'>
</span><span class='line'>export HOSTNAME=$(hostname)
</span><span class='line'>export DRONE_VERSION=1.10.1
</span><span class='line'>export DRONE_RUNNER_VERSION=1.6.3
</span><span class='line'>export GITEA_VERSION=1.13
</span><span class='line'>export IP_ADDRESS=192.168.0.6
</span><span class='line'>export MINIO_ACCESS_KEY="EXAMPLEKEY"
</span><span class='line'>export MINIO_SECRET_KEY="EXAMPLESECRET"
</span><span class='line'>export GITEA_ADMIN_USER="example"
</span><span class='line'>export DRONE_RPC_SECRET="$(echo ${HOSTNAME} | openssl dgst -md5 -hex)"
</span><span class='line'>export DRONE_USER_CREATE="username:${GITEA_ADMIN_USER},machine:false,admin:true,token:${DRONE_RPC_SECRET}"
</span><span class='line'>export DRONE_GITEA_CLIENT_ID=""
</span><span class='line'>export DRONE_GITEA_CLIENT_SECRET=""
</span><span class='line'>docker-compose up -d
</span><span class='line'>
</span><span class='line'>echo ""
</span><span class='line'>echo "Gitea: http://${IP_ADDRESS}:3000/"
</span><span class='line'>echo "Drone: http://${IP_ADDRESS}:3001/"</span></code></pre></td></tr></table></div></figure>


<h2>Deploy the Stack</h2>

<p>Set the following in your <code>boot.sh</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>IP_ADDRESS=192.168.0.6       -&gt; either reachable dns or ip address which will be your clone address and ui addresses.
</span><span class='line'>GITEA_ADMIN_USER="giteauser" -&gt; will be the user you register with in drone</span></code></pre></td></tr></table></div></figure>


<p>Now boot the stack:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ bash boot.sh</span></code></pre></td></tr></table></div></figure>


<p><em>Note</em>: Theres a <a href="https://github.com/go-gitea/gitea/issues/7702">current issue</a> where webhooks get fired twice, if you see that just restart gitea with <code>docker restart gitea</code>.</p>

<ul>
<li><p>Head over to: <code>http://${IP_ADDRESS}:3000/user/settings/applications</code> and create a new OAuth2 Application and set the Redirect URI to <code>http://${IP_ADDRESS}:3001/login</code></p></li>
<li><p>Capture the client id and client secret and populate them in the <code>boot.sh</code> in <code>DRONE_GITEA_CLIENT_ID</code> and <code>DRONE_GITEA_CLIENT_SECRET</code> and run <code>bash boot.sh</code> again. This will give drone the correct credentials in order to authenticate with gitea.</p></li>
<li><p>Now when you head over to <code>http://${IP_ADDRESS}:3001/</code> you will be asked to authorize the application and you should be able to access drone.</p></li>
</ul>


<h2>Drone CLI</h2>

<p>Install Drone CLI:
- <a href="https://docs.drone.io/cli/install/">https://docs.drone.io/cli/install/</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -L https://github.com/drone/drone-cli/releases/latest/download/drone_darwin_amd64.tar.gz | tar zx
</span><span class='line'>$ sudo mv drone /usr/local/bin/drone
</span><span class='line'>$ chmod +x /usr/local/bin/drone</span></code></pre></td></tr></table></div></figure>


<p>Get your Drone Token:
- <a href="http://$">http://$</a>{IP_ADDRESS}:3001/account</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export DRONE_SERVER=http://${IP_ADDRESS}:3001
</span><span class='line'>$ export DRONE_TOKEN=one-from-the-account-page
</span><span class='line'>drone info</span></code></pre></td></tr></table></div></figure>


<h2>Build your first pipeline</h2>

<p>Create a test repo in gitea:</p>

<p><img src="https://user-images.githubusercontent.com/567298/110296470-0ad23800-7ffb-11eb-8428-af49d0ebd62d.png" alt="image" /></p>

<p>Commit a <code>.drone.yml</code> file for drone:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>kind: pipeline
</span><span class='line'>type: docker
</span><span class='line'>name: hello-world
</span><span class='line'>
</span><span class='line'>trigger:
</span><span class='line'>  branch:
</span><span class='line'>    - master
</span><span class='line'>  event:
</span><span class='line'>    - push
</span><span class='line'>
</span><span class='line'>steps:
</span><span class='line'>  - name: say-hello
</span><span class='line'>    image: busybox
</span><span class='line'>    commands:
</span><span class='line'>      - echo hello-world</span></code></pre></td></tr></table></div></figure>


<p>Head over to drone and sync your repositories:</p>

<p><img src="https://user-images.githubusercontent.com/567298/110296425-00b03980-7ffb-11eb-9216-76725a62c09e.png" alt="image" /></p>

<p>Activate your repository:</p>

<p><img src="https://user-images.githubusercontent.com/567298/110296623-3523f580-7ffb-11eb-805f-db5db4dab0cb.png" alt="image" /></p>

<p>Push a commit to master and see your pipeline running:</p>

<p><img src="https://user-images.githubusercontent.com/567298/110296747-584ea500-7ffb-11eb-9909-259641a663aa.png" alt="image" /></p>

<h2>More Examples</h2>

<p>For more examples view my example section on the github repository:
- <a href="https://github.com/ruanbekker/drone-gitea-on-docker#more-examples">https://github.com/ruanbekker/drone-gitea-on-docker#more-examples</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/02/26/ship-your-docker-logs-to-loki-using-fluentbit/">Ship Your Docker Logs to Loki Using Fluentbit</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-02-26T15:26:34-05:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>3:26 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial, I will show you how to ship your docker containers logs to <a href="https://grafana.com/oss/loki/">Grafana Loki</a> via <a href="https://fluentbit.io/">Fluent Bit</a>.</p>

<h2>Grafana and Loki</h2>

<p>First we need to get Grafana and Loki up and running and we will be using docker and docker-compose to do that.</p>

<p>Our <code>docker-compose-loki.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: "3.7"
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  grafana:
</span><span class='line'>    image: grafana/grafana:7.4.2
</span><span class='line'>    container_name: 'grafana'
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    volumes:
</span><span class='line'>      - ./data/grafana/data:/var/lib/grafana
</span><span class='line'>      - ./configs/grafana/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml
</span><span class='line'>    networks:
</span><span class='line'>      - public
</span><span class='line'>    ports:
</span><span class='line'>      - 3000:3000
</span><span class='line'>    depends_on:
</span><span class='line'>      - loki
</span><span class='line'>    logging:
</span><span class='line'>      driver: "json-file"
</span><span class='line'>      options:
</span><span class='line'>        max-size: "1m"  
</span><span class='line'>  
</span><span class='line'>  loki:
</span><span class='line'>    image: grafana/loki:2.1.0
</span><span class='line'>    container_name: loki
</span><span class='line'>    command: -config.file=/mnt/loki-local-config.yaml
</span><span class='line'>    user: root
</span><span class='line'>    restart: unless-stopped
</span><span class='line'>    volumes:
</span><span class='line'>      - ./data/loki/data:/tmp/loki
</span><span class='line'>      - ./configs/loki/loki.yml:/mnt/loki-local-config.yaml
</span><span class='line'>    ports:
</span><span class='line'>      - 3100:3100
</span><span class='line'>    networks:
</span><span class='line'>      - public
</span><span class='line'>    logging:
</span><span class='line'>      driver: "json-file"
</span><span class='line'>      options:
</span><span class='line'>        max-size: "1m"
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  public:
</span><span class='line'>    name: public</span></code></pre></td></tr></table></div></figure>


<p>We are referencing 2 config files, first our loki datasource defined by <code>./configs/grafana/datasource.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apiVersion: 1
</span><span class='line'>
</span><span class='line'>datasources:
</span><span class='line'>- name: loki
</span><span class='line'>  type: loki
</span><span class='line'>  access: proxy
</span><span class='line'>  orgId: 1
</span><span class='line'>  url: http://loki:3100
</span><span class='line'>  basicAuth: false
</span><span class='line'>  isDefault: true
</span><span class='line'>  version: 1
</span><span class='line'>  editable: true</span></code></pre></td></tr></table></div></figure>


<p>And our second config is our loki config <code>./configs/loki/loki.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auth_enabled: false
</span><span class='line'>
</span><span class='line'>server:
</span><span class='line'>  http_listen_port: 3100
</span><span class='line'>
</span><span class='line'>ingester:
</span><span class='line'>  lifecycler:
</span><span class='line'>    address: 127.0.0.1
</span><span class='line'>    ring:
</span><span class='line'>      kvstore:
</span><span class='line'>        store: inmemory
</span><span class='line'>      replication_factor: 1
</span><span class='line'>    final_sleep: 0s
</span><span class='line'>  chunk_idle_period: 5m
</span><span class='line'>  chunk_retain_period: 30s
</span><span class='line'>  max_transfer_retries: 0
</span><span class='line'>
</span><span class='line'>schema_config:
</span><span class='line'>  configs:
</span><span class='line'>    - from: 2018-04-15
</span><span class='line'>      store: boltdb
</span><span class='line'>      object_store: filesystem
</span><span class='line'>      schema: v11
</span><span class='line'>      index:
</span><span class='line'>        prefix: index_
</span><span class='line'>        period: 168h
</span><span class='line'>
</span><span class='line'>storage_config:
</span><span class='line'>  boltdb:
</span><span class='line'>    directory: /tmp/loki/index
</span><span class='line'>
</span><span class='line'>  filesystem:
</span><span class='line'>    directory: /tmp/loki/chunks
</span><span class='line'>
</span><span class='line'>limits_config:
</span><span class='line'>  enforce_metric_name: false
</span><span class='line'>  reject_old_samples: true
</span><span class='line'>  reject_old_samples_max_age: 168h
</span><span class='line'>
</span><span class='line'>chunk_store_config:
</span><span class='line'>  max_look_back_period: 0s
</span><span class='line'>
</span><span class='line'>table_manager:
</span><span class='line'>  retention_deletes_enabled: false
</span><span class='line'>  retention_period: 0s</span></code></pre></td></tr></table></div></figure>


<p>Once you have everything in place, boot the grafana and loki containers:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose -f docker-compose-loki.yml up -d</span></code></pre></td></tr></table></div></figure>


<h2>Fluent Bit</h2>

<p>Next we need to boot our log processor and forwarder, fluent bit. In our <code>docker-compose-fluentbit.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: "3.7"
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  fluent-bit:
</span><span class='line'>    image: grafana/fluent-bit-plugin-loki:latest
</span><span class='line'>    container_name: fluent-bit
</span><span class='line'>    environment:
</span><span class='line'>      - LOKI_URL=http://loki:3100/loki/api/v1/push
</span><span class='line'>    volumes:
</span><span class='line'>      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
</span><span class='line'>    ports:
</span><span class='line'>      - "24224:24224"
</span><span class='line'>      - "24224:24224/udp"
</span><span class='line'>    networks:
</span><span class='line'>      - public
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  public:
</span><span class='line'>    name: public</span></code></pre></td></tr></table></div></figure>


<p>And as you can see we are referencing a config <code>./configs/fluentbit/fluent-bit.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[INPUT]
</span><span class='line'>    Name        forward
</span><span class='line'>    Listen      0.0.0.0
</span><span class='line'>    Port        24224
</span><span class='line'>[Output]
</span><span class='line'>    Name grafana-loki
</span><span class='line'>    Match *
</span><span class='line'>    Url ${LOKI_URL}
</span><span class='line'>    RemoveKeys source,container_id
</span><span class='line'>    Labels {job="fluent-bit"}
</span><span class='line'>    LabelKeys container_name
</span><span class='line'>    BatchWait 1s
</span><span class='line'>    BatchSize 1001024
</span><span class='line'>    LineFormat json
</span><span class='line'>    LogLevel info</span></code></pre></td></tr></table></div></figure>


<p>Once you have your configs in place, boot fluent-bit:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose -f docker-compose-fluentbit.yml up -d</span></code></pre></td></tr></table></div></figure>


<h2>Nginx App</h2>

<p>Now to configure our docker container to ship its logs to fluent-bit, which will forward the logs to Loki.</p>

<p>In our <code>docker-compose-app.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: "3"
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  nginx-json:
</span><span class='line'>    image: ruanbekker/nginx-demo:json
</span><span class='line'>    container_name: nginx-app
</span><span class='line'>    ports:
</span><span class='line'>      - 8080:80
</span><span class='line'>    logging:
</span><span class='line'>      driver: fluentd
</span><span class='line'>      options:
</span><span class='line'>        fluentd-address: 127.0.0.1:24224</span></code></pre></td></tr></table></div></figure>


<p>The fluent-bit container listens on port 24224 locally on our docker host and is not reachable via its container network, so let&rsquo;s boot our application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose -f docker-compose-app.yml up -d</span></code></pre></td></tr></table></div></figure>


<p>Once our application is up, let&rsquo;s make a request to our nginx-app:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://localhost:8080/
</span><span class='line'>ok</span></code></pre></td></tr></table></div></figure>


<p>Now head over to Grafana at <a href="http://localhost:3000/explore">http://localhost:3000/explore</a> and query: <code>{job="fluent-bit", container_name="/nginx-app"}</code> and you should see something like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109366000-03908900-789b-11eb-952e-36ff23657517.png" alt="image" /></p>

<p>Beautiful right? I know.</p>

<h2>Github Repo</h2>

<p>The source code for this can be found on:</p>

<ul>
<li><a href="https://github.com/ruanbekker/docker-logging-loki-fuentbit">https://github.com/ruanbekker/docker-logging-loki-fuentbit</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/01/31/installing-arduino-and-setup-the-nodemcu-esp32/">Installing Arduino and Setup the NodeMCU ESP32</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-01-31T11:33:31-05:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2021</span></span> <span class='time'>11:33 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A couple of weeks ago I got myself the <a href="">NodeMCU ESP32 Development Board</a>:</p>

<p><img src="https://user-images.githubusercontent.com/567298/106391027-f5626080-63f3-11eb-9dca-5efce53fbf80.png" alt="image" /></p>

<p>If you want to view more in-depth specs about the board you can have a look at the <a href="https://www.espressif.com/sites/default/files/documentation/esp32_datasheet_en.pdf">ESP32 Datasheet</a>, but in short it has:</p>

<ul>
<li>ESP32-D0WDQ6 Processor</li>
<li>WiFi with frequency range of 2.4G ~ 2.5G (2400M ~ 2483.5M)</li>
<li>Bluetooth 4.2</li>
<li>32Mbit built in Flash</li>
<li>2x19pin extension headers, breakout all the I/O pins of the module</li>
<li>2x keys, used as reset or user-defined</li>
</ul>


<h2>About this Tutorial</h2>

<p>In this tutorial we will download and install Arduino and how to setup our ESP32 Board, then just running a basic hello world application</p>

<h2>Installing Arduino</h2>

<p>Head over to <a href="https://www.arduino.cc/en/software">arduino.cc/en/software</a> and download arduino for your operating system.</p>

<p>Once installed you can reference <a href="https://github.com/espressif/arduino-esp32">arduino-esp32</a> for your operating system, but in general you will open the Arduino application, select Preferences and provide the following link on the &ldquo;Additional Boards Manager URL&rdquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json</span></code></pre></td></tr></table></div></figure>


<p>Hit OK, then select Tools, Board, Board Manager, then search for &ldquo;esp32&rdquo;, then install esp32 by Espressif Systems:</p>

<p><img width="800" alt="image" src="https://user-images.githubusercontent.com/567298/106391354-8c7be800-63f5-11eb-852d-d472fe3624e9.png"></p>

<p>Then make sure to select the board by navigating to Tools, Board, ESP32 Arduino, ESP32 Dev Module:</p>

<p><img width="1110" alt="image" src="https://user-images.githubusercontent.com/567298/106391458-06ac6c80-63f6-11eb-8a0b-eed0ae7e786b.png"></p>

<p>Select the upload rate from Tools, Upload Rate to 115200 and select the serial port, from mine it is Tools, Port, usb-serial-0001 (your&rsquo;s might differ)</p>

<h2>Hello World Application</h2>

<p>Now that we have Arduino installed and our board configured, let&rsquo;s write a hello world application, from the input text section:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>void setup() {
</span><span class='line'>  Serial.begin(115200);
</span><span class='line'>  Serial.println("Setup done");
</span><span class='line'>  delay(5000);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>void loop() {
</span><span class='line'>  Serial.println("Hello, World");
</span><span class='line'>  delay(1000);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>From the setup function we set the baud rate and print a line then sleep for 5 seconds, once that is done we call the loop function which will print &ldquo;Hello, World&rdquo; and sleep for 1 second, and that will loop indefinitely.</p>

<p>Once you are done, save your sketch and upload it to the board by either selecting the upload button or from Sketch, Upload.</p>

<p>When the code has been compiled the device will reset and you can open the serial monitor, by selecting Tools, Serial Monitor:</p>

<p><img width="936" alt="image" src="https://user-images.githubusercontent.com/567298/106391690-47f14c00-63f7-11eb-85bf-227f1ac5f92a.png"></p>

<h2>Thank You</h2>

<p>Thank you for reading.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/12/23/reduce-docker-log-size-on-disk/">Reduce Docker Log Size on Disk</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-12-23T04:11:35-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2020</span></span> <span class='time'>4:11 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In cases where you are using the defaults for logging and your application logs a lot you can consume a lot of disk space and you can run out of disk space quite quickly.</p>

<p>If it&rsquo;s a case where you already ran out of disk space, we can investigate the disk space consumed by docker logs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /var/lib/docker/containers
</span><span class='line'>$ du -sh *
</span><span class='line'>6.0G  14052251a0f13f46f65bc73d10c01408130ee8ae71529600ba5bd6bee76af4ee
</span><span class='line'>1.2G  e6b40b1d30c5cf05e8cb201ca9abf6bd283d7cf7ceaa3be2a0422be7cd750a33</span></code></pre></td></tr></table></div></figure>


<p>Referenced from <a href="https://blog.birkhoff.me/devops-truncate-docker-container-logs-periodically-to-free-up-server-disk-space/">https://blog.birkhoff.me/devops-truncate-docker-container-logs-periodically-to-free-up-server-disk-space/</a> you can truncate those files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sh -c 'truncate -s 0 /var/lib/docker/containers/*/*-json.log'</span></code></pre></td></tr></table></div></figure>


<p>Check the size again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ du -sh *
</span><span class='line'>40K   14052251a0f13f46f65bc73d10c01408130ee8ae71529600ba5bd6bee76af4ee
</span><span class='line'>36K   e6b40b1d30c5cf05e8cb201ca9abf6bd283d7cf7ceaa3be2a0422be7cd750a33</span></code></pre></td></tr></table></div></figure>


<p>To overcome this issue you can use this in logging options in your compose:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>    logging:
</span><span class='line'>      driver: "json-file"
</span><span class='line'>      options:
</span><span class='line'>        max-size: "1m"
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/12/23/https-for-local-development-with-minica/">HTTPS for Local Development With MiniCA</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-12-23T03:11:08-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2020</span></span> <span class='time'>3:11 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will use <a href="https://github.com/jsha/minica">minica</a> to enable us to run our web applications over HTTPS for local development.</p>

<p>To read more about about <a href="https://github.com/jsha/minica">minica</a> check out their website.</p>

<h2>Generate Certificates</h2>

<p>You can use their binary from their github page or use my docker image to generate the certificates to a <code>./certs</code> directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run --user "$(id -u):$(id -g)" -it -v $PWD/certs:/output ruanbekker/minica --domains 192.168.0.20.nip.io</span></code></pre></td></tr></table></div></figure>


<p>In the case from above, we are generating certificates for the FQDN <code>192.168.0.20.nip.io</code>. You will find the generated certificates under <code>./certs/</code>.</p>

<h2>Application Stack</h2>

<p>We will use docker to create a nginx webserver to serve our content via https using the generated vertificates.</p>

<p>Our <code>docker-compose.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: '3.7'
</span><span class='line'>services:
</span><span class='line'>  nginx:
</span><span class='line'>    image: nginx
</span><span class='line'>    container_name: nginx
</span><span class='line'>    ports:
</span><span class='line'>      - 80:80
</span><span class='line'>      - 443:443
</span><span class='line'>    volumes:
</span><span class='line'>      - ~/personal/docker-minica-nginx/nginx.conf:/etc/nginx/nginx.conf
</span><span class='line'>      - ~/personal/docker-minica-nginx/ssl.conf:/etc/nginx/conf.d/ssl.conf
</span><span class='line'>      - ~/personal/docker-minica-nginx/certs/192.168.0.6.nip.io:/etc/nginx/certs
</span><span class='line'>      - ~/personal/docker-minica-nginx/html/index.html:/usr/share/nginx/html/index.html</span></code></pre></td></tr></table></div></figure>


<p>Our <code>nginx.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user  nginx;
</span><span class='line'>worker_processes  1;
</span><span class='line'>error_log  /var/log/nginx/error.log warn;
</span><span class='line'>pid        /var/run/nginx.pid;
</span><span class='line'>
</span><span class='line'>events {
</span><span class='line'>    worker_connections  1024;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>http {
</span><span class='line'>    include       /etc/nginx/mime.types;
</span><span class='line'>    default_type  application/octet-stream;
</span><span class='line'>
</span><span class='line'>    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
</span><span class='line'>                      '$status $body_bytes_sent "$http_referer" '
</span><span class='line'>                      '"$http_user_agent" "$http_x_forwarded_for"';
</span><span class='line'>
</span><span class='line'>    access_log  /var/log/nginx/access.log  main;
</span><span class='line'>
</span><span class='line'>    sendfile        on;
</span><span class='line'>    keepalive_timeout  65;
</span><span class='line'>    include /etc/nginx/conf.d/ssl.conf;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Our <code>ssl.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>    listen 80;
</span><span class='line'>    server_name 192.168.0.6.nip.io;
</span><span class='line'>    return 301 https://$host$request_uri;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>server {
</span><span class='line'>    listen 443 ssl;
</span><span class='line'>    server_name 192.168.0.6.nip.io;
</span><span class='line'>
</span><span class='line'>    ssl_certificate /etc/nginx/certs/cert.pem;
</span><span class='line'>    ssl_certificate_key /etc/nginx/certs/key.pem;
</span><span class='line'>
</span><span class='line'>    location / {
</span><span class='line'>        root   /usr/share/nginx/html;
</span><span class='line'>        index  index.html;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Our <code>html/index.html</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!DOCTYPE html&gt;
</span><span class='line'>&lt;html lang="en-us"&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>    &lt;meta charset="utf-8"&gt;
</span><span class='line'>    &lt;link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"&gt;
</span><span class='line'>    &lt;script src="https://code.jquery.com/jquery-3.1.1.min.js" crossorigin="anonymous"&gt;&lt;/script&gt;
</span><span class='line'>    &lt;title&gt;Sample Page&lt;/title&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>&lt;body&gt;
</span><span class='line'>    &lt;div class="container-fluid"&gt;
</span><span class='line'>        &lt;div class="row"&gt;
</span><span class='line'>            &lt;div class="bitProcessor"&gt;&lt;/div&gt;
</span><span class='line'>            &lt;div class="col-md-12" style="background-color: white; position: absolute; top: 40%;width: 80%;left: 10%;"&gt;
</span><span class='line'>                &lt;center&gt;
</span><span class='line'>                    &lt;h1&gt;Hello, World!&lt;/h1&gt;
</span><span class='line'>                  &lt;p&gt;This is sample text.&lt;/p&gt;
</span><span class='line'>                &lt;/center&gt;
</span><span class='line'>            &lt;/div&gt;
</span><span class='line'>        &lt;/div&gt;
</span><span class='line'>    &lt;/div&gt;
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Import Certificates</h2>

<p>We have a certificate <code>./certs/minica.pem</code> which we need to import and trust on our local workstation, I am using a Mac so it will be Keychain Access.</p>

<p><img src="https://user-images.githubusercontent.com/567298/101961866-5a2ee500-3c13-11eb-9f89-03fa1bd4670d.png" alt="image" /></p>

<p>Once you open Keychain Access, select &ldquo;file&rdquo;, &ldquo;import items&rdquo; and browse and import <code>./certs/minica.pem</code>, once you are done search for minica:</p>

<p><img src="https://user-images.githubusercontent.com/567298/101962064-d4f80000-3c13-11eb-9479-c043ba3ced2c.png" alt="image" /></p>

<p>Select the item, file -> get info, expand trust, change &ldquo;when using this certificate&rdquo; to Always trust and close.</p>

<p>You will now see the root ca is trusted:</p>

<p><img src="https://user-images.githubusercontent.com/567298/101962197-2dc79880-3c14-11eb-8d26-49874c9703fa.png" alt="image" /></p>

<h2>Boot the Application Stack</h2>

<p>As we have <code>docker-compose.yml</code> in our current working directory, we can use docker-compose to boot our application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose up
</span><span class='line'>Creating network "docker-minica-nginx_default" with the default driver
</span><span class='line'>Creating nginx ... done
</span><span class='line'>Attaching to nginx</span></code></pre></td></tr></table></div></figure>


<p>Now when we browse to <code>https://192.168.0.6.nip.io</code> we will see:</p>

<p><img src="https://user-images.githubusercontent.com/567298/101962367-a9c1e080-3c14-11eb-898b-688b50c1b9db.png" alt="image" /></p>

<p>And when we inspect the certificate, we can see its valid:</p>

<p><img src="https://user-images.githubusercontent.com/567298/101962411-c78f4580-3c14-11eb-80cd-cf8e449eca95.png" alt="image" /></p>

<h2>Thank You</h2>

<p>Thank you for reading.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/12/18/harden-your-ssh-security-on-linux-servers/">Harden Your SSH Security on Linux Servers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-12-18T13:32:18+00:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>1:32 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we wil be focusing on increasing / hardening our security by adjusting our ssh configuration and applying some iptables firewall rules.</p>

<p>This will be the list of things that we will do:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  - Change the SSH Port
</span><span class='line'>  - Don't allow root to SSH
</span><span class='line'>  - Disable password based authentication
</span><span class='line'>  - Enable key based authentication and only for a singular user
</span><span class='line'>  - Allow our user to sudo
</span><span class='line'>  - Use iptables to block sources trying to DDoS your server</span></code></pre></td></tr></table></div></figure>


<h2>Packages</h2>

<p>First let&rsquo;s install the packages that we need, I&rsquo;m using Debian so I will be using the <code>apt</code> package manager:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt upgrade -y
</span><span class='line'>$ apt install sudo -y</span></code></pre></td></tr></table></div></figure>


<h2>Dedicated User</h2>

<p>Let&rsquo;s create our user james:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ useradd -m -s /bin/bash james</span></code></pre></td></tr></table></div></figure>


<p>Allow our user to sudo without a password, by running <code>visudo</code> then append the following line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>james ALL=(ALL:ALL) NOPASSWD: ALL</span></code></pre></td></tr></table></div></figure>


<h2>SSH Authorized Keys</h2>

<p>If you don&rsquo;t already have a private SSH key, generate one on your client side:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh-keygen -f ~/.ssh/james -t rsa -C "james" -q -N ""</span></code></pre></td></tr></table></div></figure>


<p>Then copy the public key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.ssh/james.pub | pbcopy</span></code></pre></td></tr></table></div></figure>


<p>On your server create the SSH directories:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /home/james/.ssh</span></code></pre></td></tr></table></div></figure>


<p>Now paste your public key into <code>/home/james/.ssh/authorized_keys</code></p>

<p>Then change the ownership:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod 700 /home/james/.ssh
</span><span class='line'>$ chmod 644 /home/james/.ssh/authorized_keys
</span><span class='line'>$ chown -R james:james /home/james</span></code></pre></td></tr></table></div></figure>


<h2>SSH Config</h2>

<p>Backup your SSH config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp /etc/ssh/sshd_config /etc/ssh_sshd_config.bak</span></code></pre></td></tr></table></div></figure>


<p>We will be using the SSH port <code>2914</code>, replace your SSH config with the following and make your adjustments where you need to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/ssh/sshd_config
</span><span class='line'>Port 2914
</span><span class='line'>HostKey /etc/ssh/ssh_host_rsa_key
</span><span class='line'>HostKey /etc/ssh/ssh_host_ecdsa_key
</span><span class='line'>HostKey /etc/ssh/ssh_host_ed25519_key
</span><span class='line'>LoginGraceTime 1m
</span><span class='line'>PermitRootLogin no
</span><span class='line'>MaxAuthTries 3
</span><span class='line'>MaxSessions 5
</span><span class='line'>AuthenticationMethods publickey
</span><span class='line'>PubkeyAuthentication yes
</span><span class='line'>AuthorizedKeysFile      /home/james/.ssh/authorized_keys
</span><span class='line'>PasswordAuthentication no
</span><span class='line'>PermitEmptyPasswords no
</span><span class='line'>ChallengeResponseAuthentication no
</span><span class='line'>UsePAM yes
</span><span class='line'>AllowUsers james
</span><span class='line'>DenyUsers root
</span><span class='line'>X11Forwarding yes
</span><span class='line'>PrintMotd no
</span><span class='line'>UseDNS no
</span><span class='line'>PidFile /var/run/sshd.pid
</span><span class='line'>AcceptEnv LANG LC_*
</span><span class='line'>Subsystem       sftp    /usr/lib/openssh/sftp-server</span></code></pre></td></tr></table></div></figure>


<p>Then save the file and restart SSH:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart sshd</span></code></pre></td></tr></table></div></figure>


<p>While you are still connected to the shell session, open up a new terminal and try to connect with your new user and private SSH key to ensure that you can connect to your server.</p>

<h2>Iptables</h2>

<p>We want to drop incoming connections which make more than 10 connection attempts to SSH within 60 seconds.</p>

<p>The tokens get refilled into buckets at 3 per minute and maximum of 3 tokens that can be filled into the bucket.</p>

<p>Let&rsquo;s create our script:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p /opt/scripts
</span><span class='line'>$ touch /opt/scripts/fw.sh</span></code></pre></td></tr></table></div></figure>


<p>In our script we will place the following content:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env bash
</span><span class='line'>INTERFACE=eth0 # check ifconfig to determine the correct interface
</span><span class='line'>SSH_PORT=2914
</span><span class='line'>CONNECTION_ATTEMPTS=10
</span><span class='line'>CONNECTION_TIME=60
</span><span class='line'>#WHITELIST_IP=x.x.x.x/32 # replace ip and uncomment if you want to whitelist a ip
</span><span class='line'>#iptables -I INPUT -s ${WHITELIST_IP} -p tcp --dport ${SSH_PORT} -i ${INTERFACE} -j ACCEPT # uncomment if you want to use whitelisting
</span><span class='line'>iptables -A INPUT -p tcp --dport ${SSH_PORT} -i ${INTERFACE} -m state --state NEW -m recent  --set
</span><span class='line'>iptables -A INPUT -p tcp --dport ${SSH_PORT} -i ${INTERFACE} -m state --state NEW -m recent  --update --seconds ${CONNECTION_TIME} --hitcount ${CONNECTION_ATTEMPTS} -j DROP
</span><span class='line'>iptables -A INPUT  -i ${INTERFACE} -p tcp --dport ${SSH_PORT} -m state --state NEW -m limit --limit 3/min --limit-burst 3 -j ACCEPT
</span><span class='line'>iptables -A INPUT  -i ${INTERFACE} -p tcp --dport ${SSH_PORT} -m state --state ESTABLISHED -j ACCEPT
</span><span class='line'>iptables -A OUTPUT -o ${INTERFACE} -p tcp --sport ${SSH_PORT} -m state --state ESTABLISHED -j ACCEPT</span></code></pre></td></tr></table></div></figure>


<p>Now we want to execute this script whenever the server boots, open up <code>/etc/rc.local</code> and append the following line, so that the file looks more or less like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>/opt/scripts/fw.sh
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<p>Ensure both files are executable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod +x /opt/scripts/fw.sh
</span><span class='line'>$ chmod +x /etc/rc.local</span></code></pre></td></tr></table></div></figure>


<p>When you are sure everything is in place, reboot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ reboot</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/11/20/encrypt-and-decrypt-files-with-ccrypt/">Encrypt and Decrypt Files With Ccrypt</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-11-20T06:27:01+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>6:27 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a quick post to demonstrate how to encrypt and decrypt files with <strong>ccrypt</strong></p>

<h2>About</h2>

<p>Ccrypt&rsquo;s description from its project page:</p>

<p><em>Encryption and decryption depends on a keyword (or key phrase) supplied by the user. By default, the user is prompted to enter a keyword from the terminal. Keywords can consist of any number of characters, and all characters are significant (although ccrypt internally hashes the key to 256 bits). Longer keywords provide better security than short ones, since they are less likely to be discovered by exhaustive search.</em></p>

<p>Ref: <a href="http://ccrypt.sourceforge.net/">http://ccrypt.sourceforge.net/</a></p>

<h2>Install</h2>

<p>For debian based systems, to install ccrypt:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install ccrypt</span></code></pre></td></tr></table></div></figure>


<h2>Usage</h2>

<p>To encrypt files, write a file to disk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "ok" &gt; file.txt</span></code></pre></td></tr></table></div></figure>


<p>Then encrypt the file by providing a password:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ccencrypt file.txt
</span><span class='line'>Enter encryption key:
</span><span class='line'>Enter encryption key: (repeat)</span></code></pre></td></tr></table></div></figure>


<p>It encrypts and only the encrypted file can be found:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ls
</span><span class='line'>file.txt.cpt</span></code></pre></td></tr></table></div></figure>


<p>Decrypt the file, by providing your password that you encrypted it with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ccdecrypt file.txt.cpt
</span><span class='line'>Enter decryption key:</span></code></pre></td></tr></table></div></figure>


<p>View the decrypted file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat file.txt
</span><span class='line'>ok</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/11/11/deploy-loki-on-multipass/">Deploy Loki on Multipass</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-11-11T14:19:05+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>2:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://sysadmins.co.za/content/images/size/w1600/2020/11/loki-banner-2.png" alt="" /></p>

<p>In this post I will demonstrate how to deploy Grafana Labs&rsquo;s <strong>Loki</strong> on <strong>Multipass</strong> using cloud-init so that you can run your own dev environment and run a couple of queries to get you started.</p>

<h2>About</h2>

<p>If you haven&rsquo;t heard of <a href="https://multipass.run/">Multipass</a>, it allows you to run Ubuntu VMs on your Mac or Windows workstation.</p>

<p>If you haven&rsquo;t heard of <a href="https://grafana.com/oss/loki/">Loki</a>, as described by Grafana Labs: <em>&ldquo;Loki is a horizontally-scalable, highly-available, multi-tenant log aggregation system inspired by Prometheus.&rdquo;</em></p>

<h2>Install Multipass</h2>

<p>Head over to <a href="https://multipass.run/">multipass.run</a> to get the installer for your operating system, and if you are curious about Multipass, I wrote a beginners guide on Multipass which can be <strong><a href="https://sysadmins.co.za/getting-started-with-multipass-vms/">found here</a></strong></p>

<h2>Cloud Init for Loki</h2>

<p>We will be making use of <strong><a href="https://cloudinit.readthedocs.io/en/latest/">cloud-init</a></strong> to bootstrap <strong><a href="https://github.com/grafana/loki/releases/tag/v2.0.0">Loki v2.0.0</a></strong> to our multipass instance.</p>

<p>V2.0.0 is the current release of the time of writing, so depending on the time when you read this, have a look at the <a href="https://github.com/grafana/loki/releases">Loki Releases</a> page for the latest version and adjust the cloud-init.yml according to the version if it differs from the one I&rsquo;m mentioning.</p>

<p>(Optional) If you want to use SSH to your Multipass VM, you can use your existing SSH key or generate a new one, if you want to create a new key, you can <a href="https://sysadmins.co.za/getting-started-with-multipass-vms/">follow this post</a></p>

<p>Copy your public key, in my case <code>~/.ssh/id_rsa.pub</code> and paste it under the ssh <code>authorized_keys</code> section.</p>

<p>Our <code>cloud-init.yml</code> has a couple of sections, but to break it down it will do the following:</p>

<ul>
<li>We provide it our public ssh key so that we can ssh with our private key</li>
<li>Updates the index repository</li>
<li>Installs the packages, unzip and wget</li>
<li>Creates the loki systemd unit file and places it under /etc/systemd/system/</li>
<li>When the vm boots it will create the user loki and creates the loki etc directory</li>
<li>Once that completes, we are downloading the loki, logcli and promtail binaries from github</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1">#cloud-config</span>
</span><span class='line'><span class="l-Scalar-Plain">ssh_authorized_keys</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh-rsa AAAA...Ha9 your-comment</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">package_update</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">unzip</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">wget</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">write_files</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
</span><span class='line'>      <span class="no">[Unit]</span>
</span><span class='line'>      <span class="no">Description=Loki</span>
</span><span class='line'>      <span class="no">User=loki</span>
</span><span class='line'>      <span class="no">Group=loki</span>
</span><span class='line'>      <span class="no">Wants=network-online.target</span>
</span><span class='line'>      <span class="no">After=network-online.target</span>
</span><span class='line'>      <span class="no">[Service]</span>
</span><span class='line'>      <span class="no">Type=simple</span>
</span><span class='line'>      <span class="no">Restart=on-failure</span>
</span><span class='line'>      <span class="no">ExecStart=/usr/local/bin/loki -config.file /etc/loki/loki-local-config.yaml</span>
</span><span class='line'>      <span class="no">[Install]</span>
</span><span class='line'>      <span class="no">WantedBy=multi-user.target</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">owner</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root:root</span>
</span><span class='line'>    <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/systemd/system/loki.service</span>
</span><span class='line'>    <span class="l-Scalar-Plain">permissions</span><span class="p-Indicator">:</span> <span class="s">&#39;0644&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">bootcmd</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">useradd --no-create-home --shell /bin/false loki</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir /etc/loki</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">chown -R loki:loki /etc/loki</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">runcmd</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">for app in loki logcli promtail; do wget &quot;https://github.com/grafana/loki/releases/download/v2.0.0/${app}-linux-amd64.zip&quot;; done</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">for app in loki logcli promtail; do unzip &quot;${app}-linux-amd64.zip&quot;; done</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">for app in loki logcli promtail; do mv &quot;${app}-linux-amd64&quot; /usr/local/bin/${app}; done</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">for app in loki logcli promtail; do rm -f &quot;${app}-linux-amd64.zip&quot;; done</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">wget https://raw.githubusercontent.com/grafana/loki/v2.0.0/cmd/loki/loki-local-config.yaml</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mv ./loki-local-config.yaml /etc/loki/loki-local-config.yaml</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">chown loki:loki /etc/loki/loki-local-config.yaml</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">systemctl daemon-reload</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">systemctl start loki</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sleep 5</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is a test&quot; | promtail --stdin --client.url http://localhost:3100/loki/api/v1/push --client.external-labels=app=cli -server.disable</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will notice that the VM will have <code>loki</code>, <code>logcli</code> and <code>promtail</code> available on it, so you will have an environment to use all of them together.</p>

<p>As you can see once we start loki, we are piping <code>this is a test</code> to Loki using Promtail, so that we can verify that the data is visible in Loki. That step is not required, but just added it to this demo.</p>

<h2>Deploy Loki on Multipass</h2>

<p>We will provision a Multipass VM using the Ubuntu Focal distribution and spec our VM with 1 CPU, 512MB of Memory and 1GB of disk and then bootstrap our installation of Loki using cloud-init:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass launch focal <span class="se">\</span>
</span><span class='line'>  --name loki <span class="se">\</span>
</span><span class='line'>  --cpus <span class="m">1</span> <span class="se">\</span>
</span><span class='line'>  --mem 512m <span class="se">\</span>
</span><span class='line'>  --disk 1G <span class="se">\</span>
</span><span class='line'>  --cloud-init cloud-init.yml
</span><span class='line'>
</span><span class='line'>Creating: loki
</span><span class='line'>Waiting <span class="k">for</span> initialization to <span class="nb">complete </span>
</span><span class='line'>Launched: loki
</span></code></pre></td></tr></table></div></figure>


<p>We can validate if our Multipass VM is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass list
</span><span class='line'>Name                    State             IPv4             Image
</span><span class='line'>loki                    Running           192.168.64.19    Ubuntu 20.04 LTS
</span></code></pre></td></tr></table></div></figure>


<h2>Test Loki inside the VM</h2>

<p>First we will exec into the VM (or SSH), then we will test out Loki inside the VM since we already have logcli available:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass <span class="nb">exec </span>loki -- bash
</span><span class='line'>To run a <span class="nb">command </span>as administrator <span class="o">(</span>user <span class="s2">&quot;root&quot;</span><span class="o">)</span>, use <span class="s2">&quot;sudo &lt;command&gt;&quot;</span>.
</span><span class='line'>See <span class="s2">&quot;man sudo_root&quot;</span> <span class="k">for</span> details.
</span><span class='line'>
</span><span class='line'>ubuntu@loki:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remembered in our cloud-init, we instructed this command to run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s2">&quot;this is a test&quot;</span> <span class="p">|</span> promtail --stdin --client.url http://localhost:3100/loki/api/v1/push --client.external-labels<span class="o">=</span><span class="nv">app</span><span class="o">=</span>cli -server.disable
</span></code></pre></td></tr></table></div></figure>


<p>So if we use logcli, we can inspect our visible labels:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --quiet labels
</span><span class='line'>__name__
</span><span class='line'>app
</span><span class='line'>hostname
</span><span class='line'>job
</span></code></pre></td></tr></table></div></figure>


<p>And as we expect, we will see the app label from the <code>--client.external-labels=app=cli</code> argument that we passed. We can also look at the values for a given label:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --quiet labels app
</span><span class='line'>cli
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s query our logs using the label selector: <code>{app="cli"}</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --quiet --output raw query <span class="s1">&#39;{app=&quot;cli&quot;}&#39;</span>
</span><span class='line'>this is a <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we remove the extra arguments, we will see more verbose output like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli query <span class="s1">&#39;{app=&quot;cli&quot;}&#39;</span>
</span><span class='line'>
</span><span class='line'>http://localhost:3100/loki/api/v1/query_range?direction<span class="o">=</span>BACKWARD<span class="p">&amp;</span><span class="nv">end</span><span class="o">=</span>1605092055756745122<span class="p">&amp;</span><span class="nv">limit</span><span class="o">=</span>30<span class="p">&amp;</span><span class="nv">query</span><span class="o">=</span>%7Bapp%3D%22cli%22%7D<span class="p">&amp;</span><span class="nv">start</span><span class="o">=</span>1605088455756745122
</span><span class='line'>Common labels: <span class="o">{</span><span class="nv">app</span><span class="o">=</span><span class="s2">&quot;cli&quot;</span>, <span class="nv">hostname</span><span class="o">=</span><span class="s2">&quot;loki&quot;</span>, <span class="nv">job</span><span class="o">=</span><span class="s2">&quot;stdin&quot;</span><span class="o">}</span>
</span><span class='line'>2020-11-11T12:45:20+02:00 <span class="o">{}</span> this is a <span class="nb">test</span>
</span><span class='line'>http://localhost:3100/loki/api/v1/query_range?direction<span class="o">=</span>BACKWARD<span class="p">&amp;</span><span class="nv">end</span><span class="o">=</span>1605091520778438972<span class="p">&amp;</span><span class="nv">limit</span><span class="o">=</span>30<span class="p">&amp;</span><span class="nv">query</span><span class="o">=</span>%7Bapp%3D%22cli%22%7D<span class="p">&amp;</span><span class="nv">start</span><span class="o">=</span>1605088455756745122
</span><span class='line'>Common labels: <span class="o">{</span><span class="nv">app</span><span class="o">=</span><span class="s2">&quot;cli&quot;</span>, <span class="nv">hostname</span><span class="o">=</span><span class="s2">&quot;loki&quot;</span>, <span class="nv">job</span><span class="o">=</span><span class="s2">&quot;stdin&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can pipe some more output to Loki:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;this is another test&quot;</span> <span class="p">|</span> promtail --stdin --client.url http://localhost:3100/loki/api/v1/push --client.external-labels<span class="o">=</span><span class="nv">app</span><span class="o">=</span>cli -server.disable
</span></code></pre></td></tr></table></div></figure>


<p>And querying our logs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --quiet --output raw query <span class="s1">&#39;{app=&quot;cli&quot;}&#39;</span>
</span><span class='line'>this is another <span class="nb">test</span>
</span><span class='line'>this is a <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing Loki Outside our VM</h2>

<p>Let&rsquo;s exit the VM and test Loki from our local workstation, first you will need to get the logcli for your OS, head over to the <a href="https://github.com/grafana/loki/releases">releases</a> page and get the binary of your choice.</p>

<p>I will be demonstrating using a mac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/grafana/loki/releases/download/v2.0.0/logcli-darwin-amd64.zip
</span><span class='line'><span class="nv">$ </span>unzip logcli-darwin-amd64.zip
</span><span class='line'><span class="nv">$ </span>sudo mv logcli-darwin-amd64 /usr/local/bin/logcli
</span><span class='line'><span class="nv">$ </span>rm -f logcli-darwin-amd64.zip
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to tell logcli where our Loki server resides, so let&rsquo;s get the IP address of Loki:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass info --all --format json <span class="p">|</span> jq -r <span class="s1">&#39;.info.loki.ipv4[]&#39;</span>
</span><span class='line'>192.168.64.19
</span></code></pre></td></tr></table></div></figure>


<p>We can either set the Loki host as an environment variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">LOKI_ADDR</span><span class="o">=</span>http://192.168.64.19
</span></code></pre></td></tr></table></div></figure>


<p>or you can specify it using the <code>--addr</code> argument:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --addr<span class="o">=</span><span class="s2">&quot;http://192.168.64.19:3100&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For the sake of simplicity and not having to type the <code>--addr</code> the whole time, I will be setting the Loki address as an environment variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">LOKI_ADDR</span><span class="o">=</span><span class="s2">&quot;http://$(multipass info --all --format json | jq -r &#39;.info.loki.ipv4[]&#39;):3100&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And when we inspect our labels using logcli, we can see that we are getting our labels from Loki on our Multipass VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli labels
</span><span class='line'>http://192.168.64.19:3100/loki/api/v1/labels?end<span class="o">=</span>1605093229877731000<span class="p">&amp;</span><span class="nv">start</span><span class="o">=</span>1605089629877731000
</span><span class='line'>__name__
</span><span class='line'>app
</span><span class='line'>hostname
</span><span class='line'>job
</span></code></pre></td></tr></table></div></figure>


<h2>Write Logs to Loki using the Loki Docker Driver</h2>

<p>We have used promtail before to pipe logs to Loki and in this example we will be making use of the Loki Docker Logging Plugin to write data to Loki.</p>

<p>If you have docker installed, install the Loki plugin:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker plugin install <span class="se">\</span>
</span><span class='line'>  grafana/loki-docker-driver:latest <span class="se">\</span>
</span><span class='line'>  --alias loki <span class="se">\</span>
</span><span class='line'>  --grant-all-permissions
</span></code></pre></td></tr></table></div></figure>


<p>Now we will use a docker container to echo stdout to the loki docker driver, which will send the output to Loki.</p>

<p>Let&rsquo;s alias a command loki_echo that we will use to send our output to the docker container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">alias</span> <span class="s1">&#39;loki_echo=docker run --rm -it --log-driver loki --log-opt loki-url=&quot;http://192.168.64.19:3100/loki/api/v1/push&quot; --log-opt loki-external-labels=&quot;app=echo-container&quot; busybox echo&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So every time we run <code>loki_echo {string}</code> we will run a docker container from the busybox image and pass the <code>{string}</code> as an argument to the echo command inside the container, which will be sent to the loki log driver and land up in Loki.</p>

<p>Let&rsquo;s push 100 log events to Loki:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ count</span><span class="o">=</span>0
</span><span class='line'><span class="nv">$ </span><span class="k">while</span> <span class="o">[</span> <span class="k">${</span><span class="nv">count</span><span class="k">}</span> !<span class="o">=</span> <span class="m">100</span> <span class="o">]</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>    <span class="k">for</span> color in red blue white silver green<span class="p">;</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'>      loki_echo <span class="s2">&quot;there are ${RANDOM} items of ${color} available&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="nv">count</span><span class="o">=</span><span class="k">$((</span>count+1<span class="k">))</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'>
</span><span class='line'>there are <span class="m">26890</span> items of green available
</span><span class='line'>there are <span class="m">14856</span> items of red available
</span><span class='line'>there are <span class="m">31162</span> items of blue available
</span><span class='line'>there are <span class="m">23993</span> items of white available
</span><span class='line'>there are <span class="m">22310</span> items of silver available
</span><span class='line'>there are <span class="m">10700</span> items of green available
</span><span class='line'>there are <span class="m">14077</span> items of red available
</span><span class='line'>there are <span class="m">20642</span> items of blue available
</span><span class='line'>there are <span class="m">31576</span> items of white available
</span><span class='line'>there are <span class="m">26053</span> items of silver available
</span><span class='line'>there are <span class="m">2973</span> items of green available
</span><span class='line'>there are <span class="m">2203</span> items of red available
</span><span class='line'>there are <span class="m">8557</span> items of blue available
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>We can verify how many log events we have with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli query <span class="s1">&#39;{app=&quot;echo-container&quot;}&#39;</span> --quiet --limit <span class="m">200</span> --output raw <span class="p">|</span> wc -l
</span><span class='line'>100
</span></code></pre></td></tr></table></div></figure>


<p>To see how many logs we have with the line &ldquo;blue&rdquo; in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli query <span class="s1">&#39;{app=&quot;echo-container&quot;} |= &quot;blue&quot;&#39;</span> --quiet --limit <span class="m">200</span> --output raw <span class="p">|</span> wc -l
</span><span class='line'>20
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s look for logs with blue or green and limit the results to 5:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli query <span class="s1">&#39;{app=&quot;echo-container&quot;} |~ &quot;items of (blue|green)&quot;&#39;</span> --quiet --limit <span class="m">5</span> --output raw
</span><span class='line'>there are <span class="m">28985</span> items of green available
</span><span class='line'>there are <span class="m">10289</span> items of blue available
</span><span class='line'>there are <span class="m">12316</span> items of green available
</span><span class='line'>there are <span class="m">23775</span> items of blue available
</span><span class='line'>there are <span class="m">20</span> items of green available
</span></code></pre></td></tr></table></div></figure>


<h2>Teardown</h2>

<p>If you followed along, you can terminate your Multipass VM with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass delete --purge loki
</span></code></pre></td></tr></table></div></figure>


<p>You can get the example code in my <strong><a href="https://github.com/ruanbekker/multipassfiles/tree/master/loki">multipassfiles github repository</a></strong></p>

<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>

<section>
  <h1>Donations</h1>
  If you find my content useful, I always appreciate coffee
  <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script>
  <script type='text/javascript'>kofiwidget2.init('Support Me on Ko-fi', '#29abe0', 'A6423ZIQ');kofiwidget2.draw();</script>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/02/20/create-dns-records-with-terraform-on-cloudflare/">Create DNS Records With Terraform on Cloudflare</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/12/05/blockchain-basics/">Blockchain Basics</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/12/05/run-a-geth-ethereum-light-node/">Run a GETH Ethereum Light Node</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/11/23/run-docker-containers-with-terraform/">Run Docker Containers With Terraform</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/11/03/setup-traefik-version-2-on-docker/">Setup Traefik Version 2 on Docker</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest cheatsheets in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com"><img src="https://user-images.githubusercontent.com/567298/97010485-c2334a00-1545-11eb-9e1d-2333e5148da1.png" width="290" height="900"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ruanbekker" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
