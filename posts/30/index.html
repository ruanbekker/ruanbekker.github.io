
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="Creating a Docker Swarm Cluster, locally on your Workstation using Docker in Docker (DID) for testing Purposes: Project Resources: Docker in Docker &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/posts/30/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
<script>
(function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
})(document, window, '//fh-blog-ruanbekker-com.home.ruan.dev/tracker.js', 'fathom');
fathom('set', 'siteId', 'MWBHH');
fathom('trackPageview');
</script>
<!-- / Fathom -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/07/how-to-create-a-local-docker-swarm-cluster-with-docker-in-docker-on-your-workstation/">How to Create a Local Docker Swarm Cluster With Docker in Docker on Your Workstation</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-07T04:03:37-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>4:03 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Creating a Docker Swarm Cluster, locally on your Workstation using Docker in Docker (DID) for testing Purposes:</p>

<h2>Project Resources:</h2>

<ul>
<li><a href="https://hub.docker.com/_/docker/">Docker in Docker</a></li>
<li><a href="https://docs.traefik.io/">Traefik</a></li>
</ul>


<h2>Create The Nodes:</h2>

<p>Create the Docker containers that will act as our Docker nodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run --privileged --name docker-node1 -v /Users/ruan/docker/did/vols/node1:/var/lib/docker -d docker:dind --storage-driver<span class="o">=</span>vfs
</span><span class='line'><span class="nv">$ </span>docker run --privileged --name docker-node2 -v /Users/ruan/docker/did/vols/node2:/var/lib/docker -d docker:dind --storage-driver<span class="o">=</span>vfs
</span><span class='line'><span class="nv">$ </span>docker run --privileged --name docker-node3 -v /Users/ruan/docker/did/vols/node3:/var/lib/docker -d docker:dind --storage-driver<span class="o">=</span>vfs
</span></code></pre></td></tr></table></div></figure>


<h2>Initialize the Swarm:</h2>

<p>Log onto the manager node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it docker-node1 sh
</span></code></pre></td></tr></table></div></figure>


<p>Initialize the Swarm:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker swarm init --advertise-addr eth0
</span><span class='line'>Swarm initialized: current node <span class="o">(</span>17ydtkqdwxzwea2riadxj4zbw<span class="o">)</span> is now a manager.
</span><span class='line'>
</span><span class='line'>To add a worker to this swarm, run the following <span class="nb">command</span>:
</span><span class='line'>
</span><span class='line'>    docker swarm join --token SWMTKN-1-4goolm8dvwictc7d39aonpcv6ca1pfj31q7irjga17o2srzf6f-b4k3hln6ogvjgmnbs1qxnjvj9 172.17.0.2:2377
</span><span class='line'>
</span><span class='line'>To add a manager to this swarm, run <span class="s1">&#39;docker swarm join-token manager&#39;</span> and follow the instructions.
</span></code></pre></td></tr></table></div></figure>


<p>Join the Worker Nodes to the Swarm:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it docker-node2 sh
</span><span class='line'>/ <span class="c"># docker swarm join --token SWMTKN-1-4mvb68vefr3dogxr6omu3uq04r4gddftdbmfomxo9pefks9siu-3t7ua7k2xigl9rwgp4dwzcxm0 172.17.0.2:2377</span>
</span><span class='line'>This node joined a swarm as a worker.
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it docker-node3 sh
</span><span class='line'>/ <span class="c"># docker swarm join --token SWMTKN-1-4mvb68vefr3dogxr6omu3uq04r4gddftdbmfomxo9pefks9siu-3t7ua7k2xigl9rwgp4dwzcxm0 172.17.0.2:2377</span>
</span><span class='line'>This node joined a swarm as a worker.
</span></code></pre></td></tr></table></div></figure>


<h2>List the Nodes:</h2>

<p>Log onto the Manager node and list the nodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it docker-node1 sh
</span><span class='line'>/ <span class="c"># docker node ls</span>
</span><span class='line'>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS
</span><span class='line'>1hnq4b4w87w6trobwye5ap4sh *   5657c28bf618        Ready               Active              Leader
</span><span class='line'>wglbb029g1kczttiaf5r6iavi     b2924bb8e555        Ready               Active
</span><span class='line'>xxr9kdqy49u2tx61w31ife90j     6622a06a1b3c        Ready               Active
</span></code></pre></td></tr></table></div></figure>


<h2>Traefik:</h2>

<p>Creating a HTTP Reverse Proxy, using Traefik:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create --driver overlay traefik-net
</span><span class='line'><span class="nv">$ </span>docker service create <span class="se">\</span>
</span><span class='line'>--name traefik <span class="se">\</span>
</span><span class='line'>--constraint <span class="s1">&#39;node.role==manager&#39;</span> <span class="se">\</span>
</span><span class='line'>--publish 80:80 <span class="se">\</span>
</span><span class='line'>--publish 8080:8080 <span class="se">\</span>
</span><span class='line'>--mount <span class="nb">type</span><span class="o">=</span><span class="nb">bind</span>,source<span class="o">=</span>/var/run/docker.sock,target<span class="o">=</span>/var/run/docker.sock <span class="se">\</span>
</span><span class='line'>--network traefik-net <span class="se">\</span>
</span><span class='line'>traefik:camembert --docker --docker.swarmmode --docker.domain<span class="o">=</span>ruanbekker.internal --docker.watch --logLevel<span class="o">=</span>DEBUG --web
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/04/getting-started-with-chef-creating-a-website-with-apache/">Getting Started With Chef: Creating a Website With Apache</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-04T14:21:20-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:21 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>From my previous post we got started with <a href="http://blog.ruanbekker.com/blog/2017/09/04/getting-started-with-chef-working-with-files/">Installing the Chef Devlopment Kit</a> and using the file resource type.</p>

<p>In this post we will create a recipe that will:</p>

<ul>
<li>Update the APT Cache</li>
<li>Install the Apache2 package</li>
<li>Enables and Starts Apache2 on Boot</li>
<li>Create a index.html for our Website</li>
</ul>


<h2>Creating a Web Server:</h2>

<p>We will create our <code>webserver.rb</code> recipe, and our first section will consist of the following:</p>

<ul>
<li>Ensuring our APT Cache is up to date</li>
<li>The Frequency property indiciates 24 hours</li>
<li>The periodic action indicates that the update occurs periodically</li>
<li>Optional: the <code>:update</code> action will update the apt cache on each run</li>
<li>Installs the apache2 package (No action is specified, defaults to <code>:install</code>)</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">apt_update</span> <span class="s1">&#39;Update APT Cache Daily&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">frequency</span> <span class="mi">86_400</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:periodic</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">package</span> <span class="s1">&#39;apache2&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this recipe at this moment will provide the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chef-client --local-mode webserver.rb
</span><span class='line'>..
</span><span class='line'>Converging <span class="m">2</span> resources
</span><span class='line'>Recipe: @recipe_files::/root/chef-repo/webserver.rb
</span><span class='line'>  * apt_update<span class="o">[</span>Update APT Cache Daily<span class="o">]</span> action periodic
</span><span class='line'>    - update new lists of packages
</span><span class='line'>    * directory<span class="o">[</span>/var/lib/apt/periodic<span class="o">]</span> action create <span class="o">(</span>up to date<span class="o">)</span>
</span><span class='line'>    * directory<span class="o">[</span>/etc/apt/apt.conf.d<span class="o">]</span> action create <span class="o">(</span>up to date<span class="o">)</span>
</span><span class='line'>    * file<span class="o">[</span>/etc/apt/apt.conf.d/15update-stamp<span class="o">]</span> action create_if_missing
</span><span class='line'>      - create new file /etc/apt/apt.conf.d/15update-stamp
</span><span class='line'>      - update content in file /etc/apt/apt.conf.d/15update-stamp from none to 174cdb
</span><span class='line'>      --- /etc/apt/apt.conf.d/15update-stamp    2017-09-04 16:53:31.604488306 +0000
</span><span class='line'>      +++ /etc/apt/apt.conf.d/.chef-15update-stamp20170904-5727-1p2g8zw 2017-09-04 16:53:31.604488306 +0000
</span><span class='line'>      @@ -1 +1,2 @@
</span><span class='line'>      +APT::Update::Post-Invoke-Success <span class="o">{</span><span class="s2">&quot;touch /var/lib/apt/periodic/update-success-stamp 2&gt;/dev/null || true&quot;</span><span class="p">;</span><span class="o">}</span><span class="p">;</span>
</span><span class='line'>    * execute<span class="o">[</span>apt-get -q update<span class="o">]</span> action run
</span><span class='line'>      - execute apt-get -q update
</span></code></pre></td></tr></table></div></figure>


<p>Next, we will set <code>apache2</code> to start on boot and start the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">apt_update</span> <span class="s1">&#39;Update APT Cache Daily&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">frequency</span> <span class="mi">86_400</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:periodic</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">package</span> <span class="s1">&#39;apache2&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="s1">&#39;apache2&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">supports</span> <span class="ss">status</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">action</span> <span class="o">[</span><span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running our chef client, will produce the following output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chef-client --local-mode webserver.rb
</span><span class='line'>Converging <span class="m">3</span> resources
</span><span class='line'>Recipe: @recipe_files::/root/chef-repo/webserver.rb
</span><span class='line'>  * apt_update<span class="o">[</span>Update APT Cache Daily<span class="o">]</span> action periodic <span class="o">(</span>up to date<span class="o">)</span>
</span><span class='line'>  * apt_package<span class="o">[</span>apache2<span class="o">]</span> action install <span class="o">(</span>up to date<span class="o">)</span>
</span><span class='line'>  * service<span class="o">[</span>apache2<span class="o">]</span> action <span class="nb">enable</span> <span class="o">(</span>up to date<span class="o">)</span>
</span><span class='line'>  * service<span class="o">[</span>apache2<span class="o">]</span> action start
</span><span class='line'>    - start service service<span class="o">[</span>apache2<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verifying that our apache2 service is started:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/etc/init.d/apache2 status
</span><span class='line'> * apache2 is running
</span></code></pre></td></tr></table></div></figure>


<p>Next, using the file resource, we will replace the `/var/www/html/index.html' landing page with the one that we will specify in our recipe:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">apt_update</span> <span class="s1">&#39;Update APT Cache Daily&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">frequency</span> <span class="mi">86_400</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:periodic</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">package</span> <span class="s1">&#39;apache2&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="s1">&#39;apache2&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">supports</span> <span class="ss">status</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">action</span> <span class="o">[</span><span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">file</span> <span class="s1">&#39;/var/www/html/index.html&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="s1">&#39;&lt;html&gt;</span>
</span><span class='line'><span class="s1">  &lt;body&gt;</span>
</span><span class='line'><span class="s1">    &lt;h1&gt;Hello, World!&lt;/h1&gt;</span>
</span><span class='line'><span class="s1">  &lt;/body&gt;</span>
</span><span class='line'><span class="s1">&lt;/html&gt;&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And our full <code>webserver.rb</code> recipe will look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># update cache periodically every 24 hours</span>
</span><span class='line'><span class="n">apt_update</span> <span class="s1">&#39;Update APT Cache Daily&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">frequency</span> <span class="mi">86_400</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:periodic</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># install apache2 (:install is the default action)</span>
</span><span class='line'><span class="n">package</span> <span class="s1">&#39;apache2&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># enable apache2 on boot and start apache2</span>
</span><span class='line'><span class="n">service</span> <span class="s1">&#39;apache2&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">supports</span> <span class="ss">status</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">action</span> <span class="o">[</span><span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># create a custom html page</span>
</span><span class='line'><span class="n">file</span> <span class="s1">&#39;/var/www/html/index.html&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="s1">&#39;&lt;html&gt;</span>
</span><span class='line'><span class="s1">  &lt;body&gt;</span>
</span><span class='line'><span class="s1">    &lt;h1&gt;Hello, World!&lt;/h1&gt;</span>
</span><span class='line'><span class="s1">  &lt;/body&gt;</span>
</span><span class='line'><span class="s1">&lt;/html&gt;&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Running our Chef Client against our Recipe:</h2>

<p>For the previous snippets, we took it section by section, here we will run the whole recipe:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chef-client --local-mode webserver.rb
</span><span class='line'>...
</span><span class='line'>Converging <span class="m">4</span> resources
</span><span class='line'>Recipe: @recipe_files::/root/chef-repo/webserver.rb
</span><span class='line'>  * apt_update<span class="o">[</span>Update APT Cache Daily<span class="o">]</span> action periodic <span class="o">(</span>up to date<span class="o">)</span>
</span><span class='line'>  * apt_package<span class="o">[</span>apache2<span class="o">]</span> action install <span class="o">(</span>up to date<span class="o">)</span>
</span><span class='line'>  * service<span class="o">[</span>apache2<span class="o">]</span> action <span class="nb">enable</span> <span class="o">(</span>up to date<span class="o">)</span>
</span><span class='line'>  * service<span class="o">[</span>apache2<span class="o">]</span> action start <span class="o">(</span>up to date<span class="o">)</span>
</span><span class='line'>  * file<span class="o">[</span>/var/www/html/index.html<span class="o">]</span> action create
</span><span class='line'>    - update content in file /var/www/html/index.html from 538f31 to 9d1dca
</span><span class='line'>    --- /var/www/html/index.html        2017-09-04 16:53:55.134043652 +0000
</span><span class='line'>    +++ /var/www/html/.chef-index20170904-7451-3kt1p7.html      2017-09-04 17:00:16.306831840 +0000
</span></code></pre></td></tr></table></div></figure>


<h2>Testing our Website:</h2>

<p>And finally, testing our website:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://localhost/
</span><span class='line'>&lt;html&gt;
</span><span class='line'>  &lt;body&gt;
</span><span class='line'>    &lt;h1&gt;Hello, World!&lt;/h1&gt;
</span><span class='line'>  &lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://docs.chef.io/resource_file.html">https://docs.chef.io/resource_file.html</a></li>
<li><a href="https://docs.chef.io/recipes.html">https://docs.chef.io/recipes.html</a></li>
<li><a href="https://learn.chef.io">https://learn.chef.io</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/04/getting-started-with-chef-working-with-files/">Getting Started With Chef: Working With Files</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-04T14:06:01-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:06 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Chef: Infrastructure as Code, Automation, Configuration Management, having a service that can do that, and especially having something in place that knows what the desired state of your configurations/applications should be is definitely a plus.</p>

<p>I stumbled upon <a href="https://learn.chef.io">learn.chef.io</a> which is a great resource for learning chef, as I am learning Chef at this moment.</p>

<p>The Components of Chef consists of:</p>

<ul>
<li>Chef Workstation (ChefDK enables you to use the tools locally to test before pushing your code to the Chef Server)</li>
<li>Chef Server (Central Repository for your Cookbooks and info of every node Chef Manages)</li>
<li>Chef Client (a Node that is Managed by the Chef Server)</li>
</ul>


<p>In this post we will install the Chef Development Kit, and work with the chef-client in local-mode to create, update and delete files using the <code>file</code> resource type.</p>

<h2>Getting Started with Chef: Installation:</h2>

<p>Installing the Chef Development Kit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-get update <span class="o">&amp;&amp;</span> apt-get upgrade -y
</span><span class='line'><span class="nv">$ </span>sudo apt-get install curl git -y
</span><span class='line'><span class="nv">$ </span>curl https://omnitruck.chef.io/install.sh <span class="p">|</span> sudo bash -s -- -P chefdk -c stable -v 2.0.28
</span></code></pre></td></tr></table></div></figure>


<h2>Configure a Resource:</h2>

<p>Using <code>chef-client</code> in local mode, we will use the <code>resource: file</code> to create a recipe that will create our <code>motd</code> file</p>

<figure class='code'><figcaption><span>hello.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">file</span> <span class="s1">&#39;/tmp/motd&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="s1">&#39;hello world&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running chef client against our recipe in local-mode:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chef-client --local-mode hello.rb
</span><span class='line'>..
</span><span class='line'>Converging <span class="m">1</span> resources
</span><span class='line'>Recipe: @recipe_files::/root/chef-repo/hello.rb
</span><span class='line'>  * file<span class="o">[</span>/tmp/motd<span class="o">]</span> action create
</span><span class='line'>    - create new file /tmp/motd
</span><span class='line'>    - update content in file /tmp/motd from none to b94d27
</span><span class='line'>    --- /tmp/motd       2017-09-04 16:18:19.265699403 +0000
</span><span class='line'>    +++ /tmp/.chef-motd20170904-4500-54fh8w     2017-09-04 16:18:19.265699403 +0000
</span><span class='line'>    @@ -1 +1,2 @@
</span><span class='line'>    +hello world
</span></code></pre></td></tr></table></div></figure>


<p>Verify the Content:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /tmp/motd
</span><span class='line'>hello world
</span></code></pre></td></tr></table></div></figure>


<p>Running the command again will do nothing, as the content is in its desired state:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chef-client --local-mode hello.rb
</span><span class='line'>..
</span><span class='line'>Converging <span class="m">1</span> resources
</span><span class='line'>Recipe: @recipe_files::/root/chef-repo/hello.rb
</span><span class='line'>  * file<span class="o">[</span>/tmp/motd<span class="o">]</span> action create <span class="o">(</span>up to date<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Changing our recipe by replacing the word <code>world</code> with <code>chef</code>, we will find that the content of our file will be updated:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chef-client --local-mode hello.rb
</span><span class='line'>..
</span><span class='line'>Converging <span class="m">1</span> resources
</span><span class='line'>Recipe: @recipe_files::/root/chef-repo/hello.rb
</span><span class='line'>  * file<span class="o">[</span>/tmp/motd<span class="o">]</span> action create
</span><span class='line'>    - update content in file /tmp/motd from b94d27 to c38c60
</span><span class='line'>    --- /tmp/motd       2017-09-04 16:18:19.265699403 +0000
</span><span class='line'>    +++ /tmp/.chef-motd20170904-4903-wuigr      2017-09-04 16:23:21.379649145 +0000
</span><span class='line'>    @@ -1,2 +1,2 @@
</span><span class='line'>    -hello world
</span><span class='line'>    +hello chef
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s overwrite the content of our <code>motd</code> file manually:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;hello robots&#39;</span> &gt; /tmp/motd
</span></code></pre></td></tr></table></div></figure>


<p>Running Chef Client against our recipe again, allows Chef to restore our content to the desired state that is specified in our recipe:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chef-client --local-mode hello.rb
</span><span class='line'>..
</span><span class='line'>Converging <span class="m">1</span> resources
</span><span class='line'>Recipe: @recipe_files::/root/chef-repo/hello.rb
</span><span class='line'>  * file<span class="o">[</span>/tmp/motd<span class="o">]</span> action create
</span><span class='line'>    - update content in file /tmp/motd from <span class="m">548078</span> to c38c60
</span><span class='line'>    --- /tmp/motd       2017-09-04 16:24:29.308286834 +0000
</span><span class='line'>    +++ /tmp/.chef-motd20170904-5103-z16ssa     2017-09-04 16:24:42.528021632 +0000
</span><span class='line'>    @@ -1,2 +1,2 @@
</span><span class='line'>    -hello robots
</span><span class='line'>    +hello chef
</span></code></pre></td></tr></table></div></figure>


<p>Deleting a file from our recipe:</p>

<figure class='code'><figcaption><span>destroy.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">file</span> <span class="s1">&#39;/tmp/motd&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:delete</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now using chef client to execute against this file will remove our file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chef-client --local-mode destroy.rb
</span><span class='line'>Recipe: @recipe_files::/root/chef-repo/destroy.rb
</span><span class='line'>  * file<span class="o">[</span>/tmp/motd<span class="o">]</span> action delete
</span><span class='line'>    - delete file /tmp/motd
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://docs.chef.io/resource_file.html">https://docs.chef.io/resource_file.html</a></li>
<li><a href="https://docs.chef.io/recipes.html">https://docs.chef.io/recipes.html</a></li>
<li><a href="https://learn.chef.io">https://learn.chef.io</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/04/splitting-characters-with-python-to-determine-name-surname-and-email-address/">Splitting Characters With Python to Determine Name Surname and Email Address</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-04T09:22:42-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>9:22 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I had a bunch of email addresses that was set in a specific format that I can strip characters from, to build up a Username, Name and Surname from the Email Address, that I could use to for dynamic reporting.</p>

<h2>Using Split in Python</h2>

<p>Here I will define the value of <code>emailadress</code> to a string, then using Python&rsquo;s <code>split()</code> function to get the values that I want:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">emailaddress</span> <span class="o">=</span> <span class="s">&quot;ruan.bekker@domain.com&quot;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">emailaddress</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;@&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="s">&#39;ruan.bekker&#39;</span><span class="p">,</span> <span class="s">&#39;domain.com&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">username</span> <span class="o">=</span> <span class="n">emailaddress</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;@&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">username</span>
</span><span class='line'><span class="s">&#39;ruan.bekker&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">username</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="s">&#39;ruan&#39;</span><span class="p">,</span> <span class="s">&#39;bekker&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">name</span> <span class="o">=</span> <span class="n">username</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">surname</span> <span class="o">=</span> <span class="n">username</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">name</span>
</span><span class='line'><span class="s">&#39;Ruan&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">surname</span>
</span><span class='line'><span class="s">&#39;Bekker&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">username</span>
</span><span class='line'><span class="s">&#39;ruan.bekker&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">emailaddress</span>
</span><span class='line'><span class="s">&#39;ruan.bekker@domain.com&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Print The Values in Question:</h2>

<p>Now that we have define our keys, let&rsquo;s print the values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;Name: {0}, Surname: {1}, UserName: {2}, Email Address: {3}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">surname</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">emailaddress</span><span class="p">))</span>
</span><span class='line'><span class="n">Name</span><span class="p">:</span> <span class="n">Ruan</span><span class="p">,</span> <span class="n">Surname</span><span class="p">:</span> <span class="n">Bekker</span><span class="p">,</span> <span class="n">UserName</span><span class="p">:</span> <span class="n">ruan</span><span class="o">.</span><span class="n">bekker</span><span class="p">,</span> <span class="n">Email</span> <span class="n">Address</span><span class="p">:</span> <span class="n">ruan</span><span class="o">.</span><span class="n">bekker</span><span class="nd">@domain.com</span>
</span></code></pre></td></tr></table></div></figure>


<p>From here on you can build up for example an email function that you can pass the values to your function to get a specific job done.</p>

<h2>Update: Capitalize from One String</h2>

<p>Today, I had to capitalize the name and surname that was linked to one variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="s">&#39;james.bond&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">username</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)]))</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span class='line'><span class="n">James</span> <span class="n">Bond</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/02/setup-a-3-node-mongodb-replica-set-on-ubuntu-16/">Setup a 3 Node MongoDB Replica Set on Ubuntu 16</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-09-02T19:29:10-04:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>7:29 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today we will setup a 3 Node Replica Set for MongoDB on Ubuntu 16. A Replica Set is a form of data replication, so that your data resides on more than one node for data durability. We will setup the 1st node as the primary node, the second as the secondary node and the 3rd node will act as an arbiter.</p>

<p>The arbiter node can almost be mentioned as a voter node, as it will be set in place to prevent split brain.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://eladnava.com/deploy-a-highly-available-mongodb-replica-set-on-aws/">https://eladnava.com/deploy-a-highly-available-mongodb-replica-set-on-aws/</a></li>
<li><a href="https://stackoverflow.com/questions/38524150/mongodb-replica-set-with-simple-password-authentication">https://stackoverflow.com/questions/38524150/mongodb-replica-set-with-simple-password-authentication</a> (auth)</li>
<li><a href="https://stackoverflow.com/questions/14789622/mongodb-keyfile-too-open-permissions">https://stackoverflow.com/questions/14789622/mongodb-keyfile-too-open-permissions</a></li>
</ul>


<h2>Installing MongoDB on our 3 Nodes:</h2>

<p>Our case, using Ubuntu 16.04, setting up our repository and installing mongodb from our repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse&quot;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/mongodb-org-3.4.list
</span><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>apt install -y mongodb-org -y
</span></code></pre></td></tr></table></div></figure>


<p>Preparing our Directories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /srv/mongodb/rs0-0 /srv/mongodb/rs0-1 /srv/mongodb/rs0-2
</span><span class='line'><span class="nv">$ </span>mkdir -p /var/log/mongodb/rs0-0 /var/log/mongodb/rs0-1 /var/log/mongodb/rs0-2
</span></code></pre></td></tr></table></div></figure>


<p>Populating our MongoDB Configuration:</p>

<ul>
<li>MongoDB Prefers XFS File Systems when using WiredTiger.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; /etc/mongod.conf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">storage:</span>
</span><span class='line'><span class="s">  dbPath: /var/lib/mongodb</span>
</span><span class='line'><span class="s">  journal:</span>
</span><span class='line'><span class="s">    enabled: false</span>
</span><span class='line'>
</span><span class='line'><span class="s">storage:</span>
</span><span class='line'><span class="s">  mmapv1:</span>
</span><span class='line'><span class="s">    smallFiles: true</span>
</span><span class='line'>
</span><span class='line'><span class="s">systemLog:</span>
</span><span class='line'><span class="s">  destination: file</span>
</span><span class='line'><span class="s">  logAppend: true</span>
</span><span class='line'><span class="s">  path: /var/log/mongodb/mongod.log</span>
</span><span class='line'>
</span><span class='line'><span class="s">net:</span>
</span><span class='line'><span class="s">  port: 27017</span>
</span><span class='line'><span class="s">  bindIp: 0.0.0.0</span>
</span><span class='line'>
</span><span class='line'><span class="s">replication:</span>
</span><span class='line'><span class="s">  replSetName: rs0</span>
</span><span class='line'>
</span><span class='line'><span class="s">security:</span>
</span><span class='line'><span class="s">  authorization: enabled</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Enable MongoDB On Startup and Start MongoDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>mongod
</span><span class='line'><span class="nv">$ </span>systemctl restart mongod
</span></code></pre></td></tr></table></div></figure>


<h2>Setup MongoDB Replica Sets:</h2>

<p>In our setup we will have 3 nodes: (mongodb-1, mongodb-2, mongodb3) From our Primary Node, connect to MongoDB and inititalize our replica set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mongo
</span><span class='line'>MongoDB shell version v3.4.7
</span><span class='line'>connecting to: mongodb://127.0.0.1:27017
</span><span class='line'>MongoDB server version: 3.4.7
</span><span class='line'>&gt; rs.initiate<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;info2&quot;</span> : <span class="s2">&quot;no configuration specified. Using a default configuration for the set&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;me&quot;</span> : <span class="s2">&quot;mysql-1:27017&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;ok&quot;</span> : 1
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, add our 2 other MongoDB Nodes, remember <code>mongodb-3</code> is our arbiter node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:SECONDARY&gt; rs.add<span class="o">(</span><span class="s2">&quot;mongodb-2&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;ok&quot;</span> : <span class="m">1</span> <span class="o">}</span>
</span><span class='line'>rs0:PRIMARY&gt; rs.add<span class="o">(</span><span class="s2">&quot;mongodb-3&quot;</span>, <span class="nb">true</span><span class="o">)</span>
</span><span class='line'><span class="o">{</span> <span class="s2">&quot;ok&quot;</span> : <span class="m">1</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify the Replica Set Status:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; rs.status<span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;set&quot;</span> <span class="p">:</span> <span class="s2">&quot;rs0&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;date&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:42.469Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;myState&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;term&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;heartbeatIntervalMillis&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">2000</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;optimes&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;lastCommittedOpTime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">0</span><span class="p">,</span> <span class="err">0),</span>
</span><span class='line'>                        <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">-1</span><span class="err">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;appliedOpTime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839853</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="nt">&quot;durableOpTime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839722</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">-1</span><span class="err">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;members&quot;</span> <span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;mysql-1:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;health&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;stateStr&quot;</span> <span class="p">:</span> <span class="s2">&quot;PRIMARY&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uptime&quot;</span> <span class="p">:</span> <span class="mi">422</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839853</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:33Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;electionTime&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839723</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                        <span class="nt">&quot;electionDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:15:23Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;configVersion&quot;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;self&quot;</span> <span class="p">:</span> <span class="kc">true</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;mongodb-2:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;health&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;stateStr&quot;</span> <span class="p">:</span> <span class="s2">&quot;SECONDARY&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uptime&quot;</span> <span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optime&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">1503839853</span><span class="p">,</span> <span class="err">1),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDurable&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                                <span class="nt">&quot;ts&quot;</span> <span class="p">:</span> <span class="err">Timestamp(</span><span class="mi">0</span><span class="p">,</span> <span class="err">0),</span>
</span><span class='line'>                                <span class="nt">&quot;t&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">-1</span><span class="err">)</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:33Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;optimeDurableDate&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;1970-01-01T00:00:00Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeat&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:41.707Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeatRecv&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:40.699Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;pingMs&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">4</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;syncingTo&quot;</span> <span class="p">:</span> <span class="s2">&quot;mysql-1:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;configVersion&quot;</span> <span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;mongodb-3:27017&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;health&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;state&quot;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;stateStr&quot;</span> <span class="p">:</span> <span class="s2">&quot;ARBITER&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;uptime&quot;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeat&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:41.721Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;lastHeartbeatRecv&quot;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&quot;2017-08-27T13:17:38.749Z&quot;</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;pingMs&quot;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">2</span><span class="err">)</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;configVersion&quot;</span> <span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;ok&quot;</span> <span class="p">:</span> <span class="mi">1</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">rs</span><span class="mi">0</span><span class="err">:PRIMARY&gt;</span> <span class="err">exit</span>
</span><span class='line'><span class="err">bye</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setup Auth:</h2>

<p>Setup Authentication on our MongoDB Database, we will create the user <code>adminuser</code> and setup the password to <code>secret</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rs0:PRIMARY&gt; use admin
</span><span class='line'>switched to db admin
</span><span class='line'>
</span><span class='line'>rs0:PRIMARY&gt; db.createUser<span class="o">({</span>user: <span class="s2">&quot;adminuser&quot;</span>, <span class="nb">pwd</span>: <span class="s2">&quot;secret&quot;</span>, roles:<span class="o">[{</span>role: <span class="s2">&quot;root&quot;</span>, db: <span class="s2">&quot;admin&quot;</span><span class="o">}]})</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">Successfully</span> <span class="err">added</span> <span class="err">user:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;user&quot;</span> <span class="p">:</span> <span class="s2">&quot;adminuser&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;roles&quot;</span> <span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                        <span class="nt">&quot;role&quot;</span> <span class="p">:</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nt">&quot;db&quot;</span> <span class="p">:</span> <span class="s2">&quot;admin&quot;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">rs</span><span class="mi">0</span><span class="err">:PRIMARY&gt;</span> <span class="err">exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>Restart MongoDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl restart mongod
</span></code></pre></td></tr></table></div></figure>


<h2>Connect and Authenticate against MongoDB:</h2>

<p>Connect to your MongoDB Cluster with auth:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mongo --host mongodb.example.com --port <span class="m">27017</span> -u &lt;username&gt; -p --authenticationDatabase admin
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/31/setup-haproxy-load-balancer-for-mysql-galera-with-ip-whitelisting-and-backup-servers/">Setup HAProxy Load Balancer for MySQL Galera With IP Whitelisting and Backup Servers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-31T19:15:50-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>7:15 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today we will setup a HAProxy Service for our 3 Node MySQL Galera Cluster</p>

<h2>Our Setup:</h2>

<ul>
<li>3 Node Galera MySQL Cluster</li>
<li>3 HAProxy Services (Each HAProxy Service Running on the MySQL Nodes)</li>
<li>MySQL Listens on Port 3307</li>
<li>HAProxy Listens on Port 3306 and Proxies through to 3307</li>
</ul>


<p>I have setup HAProxy on the same node as the MySQL Servers for my use case, but you can also setup HAProxy on a node outside the MySQL Host.</p>

<p>So essentially our MySQL Galera Cluster is a Multi Master Setup, but for now we will only accept connections from Node-A, and have Node-B and Node-C as Backup servers. Should Node-A go down, HAProxy will route connections to Node-B, and if Node-B also goes down, connections will be routed to Node-C.</p>

<p>If the Primary Node, which is Node-A recovers, connections will be restored to Node-A.</p>

<h2>Security:</h2>

<p>We use iptables to allow traffic between the nodes for port TCP/3307 and allow all traffic for Port TCP/3306, as HAProxy will allow the IP Based Access:</p>

<figure class='code'><figcaption><span>Iptables for Each Node</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>iptables -I INPUT -s <span class="o">{</span>Node-A<span class="o">}</span> -p tcp --dport <span class="m">3307</span> -j ACCEPT
</span><span class='line'><span class="nv">$ </span>iptables -I INPUT -s <span class="o">{</span>Node-B<span class="o">}</span> -p tcp --dport <span class="m">3307</span> -j ACCEPT
</span><span class='line'><span class="nv">$ </span>iptables -I INPUT -s <span class="o">{</span>Node-C<span class="o">}</span> -p tcp --dport <span class="m">3307</span> -j ACCEPT
</span><span class='line'><span class="nv">$ </span>iptables -A INPUT -p tcp --dport <span class="m">3306</span> -j ACCEPT
</span><span class='line'><span class="nv">$ </span>iptables -A INPUT -p tcp --dport <span class="m">3307</span> -j DROP
</span></code></pre></td></tr></table></div></figure>


<h2>HAProxy:</h2>

<p>Installing HAProxy on Ubuntu:</p>

<figure class='code'><figcaption><span>Install HAProxy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update
</span><span class='line'><span class="nv">$ </span>sudo apt install haproxy -y
</span></code></pre></td></tr></table></div></figure>


<p>Configure HAProxy with a Port 3306 listener, specify your source addresses that you would like to be authorized to communicate with MySQL and then specify the servers to proxy the connections to our MySQL Galera Cluster, specifying 2 backup servers:</p>

<figure class='code'><figcaption><span>/etc/haproxy/haproxy.cfg</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>global
</span><span class='line'>  log         127.0.0.1 local2
</span><span class='line'>  chroot      /var/lib/haproxy
</span><span class='line'>  pidfile     /var/run/haproxy.pid
</span><span class='line'>  maxconn     1020
</span><span class='line'>  user        haproxy
</span><span class='line'>  group       haproxy
</span><span class='line'>  daemon
</span><span class='line'>
</span><span class='line'>  stats socket /var/lib/haproxy/stats.sock mode <span class="m">600</span> level admin
</span><span class='line'>  stats timeout 2m
</span><span class='line'>
</span><span class='line'>defaults
</span><span class='line'>  mode    tcp
</span><span class='line'>  log     global
</span><span class='line'>  option  dontlognull
</span><span class='line'>  option  redispatch
</span><span class='line'>  retries                   3
</span><span class='line'>  timeout queue             45s
</span><span class='line'>  timeout connect           5s
</span><span class='line'>  timeout client            1m
</span><span class='line'>  timeout server            1m
</span><span class='line'>  timeout check             10s
</span><span class='line'>  maxconn                   1020
</span><span class='line'>
</span><span class='line'>listen stats
</span><span class='line'>  <span class="nb">bind</span>    *:80
</span><span class='line'>  mode    http
</span><span class='line'>  stats   <span class="nb">enable</span>
</span><span class='line'><span class="nb">  </span>stats   show-legends
</span><span class='line'>  stats   refresh           5s
</span><span class='line'>  stats   uri               /
</span><span class='line'>  stats   realm             Haproxy<span class="se">\ </span>Statistics
</span><span class='line'>  stats   auth              admin:secret
</span><span class='line'>  stats   admin             <span class="k">if</span> TRUE
</span><span class='line'>
</span><span class='line'>listen galera-lb
</span><span class='line'>  <span class="nb">bind</span>    *:3306
</span><span class='line'>  mode    tcp
</span><span class='line'>  acl     network_allowed src 10.10.1.0/24 10.32.15.2/32
</span><span class='line'>  tcp-request               content accept <span class="k">if</span> network_allowed
</span><span class='line'>  tcp-request               content reject
</span><span class='line'>  default_backend           galera-cluster
</span><span class='line'>
</span><span class='line'>backend galera-cluster
</span><span class='line'>  balance roundrobin
</span><span class='line'>  server  scw-mysql-1 10.0.0.2:3307  check
</span><span class='line'>  server  scw-mysql-2 10.0.0.3:3307  check backup
</span><span class='line'>  server  scw-mysql-3 10.0.0.4:3307  check backup
</span></code></pre></td></tr></table></div></figure>


<p>Start HAProxy:</p>

<figure class='code'><figcaption><span>Start HAProxy Service</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>haproxy
</span><span class='line'><span class="nv">$ </span>sudo systemctl restart haproxy
</span></code></pre></td></tr></table></div></figure>


<h2>Authorize HAProxy Hostnames to Connect to MySQL:</h2>

<p>In this case we need to allow the Hostnames to be able to connect to mysql:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">&#39;root&#39;</span><span class="o">@</span><span class="s1">&#39;%&#39;</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">&#39;secrets&#39;</span> <span class="k">WITH</span> <span class="k">GRANT</span> <span class="k">OPTION</span><span class="p">;</span>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://raymii.org/s/snippets/haproxy_restrict_specific_urls_to_specific_ip_addresses.html">https://raymii.org/s/snippets/haproxy_restrict_specific_urls_to_specific_ip_addresses.html</a></li>
</ul>


<center>
        <script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init('Buy Me a Coffee', '#46b798', 'A6423ZIQ');kofiwidget2.draw();</script>
</center>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/31/secure-your-access-to-kibana-5-and-elasticsearch-5-with-nginx-for-aws/">Secure Your Access to Kibana 5 and Elasticsearch 5 With Nginx for AWS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-31T10:40:09-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>10:40 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As <del>until now, AWS does not offer VPC Support for Elasticsearch</del>, so this make things a bit difficult authorizing Private IP Ranges.</p>

<p>One workaround would be to setup a Nginx Reverse Proxy on AWS within the your Private VPC, associate a EIP on your Nginx EC2 Instance, then authorize your EIP on your Elasticsearch IP Access Policy.</p>

<p><strong>Update</strong>:</p>

<ul>
<li><a href="https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-vpc.html">Elasticsearch Announced VPC Support for Elasticsearch</a></li>
</ul>


<h2>Our Setup:</h2>

<p>In this setup, we will have an Internal ELB (Elastic Load Balancer), which we will associate 1 or more EC2 Nginx Instances behind the ELB, then setup our Nginx to Revere Proxy our connections through to our Elasticsearch Endpoint.</p>

<p>We will also setup Basic HTTP Authentication for our <code>/</code> elasticsearch endpoint, and our <code>/kibana</code> endpoint. But we will keep the authentication seperate from each other, so that credentials for ES and Kibana is not the same, but depending on your use case, you can allow both endpoints to reference the same credential file.</p>

<h2>Install Nginx</h2>

<p>Depending on your Linux Distribution, the package manager may differ, I am using Amazon Linux:</p>

<figure class='code'><figcaption><span>Install Nginx</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo yum update -y
</span><span class='line'><span class="nv">$ </span>sudo yum install nginx httpd-tools -y
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Nginx:</h2>

<p>Remove the default configuration and replace the <code>nginx.conf</code> with the following:</p>

<figure class='code'><figcaption><span>Remove Default Nginx Config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo rm -r /etc/nginx/nginx.conf
</span></code></pre></td></tr></table></div></figure>


<p>Main Nginx Configuration:</p>

<figure class='code'><figcaption><span>/etc/nginx/nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>user nginx<span class="p">;</span>
</span><span class='line'>worker_processes auto<span class="p">;</span>
</span><span class='line'>pid /run/nginx.pid<span class="p">;</span>
</span><span class='line'>error_log /var/log/nginx/error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>  worker_connections 1024<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Basic Settings</span>
</span><span class='line'>  sendfile on<span class="p">;</span>
</span><span class='line'>  tcp_nopush on<span class="p">;</span>
</span><span class='line'>  tcp_nodelay on<span class="p">;</span>
</span><span class='line'>  keepalive_timeout 65<span class="p">;</span>
</span><span class='line'>  types_hash_max_size 2048<span class="p">;</span>
</span><span class='line'>  server_names_hash_bucket_size 128<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  include /etc/nginx/mime.types<span class="p">;</span>
</span><span class='line'>  default_type application/octet-stream<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Logging Settings</span>
</span><span class='line'>        log_format  main  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  access_log /var/log/nginx/access.log main<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Gzip Settings</span>
</span><span class='line'>  gzip on<span class="p">;</span>
</span><span class='line'>  gzip_disable <span class="s2">&quot;msie6&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Elasticsearch Config</span>
</span><span class='line'>  include /etc/nginx/conf.d/elasticsearch.conf<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Reverse Proxy Configuration:</p>

<figure class='code'><figcaption><span>/etc/nginx/conf.d/elasticsearch.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>server <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  listen 80<span class="p">;</span>
</span><span class='line'>  server_name elk.mydomain.com<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># error logging</span>
</span><span class='line'>  error_log /var/log/nginx/elasticsearch_error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># authentication: server wide</span>
</span><span class='line'>  <span class="c">#auth_basic &quot;Auth&quot;;</span>
</span><span class='line'>  <span class="c">#auth_basic_user_file /etc/nginx/.secrets;</span>
</span><span class='line'>
</span><span class='line'>  location / <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># authentication: elasticsearch</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;Elasticsearch Auth&quot;</span><span class="p">;</span>
</span><span class='line'>    auth_basic_user_file /etc/nginx/.secrets_elasticsearch<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Host https://search.eu-west-1.es.amazonaws.com<span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="o">{</span>NGINX-EIP<span class="o">}</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Authorization <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass https://search.eu-west-1.es.amazonaws.com/<span class="p">;</span>
</span><span class='line'>    proxy_redirect https://search.eu-west-1.es.amazonaws.com/ http://<span class="o">{</span>NGINX-EIP<span class="o">}</span>/<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location /kibana <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># authentication: kibana</span>
</span><span class='line'>    auth_basic <span class="s2">&quot;Kibana Auth&quot;</span><span class="p">;</span>
</span><span class='line'>    auth_basic_user_file /etc/nginx/.secrets_kibana<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>    proxy_set_header Host https://search.eu-west-1.es.amazonaws.com<span class="p">;</span>
</span><span class='line'>    proxy_set_header X-Real-IP <span class="o">{</span>NGINX-EIP<span class="o">}</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Proxy-Connection <span class="s2">&quot;Keep-Alive&quot;</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header Authorization <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_pass https://search.eu-west-1.es.amazonaws.com/_plugin/kibana/<span class="p">;</span>
</span><span class='line'>    proxy_redirect https://search.eu-west-1.es.amazonaws.com/_plugin/kibana/ http://<span class="o">{</span>NGINX_EIP<span class="o">}</span>/kibana/<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># elb checks</span>
</span><span class='line'>  location /status <span class="o">{</span>
</span><span class='line'>    root /usr/share/nginx/html/<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Setup Authentication:</h2>

<p>Setup the authentication for elasticsearch and kibana:</p>

<figure class='code'><figcaption><span>Create Auth for Kibana and Elasticsearch</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo htpasswd -c /etc/nginx/.secrets_elasticsearch admin
</span><span class='line'><span class="nv">$ </span>sudo htpasswd -c /etc/nginx/.secrets_kibana admin
</span></code></pre></td></tr></table></div></figure>


<h2>Restart Nginx and Enable on Startup</h2>

<p>Restart the nginx process and enable the process on boot:</p>

<figure class='code'><figcaption><span>Restart Nginx</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo /etc/init.d/nginx restart
</span><span class='line'><span class="nv">$ </span>sudo chkconfig nginx on
</span></code></pre></td></tr></table></div></figure>


<h2>Configure ELB:</h2>

<p>Create a New Internal ELB, set the Backend Instances on Port 80, and the healthcheck should point to <code>/status/index.html</code> as this location block does not require authentication and our ELB will be able to get a 200 reponse if all is good.
Next you can configure your Route 53 Hosted Zone, <code>elk.mydomain.com</code> to map to your ELB.</p>

<h2>End Result</h2>

<p>Now you should be able to access Elasticsearch on <code>http://elk.mydomain.com/</code> and Kibana on <code>http://elk.mydomain.com/kibana</code> after authenticating.</p>

<p><p>
<script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init(&lsquo;Buy Me a Coffee&rsquo;, &lsquo;#46b798&rsquo;, &lsquo;A6423ZIQ&rsquo;);kofiwidget2.draw();</script></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/31/reference-credentials-outside-your-main-application-in-python/">Reference Credentials Outside Your Main Application in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-31T03:00:58-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>3:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post I will show one way of referencing credentials from your application in Python, without setting them in your applications code. We will create a seperate python file which will hold our credentials, and then call them from our main application.</p>

<h2>Our Main Application</h2>

<p>This app will print our username, just for the sake of this example:</p>

<figure class='code'><figcaption><span>app.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">credentials</span> <span class="k">as</span> <span class="n">secrets</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_username</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;APP1&#39;</span><span class="p">][</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">my_password</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;APP1&#39;</span><span class="p">][</span><span class="s">&#39;password&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;Hello, your username is: {username}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">my_username</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Our Credentials File</h2>

<p>Then we have our file which will hold our credentials:</p>

<figure class='code'><figcaption><span>config.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">credentials</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;APP1&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="s">&#39;foo&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;password&#39;</span><span class="p">:</span> <span class="s">&#39;bar&#39;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That is at least one way of doing it, you could also use environment variables using the <code>os</code> module, which is described <a href="https://stackoverflow.com/a/4907053">here</a></p>

<h2>References:</h2>

<ul>
<li><a href="https://docs.python.org/2/tutorial/inputoutput.html">https://docs.python.org/2/tutorial/inputoutput.html</a></li>
<li><a href="https://docs.python.org/2/library/os.html#os.environ">https://docs.python.org/2/library/os.html#os.environ</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/28/change-iam-username-with-aws-cli/">Change IAM Username With AWS CLI</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-28T18:27:21-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>6:27 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You may find yourself in a position where you need to rename more than one IAM Username, and one way of doing this is using the AWS CLI tools to rename the username.</p>

<p>The benefit of this is that the user&rsquo;s access keys remains the same, any policies associated to the user, will stay on the user after the username gets renamed.</p>

<p>The only thing that changes, is ofcourse the username that the user will use when logging onto the AWS Management Console:</p>

<h2>Details of our User:</h2>

<p>We will change the IAM User <code>peter</code> to <code>peter.franklin</code>. Currently Peter&rsquo;s ACCESS_KEY will be <code>AKIA123456ABCDEF1234</code> which is configured with the profile name <code>peter</code>.</p>

<p>Lets first get details of our user before changing it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile admin iam get-user --user-name peter
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;User&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;UserName&quot;</span>: <span class="s2">&quot;peter&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;PasswordLastUsed&quot;</span>: <span class="s2">&quot;2017-08-28T13:17:22Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;CreateDate&quot;</span>: <span class="s2">&quot;2017-08-28T13:11:25Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;UserId&quot;</span>: <span class="s2">&quot;ABCDEFGHIJKLMNOPQRST&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;/&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Arn&quot;</span>: <span class="s2">&quot;arn:aws:iam::123456789012:user/peter&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Rename the IAM User</h2>

<p>Update user peter to peter.franklin:</p>

<figure class='code'><figcaption><span>Rename the IAM User</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile aws iam update-user --user-name peter --new-user-name peter.franklin
</span></code></pre></td></tr></table></div></figure>


<p>Describe peter&rsquo;s new username:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile aws iam get-user --user-name peter.franklin
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;User&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;UserName&quot;</span>: <span class="s2">&quot;peter.franklin&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;PasswordLastUsed&quot;</span>: <span class="s2">&quot;2017-08-28T13:23:18Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;CreateDate&quot;</span>: <span class="s2">&quot;2017-08-28T13:11:25Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;UserId&quot;</span>: <span class="s2">&quot;ABCDEFGHIJKLNMOPQRST&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Path&quot;</span>: <span class="s2">&quot;/&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Arn&quot;</span>: <span class="s2">&quot;arn:aws:iam::123456789012:user/peter.franklin&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify that access keys are the same:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile aws iam list-access-keys --user-name peter.franklin
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;AccessKeyMetadata&quot;</span>: <span class="o">[</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;UserName&quot;</span>: <span class="s2">&quot;peter.franklin&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Status&quot;</span>: <span class="s2">&quot;Active&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;CreateDate&quot;</span>: <span class="s2">&quot;2017-08-28T13:11:27Z&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;AccessKeyId&quot;</span>: <span class="s2">&quot;AKIA123456ABCDEF1234&quot;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this momemnt we can see that Peter&rsquo;s AccessKeyId is still the same, which means he does not have to update his credentials on his end.</p>

<h2>Some Useful CLI Commands:</h2>

<p>Get only the Access Key for a User:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile admin iam list-access-keys --user-name peter.franklin <span class="p">|</span> jq -r <span class="s1">&#39;.[][].AccessKeyId&#39;</span>
</span><span class='line'>AKIA123456ABCDEF1234
</span></code></pre></td></tr></table></div></figure>


<h2>Determine when the AccessKey was last used, and for which Service:</h2>

<p>For auditing, or verifying if a AccessKeyId is being used, we can call the <code>get-access-key-last-used</code>, which will give us the last time the key was used, and also see for which service in question.</p>

<p>Let Peter create a DynamoDB Table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile peter dynamodb <span class="se">\</span>
</span><span class='line'>create-table --table-name test01 <span class="se">\</span>
</span><span class='line'>--attribute-definitions <span class="s2">&quot;AttributeName=username,AttributeType=S&quot;</span> <span class="se">\</span>
</span><span class='line'>--key-schema <span class="s2">&quot;AttributeName=username,KeyType=HASH&quot;</span> <span class="se">\</span>
</span><span class='line'>--provisioned-throughput <span class="s2">&quot;ReadCapacityUnits=1,WriteCapacityUnits=1&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;TableDescription&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;TableArn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:dynamodb:eu-west-1:123456789012:table/test01&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;AttributeDefinitions&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;AttributeName&quot;</span><span class="p">:</span> <span class="s2">&quot;username&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;AttributeType&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;ProvisionedThroughput&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;NumberOfDecreasesToday&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;WriteCapacityUnits&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;ReadCapacityUnits&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nt">&quot;TableSizeBytes&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;TableName&quot;</span><span class="p">:</span> <span class="s2">&quot;test01&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;TableStatus&quot;</span><span class="p">:</span> <span class="s2">&quot;CREATING&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;KeySchema&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="nt">&quot;KeyType&quot;</span><span class="p">:</span> <span class="s2">&quot;HASH&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nt">&quot;AttributeName&quot;</span><span class="p">:</span> <span class="s2">&quot;username&quot;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="nt">&quot;ItemCount&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="nt">&quot;CreationDateTime&quot;</span><span class="p">:</span> <span class="mf">1503928537.671</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Get Detail on LastUsedDate:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile admin iam get-access-key-last-used  --access-key <span class="k">$(</span>aws --profile aws iam list-access-keys --user-name peter.franklin <span class="p">|</span> jq -r <span class="s1">&#39;.[][].AccessKeyId&#39;</span><span class="k">)</span> <span class="p">|</span> jq -r <span class="s1">&#39;.[]&#39;</span>
</span><span class='line'>peter.franklin
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;Region&quot;</span>: <span class="s2">&quot;eu-west-1&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;ServiceName&quot;</span>: <span class="s2">&quot;dynamodb&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;LastUsedDate&quot;</span>: <span class="s2">&quot;2017-08-28T13:55:00Z&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Only getting the LastUsedDate of the AccessKeyId:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>aws --profile admin iam get-access-key-last-used  --access-key <span class="k">$(</span>aws --profile aws iam list-access-keys --user-name peter.franklin <span class="p">|</span> jq -r <span class="s1">&#39;.[][].AccessKeyId&#39;</span><span class="k">)</span> <span class="p">|</span> jq <span class="s1">&#39;.AccessKeyLastUsed.LastUsedDate&#39;</span>
</span><span class='line'><span class="s2">&quot;2017-08-28T13:55:00Z&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><ul>
<li><a href="http://docs.aws.amazon.com/cli/latest/reference/iam/update-user.html?shortFooter=true">http://docs.aws.amazon.com/cli/latest/reference/iam/update-user.html?shortFooter=true</a></li>
</ul>
</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/08/27/using-the-python-api-for-mongodb-using-pymongo/">Using the Python API for MongoDB Using PyMongo</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-08-27T16:19:48-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>4:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Using the Python API for MongoDB using Pymongo</p>

<h2>Requirements:</h2>

<p>You will need to install the <code>pymongo</code> driver using pip:</p>

<figure class='code'><figcaption><span>Install Pymongo</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install pymongo
</span></code></pre></td></tr></table></div></figure>


<p>A configuration file with your access credentials, which I like to use outside my code:</p>

<figure class='code'><figcaption><span>config.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">credentials</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;mongodb&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;HOSTNAME&quot;</span>: <span class="s2">&quot;host.domain.com&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;USERNAME&quot;</span>: <span class="s2">&quot;username&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;PASSWORD&quot;</span>: <span class="s2">&quot;password&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Connecting to MongoDB:</h2>

<p>From the python interpreter, connect to MongoDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">credentials</span> <span class="k">as</span> <span class="n">secrets</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongo_host</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;mongodb&#39;</span><span class="p">][</span><span class="s">&#39;HOSTNAME&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongo_username</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;mongodb&#39;</span><span class="p">][</span><span class="s">&#39;USERNAME&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongo_password</span> <span class="o">=</span> <span class="n">secrets</span><span class="p">[</span><span class="s">&#39;mongodb&#39;</span><span class="p">][</span><span class="s">&#39;PASSWORD&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongodb_client</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="s">&#39;mongodb://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">:27017/admin?authMechanism=SCRAM-SHA-1&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mongo_username</span><span class="p">,</span> <span class="n">mongo_password</span><span class="p">,</span> <span class="n">mongo_host</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find the Database that you are connected to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">get_database</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'><span class="s">u&#39;admin&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find all the databases that is currently on your MongoDB Server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dbs</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">database_names</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">admin</span>
</span><span class='line'><span class="n">flask_reminders</span>
</span><span class='line'><span class="n">local</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create a Database, Collection and Write a Document into your Database:</h2>

<p>Let&rsquo;s create a database, in my case it will be <code>ruan-test</code>, and my collection name <code>mycollection</code> and the write one item into it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="p">[</span><span class="s">&#39;ruan-test&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span> <span class="o">=</span> <span class="n">newdb</span><span class="p">[</span><span class="s">&#39;mycollection&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;frank&quot;</span><span class="p">,</span> <span class="s">&quot;surname&quot;</span><span class="p">:</span> <span class="s">&quot;jeffreys&quot;</span><span class="p">,</span> <span class="s">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;person&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">]}</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">doc_id</span> <span class="o">=</span> <span class="n">newdb_collection</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span><span class="o">.</span><span class="n">inserted_id</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
</span><span class='line'><span class="mi">59</span><span class="n">a319ec1f15a5088ba3a339</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note: you can also connect to your collection like the following</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="p">[</span><span class="s">&#39;ruan-test&#39;</span><span class="p">][</span><span class="s">&#39;mycollection&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have inserted one item into our database, which we can verify with <code>count()</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span class='line'><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see I have the value of the item&rsquo;s id, we can use that to find it from our collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;_id&quot;</span><span class="p">:</span> <span class="n">doc_id</span><span class="p">})</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a319ec1f15a5088ba3a339&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;jeffreys&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;frank&#39;</span><span class="p">,</span> <span class="s">u&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">u&#39;person&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we only have one item in our database, we can also use <code>find_one()</code> which will give us the exact same data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a319ec1f15a5088ba3a339&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;jeffreys&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;frank&#39;</span><span class="p">,</span> <span class="s">u&#39;tags&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">u&#39;person&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can write some more data to our database, but this time, lets write to a different collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb_collection2</span> <span class="o">=</span> <span class="n">newdb</span><span class="p">[</span><span class="s">&#39;new-collection-2&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">item</span> <span class="o">=</span> <span class="n">newdb_collection2</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;ruby&quot;</span><span class="p">,</span> <span class="s">&quot;surname&quot;</span><span class="p">:</span> <span class="s">&quot;james&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">inserted_id</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">item2</span> <span class="o">=</span> <span class="n">newdb_collection2</span><span class="o">.</span><span class="n">insert_one</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;ruby&quot;</span><span class="p">,</span> <span class="s">&quot;surname&quot;</span><span class="p">:</span> <span class="s">&quot;james&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">inserted_id</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we captured the items <code>_id</code>, we can view the:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="mi">59</span><span class="n">a31acf1f15a5088ba3a33b</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">item2</span><span class="p">)</span>
</span><span class='line'><span class="mi">59</span><span class="n">a31a8a1f15a5088ba3a33a</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Query Data from MongoDB:</h2>

<p>We can then query for this data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb2</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;ruby&quot;</span><span class="p">})</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a31acf1f15a5088ba3a33b&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;james&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;ruby&#39;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb2</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;_id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">})</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a31acf1f15a5088ba3a33b&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;james&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;ruby&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also scan for all items in the collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">scan</span> <span class="o">=</span> <span class="n">newdb_collection2</span><span class="o">.</span><span class="n">find</span><span class="p">({})</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scan</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a31a8a1f15a5088ba3a33a&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;james&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;phillip&#39;</span><span class="p">}</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;59a31acf1f15a5088ba3a33b&#39;</span><span class="p">),</span> <span class="s">u&#39;surname&#39;</span><span class="p">:</span> <span class="s">u&#39;james&#39;</span><span class="p">,</span> <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;ruby&#39;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb2</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span class='line'><span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can now verify that we have 2 collections in our database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">newdb</span><span class="o">.</span><span class="n">collection_names</span><span class="p">()</span>
</span><span class='line'><span class="p">[</span><span class="s">u&#39;mycollection-2&#39;</span><span class="p">,</span> <span class="s">u&#39;mycollection&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Connecting to an existing Database:</h2>

<p>Let&rsquo;s connect to an existing database on our MongoDB Server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="p">[</span><span class="s">&#39;flask_reminders&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>List the collections:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">collection_names</span><span class="p">()</span>
</span><span class='line'><span class="p">[</span><span class="s">u&#39;reminders&#39;</span><span class="p">,</span> <span class="s">u&#39;usersessions&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Count the number of items in our <code>reminders</code> Collection:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">reminders</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span><span class='line'><span class="mi">624</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find a Random Item:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">reminders</span><span class="o">.</span><span class="n">find_one</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;category&#39;</span><span class="p">:</span> <span class="s">u&#39;Python&#39;</span><span class="p">,</span> <span class="s">u&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Chatbot with SQLite&#39;</span><span class="p">,</span> <span class="s">u&#39;link&#39;</span><span class="p">:</span> <span class="s">u&#39;http://rodic.fr/blog/python-chatbot-1/&#39;</span><span class="p">,</span> <span class="s">u&#39;date&#39;</span><span class="p">:</span> <span class="s">u&#39;2017-01-03&#39;</span><span class="p">,</span> <span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;586bb6dd0269103671afce32&#39;</span><span class="p">),</span> <span class="s">u&#39;type&#39;</span><span class="p">:</span> <span class="s">u&#39;Discovered Service&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find One Item, with a Specific Value, for example the value <code>AWS</code> for our <code>Category key</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">reminders</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&quot;category&quot;</span><span class="p">:</span> <span class="s">&quot;AWS&quot;</span><span class="p">})</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;category&#39;</span><span class="p">:</span> <span class="s">u&#39;AWS&#39;</span><span class="p">,</span> <span class="s">u&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Elasticsearch Documentation Access Policies&#39;</span><span class="p">,</span> <span class="s">u&#39;link&#39;</span><span class="p">:</span> <span class="s">u&#39;http://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-createupdatedomains.html#es-createdomain-configure-access-policies&#39;</span><span class="p">,</span> <span class="s">u&#39;date&#39;</span><span class="p">:</span> <span class="s">u&#39;2017-02-13&#39;</span><span class="p">,</span> <span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;58a1d45202691070616947c3&#39;</span><span class="p">),</span> <span class="s">u&#39;type&#39;</span><span class="p">:</span> <span class="s">u&#39;Documentation&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find All Items, with a specific value:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">flaskdb</span><span class="o">.</span><span class="n">reminders</span><span class="o">.</span><span class="n">find</span><span class="p">({</span><span class="s">&quot;category&quot;</span><span class="p">:</span> <span class="s">&quot;AWS&quot;</span><span class="p">})</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;category&#39;</span><span class="p">:</span> <span class="s">u&#39;Python&#39;</span><span class="p">,</span> <span class="s">u&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Chatbot with SQLite&#39;</span><span class="p">,</span> <span class="s">u&#39;link&#39;</span><span class="p">:</span> <span class="s">u&#39;http://rodic.fr/blog/python-chatbot-1/&#39;</span><span class="p">,</span> <span class="s">u&#39;date&#39;</span><span class="p">:</span> <span class="s">u&#39;2017-01-03&#39;</span><span class="p">,</span> <span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;586bb6dd0269103671afce32&#39;</span><span class="p">),</span> <span class="s">u&#39;type&#39;</span><span class="p">:</span> <span class="s">u&#39;Discovered Service&#39;</span><span class="p">}</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;category&#39;</span><span class="p">:</span> <span class="s">u&#39;Python&#39;</span><span class="p">,</span> <span class="s">u&#39;description&#39;</span><span class="p">:</span> <span class="s">u&#39;Boto: Kinesis List&#39;</span><span class="p">,</span> <span class="s">u&#39;link&#39;</span><span class="p">:</span> <span class="s">u&#39;https://gitlab.com/rbekker87/code-examples/blob/master/kinesis/firehose/python/firehose.list.py&#39;</span><span class="p">,</span> <span class="s">u&#39;date&#39;</span><span class="p">:</span> <span class="s">u&#39;2017-01-05&#39;</span><span class="p">,</span> <span class="s">u&#39;_id&#39;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="s">&#39;586dde1e0269103671afce36&#39;</span><span class="p">),</span> <span class="s">u&#39;type&#39;</span><span class="p">:</span> <span class="s">u&#39;Stuff Done&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deleting Databases:</h2>

<p>Cleaning up, deleting the database that we created, when a database is delete, the collections within that database also gets removed.</p>

<p>First list the databases:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dbs</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">database_names</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">admin</span>
</span><span class='line'><span class="n">flask_reminders</span>
</span><span class='line'><span class="n">local</span>
</span><span class='line'><span class="n">ruan</span><span class="o">-</span><span class="n">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then delete the database that you want to delete:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">drop_database</span><span class="p">(</span><span class="s">&quot;ruan-test&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then verify if the database was removed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">dbs</span> <span class="o">=</span> <span class="n">mongodb_client</span><span class="o">.</span><span class="n">database_names</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">admin</span>
</span><span class='line'><span class="n">flask_reminders</span>
</span><span class='line'><span class="n">local</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="http://api.mongodb.com/python/current/tutorial.html">http://api.mongodb.com/python/current/tutorial.html</a></li>
<li><a href="https://docs.mongodb.com/getting-started/python/client/">https://docs.mongodb.com/getting-started/python/client/</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/31">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/29">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2021/03/10/generate-grafana-loki-log-links-from-metric-label-values/">Generate Grafana Loki Log Links From Metric Label Values</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/visualize-weather-data-with-grafana-and-the-dht22-sensor/">Visualize Weather Data With Grafana and the DHT22 Sensor</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/09/cicd-with-droneci-and-gitea-using-docker-compose/">CICD With DroneCI and Gitea Using Docker Compose</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/02/26/ship-your-docker-logs-to-loki-using-fluentbit/">Ship Your Docker Logs to Loki Using Fluentbit</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/01/31/installing-arduino-and-setup-the-nodemcu-esp32/">Installing Arduino and Setup the NodeMCU ESP32</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest cheatsheets in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com"><img src="https://user-images.githubusercontent.com/567298/97010485-c2334a00-1545-11eb-9e1d-2333e5148da1.png" width="290" height="900"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
