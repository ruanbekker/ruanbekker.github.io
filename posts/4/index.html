
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="I have a dedicated server with LXD installed where I have a bunch of system containers running to host a lot of my playground services, and to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/posts/4/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
<script>
(function(f, a, t, h, o, m){
	a[h]=a[h]||function(){
		(a[h].q=a[h].q||[]).push(arguments)
	};
	o=f.createElement('script'),
	m=f.getElementsByTagName('script')[0];
	o.async=1; o.src=t; o.id='fathom-script';
	m.parentNode.insertBefore(o,m)
})(document, window, '//fh-blog-ruanbekker-com.home.ruan.dev/tracker.js', 'fathom');
fathom('set', 'siteId', 'MWBHH');
fathom('trackPageview');
</script>
<!-- / Fathom -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/06/13/using-proxyjump-with-ssh-for-vms-with-no-public-ips/">Using ProxyJump With SSH for VMs With No Public IPs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-06-13T20:06:35+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>8:06 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://img.sysadmins.co.za/wngib2.png" alt="ssh-proxy-jump" /></p>

<p>I have a dedicated server with LXD installed where I have a bunch of system containers running to host a lot of my playground services, and to access the operating system of those lxc containers, I need to SSH to the LXD host, then exec or ssh into that LXC container.</p>

<p>This became tedious and wanted a way to directly ssh to them, as they don&rsquo;t have public ip addresses, it&rsquo;s not possible but found its possible to access them using proxyjump.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[you] -&gt; [hypervisor] -&gt; [vm on hypervisor]</span></code></pre></td></tr></table></div></figure>


<p>First step is to create our ssh key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh-keygen -t rsa</span></code></pre></td></tr></table></div></figure>


<p>Add the created public key (<code>~/.ssh/id_rsa.pub</code>) on the hypervisor and the target vm&rsquo;s <code>~/.ssh/authorized_key</code> files.</p>

<p>Then create the SSH Config on your local workstation (<code>~/.ssh/config</code>):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Host *
</span><span class='line'>  StrictHostKeyChecking no
</span><span class='line'>  UserKnownHostsFile=/dev/null
</span><span class='line'>
</span><span class='line'>Host hypervisor
</span><span class='line'>  Hostname hv.domain.com
</span><span class='line'>  User myuser
</span><span class='line'>  IdentityFile ~/.ssh/id_rsa
</span><span class='line'>
</span><span class='line'>Host ctr1
</span><span class='line'>  Hostname 10.37.117.132
</span><span class='line'>  User root
</span><span class='line'>  IdentityFile ~/.ssh/id_rsa
</span><span class='line'>  ProxyJump hypervisor</span></code></pre></td></tr></table></div></figure>


<p>Now accessing our lxc container ctr1, is possible by doing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh ctr1
</span><span class='line'>Warning: Permanently added 'x,x' (ECDSA) to the list of known hosts.
</span><span class='line'>Warning: Permanently added '10.37.117.132' (ECDSA) to the list of known hosts.
</span><span class='line'>root@ctr1~ $</span></code></pre></td></tr></table></div></figure>


<p>Thank you for reading</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/06/13/using-a-ssh-reverse-tunnel-to-access-nodes-on-private-ranges/">Using a SSH Reverse Tunnel to Access Nodes on Private Ranges</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-06-13T19:59:27+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>7:59 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://img.sysadmins.co.za/wngib2.png" alt="ssh-tunneling" /></p>

<p>Personal utility (actually just a command) that I use to reach my Raspberry Pi Nodes that has no direct route via the Internet</p>

<h2>Other Projects</h2>

<p>There&rsquo;s a lot of other tools out there that&rsquo;s already solving this issue, such as <a href="https://inlets.dev">inlets</a>, but I wanted my own, so that I can extend features to it as it pleases me.</p>

<h2>Overview</h2>

<p>This is more ore less how it looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[VPS] &lt;-- Has a Public IP
</span><span class='line'> |
</span><span class='line'> |
</span><span class='line'> [HOME NETWORK] &lt;-- Dynamic IP
</span><span class='line'>   |
</span><span class='line'>   |
</span><span class='line'> [rpi-01:22], [rpi-02:22] &lt;-- Private IPs</span></code></pre></td></tr></table></div></figure>


<ul>
<li>SSH Tunnel is setup from the Raspberry Pi Nodes</li>
<li>Each Raspberry Pi sets up a unique port on the VPS for the tunnel to traverse to the Rpi on port 22</li>
<li>To reach Rpi-01, you hop onto the VPS and ssh to localhost port 2201</li>
<li>To reach Rpi-02, you hop onto the VPS and ssh to localhost port 2202, etc</li>
</ul>


<h2>Progress</h2>

<p>The tool will still be built, but using ssh it&rsquo;s quite easy</p>

<h2>Usage</h2>

<p>Setup the SSH Reverse Tunnel from rpi-01:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -i ~/.ssh/bastion.pem \
</span><span class='line'>  -o StrictHostKeyChecking=no \
</span><span class='line'>  -o UserKnownHostsFile=/dev/null \
</span><span class='line'>  -o ServerAliveInterval=60 \
</span><span class='line'>  -N -R 2201:localhost:22 \
</span><span class='line'>  -p 22 ruan@bastion-9239.domain.cloud</span></code></pre></td></tr></table></div></figure>


<p>Setup the SSH Reverse Tunnel from rpi-02:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -i ~/.ssh/bastion.pem \
</span><span class='line'>  -o StrictHostKeyChecking=no \
</span><span class='line'>  -o UserKnownHostsFile=/dev/null \
</span><span class='line'>  -o ServerAliveInterval=60 \
</span><span class='line'>  -N -R 2202:localhost:22 \
</span><span class='line'>  -p 22 ruan@bastion-9239.domain.cloud</span></code></pre></td></tr></table></div></figure>


<p>On the VPS, we can see that we have port 2021 and 2022 listening:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ netstat -tulpn
</span><span class='line'>Active Internet connections (only servers)
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        0      0 127.0.0.1:2201          0.0.0.0:*               LISTEN      -
</span><span class='line'>tcp        0      0 127.0.0.1:2202          0.0.0.0:*               LISTEN      -</span></code></pre></td></tr></table></div></figure>


<p>To connect to rpi-01, we ssh to localhost on port 2201, from the VPS:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -p 2201 pi@localhost
</span><span class='line'>pi@rpi-01:~ $</span></code></pre></td></tr></table></div></figure>


<p>To connect to rpi-02, we ssh to localhost on port 2202 from the VPS:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -p 2202 pi@localhost
</span><span class='line'>pi@rpi-02:~ $</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/06/13/get-the-top-10-items-on-hackernews-in-python/">Get the Top 10 Items on Hackernews in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-06-13T19:53:20+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>7:53 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a quick post on how to use python to get the 10 latest items from hacker<a href="news:">news:</a></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import requests
</span><span class='line'>import json
</span><span class='line'>
</span><span class='line'>def get_top_ten():
</span><span class='line'>    ids = requests.get('https://hacker-news.firebaseio.com/v0/topstories.json?print=pretty').json()[0:10]
</span><span class='line'>    for id in ids:
</span><span class='line'>        postresponse = requests.get('https://hacker-news.firebaseio.com/v0/item/{postid}.json?print=pretty'.format(postid=id)).json()
</span><span class='line'>        formatted = {"title": postresponse["title"], "type": postresponse["type"], "url": postresponse["url"], "by": postresponse["by"]}
</span><span class='line'>        print(json.dumps(formatted, indent=2))</span></code></pre></td></tr></table></div></figure>


<p>When running it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; get_top_ten()
</span><span class='line'>..
</span><span class='line'>{
</span><span class='line'>  "title": "Play Counter-Strike 1.6 in your browser",
</span><span class='line'>  "type": "story",
</span><span class='line'>  "url": "http://cs-online.club",
</span><span class='line'>  "by": "m0ck"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/06/13/improve-mysql-write-performance-using-batch-writes/">Improve MySQL Write Performance Using Batch Writes</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-06-13T19:31:32+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>7:31 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://img.sysadmins.co.za/wngib2.png" alt="mysql-python-performance" /></p>

<p>I am no DBA, but I got curious when I noticed sluggish write performance on a mysql database, and I remembered somewhere that you should always use batch writes over sequential writes. So I decided to test it out, using a python script and a mysql server.</p>

<h2>What will we be doing</h2>

<p>I wrote a python script that writes 100,000 records to a database and keeps time of how long the writes took, 2 examples which I will compare:</p>

<ul>
<li>One script writing each record to the database</li>
<li>One script writing all the records as batch</li>
</ul>


<h2>Sequential Writes</h2>

<p>It took 48 seconds to write 100,000 records into a database using sequential writes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">userids</span><span class="p">:</span>
</span><span class='line'>    <span class="n">userid</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">job</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span class='line'>    <span class="n">age</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">49</span><span class="p">)</span>
</span><span class='line'>    <span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;ccnum&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">status</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s">&quot;active&quot;</span><span class="p">,</span> <span class="s">&quot;inactive&quot;</span><span class="p">,</span> <span class="s">&quot;disabled&quot;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;INSERT INTO customers(userid, name, job, age, credit_card_num, status) VALUES(%s, %s, %s, %s, %s, %s)&quot;&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">credit_card_num</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running that shows us this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python3</span> <span class="n">mysql_seq_writes</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="n">start</span>
</span><span class='line'><span class="n">writing</span> <span class="n">customers</span> <span class="n">to</span> <span class="n">database</span>
</span><span class='line'><span class="n">finish</span>
</span><span class='line'><span class="n">inserted</span> <span class="mi">100000</span> <span class="n">records</span> <span class="ow">in</span> <span class="mi">48</span><span class="n">s</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Batch Writes</h2>

<p>It took 3 seconds to write to write 100,000 records using batch writes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">userids</span><span class="p">:</span>
</span><span class='line'>    <span class="n">userid</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">job</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span class='line'>    <span class="n">age</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">49</span><span class="p">)</span>
</span><span class='line'>    <span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;ccnum&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">status</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s">&quot;active&quot;</span><span class="p">,</span> <span class="s">&quot;inactive&quot;</span><span class="p">,</span> <span class="s">&quot;disabled&quot;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">bunch_users</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">userid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">credit_card_num</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;INSERT INTO customers(userid, name, job, age, credit_card_num, status) VALUES(%s, %s, %s, %s, %s, %s)&quot;&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">bunch_users</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running that shows us this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python3</span> <span class="n">mysql_batch_writes</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="n">start</span>
</span><span class='line'><span class="n">writing</span> <span class="n">customers</span> <span class="n">to</span> <span class="n">database</span>
</span><span class='line'><span class="n">finish</span>
</span><span class='line'><span class="n">inserted</span> <span class="mi">100000</span> <span class="n">records</span> <span class="ow">in</span> <span class="mi">3</span><span class="n">s</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Looking at the Scripts</h2>

<p>The script used for sequential writes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">datetime</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">MySQLdb</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
</span><span class='line'>
</span><span class='line'><span class="n">host</span><span class="o">=</span><span class="s">&quot;172.18.0.1&quot;</span>
</span><span class='line'><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span>
</span><span class='line'><span class="n">password</span><span class="o">=</span><span class="s">&quot;password&quot;</span>
</span><span class='line'><span class="n">dbname</span><span class="o">=</span><span class="s">&quot;shopdb&quot;</span>
</span><span class='line'><span class="n">records</span><span class="o">=</span><span class="mi">100000</span>
</span><span class='line'>
</span><span class='line'><span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">dbname</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ruan&#39;</span><span class="p">,</span> <span class="s">&#39;donovan&#39;</span><span class="p">,</span> <span class="s">&#39;james&#39;</span><span class="p">,</span> <span class="s">&#39;warren&#39;</span><span class="p">,</span> <span class="s">&#39;angie&#39;</span><span class="p">,</span> <span class="s">&#39;nicole&#39;</span><span class="p">,</span> <span class="s">&#39;jenny&#39;</span><span class="p">,</span> <span class="s">&#39;penny&#39;</span><span class="p">,</span> <span class="s">&#39;amber&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">job</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;doctor&#39;</span><span class="p">,</span> <span class="s">&#39;scientist&#39;</span><span class="p">,</span> <span class="s">&#39;teacher&#39;</span><span class="p">,</span> <span class="s">&#39;police officer&#39;</span><span class="p">,</span> <span class="s">&#39;waiter&#39;</span><span class="p">,</span> <span class="s">&#39;banker&#39;</span><span class="p">,</span> <span class="s">&#39;it&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">cur</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span class='line'><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DROP TABLE IF EXISTS customers&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE customers(userid VARCHAR(50), name VARCHAR(50), surname VARCHAR(50), job VARCHAR(50), age INT(2), credit_card_num VARCHAR(50), status VARCHAR(10))&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">bunch_users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="n">userids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">gen_id</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">gen_user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
</span><span class='line'>    <span class="n">ccnum</span> <span class="o">=</span> <span class="s">&#39;{0}-{1}-{2}-{3}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gen_id</span><span class="p">(),</span> <span class="n">gen_id</span><span class="p">(),</span> <span class="n">gen_id</span><span class="p">(),</span> <span class="n">gen_id</span><span class="p">())</span>
</span><span class='line'>    <span class="n">userid</span> <span class="o">=</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ccnum</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ccnum</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;uid&quot;</span><span class="p">:</span> <span class="n">userid</span><span class="p">,</span> <span class="s">&quot;ccnum&quot;</span><span class="p">:</span> <span class="n">ccnum</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
</span><span class='line'>    <span class="n">userids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen_user</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;writing customers to database&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">timestart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">userids</span><span class="p">:</span>
</span><span class='line'>    <span class="n">userid</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">job</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span class='line'>    <span class="n">age</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">49</span><span class="p">)</span>
</span><span class='line'>    <span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;ccnum&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">status</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s">&quot;active&quot;</span><span class="p">,</span> <span class="s">&quot;inactive&quot;</span><span class="p">,</span> <span class="s">&quot;disabled&quot;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#bunch_users.append((userid, name, job, age, credit_card_num, status))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;INSERT INTO customers(userid, name, job, age, credit_card_num, status) VALUES(%s, %s, %s, %s, %s, %s)&quot;&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">credit_card_num</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="n">timefinish</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;finish&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;inserted {} records in {}s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">timefinish</span><span class="o">-</span><span class="n">timestart</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The script used for the batch writes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">datetime</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">MySQLdb</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span>
</span><span class='line'>
</span><span class='line'><span class="n">host</span><span class="o">=</span><span class="s">&quot;172.18.0.1&quot;</span>
</span><span class='line'><span class="n">user</span><span class="o">=</span><span class="s">&quot;root&quot;</span>
</span><span class='line'><span class="n">password</span><span class="o">=</span><span class="s">&quot;password&quot;</span>
</span><span class='line'><span class="n">dbname</span><span class="o">=</span><span class="s">&quot;shopdb&quot;</span>
</span><span class='line'><span class="n">records</span><span class="o">=</span><span class="mi">100000</span>
</span><span class='line'>
</span><span class='line'><span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">dbname</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ruan&#39;</span><span class="p">,</span> <span class="s">&#39;donovan&#39;</span><span class="p">,</span> <span class="s">&#39;james&#39;</span><span class="p">,</span> <span class="s">&#39;warren&#39;</span><span class="p">,</span> <span class="s">&#39;angie&#39;</span><span class="p">,</span> <span class="s">&#39;nicole&#39;</span><span class="p">,</span> <span class="s">&#39;jenny&#39;</span><span class="p">,</span> <span class="s">&#39;penny&#39;</span><span class="p">,</span> <span class="s">&#39;amber&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">job</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;doctor&#39;</span><span class="p">,</span> <span class="s">&#39;scientist&#39;</span><span class="p">,</span> <span class="s">&#39;teacher&#39;</span><span class="p">,</span> <span class="s">&#39;police officer&#39;</span><span class="p">,</span> <span class="s">&#39;waiter&#39;</span><span class="p">,</span> <span class="s">&#39;banker&#39;</span><span class="p">,</span> <span class="s">&#39;it&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">cur</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span><span class='line'><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;DROP TABLE IF EXISTS customers&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;CREATE TABLE customers(userid VARCHAR(50), name VARCHAR(50), surname VARCHAR(50), job VARCHAR(50), age INT(2), credit_card_num VARCHAR(50), status VARCHAR(10))&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">bunch_users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="n">userids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">gen_id</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">9999</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">gen_user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
</span><span class='line'>    <span class="n">ccnum</span> <span class="o">=</span> <span class="s">&#39;{0}-{1}-{2}-{3}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gen_id</span><span class="p">(),</span> <span class="n">gen_id</span><span class="p">(),</span> <span class="n">gen_id</span><span class="p">(),</span> <span class="n">gen_id</span><span class="p">())</span>
</span><span class='line'>    <span class="n">userid</span> <span class="o">=</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">ccnum</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ccnum</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;uid&quot;</span><span class="p">:</span> <span class="n">userid</span><span class="p">,</span> <span class="s">&quot;ccnum&quot;</span><span class="p">:</span> <span class="n">ccnum</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">records</span><span class="p">):</span>
</span><span class='line'>    <span class="n">userids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen_user</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">userids</span><span class="p">:</span>
</span><span class='line'>    <span class="n">userid</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>    <span class="n">job</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span class='line'>    <span class="n">age</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span><span class="mi">49</span><span class="p">)</span>
</span><span class='line'>    <span class="n">credit_card_num</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&quot;ccnum&quot;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">status</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s">&quot;active&quot;</span><span class="p">,</span> <span class="s">&quot;inactive&quot;</span><span class="p">,</span> <span class="s">&quot;disabled&quot;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">bunch_users</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">userid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">credit_card_num</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">timestart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;writing customers to database&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;INSERT INTO customers(userid, name, job, age, credit_card_num, status) VALUES(%s, %s, %s, %s, %s, %s)&quot;&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">bunch_users</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'><span class="n">timefinish</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;finish&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;inserted {} records in {}s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">timefinish</span><span class="o">-</span><span class="n">timestart</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thanks</h2>

<p>Thanks for reading, so this was kind of interesting to see to never do sequential writes but write them in bulk when you have large amount of writes.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/06/08/build-a-ghost-blog-with-nginx-cache-on-docker/">Increase Performance With Your Ghost Blog on Docker</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-06-08T23:28:07+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:28 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://img.sysadmins.co.za/wngib2.png" alt="nginx-blog-ghost-caching" /></p>

<p>Nginx Caching + Ghost == Great Performance.</p>

<p>In this post we will build a nginx reverse proxy with caching enabled for our static content such as images, which will be our frontend and therefore we will have port 80 exposed, and run our ghost blog as our backend, which we will proxy traffic through from our nginx container.</p>

<h2>But why would you want caching?</h2>

<p>Returning data from memory is a lot faster than returning data from disk, and in this case where a request is being made against nginx, then it proxy passes the request to ghost, gets the data that you requested and returns the data to the client.</p>

<p>So for items that rarely changes like images, we can benefit from caching, so the images can be returned from the nginx service, where the first request will be made to ghost and then it will be loaded into nginx cache, so then the next time when you request the same image it will be returned from cache instead of making that same request to ghost again.</p>

<h2>Caching Info</h2>

<p>For this demonstration once we define the size of our chache which will be 500MB and we specify that if an object has not been accessed for 24 hours, we can expire the object from the cache.</p>

<h2>Nginx</h2>

<p>We will build our nginx container by adding our custom nginx config to our dockerfile.</p>

<p>Our <code>Dockerfile</code> will look like the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ROM nginx:stable
</span><span class='line'>ADD nginx.conf /etc/nginx/nginx.conf</span></code></pre></td></tr></table></div></figure>


<p>Our <code>nginx.conf</code> configuration file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>events {
</span><span class='line'>  worker_connections  1024;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>http {
</span><span class='line'>  default_type       text/html;
</span><span class='line'>  access_log         /dev/stdout;
</span><span class='line'>  sendfile           on;
</span><span class='line'>  keepalive_timeout  65;
</span><span class='line'>
</span><span class='line'>  #proxy_cache_path /tmp/ghostcache levels=1:2 keys_zone=ghostcache:500m max_size=2g inactive=30d;
</span><span class='line'>  proxy_cache_path /tmp/ghostcache levels=1:2 keys_zone=ghostcache:60m max_size=500m inactive=24h;
</span><span class='line'>  proxy_cache_key "$scheme$request_method$host$request_uri";
</span><span class='line'>  proxy_cache_methods GET HEAD;
</span><span class='line'>
</span><span class='line'>  server {
</span><span class='line'>    listen 80;
</span><span class='line'>
</span><span class='line'>    location / {
</span><span class='line'>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>        proxy_set_header X-Forwarded-Proto $scheme;
</span><span class='line'>        proxy_set_header X-Real-IP $remote_addr;
</span><span class='line'>        proxy_set_header Host $http_host;
</span><span class='line'>        proxy_pass http://ghost:2368;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    location ~* \.(?:css|js|ico)$ {
</span><span class='line'>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>        proxy_set_header X-Forwarded-Proto $scheme;
</span><span class='line'>        proxy_set_header X-Real-IP $remote_addr;
</span><span class='line'>        proxy_set_header Host $http_host;
</span><span class='line'>        proxy_pass http://ghost:2368;
</span><span class='line'>        access_log off;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    location ^~ /content/images/ {
</span><span class='line'>        proxy_cache ghostcache;
</span><span class='line'>        proxy_cache_valid 60m;
</span><span class='line'>        proxy_cache_valid 404 1m;
</span><span class='line'>        proxy_ignore_headers Set-Cookie;
</span><span class='line'>        proxy_hide_header Set-Cookie;
</span><span class='line'>        proxy_cache_use_stale error timeout invalid_header updating http_500 http_502 http_503 http_504;
</span><span class='line'>        proxy_ignore_headers Cache-Control;
</span><span class='line'>        add_header X-Cache-Status $upstream_cache_status;
</span><span class='line'>
</span><span class='line'>        proxy_set_header Host $http_host;
</span><span class='line'>        proxy_set_header X-Real-IP $remote_addr;
</span><span class='line'>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>        proxy_set_header X-Forwarded-Proto $scheme;
</span><span class='line'>        proxy_pass http://ghost:2368;
</span><span class='line'>        access_log off;
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Then our <code>docker-compose.yml</code> where we will add our nginx and ghost container to run together:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: '3.4'
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  ghost:
</span><span class='line'>    image: ghost:3.15.1
</span><span class='line'>    container_name: 'ghost'
</span><span class='line'>    environment:
</span><span class='line'>      - NODE_ENV=production
</span><span class='line'>      - url=http://localhost:80
</span><span class='line'>    networks:
</span><span class='line'>      - ghost
</span><span class='line'>    volumes:
</span><span class='line'>      - ghost_content:/var/lib/ghost/content/data
</span><span class='line'>
</span><span class='line'>  proxy:
</span><span class='line'>    build: .
</span><span class='line'>    container_name: 'proxy'
</span><span class='line'>    depends_on:
</span><span class='line'>      - ghost
</span><span class='line'>    ports:
</span><span class='line'>      - 80:80
</span><span class='line'>    networks:
</span><span class='line'>      - ghost
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  ghost: {}
</span><span class='line'>
</span><span class='line'>volumes:
</span><span class='line'>  ghost_content: {}</span></code></pre></td></tr></table></div></figure>


<p>To boot our stack:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose up</span></code></pre></td></tr></table></div></figure>


<h2>Test Caching</h2>

<p>Once your containers are in a running state, open your browsers devloper tools and look at the networking tab, then access your ghost blog on <code>http://localhost:80/</code>, the first time a image is opened you should see the cache shows <code>MISS</code> when you refresh again you should see a <code>HIT</code>, which means that the object is being returned from your cache.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/06/08/ingesting-pocket-items-into-elasticsearch/">Ingesting Pocket.com Links Into Elasticsearch</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-06-08T23:06:23+02:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:06 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://img.sysadmins.co.za/wngib2.png" alt="python-elasticsearch-pocket" /></p>

<p>Links that I stumble upon, I always save to <a href="https://getpocket.com">getpocket.com</a> and tag them with the relevant info. So the one day I had this random idea to list my links per category on a web service and I was wondering how to approach that scenario, which lead me to this.</p>

<p>In this post we will consume all our saved bookmarks from pocket.com and ingest them into elasticsearch. But we dont want to read all the items from pocket&rsquo;s api every single time when the consumer run, therefore I have a method of checkpointing the last save run with a timestamp, so the next time it runs, we have context where to start from</p>

<h2>What will we be doing</h2>

<p>We will authenticate with pocket, then write the code how we will read the data from pocket and ingest them into elasticsearch.</p>

<h2>Authentication</h2>

<p>Head over to the <a href="https://getpocket.com/developer/apps/new">developer console</a> on pocket and create a new application then save your config in <code>config.py</code> which we will have as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>application_name = "Awesome Links"
</span><span class='line'>application_link = "https://getpocket.com/developer/app/x/x"
</span><span class='line'>application_url = "https://awesome-links.domain"
</span><span class='line'>consumer_key = "x"
</span><span class='line'>access_token = "x"
</span><span class='line'>es_host = ""
</span><span class='line'>es_user = ""
</span><span class='line'>es_pass = ""</span></code></pre></td></tr></table></div></figure>


<p>Ensure that you have the requests library installed (<code>pip install requests</code>), the code that I used to get a access token:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import config
</span><span class='line'>import requests
</span><span class='line'>import webbrowser
</span><span class='line'>import time
</span><span class='line'>
</span><span class='line'>CONSUMER_KEY = config.consumer_key
</span><span class='line'>BASE_URL = "https://getpocket.com"
</span><span class='line'>REDIRECT_URL = "localhost" # &lt;-- you can run python -m SimpleHTTPServer 80 to have a local server listening on port 80
</span><span class='line'>HEADERS = {"Content-Type": "application/json; charset=UTF-8", "X-Accept": "application/json"}
</span><span class='line'>
</span><span class='line'>def request_code():
</span><span class='line'>    payload = {
</span><span class='line'>        "consumer_key": CONSUMER_KEY,
</span><span class='line'>        "redirect_uri": REDIRECT_URL,
</span><span class='line'>    }
</span><span class='line'>    response = requests.post("https://getpocket.com/v3/oauth/request", headers=HEADERS, json=payload)
</span><span class='line'>    print("request_code")
</span><span class='line'>    print(response.json())
</span><span class='line'>    return response.json()["code"]
</span><span class='line'>
</span><span class='line'>def request_access_token(code):
</span><span class='line'>    payload = {
</span><span class='line'>        "consumer_key": CONSUMER_KEY,
</span><span class='line'>        "code": code,
</span><span class='line'>    }
</span><span class='line'>    response = requests.post("https://getpocket.com/v3/oauth/authorize", headers=HEADERS, json=payload)
</span><span class='line'>    print("request_access_token")
</span><span class='line'>    print(response.json())
</span><span class='line'>    time.sleep(10)
</span><span class='line'>    return response.json()["access_token"]
</span><span class='line'>
</span><span class='line'>def request_authorization(code):
</span><span class='line'>    url = "https://getpocket.com/auth/authorize?request_token={code}&redirect_uri={redirect_url}".format(code=code, redirect_url=REDIRECT_URL)
</span><span class='line'>    print("request_authorization")
</span><span class='line'>    print(url)
</span><span class='line'>    webbrowser.open(url, new=2)
</span><span class='line'>
</span><span class='line'>def authenticate_pocket():
</span><span class='line'>    code = request_code()
</span><span class='line'>    request_authorization(code)
</span><span class='line'>    return request_access_token(code)
</span><span class='line'>
</span><span class='line'>authenticate_pocket()
</span><span class='line'># access_token will be returned</span></code></pre></td></tr></table></div></figure>


<h2>Main App</h2>

<p>Once we have our access_token we can save that to our <code>config.py</code>, we will also be working with elasticsearch so we can add our elasticsearch info there as well:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env python
</span><span class='line'>
</span><span class='line'>import config
</span><span class='line'>import requests
</span><span class='line'>import time
</span><span class='line'>
</span><span class='line'>CONSUMER_KEY = config.consumer_key
</span><span class='line'>ACCESS_TOKEN = config.access_token
</span><span class='line'>HEADERS = {"Content-Type": "application/json; charset=UTF-8", "X-Accept": "application/json"}
</span><span class='line'>ES_HOST = config.es_host
</span><span class='line'>ES_USER = config.es_user
</span><span class='line'>ES_PASS = config.es_pass
</span><span class='line'>
</span><span class='line'>def write_checkpoint(timestamp):
</span><span class='line'>    response = requests.put(
</span><span class='line'>        'https://{eshost}/pocket-data/_doc/checkpoint'.format(eshost=ES_HOST),
</span><span class='line'>        auth=(ES_USER, ES_PASS),
</span><span class='line'>        json={
</span><span class='line'>            "checkpoint_timestamp": timestamp
</span><span class='line'>        }
</span><span class='line'>    )
</span><span class='line'>    return {"checkpoint_timestamp": timestamp}
</span><span class='line'>
</span><span class='line'>def get_checkpoint():
</span><span class='line'>    response = requests.get(
</span><span class='line'>        'https://{eshost}/pocket-data/_doc/checkpoint'.format(ES_HOST),
</span><span class='line'>        auth=(ES_USER, ES_PASS)
</span><span class='line'>    )
</span><span class='line'>    checkpoint_timestamp = response.json()['_source']['checkpoint_timestamp']
</span><span class='line'>    return checkpoint_timestamp
</span><span class='line'>
</span><span class='line'>def ingest_to_es(payload):
</span><span class='line'>    response = requests.put(
</span><span class='line'>        'https://{eshost}/pocket-data/_doc/{item_id}'.format(eshost=ES_HOST, item_id=payload['item_id']),
</span><span class='line'>        auth=(ES_USER, ES_PASS),
</span><span class='line'>        json=payload
</span><span class='line'>    )
</span><span class='line'>    return response.json()
</span><span class='line'>
</span><span class='line'>def convert_timestamp(epoch):
</span><span class='line'>    return time.strftime('%Y-%m-%d', time.localtime(int(epoch)))
</span><span class='line'>
</span><span class='line'>def mapper(pocket_item):
</span><span class='line'>    try:
</span><span class='line'>        payload = {
</span><span class='line'>            "item_id": pocket_item['item_id'],
</span><span class='line'>            "time_added": convert_timestamp(pocket_item['time_added']),
</span><span class='line'>            "url": pocket_item['resolved_url'],
</span><span class='line'>            "title": pocket_item['resolved_title'],
</span><span class='line'>            #"excerpt": pocket_item['excerpt'],
</span><span class='line'>            "tags": list(pocket_item['tags'].keys())
</span><span class='line'>        }
</span><span class='line'>    except:
</span><span class='line'>        print("error, item has been skipped:")
</span><span class='line'>        print(pocket_item)
</span><span class='line'>        payload = "skip"
</span><span class='line'>    return payload
</span><span class='line'>
</span><span class='line'>def ingest_pocket_items(payload):
</span><span class='line'>    pocket_items = list()
</span><span class='line'>    pocket_items.extend(payload['list'].keys())
</span><span class='line'>    last_scraped_time = payload['since']
</span><span class='line'>    number_of_items = len(pocket_items)
</span><span class='line'>    print('got {} items from pocket'.format(len(pocket_items)))
</span><span class='line'>    time.sleep(5)
</span><span class='line'>    if len(pocket_items) &gt; 0:
</span><span class='line'>        for pocket_item in pocket_items:
</span><span class='line'>            mapped_payload = mapper(payload['list'][pocket_item])
</span><span class='line'>            #print(mapped_payload)
</span><span class='line'>            if mapped_payload != "skip":
</span><span class='line'>                ingest_to_es(mapped_payload)
</span><span class='line'>            print("Number of items left to ingest: {}".format(number_of_items))
</span><span class='line'>            number_of_items-=1
</span><span class='line'>    else:
</span><span class='line'>        print('nothing new')
</span><span class='line'>    print('writing checkpoint to es: {}'.format(last_scraped_time))
</span><span class='line'>    write_checkpoint(last_scraped_time)
</span><span class='line'>    return 'done'
</span><span class='line'>
</span><span class='line'>def fetch_pocket_items(timestamp):
</span><span class='line'>    response = requests.post(
</span><span class='line'>        "https://getpocket.com/v3/get",
</span><span class='line'>        headers=HEADERS,
</span><span class='line'>        json={
</span><span class='line'>            "consumer_key": CONSUMER_KEY,
</span><span class='line'>            "access_token": ACCESS_TOKEN,
</span><span class='line'>            "state": "all",
</span><span class='line'>            "contentType": "article",
</span><span class='line'>            "sort": "newest",
</span><span class='line'>            "detailType": "complete",
</span><span class='line'>            "since": int(timestamp)
</span><span class='line'>        }
</span><span class='line'>    )
</span><span class='line'>    return response.json()
</span><span class='line'>
</span><span class='line'># get checkpoint
</span><span class='line'>print('getting checkpoint id')
</span><span class='line'>checkpoint_timestamp = get_checkpoint()
</span><span class='line'>print('got checkpoint id: {}'.format(checkpoint_timestamp))
</span><span class='line'>time.sleep(5)
</span><span class='line'>
</span><span class='line'># fetch items from pocket
</span><span class='line'>print('fetch items from pocket')
</span><span class='line'>pocket_response = fetch_pocket_items(checkpoint_timestamp)
</span><span class='line'>
</span><span class='line'># write
</span><span class='line'>print('ingesting pocket items into es')
</span><span class='line'>ingest_pocket_items(pocket_response)</span></code></pre></td></tr></table></div></figure>


<p>So what we are doing here is that we are reading from the pocket api all the data that you saved in your account, and save the current time in epoch format, which we will need to tell our run when was the last time we consumed and keep that value in memory.</p>

<p>Then from the data we received, we will map the data that we are interested in, into key/value pairs and then ingest the data into elasticsearch.</p>

<p>After the initial ingestion has been done, which can take some time depending on how many items you have on pocket, as soon as it&rsquo;s done it will write the checkpoint time to elasticsearch so that the client know the next time from what time to search from again.</p>

<p>This way we dont ingest all the items again, testing it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python server.py
</span><span class='line'>getting checkpoint id
</span><span class='line'>got checkpoint id: 1591045652
</span><span class='line'>fetch items from pocket
</span><span class='line'>ingesting pocket items into es
</span><span class='line'>got 2 items from pocket
</span><span class='line'>Number of items left to ingest: 2
</span><span class='line'>Number of items left to ingest: 1
</span><span class='line'>writing checkpoint to es: 1591392580</span></code></pre></td></tr></table></div></figure>


<p>Add one more item to pocket, then run our ingester again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python server.py
</span><span class='line'>getting checkpoint id
</span><span class='line'>got checkpoint id: 1591392580
</span><span class='line'>fetch items from pocket
</span><span class='line'>ingesting pocket items into es
</span><span class='line'>got 1 items from pocket
</span><span class='line'>Number of items left to ingest: 1
</span><span class='line'>writing checkpoint to es: 1591650259</span></code></pre></td></tr></table></div></figure>


<p>Search for one document on elasticsearch:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -u user:pass 'https://es.domain/pocket-data/_search?pretty=true&size=1'
</span><span class='line'>{
</span><span class='line'>  "took" : 194,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 766,
</span><span class='line'>    "max_score" : 1.0,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "pocket-data",
</span><span class='line'>        "_type" : "_doc",
</span><span class='line'>        "_id" : "2676106577",
</span><span class='line'>        "_score" : 1.0,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "item_id" : "2676106577",
</span><span class='line'>          "time_added" : "2020-05-03",
</span><span class='line'>          "url" : "https://programmaticponderings.com/2019/07/30/managing-aws-infrastructure-as-code-using-ansible-cloudformation-and-codebuild/",
</span><span class='line'>          "title" : "Managing AWS Infrastructure as Code using Ansible, CloudFormation, and CodeBuild",
</span><span class='line'>          "tags" : [
</span><span class='line'>            "ansible",
</span><span class='line'>            "aws",
</span><span class='line'>            "cicd",
</span><span class='line'>            "cloudformation",
</span><span class='line'>            "devops"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Search for aws tags:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -u x:x 'https://es.domain/pocket-data/_search?q=tags:aws&pretty=true&size=1'
</span><span class='line'>{
</span><span class='line'>  "took" : 101,
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "_shards" : {
</span><span class='line'>    "total" : 5,
</span><span class='line'>    "successful" : 5,
</span><span class='line'>    "skipped" : 0,
</span><span class='line'>    "failed" : 0
</span><span class='line'>  },
</span><span class='line'>  "hits" : {
</span><span class='line'>    "total" : 112,
</span><span class='line'>    "max_score" : 2.6346242,
</span><span class='line'>    "hits" : [
</span><span class='line'>      {
</span><span class='line'>        "_index" : "pocket-data",
</span><span class='line'>        "_type" : "_doc",
</span><span class='line'>        "_id" : "2673747670",
</span><span class='line'>        "_score" : 2.6346242,
</span><span class='line'>        "_source" : {
</span><span class='line'>          "item_id" : "2673747670",
</span><span class='line'>          "time_added" : "2019-07-28",
</span><span class='line'>          "url" : "https://github.com/lgoodridge/serverless-chat",
</span><span class='line'>          "title" : "lgoodridge/serverless-chat",
</span><span class='line'>          "tags" : [
</span><span class='line'>            "aws"
</span><span class='line'>          ]
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Now what</h2>

<p>Now that our data is in elasticsearch, we can build a search engine or a web application that can list our favorite links per category. I wil write up a post on the search engine in the future.</p>

<h2>Thank You</h2>

<p>If you liked this please send me a shout out on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/05/16/using-python-rq-for-task-queues-in-python/">Using Python RQ for Task Queues in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-05-16T21:12:36+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>9:12 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a getting started on python-rq tutorial and I will demonstrate how to work with asynchronous tasks using python redis queue (python-rq).</p>

<h2>What will we be doing</h2>

<p>We want a client to submit 1000&rsquo;s of jobs in a non-blocking asynchronous fashion, and then we will have workers which will consume these jobs from our redis queue, and process those tasks at the rate of what our consumer can handle.</p>

<p>The nice thing about this is that, if our consumer is unavailable for processing the tasks will remain in the queue and once the consumer is ready to consume, the tasks will be executed. It&rsquo;s also nice that its asynchronous, so the client don&rsquo;t have to wait until the task has finished.</p>

<p>We will run a redis server using docker, which will be used to queue all our jobs, then we will go through the basics in python and python-rq such as:</p>

<ul>
<li>Writing a Task</li>
<li>Enqueueing a Job</li>
<li>Getting information from our queue, listing jobs, job statuses</li>
<li>Running our workers to consume from the queue and action our tasks</li>
<li>Basic application which queues jobs to the queue, consumes and action them and monitors the queue</li>
</ul>


<h2>Redis Server</h2>

<p>You will require docker for this next step, to start the redis server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run --rm -itd --name redis -p 6379:6379 redis:alpine</span></code></pre></td></tr></table></div></figure>


<h2>Python RQ</h2>

<p>Install python-rq:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip install rq</span></code></pre></td></tr></table></div></figure>


<p>Create the task which will be actioned by our workers, in our case it will just be a simple function that adds all the numbers from a given string to a list, then adds them up and return the total value.</p>

<p>This is however a very basic task, but its just for demonstration.</p>

<p>Our <code>tasks.py</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def sum_numbers_from_string(string):
</span><span class='line'>    numbers = []
</span><span class='line'>    for each_character in string:
</span><span class='line'>        if each_character.isdigit():
</span><span class='line'>            numbers.append(int(each_character))
</span><span class='line'>    total = 0
</span><span class='line'>    for each_number in numbers:
</span><span class='line'>        total=total+each_number
</span><span class='line'>
</span><span class='line'>    return total</span></code></pre></td></tr></table></div></figure>


<p>To test this locally:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; from tasks import sum_numbers_from_string
</span><span class='line'>&gt;&gt;&gt; sum_numbers_from_string('adje-fje5-sjfdu1s-gdj9-asd1fg')
</span><span class='line'>16</span></code></pre></td></tr></table></div></figure>


<p>Now, lets import redis and redis-queue, with our tasks and instantiate a queue object:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; from redis import Redis
</span><span class='line'>&gt;&gt;&gt; from rq import Connection, Queue, Worker
</span><span class='line'>&gt;&gt;&gt; from tasks import sum_numbers_from_string
</span><span class='line'>&gt;&gt;&gt; redis_connection = Redis(host='localhost', port=6379, db=0)
</span><span class='line'>&gt;&gt;&gt; q = Queue(connection=redis_connection)</span></code></pre></td></tr></table></div></figure>


<h2>Submit a Task to the Queue</h2>

<p>Let&rsquo;s submit a task to the queue:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; result = q.enqueue(sum_numbers_from_string, 'hbj2-plg5-2xf4r1s-f2lf-9sx4ff')</span></code></pre></td></tr></table></div></figure>


<p>We have a couple of properties from <code>result</code> which we can inspect, first let&rsquo;s have a look at the id that we got back when we submitted our task to the queue:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; result.get_id()
</span><span class='line'>'5a607474-cf1b-4fa5-9adb-f8437555a7e7'</span></code></pre></td></tr></table></div></figure>


<p>We can also get the status from our task:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; result.get_status()
</span><span class='line'>'queued'</span></code></pre></td></tr></table></div></figure>


<p>We can also view our results in json format:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; import json
</span><span class='line'>&gt;&gt;&gt; print(json.dumps(result.to_dict(), indent=2, default=str))
</span><span class='line'>{
</span><span class='line'>  "created_at": "2020-05-16T11:56:49.892713Z",
</span><span class='line'>  "data": "b'..\\x00\\x99\\xa0\\x16\\xfe..'",
</span><span class='line'>  "origin": "default",
</span><span class='line'>  "description": "tasks.sum_numbers_from_string('hbj2-plg5-2xf4r1s-f2lf-9sx4ff')",
</span><span class='line'>  "enqueued_at": "2020-05-16T11:56:49.893252Z",
</span><span class='line'>  "started_at": "",
</span><span class='line'>  "ended_at": "",
</span><span class='line'>  "timeout": 180,
</span><span class='line'>  "status": "queued"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>If we dont have context of the job id, we can use <code>get_jobs</code> to get all the jobs which is queued:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; list_jobs = q.get_jobs
</span><span class='line'>&gt;&gt;&gt; list_jobs()
</span><span class='line'>[Job('5a607474-cf1b-4fa5-9adb-f8437555a7e7', enqueued_at=datetime.datetime(2020, 5, 16, 12, 30, 22, 699609))]</span></code></pre></td></tr></table></div></figure>


<p>Then we can loop through the results and get the id like below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; for j in list_jobs():
</span><span class='line'>...     j.id
</span><span class='line'>...
</span><span class='line'>'5a607474-cf1b-4fa5-9adb-f8437555a7e7'</span></code></pre></td></tr></table></div></figure>


<p>Or to get the job id&rsquo;s in a list:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; list_job_ids = q.get_job_ids()
</span><span class='line'>&gt;&gt;&gt; list_job_ids
</span><span class='line'>['5a607474-cf1b-4fa5-9adb-f8437555a7e7']</span></code></pre></td></tr></table></div></figure>


<p>Since we received the job id, we can use <code>fetch_job</code> to get more info about the job:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; fetched_job = q.fetch_job('5a607474-cf1b-4fa5-9adb-f8437555a7e7')
</span><span class='line'>&gt;&gt;&gt; fetched_job
</span><span class='line'>Job('5a607474-cf1b-4fa5-9adb-f8437555a7e7', enqueued_at=datetime.datetime(2020, 5, 16, 12, 30, 22, 699609))</span></code></pre></td></tr></table></div></figure>


<p>And as before we can view it in json format:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; fetched_job.to_dict()
</span><span class='line'>{'created_at': '2020-05-16T12:30:22.698728Z', 'data': b'..x\x9c6\xfe..', 'origin': 'queue1', 'description': "tasks.sum_numbers_from_string('hbj2-plg5-2xf4r1s-f2lf-9sx4ff')", 'enqueued_at': '2020-05-16T12:30:22.699609Z', 'started_at': '', 'ended_at': '', 'timeout': 180, 'status': 'queued'}</span></code></pre></td></tr></table></div></figure>


<p>We can also view the key in redis by passing the job_id:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; result.key_for(job_id='5a607474-cf1b-4fa5-9adb-f8437555a7e7')
</span><span class='line'>b'rq:job:5a607474-cf1b-4fa5-9adb-f8437555a7e7'</span></code></pre></td></tr></table></div></figure>


<p>To view how many jobs are in our queue, we can either do:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; len(q)
</span><span class='line'>1</span></code></pre></td></tr></table></div></figure>


<p>or:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; q.get_job_ids()
</span><span class='line'>['5a607474-cf1b-4fa5-9adb-f8437555a7e7']</span></code></pre></td></tr></table></div></figure>


<h2>Consuming from the Queue</h2>

<p>Now that our task is queued, let&rsquo;s fire of our worker to consume the job from the queue and action the task:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; w = Worker([q], connection=redis_connection)
</span><span class='line'>&gt;&gt;&gt; w.work()
</span><span class='line'>14:05:35 Worker rq:worker:49658973741d4085961e34e9641227dd: started, version 1.4.1
</span><span class='line'>14:05:35 Listening on default...
</span><span class='line'>14:05:35 Cleaning registries for queue: default
</span><span class='line'>14:05:35 default: tasks.sum_numbers_from_string('hbj2-plg5-2xf4r1s-f2lf-9sx4ff') (5a607474-cf1b-4fa5-9adb-f8437555a7e7)
</span><span class='line'>14:05:40 default: Job OK (5a607474-cf1b-4fa5-9adb-f8437555a7e7)
</span><span class='line'>14:05:40 Result is kept for 500 seconds
</span><span class='line'>14:05:59 Warm shut down requested
</span><span class='line'>True</span></code></pre></td></tr></table></div></figure>


<p>Now, when we get the status of our job, you will see that it finished:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; result.get_status()
</span><span class='line'>'finished'</span></code></pre></td></tr></table></div></figure>


<p>And to get the result from our worker:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; result.result
</span><span class='line'>29</span></code></pre></td></tr></table></div></figure>


<p>And like before, if you dont have context of your job id, you can get the job id, then return the result:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; result = fetched_job = q.fetch_job('5a607474-cf1b-4fa5-9adb-f8437555a7e7')
</span><span class='line'>&gt;&gt;&gt; result.result
</span><span class='line'>29</span></code></pre></td></tr></table></div></figure>


<h2>Naming Queues</h2>

<p>We can namespace our tasks into specific queues, for example if we want to create <code>queue1</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; q1 = Queue('queue1', connection=redis_connection)</span></code></pre></td></tr></table></div></figure>


<p>To verify the queue name:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; q1
</span><span class='line'>Queue('queue1')</span></code></pre></td></tr></table></div></figure>


<p>As we can see our queue is empty:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; q1.get_job_ids()
</span><span class='line'>[]</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s submit 10 jobs to our queue:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; from uuid import uuid4
</span><span class='line'>&gt;&gt;&gt; for attempt in range(0,10):
</span><span class='line'>...     random_string = uuid4().hex
</span><span class='line'>...     q1.enqueue(sum_numbers_from_string, random_string)
</span><span class='line'>...
</span><span class='line'>Job('c3f2369d-5b27-40e0-97be-8fe26989a78e', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 472508))
</span><span class='line'>Job('06b93517-5dae-4133-8131-e8d35b8dd780', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 475604))
</span><span class='line'>Job('81f05aef-4bd6-421b-912d-78b5d419b10a', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 478071))
</span><span class='line'>Job('8f14e81f-74fa-44d9-9fc7-e8e7b8c7b76f', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 480438))
</span><span class='line'>Job('e8552750-89d2-4538-8c3e-a48c4c3e9a51', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 483106))
</span><span class='line'>Job('bf19a0a3-eb0c-4692-b452-67c5ad954094', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 486193))
</span><span class='line'>Job('0da3688a-cffa-4ba6-a272-b6cc90942ef6', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 488545))
</span><span class='line'>Job('717bd147-615c-458d-8386-9ea6a198e137', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 491074))
</span><span class='line'>Job('7cdac5aa-8dc3-40be-a8fc-b273ce61b03b', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 493618))
</span><span class='line'>Job('4f7ea527-0695-4e2b-bc8b-3d8807a86390', enqueued_at=datetime.datetime(2020, 5, 16, 13, 1, 14, 496930))</span></code></pre></td></tr></table></div></figure>


<p>To verify the number of jobs in our queue:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; q1.get_job_ids()
</span><span class='line'>['c3f2369d-5b27-40e0-97be-8fe26989a78e', '06b93517-5dae-4133-8131-e8d35b8dd780', '81f05aef-4bd6-421b-912d-78b5d419b10a', '8f14e81f-74fa-44d9-9fc7-e8e7b8c7b76f', 'e8552750-89d2-4538-8c3e-a48c4c3e9a51', 'bf19a0a3-eb0c-4692-b452-67c5ad954094', '0da3688a-cffa-4ba6-a272-b6cc90942ef6', '717bd147-615c-458d-8386-9ea6a198e137', '7cdac5aa-8dc3-40be-a8fc-b273ce61b03b', '4f7ea527-0695-4e2b-bc8b-3d8807a86390']</span></code></pre></td></tr></table></div></figure>


<p>And to count them:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; len(q1)
</span><span class='line'>10</span></code></pre></td></tr></table></div></figure>


<h2>Cleaning the Queue</h2>

<p>Cleaning the queue can either be done with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; q.empty()
</span><span class='line'>10</span></code></pre></td></tr></table></div></figure>


<p>or</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; q.delete(delete_jobs=True)</span></code></pre></td></tr></table></div></figure>


<p>Then to verify that our queue is clean:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; q.get_job_ids()
</span><span class='line'>[]</span></code></pre></td></tr></table></div></figure>


<h2>Naming Workers</h2>

<p>The same way that we defined a name for our queue, we can define a name for our workers:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; worker = Worker([q1], connection=redis_connection, name='worker1')
</span><span class='line'>&gt;&gt;&gt; worker.work()</span></code></pre></td></tr></table></div></figure>


<p>Which means you can have different workers consuming jobs from specific queues.</p>

<h2>Resources</h2>

<p>Documentation:</p>

<ul>
<li><a href="https://python-rq.org/docs/">https://python-rq.org/docs/</a></li>
<li><a href="https://python-rq.org/docs/workers/">https://python-rq.org/docs/workers/</a></li>
<li><a href="https://python-rq.org/docs/monitoring/">https://python-rq.org/docs/monitoring/</a></li>
</ul>


<h2>Thank You</h2>

<p>I hope this was usful, if you enjoyed this come say hi on Twitter <a href="https://twitter.com/ruanbekker">@ruanbekker</a> or visit my website at <a href="https://ruan.dev">ruan.dev</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/05/09/selecting-and-returning-specific-data-with-jq/">Selecting and Returning Specific Data With JQ</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-05-09T22:23:00+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>10:23 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was working with curl to get data from a api, and wanted to get a specific url for a specific name within an array. I got it working using jq, and will be demonstrating how I got it working.</p>

<p>The data:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat data.json | jq .
</span><span class='line'>{
</span><span class='line'>  "tag_name": "v1.17.5+k3s1",
</span><span class='line'>  "name": "v1.17.5+k3s1",
</span><span class='line'>  "assets": [
</span><span class='line'>    {
</span><span class='line'>      "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496869",
</span><span class='line'>      "id": 20496869,
</span><span class='line'>      "name": "e2e-passed-amd64-parallel.log",
</span><span class='line'>      "state": "uploaded",
</span><span class='line'>      "size": 1125136,
</span><span class='line'>      "download_count": 3,
</span><span class='line'>      "created_at": "2020-05-07T00:00:45Z",
</span><span class='line'>      "updated_at": "2020-05-07T00:00:46Z",
</span><span class='line'>      "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/e2e-passed-amd64-parallel.log"
</span><span class='line'>    },
</span><span class='line'>    {
</span><span class='line'>      "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496281",
</span><span class='line'>      "id": 20496281,
</span><span class='line'>      "name": "k3s",
</span><span class='line'>      "state": "uploaded",
</span><span class='line'>      "size": 52740096,
</span><span class='line'>      "download_count": 887,
</span><span class='line'>      "created_at": "2020-05-06T23:45:02Z",
</span><span class='line'>      "updated_at": "2020-05-06T23:45:03Z",
</span><span class='line'>      "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s"
</span><span class='line'>    },
</span><span class='line'>    {
</span><span class='line'>      "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496655",
</span><span class='line'>      "id": 20496655,
</span><span class='line'>      "name": "k3s-armhf",
</span><span class='line'>      "state": "uploaded",
</span><span class='line'>      "size": 48431104,
</span><span class='line'>      "download_count": 95,
</span><span class='line'>      "created_at": "2020-05-06T23:48:05Z",
</span><span class='line'>      "updated_at": "2020-05-06T23:48:06Z",
</span><span class='line'>      "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s-armhf"
</span><span class='line'>    }
</span><span class='line'>  ],
</span><span class='line'>  "tarball_url": "",
</span><span class='line'>  "zipball_url": "",
</span><span class='line'>  "body": ""
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Getting the json objects inside the array &ldquo;assets&rdquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat data.json | jq '.assets[]'
</span><span class='line'>{
</span><span class='line'>  "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496869",
</span><span class='line'>  "id": 20496869,
</span><span class='line'>  "name": "e2e-passed-amd64-parallel.log",
</span><span class='line'>  "state": "uploaded",
</span><span class='line'>  "size": 1125136,
</span><span class='line'>  "download_count": 3,
</span><span class='line'>  "created_at": "2020-05-07T00:00:45Z",
</span><span class='line'>  "updated_at": "2020-05-07T00:00:46Z",
</span><span class='line'>  "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/e2e-passed-amd64-parallel.log"
</span><span class='line'>}
</span><span class='line'>{
</span><span class='line'>  "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496281",
</span><span class='line'>  "id": 20496281,
</span><span class='line'>  "name": "k3s",
</span><span class='line'>  "state": "uploaded",
</span><span class='line'>  "size": 52740096,
</span><span class='line'>  "download_count": 887,
</span><span class='line'>  "created_at": "2020-05-06T23:45:02Z",
</span><span class='line'>  "updated_at": "2020-05-06T23:45:03Z",
</span><span class='line'>  "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s"
</span><span class='line'>}
</span><span class='line'>{
</span><span class='line'>  "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496655",
</span><span class='line'>  "id": 20496655,
</span><span class='line'>  "name": "k3s-armhf",
</span><span class='line'>  "state": "uploaded",
</span><span class='line'>  "size": 48431104,
</span><span class='line'>  "download_count": 95,
</span><span class='line'>  "created_at": "2020-05-06T23:48:05Z",
</span><span class='line'>  "updated_at": "2020-05-06T23:48:06Z",
</span><span class='line'>  "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s-armhf"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Data containing &ldquo;k3s&rdquo; under the &ldquo;name&rdquo; key::</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat data.json | jq '.assets[] | select(.name | contains("3s"))'
</span><span class='line'>{
</span><span class='line'>  "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496281",
</span><span class='line'>  "id": 20496281,
</span><span class='line'>  "name": "k3s",
</span><span class='line'>  "state": "uploaded",
</span><span class='line'>  "size": 52740096,
</span><span class='line'>  "download_count": 887,
</span><span class='line'>  "created_at": "2020-05-06T23:45:02Z",
</span><span class='line'>  "updated_at": "2020-05-06T23:45:03Z",
</span><span class='line'>  "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s"
</span><span class='line'>}
</span><span class='line'>{
</span><span class='line'>  "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496655",
</span><span class='line'>  "id": 20496655,
</span><span class='line'>  "name": "k3s-armhf",
</span><span class='line'>  "state": "uploaded",
</span><span class='line'>  "size": 48431104,
</span><span class='line'>  "download_count": 95,
</span><span class='line'>  "created_at": "2020-05-06T23:48:05Z",
</span><span class='line'>  "updated_at": "2020-05-06T23:48:06Z",
</span><span class='line'>  "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s-armhf"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Data that starts with &ldquo;k3s&rdquo; under the &ldquo;name&rdquo; key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat data.json | jq '.assets[] | select(.name | startswith("k3s"))'
</span><span class='line'>{
</span><span class='line'>  "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496281",
</span><span class='line'>  "id": 20496281,
</span><span class='line'>  "name": "k3s",
</span><span class='line'>  "state": "uploaded",
</span><span class='line'>  "size": 52740096,
</span><span class='line'>  "download_count": 887,
</span><span class='line'>  "created_at": "2020-05-06T23:45:02Z",
</span><span class='line'>  "updated_at": "2020-05-06T23:45:03Z",
</span><span class='line'>  "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s"
</span><span class='line'>}
</span><span class='line'>{
</span><span class='line'>  "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496655",
</span><span class='line'>  "id": 20496655,
</span><span class='line'>  "name": "k3s-armhf",
</span><span class='line'>  "state": "uploaded",
</span><span class='line'>  "size": 48431104,
</span><span class='line'>  "download_count": 95,
</span><span class='line'>  "created_at": "2020-05-06T23:48:05Z",
</span><span class='line'>  "updated_at": "2020-05-06T23:48:06Z",
</span><span class='line'>  "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s-armhf"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Data with the exact name is &ldquo;k3s&rdquo;:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat data.json | jq '.assets[] | select(.name == "k3s")'
</span><span class='line'>{
</span><span class='line'>  "url": "https://api.github.com/repos/rancher/k3s/releases/assets/20496281",
</span><span class='line'>  "id": 20496281,
</span><span class='line'>  "name": "k3s",
</span><span class='line'>  "state": "uploaded",
</span><span class='line'>  "size": 52740096,
</span><span class='line'>  "download_count": 887,
</span><span class='line'>  "created_at": "2020-05-06T23:45:02Z",
</span><span class='line'>  "updated_at": "2020-05-06T23:45:03Z",
</span><span class='line'>  "browser_download_url": "https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Getting only the &ldquo;browser_download_url&rdquo; value from the match:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat data.json | jq '.assets[] | select(.name == "k3s") | .browser_download_url'
</span><span class='line'>"https://github.com/rancher/k3s/releases/download/v1.17.5%2Bk3s1/k3s"</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/05/08/server-backups-to-google-drive-using-the-drive-cli-tool/">Server Backups to Google Drive Using the Drive CLI Tool</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-05-08T18:43:35+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>6:43 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This tutorial will demonstrate how I ship my backups to Google Drive using the <a href="https://github.com/odeke-em/drive/releases/">drive</a> cli utility.</p>

<p>What I really like about the drive cli tool, is that it&rsquo;s super easy to setup and you can easily script your backups to ship it to google drive.</p>

<h2>What we will be doing</h2>

<p>We will setup the drive cli tool, authorize it with your google account, then show how to upload your files to google drive from your terminal and then create a script to automatically upload your data to google drive and then include it in a cronjob.</p>

<h2>Setup Drive CLI Tool</h2>

<p>Head over to the <a href="https://github.com/odeke-em/drive/releases/">drive releases</a> page and get the latest version, at the moment of writing 0.3.9 is the latest. Then we will move it to our path and make it executable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://github.com/odeke-em/drive/releases/download/v0.3.9/drive_linux
</span><span class='line'>$ mv drive_linux /usr/bin/gdrive
</span><span class='line'>$ chmod +x /usr/bin/gdrive</span></code></pre></td></tr></table></div></figure>


<p>You should be getting a output when running version as an argument:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gdrive version
</span><span class='line'>drive version: 0.3.9</span></code></pre></td></tr></table></div></figure>


<h2>Credentials</h2>

<p>Move to your home directory and initialize, this will ask you to access the google accounts web page, where you will be authorizing this application to use your google drive account. Upon succesful authorization, you will get a authorization code that we will need to paste in our terminal.</p>

<p>This will then write the credentials file to ~/.gd/credentials.json`. <strong>Always</strong> remember to keep this file safe.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gdrive init
</span><span class='line'>Visit this URL to get an authorization code
</span><span class='line'>https://accounts.google.com/o/oauth2/auth?access_type=offline&client_id=x&redirect_uri=x&response_type=code&scope=x&state=x
</span><span class='line'>Paste the authorization code: &lt; paste authorization code here &gt;</span></code></pre></td></tr></table></div></figure>


<p>You will now see that the credentials for your application has been saved as seen below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.gd/credentials.json
</span><span class='line'>{"client_id":"&lt;redacted&gt;","client_secret":"&lt;redacted&gt;","refresh_token":"&lt;redacted&gt;"}</span></code></pre></td></tr></table></div></figure>


<h2>Backup to Google Drive</h2>

<p>On Google Drive, I have a backup folder named <code>Backups</code> and in my local path <code>/opt/backups/</code>, which has the files that I want to backup to google drive:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ls /opt/backups/
</span><span class='line'>app.backup-2020-05-05.tar.gz  
</span><span class='line'>app.backup-2020-05-06.tar.gz</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s backup the files to Google Drive, it works as follows <code>gdrive push -destination (path on google drive) (path on local drive)</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gdrive push -destination Backups/demo/app1 /opt/backups/*
</span><span class='line'>Resolving...
</span><span class='line'>+ /Backups/demo/app1/app.backup-2020-05-05.tar.gz
</span><span class='line'>+ /Backups/demo/app1/app.backup-2020-05-06.tar.gz
</span><span class='line'>Addition count 2 src: 26.32MB
</span><span class='line'>Proceed with the changes? [Y/n]:Y</span></code></pre></td></tr></table></div></figure>


<p>As you can see it checks what is on Google Drive and what is on the Local Drive, then determines what needs to be uploaded, and asks you if you want to continue.</p>

<p>If we run that command again, you will see that it does not upload it again, as the content is already on Google Drive:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gdrive push -destination Backups/demo/app1 /opt/backups/*
</span><span class='line'>Resolving...
</span><span class='line'>Everything is up-to-date.</span></code></pre></td></tr></table></div></figure>


<p>To test it out, let&rsquo;s create a new file and verify if it only uploads the new file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ touch file.txt
</span><span class='line'>$ gdrive push -destination Backups/demo/app1 /opt/backups/*
</span><span class='line'>Resolving...
</span><span class='line'>+ /Backups/demo/app1/file.txt
</span><span class='line'>Addition count 1
</span><span class='line'>Proceed with the changes? [Y/n]:y</span></code></pre></td></tr></table></div></figure>


<p>That is all cool and all, but if we want to script this, we don&rsquo;t want to be prompted to continue, we can do this by adding a argument <code>-quiet</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gdrive push -quiet -destination Backups/demo/app1 /opt/*</span></code></pre></td></tr></table></div></figure>


<h2>Scripting our Backup Task</h2>

<p>Let&rsquo;s create a script that makes a local archive, then uploads it to Google Drive, I will create the file: <code>/opt/scripts/backup.sh</code> with the following content:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'># make a local archive
</span><span class='line'>tar -zcvf /opt/backups/app1.backup-$(date +%F).tar.gz \
</span><span class='line'>  /home/me/data/dir1 \
</span><span class='line'>  /home/me/data/dir2 \
</span><span class='line'>  /home/me/data/dir3 \
</span><span class='line'>  /home/me/data/dir4 
</span><span class='line'>
</span><span class='line'># backup to gdrive
</span><span class='line'>sleep 1
</span><span class='line'>gdrive push -quiet -destination Backups/Servers/sysadmins.co.za /opt/backups/sysadmins-blog/*
</span><span class='line'>
</span><span class='line'># delete archives older than 14 days from disk
</span><span class='line'>sleep 1
</span><span class='line'>find /opt/backups/ -type f -name "*.tar.gz" -mtime +14 -exec rm {} \;</span></code></pre></td></tr></table></div></figure>


<p>Make the file executable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod +x /opt/scripts/backup.sh</span></code></pre></td></tr></table></div></figure>


<p>Then, we want to add it as a cronjob so that it runs every night at 23:10 in my case:</p>

<p>Open crotab: <code>crontab -e</code> and add the following entry:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>10 23 * * * /opt/scripts/backup.sh</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Backups are important, especially when you rely on them, and it was never made. Plan ahead to not be in that situation.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/05/05/how-to-setup-a-redis-exporter-for-prometheus/">How to Setup a Redis Exporter for Prometheus</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-05-05T23:14:52+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>11:14 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will visualize our Redis Cluster&rsquo;s Metrics with Grafana. In order to do that we will setup a <a href="https://github.com/oliver006/redis_exporter">redis exporter</a> which will authenticate with redis and then configure prometheus to scrape the endpoint of the redis exporter&rsquo;s http endpoint to write the time series data to prometheus.</p>

<h2>Install Golang</h2>

<p>We need to build a binary from the redis exporter project, and we need a Golang environment. If you don&rsquo;t have golang installed already:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /tmp/
</span><span class='line'>$ wget https://dl.google.com/go/go1.14.2.linux-amd64.tar.gz
</span><span class='line'>$ tar -xf go1.14.2.linux-amd64.tar.gz -C /usr/local
</span><span class='line'>$ mkdir -p $HOME/go/{bin,src,pkg}
</span><span class='line'>$ export GOPATH=/go
</span><span class='line'>$ export PATH=${PATH}:${GOPATH}/bin:/usr/local/go/bin</span></code></pre></td></tr></table></div></figure>


<p>You should now be able to get a response:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go version
</span><span class='line'>go version go1.14.2 linux/amd64</span></code></pre></td></tr></table></div></figure>


<h2>Redis Exporter</h2>

<p>Get the source code and build the binary:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/oliver006/redis_exporter.git
</span><span class='line'>$ cd redis_exporter
</span><span class='line'>$ go build .</span></code></pre></td></tr></table></div></figure>


<p>Now the binary should be built, and you should be able to get a response when running the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./redis_exporter --help</span></code></pre></td></tr></table></div></figure>


<p>Copy the binary the the following path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp redis_exporter /usr/bin/</span></code></pre></td></tr></table></div></figure>


<p>Then create the systemd unit file, in <code>/etc/systemd/system/redis_exporter.service</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=Redis Exporter
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=root
</span><span class='line'>Group=root
</span><span class='line'>Type=simple
</span><span class='line'>ExecStart=/usr/bin/redis_exporter \
</span><span class='line'>    -web.listen-address ":9121" \
</span><span class='line'>    -redis.addr "redis://ip.of.redis.server:6379" \
</span><span class='line'>    -redis.password "your-strong-redis-password"
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Reload systemd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-relaod</span></code></pre></td></tr></table></div></figure>


<p>Then start the redis exporter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart redis_exporter</span></code></pre></td></tr></table></div></figure>


<p>Now you should be able to get redis metrics when you hit the redis exporter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://127.0.0.1:9121/metrics
</span><span class='line'>...
</span><span class='line'># TYPE redis_commands_duration_seconds_total counter
</span><span class='line'>redis_commands_duration_seconds_total{cmd="auth"} 0.000308
</span><span class='line'>redis_commands_duration_seconds_total{cmd="client"} 0.000251
</span><span class='line'>redis_commands_duration_seconds_total{cmd="config"} 0.010594
</span><span class='line'>redis_commands_duration_seconds_total{cmd="evalsha"} 229.214873
</span><span class='line'>redis_commands_duration_seconds_total{cmd="get"} 0.002343
</span><span class='line'>redis_commands_duration_seconds_total{cmd="info"} 0.013722
</span><span class='line'>redis_commands_duration_seconds_total{cmd="latency"} 0.000557
</span><span class='line'>redis_commands_duration_seconds_total{cmd="lrange"} 11.102069
</span><span class='line'>redis_commands_duration_seconds_total{cmd="ltrim"} 3.731263
</span><span class='line'>redis_commands_duration_seconds_total{cmd="ping"} 2e-05
</span><span class='line'>redis_commands_duration_seconds_total{cmd="rpush"} 3.460981
</span><span class='line'>redis_commands_duration_seconds_total{cmd="script"} 0.008393
</span><span class='line'>redis_commands_duration_seconds_total{cmd="set"} 0.001329
</span><span class='line'>redis_commands_duration_seconds_total{cmd="slowlog"} 0.001308
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<h2>Configure Prometheus</h2>

<p>If you don&rsquo;t have prometheus setup, you can <a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">view this blogpost</a> to get it setup.</p>

<p>Then configure your <code>prometheus.yml</code> and add the target to scrape the redis exporter endpoint to write the time series data into prometheus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: redis_exporter
</span><span class='line'>    static_configs:
</span><span class='line'>    - targets: ['ip.of.redis.exporter:9121']</span></code></pre></td></tr></table></div></figure>


<p>Then restart prometheus, if you have docker redeploy your stack or prometheus container. For prometheus as a service you can use <code>systemctl restart prometheus</code>, depending on your operating system distribution.</p>

<h2>Grafana</h2>

<p>Head over to Grafana, if you don&rsquo;t have Grafana, you can <a href="https://blog.ruanbekker.com/blog/2019/05/17/install-grafana-to-visualize-your-metrics-from-datasources-such-as-prometheus-on-linux/">view this post</a> to install Grafana.</p>

<p>Then import the dashboard <a href="https://grafana.com/grafana/dashboards/763">763</a> and after some time, you should see a dashboard more or less like this:</p>

<p><img width="1280" alt="image" src="https://user-images.githubusercontent.com/567298/81118917-0b58f880-8f2a-11ea-941a-b43696fab9b0.png"></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/5">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/3">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2021/05/03/setup-a-crypto-digibyte-full-node-on-linux/">Setup a Crypto Digibyte Full Node on Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/04/06/install-concourse-ci-v6-on-ubuntu-20-dot-04/">Install Concourse CI V6 on Ubuntu 20.04</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/wireguard-vpn-with-unbound-ads-blocking-dns/">Wireguard VPN With Unbound ADS Blocking DNS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/ssh-using-aws-ssm-session-manager/">SSH Using AWS SSM Session Manager</a>
      </li>
    
      <li class="post">
        <a href="/blog/2021/03/10/bypass-the-medium-paywall-system/">Bypass the Medium Paywall System</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest cheatsheets in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com"><img src="https://user-images.githubusercontent.com/567298/97010485-c2334a00-1545-11eb-9e1d-2333e5148da1.png" width="290" height="900"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
