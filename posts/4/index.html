
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="Task (aka Taskfile) is a task runner written in Go, which is similar to GNU Make, but in my opinion is a lot easier to use as you specify your tasks &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/posts/4/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script async defer data-website-id="2cfa7c36-c1f7-48fd-949c-2e5e8a1d873d" src="https://umami-analytics.ruan.dev/umami.js"></script>

  <!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1100086574264181"
     crossorigin="anonymous"></script>

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/08/01/task-runner-with-yaml-config-written-in-go/">Task Runner With YAML Config Written in Go</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-08-01T06:11:54-04:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2021</span></span> <span class='time'>6:11 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://blog.ruanbekker.com/images/ruanbekker-header-photo.png" alt="" /></p>

<p><a href="https://taskfile.dev/">Task</a> (aka Taskfile) is a task runner written in <a href="https://golang.org/">Go</a>, which is similar to GNU Make, but in my opinion is a lot easier to use as you specify your tasks in yaml.</p>

<h2>What to expect</h2>

<p>In this post we will go through a quick demonstration using Task, how to install Task, as well as a couple of basic examples to get you up and running with Task.</p>

<h2>Install</h2>

<p>For mac, installing task::</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install go-task/tap/go-task
</span></code></pre></td></tr></table></div></figure>


<p>For linux, installing task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sh -c <span class="s2">&quot;$(curl --location https://taskfile.dev/install.sh)&quot;</span> -- -d -b /usr/local/bin
</span></code></pre></td></tr></table></div></figure>


<p>Or manual installation for arm as an example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">pushd</span> /tmp
</span><span class='line'><span class="nv">$ </span>wget https://github.com/go-task/task/releases/download/v3.7.0/task_linux_arm.tar.gz
</span><span class='line'><span class="nv">$ </span>tar -xvf task_linux_arm.tar.gz
</span><span class='line'><span class="nv">$ </span>sudo mv task /usr/local/bin/task
</span><span class='line'><span class="nv">$ </span>sudo chmod +x /usr/local/bin/task
</span><span class='line'><span class="nv">$ </span><span class="nb">popd</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify that task is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task --version
</span><span class='line'>Task version: v3.7.0
</span></code></pre></td></tr></table></div></figure>


<p>For more information check the installation page:
- <a href="https://taskfile.dev/#/installation">https://taskfile.dev/#/installation</a></p>

<h2>Usage</h2>

<p>Task uses a default config file: <code>Taskfile.yml</code> in the current working directory where you can provide context on what your tasks should do.</p>

<p>To generate a <code>Taskfile.yml</code> with example config, task gives us a <code>--init</code> flag to generate a sample.</p>

<p>For a basic hello-world example, our task <code>helloworld</code> will echo out <code>hello, world!</code>. To generate the sample code, run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>task --init
</span></code></pre></td></tr></table></div></figure>


<p>Then update the config, to the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">desc</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prints out hello world message</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, world!&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To demonstrate what the config means:</p>

<ul>
<li><code>tasks</code>: refers to the list of tasks</li>
<li><code>helloworld</code>: is the task name</li>
<li><code>desc</code>: describes the task, useful for listing tasks</li>
<li><code>cmds</code>: the commands that the task will execute</li>
</ul>


<p>To list all our tasks for our taskfile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task --list
</span><span class='line'>task: Available tasks <span class="k">for</span> this project:
</span><span class='line'>* helloworld:     prints out hello world message
</span></code></pre></td></tr></table></div></figure>


<p>Which we call using the application <code>task</code> with the argument of the task name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task helloworld
</span><span class='line'>task: <span class="o">[</span>helloworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;hello, world!&quot;</span>
</span><span class='line'>hello, world!
</span></code></pre></td></tr></table></div></figure>


<p>We can also reduce the output verbosity using <code>silent</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">desc</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prints out hello world message</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, world!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which will result in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task helloworld
</span><span class='line'>hello, world!
</span></code></pre></td></tr></table></div></figure>


<p>For a example using environment variables, we can use it in two ways:</p>

<ul>
<li>per task</li>
<li>globally, across all tasks</li>
</ul>


<p>For using environment variables per task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">WORD</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">world</span>
</span></code></pre></td></tr></table></div></figure>


<p>Results in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task helloworld
</span><span class='line'>task: <span class="o">[</span>helloworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;hello, $WORD!&quot;</span>
</span><span class='line'>hello, world!
</span></code></pre></td></tr></table></div></figure>


<p>For using environment variables globally across all tasks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">WORD</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">world</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">byeworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bye</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running our first task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task helloworld
</span><span class='line'>task: <span class="o">[</span>helloworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;hello, $WORD!&quot;</span>
</span><span class='line'>hello, world!
</span></code></pre></td></tr></table></div></figure>


<p>And running our second task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task byeworld
</span><span class='line'>task: <span class="o">[</span>byeworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>bye, world!
</span></code></pre></td></tr></table></div></figure>


<p>To store your environment variables in a <code>.env</code> file, you can specify it as the following in your <code>Taskfile.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">dotenv</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;.env&#39;</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">byeworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bye</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in your <code>.env</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">WORD=world</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you should see your environment variables referenced from the <code>.env</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ task helloworld</span>
</span><span class='line'><span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">helloworld</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">hello, world!</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can also reference config using <code>vars</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Hello, World!</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">desc</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prints out a message</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case our task name is <code>default</code>, therefore we can only run <code>task</code> without any arguments, as default with be the default task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ task</span>
</span><span class='line'><span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">default</span><span class="p-Indicator">]</span> <span class="l-Scalar-Plain">echo &quot;Hello, World!&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">Hello, World!</span>
</span></code></pre></td></tr></table></div></figure>


<p>To run both tasks with one command, you can specify dependencies, so if we define a task with zero commands but just dependencies, it will call those tasks and execute them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">WORD</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">world</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">helloworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;hello, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hello</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">byeworld</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cmds</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">env</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">GREETING</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bye</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">all</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deps</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">helloworld</span><span class="p-Indicator">,</span> <span class="nv">byeworld</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So when we run the <code>all</code> task:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>task all
</span><span class='line'>task: <span class="o">[</span>helloworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;hello, $WORD!&quot;</span>
</span><span class='line'>hello, world!
</span><span class='line'>task: <span class="o">[</span>byeworld<span class="o">]</span> <span class="nb">echo</span> <span class="s2">&quot;$GREETING, $WORD!&quot;</span>
</span><span class='line'>bye, world!
</span></code></pre></td></tr></table></div></figure>


<p>For more usage examples, have a look at their documentation:
- <a href="https://taskfile.dev/#/usage">https://taskfile.dev/#/usage</a></p>

<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/07/31/basic-logging-with-python/">Basic Logging With Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-07-31T04:17:24-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2021</span></span> <span class='time'>4:17 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://blog.ruanbekker.com/images/ruanbekker-header-photo.png" alt="" /></p>

<p>I&rsquo;m trying to force myself to move away from using the <code>print()</code> function as I&rsquo;m pretty much using print all the time to cater for logging, and using the <code>logging</code> package instead.</p>

<p>This is a basic example of using logging in a basic python app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">logging</span>
</span><span class='line'>
</span><span class='line'><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
</span><span class='line'>    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
</span><span class='line'>    <span class="n">format</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%(asctime)s</span><span class="s"> [</span><span class="si">%(levelname)s</span><span class="s">] </span><span class="si">%(name)s</span><span class="s"> </span><span class="si">%(message)s</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
</span><span class='line'>        <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">messagestring</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;info&#39;</span><span class="p">:</span> <span class="s">&#39;info message&#39;</span><span class="p">,</span> <span class="s">&#39;warn&#39;</span><span class="p">:</span> <span class="s">&#39;this is a warning&#39;</span><span class="p">,</span> <span class="s">&#39;err&#39;</span><span class="p">:</span> <span class="s">&#39;this is a error&#39;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;thisapp&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;message: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">messagestring</span><span class="p">[</span><span class="s">&#39;info&#39;</span><span class="p">]))</span>
</span><span class='line'><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;message: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">messagestring</span><span class="p">[</span><span class="s">&#39;warn&#39;</span><span class="p">]))</span>
</span><span class='line'><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;message: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">messagestring</span><span class="p">[</span><span class="s">&#39;err&#39;</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When running this example, this is the output that you will see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python app.py
</span><span class='line'>2021-07-19 13:07:43,647 <span class="o">[</span>INFO<span class="o">]</span> thisapp message: info message
</span><span class='line'>2021-07-19 13:07:43,647 <span class="o">[</span>WARNING<span class="o">]</span> thisapp message: this is a warning
</span><span class='line'>2021-07-19 13:07:43,647 <span class="o">[</span>ERROR<span class="o">]</span> thisapp message: this is a error
</span></code></pre></td></tr></table></div></figure>


<p>More more info on this package, see it&rsquo;s documentation:
- <a href="https://docs.python.org/3/library/logging.html">https://docs.python.org/3/library/logging.html</a></p>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/07/31/difference-with-ecs-task-and-execution-iam-roles-on-aws/">Difference With ECS Task and Execution IAM Roles on AWS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-07-31T03:37:34-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2021</span></span> <span class='time'>3:37 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://blog.ruanbekker.com/images/ruanbekker-header-photo.png" alt="" /></p>

<p>In this post we will look at what the difference is between the <a href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/task-iam-roles.html">AWS ECS Task Execution IAM Role</a> and the <a href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/task-iam-roles.html">IAM Role for Tasks</a> and give a example policy to demonstrate.</p>

<h2>ECS Task Execution Role</h2>

<p>The ECS Execution Role is used by the ecs-agent which runs on ECS and is responsible for:
- Pulling down docker images from ECR
- Fetching the SSM Parameters from SSM for your Task (Secrets and LogConfigurations)
- Writing Logs to CloudWatch</p>

<p>The IAM Role has been configured that the Trusted Identity is ecs so only ECS is allowed to assume credentials from the IAM Policy that is associated to the Role.</p>

<p>The trusted identity in the IAM Role to be ecs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;ecs-tasks.amazonaws.com&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and the policy will look like this more or less for a example service, I am demonstrating my-dev-service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;ecr:GetAuthorizationToken&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;ecr:BatchCheckLayerAvailability&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;ecr:GetDownloadUrlForLayer&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;ecr:BatchGetImage&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;logs:CreateLogStream&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;logs:PutLogEvents&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;SSMGetParameters&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;ssm:GetParameter&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:ssm:eu-west-1:*:parameter/my-service/dev/*&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;KMSDecryptParametersWithKey&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;kms:GetPublicKey&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;kms:Decrypt&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;kms:GenerateDataKey&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;kms:DescribeKey&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the ECS Task Definition the role arn is specified as <code>"executionRoleArn"</code> in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;my-dev-service&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;executionRoleArn&quot;</span><span class="p">:</span><span class="s2">&quot;arn:aws:iam::000000000000:role/ecs-exec-role&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;taskRoleArn&quot;</span><span class="p">:</span><span class="s2">&quot;arn:aws:iam::000000000000:role/ecs-task-role&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;containerDefinitions&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ECS Task Role</h2>

<p>The ECS Task Role is used by the service that is deployed to ECS, so this will be your application requiring access to SQS as an example</p>

<p>Same as before, we set the trusted identity in the IAM Role to be ecs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Service&quot;</span><span class="p">:</span> <span class="s2">&quot;ecs-tasks.amazonaws.com&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;sts:AssumeRole&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So only the ECS tasks using the role is allowed to assume credentials from the IAM Role, and the policy associated to the role, can look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;AllowDevSQS&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;sqs:GetQueueUrl&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;sqs:ReceiveMessage&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;sqs:SendMessage&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;sqs:ChangeMessageVisibility&quot;</span>
</span><span class='line'>            <span class="p">],</span>
</span><span class='line'>            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;arn:aws:sqs:eu-west-1:000000000000:dev-pending-queue&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;arn:aws:sqs:eu-west-1:000000000000:dev-confirmed-queue&quot;</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The role arn will be specified in <code>"taskRoleArn"</code> from the following in the ECS Task Definition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;my-dev-service&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;executionRoleArn&quot;</span><span class="p">:</span><span class="s2">&quot;arn:aws:iam::000000000000:role/ecs-exec-role&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;taskRoleArn&quot;</span><span class="p">:</span><span class="s2">&quot;arn:aws:iam::000000000000:role/ecs-task-role&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;containerDefinitions&quot;</span><span class="p">:</span> <span class="p">[]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Application Code</h2>

<p>In your application you don’t need to reference any aws access keys as the role will assume credentials for you by the SDK, with python a short example will be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="n">sqs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;sqs&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/07/12/install-java-11-and-maven-on-ubuntu-linux/">Install Java 11 and Maven on Ubuntu Linux</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-07-12T02:36:32-04:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>2:36 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this short tutorial I will show you how to prepare your environment for Java 11 and Maven on Ubuntu for Linux.</p>

<h2>Install</h2>

<p>Update your package manager and install OpenJDK 11:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt update
</span><span class='line'>sudo apt install openjdk-11-jdk -y
</span></code></pre></td></tr></table></div></figure>


<p>Verify that Java is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>java -version
</span><span class='line'>openjdk version <span class="s2">&quot;11.0.11&quot;</span> 2021-04-20
</span><span class='line'>OpenJDK Runtime Environment <span class="o">(</span>build 11.0.11+9-Ubuntu-0ubuntu2.20.04<span class="o">)</span>
</span><span class='line'>OpenJDK 64-Bit Server VM <span class="o">(</span>build 11.0.11+9-Ubuntu-0ubuntu2.20.04, mixed mode, sharing<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once Java is installed, we can install Maven, first switch to the root user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo su
</span></code></pre></td></tr></table></div></figure>


<p>I will be using maven version <code>3.6.2</code>, so adjust accordingly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ MAVEN_HOME</span><span class="o">=</span><span class="s2">&quot;/opt/maven&quot;</span>
</span><span class='line'><span class="nv">$ MAVEN_VERSION</span><span class="o">=</span>3.6.3
</span><span class='line'><span class="nv">$ MAVEN_CONFIG_HOME</span><span class="o">=</span><span class="s2">&quot;/root/.m2&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the directories, then download maven and extract:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p <span class="nv">$MAVEN_HOME</span>
</span><span class='line'><span class="nv">$ </span>curl -LSso /var/tmp/apache-maven-<span class="nv">$MAVEN_VERSION</span>-bin.tar.gz https://apache.org/dist/maven/maven-3/<span class="nv">$MAVEN_VERSION</span>/binaries/apache-maven-<span class="nv">$MAVEN_VERSION</span>-bin.tar.gz
</span><span class='line'><span class="nv">$ </span>tar xzvf /var/tmp/apache-maven-<span class="nv">$MAVEN_VERSION</span>-bin.tar.gz -C <span class="nv">$MAVEN_HOME</span> --strip-components<span class="o">=</span>1
</span><span class='line'><span class="nv">$ </span>rm /var/tmp/apache-maven-<span class="nv">$MAVEN_VERSION</span>-bin.tar.gz
</span><span class='line'><span class="nv">$ </span>update-alternatives --install /usr/bin/mvn mvn /opt/maven/bin/mvn 10000
</span><span class='line'><span class="nv">$ </span>mkdir -p <span class="nv">$MAVEN_CONFIG_HOME</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set the environment variables for maven:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/profile.d/custom.sh
</span><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nb">export </span><span class="nv">MAVEN_HOME</span><span class="o">=</span><span class="s2">&quot;/opt/maven&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">MAVEN_VERSION</span><span class="o">=</span>3.6.3
</span><span class='line'><span class="nb">export </span><span class="nv">MAVEN_CONFIG_HOME</span><span class="o">=</span><span class="s2">&quot;/root/.m2&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then make the file executable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod +x /etc/profile.d/custom.sh
</span></code></pre></td></tr></table></div></figure>


<p>Verify that maven is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mvn -version
</span><span class='line'>Apache Maven 3.6.3 <span class="o">(</span>cecedd343002696d0abb50b32b541b8a6ba2883f<span class="o">)</span>
</span><span class='line'>Maven home: /opt/maven
</span><span class='line'>Java version: 11.0.11, vendor: Ubuntu, runtime: /usr/lib/jvm/java-11-openjdk-amd64
</span><span class='line'>Default locale: en, platform encoding: UTF-8
</span><span class='line'>OS name: <span class="s2">&quot;linux&quot;</span>, version: <span class="s2">&quot;5.4.0-1041-aws&quot;</span>, arch: <span class="s2">&quot;amd64&quot;</span>, family: <span class="s2">&quot;unix&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/05/03/setup-a-crypto-digibyte-full-node-on-linux/">Setup a Crypto Digibyte Full Node on Linux</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-05-03T17:14:49-04:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2021</span></span> <span class='time'>5:14 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://upload.wikimedia.org/wikipedia/en/8/8f/DigiByte_logo.svg" alt="" /></p>

<p>In this tutorial I will show you how to setup a digibyte (DGB) Full Node on Linux and show you how to interact with your wallet and the blockchain.</p>

<h2>What is a Full Node</h2>

<p>By running a Full Node, you contribute by helping to fully validate transactions and blocks. Almost all full nodes also help the network by accepting transactions and blocks from other full nodes, validating those transactions and blocks and then relaying them to other full nodes. Therefore you are contributing to maintaining the consensus of the blockchain.</p>

<h2>Hardware Requirements</h2>

<p>In order to run a full digibyte node you will need a server that is preferrably online 24/7 and that you have an uncapped connection as at the time of writing the digibyte blockchain is about 25GB in size but increases over time. I also used a server with 2vCPU&rsquo;s and 4GB of memory.</p>

<h2>Setup the Pre-Requisites</h2>

<p>First create the user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>useradd -G sudo digibyte -m -s /bin/bash
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;digibyte ALL=(ALL:ALL) NOPASSWD: ALL&quot;</span> <span class="p">|</span> sudo tee /etc/sudoers.d/no-sudo-password-for-digibyte
</span></code></pre></td></tr></table></div></figure>


<p>Create the configuration directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /etc/digibyte /var/lib/digibyte
</span></code></pre></td></tr></table></div></figure>


<p>Create the digibyte configuration file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat <span class="s">&lt;&lt;EOF &gt; /etc/digibyte/digibyte.conf</span>
</span><span class='line'><span class="s">daemon=1</span>
</span><span class='line'><span class="s">maxconnections=300</span>
</span><span class='line'><span class="s">disablewallet=0</span>
</span><span class='line'><span class="s">rpcuser=jsonrpc</span>
</span><span class='line'><span class="s">rpcpassword=$(openssl rand -base64 18)</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Download the Software</h2>

<p>Get the <a href="https://github.com/DigiByte-Core/digibyte/releases">latest</a> release, but at the time of writing v7.17.2 is the latest:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/DigiByte-Core/digibyte/releases/download/v7.17.2/digibyte-7.17.2-x86_64-linux-gnu.tar.gz
</span><span class='line'><span class="nv">$ </span>tar -xf digibyte-7.17.2-x86_64-linux-gnu.tar.gz
</span><span class='line'><span class="nv">$ </span>mv digibyte-7.17.2 /usr/local/digibyte-7.17.2
</span></code></pre></td></tr></table></div></figure>


<p>Then symbolic link the version directory to digibyte:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ln -s /usr/local/digibyte-7.17.2 /usr/local/digibyte
</span></code></pre></td></tr></table></div></figure>


<h2>SystemD</h2>

<p>Create the systemd unit file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat <span class="s">&lt;&lt;EOF &gt; /etc/systemd/system/digibyted.service</span>
</span><span class='line'><span class="s">[Unit]</span>
</span><span class='line'><span class="s">Description=DigiByte&#39;s distributed currency daemon</span>
</span><span class='line'><span class="s">After=network.target</span>
</span><span class='line'>
</span><span class='line'><span class="s">[Service]</span>
</span><span class='line'><span class="s">User=digibyte</span>
</span><span class='line'><span class="s">Group=digibyte</span>
</span><span class='line'>
</span><span class='line'><span class="s">Type=forking</span>
</span><span class='line'><span class="s">PIDFile=/etc/digibyte/digibyted.pid</span>
</span><span class='line'><span class="s">ExecStart=/usr/local/digibyte/bin/digibyted -daemon -pid=/etc/digibyte/digibyted.pid \</span>
</span><span class='line'><span class="s">  -conf=/etc/digibyte/digibyte.conf -datadir=/var/lib/digibyte -deprecatedrpc=accounts </span>
</span><span class='line'>
</span><span class='line'><span class="s">Restart=always</span>
</span><span class='line'><span class="s">PrivateTmp=true</span>
</span><span class='line'><span class="s">TimeoutStopSec=60s</span>
</span><span class='line'><span class="s">TimeoutStartSec=2s</span>
</span><span class='line'><span class="s">StartLimitInterval=120s</span>
</span><span class='line'><span class="s">StartLimitBurst=5</span>
</span><span class='line'>
</span><span class='line'><span class="s">[Install]</span>
</span><span class='line'><span class="s">WantedBy=multi-user.target</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Change the ownerships to digibyte:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chown -R digibyte:digibyte /etc/digibyte /var/lib/digibyte
</span></code></pre></td></tr></table></div></figure>


<p>Enable and start the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>digibyted.service
</span><span class='line'><span class="nv">$ </span>systemctl start digibyted.service
</span></code></pre></td></tr></table></div></figure>


<p>Check the log:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tail -f /var/lib/digibyte/debug.log
</span></code></pre></td></tr></table></div></figure>


<h2>Interact with the Node</h2>

<p>Check the uptime:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;uptime&quot;, &quot;params&quot;: []}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check the wallet address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;getaccountaddress&quot;, &quot;params&quot;: []}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:<span class="s2">&quot;D7ZznMe4NyEkXd6zA6MB3GYXiAURo64hNs&quot;</span>,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Get the account balance:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;getbalance&quot;, &quot;params&quot;: []}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:0.00000000,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the digibyte-cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/usr/local/digibyte/bin/digibyte-cli -getinfo
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;version&quot;</span>: 7170200,
</span><span class='line'>  <span class="s2">&quot;protocolversion&quot;</span>: 70017,
</span><span class='line'>  <span class="s2">&quot;walletversion&quot;</span>: 169900,
</span><span class='line'>  <span class="s2">&quot;balance&quot;</span>: 0.00000000,
</span><span class='line'>  <span class="s2">&quot;blocks&quot;</span>: 183019,
</span><span class='line'>  <span class="s2">&quot;timeoffset&quot;</span>: 0,
</span><span class='line'>  <span class="s2">&quot;connections&quot;</span>: 8,
</span><span class='line'>  <span class="s2">&quot;proxy&quot;</span>: <span class="s2">&quot;&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;difficulty&quot;</span>: null,
</span><span class='line'>  <span class="s2">&quot;testnet&quot;</span>: <span class="nb">false</span>,
</span><span class='line'>  <span class="s2">&quot;keypoololdest&quot;</span>: 1619558662,
</span><span class='line'>  <span class="s2">&quot;keypoolsize&quot;</span>: 1000,
</span><span class='line'>  <span class="s2">&quot;paytxfee&quot;</span>: 0.00000000,
</span><span class='line'>  <span class="s2">&quot;relayfee&quot;</span>: 0.00001000,
</span><span class='line'>  <span class="s2">&quot;warnings&quot;</span>: <span class="s2">&quot;&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Making a Transaction to my Wallet</h2>

<p>Let&rsquo;s make a transaction to my wallet node from a crypto currency exchange where I have digibyte, so first to get the wallet address where we would like to deposit the crypto currency:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;getaccountaddress&quot;, &quot;params&quot;: []}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:<span class="s2">&quot;D7ZznMe4NyEkXd6zA6MB3GYXiAURo64hNs&quot;</span>,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>From a exchange where you have DGB, withdraw to the address DN8RMAUz2yHGW1PuuLtiSkiTZARzMJ4L2A which is your wallet on the node (ensure you have enough to cover the transaction fee).</p>

<p>Once the transaction has enough confirmations, have a look at your wallet balance, and you will see the 5 DGB that I sent to my wallet can be seen:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;: &quot;curl&quot;, &quot;method&quot;: &quot;getbalance&quot;, &quot;params&quot;: [&quot;&quot;]}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:5.00000000,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve setup a software wallet on my pc, and from DGB I selected receive and copied my DGB software wallet address, now I would like to transfer my funds from my node wallet to my software wallet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;:&quot;curl&quot;, &quot;method&quot;: &quot;sendtoaddress&quot;, &quot;params&quot;: [&quot;DTqHG9KA3oQAywq18gpBknxHXHZviyYdvS&quot;, 5.0, &quot;donation&quot;, &quot;happy bday&quot;] }&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:null,<span class="s2">&quot;error&quot;</span>:<span class="o">{</span><span class="s2">&quot;code&quot;</span>:-4,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;Error: This transaction requires a transaction fee of at least 0.0004324&quot;</span><span class="o">}</span>,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see I don&rsquo;t have enough in my nodes wallet to make the transaction, therefore I need to keep the transaction cost in consideration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python3 -c <span class="s1">&#39;print(5.0-0.0004324)&#39;</span>
</span><span class='line'>4.9995676
</span></code></pre></td></tr></table></div></figure>


<p>So let&rsquo;s send <code>4.998</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> -u <span class="s2">&quot;jsonrpc:$PASSWORD&quot;</span> http://localhost:14022 -d <span class="s1">&#39;{&quot;jsonrpc&quot;: &quot;1.0&quot;, &quot;id&quot;:&quot;curl&quot;, &quot;method&quot;: &quot;sendtoaddress&quot;, &quot;params&quot;: [&quot;DTqHG9KA3oQAywq18gpBknxHXHZviyYdvS&quot;, 4.998, &quot;donation&quot;, &quot;happy bday&quot;] }&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;result&quot;</span>:<span class="s2">&quot;260e49b72f17f42f5a6c858e5403e23b5382000650997292e7e79f1535f5c4d0&quot;</span>,<span class="s2">&quot;error&quot;</span>:null,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;curl&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see we are getting back a transaction id which we can use later to check up on. A couple of seconds later I received a notification on my software wallet that my funds were received:</p>

<p><img src="https://user-images.githubusercontent.com/567298/116690769-2aae2880-a9ba-11eb-8735-3fd1f0cc9ece.png" alt="" /></p>

<p>First, using our software wallet&rsquo;s address we can look it up:
- <a href="https://digiexplorer.info/address/DTqHG9KA3oQAywq18gpBknxHXHZviyYdvS">https://digiexplorer.info/address/DTqHG9KA3oQAywq18gpBknxHXHZviyYdvS</a></p>

<p>And it should look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/116691497-29313000-a9bb-11eb-962d-0427a560718a.png" alt="" /></p>

<p>We can also lookup the transaction id:
- <a href="https://digiexplorer.info/tx/260e49b72f17f42f5a6c858e5403e23b5382000650997292e7e79f1535f5c4d0">https://digiexplorer.info/tx/260e49b72f17f42f5a6c858e5403e23b5382000650997292e7e79f1535f5c4d0</a></p>

<p>And it should look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/116691773-9ba21000-a9bb-11eb-978e-58be3a8be045.png" alt="" /></p>

<h2>Resources</h2>

<p>RPC Docs:
- <a href="https://developer.bitcoin.org/reference/rpc/index.html">https://developer.bitcoin.org/reference/rpc/index.html</a>
- <a href="https://chainquery.com/bitcoin-cli">https://chainquery.com/bitcoin-cli</a></p>

<p>Digibyte Config:
- <a href="https://github.com/digibyte/digibyte/blob/master/contrib/debian/examples/digibyte.conf">https://github.com/digibyte/digibyte/blob/master/contrib/debian/examples/digibyte.conf</a></p>

<p>REST Config:
- <a href="https://github.com/digibyte/digibyte/blob/master/doc/REST-interface.md">https://github.com/digibyte/digibyte/blob/master/doc/REST-interface.md</a></p>

<p>Resources:
- <a href="https://digibytewallets.com/">https://digibytewallets.com/</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/04/06/install-concourse-ci-v6-on-ubuntu-20-dot-04/">Install Concourse CI V6 on Ubuntu 20.04</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-04-06T17:56:38-04:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>5:56 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495" alt="" /></p>

<p>Concourse is a Pipeline Based Continious Integration system written in Go</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://concourse-ci.org/">https://concourse-ci.org/</a></li>
<li><a href="https://github.com/concourse/concourse">https://github.com/concourse/concourse</a></li>
<li><a href="https://github.com/starkandwayne/concourse-tutorial">https://github.com/starkandwayne/concourse-tutorial</a></li>
</ul>


<h2>Older Version</h2>

<p>An older version is available:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2017/11/07/setup-a-concourse-ci-server-on-ubuntu-16/">Setup Concourse CI v4 on Ubuntu 16.04</a></li>
</ul>


<h2>What is Concourse CI:</h2>

<p>Concourse CI is a Continious Integration Platform. Concourse enables you to construct pipelines with a yaml configuration that can consist out of 3 core concepts, tasks, resources, and jobs that compose them. For more information about this have a look at their <a href="https://concourse.ci/concepts.html">docs</a></p>

<h2>What will we be doing today</h2>

<p>We will setup a Concourse CI Server v6.7.6 (web and worker) on Ubuntu 20.04 and run the traditional <code>Hello, World</code> pipeline</p>

<h2>Setup the Server:</h2>

<p>Concourse needs <code>PostgresSQL</code> server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install postgresql postgresql-contrib -y
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>postgresql
</span></code></pre></td></tr></table></div></figure>


<p>Create the Database and User for Concourse on Postgres:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo -u postgres createuser concourse
</span><span class='line'><span class="nv">$ </span>sudo -u postgres createdb --owner<span class="o">=</span>concourse atc
</span></code></pre></td></tr></table></div></figure>


<p>Download the Concourse and Fly Cli Binaries:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v6.7.6/concourse-6.7.6-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v6.7.6/fly-6.7.6-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>tar -xvf concourse-6.7.6-linux-amd64.tgz -C /usr/local/
</span><span class='line'><span class="nv">$ </span>tar -xvf fly-6.7.6-linux-amd64.tgz
</span><span class='line'><span class="nv">$ </span>mv fly /usr/bin/fly
</span><span class='line'><span class="nv">$ </span>rm -rf concourse-6.7.6-linux-amd64.tgz fly-6.7.6-linux-amd64.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Create the Encryption Keys:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /etc/concourse
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/tsa_host_key
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/worker_key
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/session_signing_key
</span><span class='line'><span class="nv">$ </span>cp /etc/concourse/worker_key.pub /etc/concourse/authorized_worker_keys
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Web Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/concourse/web_environment
</span><span class='line'>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/concourse/bin
</span><span class='line'><span class="nv">CONCOURSE_ADD_LOCAL_USER</span><span class="o">=</span>ruan:pass
</span><span class='line'><span class="nv">CONCOURSE_SESSION_SIGNING_KEY</span><span class="o">=</span>/etc/concourse/session_signing_key
</span><span class='line'><span class="nv">CONCOURSE_TSA_HOST_KEY</span><span class="o">=</span>/etc/concourse/tsa_host_key
</span><span class='line'><span class="nv">CONCOURSE_TSA_AUTHORIZED_KEYS</span><span class="o">=</span>/etc/concourse/authorized_worker_keys
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_HOST</span><span class="o">=</span>127.0.0.1
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_USER</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_PASSWORD</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_DATABASE</span><span class="o">=</span>atc
</span><span class='line'><span class="nv">CONCOURSE_MAIN_TEAM_LOCAL_USER</span><span class="o">=</span>ruan
</span><span class='line'><span class="nv">CONCOURSE_EXTERNAL_URL</span><span class="o">=</span>http://10.20.30.40:8080 <span class="c"># replace this with your ip address</span>
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Worker Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/concourse/worker_environment
</span><span class='line'>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/concourse/bin
</span><span class='line'><span class="nv">CONCOURSE_WORK_DIR</span><span class="o">=</span>/var/lib/concourse
</span><span class='line'><span class="nv">CONCOURSE_TSA_HOST</span><span class="o">=</span>127.0.0.1:2222
</span><span class='line'><span class="nv">CONCOURSE_TSA_PUBLIC_KEY</span><span class="o">=</span>/etc/concourse/tsa_host_key.pub
</span><span class='line'><span class="nv">CONCOURSE_TSA_WORKER_PRIVATE_KEY</span><span class="o">=</span>/etc/concourse/worker_key
</span><span class='line'><span class="nv">CONCOURSE_GARDEN_DNS_SERVER</span><span class="o">=</span>8.8.8.8
</span></code></pre></td></tr></table></div></figure>


<p>Create a Concourse user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /var/lib/concourse
</span><span class='line'><span class="nv">$ </span>sudo adduser --system --group concourse
</span><span class='line'><span class="nv">$ </span>sudo chown -R concourse:concourse /etc/concourse /var/lib/concourse
</span><span class='line'><span class="nv">$ </span>sudo chmod <span class="m">600</span> /etc/concourse/*_environment
</span></code></pre></td></tr></table></div></figure>


<p>Create SystemD Unit Files, first for the Web Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/systemd/system/concourse-web.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Concourse CI web process <span class="o">(</span>ATC and TSA<span class="o">)</span>
</span><span class='line'><span class="nv">After</span><span class="o">=</span>postgresql.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">User</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>on-failure
</span><span class='line'><span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/concourse/web_environment
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/concourse web
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></code></pre></td></tr></table></div></figure>


<p>Then the SystemD Unit File for the Worker Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/systemd/system/concourse-worker.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Concourse CI worker process
</span><span class='line'><span class="nv">After</span><span class="o">=</span>concourse-web.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">User</span><span class="o">=</span>root
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>on-failure
</span><span class='line'><span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/concourse/worker_environment
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/concourse worker
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></code></pre></td></tr></table></div></figure>


<p>Create a postgres password for the concourse user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /home/concourse/
</span><span class='line'><span class="nv">$ </span>sudo -u concourse psql atc
</span><span class='line'><span class="nv">atc</span><span class="o">=</span>&gt; ALTER USER concourse WITH PASSWORD <span class="s1">&#39;concourse&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">atc</span><span class="o">=</span>&gt; <span class="se">\q</span>
</span></code></pre></td></tr></table></div></figure>


<p>Start and Enable the Services:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl start concourse-web concourse-worker
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>concourse-web concourse-worker postgresql
</span><span class='line'><span class="nv">$ </span>systemctl status concourse-web concourse-worker
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>systemctl is-active concourse-worker concourse-web
</span><span class='line'>active
</span><span class='line'>active
</span></code></pre></td></tr></table></div></figure>


<p>The listening ports should more or less look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -tulpn
</span><span class='line'>
</span><span class='line'>Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7777          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7788          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:8079          0.0.0.0:*               LISTEN      4525/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      1283/sshd
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:5432          0.0.0.0:*               LISTEN      4047/postgres
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::36159                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::46829                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::2222                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::8080                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      1283/sshd
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:68              0.0.0.0:*                           918/dhclient
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:42165           0.0.0.0:*                           4530/concourse
</span></code></pre></td></tr></table></div></figure>


<h2>Client Side:</h2>

<p>I will be using a the Fly cli from a Mac, so first we need to download the fly-cli for Mac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v6.7.6/fly-6.7.6-darwin-amd64.tgz
</span><span class='line'><span class="nv">$ </span>tar -xvf fly-6.7.6-darwin-amd64.tgz
</span><span class='line'><span class="nv">$ </span>sudo mv fly /usr/local/bin/fly
</span><span class='line'><span class="nv">$ </span>rm -rf fly-6.7.6-darwin-amd64.tgz
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to setup our Concourse Target by Authenticating against our Concourse Endpoint, lets setup our target with the name <code>ci</code>, and make sure to replace the ip address with the ip of your concourse server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci login -c http://10.20.30.40:8080
</span><span class='line'>logging in to team <span class="s1">&#39;main&#39;</span>
</span><span class='line'>
</span><span class='line'>navigate to the following URL in your browser:
</span><span class='line'>
</span><span class='line'>  http://10.20.30.40:8080/login?fly_port<span class="o">=</span>42181
</span><span class='line'>
</span><span class='line'>or enter token manually <span class="o">(</span>input hidden<span class="o">)</span>:
</span><span class='line'>target saved
</span></code></pre></td></tr></table></div></figure>


<p>Lets list our targets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly targets
</span><span class='line'>name  url                        team  expiry
</span><span class='line'>ci    http://10.20.30.40:8080    main  Wed, <span class="m">08</span> Nov <span class="m">2021</span> 15:32:59 UTC
</span></code></pre></td></tr></table></div></figure>


<p>Listing Registered Workers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>10.20.30.40       <span class="m">0</span>           linux     none  none  running  1.2
</span></code></pre></td></tr></table></div></figure>


<p>Listing Active Containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job            build <span class="c">#  build id  type   name                  attempt</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hello World Pipeline:</h2>

<p>Let&rsquo;s create a basic pipeline, that will print out <code>Hello, World!</code>:</p>

<p>Our <code>hello-world.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-job</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">say-hello</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine</span>
</span><span class='line'>          <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">edge</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/bin/sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">-c</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Hello, World!&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Applying the configuration to our pipeline:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci <span class="nb">set</span>-pipeline -p yeeehaa -c hello-world.yml
</span><span class='line'><span class="nb">jobs</span>:
</span><span class='line'>  job my-job has been added:
</span><span class='line'>    name: my-job
</span><span class='line'>    plan:
</span><span class='line'>    - task: say-hello
</span><span class='line'>      config:
</span><span class='line'>        platform: linux
</span><span class='line'>        image_resource:
</span><span class='line'>          <span class="nb">type</span>: docker-image
</span><span class='line'>          <span class="nb">source</span>:
</span><span class='line'>            repository: alpine
</span><span class='line'>            tag: edge
</span><span class='line'>        run:
</span><span class='line'>          path: /bin/sh
</span><span class='line'>          args:
</span><span class='line'>          - -c
</span><span class='line'>          - <span class="p">|</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'>apply configuration? <span class="o">[</span>yN<span class="o">]</span>: y
</span><span class='line'>pipeline created!
</span><span class='line'>you can view your pipeline here: http://10.20.30.40:8080/teams/main/pipelines/yeeehaa
</span><span class='line'>
</span><span class='line'>the pipeline is currently paused. to unpause, either:
</span><span class='line'>  - run the unpause-pipeline <span class="nb">command</span>
</span><span class='line'>  - click play next to the pipeline in the web ui
</span></code></pre></td></tr></table></div></figure>


<p>We can browse to the WebUI to unpause the pipeline, but since I like to do everything on cli as far as possible, I will unpause the pipeline via cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci unpause-pipeline -p yeeehaa
</span><span class='line'>unpaused <span class="s1">&#39;yeeehaa&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now our Pipeline is unpaused, but since we did not specify any triggers, we need to manually trigger the pipeline to run, you can either via the WebUI, select your pipeline which in this case will be named <code>yeeehaa</code> and then select the job, which will be <code>my-job</code> then hit the <code>+</code> sign, which will trigger the pipeline.</p>

<p>I will be using the cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job
</span><span class='line'>started yeeehaa/my-job <span class="c">#1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Via the WebUI on <code>http://10.20.30.40:8080/teams/main/pipelines/yeeehaa/jobs/my-job/builds/1</code> you should see the <code>Hello, World!</code> output, or via the cli, we also have the option to see the output, so let&rsquo;s trigger it again, but this time passing the <code>--watch</code> flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job --watch
</span><span class='line'>started yeeehaa/my-job <span class="c">#2</span>
</span><span class='line'>
</span><span class='line'>initializing
</span><span class='line'>running /bin/sh -c <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>Hello, World!
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>


<p>Listing our Workers and Containers again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>10.20.30.40       <span class="m">2</span>           linux     none  none  running  1.2
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job         build <span class="c">#  build id  type   name           attempt</span>
</span><span class='line'>36982955-54fd-4c1b-57b8-216486c58db8  10.20.30.40       yeeehaa      my-job      <span class="m">2</span>        <span class="m">729</span>       task   say-hello      n/a
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/wireguard-vpn-with-unbound-ads-blocking-dns/">Wireguard VPN With Unbound ADS Blocking DNS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:59:51-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:59 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will setup a Wireguard VPN with Unbound DNS Server with some additional configuration to block ads for any clients using the DNS Server while connected to the VPN.</p>

<p>A massive thank you to <a href="https://github.com/complexorganizations/wireguard-manager/blob/main/wireguard-server.sh">complexorganizations</a> for providing the source where this tuturial is based off.</p>

<h2>Install Packages</h2>

<p>I will be using Debian Buster for this installation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update
</span><span class='line'>$ apt upgrade -y
</span><span class='line'>$ apt update && apt install iptables curl coreutils bc jq sed e2fsprogs -y
</span><span class='line'>$ apt install linux-headers-"$(uname -r)" -y</span></code></pre></td></tr></table></div></figure>


<p>I want to disable IPv6, in my case I had to apply a couple of kernel parameter tweaks:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo net.ipv6.conf.all.disable_ipv6 = 1 &gt; /etc/sysctl.d/70-disable-ipv6.conf
</span><span class='line'>$ echo "net.ipv6.conf.$(ip -4 route ls | grep default | grep -Po '(?&lt;=dev )(\S+)' | head -1).disable_ipv6 = 1" &gt;&gt; /etc/sysctl.d/70-disable-ipv6.conf
</span><span class='line'>$ echo 'net.ipv4.ip_forward = 1' &gt; /etc/sysctl.d/60-enable-ip-forwarding.conf
</span><span class='line'>$ sysctl -p -f /etc/sysctl.d/70-disable-ipv6.conf
</span><span class='line'>$ sysctl -p -f /etc/sysctl.d/60-enable-ip-forwarding.conf</span></code></pre></td></tr></table></div></figure>


<h2>Environment Variables</h2>

<p>A couple of environment variables that we will reference during our installation, tweak where your setup differs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export NPROC=$(nproc)
</span><span class='line'>$ export SERVER_HOST=$(curl -s -4 ifconfig.co)
</span><span class='line'>$ export SERVER_PORT="51820"
</span><span class='line'>$ export MTU_CHOICE="1280"
</span><span class='line'>$ export NAT_CHOICE="25"
</span><span class='line'>$ export IPV4_SUBNET="10.7.0.0/24"
</span><span class='line'>$ export PRIVATE_SUBNET_V4=${IPV4_SUBNET}
</span><span class='line'>$ export GATEWAY_ADDRESS_V4="${PRIVATE_SUBNET_V4::-4}1"
</span><span class='line'>$ export PRIVATE_SUBNET_MASK_V4=$(echo "$PRIVATE_SUBNET_V4" | cut -d "/" -f 2)
</span><span class='line'>$ export CLIENT_DNS="$GATEWAY_ADDRESS_V4"
</span><span class='line'>$ export CLIENT_ALLOWED_IP="0.0.0.0/0"</span></code></pre></td></tr></table></div></figure>


<h2>Unbound Installation</h2>

<p>Download the unbound <code>root.hints</code> file from internic:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl https://www.internic.net/domain/named.cache --create-dirs -o /etc/unbound/root.hints</span></code></pre></td></tr></table></div></figure>


<p>Generate the <code>/etc/unbound/unbound.conf</code> config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "include: \"/etc/unbound/unbound.conf.d/*.conf\"
</span><span class='line'>server:
</span><span class='line'>    num-threads: $NPROC
</span><span class='line'>    verbosity: 1
</span><span class='line'>    root-hints: /etc/unbound/root.hints
</span><span class='line'>    # auto-trust-anchor-file: /var/lib/unbound/root.key
</span><span class='line'>    interface: 0.0.0.0
</span><span class='line'>    interface: ::0
</span><span class='line'>    max-udp-size: 3072
</span><span class='line'>    access-control: 0.0.0.0/0                 refuse
</span><span class='line'>    access-control: $PRIVATE_SUBNET_V4               allow
</span><span class='line'>    access-control: 127.0.0.1                 allow
</span><span class='line'>    private-address: $PRIVATE_SUBNET_V4
</span><span class='line'>    hide-identity: yes
</span><span class='line'>    hide-version: yes
</span><span class='line'>    harden-glue: yes
</span><span class='line'>    harden-dnssec-stripped: yes
</span><span class='line'>    harden-referral-path: yes
</span><span class='line'>    unwanted-reply-threshold: 10000000
</span><span class='line'>    val-log-level: 1
</span><span class='line'>    cache-min-ttl: 1800
</span><span class='line'>    cache-max-ttl: 14400
</span><span class='line'>    prefetch: yes
</span><span class='line'>    qname-minimisation: yes
</span><span class='line'>    prefetch-key: yes
</span><span class='line'>    forward-zone:
</span><span class='line'>        name: \".\"
</span><span class='line'>        forward-addr: 1.1.1.1
</span><span class='line'>        forward-addr: 8.8.8.8" &gt;&gt; /etc/unbound/unbound.conf</span></code></pre></td></tr></table></div></figure>


<p>Download the host entries for all the ad servers which we will block:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/social/hosts -o /tmp/adblocking_hosts</span></code></pre></td></tr></table></div></figure>


<p>Include the ads configuration in <code>/etc/unbound/unbound.d/ads.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "server:" &gt; /etc/unbound/unbound.conf.d/ads.conf
</span><span class='line'>$ cat /etc/unbound/adblocking_hosts | grep '^0\.0\.0\.0' | awk '{print "    local-zone: \""$2"\" redirect\n    local-data: \""$2" A 0.0.0.0\""}' &gt;&gt; /etc/unbound/unbound.conf.d/ads.conf</span></code></pre></td></tr></table></div></figure>


<p>Update the VPN Server&rsquo;s nameserver configuration to unbound:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chattr -i /etc/resolv.conf
</span><span class='line'>$ mv /etc/resolv.conf /etc/resolv.conf.old
</span><span class='line'>$ echo "nameserver 127.0.0.1" &gt;&gt;/etc/resolv.conf
</span><span class='line'>$ chattr +i /etc/resolv.conf</span></code></pre></td></tr></table></div></figure>


<p>Enable and Restart Unbound:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable unbound
</span><span class='line'>$ systemctl restart unbound</span></code></pre></td></tr></table></div></figure>


<p>Test if DNS Resolution works:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ dig google.com</span></code></pre></td></tr></table></div></figure>


<h2>Wireguard Installation</h2>

<p>Include the sources and install wireguard and its dependencies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "deb http://deb.debian.org/debian/ unstable main" &gt;&gt;/etc/apt/sources.list.d/unstable.list
</span><span class='line'>$ echo -e "Package: *\nPin: release a=unstable\nPin-Priority: 90"  &gt;&gt;/etc/apt/preferences.d/limit-unstable
</span><span class='line'>$ apt update
</span><span class='line'>$ apt install wireguard qrencode haveged ifupdown -y</span></code></pre></td></tr></table></div></figure>


<p>Set the environment variables and tweak where you need to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export SERVER_PRIVKEY=$(wg genkey)
</span><span class='line'>$ export SERVER_PUBKEY=$(echo "$SERVER_PRIVKEY" | wg pubkey)
</span><span class='line'>$ export CLIENT_NAME="ruan-pc"
</span><span class='line'>$ export CLIENT_PRIVKEY=$(wg genkey)
</span><span class='line'>$ export CLIENT_PUBKEY=$(echo "$CLIENT_PRIVKEY" | wg pubkey)
</span><span class='line'>$ export CLIENT_ADDRESS_V4="${PRIVATE_SUBNET_V4::-4}3"
</span><span class='line'>$ export PRESHARED_KEY=$(wg genpsk)
</span><span class='line'>$ export WIREGUARD_PUB_NIC="wg0"
</span><span class='line'>$ export PEER_PORT=$(shuf -i1024-65535 -n1)
</span><span class='line'>$ export WG_CONFIG="/etc/wireguard/$WIREGUARD_PUB_NIC.conf"</span></code></pre></td></tr></table></div></figure>


<p>Create the wireguard clients directory and create the config filename:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p /etc/wireguard/clients
</span><span class='line'>$ touch $WG_CONFIG && chmod 600 $WG_CONFIG</span></code></pre></td></tr></table></div></figure>


<p>Create the wireguard server config content and write it to the config file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "# $PRIVATE_SUBNET_V4 $SERVER_HOST:$SERVER_PORT $SERVER_PUBKEY $CLIENT_DNS $MTU_CHOICE $NAT_CHOICE $CLIENT_ALLOWED_IP
</span><span class='line'>[Interface]
</span><span class='line'>Address = $GATEWAY_ADDRESS_V4/$PRIVATE_SUBNET_MASK_V4
</span><span class='line'>ListenPort = $SERVER_PORT
</span><span class='line'>PrivateKey = $SERVER_PRIVKEY
</span><span class='line'>PostUp = iptables -A FORWARD -i $WIREGUARD_PUB_NIC -o $SERVER_PUB_NIC -j ACCEPT; iptables -t nat -A POSTROUTING -o $SERVER_PUB_NIC -j MASQUERADE; iptables -A INPUT -s $PRIVATE_SUBNET_V4 -p udp -m udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
</span><span class='line'>PostDown = iptables -D FORWARD -i $WIREGUARD_PUB_NIC  -o $SERVER_PUB_NIC -j ACCEPT; iptables -t nat -D POSTROUTING -o $SERVER_PUB_NIC -j MASQUERADE; iptables -D INPUT -s $PRIVATE_SUBNET_V4 -p udp -m udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT
</span><span class='line'>SaveConfig = false
</span><span class='line'># $CLIENT_NAME start
</span><span class='line'>[Peer]
</span><span class='line'>PublicKey = $CLIENT_PUBKEY
</span><span class='line'>PresharedKey = $PRESHARED_KEY
</span><span class='line'>AllowedIPs = $CLIENT_ADDRESS_V4/32
</span><span class='line'># $CLIENT_NAME end &gt;&gt;" &gt;&gt; $WG_CONFIG</span></code></pre></td></tr></table></div></figure>


<p>Create the client config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "# $CLIENT_NAME
</span><span class='line'>[Interface]
</span><span class='line'>Address = $CLIENT_ADDRESS_V4/$PRIVATE_SUBNET_MASK_V4
</span><span class='line'>DNS = $CLIENT_DNS
</span><span class='line'>ListenPort = $PEER_PORT
</span><span class='line'>MTU = $MTU_CHOICE
</span><span class='line'>PrivateKey = $CLIENT_PRIVKEY
</span><span class='line'>[Peer]
</span><span class='line'>AllowedIPs = $CLIENT_ALLOWED_IP
</span><span class='line'>Endpoint = $SERVER_HOST:$SERVER_PORT
</span><span class='line'>PersistentKeepalive = $NAT_CHOICE
</span><span class='line'>PresharedKey = $PRESHARED_KEY
</span><span class='line'>PublicKey = $SERVER_PUBKEY" &gt;&gt; /etc/wireguard/clients/"$CLIENT_NAME"-$WIREGUARD_PUB_NIC.conf</span></code></pre></td></tr></table></div></figure>


<p>Restart and Enable Wireguard:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable wg-quick@$WIREGUARD_PUB_NIC
</span><span class='line'>$ systemctl restart wg-quick@$WIREGUARD_PUB_NIC</span></code></pre></td></tr></table></div></figure>


<h2>Connect your Client</h2>

<p>Head over to <a href="https://www.wireguard.com/install/">Wireguard.com</a> and install the client of your choice then generate a QR Code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ qrencode -t ansiutf8 -l L &lt;/etc/wireguard/clients/"$CLIENT_NAME"-$WIREGUARD_PUB_NIC.conf</span></code></pre></td></tr></table></div></figure>


<p>Configure your client and connect to the VPN, after the connection has been established you can have a look on the server for connection details with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wg show</span></code></pre></td></tr></table></div></figure>


<p>Once connected head over to a website with ads, such as <a href="https://www.speedtest.net/">https://www.speedtest.net/</a> and you should see no ads.</p>

<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/ssh-using-aws-ssm-session-manager/">SSH Using AWS SSM Session Manager</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:52:54-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:52 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You can use SSM Session Manager to connect to your EC2 instances, as long as your EC2 instance has the associated IAM Role which includes the AmazonSSMManagedInstanceCore managed policy.</p>

<h2>AWS EC2 Console</h2>

<p>Head over to &ldquo;Connect&rdquo; and select &ldquo;Session Manager&rdquo;:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103775580-e8da2a80-5036-11eb-9e00-0fd9b4d9d467.png" alt="image" /></p>

<p>You should get a shell:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103775597-f2639280-5036-11eb-8101-768f1c81108a.png" alt="image" /></p>

<h2>AWS CLI</h2>

<p>You can also use the CLI:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>aws --profile prod ssm start-session --target i-0ebba722b102179b6</span></code></pre></td></tr></table></div></figure>


<p>If you get this error:</p>

<p><img src="https://user-images.githubusercontent.com/567298/103775625-ff808180-5036-11eb-88dc-be8fde3586ad.png" alt="image" /></p>

<p>Head over to:</p>

<p><a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html">https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html</a></p>

<p>Install the session manager plugin, for Mac:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip" -o "sessionmanager-bundle.zip"
</span><span class='line'>$ unzip sessionmanager-bundle.zip
</span><span class='line'>$ sudo ./sessionmanager-bundle/install -i /usr/local/sessionmanagerplugin -b /usr/local/bin/session-manager-plugin
</span><span class='line'>$ rm -rf sessionmanager-bundle</span></code></pre></td></tr></table></div></figure>


<p>After installation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aws --profile prod ssm start-session --target i-0ebba722b102179b6
</span><span class='line'>Starting session with SessionId: ruan.bekker-0b07cbbe261885ad3
</span><span class='line'>
</span><span class='line'>sh-4.2$ sudo su - ec2-user
</span><span class='line'>Last login: Wed Jan  6 12:55:03 UTC 2021 on pts/0
</span><span class='line'>[ec2-user@ip-172-31-23-246 ~]$</span></code></pre></td></tr></table></div></figure>


<p>Note: when you are using ssm session manager you don’t require security groups or a direct routable network to your instance.</p>

<h2>Bash Functions FTW</h2>

<p>You can implement this into a bash function:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.functions.aws
</span><span class='line'>aws-ssh(){
</span><span class='line'>  instance_name=${1}
</span><span class='line'>  instance_id=$(aws --profile prod ec2 describe-instances --filter "Name=tag:Name,Values=${instance_name}" --query "Reservations[].Instances[?State.Name == 'running'].InstanceId[]" --output text)
</span><span class='line'>  aws --profile prod ssm start-session --target ${instance_id}
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>$ aws-ssh ssm-session-manager-ssh-test2
</span><span class='line'>Starting session with SessionId: ruan.bekker-04daf56c5f3668790
</span><span class='line'>sh-4.2$</span></code></pre></td></tr></table></div></figure>


<p>If you have your own SSH key, you can use this ~/.ssh/config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># AWS SSM Session Manager
</span><span class='line'>Host i-*
</span><span class='line'>    ProxyCommand sh -c "aws --profile prod ssm start-session --target %h --document-name AWS-StartSSHSession --parameters 'portNumber=%p'"</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -i ~/.ssh/infra.pem ec2-user@i-0ebba722b102179b6
</span><span class='line'>Warning: Permanently added 'i-0ebba722b102179b6' (ECDSA) to the list of known hosts.
</span><span class='line'>Last login: Wed Jan  6 13:04:03 2021
</span><span class='line'>
</span><span class='line'>       __|  __|_  )
</span><span class='line'>       _|  (     /   Amazon Linux 2 AMI
</span><span class='line'>      ___|\___|___|
</span><span class='line'>
</span><span class='line'>https://aws.amazon.com/amazon-linux-2/
</span><span class='line'>[ec2-user@ip-172-31-23-246 ~]$</span></code></pre></td></tr></table></div></figure>


<h2>Related:</h2>

<ul>
<li><a href="https://aws.amazon.com/blogs/mt/amazon-ec2-instance-port-forwarding-with-aws-systems-manager/">https://aws.amazon.com/blogs/mt/amazon-ec2-instance-port-forwarding-with-aws-systems-manager/</a></li>
<li><a href="https://aws.amazon.com/blogs/aws/new-port-forwarding-using-aws-system-manager-sessions-manager/">https://aws.amazon.com/blogs/aws/new-port-forwarding-using-aws-system-manager-sessions-manager/</a></li>
</ul>


<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/bypass-the-medium-paywall-system/">Bypass the Medium Paywall System</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:45:54-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:45 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Do you like reading stories on medium.com but not a big fan of the paywall system?</p>

<p><img src="https://user-images.githubusercontent.com/567298/108808924-6ab6f080-75b0-11eb-961f-25327551725f.png" alt="image" /></p>

<p>Copy the link, DM yourself on twitter and paste the link:</p>

<p><img src="https://user-images.githubusercontent.com/567298/108809014-9e921600-75b0-11eb-8c01-18da23d43793.png" alt="image" /></p>

<p>Click on the pasted link, and enjoy:</p>

<p><img src="https://user-images.githubusercontent.com/567298/108809056-b2d61300-75b0-11eb-8eeb-38f99118bb17.png" alt="image" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2021/03/10/generate-grafana-loki-log-links-from-metric-label-values/">Generate Grafana Loki Log Links From Metric Label Values</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2021-03-10T00:34:04-05:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2021</span></span> <span class='time'>12:34 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will generate Loki Log links from selected dropdown template variables in a Grafana Dashboard.</p>

<h2>Context</h2>

<p>To give more context, we have a Grafana Dashboard with all our services, and when you select that service you see all the metrics of that service, now if you want to see the logs of that service, the selected label values will be parsed to a log link which you can click and it will take you to the Loki Explorer and parse the label values to the log link, so your logql will already be generated for you.</p>

<p>In order to achieve this, our metrics and logs need to share the same labels and label values (environment, container_name) etc.</p>

<h2>Dashboard Variables</h2>

<p>First we have our environment variable:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668240-a6862300-7b79-11eb-85ce-d381edfbe78e.png" alt="image" /></p>

<p>And here we have our service variable:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668438-dc2b0c00-7b79-11eb-9b17-629e9b1716a9.png" alt="image" /></p>

<p>Then for our container_name we have:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668632-05e43300-7b7a-11eb-97a0-8ff81f0c929c.png" alt="image" /></p>

<p>Notice the <code>/^(.*?)-[0-9]/</code> thats just to strip the end, if we remove it it will be:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668778-27451f00-7b7a-11eb-976f-a7d0b473cd1b.png" alt="image" /></p>

<h2>Grafana Dashboard</h2>

<p>Now when we select the environment, service, we get presented with a Loki LogURL:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109668970-552a6380-7b7a-11eb-8c72-b284cf0f5eec.png" alt="image" /></p>

<p>If we look at our dashboard links, under the dashboard settings:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109669065-6b382400-7b7a-11eb-8a29-34b492fef327.png" alt="image" /></p>

<p>The Logs Uri is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://grafana.mydomain.com/explore?orgId=1&left=%5B%22now-1h%22,%22now%22,%22Loki%22,%7B%22expr%22:%22%7Bcontainer_name%3D~%5C%22.*$container_name.*%5C%22%7D%22%7D,%7B%22mode%22:%22Logs%22%7D,%7B%22ui%22:%5Btrue,true,true,%22none%22%5D%7D%5D</span></code></pre></td></tr></table></div></figure>


<p>Now when we select our label values from the dropdown for our service and we follow the link we will get:</p>

<p><img src="https://user-images.githubusercontent.com/567298/109669297-a33f6700-7b7a-11eb-8205-f021467af751.png" alt="image" /></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/5">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/3">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>

<section>
  <h1>Say Hi!</h1>
  Send me a note using the <a href="https://saythanks.io/to/ruanbekker">saythanks.io</a> project.
</section>

<section>
  <h1>Newsletter</h1>
  View my newsletter on <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog" target="_blank">digests.ruanbekker.com</a>
</section>

<section>
  <h1>Cheetsheet Repository</h1>
  Have a look at my <strong>Cheetsheets Github Repository</strong>:
  <p></p>
  <a href="https://github.com/ruanbekker/cheatsheets" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719365-1d8a05e2-a0d3-4078-a84f-c691544e4b8f.png" width="480" height="240"></a>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/07/31/docker-multistage-builds-for-hugo/">Docker Multistage Builds for Hugo</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/07/14/remote-builds-with-docker-contexts/">Remote Builds With Docker Contexts</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/29/create-a-raid5-array-with-mdadm-on-linux/">Create a RAID5 Array With Mdadm on Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/23/install-a-specific-python-version-on-ubuntu/">Install a Specific Python Version on Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/15/how-to-persist-iptables-rules-after-reboots/">How to Persist Iptables Rules After Reboots</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest elasticsearch cheatsheet in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719853-fe9a50a4-03f2-4a26-a422-0deb946ca09c.png" width="480" height="240"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ruanbekker" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
