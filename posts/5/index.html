
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="This is a curated list of tutorials of prometheus, from installing prometheus, installing grafana, exporters, docker versions of the prometheus / &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/posts/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.ruan.dev/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/17/prometheus-series-of-tutorials-for-your-guide-to-epic-metrics/">Prometheus Series of Tutorials for Your Guide to Epic Metrics</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-17T20:24:40+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>8:24 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/57307750-696bb980-70e5-11e9-9b0b-73ad88bde6a3.png" alt="prometheus" /></p>

<p>This is a curated list of tutorials of prometheus, from installing prometheus, installing grafana, exporters, docker versions of the prometheus / grafana / node exporter stack, etc.</p>

<h2>The List</h2>

<ul>
<li>Install <a href="http://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">Prometheus</a></li>
<li>Install <a href="http://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">Node Exporter</a></li>
<li>Install <a href="http://blog.ruanbekker.com/blog/2019/05/17/install-pushgateway-to-expose-metrics-to-prometheus/">Pushgateway</a></li>
<li>Install <a href="http://blog.ruanbekker.com/blog/2019/05/17/install-grafana-to-visualize-your-metrics-from-datasources-such-as-prometheus-on-linux/">Grafana</a></li>
<li>Install <a href="http://blog.ruanbekker.com/blog/2019/05/17/install-alertmanager-to-alert-based-on-metrics-from-prometheus/">Alertmananger</a></li>
<li>Install <a href="http://blog.ruanbekker.com/blog/2019/05/17/install-blackbox-exporter-to-monitor-websites-with-prometheus/">Blackbox Exporter</a></li>
<li>Install <a href="">Docker Prometheus Grafana Stack</a></li>
</ul>


<p>This list will be updated as I publish more tutorials</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/17/install-blackbox-exporter-to-monitor-websites-with-prometheus/">Install Blackbox Exporter to Monitor Websites With Prometheus</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-17T18:55:15+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>6:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/57307750-696bb980-70e5-11e9-9b0b-73ad88bde6a3.png" alt="prometheus" /></p>

<p>Blackbox Exporter by Prometheus allows probing over endpoints such as http, https, icmp, tcp and dns.</p>

<p><a href="https://bekkerclothing.com/collections/developer?utm_source=blog.ruanbekker.com&utm_medium=blog&utm_campaign=leaderboard_ad" target="_blank"><img alt="bekker-clothing-developer-tshirts" src="https://user-images.githubusercontent.com/567298/70170981-7c278a80-16d6-11ea-9759-6621d02c1423.png"></a></p>

<h2>What will we be doing</h2>

<p>In this tutorial we will install the blackbox exporter on linux. Im assuming that you have already <a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">set up prometheus</a>.</p>

<h2>Install the Blackbox Exporter</h2>

<p>First create the blackbox exporter user:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ useradd --no-create-home --shell /bin/false blackbox_exporter</span></code></pre></td></tr></table></div></figure>


<p>Download blackbox exporter and extract:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.14.0/blackbox_exporter-0.14.0.linux-amd64.tar.gz
</span><span class='line'>$ tar -xvf blackbox_exporter-0.14.0.linux-amd64.tar.gz</span></code></pre></td></tr></table></div></figure>


<p>Move the binaries in place and change the ownership:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp blackbox_exporter-0.14.0.linux-amd64/blackbox_exporter /usr/local/bin/blackbox_exporter
</span><span class='line'>$ chown blackbox_exporter:blackbox_exporter /usr/local/bin/blackbox_exporter</span></code></pre></td></tr></table></div></figure>


<p>Remove the downloaded archive:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rm -rf blackbox_exporter-0.14.0.linux-amd64*</span></code></pre></td></tr></table></div></figure>


<p>Create the blackbox directory and create the config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /etc/blackbox_exporter
</span><span class='line'>$ vim /etc/blackbox_exporter/blackbox.yml</span></code></pre></td></tr></table></div></figure>


<p>Populate this config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>modules:
</span><span class='line'>  http_2xx:
</span><span class='line'>    prober: http
</span><span class='line'>    timeout: 5s
</span><span class='line'>    http:
</span><span class='line'>      valid_status_codes: []
</span><span class='line'>      method: GET</span></code></pre></td></tr></table></div></figure>


<p>Update the permissions of the config so that the user has ownership:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chown blackbox_exporter:blackbox_exporter /etc/blackbox_exporter/blackbox.yml</span></code></pre></td></tr></table></div></figure>


<p>Create the systemd unit file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/systemd/system/blackbox_exporter.service</span></code></pre></td></tr></table></div></figure>


<p>Populate the systemd unit file configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=Blackbox Exporter
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=blackbox_exporter
</span><span class='line'>Group=blackbox_exporter
</span><span class='line'>Type=simple
</span><span class='line'>ExecStart=/usr/local/bin/blackbox_exporter --config.file /etc/blackbox_exporter/blackbox.yml
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Reload the systemd daemon and restart the service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl start blackbox_exporter</span></code></pre></td></tr></table></div></figure>


<p>The service should be started, verify:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl status blackbox_exporter
</span><span class='line'>  blackbox_exporter.service - Blackbox Exporter
</span><span class='line'>   Loaded: loaded (/etc/systemd/system/blackbox_exporter.service; disabled; vendor preset: enabled)
</span><span class='line'>   Active: active (running) since Wed 2019-05-08 00:02:40 UTC; 5s ago
</span><span class='line'> Main PID: 10084 (blackbox_export)
</span><span class='line'>    Tasks: 6 (limit: 4704)
</span><span class='line'>   CGroup: /system.slice/blackbox_exporter.service
</span><span class='line'>           └─10084 /usr/local/bin/blackbox_exporter --config.file /etc/blackbox_exporter/blackbox.yml
</span><span class='line'>
</span><span class='line'>May 08 00:02:40 ip-172-31-41-126 systemd[1]: Started Blackbox Exporter.
</span><span class='line'>May 08 00:02:40 ip-172-31-41-126 blackbox_exporter[10084]: level=info ts=2019-05-08T00:02:40.5229204Z caller=main.go:213 msg="Starting blackbox_exporter" version="(version=0.14.0, branch=HEAD, revision=bb
</span><span class='line'>May 08 00:02:40 ip-172-31-41-126 blackbox_exporter[10084]: level=info ts=2019-05-08T00:02:40.52553523Z caller=main.go:226 msg="Loaded config file"
</span><span class='line'>May 08 00:02:40 ip-172-31-41-126 blackbox_exporter[10084]: level=info ts=2019-05-08T00:02:40.525695324Z caller=main.go:330 msg="Listening on address" address=:9115</span></code></pre></td></tr></table></div></figure>


<p>Enable the service on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable blackbox_exporter</span></code></pre></td></tr></table></div></figure>


<h2>Configure Prometheus</h2>

<p>Next, we need to provide context to prometheus on what to monitor. We will inform prometheus to monitor a web endpoint on port 8080 using the blackbox exporter (we will create a python simplehttpserver to run on port 8080).</p>

<p>Edit the prometheus config <code>/etc/prometheus/prometheus.yml</code> and append the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  - job_name: 'blackbox'
</span><span class='line'>    metrics_path: /probe
</span><span class='line'>    params:
</span><span class='line'>      module: [http_2xx]
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets:
</span><span class='line'>        - http://localhost:8080
</span><span class='line'>    relabel_configs:
</span><span class='line'>      - source_labels: [__address__]
</span><span class='line'>        target_label: __param_target
</span><span class='line'>      - source_labels: [__param_target]
</span><span class='line'>        target_label: instance
</span><span class='line'>      - target_label: __address__
</span><span class='line'>        replacement: localhost:9115</span></code></pre></td></tr></table></div></figure>


<p>Open a new terminal, create a <code>index.html</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "ok" &gt; index.html</span></code></pre></td></tr></table></div></figure>


<p>Then start a SimpleHTTPServer on port 8080:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ python -m SimpleHTTPServer 8080</span></code></pre></td></tr></table></div></figure>


<p>Head back to the previous terminal session and restart prometheus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart prometheus</span></code></pre></td></tr></table></div></figure>


<h2>Configure the Alarm definition:</h2>

<p>Create a alarm definition that desribes that defines when to notify when a endpoint goes down:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/prometheus/alert.rules.yml</span></code></pre></td></tr></table></div></figure>


<p>And our alert definition:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>groups:
</span><span class='line'>- name: alert.rules
</span><span class='line'>  rules:
</span><span class='line'>  - alert: EndpointDown
</span><span class='line'>    expr: probe_success == 0
</span><span class='line'>    for: 10s
</span><span class='line'>    labels:
</span><span class='line'>      severity: "critical"
</span><span class='line'>    annotations:
</span><span class='line'>      summary: "Endpoint  down"</span></code></pre></td></tr></table></div></figure>


<p>Ensure that the permission is set:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chown prometheus:prometheus /etc/prometheus/alert.rules.yml</span></code></pre></td></tr></table></div></figure>


<p>Use the <code>promtool</code> to validate that the alert is correctly configured:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ promtool check rules /etc/prometheus/alert.rules.yml
</span><span class='line'>Checking /etc/prometheus/alert.rules.yml
</span><span class='line'>  SUCCESS: 1 rules found</span></code></pre></td></tr></table></div></figure>


<p>If everything is good, restart prometheus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart prometheus</span></code></pre></td></tr></table></div></figure>


<h2>Blackbox Exporter Dashboard</h2>

<p>To install a blackbox exporter dashboard: <a href="https://grafana.com/dashboards/7587">https://grafana.com/dashboards/7587</a>, create a new dashboard, select import, provide the ID: <code>7587</code>, select the prometheus datasource and select save.</p>

<p>The dashboard should look similar to this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/57947217-99357100-78de-11e9-9108-9338c97ca59d.png" alt="blackbox-exporter" /></p>

<h2>Next up, Alertmanager</h2>

<p>In the <a href="https://blog.ruanbekker.com/blog/2019/05/17/install-alertmanager-to-alert-based-on-metrics-from-prometheus/">next tutorial</a> we will setup Alertmanager to alert when our endpoint goes down</p>

<h2>Resources</h2>

<p>See all <a href="https://blog.ruanbekker.com/blog/categories/prometheus/">#prometheus</a> blogposts</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/17/install-alertmanager-to-alert-based-on-metrics-from-prometheus/">Install Alertmanager to Alert Based on Metrics From Prometheus</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-17T18:49:26+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>6:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/57307750-696bb980-70e5-11e9-9b0b-73ad88bde6a3.png" alt="prometheus" /></p>

<p>So we are pushing our time series metrics into prometheus, and now we would like to alarm based on certain metric dimensions. That&rsquo;s where alertmanager fits in. We can setup targets and rules, once rules for our targets does not match, we can alarm to destinations suchs as slack, email etc.</p>

<p><a href="https://bekkerclothing.com/collections/developer?utm_source=blog.ruanbekker.com&utm_medium=blog&utm_campaign=leaderboard_ad" target="_blank"><img alt="bekker-clothing-developer-tshirts" src="https://user-images.githubusercontent.com/567298/70170981-7c278a80-16d6-11ea-9759-6621d02c1423.png"></a></p>

<h2>What we will be doing:</h2>

<p>In our previous tutorial we installed blackbox exporter to probe a endpoint. Now we will install Alertmanager and configure an alert to notify us via email and slack when our endpoint goes down. See <a href="https://blog.ruanbekker.com/blog/2019/05/17/install-blackbox-exporter-to-monitor-websites-with-prometheus/">this post</a> if you have not seen the previous tutorial.</p>

<h2>Install Alertmanager</h2>

<p>Create the user for alertmanager:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ useradd --no-create-home --shell /bin/false alertmanager</span></code></pre></td></tr></table></div></figure>


<p>Download alertmanager and extract:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ https://github.com/prometheus/alertmanager/releases/download/v0.17.0/alertmanager-0.17.0.linux-amd64.tar.gz
</span><span class='line'>$ tar -xvf alertmanager-0.17.0.linux-amd64.tar.gz</span></code></pre></td></tr></table></div></figure>


<p>Move alertmanager and amtool birnaries in place:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp alertmanager-0.17.0.linux-amd64/alertmanager /usr/local/bin/
</span><span class='line'>$ cp alertmanager-0.17.0.linux-amd64/amtool /usr/local/bin/</span></code></pre></td></tr></table></div></figure>


<p>Ensure that the correct permissions are in place:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chown alertmanager:alertmanager /usr/local/bin/alertmanager
</span><span class='line'>$ chown alertmanager:alertmanager /usr/local/bin/amtool</span></code></pre></td></tr></table></div></figure>


<p>Cleanup:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rm -rf alertmanager-0.17.0*</span></code></pre></td></tr></table></div></figure>


<h2>Configure Alertmanager:</h2>

<p>Create the alertmanager directory and configure the global alertmanager configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /etc/alertmanager
</span><span class='line'>$ vim /etc/alertmanager/alertmanager.yml</span></code></pre></td></tr></table></div></figure>


<p>Provide the global config and ensure to populate your personal information. See <a href="https://blog.ruanbekker.com/blog/2019/04/18/setup-a-slack-webhook-for-sending-messages-from-applications/">this post</a> to create a slack webhook.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global:
</span><span class='line'>  smtp_smarthost: 'smtp.domain.net:587'
</span><span class='line'>  smtp_from: 'AlertManager &lt;mailer@domain.com&gt;'
</span><span class='line'>  smtp_require_tls: true
</span><span class='line'>  smtp_hello: 'alertmanager'
</span><span class='line'>  smtp_auth_username: 'username'
</span><span class='line'>  smtp_auth_password: 'password'
</span><span class='line'>
</span><span class='line'>  slack_api_url: 'https://hooks.slack.com/services/x/xx/xxx'
</span><span class='line'>
</span><span class='line'>route:
</span><span class='line'>  group_by: ['instance', 'alert']
</span><span class='line'>  group_wait: 30s
</span><span class='line'>  group_interval: 5m
</span><span class='line'>  repeat_interval: 3h
</span><span class='line'>  receiver: team-1
</span><span class='line'>
</span><span class='line'>receivers:
</span><span class='line'>  - name: 'team-1'
</span><span class='line'>    email_configs:
</span><span class='line'>      - to: 'user@domain.com'
</span><span class='line'>    slack_configs:
</span><span class='line'>      # https://prometheus.io/docs/alerting/configuration/#slack_config
</span><span class='line'>      - channel: 'system_events'
</span><span class='line'>      - username: 'AlertManager'
</span><span class='line'>      - icon_emoji: ':joy:'</span></code></pre></td></tr></table></div></figure>


<p>Ensure the permissions are in place:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chown alertmanager:alertmanager -R /etc/alertmanager</span></code></pre></td></tr></table></div></figure>


<p>Create the alertmanager systemd unit file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/systemd/system/alertmanager.service</span></code></pre></td></tr></table></div></figure>


<p>And supply the unit file configuration. Note that I am exposing port <code>9093</code> directly as Im not using a reverse proxy.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=Alertmanager
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=alertmanager
</span><span class='line'>Group=alertmanager
</span><span class='line'>Type=simple
</span><span class='line'>WorkingDirectory=/etc/alertmanager/
</span><span class='line'>ExecStart=/usr/local/bin/alertmanager --config.file=/etc/alertmanager/alertmanager.yml --web.external-url http://0.0.0.0:9093
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Now we need to inform prometheus that we will send alerts to alertmanager to it&rsquo;s exposed port:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/prometheus/prometheus.yml</span></code></pre></td></tr></table></div></figure>


<p>And supply the alertmanager configuration for prometheus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>alerting:
</span><span class='line'>  alertmanagers:
</span><span class='line'>  - static_configs:
</span><span class='line'>    - targets:
</span><span class='line'>      - localhost:9093
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>So when we get alerted, our alert will include a link to our alert. We need to provide the base url of that alert. That get&rsquo;s done in our alertmanager systemd unit file: <code>/etc/systemd/system/alertmanager.service</code> under <code>--web.external-url</code> passing the alertmanager base ip address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=Alertmanager
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=alertmanager
</span><span class='line'>Group=alertmanager
</span><span class='line'>Type=simple
</span><span class='line'>WorkingDirectory=/etc/alertmanager/
</span><span class='line'>ExecStart=/usr/local/bin/alertmanager --config.file=/etc/alertmanager/alertmanager.yml --web.external-url http://&lt;your.alertmanager.ip.address&gt;:9093
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Then we need to do the same with the prometheus systemd unit file: <code>/etc/systemd/system/prometheus.service</code> under <code>--web.external-url</code> passing the prometheus base ip address:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=Prometheus
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=prometheus
</span><span class='line'>Group=prometheus
</span><span class='line'>Type=simple
</span><span class='line'>ExecStart=/usr/local/bin/prometheus \
</span><span class='line'>    --config.file /etc/prometheus/prometheus.yml \
</span><span class='line'>    --storage.tsdb.path /var/lib/prometheus/ \
</span><span class='line'>    --web.console.templates=/etc/prometheus/consoles \
</span><span class='line'>    --web.console.libraries=/etc/prometheus/console_libraries \
</span><span class='line'>    --web.external-url http://&lt;your.prometheus.ip.address&gt;
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Since we have edited the systemd unit files, we need to reload the systemd daemon:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload</span></code></pre></td></tr></table></div></figure>


<p>Then restart prometheus and alertmanager:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart prometheus
</span><span class='line'>$ systemctl restart alertmanager</span></code></pre></td></tr></table></div></figure>


<p>Inspect the status of alertmanager and prometheus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl status alertmanager
</span><span class='line'>$ systemctl status prometheus</span></code></pre></td></tr></table></div></figure>


<p>If everything seems good, enable alertmanager on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable alertmanager</span></code></pre></td></tr></table></div></figure>


<h2>Access Alertmanager:</h2>

<p>Access alertmanager on your endpoint on port <code>9093</code>:</p>

<p><img src="https://user-images.githubusercontent.com/567298/57946361-69856980-78dc-11e9-8c48-ebcc3b0d201e.png" alt="alertmanager" /></p>

<p>From our previous tutorial we started a local web service on port <code>8080</code> that is being monitored by prometheus. Let&rsquo;s stop that service to test out the alerting. You should get a notification via email:</p>

<p><img src="https://user-images.githubusercontent.com/567298/57946586-f29ca080-78dc-11e9-983c-6b857ef21bae.png" alt="alertmanager" /></p>

<p>And the notification via slack:</p>

<p><img src="https://user-images.githubusercontent.com/567298/57946602-03e5ad00-78dd-11e9-9ecc-c3d58b2ad3ec.png" alt="alertmanager" /></p>

<p>When you start the service again and head over to the prometheus ui under alerts, you will see that the service recovered:</p>

<p><img src="https://user-images.githubusercontent.com/567298/57946647-2677c600-78dd-11e9-95a9-b9f4190172bf.png" alt="prometheus" /></p>

<h2>Install Prometheus Alertmanager Plugin</h2>

<p>Install the Prometheus Alertmanager Plugin in Grafana. Head to the instance where grafana is installed and install the plugin:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ grafana-cli plugins install camptocamp-prometheus-alertmanager-datasource</span></code></pre></td></tr></table></div></figure>


<p>Once the plugin is installed, restart grafana:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ service grafana-server restart</span></code></pre></td></tr></table></div></figure>


<p>Install the dasboard <a href="https://grafana.com/dashboards/8010">grafana.com/dashboards/8010</a>. Create a new datasource, select the prometheus-alertmanager datasource, configure and save.</p>

<p>Add a new dasboard, select import and provide the ID <code>8010</code>, select the prometheus-alertmanager datasource and save. You should see the following (more or less):</p>

<p><img src="https://user-images.githubusercontent.com/567298/57947092-3f34ab80-78de-11e9-904b-f42d5ecd7d0a.png" alt="prometheus-alertmanager" /></p>

<h2>Resources</h2>

<p>See all <a href="https://blog.ruanbekker.com/blog/categories/prometheus/">#prometheus</a> blogposts</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/17/install-grafana-to-visualize-your-metrics-from-datasources-such-as-prometheus-on-linux/">Install Grafana to Visualize Your Metrics From Datasources Such as Prometheus on Linux</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-17T18:08:02+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>6:08 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/57941411-2a045080-78cf-11e9-97f9-47fb8b75a722.png" alt="image" /></p>

<p>Grafana is a Open Source Dashboarding service that allows you to monitor, analyze and graph metrics from datasources such as prometheus, influxdb, elasticsearch, aws cloudwatch, and many more.</p>

<p>Not only is grafana amazing, its super pretty!</p>

<p>Example of how a dashboard might look like:</p>

<p><img width="1279" alt="E24B39B1-23C8-44C5-959D-6E6275F8FE99" src="https://user-images.githubusercontent.com/567298/57942872-d98ef200-78d2-11e9-9370-b130bcc222f7.png"></p>

<h2>What are we doing today</h2>

<p>In this tutorial we will setup grafana on linux. If you have not set up <a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">prometheus</a>, follow <a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">this blogpost</a> to install prometheus.</p>

<h2>Install Grafana</h2>

<p>I will be demonstrating how to install grafana on debian, if you have another operating system, head over to <a href="https://grafana.com/docs/installation/">grafana documentation</a> for other supported operating systems.</p>

<p>Get the gpg key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl https://packages.grafana.com/gpg.key | sudo apt-key add -</span></code></pre></td></tr></table></div></figure>


<p>Import the public keys:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt-key adv --keyserver keyserver.ubuntu.com --recv-keys  8C8C34C524098CB6 </span></code></pre></td></tr></table></div></figure>


<p>Add the latest stable packages to your repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"</span></code></pre></td></tr></table></div></figure>


<p>Install a pre-requirement package:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install apt-transport-https -y</span></code></pre></td></tr></table></div></figure>


<p>Update the repository index and install grafana:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && sudo apt install grafana -y</span></code></pre></td></tr></table></div></figure>


<p>Once grafana is installed, start the service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ service grafana-server start</span></code></pre></td></tr></table></div></figure>


<p>Then enable the service on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ update-rc.d grafana-server defaults</span></code></pre></td></tr></table></div></figure>


<p>If you want to control the service via systemd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl start grafana-server
</span><span class='line'>$ systemctl status grafana-server</span></code></pre></td></tr></table></div></figure>


<h2>Optional: Nginx Reverse Proxy</h2>

<p>If you want to front your grafana instance with a nginx reverse proxy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/nginx/sites-enabled/grafana
</span><span class='line'>server {
</span><span class='line'>    listen 80;
</span><span class='line'>    server_name grafana.domain.com;
</span><span class='line'>
</span><span class='line'>    location / {
</span><span class='line'>        proxy_pass http://127.0.0.1:3000/;
</span><span class='line'>        proxy_redirect http://127.0.0.1:3000/ /;
</span><span class='line'>        proxy_http_version 1.1;
</span><span class='line'>        proxy_set_header Host $host;
</span><span class='line'>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class='line'>        proxy_set_header X-Real-IP $remote_addr;
</span><span class='line'>    }</span></code></pre></td></tr></table></div></figure>


<p>Then restart nginx:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart nginx</span></code></pre></td></tr></table></div></figure>


<h2>Access Grafana</h2>

<p>If you are accessing grafana directly, access grafana on <code>http://your-grafana-ip:3000/</code> and your username is <code>admin</code> and password <code>admin</code></p>

<h2>Dashboarding Tutorials</h2>

<p>Have a look at this screencast where the guys from grafana show you how to build dashboards:</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/sKNZMtoSHN4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<p>Also have a look at their <a href="https://grafana.com/dashboards">public repository of dashboards</a></p>

<p>For more tutorials on prometheus and metrics have a look at <strong><a href="https://blog.ruanbekker.com/blog/categories/prometheus/">#prometheus</a></strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/17/install-pushgateway-to-expose-metrics-to-prometheus/">Install Pushgateway to Expose Metrics to Prometheus</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-17T13:04:03+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>1:04 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/57307750-696bb980-70e5-11e9-9b0b-73ad88bde6a3.png" alt="" /></p>

<p>In most cases when we want to scrape a node for metrics, we will install node-exporter on a host and configure prometheus to scrape the configured node to consume metric data. But in certain cases we want to push custom metrics to prometheus. In such cases, we can make use of pushgateway.</p>

<p>Pushgateway allows you to push custom metrics to push gateway&rsquo;s endpoint, then we configure prometheus to scrape push gateway to consume the exposed metrics into prometheus.</p>

<p><a href="https://bekkerclothing.com/collections/developer?utm_source=blog.ruanbekker.com&utm_medium=blog&utm_campaign=leaderboard_ad" target="_blank"><img alt="bekker-clothing-developer-tshirts" src="https://user-images.githubusercontent.com/567298/70170981-7c278a80-16d6-11ea-9759-6621d02c1423.png"></a></p>

<h2>Pre-Requirements</h2>

<p>If you have not set up <a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">Prometheus</a>, head over to <strong><a href="https://blog.ruanbekker.com/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">this blogpost</a></strong> to set up prometheus on Linux.</p>

<h2>What we will do?</h2>

<p>In this tutorial, we will setup pushgateway on linux and after pushgateway has been setup, we will push some custom metrics to pushgateway and configure prometheus to scrape metrics from pushgateway.</p>

<h2>Install Pushgateway</h2>

<p>Get the latest version of <a href="https://prometheus.io/download/">pushgateway</a> from prometheus.io, then download and extract:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://github.com/prometheus/pushgateway/releases/download/v0.8.0/pushgateway-0.8.0.linux-amd64.tar.gz
</span><span class='line'>$ tar -xvf pushgateway-0.8.0.linux-amd64.tar.gz</span></code></pre></td></tr></table></div></figure>


<p>Create the <code>pushgateway</code> user:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ useradd --no-create-home --shell /bin/false pushgateway</span></code></pre></td></tr></table></div></figure>


<p>Move the binary in place and update the permissions to the user that we created:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp pushgateway-0.8.0.linux-amd64/pushgateway /usr/local/bin/pushgateway
</span><span class='line'>$ chown pushgateway:pushgateway /usr/local/bin/pushgateway</span></code></pre></td></tr></table></div></figure>


<p>Create the systemd unit file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat &gt; /etc/systemd/system/pushgateway.service &lt;&lt; EOF
</span><span class='line'>[Unit]
</span><span class='line'>Description=Pushgateway
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=pushgateway
</span><span class='line'>Group=pushgateway
</span><span class='line'>Type=simple
</span><span class='line'>ExecStart=/usr/local/bin/pushgateway \
</span><span class='line'>    --web.listen-address=":9091" \
</span><span class='line'>    --web.telemetry-path="/metrics" \
</span><span class='line'>    --persistence.file="/tmp/metric.store" \
</span><span class='line'>    --persistence.interval=5m \
</span><span class='line'>    --log.level="info" \
</span><span class='line'>    --log.format="logger:stdout?json=true"
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target
</span><span class='line'>EOF</span></code></pre></td></tr></table></div></figure>


<p>Reload systemd and restart the pushgateway service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl restart pushgateway</span></code></pre></td></tr></table></div></figure>


<p>Ensure that pushgateway has been started:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl status pushgateway
</span><span class='line'>  pushgateway.service - Pushgateway
</span><span class='line'>   Loaded: loaded (/etc/systemd/system/pushgateway.service; disabled; vendor preset: enabled)
</span><span class='line'>   Active: active (running) since Tue 2019-05-07 09:05:57 UTC; 2min 33s ago
</span><span class='line'> Main PID: 6974 (pushgateway)
</span><span class='line'>    Tasks: 6 (limit: 4704)
</span><span class='line'>   CGroup: /system.slice/pushgateway.service
</span><span class='line'>           └─6974 /usr/local/bin/pushgateway --web.listen-address=:9091 --web.telemetry-path=/metrics --persistence.file=/tmp/metric.store --persistence.interval=5m --log.level=info --log.format=logger:st
</span><span class='line'>
</span><span class='line'>May 07 09:05:57 ip-172-31-41-126 systemd[1]: Started Pushgateway.</span></code></pre></td></tr></table></div></figure>


<h2>Configure Prometheus</h2>

<p>Now we want to configure prometheus to scrape pushgateway for metrics, then the scraped metrics will be injected into prometheus&rsquo;s time series database:</p>

<p>At the moment, I have prometheus, node-exporter and pushgateway on the same node so I will provide my complete prometheus configuration, If you are just looking for the pushgateway config, it will be the last line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/prometheus/prometheus.yml
</span><span class='line'>global:
</span><span class='line'>  scrape_interval: 15s
</span><span class='line'>
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'prometheus'
</span><span class='line'>    scrape_interval: 5s
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['localhost:9090']
</span><span class='line'>
</span><span class='line'>  - job_name: 'node_exporter'
</span><span class='line'>    scrape_interval: 5s
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['localhost:9100']
</span><span class='line'>
</span><span class='line'>  - job_name: 'pushgateway'
</span><span class='line'>    honor_labels: true
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['localhost:9091']</span></code></pre></td></tr></table></div></figure>


<p>Restart prometheus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart prometheus</span></code></pre></td></tr></table></div></figure>


<h2>Push metrics to pushgateway</h2>

<p>First we will look at a bash example to push metrics to pushgateway:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "cpu_utilization 20.25" | curl --data-binary @- http://localhost:9091/metrics/job/my_custom_metrics/instance/10.20.0.1:9000/provider/hetzner</span></code></pre></td></tr></table></div></figure>


<p>Have a look at pushgateway&rsquo;s metrics endpoint:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -L http://localhost:9091/metrics/
</span><span class='line'># TYPE cpu_utilization untyped
</span><span class='line'>cpu_utlization{instance="10.20.0.1:9000",job="my_custom_metrics",provider="hetzner"} 20.25</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s look at a python example on how we can push metrics to pushgateway:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'><span class="n">job_name</span><span class="o">=</span><span class="s">&#39;my_custom_metrics&#39;</span>
</span><span class='line'><span class="n">instance_name</span><span class="o">=</span><span class="s">&#39;10.20.0.1:9000&#39;</span>
</span><span class='line'><span class="n">provider</span><span class="o">=</span><span class="s">&#39;hetzner&#39;</span>
</span><span class='line'><span class="n">payload_key</span><span class="o">=</span><span class="s">&#39;cpu_utilization&#39;</span>
</span><span class='line'><span class="n">payload_value</span><span class="o">=</span><span class="s">&#39;21.90&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;http://localhost:9091/metrics/job/{j}/instance/{i}/team/{t}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">instance_name</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">team_name</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="s">&#39;{k} {v}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">payload_key</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">payload_value</span><span class="p">))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this method, you can push any custom metrics (bash, lambda function, etc) to pushgateway and allow prometheus to consume that data into it&rsquo;s time series database.</p>

<h2>Resources:</h2>

<p>See <a href="https://blog.ruanbekker.com/blog/categories/prometheus/">#prometheus</a> for more posts on Prometheus</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/10/running-a-ha-mysql-galera-cluster-on-docker-swarm/">Running a HA MySQL Galera Cluster on Docker Swarm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-10T13:02:39+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>1:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/57523982-c904d780-7326-11e9-981a-7a9cb9552c2f.png" alt="image" /></p>

<p>In this post we will setup a highly available mysql galera cluster on docker swarm.</p>

<h2>About</h2>

<p>The service is based of <a href="https://github.com/toughIQ/docker-mariadb-cluster">docker-mariadb-cluster</a> repository and it&rsquo;s designed not to have any persistent data attached to the service, but rely on the &ldquo;nodes&rdquo; to replicate the data.</p>

<p>Note, that however this proof of concept works, I always recommend to use a remote mysql database outside your cluster, such as RDS etc.</p>

<p>Since we don&rsquo;t persist any data on the mysql cluster, I have associated a dbclient service that will run continious backups, which we will persist the path where the backups reside to disk.</p>

<h2>Deploy the MySQL Cluster</h2>

<p>The <a href="https://raw.githubusercontent.com/ruanbekker/dockerfiles/master/mysql-cluster/docker-compose.yml">docker-compose.yml</a> that we will use looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.5&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">dbclient</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">BACKUP_ENABLED=1</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">BACKUP_INTERVAL=3600</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">BACKUP_PATH=/data</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">BACKUP_FILENAME=db_backup</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">dbnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">entrypoint</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>      <span class="no">sh -c &#39;sh -s &lt;&lt; EOF</span>
</span><span class='line'>      <span class="no">apk add --no-cache mysql-client</span>
</span><span class='line'>      <span class="no">while true</span>
</span><span class='line'>        <span class="no">do</span>
</span><span class='line'>          <span class="no">if [ $$BACKUP_ENABLED == 1 ]</span>
</span><span class='line'>            <span class="no">then</span>
</span><span class='line'>              <span class="no">sleep $$BACKUP_INTERVAL</span>
</span><span class='line'>              <span class="no">mkdir -p $$BACKUP_PATH/$$(date +%F)</span>
</span><span class='line'>              <span class="no">echo &quot;$$(date +%FT%H.%m) - Making Backup to : $$BACKUP_PATH/$$(date +%F)/$$BACKUP_FILENAME-$$(date +%FT%H.%m).sql.gz&quot;</span>
</span><span class='line'>              <span class="no">mysqldump -u root -ppassword -h dblb --all-databases | gzip &gt; $$BACKUP_PATH/$$(date +%F)/$$BACKUP_FILENAME-$$(date +%FT%H.%m).sql.gz</span>
</span><span class='line'>              <span class="no">find $$BACKUP_PATH -mtime 7 -delete</span>
</span><span class='line'>          <span class="no">fi</span>
</span><span class='line'>        <span class="no">done</span>
</span><span class='line'>      <span class="no">EOF&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">vol_dbclient:/data</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">replicated</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">dbcluster</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">toughiq/mariadb-cluster</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">dbnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DB_SERVICE_NAME=dbcluster</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD=password</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_DATABASE=mydb</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_USER=mydbuser</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">MYSQL_PASSWORD=mydbpass</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">replicated</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">dblb</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">toughiq/maxscale</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">dbnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3306:3306</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">DB_SERVICE_NAME=dbcluster</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ENABLE_ROOT_USER=1</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">replicated</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vol_dbclient</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">dbnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dbnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">overlay</span>
</span></code></pre></td></tr></table></div></figure>


<p>The dbclient is configured to be in the same network as the cluster so it can reach the mysql service. The default behavior is that it will make a backup every hour (3600 seconds) to the <code>/data/{date}/</code> path.</p>

<p>Deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker stack deploy -c docker-compose.yml galera</span>
</span><span class='line'><span class="l-Scalar-Plain">Creating network dbnet</span>
</span><span class='line'><span class="l-Scalar-Plain">Creating service galera_dbcluster</span>
</span><span class='line'><span class="l-Scalar-Plain">Creating service galera_dblb</span>
</span><span class='line'><span class="l-Scalar-Plain">Creating service galera_dbclient</span>
</span></code></pre></td></tr></table></div></figure>


<p>Have a look to see if all the services is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker service ls</span>
</span><span class='line'><span class="l-Scalar-Plain">ID                  NAME                MODE                REPLICAS            IMAGE                            PORTS</span>
</span><span class='line'><span class="l-Scalar-Plain">jm7p70qre72u        galera_dbclient     replicated          1/1                 alpine:latest</span>
</span><span class='line'><span class="l-Scalar-Plain">p8kcr5y7szte        galera_dbcluster    replicated          1/1                 toughiq/mariadb-cluster:latest</span>
</span><span class='line'><span class="l-Scalar-Plain">1hu3oxhujgfm        galera_dblb         replicated          1/1                 toughiq/maxscale:latest          :3306-&gt;3306/tcp</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The Backup Client</h2>

<p>As mentioned the backup client backs up to the <code>/data/</code> path:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker exec -it $(docker ps -f name=galera_dbclient -q) find /data/</span>
</span><span class='line'><span class="l-Scalar-Plain">/data/</span>
</span><span class='line'><span class="l-Scalar-Plain">/data/2019-05-10</span>
</span><span class='line'><span class="l-Scalar-Plain">/data/2019-05-10/db_backup-2019-05-10T10.05.sql.gz</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s go ahead and populate some data into our mysql database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker exec -it $(docker ps -f name=galera_dbclient -q) mysql -uroot -ppassword -h dblb</span>
</span><span class='line'><span class="l-Scalar-Plain">MySQL [(none)]&gt; create table mydb.foo (name varchar(10));</span>
</span><span class='line'><span class="l-Scalar-Plain">MySQL [(none)]&gt; insert into mydb.foo values(&#39;ruan&#39;);</span>
</span><span class='line'><span class="l-Scalar-Plain">MySQL [(none)]&gt; exit</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Scale the Cluster</h2>

<p>At the moment we only have 1 replica for our mysql cluster, let&rsquo;s go ahead and scale the cluster to 3 replicas:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker service scale galera_dbcluster=3</span>
</span><span class='line'><span class="l-Scalar-Plain">galera_dbcluster scaled to 3</span>
</span><span class='line'><span class="l-Scalar-Plain">overall progress</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3 out of 3 tasks</span>
</span><span class='line'><span class="l-Scalar-Plain">1/3</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">running   [==================================================&gt;]</span>
</span><span class='line'><span class="l-Scalar-Plain">2/3</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">running   [==================================================&gt;]</span>
</span><span class='line'><span class="l-Scalar-Plain">3/3</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">running   [==================================================&gt;]</span>
</span><span class='line'><span class="l-Scalar-Plain">verify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Service converged</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify that the service has been scaled:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker service ls</span>
</span><span class='line'><span class="l-Scalar-Plain">ID                  NAME                MODE                REPLICAS            IMAGE                            PORTS</span>
</span><span class='line'><span class="l-Scalar-Plain">jm7p70qre72u        galera_dbclient     replicated          1/1                 alpine:latest</span>
</span><span class='line'><span class="l-Scalar-Plain">p8kcr5y7szte        galera_dbcluster    replicated          3/3                 toughiq/mariadb-cluster:latest</span>
</span><span class='line'><span class="l-Scalar-Plain">1hu3oxhujgfm        galera_dblb         replicated          1/1                 toughiq/maxscale:latest          :3306-&gt;3306/tcp</span>
</span></code></pre></td></tr></table></div></figure>


<p>Test, by reading from the database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker exec -it $(docker ps -f name=galera_dbclient -q) mysql -uroot -ppassword -h dblb -e&#39;select * from mydb.foo;&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| name |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| ruan |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Simulate a Node Failure:</h2>

<p>Simulate a node failure by killing one of the mysql containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker kill 9e336032ab52</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify that one container is missing from our service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker service ls</span>
</span><span class='line'><span class="l-Scalar-Plain">ID                  NAME                MODE                REPLICAS            IMAGE                            PORTS</span>
</span><span class='line'><span class="l-Scalar-Plain">p8kcr5y7szte        galera_dbcluster    replicated          2/3                 toughiq/mariadb-cluster:latest</span>
</span></code></pre></td></tr></table></div></figure>


<p>While the container is provisioning, as we have 2 out of 3 running containers, read the data 3 times so test that the round robin queries dont hit the affected container (the dblb wont route traffic to the affected container):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker exec -it $(docker ps -f name=galera_dbclient -q) mysql -uroot -ppassword -h dblb -e&#39;select * from mydb.foo;&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| name |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| ruan |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">$ docker exec -it $(docker ps -f name=galera_dbclient -q) mysql -uroot -ppassword -h dblb -e&#39;select * from mydb.foo;&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| name |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| ruan |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">$ docker exec -it $(docker ps -f name=galera_dbclient -q) mysql -uroot -ppassword -h dblb -e&#39;select * from mydb.foo;&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| name |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| ruan |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify that the 3rd container has checked in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker service ls</span>
</span><span class='line'><span class="l-Scalar-Plain">ID                  NAME                MODE                REPLICAS            IMAGE                            PORTS</span>
</span><span class='line'><span class="l-Scalar-Plain">p8kcr5y7szte        galera_dbcluster    replicated          3/3                 toughiq/mariadb-cluster:latest</span>
</span></code></pre></td></tr></table></div></figure>


<h2>How to Restore?</h2>

<p>I&rsquo;m deleting the database to simulate the scenario where we need to restore:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ docker exec -it $(docker ps -f name=galera_dbclient -q) sh</span>
</span><span class='line'><span class="l-Scalar-Plain">&gt; mysql -uroot -ppassword -h dblb -e&#39;drop database mydb;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ensure the db is not present:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">&gt;</span><span class="err"> mysql -uroot -ppassword -h dblb -e&#39;select * from mydb.foo;&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">ERROR 1146 (42S02) at line 1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Table &#39;mydb.foo&#39; doesn&#39;t exist</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find the archive and extract:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">&gt;</span><span class="err"> find /data/</span>
</span><span class='line'><span class="l-Scalar-Plain">/data/</span>
</span><span class='line'><span class="l-Scalar-Plain">/data/2019-05-10</span>
</span><span class='line'><span class="l-Scalar-Plain">/data/2019-05-10/db_backup-2019-05-10T10.05.sql.gz</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">&gt; gunzip /data/2019-05-10/db_backup-2019-05-10T10.05.sql.gz</span>
</span></code></pre></td></tr></table></div></figure>


<p>Restore the backed up database to MySQL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">&gt;</span><span class="err"> mysql -uroot -ppassword -h dblb &lt; /data/2019-05-10/db_backup-2019-05-10T10.05.sql</span>
</span></code></pre></td></tr></table></div></figure>


<p>Test that we can read our data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">&gt;</span><span class="err"> mysql -uroot -ppassword -h dblb -e&#39;select * from mydb.foo;&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| name |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span><span class='line'><span class="l-Scalar-Plain">| ruan |</span>
</span><span class='line'><span class="l-Scalar-Plain">+------+</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/07/create-secrets-with-vaults-transits-secret-engine/">Create Secrets With Vaults Transits Secret Engine</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-07T22:31:54+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>10:31 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://camo.githubusercontent.com/b2223b0ca7077fcf9919372582183757239e4153/68747470733a2f2f6c6561726e2e6861736869636f72702e636f6d2f6173736574732f696d616765732f7661756c742d656e6372797074696f6e2e706e67" alt="" /></p>

<p>Vault&rsquo;s transit secrets engine handles cryptographic functions on data-in-transit. Vault doesn&rsquo;t store the data sent to the secrets engine, so it can also be viewed as encryption as a service.</p>

<p>In this tutorial we will demonstrate how to use Vault&rsquo;s Transit Secret Engine.</p>

<p>Related Posts:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/06/setup-hashicorp-vault-server-on-docker-and-cli-guide/">Setup a Vault Server on Docker</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/07/persist-vault-data-with-amazon-s3-as-a-storage-backend/">Use the S3 Storage Backend to Persist Data</a></li>
</ul>


<h2>Enable the Transit Engine:</h2>

<p>Enable transit secret engine using the /sys/mounts endpoint:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl --header "X-Vault-Token: $VAULT_TOKEN" -XPOST -d '{"type": "transit", "description": "encs encryption"}' http://127.0.0.1:8200/v1/sys/mounts/transit</span></code></pre></td></tr></table></div></figure>


<h2>Create the Key Ring:</h2>

<p>Create an encryption key ring named <code>fookey</code> using the transit/keys endpoint:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s --header "X-Vault-Token: $VAULT_TOKEN" -XGET http://127.0.0.1:8200/v1/transit/keys/fookey | jq
</span><span class='line'>{
</span><span class='line'>  "request_id": "8375227a-4a9f-a108-0b89-84c448419e80",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "allow_plaintext_backup": false,
</span><span class='line'>    "deletion_allowed": false,
</span><span class='line'>    "derived": false,
</span><span class='line'>    "exportable": false,
</span><span class='line'>    "keys": {
</span><span class='line'>      "1": 1554654295
</span><span class='line'>    },
</span><span class='line'>    "latest_version": 1,
</span><span class='line'>    "min_available_version": 0,
</span><span class='line'>    "min_decryption_version": 1,
</span><span class='line'>    "min_encryption_version": 0,
</span><span class='line'>    "name": "fookey",
</span><span class='line'>    "supports_decryption": true,
</span><span class='line'>    "supports_derivation": true,
</span><span class='line'>    "supports_encryption": true,
</span><span class='line'>    "supports_signing": false,
</span><span class='line'>    "type": "aes256-gcm96"
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Encoding</h2>

<p>Encode your string:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ base64 &lt;&lt;&lt; "hello world"
</span><span class='line'>aGVsbG8gd29ybGQK</span></code></pre></td></tr></table></div></figure>


<h2>Encrypt</h2>

<p>To encrypt your secret, use the transit/encrypt endpoint:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s --header "X-Vault-Token: $VAULT_TOKEN" --request POST  --data '{"plaintext": "aGVsbG8gd29ybGQK"}' http://127.0.0.1:8200/v1/transit/encrypt/fookey | jq
</span><span class='line'>{
</span><span class='line'>  "request_id": "ab00ba0f-9e45-0aca-e3c1-7765fd83fc3c",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "ciphertext": "vault:v1:Yo4U6xXFM2FoBOaUrw0w3EpSlJS6gmsa4HP1xKtjrk0+xSqi5Rvjvg=="
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Decrypt:</h2>

<p>Use the transit/decrypt endpoint to decrypt the ciphertext:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s --header "X-Vault-Token: $VAULT_TOKEN" --request POST  --data '{"ciphertext": "vault:v1:Yo4U6xXFM2FoBOaUrw0w3EpSlJS6gmsa4HP1xKtjrk0+xSqi5Rvjvg=="}' http://127.0.0.1:8200/v1/transit/decrypt/fookey | jq
</span><span class='line'>{
</span><span class='line'>  "request_id": "3d9743a0-2daf-823c-f413-8c8a90753479",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "plaintext": "aGVsbG8gd29ybGQK"
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Decoding</h2>

<p>Decode the response:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ base64 --decode &lt;&lt;&lt; "aGVsbG8gd29ybGQK"
</span><span class='line'>hello world</span></code></pre></td></tr></table></div></figure>


<h2>Resources</h2>

<ul>
<li><a href="https://learn.hashicorp.com/vault/encryption-as-a-service/eaas-transit">Vault Documentation on this topic</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/07/use-the-vault-api-to-provision-app-keys-and-create-kv-pairs/">Use the Vault API to Provision App Keys and Create KV Pairs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-07T22:23:10+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>10:23 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/57256060-f1a27e00-7055-11e9-9a05-77d3fdd6c76f.png" alt="" /></p>

<p>In this tutorial we will use Vault API to create a user and allow that user to write/read key/value pairs from a given path.</p>

<p>Related Posts:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/06/setup-hashicorp-vault-server-on-docker-and-cli-guide/">Setup a Vault Server on Docker</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/06/setup-hashicorp-vault-server-on-docker-and-cli-guide/">Getting Started with the Vault CLI</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/07/persist-vault-data-with-amazon-s3-as-a-storage-backend/">Use the S3 Storage Backend to Persist Data</a></li>
<li><a href="https://blog.ruanbekker.com/blog/2019/05/07/create-secrets-with-vaults-transits-secret-engine/">Create Secrets with Vaults Transit Secret Engine</a></li>
</ul>


<h2>Credentials / Authentication</h2>

<p>Export Vault Root Tokens:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export ROOT_TOKEN="$(cat ~/.vault-token)"
</span><span class='line'>$ export VAULT_TOKEN=${ROOT_TOKEN}</span></code></pre></td></tr></table></div></figure>


<p>Check the vault status:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET -H "X-Vault-Token: ${VAULT_TOKEN}" http://127.0.0.1:8200/v1/sys/health | jq
</span><span class='line'>{
</span><span class='line'>  "initialized": true,
</span><span class='line'>  "sealed": false,
</span><span class='line'>  "standby": false,
</span><span class='line'>  "performance_standby": false,
</span><span class='line'>  "replication_performance_mode": "disabled",
</span><span class='line'>  "replication_dr_mode": "disabled",
</span><span class='line'>  "server_time_utc": 1554652468,
</span><span class='line'>  "version": "1.1.0",
</span><span class='line'>  "cluster_name": "vault-cluster-bfb00cd7",
</span><span class='line'>  "cluster_id": "dc1dc9a6-xx-xx-xx-a2870f475e7a"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Do a lookup for the root user:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET -H "X-Vault-Token: ${VAULT_TOKEN}" http://127.0.0.1:8200/v1/auth/token/lookup-self | jq
</span><span class='line'>{
</span><span class='line'>  "request_id": "69a19f66-5bad-3af2-81a5-81ca24e50b02",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "accessor": "A7Xkik1ebWpUfzqNrvADmQ08",
</span><span class='line'>    "creation_time": 1554651149,
</span><span class='line'>    "creation_ttl": 0,
</span><span class='line'>    "display_name": "root",
</span><span class='line'>    "entity_id": "",
</span><span class='line'>    "expire_time": null,
</span><span class='line'>    "explicit_max_ttl": 0,
</span><span class='line'>    "id": "s.po8HkMdCnnAerlCAeHGGGszQ",
</span><span class='line'>    "meta": null,
</span><span class='line'>    "num_uses": 0,
</span><span class='line'>    "orphan": true,
</span><span class='line'>    "path": "auth/token/root",
</span><span class='line'>    "policies": [
</span><span class='line'>      "root"
</span><span class='line'>    ],
</span><span class='line'>    "ttl": 0,
</span><span class='line'>    "type": "service"
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Create the Roles</h2>

<p>Create the AppRole:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XPOST -H "X-Vault-Token: ${VAULT_TOKEN}" -d '{"type": "approle"}' http://127.0.0.1:8200/v1/sys/auth/approle | jq
</span><span class='line'>$ curl -s -XGET -H "X-Vault-Token: ${VAULT_TOKEN}" http://127.0.0.1:8200/v1/sys/auth | jq
</span><span class='line'>{
</span><span class='line'>  "token/": {
</span><span class='line'>    "accessor": "auth_token_31f2381e",
</span><span class='line'>    "config": {
</span><span class='line'>      "default_lease_ttl": 0,
</span><span class='line'>      "force_no_cache": false,
</span><span class='line'>      "max_lease_ttl": 0,
</span><span class='line'>      "token_type": "default-service"
</span><span class='line'>    },
</span><span class='line'>    "description": "token based credentials",
</span><span class='line'>    "local": false,
</span><span class='line'>    "options": null,
</span><span class='line'>    "seal_wrap": false,
</span><span class='line'>    "type": "token"
</span><span class='line'>  },
</span><span class='line'>  "approle/": {
</span><span class='line'>    "accessor": "auth_approle_d542dcad",
</span><span class='line'>    "config": {
</span><span class='line'>      "default_lease_ttl": 0,
</span><span class='line'>      "force_no_cache": false,
</span><span class='line'>      "max_lease_ttl": 0,
</span><span class='line'>      "token_type": "default-service"
</span><span class='line'>    },
</span><span class='line'>    "description": "",
</span><span class='line'>    "local": false,
</span><span class='line'>    "options": {},
</span><span class='line'>    "seal_wrap": false,
</span><span class='line'>    "type": "approle"
</span><span class='line'>  },
</span><span class='line'>  "request_id": "20554948-b8e0-4254-f21d-f9ad25f1e5d5",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "approle/": {
</span><span class='line'>      "accessor": "auth_approle_d542dcad",
</span><span class='line'>      "config": {
</span><span class='line'>        "default_lease_ttl": 0,
</span><span class='line'>        "force_no_cache": false,
</span><span class='line'>        "max_lease_ttl": 0,
</span><span class='line'>        "token_type": "default-service"
</span><span class='line'>      },
</span><span class='line'>      "description": "",
</span><span class='line'>      "local": false,
</span><span class='line'>      "options": {},
</span><span class='line'>      "seal_wrap": false,
</span><span class='line'>      "type": "approle"
</span><span class='line'>    },
</span><span class='line'>    "token/": {
</span><span class='line'>      "accessor": "auth_token_31f2381e",
</span><span class='line'>      "config": {
</span><span class='line'>        "default_lease_ttl": 0,
</span><span class='line'>        "force_no_cache": false,
</span><span class='line'>        "max_lease_ttl": 0,
</span><span class='line'>        "token_type": "default-service"
</span><span class='line'>      },
</span><span class='line'>      "description": "token based credentials",
</span><span class='line'>      "local": false,
</span><span class='line'>      "options": null,
</span><span class='line'>      "seal_wrap": false,
</span><span class='line'>      "type": "token"
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Create the test policy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XPOST -H "X-Vault-Token: ${VAULT_TOKEN}" -d '{"policy": "{\"name\": \"test\", \"path\": {\"secret/*\": {\"policy\": \"write\"}}}"}' http://127.0.0.1:8200/v1/sys/policy/test
</span><span class='line'>$ curl -s -XGET -H "X-Vault-Token: ${VAULT_TOKEN}" http://127.0.0.1:8200/v1/sys/policy/test | jq
</span><span class='line'>{
</span><span class='line'>  "name": "test",
</span><span class='line'>  "rules": "{\"name\": \"test\", \"path\": {\"secret/*\": {\"policy\": \"write\"}}}",
</span><span class='line'>  "request_id": "e4f55dc0-575f-ead9-48f6-43154153889a",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "name": "test",
</span><span class='line'>    "rules": "{\"name\": \"test\", \"path\": {\"secret/*\": {\"policy\": \"write\"}}}"
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Attach the policy to the approle:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -XPOST -H "X-Vault-Token: ${VAULT_TOKEN}" -d '{"policies": "test"}' http://127.0.0.1:8200/v1/auth/approle/role/app
</span><span class='line'>$ curl -s -XGET -H "X-Vault-Token: ${VAULT_TOKEN}" 'http://127.0.0.1:8200/v1/auth/approle/role?list=true' | jq .
</span><span class='line'>{
</span><span class='line'>  "request_id": "e645cad9-9010-4299-0e6b-0baf6d9194b8",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "keys": [
</span><span class='line'>      "app"
</span><span class='line'>    ]
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Enable the kv store:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -H "X-Vault-Token: ${VAULT_TOKEN}" -XPOST --data '{"type": "kv", "description": "my key value store", "config": {"force_no_cache": true}}' http://127.0.0.1:8200/v1/sys/mounts/secret</span></code></pre></td></tr></table></div></figure>


<h2>Create the User Credentials</h2>

<p>Get the role_id:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET -H "X-Vault-Token: ${VAULT_TOKEN}" http://127.0.0.1:8200/v1/auth/approle/role/app/role-id | jq
</span><span class='line'>{
</span><span class='line'>  "request_id": "e803a1bf-a492-dad7-68db-bb1506752e03",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "role_id": "3e365c72-7aad-f4e4-521c-d7cf0dd83c0f"
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Create the secret_id:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XPOST -H "X-Vault-Token: ${VAULT_TOKEN}" http://127.0.0.1:8200/v1/auth/approle/role/app/secret-id | jq
</span><span class='line'>{
</span><span class='line'>  "request_id": "b56d20c0-ff8a-a1fe-4d5f-42e57b625b83",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "secret_id": "5eecfe29-d6e1-50e6-7a70-04c6bea42b76",
</span><span class='line'>    "secret_id_accessor": "2fa80586-32b9-1c6f-fe1d-7c547e5403e5"
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Create the token with the role_id and secret_id:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XPOST -d '{"role_id": "3e365c72-7aad-f4e4-521c-d7cf0dd83c0f","secret_id": "5eecfe29-d6e1-50e6-7a70-04c6bea42b76"}' http://127.0.0.1:8200/v1/auth/approle/login | jq
</span><span class='line'>{
</span><span class='line'>  "request_id": "82470940-ef09-bcbb-f7a0-bdf085b4f47b",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": null,
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": {
</span><span class='line'>    "client_token": "s.7EtwtRGsZWOtkqcMvj3UMLP0",
</span><span class='line'>    "accessor": "2TPL1vg5IZXgVF6Xf1RRzbmL",
</span><span class='line'>    "policies": [
</span><span class='line'>      "default",
</span><span class='line'>      "test"
</span><span class='line'>    ],
</span><span class='line'>    "token_policies": [
</span><span class='line'>      "default",
</span><span class='line'>      "test"
</span><span class='line'>    ],
</span><span class='line'>    "metadata": {
</span><span class='line'>      "role_name": "app"
</span><span class='line'>    },
</span><span class='line'>    "lease_duration": 2764800,
</span><span class='line'>    "renewable": true,
</span><span class='line'>    "entity_id": "d5051b01-b7ce-626c-a9f4-e1663f8c23e8",
</span><span class='line'>    "token_type": "service",
</span><span class='line'>    "orphan": true
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Create KV Pairs with New User</h2>

<p>Export the user auth with the received token:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export APP_TOKEN=s.7EtwtRGsZWOtkqcMvj3UMLP0
</span><span class='line'>$ export VAULT_TOKEN=$APP_TOKEN</span></code></pre></td></tr></table></div></figure>


<p>Verify if you can lookup your own info:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET -H "X-Vault-Token: ${VAULT_TOKEN}" http://127.0.0.1:8200/v1/auth/token/lookup-self | jq
</span><span class='line'>{
</span><span class='line'>  "request_id": "2e69cd68-8668-3159-6440-c430cb61d2e6",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 0,
</span><span class='line'>  "data": {
</span><span class='line'>    "accessor": "2TPL1vg5IZXgVF6Xf1RRzbmL",
</span><span class='line'>    "creation_time": 1554651882,
</span><span class='line'>    "creation_ttl": 2764800,
</span><span class='line'>    "display_name": "approle",
</span><span class='line'>    "entity_id": "d5051b01-b7ce-626c-a9f4-e1663f8c23e8",
</span><span class='line'>    "expire_time": "2019-05-09T15:44:42.1013993Z",
</span><span class='line'>    "explicit_max_ttl": 0,
</span><span class='line'>    "id": "s.7EtwtRGsZWOtkqcMvj3UMLP0",
</span><span class='line'>    "issue_time": "2019-04-07T15:44:42.1013788Z",
</span><span class='line'>    "meta": {
</span><span class='line'>      "role_name": "app"
</span><span class='line'>    },
</span><span class='line'>    "num_uses": 0,
</span><span class='line'>    "orphan": true,
</span><span class='line'>    "path": "auth/approle/login",
</span><span class='line'>    "policies": [
</span><span class='line'>      "default",
</span><span class='line'>      "test"
</span><span class='line'>    ],
</span><span class='line'>    "renewable": true,
</span><span class='line'>    "ttl": 2764556,
</span><span class='line'>    "type": "service"
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Create a KV pair:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XPOST -H "X-Vault-Token: ${VAULT_TOKEN}" -d '{"app_password": "secret123"}' http://127.0.0.1:8200/v1/secret/app01/app_password</span></code></pre></td></tr></table></div></figure>


<p>Read the secret from KV pair:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XGET -H "X-Vault-Token: ${VAULT_TOKEN}" http://127.0.0.1:8200/v1/secret/app01/app_password | jq
</span><span class='line'>{
</span><span class='line'>  "request_id": "70d5f16d-2abb-fcfd-063f-0e21d9cef8fd",
</span><span class='line'>  "lease_id": "",
</span><span class='line'>  "renewable": false,
</span><span class='line'>  "lease_duration": 2764800,
</span><span class='line'>  "data": {
</span><span class='line'>    "app_password": "secret123"
</span><span class='line'>  },
</span><span class='line'>  "wrap_info": null,
</span><span class='line'>  "warnings": null,
</span><span class='line'>  "auth": null
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Try to write outside the allowed path:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -s -XPOST -H "X-Vault-Token: ${VAULT_TOKEN}" -d '{"app_password": "secret123"}' http://127.0.0.1:8200/v1/secrets/app01/app_password
</span><span class='line'>{"errors":["1 error occurred:\n\t* permission denied\n\n"]}</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://www.vaultproject.io/api/system/audit.html">https://www.vaultproject.io/api/system/audit.html</a></li>
<li><a href="https://learn.hashicorp.com/vault/getting-started/apis">https://learn.hashicorp.com/vault/getting-started/apis</a></li>
<li><a href="https://www.hashicorp.com/resources/getting-vault-enterprise-installed-running">https://www.hashicorp.com/resources/getting-vault-enterprise-installed-running</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/07/persist-vault-data-with-amazon-s3-as-a-storage-backend/">Persist Vault Data With Amazon S3 as a Storage Backend</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-07T22:01:45+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>10:01 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/57256060-f1a27e00-7055-11e9-9a05-77d3fdd6c76f.png" alt="" /></p>

<p>In a previous post we have set up <a href="https://blog.ruanbekker.com/blog/2019/05/06/setup-hashicorp-vault-server-on-docker-and-cli-guide/">the vault server on docker</a>, but using a file backend to persist our data.</p>

<p>In this tutorial we will configure vault to use <a href="https://www.vaultproject.io/docs/configuration/storage/s3.html">amazon s3 as a storage backend</a> to persist our data for vault.</p>

<h2>Provision S3 Bucket</h2>

<p>Create the S3 Bucket where our data will reside:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aws s3 mb --region=eu-west-1 s3://somename-vault-backend</span></code></pre></td></tr></table></div></figure>


<h2>Vault Config</h2>

<p>Create the vault config, where we will provide details about our storage backend and configuration for the vault server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim volumes/config/s3vault.json</span></code></pre></td></tr></table></div></figure>


<p>Populate the config file with the following details, you will just need to provide your own credentials:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;backend&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;s3&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;access_key&quot;</span><span class="p">:</span> <span class="s2">&quot;ACCESS_KEY&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;secret_key&quot;</span><span class="p">:</span> <span class="s2">&quot;SECRET_KEY&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;bucket&quot;</span><span class="p">:</span> <span class="s2">&quot;somename-vault-backend&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;listener&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;tcp&quot;</span><span class="p">:{</span>
</span><span class='line'>      <span class="nt">&quot;address&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.0.0:8200&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;tls_disable&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;ui&quot;</span><span class="p">:</span> <span class="kc">true</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Docker Compose</h2>

<p>As we are using docker to deploy our vault server, our docker-compose.yml:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">$</span> <span class="err">cat</span> <span class="err">&gt;</span> <span class="err">docker-compose.yml</span> <span class="err">&lt;&lt;</span> <span class="err">EOF</span>
</span><span class='line'><span class="err">version:</span> <span class="err">&#39;</span><span class="mi">2</span><span class="err">&#39;</span>
</span><span class='line'><span class="err">services:</span>
</span><span class='line'>  <span class="err">vault:</span>
</span><span class='line'>    <span class="err">image:</span> <span class="err">vault</span>
</span><span class='line'>    <span class="err">container_name:</span> <span class="err">vault</span>
</span><span class='line'>    <span class="err">ports:</span>
</span><span class='line'>      <span class="err">-</span> <span class="s2">&quot;8200:8200&quot;</span>
</span><span class='line'>    <span class="err">restart:</span> <span class="err">always</span>
</span><span class='line'>    <span class="err">volumes:</span>
</span><span class='line'>      <span class="err">-</span> <span class="err">./volumes/logs:/vault/logs</span>
</span><span class='line'>      <span class="err">-</span> <span class="err">./volumes/file:/vault/file</span>
</span><span class='line'>      <span class="err">-</span> <span class="err">./volumes/config:/vault/config</span>
</span><span class='line'>    <span class="err">cap_add:</span>
</span><span class='line'>      <span class="err">-</span> <span class="err">IPC_LOCK</span>
</span><span class='line'>    <span class="err">entrypoint:</span> <span class="err">vault</span> <span class="err">server</span> <span class="err">-config=/vault/config/s</span><span class="mi">3</span><span class="err">vault.json</span>
</span><span class='line'><span class="err">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploy the vault server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="err">$</span> <span class="err">docker-compose</span> <span class="err">up</span>
</span></code></pre></td></tr></table></div></figure>


<p>Go ahead and create some secrets, then deploy the docker container on another host to test out the data persistence.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/05/07/setup-prometheus-and-node-exporter-on-ubuntu-for-epic-monitoring/">Setup Prometheus and Node Exporter on Ubuntu for Epic Monitoring</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-05-07T15:55:37+02:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/57307750-696bb980-70e5-11e9-9b0b-73ad88bde6a3.png" alt="image" /></p>

<p><a href="https://prometheus.io/">Prometheus</a> is one of those awesome open source monitoring services that I simply cannot live without. Prometheus is a Time Series Database that collects metrics from services using it&rsquo;s exporters functionality. Prometheus has its own query language called PromQL and makes graphing epic visualiztions with services such as Grafana a breeze.</p>

<p><a href="https://bekkerclothing.com/collections/developer?utm_source=blog.ruanbekker.com&utm_medium=blog&utm_campaign=leaderboard_ad" target="_blank"><img alt="bekker-clothing-developer-tshirts" src="https://user-images.githubusercontent.com/567298/70170981-7c278a80-16d6-11ea-9759-6621d02c1423.png"></a></p>

<h2>What are we doing today</h2>

<p>We will install the <code>prometheus</code> service and set up <code>node_exporter</code> to consume node related metrics such as cpu, memory, io etc that will be scraped by the exporter configuration on prometheus, which then gets pushed into prometheus&rsquo;s time series database. Which can then be used by services such as Grafana to visualize the data.</p>

<p>Other exporters is also available, such as: <code>haproxy_exporter</code>, <code>blackbox_exporter</code> etc, then you also get <code>pushgateway</code> which is used to push data to, and then your exporter configuration scrapes the data from the pushgateway endpoint. In a later tutorial, we will set up push gateway as well.</p>

<h2>Install Prometheus</h2>

<p>First, let&rsquo;s provision our dedicated system users for prometheus and node exporter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ useradd --no-create-home --shell /bin/false prometheus
</span><span class='line'>$ useradd --no-create-home --shell /bin/false node_exporter</span></code></pre></td></tr></table></div></figure>


<p>Create the directories for it&rsquo;s system files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /etc/prometheus
</span><span class='line'>$ mkdir /var/lib/prometheus</span></code></pre></td></tr></table></div></figure>


<p>Apply the permissions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chown prometheus:prometheus /etc/prometheus
</span><span class='line'>$ chown prometheus:prometheus /var/lib/prometheus</span></code></pre></td></tr></table></div></figure>


<p>Next, update your system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt upgrade -y</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s install prometheus, head over to <a href="https://prometheus.io/download/">https://prometheus.io/download/</a> and get the latest version of prometheus:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://github.com/prometheus/prometheus/releases/download/v2.8.0/prometheus-2.8.0.linux-amd64.tar.gz
</span><span class='line'>$ tar -xf prometheus-2.8.0.linux-amd64.tar.gz
</span><span class='line'>$ cp prometheus-2.8.0.linux-amd64/prometheus /usr/local/bin/
</span><span class='line'>$ cp prometheus-2.8.0.linux-amd64/promtool /usr/local/bin/
</span><span class='line'>$ chown prometheus:prometheus /usr/local/bin/prometheus
</span><span class='line'>$ chown prometheus:prometheus /usr/local/bin/promtool
</span><span class='line'>$ cp -r prometheus-2.8.0.linux-amd64/consoles /etc/prometheus/
</span><span class='line'>$ cp -r prometheus-2.8.0.linux-amd64/console_libraries /etc/prometheus/
</span><span class='line'>$ chown -R prometheus:prometheus /etc/prometheus/consoles
</span><span class='line'>$ chown -R prometheus:prometheus /etc/prometheus/console_libraries
</span><span class='line'>$ rm -rf prometheus-2.8.0.linux-amd64*</span></code></pre></td></tr></table></div></figure>


<h2>Configure Prometheus</h2>

<p>We need to tell prometheus to scrape itself in order to get prometheus performance data, edit the prometheus configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/prometheus/prometheus.yml</span></code></pre></td></tr></table></div></figure>


<p>And add a scrape config: Set the interval on when it needs to scrap, the job name which will be in your metric and the endpoint which it needs to scrape:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global:
</span><span class='line'>  scrape_interval: 15s
</span><span class='line'>
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'prometheus'
</span><span class='line'>    scrape_interval: 5s
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['localhost:9090']</span></code></pre></td></tr></table></div></figure>


<p>Apply permissions to the configured file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chown prometheus:prometheus /etc/prometheus/prometheus.yml</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to define a systemd unit file so we can control the daemon using systemd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/systemd/system/prometheus.service</span></code></pre></td></tr></table></div></figure>


<p>The config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=Prometheus
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=prometheus
</span><span class='line'>Group=prometheus
</span><span class='line'>Type=simple
</span><span class='line'>ExecStart=/usr/local/bin/prometheus \
</span><span class='line'>    --config.file /etc/prometheus/prometheus.yml \
</span><span class='line'>    --storage.tsdb.path /var/lib/prometheus/ \
</span><span class='line'>    --web.console.templates=/etc/prometheus/consoles \
</span><span class='line'>    --web.console.libraries=/etc/prometheus/console_libraries
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Since we created a new systemd unit file, we need to reload the systemd daemon, then start the service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl start prometheus</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s look at the status to see if everything works as expected:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl status prometheus
</span><span class='line'>prometheus.service - Prometheus
</span><span class='line'>   Loaded: loaded (/etc/systemd/system/prometheus.service; disabled; vendor preset: enabled)
</span><span class='line'>   Active: active (running) since Tue 2019-03-26 11:59:10 UTC; 6s ago
</span><span class='line'> Main PID: 16374 (prometheus)
</span><span class='line'>    Tasks: 9 (limit: 4704)
</span><span class='line'>   CGroup: /system.slice/prometheus.service
</span><span class='line'>           └─16374 /usr/local/bin/prometheus --config.file /etc/prometheus/prometheus.yml --storage.tsdb.path /var/lib/prometheus/ --web.console.templates=/etc/prometheus/consoles --web.console.libraries=
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>Mar 26 11:59:10 ip-172-31-41-126 prometheus[16374]: level=info ts=2019-03-26T11:59:10.893770598Z caller=main.go:655 msg="TSDB started"</span></code></pre></td></tr></table></div></figure>


<p>Seems legit! Enable the service on startup:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable prometheus</span></code></pre></td></tr></table></div></figure>


<h2>Install Node Exporter</h2>

<p>Now since we have prometheus up and running, we can start adding exporters to publish data into our prometheus time series database. As mentioned before, with node exporter, we will allow prometheus to scrape the node exporter endpoint to consume metrics about the node:</p>

<p>You will find the latest version from their website, which I have added at the top of this post.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://github.com/prometheus/node_exporter/releases/download/v0.17.0/node_exporter-0.17.0.linux-amd64.tar.gz
</span><span class='line'>$ tar -xf node_exporter-0.17.0.linux-amd64.tar.gz
</span><span class='line'>$ cp node_exporter-0.17.0.linux-amd64/node_exporter /usr/local/bin
</span><span class='line'>$ chown node_exporter:node_exporter /usr/local/bin/node_exporter
</span><span class='line'>$ rm -rf node_exporter-0.17.0.linux-amd64*</span></code></pre></td></tr></table></div></figure>


<p>Create the systemd unit file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/systemd/system/node_exporter.service</span></code></pre></td></tr></table></div></figure>


<p>Apply this configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Unit]
</span><span class='line'>Description=Node Exporter
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=node_exporter
</span><span class='line'>Group=node_exporter
</span><span class='line'>Type=simple
</span><span class='line'>ExecStart=/usr/local/bin/node_exporter
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Reload the systemd daemon and start node exporter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl daemon-reload
</span><span class='line'>$ systemctl start node_exporter</span></code></pre></td></tr></table></div></figure>


<p>Look at the status:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ node_exporter.service - Node Exporter
</span><span class='line'>   Loaded: loaded (/etc/systemd/system/node_exporter.service; disabled; vendor preset: enabled)
</span><span class='line'>   Active: active (running) since Tue 2019-03-26 12:01:39 UTC; 5s ago
</span><span class='line'> Main PID: 16474 (node_exporter)
</span><span class='line'>    Tasks: 4 (limit: 4704)
</span><span class='line'>   CGroup: /system.slice/node_exporter.service
</span><span class='line'>           └─16474 /usr/local/bin/node_exporter
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>Mar 26 12:01:39 ip-172-31-41-126 node_exporter[16474]: time="2019-03-26T12:01:39Z" level=info msg="Listening on :9100" source="node_exporter.go:111"</span></code></pre></td></tr></table></div></figure>


<p>If everything looks good, enable the service on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl enable node_exporter</span></code></pre></td></tr></table></div></figure>


<h2>Configure Node Exporter</h2>

<p>Now that we have node exporter running, we need to tell prometheus how to scrape node exporter, so that the node related metrics can end up into prometheus. Edit the prometheus config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /etc/prometheus/prometheus.yml</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m providing the full config, but the config is the last section, where you can see the jobname is node_exporter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>global:
</span><span class='line'>  scrape_interval: 15s
</span><span class='line'>
</span><span class='line'>scrape_configs:
</span><span class='line'>  - job_name: 'prometheus'
</span><span class='line'>    scrape_interval: 5s
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['localhost:9090']
</span><span class='line'>
</span><span class='line'>  - job_name: 'node_exporter'
</span><span class='line'>    scrape_interval: 5s
</span><span class='line'>    static_configs:
</span><span class='line'>      - targets: ['localhost:9100']</span></code></pre></td></tr></table></div></figure>


<p>Once the config is saved, restart prometheus and have a look at the status if everything is going as expected:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart prometheus
</span><span class='line'>$ systemctl status prometheus</span></code></pre></td></tr></table></div></figure>


<h2>Nginx Reverse Proxy</h2>

<p>Let&rsquo;s add a layer of security and front our setup with a nginx reverse proxy, so that we don&rsquo;t have to access prometheus on high ports and we have the option to enable basic http authentication. Install nginx:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install nginx apache2-utils -y</span></code></pre></td></tr></table></div></figure>


<p>Create the authentication file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ htpasswd -c /etc/nginx/.htpasswd admin</span></code></pre></td></tr></table></div></figure>


<p>Create the nginx site configuration, this will tel nginx to route connections on port 80, to reverse proxy to localhost, port 9090, if authenticated:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rm /etc/nginx/sites-enabled/default
</span><span class='line'>$ vim /etc/nginx/sites-enabled/prometheus.conf</span></code></pre></td></tr></table></div></figure>


<p>And this is the config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>    listen 80 default_server;
</span><span class='line'>    listen [::]:80 default_server;
</span><span class='line'>    root /var/www/html;
</span><span class='line'>    index index.html index.htm index.nginx-debian.html;
</span><span class='line'>    server_name _;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    location / {
</span><span class='line'>            auth_basic "Prometheus Auth";
</span><span class='line'>            auth_basic_user_file /etc/nginx/.htpasswd;
</span><span class='line'>            proxy_pass http://localhost:9090;
</span><span class='line'>            proxy_http_version 1.1;
</span><span class='line'>            proxy_set_header Upgrade $http_upgrade;
</span><span class='line'>            proxy_set_header Connection 'upgrade';
</span><span class='line'>            proxy_set_header Host $host;
</span><span class='line'>            proxy_cache_bypass $http_upgrade;
</span><span class='line'>        }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Reload nginx configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl reload nginx</span></code></pre></td></tr></table></div></figure>


<h2>Access the Beauty of Prometheus Land!</h2>

<p>Once you have authenticated, head over to status, here you will see status info such as your targets, this wil be the endpoints that prometheus is scraping:</p>

<p><img src="https://user-images.githubusercontent.com/567298/57307130-4b518980-70e4-11e9-9f16-4665427fba1f.png" alt="image" /></p>

<p>From the main screen, let&rsquo;s dive into some queries using <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">PromQL</a>. Also see my <a href="https://github.com/ruanbekker/awesome-list/blob/master/cheatsheets/PROMETHEUS.md">Prometheus Cheatsheet</a>.</p>

<p>For the first query, we want to see the available memory of this node in bytes (<code>node_memory_MemAvailable_bytes</code>):</p>

<p><img src="https://user-images.githubusercontent.com/567298/57307338-aa170300-70e4-11e9-9022-e02a4d1d64cf.png" alt="image" /></p>

<p>Now since the value is in bytes, let&rsquo;s convert the value to MB, (<code>node_memory_MemAvailable_bytes/1024/1024</code>)</p>

<p><img src="https://user-images.githubusercontent.com/567298/57307421-d468c080-70e4-11e9-8bd3-425803cb805c.png" alt="image" /></p>

<p>Let&rsquo;s say we want to see the average memory available in 5 minute buckets:</p>

<p><img src="https://user-images.githubusercontent.com/567298/57307504-feba7e00-70e4-11e9-952f-a7ba12eba6a8.png" alt="image" /></p>

<p>That&rsquo;s a few basic ones, but feel free to checkout my <a href="https://github.com/ruanbekker/awesome-list/blob/master/cheatsheets/PROMETHEUS.md">Prometheus Cheatsheet</a> for other examples. I update them as I find more queries.</p>

<h2>Thanks</h2>

<p>Hope this was informative. I am planning to publish a post on visualizing prometheus data with Grafana (which is EPIC!) and installing Pushgateway for custom integrations.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/6">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/4">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/04/28/nginx-analysis-dashboard-using-grafana-and-elasticsearch/">Nginx Analysis Dashboard Using Grafana and Elasticsearch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/27/how-to-do-port-forwarding-with-iptables/">How to Do Port Forwarding With Iptables</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/27/how-to-set-a-static-ip-in-ubuntu-18/">How to Set a Static IP in Ubuntu 18</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/26/graphing-covid-19-stats-with-grafana-and-elasticsearch-using-python/">Graphing Covid-19 Stats With Grafana and Elasticsearch Using Python</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/25/nginx-metrics-on-prometheus-with-the-nginx-log-exporter/">Nginx Metrics on Prometheus With the Nginx Log Exporter</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Free $100 Credit</h1>
  <ul id=""></ul>
  <p></p>
  <strong>May 2020</strong>: Receive $100 to test on Vultr when you sign up.
  <p></p>
  <a href="https://www.vultr.com/?ref=8373836-6G"><img src="https://www.vultr.com/media/banners/banner_160x600.png" width="160" height="600"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
