
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In cases where you are using the defaults for logging and your application logs a lot you can consume a lot of disk space and you can run out of disk &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/posts/5/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <script async defer data-website-id="2cfa7c36-c1f7-48fd-949c-2e5e8a1d873d" src="https://umami-analytics.ruan.dev/umami.js"></script>

  <!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1100086574264181"
     crossorigin="anonymous"></script>

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/12/23/reduce-docker-log-size-on-disk/">Reduce Docker Log Size on Disk</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-12-23T04:11:35-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2020</span></span> <span class='time'>4:11 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In cases where you are using the defaults for logging and your application logs a lot you can consume a lot of disk space and you can run out of disk space quite quickly.</p>

<p>If it&rsquo;s a case where you already ran out of disk space, we can investigate the disk space consumed by docker logs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /var/lib/docker/containers
</span><span class='line'>$ du -sh *
</span><span class='line'>6.0G  14052251a0f13f46f65bc73d10c01408130ee8ae71529600ba5bd6bee76af4ee
</span><span class='line'>1.2G  e6b40b1d30c5cf05e8cb201ca9abf6bd283d7cf7ceaa3be2a0422be7cd750a33</span></code></pre></td></tr></table></div></figure>


<p>Referenced from <a href="https://blog.birkhoff.me/devops-truncate-docker-container-logs-periodically-to-free-up-server-disk-space/">https://blog.birkhoff.me/devops-truncate-docker-container-logs-periodically-to-free-up-server-disk-space/</a> you can truncate those files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sh -c 'truncate -s 0 /var/lib/docker/containers/*/*-json.log'</span></code></pre></td></tr></table></div></figure>


<p>Check the size again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ du -sh *
</span><span class='line'>40K   14052251a0f13f46f65bc73d10c01408130ee8ae71529600ba5bd6bee76af4ee
</span><span class='line'>36K   e6b40b1d30c5cf05e8cb201ca9abf6bd283d7cf7ceaa3be2a0422be7cd750a33</span></code></pre></td></tr></table></div></figure>


<p>To overcome this issue you can use this in logging options in your compose:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>    logging:
</span><span class='line'>      driver: "json-file"
</span><span class='line'>      options:
</span><span class='line'>        max-size: "1m"
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/12/23/https-for-local-development-with-minica/">HTTPS for Local Development With MiniCA</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-12-23T03:11:08-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2020</span></span> <span class='time'>3:11 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial we will use <a href="https://github.com/jsha/minica">minica</a> to enable us to run our web applications over HTTPS for local development.</p>

<p>To read more about about <a href="https://github.com/jsha/minica">minica</a> check out their website.</p>

<h2>Generate Certificates</h2>

<p>You can use their binary from their github page or use my docker image to generate the certificates to a <code>./certs</code> directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run --user "$(id -u):$(id -g)" -it -v $PWD/certs:/output ruanbekker/minica --domains 192.168.0.20.nip.io</span></code></pre></td></tr></table></div></figure>


<p>In the case from above, we are generating certificates for the FQDN <code>192.168.0.20.nip.io</code>. You will find the generated certificates under <code>./certs/</code>.</p>

<h2>Application Stack</h2>

<p>We will use docker to create a nginx webserver to serve our content via https using the generated vertificates.</p>

<p>Our <code>docker-compose.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: '3.7'
</span><span class='line'>services:
</span><span class='line'>  nginx:
</span><span class='line'>    image: nginx
</span><span class='line'>    container_name: nginx
</span><span class='line'>    ports:
</span><span class='line'>      - 80:80
</span><span class='line'>      - 443:443
</span><span class='line'>    volumes:
</span><span class='line'>      - ~/personal/docker-minica-nginx/nginx.conf:/etc/nginx/nginx.conf
</span><span class='line'>      - ~/personal/docker-minica-nginx/ssl.conf:/etc/nginx/conf.d/ssl.conf
</span><span class='line'>      - ~/personal/docker-minica-nginx/certs/192.168.0.6.nip.io:/etc/nginx/certs
</span><span class='line'>      - ~/personal/docker-minica-nginx/html/index.html:/usr/share/nginx/html/index.html</span></code></pre></td></tr></table></div></figure>


<p>Our <code>nginx.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>user  nginx;
</span><span class='line'>worker_processes  1;
</span><span class='line'>error_log  /var/log/nginx/error.log warn;
</span><span class='line'>pid        /var/run/nginx.pid;
</span><span class='line'>
</span><span class='line'>events {
</span><span class='line'>    worker_connections  1024;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>http {
</span><span class='line'>    include       /etc/nginx/mime.types;
</span><span class='line'>    default_type  application/octet-stream;
</span><span class='line'>
</span><span class='line'>    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
</span><span class='line'>                      '$status $body_bytes_sent "$http_referer" '
</span><span class='line'>                      '"$http_user_agent" "$http_x_forwarded_for"';
</span><span class='line'>
</span><span class='line'>    access_log  /var/log/nginx/access.log  main;
</span><span class='line'>
</span><span class='line'>    sendfile        on;
</span><span class='line'>    keepalive_timeout  65;
</span><span class='line'>    include /etc/nginx/conf.d/ssl.conf;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Our <code>ssl.conf</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server {
</span><span class='line'>    listen 80;
</span><span class='line'>    server_name 192.168.0.6.nip.io;
</span><span class='line'>    return 301 https://$host$request_uri;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>server {
</span><span class='line'>    listen 443 ssl;
</span><span class='line'>    server_name 192.168.0.6.nip.io;
</span><span class='line'>
</span><span class='line'>    ssl_certificate /etc/nginx/certs/cert.pem;
</span><span class='line'>    ssl_certificate_key /etc/nginx/certs/key.pem;
</span><span class='line'>
</span><span class='line'>    location / {
</span><span class='line'>        root   /usr/share/nginx/html;
</span><span class='line'>        index  index.html;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Our <code>html/index.html</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;!DOCTYPE html&gt;
</span><span class='line'>&lt;html lang="en-us"&gt;
</span><span class='line'>&lt;head&gt;
</span><span class='line'>    &lt;meta charset="utf-8"&gt;
</span><span class='line'>    &lt;link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"&gt;
</span><span class='line'>    &lt;script src="https://code.jquery.com/jquery-3.1.1.min.js" crossorigin="anonymous"&gt;&lt;/script&gt;
</span><span class='line'>    &lt;title&gt;Sample Page&lt;/title&gt;
</span><span class='line'>&lt;/head&gt;
</span><span class='line'>&lt;body&gt;
</span><span class='line'>    &lt;div class="container-fluid"&gt;
</span><span class='line'>        &lt;div class="row"&gt;
</span><span class='line'>            &lt;div class="bitProcessor"&gt;&lt;/div&gt;
</span><span class='line'>            &lt;div class="col-md-12" style="background-color: white; position: absolute; top: 40%;width: 80%;left: 10%;"&gt;
</span><span class='line'>                &lt;center&gt;
</span><span class='line'>                    &lt;h1&gt;Hello, World!&lt;/h1&gt;
</span><span class='line'>                  &lt;p&gt;This is sample text.&lt;/p&gt;
</span><span class='line'>                &lt;/center&gt;
</span><span class='line'>            &lt;/div&gt;
</span><span class='line'>        &lt;/div&gt;
</span><span class='line'>    &lt;/div&gt;
</span><span class='line'>&lt;/body&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Import Certificates</h2>

<p>We have a certificate <code>./certs/minica.pem</code> which we need to import and trust on our local workstation, I am using a Mac so it will be Keychain Access.</p>

<p><img src="https://user-images.githubusercontent.com/567298/101961866-5a2ee500-3c13-11eb-9f89-03fa1bd4670d.png" alt="image" /></p>

<p>Once you open Keychain Access, select &ldquo;file&rdquo;, &ldquo;import items&rdquo; and browse and import <code>./certs/minica.pem</code>, once you are done search for minica:</p>

<p><img src="https://user-images.githubusercontent.com/567298/101962064-d4f80000-3c13-11eb-9479-c043ba3ced2c.png" alt="image" /></p>

<p>Select the item, file -> get info, expand trust, change &ldquo;when using this certificate&rdquo; to Always trust and close.</p>

<p>You will now see the root ca is trusted:</p>

<p><img src="https://user-images.githubusercontent.com/567298/101962197-2dc79880-3c14-11eb-8d26-49874c9703fa.png" alt="image" /></p>

<h2>Boot the Application Stack</h2>

<p>As we have <code>docker-compose.yml</code> in our current working directory, we can use docker-compose to boot our application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose up
</span><span class='line'>Creating network "docker-minica-nginx_default" with the default driver
</span><span class='line'>Creating nginx ... done
</span><span class='line'>Attaching to nginx</span></code></pre></td></tr></table></div></figure>


<p>Now when we browse to <code>https://192.168.0.6.nip.io</code> we will see:</p>

<p><img src="https://user-images.githubusercontent.com/567298/101962367-a9c1e080-3c14-11eb-898b-688b50c1b9db.png" alt="image" /></p>

<p>And when we inspect the certificate, we can see its valid:</p>

<p><img src="https://user-images.githubusercontent.com/567298/101962411-c78f4580-3c14-11eb-80cd-cf8e449eca95.png" alt="image" /></p>

<h2>Thank You</h2>

<p>Thank you for reading.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/12/18/harden-your-ssh-security-on-linux-servers/">Harden Your SSH Security on Linux Servers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-12-18T13:32:18+00:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>1:32 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post we wil be focusing on increasing / hardening our security by adjusting our ssh configuration and applying some iptables firewall rules.</p>

<p>This will be the list of things that we will do:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  - Change the SSH Port
</span><span class='line'>  - Don't allow root to SSH
</span><span class='line'>  - Disable password based authentication
</span><span class='line'>  - Enable key based authentication and only for a singular user
</span><span class='line'>  - Allow our user to sudo
</span><span class='line'>  - Use iptables to block sources trying to DDoS your server</span></code></pre></td></tr></table></div></figure>


<h2>Packages</h2>

<p>First let&rsquo;s install the packages that we need, I&rsquo;m using Debian so I will be using the <code>apt</code> package manager:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt upgrade -y
</span><span class='line'>$ apt install sudo -y</span></code></pre></td></tr></table></div></figure>


<h2>Dedicated User</h2>

<p>Let&rsquo;s create our user james:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ useradd -m -s /bin/bash james</span></code></pre></td></tr></table></div></figure>


<p>Allow our user to sudo without a password, by running <code>visudo</code> then append the following line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>james ALL=(ALL:ALL) NOPASSWD: ALL</span></code></pre></td></tr></table></div></figure>


<h2>SSH Authorized Keys</h2>

<p>If you don&rsquo;t already have a private SSH key, generate one on your client side:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh-keygen -f ~/.ssh/james -t rsa -C "james" -q -N ""</span></code></pre></td></tr></table></div></figure>


<p>Then copy the public key:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat ~/.ssh/james.pub | pbcopy</span></code></pre></td></tr></table></div></figure>


<p>On your server create the SSH directories:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /home/james/.ssh</span></code></pre></td></tr></table></div></figure>


<p>Now paste your public key into <code>/home/james/.ssh/authorized_keys</code></p>

<p>Then change the ownership:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod 700 /home/james/.ssh
</span><span class='line'>$ chmod 644 /home/james/.ssh/authorized_keys
</span><span class='line'>$ chown -R james:james /home/james</span></code></pre></td></tr></table></div></figure>


<h2>SSH Config</h2>

<p>Backup your SSH config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cp /etc/ssh/sshd_config /etc/ssh_sshd_config.bak</span></code></pre></td></tr></table></div></figure>


<p>We will be using the SSH port <code>2914</code>, replace your SSH config with the following and make your adjustments where you need to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># /etc/ssh/sshd_config
</span><span class='line'>Port 2914
</span><span class='line'>HostKey /etc/ssh/ssh_host_rsa_key
</span><span class='line'>HostKey /etc/ssh/ssh_host_ecdsa_key
</span><span class='line'>HostKey /etc/ssh/ssh_host_ed25519_key
</span><span class='line'>LoginGraceTime 1m
</span><span class='line'>PermitRootLogin no
</span><span class='line'>MaxAuthTries 3
</span><span class='line'>MaxSessions 5
</span><span class='line'>AuthenticationMethods publickey
</span><span class='line'>PubkeyAuthentication yes
</span><span class='line'>AuthorizedKeysFile      /home/james/.ssh/authorized_keys
</span><span class='line'>PasswordAuthentication no
</span><span class='line'>PermitEmptyPasswords no
</span><span class='line'>ChallengeResponseAuthentication no
</span><span class='line'>UsePAM yes
</span><span class='line'>AllowUsers james
</span><span class='line'>DenyUsers root
</span><span class='line'>X11Forwarding yes
</span><span class='line'>PrintMotd no
</span><span class='line'>UseDNS no
</span><span class='line'>PidFile /var/run/sshd.pid
</span><span class='line'>AcceptEnv LANG LC_*
</span><span class='line'>Subsystem       sftp    /usr/lib/openssh/sftp-server</span></code></pre></td></tr></table></div></figure>


<p>Then save the file and restart SSH:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart sshd</span></code></pre></td></tr></table></div></figure>


<p>While you are still connected to the shell session, open up a new terminal and try to connect with your new user and private SSH key to ensure that you can connect to your server.</p>

<h2>Iptables</h2>

<p>We want to drop incoming connections which make more than 10 connection attempts to SSH within 60 seconds.</p>

<p>The tokens get refilled into buckets at 3 per minute and maximum of 3 tokens that can be filled into the bucket.</p>

<p>Let&rsquo;s create our script:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir -p /opt/scripts
</span><span class='line'>$ touch /opt/scripts/fw.sh</span></code></pre></td></tr></table></div></figure>


<p>In our script we will place the following content:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env bash
</span><span class='line'>INTERFACE=eth0 # check ifconfig to determine the correct interface
</span><span class='line'>SSH_PORT=2914
</span><span class='line'>CONNECTION_ATTEMPTS=10
</span><span class='line'>CONNECTION_TIME=60
</span><span class='line'>#WHITELIST_IP=x.x.x.x/32 # replace ip and uncomment if you want to whitelist a ip
</span><span class='line'>#iptables -I INPUT -s ${WHITELIST_IP} -p tcp --dport ${SSH_PORT} -i ${INTERFACE} -j ACCEPT # uncomment if you want to use whitelisting
</span><span class='line'>iptables -A INPUT -p tcp --dport ${SSH_PORT} -i ${INTERFACE} -m state --state NEW -m recent  --set
</span><span class='line'>iptables -A INPUT -p tcp --dport ${SSH_PORT} -i ${INTERFACE} -m state --state NEW -m recent  --update --seconds ${CONNECTION_TIME} --hitcount ${CONNECTION_ATTEMPTS} -j DROP
</span><span class='line'>iptables -A INPUT  -i ${INTERFACE} -p tcp --dport ${SSH_PORT} -m state --state NEW -m limit --limit 3/min --limit-burst 3 -j ACCEPT
</span><span class='line'>iptables -A INPUT  -i ${INTERFACE} -p tcp --dport ${SSH_PORT} -m state --state ESTABLISHED -j ACCEPT
</span><span class='line'>iptables -A OUTPUT -o ${INTERFACE} -p tcp --sport ${SSH_PORT} -m state --state ESTABLISHED -j ACCEPT</span></code></pre></td></tr></table></div></figure>


<p>Now we want to execute this script whenever the server boots, open up <code>/etc/rc.local</code> and append the following line, so that the file looks more or less like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>/opt/scripts/fw.sh
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<p>Ensure both files are executable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chmod +x /opt/scripts/fw.sh
</span><span class='line'>$ chmod +x /etc/rc.local</span></code></pre></td></tr></table></div></figure>


<p>When you are sure everything is in place, reboot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ reboot</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/11/20/encrypt-and-decrypt-files-with-ccrypt/">Encrypt and Decrypt Files With Ccrypt</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-11-20T06:27:01+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>6:27 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a quick post to demonstrate how to encrypt and decrypt files with <strong>ccrypt</strong></p>

<h2>About</h2>

<p>Ccrypt&rsquo;s description from its project page:</p>

<p><em>Encryption and decryption depends on a keyword (or key phrase) supplied by the user. By default, the user is prompted to enter a keyword from the terminal. Keywords can consist of any number of characters, and all characters are significant (although ccrypt internally hashes the key to 256 bits). Longer keywords provide better security than short ones, since they are less likely to be discovered by exhaustive search.</em></p>

<p>Ref: <a href="http://ccrypt.sourceforge.net/">http://ccrypt.sourceforge.net/</a></p>

<h2>Install</h2>

<p>For debian based systems, to install ccrypt:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install ccrypt</span></code></pre></td></tr></table></div></figure>


<h2>Usage</h2>

<p>To encrypt files, write a file to disk:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ echo "ok" &gt; file.txt</span></code></pre></td></tr></table></div></figure>


<p>Then encrypt the file by providing a password:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ccencrypt file.txt
</span><span class='line'>Enter encryption key:
</span><span class='line'>Enter encryption key: (repeat)</span></code></pre></td></tr></table></div></figure>


<p>It encrypts and only the encrypted file can be found:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ls
</span><span class='line'>file.txt.cpt</span></code></pre></td></tr></table></div></figure>


<p>Decrypt the file, by providing your password that you encrypted it with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ccdecrypt file.txt.cpt
</span><span class='line'>Enter decryption key:</span></code></pre></td></tr></table></div></figure>


<p>View the decrypted file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat file.txt
</span><span class='line'>ok</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/11/11/deploy-loki-on-multipass/">Deploy Loki on Multipass</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-11-11T14:19:05+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>2:19 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://sysadmins.co.za/content/images/size/w1600/2020/11/loki-banner-2.png" alt="" /></p>

<p>In this post I will demonstrate how to deploy Grafana Labs&rsquo;s <strong>Loki</strong> on <strong>Multipass</strong> using cloud-init so that you can run your own dev environment and run a couple of queries to get you started.</p>

<h2>About</h2>

<p>If you haven&rsquo;t heard of <a href="https://multipass.run/">Multipass</a>, it allows you to run Ubuntu VMs on your Mac or Windows workstation.</p>

<p>If you haven&rsquo;t heard of <a href="https://grafana.com/oss/loki/">Loki</a>, as described by Grafana Labs: <em>&ldquo;Loki is a horizontally-scalable, highly-available, multi-tenant log aggregation system inspired by Prometheus.&rdquo;</em></p>

<h2>Install Multipass</h2>

<p>Head over to <a href="https://multipass.run/">multipass.run</a> to get the installer for your operating system, and if you are curious about Multipass, I wrote a beginners guide on Multipass which can be <strong><a href="https://sysadmins.co.za/getting-started-with-multipass-vms/">found here</a></strong></p>

<h2>Cloud Init for Loki</h2>

<p>We will be making use of <strong><a href="https://cloudinit.readthedocs.io/en/latest/">cloud-init</a></strong> to bootstrap <strong><a href="https://github.com/grafana/loki/releases/tag/v2.0.0">Loki v2.0.0</a></strong> to our multipass instance.</p>

<p>V2.0.0 is the current release of the time of writing, so depending on the time when you read this, have a look at the <a href="https://github.com/grafana/loki/releases">Loki Releases</a> page for the latest version and adjust the cloud-init.yml according to the version if it differs from the one I&rsquo;m mentioning.</p>

<p>(Optional) If you want to use SSH to your Multipass VM, you can use your existing SSH key or generate a new one, if you want to create a new key, you can <a href="https://sysadmins.co.za/getting-started-with-multipass-vms/">follow this post</a></p>

<p>Copy your public key, in my case <code>~/.ssh/id_rsa.pub</code> and paste it under the ssh <code>authorized_keys</code> section.</p>

<p>Our <code>cloud-init.yml</code> has a couple of sections, but to break it down it will do the following:</p>

<ul>
<li>We provide it our public ssh key so that we can ssh with our private key</li>
<li>Updates the index repository</li>
<li>Installs the packages, unzip and wget</li>
<li>Creates the loki systemd unit file and places it under /etc/systemd/system/</li>
<li>When the vm boots it will create the user loki and creates the loki etc directory</li>
<li>Once that completes, we are downloading the loki, logcli and promtail binaries from github</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1">#cloud-config</span>
</span><span class='line'><span class="l-Scalar-Plain">ssh_authorized_keys</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh-rsa AAAA...Ha9 your-comment</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">package_update</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">unzip</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">wget</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">write_files</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
</span><span class='line'>      <span class="no">[Unit]</span>
</span><span class='line'>      <span class="no">Description=Loki</span>
</span><span class='line'>      <span class="no">User=loki</span>
</span><span class='line'>      <span class="no">Group=loki</span>
</span><span class='line'>      <span class="no">Wants=network-online.target</span>
</span><span class='line'>      <span class="no">After=network-online.target</span>
</span><span class='line'>      <span class="no">[Service]</span>
</span><span class='line'>      <span class="no">Type=simple</span>
</span><span class='line'>      <span class="no">Restart=on-failure</span>
</span><span class='line'>      <span class="no">ExecStart=/usr/local/bin/loki -config.file /etc/loki/loki-local-config.yaml</span>
</span><span class='line'>      <span class="no">[Install]</span>
</span><span class='line'>      <span class="no">WantedBy=multi-user.target</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">owner</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root:root</span>
</span><span class='line'>    <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/systemd/system/loki.service</span>
</span><span class='line'>    <span class="l-Scalar-Plain">permissions</span><span class="p-Indicator">:</span> <span class="s">&#39;0644&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">bootcmd</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">useradd --no-create-home --shell /bin/false loki</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mkdir /etc/loki</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">chown -R loki:loki /etc/loki</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">runcmd</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">for app in loki logcli promtail; do wget &quot;https://github.com/grafana/loki/releases/download/v2.0.0/${app}-linux-amd64.zip&quot;; done</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">for app in loki logcli promtail; do unzip &quot;${app}-linux-amd64.zip&quot;; done</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">for app in loki logcli promtail; do mv &quot;${app}-linux-amd64&quot; /usr/local/bin/${app}; done</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">for app in loki logcli promtail; do rm -f &quot;${app}-linux-amd64.zip&quot;; done</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">wget https://raw.githubusercontent.com/grafana/loki/v2.0.0/cmd/loki/loki-local-config.yaml</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">mv ./loki-local-config.yaml /etc/loki/loki-local-config.yaml</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">chown loki:loki /etc/loki/loki-local-config.yaml</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">systemctl daemon-reload</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">systemctl start loki</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sleep 5</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &quot;this is a test&quot; | promtail --stdin --client.url http://localhost:3100/loki/api/v1/push --client.external-labels=app=cli -server.disable</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will notice that the VM will have <code>loki</code>, <code>logcli</code> and <code>promtail</code> available on it, so you will have an environment to use all of them together.</p>

<p>As you can see once we start loki, we are piping <code>this is a test</code> to Loki using Promtail, so that we can verify that the data is visible in Loki. That step is not required, but just added it to this demo.</p>

<h2>Deploy Loki on Multipass</h2>

<p>We will provision a Multipass VM using the Ubuntu Focal distribution and spec our VM with 1 CPU, 512MB of Memory and 1GB of disk and then bootstrap our installation of Loki using cloud-init:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass launch focal <span class="se">\</span>
</span><span class='line'>  --name loki <span class="se">\</span>
</span><span class='line'>  --cpus <span class="m">1</span> <span class="se">\</span>
</span><span class='line'>  --mem 512m <span class="se">\</span>
</span><span class='line'>  --disk 1G <span class="se">\</span>
</span><span class='line'>  --cloud-init cloud-init.yml
</span><span class='line'>
</span><span class='line'>Creating: loki
</span><span class='line'>Waiting <span class="k">for</span> initialization to <span class="nb">complete </span>
</span><span class='line'>Launched: loki
</span></code></pre></td></tr></table></div></figure>


<p>We can validate if our Multipass VM is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass list
</span><span class='line'>Name                    State             IPv4             Image
</span><span class='line'>loki                    Running           192.168.64.19    Ubuntu 20.04 LTS
</span></code></pre></td></tr></table></div></figure>


<h2>Test Loki inside the VM</h2>

<p>First we will exec into the VM (or SSH), then we will test out Loki inside the VM since we already have logcli available:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass <span class="nb">exec </span>loki -- bash
</span><span class='line'>To run a <span class="nb">command </span>as administrator <span class="o">(</span>user <span class="s2">&quot;root&quot;</span><span class="o">)</span>, use <span class="s2">&quot;sudo &lt;command&gt;&quot;</span>.
</span><span class='line'>See <span class="s2">&quot;man sudo_root&quot;</span> <span class="k">for</span> details.
</span><span class='line'>
</span><span class='line'>ubuntu@loki:~<span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remembered in our cloud-init, we instructed this command to run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">echo</span> <span class="s2">&quot;this is a test&quot;</span> <span class="p">|</span> promtail --stdin --client.url http://localhost:3100/loki/api/v1/push --client.external-labels<span class="o">=</span><span class="nv">app</span><span class="o">=</span>cli -server.disable
</span></code></pre></td></tr></table></div></figure>


<p>So if we use logcli, we can inspect our visible labels:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --quiet labels
</span><span class='line'>__name__
</span><span class='line'>app
</span><span class='line'>hostname
</span><span class='line'>job
</span></code></pre></td></tr></table></div></figure>


<p>And as we expect, we will see the app label from the <code>--client.external-labels=app=cli</code> argument that we passed. We can also look at the values for a given label:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --quiet labels app
</span><span class='line'>cli
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s query our logs using the label selector: <code>{app="cli"}</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --quiet --output raw query <span class="s1">&#39;{app=&quot;cli&quot;}&#39;</span>
</span><span class='line'>this is a <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we remove the extra arguments, we will see more verbose output like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli query <span class="s1">&#39;{app=&quot;cli&quot;}&#39;</span>
</span><span class='line'>
</span><span class='line'>http://localhost:3100/loki/api/v1/query_range?direction<span class="o">=</span>BACKWARD<span class="p">&amp;</span><span class="nv">end</span><span class="o">=</span>1605092055756745122<span class="p">&amp;</span><span class="nv">limit</span><span class="o">=</span>30<span class="p">&amp;</span><span class="nv">query</span><span class="o">=</span>%7Bapp%3D%22cli%22%7D<span class="p">&amp;</span><span class="nv">start</span><span class="o">=</span>1605088455756745122
</span><span class='line'>Common labels: <span class="o">{</span><span class="nv">app</span><span class="o">=</span><span class="s2">&quot;cli&quot;</span>, <span class="nv">hostname</span><span class="o">=</span><span class="s2">&quot;loki&quot;</span>, <span class="nv">job</span><span class="o">=</span><span class="s2">&quot;stdin&quot;</span><span class="o">}</span>
</span><span class='line'>2020-11-11T12:45:20+02:00 <span class="o">{}</span> this is a <span class="nb">test</span>
</span><span class='line'>http://localhost:3100/loki/api/v1/query_range?direction<span class="o">=</span>BACKWARD<span class="p">&amp;</span><span class="nv">end</span><span class="o">=</span>1605091520778438972<span class="p">&amp;</span><span class="nv">limit</span><span class="o">=</span>30<span class="p">&amp;</span><span class="nv">query</span><span class="o">=</span>%7Bapp%3D%22cli%22%7D<span class="p">&amp;</span><span class="nv">start</span><span class="o">=</span>1605088455756745122
</span><span class='line'>Common labels: <span class="o">{</span><span class="nv">app</span><span class="o">=</span><span class="s2">&quot;cli&quot;</span>, <span class="nv">hostname</span><span class="o">=</span><span class="s2">&quot;loki&quot;</span>, <span class="nv">job</span><span class="o">=</span><span class="s2">&quot;stdin&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can pipe some more output to Loki:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;this is another test&quot;</span> <span class="p">|</span> promtail --stdin --client.url http://localhost:3100/loki/api/v1/push --client.external-labels<span class="o">=</span><span class="nv">app</span><span class="o">=</span>cli -server.disable
</span></code></pre></td></tr></table></div></figure>


<p>And querying our logs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --quiet --output raw query <span class="s1">&#39;{app=&quot;cli&quot;}&#39;</span>
</span><span class='line'>this is another <span class="nb">test</span>
</span><span class='line'>this is a <span class="nb">test</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing Loki Outside our VM</h2>

<p>Let&rsquo;s exit the VM and test Loki from our local workstation, first you will need to get the logcli for your OS, head over to the <a href="https://github.com/grafana/loki/releases">releases</a> page and get the binary of your choice.</p>

<p>I will be demonstrating using a mac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/grafana/loki/releases/download/v2.0.0/logcli-darwin-amd64.zip
</span><span class='line'><span class="nv">$ </span>unzip logcli-darwin-amd64.zip
</span><span class='line'><span class="nv">$ </span>sudo mv logcli-darwin-amd64 /usr/local/bin/logcli
</span><span class='line'><span class="nv">$ </span>rm -f logcli-darwin-amd64.zip
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to tell logcli where our Loki server resides, so let&rsquo;s get the IP address of Loki:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass info --all --format json <span class="p">|</span> jq -r <span class="s1">&#39;.info.loki.ipv4[]&#39;</span>
</span><span class='line'>192.168.64.19
</span></code></pre></td></tr></table></div></figure>


<p>We can either set the Loki host as an environment variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">LOKI_ADDR</span><span class="o">=</span>http://192.168.64.19
</span></code></pre></td></tr></table></div></figure>


<p>or you can specify it using the <code>--addr</code> argument:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli --addr<span class="o">=</span><span class="s2">&quot;http://192.168.64.19:3100&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For the sake of simplicity and not having to type the <code>--addr</code> the whole time, I will be setting the Loki address as an environment variable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">LOKI_ADDR</span><span class="o">=</span><span class="s2">&quot;http://$(multipass info --all --format json | jq -r &#39;.info.loki.ipv4[]&#39;):3100&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And when we inspect our labels using logcli, we can see that we are getting our labels from Loki on our Multipass VM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli labels
</span><span class='line'>http://192.168.64.19:3100/loki/api/v1/labels?end<span class="o">=</span>1605093229877731000<span class="p">&amp;</span><span class="nv">start</span><span class="o">=</span>1605089629877731000
</span><span class='line'>__name__
</span><span class='line'>app
</span><span class='line'>hostname
</span><span class='line'>job
</span></code></pre></td></tr></table></div></figure>


<h2>Write Logs to Loki using the Loki Docker Driver</h2>

<p>We have used promtail before to pipe logs to Loki and in this example we will be making use of the Loki Docker Logging Plugin to write data to Loki.</p>

<p>If you have docker installed, install the Loki plugin:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker plugin install <span class="se">\</span>
</span><span class='line'>  grafana/loki-docker-driver:latest <span class="se">\</span>
</span><span class='line'>  --alias loki <span class="se">\</span>
</span><span class='line'>  --grant-all-permissions
</span></code></pre></td></tr></table></div></figure>


<p>Now we will use a docker container to echo stdout to the loki docker driver, which will send the output to Loki.</p>

<p>Let&rsquo;s alias a command loki_echo that we will use to send our output to the docker container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">alias</span> <span class="s1">&#39;loki_echo=docker run --rm -it --log-driver loki --log-opt loki-url=&quot;http://192.168.64.19:3100/loki/api/v1/push&quot; --log-opt loki-external-labels=&quot;app=echo-container&quot; busybox echo&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So every time we run <code>loki_echo {string}</code> we will run a docker container from the busybox image and pass the <code>{string}</code> as an argument to the echo command inside the container, which will be sent to the loki log driver and land up in Loki.</p>

<p>Let&rsquo;s push 100 log events to Loki:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ count</span><span class="o">=</span>0
</span><span class='line'><span class="nv">$ </span><span class="k">while</span> <span class="o">[</span> <span class="k">${</span><span class="nv">count</span><span class="k">}</span> !<span class="o">=</span> <span class="m">100</span> <span class="o">]</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>    <span class="k">for</span> color in red blue white silver green<span class="p">;</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'>      loki_echo <span class="s2">&quot;there are ${RANDOM} items of ${color} available&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="nv">count</span><span class="o">=</span><span class="k">$((</span>count+1<span class="k">))</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'>
</span><span class='line'>there are <span class="m">26890</span> items of green available
</span><span class='line'>there are <span class="m">14856</span> items of red available
</span><span class='line'>there are <span class="m">31162</span> items of blue available
</span><span class='line'>there are <span class="m">23993</span> items of white available
</span><span class='line'>there are <span class="m">22310</span> items of silver available
</span><span class='line'>there are <span class="m">10700</span> items of green available
</span><span class='line'>there are <span class="m">14077</span> items of red available
</span><span class='line'>there are <span class="m">20642</span> items of blue available
</span><span class='line'>there are <span class="m">31576</span> items of white available
</span><span class='line'>there are <span class="m">26053</span> items of silver available
</span><span class='line'>there are <span class="m">2973</span> items of green available
</span><span class='line'>there are <span class="m">2203</span> items of red available
</span><span class='line'>there are <span class="m">8557</span> items of blue available
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>We can verify how many log events we have with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli query <span class="s1">&#39;{app=&quot;echo-container&quot;}&#39;</span> --quiet --limit <span class="m">200</span> --output raw <span class="p">|</span> wc -l
</span><span class='line'>100
</span></code></pre></td></tr></table></div></figure>


<p>To see how many logs we have with the line &ldquo;blue&rdquo; in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli query <span class="s1">&#39;{app=&quot;echo-container&quot;} |= &quot;blue&quot;&#39;</span> --quiet --limit <span class="m">200</span> --output raw <span class="p">|</span> wc -l
</span><span class='line'>20
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s look for logs with blue or green and limit the results to 5:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>logcli query <span class="s1">&#39;{app=&quot;echo-container&quot;} |~ &quot;items of (blue|green)&quot;&#39;</span> --quiet --limit <span class="m">5</span> --output raw
</span><span class='line'>there are <span class="m">28985</span> items of green available
</span><span class='line'>there are <span class="m">10289</span> items of blue available
</span><span class='line'>there are <span class="m">12316</span> items of green available
</span><span class='line'>there are <span class="m">23775</span> items of blue available
</span><span class='line'>there are <span class="m">20</span> items of green available
</span></code></pre></td></tr></table></div></figure>


<h2>Teardown</h2>

<p>If you followed along, you can terminate your Multipass VM with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>multipass delete --purge loki
</span></code></pre></td></tr></table></div></figure>


<p>You can get the example code in my <strong><a href="https://github.com/ruanbekker/multipassfiles/tree/master/loki">multipassfiles github repository</a></strong></p>

<h2>Thanks</h2>

<p>Thanks for reading, if you like my content, check out my <strong><a href="https://ruan.dev">website</a></strong> or follow me at <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> on Twitter.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/11/06/how-to-setup-alerting-with-loki/">How to Setup Alerting With Loki</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-11-06T15:13:53+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>3:13 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/98380823-bd948880-2051-11eb-8ab4-c8d5f5d3e612.png" alt="image" /></p>

<p>Recently Grafana Labs announced <strong><a href="https://grafana.com/blog/2020/10/28/loki-2.0-released-transform-logs-as-youre-querying-them-and-set-up-alerts-within-loki/">Loki v2</a></strong> and its awesome! Definitely check out their blog post on more details.</p>

<p>Loki has a index option called <strong>boltdb-shipper</strong>, which allows you to run Loki with only a object store and you <strong>no longer need a dedicated index store</strong> such as DynamoDB. You can extract labels from log lines at query time, which is CRAZY! And I really like how they&rsquo;ve implemented it, you can parse, filter and format like mad. I really like that.</p>

<p>And then generating alerts from any query, which we will go into today. Definitely check out <a href="https://grafana.com/blog/2020/10/28/loki-2.0-released-transform-logs-as-youre-querying-them-and-set-up-alerts-within-loki/">this blogpost</a> and <a href="https://grafana.com/blog/2020/11/04/video-top-three-features-of-the-new-loki-2.0/">this video</a> for more details on the features of Loki v2.</p>

<h2>What will we be doing today</h2>

<p>In this tutorial we will setup a alert using the Loki local ruler to alert us when we have <strong>high number of log events coming in</strong>. For example, let&rsquo;s say someone has debug logging enabled in their application and we want to send a alert to slack when it breaches the threshold.</p>

<p>I will simulate this with a <code>http-client</code> container which runs <code>curl</code> in a while loop to fire a bunch of http requests against the nginx container which logs to Loki, so we can see how the alerting works, and in this scenario we will alert to Slack.</p>

<p>And after that we will stop our http-client container to see how the alarm resolves when the log rate comes down again.</p>

<p>All the components are available in the <code>docker-compose.yml</code> on my <a href="https://github.com/ruanbekker/loki-alerts-docker">github repository</a></p>

<h2>Components</h2>

<p>Let&rsquo;s break it down and start with the loki config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>...
</span><span class='line'>ruler:
</span><span class='line'>  storage:
</span><span class='line'>    type: local
</span><span class='line'>    local:
</span><span class='line'>      directory: /etc/loki/rules
</span><span class='line'>  rule_path: /tmp/loki/rules-temp
</span><span class='line'>  alertmanager_url: http://alertmanager:9093
</span><span class='line'>  ring:
</span><span class='line'>    kvstore:
</span><span class='line'>      store: inmemory
</span><span class='line'>  enable_api: true
</span><span class='line'>  enable_alertmanager_v2: true</span></code></pre></td></tr></table></div></figure>


<p>In the section of the loki config, I will be making use of the local ruler and map my alert rules under <code>/etc/loki/rules/</code> and we are also defining our alertmanager instance where these alerts should be shipped to.</p>

<p>In my rule definition <code>/etc/loki/rules/demo/rules.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>groups:
</span><span class='line'>  - name: rate-alerting
</span><span class='line'>    rules:
</span><span class='line'>      - alert: HighLogRate
</span><span class='line'>        expr: |
</span><span class='line'>          sum by (compose_service)
</span><span class='line'>            (rate({job="dockerlogs"}[1m]))
</span><span class='line'>            &gt; 60
</span><span class='line'>        for: 1m
</span><span class='line'>        labels:
</span><span class='line'>            severity: warning
</span><span class='line'>            team: devops
</span><span class='line'>            category: logs
</span><span class='line'>        annotations:
</span><span class='line'>            title: "High LogRate Alert"
</span><span class='line'>            description: "something is logging a lot"
</span><span class='line'>            impact: "impact"
</span><span class='line'>            action: "action"
</span><span class='line'>            dashboard: "https://grafana.com/service-dashboard"
</span><span class='line'>            runbook: "https://wiki.com"
</span><span class='line'>            logurl: "https://grafana.com/log-explorer"</span></code></pre></td></tr></table></div></figure>


<p>In my expression, I am using LogQL to return per second rate of all my docker logs within the last minute per compose service for my dockerlogs job and we are specifying that it should alert when the threshold is above 60.</p>

<p>As you can see I have a couple of <strong>labels and annotations</strong>, which becomes <strong>very useful</strong> when you have dashboard links, runbooks etc and you would like to map that to your alert. I am doing the mapping in my <code>alertmanager.yml</code> config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>route:
</span><span class='line'>...
</span><span class='line'>  receiver: 'default-catchall-slack'
</span><span class='line'>  routes:
</span><span class='line'>  - match:
</span><span class='line'>      severity: warning
</span><span class='line'>    receiver: warning-devops-slack
</span><span class='line'>    routes:
</span><span class='line'>    - match_re:
</span><span class='line'>        team: .*(devops).*
</span><span class='line'>      receiver: warning-devops-slack
</span><span class='line'>
</span><span class='line'>receivers:
</span><span class='line'>...
</span><span class='line'>- name: 'warning-devops-slack'
</span><span class='line'>  slack_configs:
</span><span class='line'>    - send_resolved: true
</span><span class='line'>      channel: '__SLACK_CHANNEL__'
</span><span class='line'>      title: ':fire::white_check_mark: []  '
</span><span class='line'>      text: &gt;-
</span><span class='line'>        
</span><span class='line'>          *Description:* 
</span><span class='line'>          *Severity:* ``
</span><span class='line'>          *Graph:* &lt;|:chart_with_upwards_trend:&gt;&lt;|:chart_with_upwards_trend:&gt; *Dashboard:* &lt;|:bar_chart:&gt; *Runbook:* &lt;|:spiral_note_pad:&gt;
</span><span class='line'>          *Details:*
</span><span class='line'>           - *:* ``
</span><span class='line'>          
</span><span class='line'>           - *Impact*: 
</span><span class='line'>           - *Receiver*: warning--slack
</span><span class='line'>        </span></code></pre></td></tr></table></div></figure>


<p>As you can see, when my alert matches nothing it will go to my catchall receiver, but when my label contains <code>devops</code> and the route the alert to my <code>warning-devops-slack</code> receiver, and then we will be parsing our labels and annotations to include the values in our alarm on slack.</p>

<h2>Demo</h2>

<p>Enough with the background details, and it&rsquo;s time to get into the action.</p>

<p>All the code for this demonstration will be available in my github repository: <strong><a href="https://github.com/ruanbekker/loki-alerts-docker">github.com/ruanbekker/loki-alerts-docker</a></strong></p>

<p>The docker-compose will have a container of <strong>grafana</strong>, <strong>alertmanager</strong>, <strong>loki</strong>, <strong>nginx</strong> and a <strong>http-client</strong>.</p>

<p>The http-client is curl in a while loop that will just make a bunch of http requests against the nginx container, which will be logging to loki.</p>

<h2>Get the source</h2>

<p>Get the code from my github repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone https://github.com/ruanbekker/loki-alerts-docker
</span><span class='line'>$ cd loki-alerts-docker</span></code></pre></td></tr></table></div></figure>


<p>You will need to replace the slack webhook url and the slack channel where you want your alerts to be sent to. This will take the environment variables and replace the values in <code>config/alertmanager.yml</code> (always check out the script first, before executing it)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ SLACK_WEBHOOK_URL="https://hooks.slack.com/services/xx/xx/xx" SLACK_CHANNEL="#notifications" ./parse_configs.sh</span></code></pre></td></tr></table></div></figure>


<p>You can double check by running <code>cat config/alertmanager.yml</code>, once you are done, boot the stack:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose up -d</span></code></pre></td></tr></table></div></figure>


<p>Open up grafana:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ open http://grafana.localdns.xyz:3000</span></code></pre></td></tr></table></div></figure>


<p>Use the initial user and password combination <code>admin/admin</code> and then reset your password:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98379039-7efdce80-204f-11eb-9c8a-3ed12a63cb14.png" alt="image" /></p>

<p>Browse for your labels on the log explorer section, in my example it will be <code>{job="dockerlogs"}</code>:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98379172-ace31300-204f-11eb-8e6c-3cf073afe771.png" alt="image" /></p>

<p>When we select our job=&ldquo;dockerlogs&rdquo; label, we will see our logs:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98379288-c71cf100-204f-11eb-911c-043a983bae6d.png" alt="image" /></p>

<p>As I explained earlier the query that we will be running in our ruler, can be checked what the rate currently is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sum by (compose_project, compose_service) (rate({job="dockerlogs"}[1m]))</span></code></pre></td></tr></table></div></figure>


<p>Which will look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98379765-54604580-2050-11eb-9c90-5e0adf2bb586.png" alt="image" /></p>

<p>In the configured expression in our ruler config, we have set to alarm once the value goes above 60, we can validate this by running:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sum by (compose_project, compose_service) (rate({job="dockerlogs"}[1m])) &gt; 60</span></code></pre></td></tr></table></div></figure>


<p>And we can verify that this is the case, and by now it should be alarming:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98379900-84a7e400-2050-11eb-87d0-ae52617d195e.png" alt="image" /></p>

<p>Head over to alertmanager:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ open http://alertmanager.localdns.xyz:9093</span></code></pre></td></tr></table></div></figure>


<p>We can see alertmanager is showing the alarm:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98380013-af923800-2050-11eb-8585-f7489bf722cb.png" alt="image" /></p>

<p>When we head over to slack, we can see our notification:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98380158-de101300-2050-11eb-8d73-20828124fab5.png" alt="image" /></p>

<p>So let&rsquo;s stop our http client:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose stop http-client
</span><span class='line'>Stopping http-client ... done</span></code></pre></td></tr></table></div></figure>


<p>Then we can see the logging stopped:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98380907-e0bf3800-2051-11eb-99c3-b3b9ac22bba5.png" alt="image" /></p>

<p>And in slack, we should see that the alarm recovered and we should see the notification:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98381360-722eaa00-2052-11eb-8bb4-07cdc8ffa7ee.png" alt="image" /></p>

<p>Then you can terminate your stack:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker-compose down</span></code></pre></td></tr></table></div></figure>


<p>Pretty epic stuff right? I really love how cost effective Loki is as logging use to be so expensive to run and especially maintain, Grafana Labs are really doing some epic work and my hat goes off to them.</p>

<h2>Thanks</h2>

<p>I hope you found this useful, feel free to reach out to me on Twitter <strong><a href="https://twitter.com/ruanbekker">@ruanbekker</a></strong> or visit me on my website <strong><a href="https://ruan.dev">ruan.dev</a></strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/11/06/sending-slack-messages-with-python/">Sending Slack Messages With Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-11-06T13:58:50+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>1:58 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post I will demonstrate how to send messages to slack using python based on the status of an event.</p>

<p>We will keep it basic, that when something is down or up, it should send a slack message with the status, message, color and embed your grafana dashboard links inside the alert (or any links that you would like).</p>

<h2>Create a Webhook</h2>

<p>From a previous post on <a href="https://blog.ruanbekker.com/blog/2019/04/18/setup-a-slack-webhook-for-sending-messages-from-applications/">how to use curl to send slack messages</a> I showed how to create your webhook, so you can just follow that post if you want to follow along.</p>

<p>Once you have a webhook, which will look like <code>https://hooks.slack.com/services/xx/yy/zz</code>, you are good to follow to the next step.</p>

<h2>Creating the Script</h2>

<p>First we need requests:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pip install requests</span></code></pre></td></tr></table></div></figure>


<p>Then we will create the <code>slack_notifier.py</code>, just ensure that you replace your slack webhook url and slack channel to yours:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>
</span><span class='line'><span class="n">SLACK_WEBHOOK_URL</span> <span class="o">=</span> <span class="s">&#39;https://hooks.slack.com/&lt;your&gt;/&lt;slack&gt;/&lt;webhook&gt;&#39;</span>
</span><span class='line'><span class="n">SLACK_CHANNEL</span> <span class="o">=</span> <span class="s">&quot;#your-slack-channel&quot;</span>
</span><span class='line'><span class="n">ALERT_STATE</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">alert_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;emoji&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;up&quot;</span><span class="p">:</span> <span class="s">&quot;:white_check_mark:&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;down&quot;</span><span class="p">:</span> <span class="s">&quot;:fire:&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;up&quot;</span><span class="p">:</span> <span class="s">&quot;RESOLVED&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;down&quot;</span><span class="p">:</span> <span class="s">&quot;FIRING&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;up&quot;</span><span class="p">:</span> <span class="s">&quot;Everything is good!&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;down&quot;</span><span class="p">:</span> <span class="s">&quot;Stuff is burning!&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&quot;color&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;up&quot;</span><span class="p">:</span> <span class="s">&quot;#32a852&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;down&quot;</span><span class="p">:</span> <span class="s">&quot;#ad1721&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">alert_to_slack</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">log_url</span><span class="p">,</span> <span class="n">metric_url</span><span class="p">):</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;AlertManager&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;username&quot;</span><span class="p">:</span> <span class="s">&quot;Notifications&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;channel&quot;</span><span class="p">:</span> <span class="n">SLACK_CHANNEL</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;attachments&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;{emoji} [*{state}*] Status Checker</span><span class="se">\n</span><span class="s"> {message}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span class='line'>                <span class="n">emoji</span><span class="o">=</span><span class="n">alert_map</span><span class="p">[</span><span class="s">&quot;emoji&quot;</span><span class="p">][</span><span class="n">status</span><span class="p">],</span>
</span><span class='line'>                <span class="n">state</span><span class="o">=</span><span class="n">alert_map</span><span class="p">[</span><span class="s">&quot;text&quot;</span><span class="p">][</span><span class="n">status</span><span class="p">],</span>
</span><span class='line'>                <span class="n">message</span><span class="o">=</span><span class="n">alert_map</span><span class="p">[</span><span class="s">&quot;message&quot;</span><span class="p">][</span><span class="n">status</span><span class="p">]</span>
</span><span class='line'>            <span class="p">),</span>
</span><span class='line'>            <span class="s">&quot;color&quot;</span><span class="p">:</span> <span class="n">alert_map</span><span class="p">[</span><span class="s">&quot;color&quot;</span><span class="p">][</span><span class="n">status</span><span class="p">],</span>
</span><span class='line'>            <span class="s">&quot;attachment_type&quot;</span><span class="p">:</span> <span class="s">&quot;default&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;Logs&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;Logs&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;button&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;style&quot;</span><span class="p">:</span> <span class="s">&quot;primary&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;url&quot;</span><span class="p">:</span> <span class="n">log_url</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;Metrics&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;Metrics&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;button&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;style&quot;</span><span class="p">:</span> <span class="s">&quot;primary&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;url&quot;</span><span class="p">:</span> <span class="n">metric_url</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>        <span class="p">}]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">SLACK_WEBHOOK_URL</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span>
</span><span class='line'>
</span><span class='line'><span class="n">alert_to_slack</span><span class="p">(</span><span class="n">ALERT_STATE</span><span class="p">,</span> <span class="s">&quot;https://grafana-logs.dashboard.local&quot;</span><span class="p">,</span> <span class="s">&quot;https://grafana-metrics.dashboard.local&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Testing it out</h2>

<p>Time to test it out, so let&rsquo;s assume something is down, then we can react on that event and action the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python</span> <span class="n">slack_notifier</span><span class="o">.</span><span class="n">py</span> <span class="n">down</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which will look like the following on slack:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98374881-fdf00880-2049-11eb-9d7f-7599665871db.png" alt="image" /></p>

<p>And when recovery is in place, we can action the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python</span> <span class="n">slack_notifier</span><span class="o">.</span><span class="n">py</span> <span class="n">up</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which will look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/98374958-1eb85e00-204a-11eb-8ab0-c6a8a0640752.png" alt="image" /></p>

<h2>Thanks</h2>

<p>That was a basic example on how you can use python to send slack messages.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/11/02/running-ssh-commands-on-aws-ec2-instances-with-python/">Running SSH Commands on AWS EC2 Instances With Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-11-02T09:55:43+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2020</span></span> <span class='time'>9:55 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this quick post I will demonstrate how to discover a EC2 Instance&rsquo;s Private IP Address using the AWS API by using Tags then use Paramiko in Python to SSH to the EC2 instance and run SSH commands on the target instance.</p>

<p>Install the required dependencies:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virtualenv -p python3 .venv
</span><span class='line'>$ source .venve/bin/activate
</span><span class='line'>$ pip install boto3 paramiko</span></code></pre></td></tr></table></div></figure>


<p>I have my development profile for aws configured under <code>dev</code> as can seen below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aws --profile dev configure list
</span><span class='line'>      Name                    Value             Type    Location
</span><span class='line'>      ----                    -----             ----    --------
</span><span class='line'>   profile                      dev           manual    --profile
</span><span class='line'>access_key     ****************xxxx      assume-role
</span><span class='line'>secret_key     ****************xxxx      assume-role
</span><span class='line'>    region                eu-west-1      config-file    ~/.aws/config</span></code></pre></td></tr></table></div></figure>


<p>First we need to discover the private ip address from the api by referencing tags, and in this example we will use the <code>Name</code> tag:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import boto3
</span><span class='line'>ec2 = boto3.Session(profile_name='dev', region_name='eu-west-1').client('ec2')
</span><span class='line'>
</span><span class='line'>target_instances = ec2.describe_instances(
</span><span class='line'>    Filters=[{'Name':'tag:Name','Values':['my-demo-ec2-instance']}]
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>ec2_instances = []
</span><span class='line'>for each_instance in target_instances['Reservations']:
</span><span class='line'>    for found_instance in each_instance['Instances']:
</span><span class='line'>        ec2_instances.append(found_instance['PrivateIpAddress'])
</span><span class='line'>
</span><span class='line'># ec2_instances
</span><span class='line'># ['172.31.2.89']</span></code></pre></td></tr></table></div></figure>


<p>So we are instantiating a ec2 instance with our configured dev profile, then we describe all our instances using the tag key <code>Name</code> and value <code>my-demo-ec2-instance</code> and then access the private ip address and append it to our <code>ec2_instances</code> list.</p>

<p>Next we want to define the commands that we want to run on the target ec2 instance:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>commands = [
</span><span class='line'>    "echo hi",
</span><span class='line'>    "whoami",
</span><span class='line'>    "hostname"
</span><span class='line'>]</span></code></pre></td></tr></table></div></figure>


<p>In my case I only have 1 ec2 instance with the name <code>my-demo-ec2-instance</code>, but if you have more you can just loop through the list and perform the actions.</p>

<p>Next we want to establish the SSH connection:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>k = paramiko.RSAKey.from_private_key_file("/Users/ruan/.ssh/id_rsa")
</span><span class='line'>c = paramiko.SSHClient()
</span><span class='line'>c.set_missing_host_key_policy(paramiko.AutoAddPolicy())
</span><span class='line'>c.connect(hostname=ec2_instances[0], username="ruan", pkey=k, allow_agent=False, look_for_keys=False)</span></code></pre></td></tr></table></div></figure>


<p>Once our SSH connection has established, we can loop through our commands and execute them:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>for command in commands:
</span><span class='line'>    print("running command: {}".format(command))
</span><span class='line'>    stdin , stdout, stderr = c.exec_command(command)
</span><span class='line'>    print(stdout.read())
</span><span class='line'>    print(stderr.read())</span></code></pre></td></tr></table></div></figure>


<p>Which will output the folling:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>running command: echo hi
</span><span class='line'>b'hi\n'
</span><span class='line'>b''
</span><span class='line'>running command: whoami
</span><span class='line'>b'ruan\n'
</span><span class='line'>b''
</span><span class='line'>running command: hostname
</span><span class='line'>b'ip-172-31-2-89\n'
</span><span class='line'>b''</span></code></pre></td></tr></table></div></figure>


<p>And then close the SSH connection:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>c.close()</span></code></pre></td></tr></table></div></figure>


<p>And the full script will look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="n">ssh_username</span> <span class="o">=</span> <span class="s">&quot;ruan&quot;</span>
</span><span class='line'><span class="n">ssh_key_file</span> <span class="o">=</span> <span class="s">&quot;/Users/ruan/.ssh/id_rsa&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ec2</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;dev&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;ec2&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">target_instances</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">describe_instances</span><span class="p">(</span>
</span><span class='line'>    <span class="n">Filters</span><span class="o">=</span><span class="p">[{</span><span class="s">&#39;Name&#39;</span><span class="p">:</span><span class="s">&#39;tag:Name&#39;</span><span class="p">,</span><span class="s">&#39;Values&#39;</span><span class="p">:[</span><span class="s">&#39;my-demo-ec2-instance&#39;</span><span class="p">]}]</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">ec2_instances</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="k">for</span> <span class="n">each_instance</span> <span class="ow">in</span> <span class="n">target_instances</span><span class="p">[</span><span class="s">&#39;Reservations&#39;</span><span class="p">]:</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">found_instance</span> <span class="ow">in</span> <span class="n">each_instance</span><span class="p">[</span><span class="s">&#39;Instances&#39;</span><span class="p">]:</span>
</span><span class='line'>        <span class="n">ec2_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found_instance</span><span class="p">[</span><span class="s">&#39;PrivateIpAddress&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">commands</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="s">&quot;echo hi&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;whoami&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;hostname&quot;</span>
</span><span class='line'><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">k</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">RSAKey</span><span class="o">.</span><span class="n">from_private_key_file</span><span class="p">(</span><span class="n">ssh_key_file</span><span class="p">)</span>
</span><span class='line'><span class="n">c</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
</span><span class='line'><span class="n">c</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
</span><span class='line'><span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">ec2_instances</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">username</span><span class="o">=</span><span class="n">ssh_username</span><span class="p">,</span> <span class="n">pkey</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">allow_agent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">look_for_keys</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;running command: {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
</span><span class='line'>    <span class="n">stdin</span> <span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/10/29/running-loki-behind-nginx-reverse-proxy/">Running Loki Behind Nginx Reverse Proxy</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-10-29T08:29:13+00:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>8:29 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this tutorial I will demonstrate how to run <strong>Loki v2.0.0</strong> behind a <strong>Nginx Reverse Proxy</strong> with basic http authentication enabled on Nginx and what to do to configure Nginx for <strong>websockets</strong>, which is required when you want to use <strong>tail in logcli</strong> via Nginx.</p>

<h2>Assumptions</h2>

<p>My environment consists of a AWS Application LoadBalancer with a Host entry and a Target Group associated to port 80 of my Nginx/Loki EC2 instance.</p>

<p>Health checks to my EC2 instance are being performed to <code>instance:80/ready</code></p>

<p>I have a S3 bucket and a DynamoDB table already running in my account which Loki will use. But <strong>NOTE</strong> that boltdb-shipper is now production ready since <a href="https://github.com/grafana/loki/blob/v2.0.0/CHANGELOG.md#20">v2.0.0</a>, which is awesome, because now you only require a object store such as S3, so you don&rsquo;t need DynamoDB.</p>

<p>More information on this topic can be found under their <a href="https://github.com/grafana/loki/blob/v2.0.0/CHANGELOG.md#20">changelog</a></p>

<h2>What can you expect from this blogpost</h2>

<p>We will go through the following topics:</p>

<ul>
<li>Install Loki v2.0.0 and Nginx</li>
<li>Configure HTTP Basic Authentication to Loki&rsquo;s API Endpoints</li>
<li>Bypass HTTP Basic Authentication to the <code>/ready</code> endpoint for our Load Balancer to perform healthchecks</li>
<li>Enable Nginx to upgrade websocket connections so that we can use <code>logcli --tail</code></li>
<li>Test out access to Loki via our Nginx Reverse Proxy</li>
<li>Install and use LogCLI</li>
</ul>


<h2>Install Software</h2>

<p>First we will install <code>nginx</code> and <code>apache2-utils</code>. In my use-case I will be using Ubuntu 20 as my operating system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt update && sudo apt install nginx apache2-utils -y</span></code></pre></td></tr></table></div></figure>


<p>Next we will install Loki v2.0.0, if you are upgrading from a previous version of Loki, I would recommend checking out the <a href="https://github.com/grafana/loki/releases/tag/v2.0.0">upgrade guide</a> mentioned on their releases page.</p>

<p>Download the package:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -O -L "https://github.com/grafana/loki/releases/download/v2.0.0/loki-linux-amd64.zip"</span></code></pre></td></tr></table></div></figure>


<p>Unzip the archive:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ unzip loki-linux-amd64.zip</span></code></pre></td></tr></table></div></figure>


<p>Move the binary to your $PATH:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mv loki-linux-amd64 /usr/local/bin/loki</span></code></pre></td></tr></table></div></figure>


<p>And ensure that the binary is executable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo chmod a+x /usr/local/bin/loki</span></code></pre></td></tr></table></div></figure>


<h2>Configuration</h2>

<p>Create the user that will be responsible for running loki:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ useradd --no-create-home --shell /bin/false loki</span></code></pre></td></tr></table></div></figure>


<p>Create the directory where we will place the loki configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /etc/loki</span></code></pre></td></tr></table></div></figure>


<p>Create the loki configuration file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/loki/loki-config.yml
</span><span class='line'>auth_enabled: false
</span><span class='line'>
</span><span class='line'>server:
</span><span class='line'>  http_listen_port: 3100
</span><span class='line'>  http_listen_address: 127.0.0.1
</span><span class='line'>  http_server_read_timeout: 1000s
</span><span class='line'>  http_server_write_timeout: 1000s
</span><span class='line'>  http_server_idle_timeout: 1000s
</span><span class='line'>  log_level: info
</span><span class='line'>
</span><span class='line'>ingester:
</span><span class='line'>  lifecycler:
</span><span class='line'>    address: 127.0.0.1
</span><span class='line'>    ring:
</span><span class='line'>      kvstore:
</span><span class='line'>        store: inmemory
</span><span class='line'>      replication_factor: 1
</span><span class='line'>    final_sleep: 0s
</span><span class='line'>  chunk_encoding: snappy
</span><span class='line'>  chunk_idle_period: 1h
</span><span class='line'>  chunk_target_size: 1048576
</span><span class='line'>  chunk_retain_period: 30s
</span><span class='line'>  max_transfer_retries: 0
</span><span class='line'>
</span><span class='line'># https://grafana.com/docs/loki/latest/configuration/#schema_config
</span><span class='line'>schema_config:
</span><span class='line'>  configs:
</span><span class='line'>    - from: 2020-05-15
</span><span class='line'>      store: aws
</span><span class='line'>      object_store: s3
</span><span class='line'>      schema: v11
</span><span class='line'>      index:
</span><span class='line'>        prefix: loki-logging-index
</span><span class='line'>
</span><span class='line'>storage_config:
</span><span class='line'>  aws:
</span><span class='line'>    http_config:
</span><span class='line'>      idle_conn_timeout: 90s
</span><span class='line'>      response_header_timeout: 0s
</span><span class='line'>    s3: s3://myak:mysk@eu-west-1/loki-logs-datastore
</span><span class='line'>
</span><span class='line'>    dynamodb:
</span><span class='line'>      dynamodb_url: dynamodb://myak:mysk@eu-west-1
</span><span class='line'>
</span><span class='line'>limits_config:
</span><span class='line'>  enforce_metric_name: false
</span><span class='line'>  reject_old_samples: true
</span><span class='line'>  reject_old_samples_max_age: 168h
</span><span class='line'>  ingestion_rate_mb: 30
</span><span class='line'>  ingestion_burst_size_mb: 60
</span><span class='line'>
</span><span class='line'># https://grafana.com/docs/loki/latest/operations/storage/retention/
</span><span class='line'># To avoid querying of data beyond the retention period, max_look_back_period config in chunk_store_config
</span><span class='line'># must be set to a value less than or equal to what is set in table_manager.retention_period
</span><span class='line'>chunk_store_config:
</span><span class='line'>  max_look_back_period: 720h
</span><span class='line'>
</span><span class='line'># https://grafana.com/docs/loki/latest/operations/storage/retention/
</span><span class='line'>table_manager:
</span><span class='line'>  retention_deletes_enabled: true
</span><span class='line'>  retention_period: 720h
</span><span class='line'>  chunk_tables_provisioning:
</span><span class='line'>    inactive_read_throughput: 10
</span><span class='line'>    inactive_write_throughput: 10
</span><span class='line'>    provisioned_read_throughput: 50
</span><span class='line'>    provisioned_write_throughput: 20
</span><span class='line'>  index_tables_provisioning:
</span><span class='line'>    inactive_read_throughput: 10
</span><span class='line'>    inactive_write_throughput: 10
</span><span class='line'>    provisioned_read_throughput: 50
</span><span class='line'>    provisioned_write_throughput: 20</span></code></pre></td></tr></table></div></figure>


<p>Apply permissions so that the loki user has access to it&rsquo;s configuration:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ chown -R loki:loki /etc/loki</span></code></pre></td></tr></table></div></figure>


<p>Create a systemd unit file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/systemd/system/loki.service
</span><span class='line'>[Unit]
</span><span class='line'>Description=Loki
</span><span class='line'>Wants=network-online.target
</span><span class='line'>After=network-online.target
</span><span class='line'>
</span><span class='line'>[Service]
</span><span class='line'>User=loki
</span><span class='line'>Group=loki
</span><span class='line'>Type=simple
</span><span class='line'>Restart=on-failure
</span><span class='line'>ExecStart=/usr/local/bin/loki -config.file /etc/loki/loki-config.yml
</span><span class='line'>
</span><span class='line'>[Install]
</span><span class='line'>WantedBy=multi-user.target</span></code></pre></td></tr></table></div></figure>


<p>Create the main nginx config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/nginx/nginx.conf
</span><span class='line'>user www-data;
</span><span class='line'>worker_processes auto;
</span><span class='line'>pid /run/nginx.pid;
</span><span class='line'>include /etc/nginx/modules-enabled/*.conf;
</span><span class='line'>worker_rlimit_nofile 100000;
</span><span class='line'>
</span><span class='line'>events {
</span><span class='line'>        worker_connections 4000;
</span><span class='line'>        use epoll;
</span><span class='line'>        multi_accept on;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>http {
</span><span class='line'>
</span><span class='line'>  # basic settings
</span><span class='line'>  sendfile on;
</span><span class='line'>  tcp_nopush on;
</span><span class='line'>  tcp_nodelay on;
</span><span class='line'>  keepalive_timeout 65;
</span><span class='line'>  types_hash_max_size 2048;
</span><span class='line'>        open_file_cache_valid 30s;
</span><span class='line'>        open_file_cache_min_uses 2;
</span><span class='line'>        open_file_cache_errors on;
</span><span class='line'>
</span><span class='line'>  include /etc/nginx/mime.types;
</span><span class='line'>  default_type application/octet-stream;
</span><span class='line'>
</span><span class='line'>        # ssl settings
</span><span class='line'>  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
</span><span class='line'>  ssl_prefer_server_ciphers on;
</span><span class='line'>
</span><span class='line'>  # websockets config
</span><span class='line'>  map $http_upgrade $connection_upgrade {
</span><span class='line'>            default upgrade;
</span><span class='line'>            '' close;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>  # logging settings
</span><span class='line'>  access_log off;
</span><span class='line'>  access_log /var/log/nginx/access.log;
</span><span class='line'>  error_log /var/log/nginx/error.log;
</span><span class='line'>
</span><span class='line'>  # gzip settings
</span><span class='line'>  gzip on;
</span><span class='line'>      gzip_min_length 10240;
</span><span class='line'>      gzip_comp_level 1;
</span><span class='line'>      gzip_vary on;
</span><span class='line'>      gzip_disable msie6;
</span><span class='line'>      gzip_proxied expired no-cache no-store private auth;
</span><span class='line'>      gzip_types
</span><span class='line'>      text/css
</span><span class='line'>      text/javascript
</span><span class='line'>      text/xml
</span><span class='line'>      text/plain
</span><span class='line'>      text/x-component
</span><span class='line'>      application/javascript
</span><span class='line'>      application/x-javascript
</span><span class='line'>      application/json
</span><span class='line'>      application/xml
</span><span class='line'>      application/rss+xml
</span><span class='line'>      application/atom+xml
</span><span class='line'>      font/truetype
</span><span class='line'>      font/opentype
</span><span class='line'>      application/vnd.ms-fontobject
</span><span class='line'>      image/svg+xml;
</span><span class='line'>      reset_timedout_connection on;
</span><span class='line'>      client_body_timeout 10;
</span><span class='line'>      send_timeout 2;
</span><span class='line'>      keepalive_requests 100000;
</span><span class='line'>        
</span><span class='line'>        # virtual host configs
</span><span class='line'>      include /etc/nginx/conf.d/loki.conf;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Create the virtual host config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat /etc/nginx/conf.d/loki.conf
</span><span class='line'>upstream loki {
</span><span class='line'>  server 127.0.0.1:3100;
</span><span class='line'>  keepalive 15;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>server {
</span><span class='line'>  listen 80;
</span><span class='line'>  server_name loki.localdns.xyz;
</span><span class='line'>
</span><span class='line'>  auth_basic "loki auth";
</span><span class='line'>  auth_basic_user_file /etc/nginx/passwords;
</span><span class='line'>
</span><span class='line'>  location / {
</span><span class='line'>    proxy_read_timeout 1800s;
</span><span class='line'>    proxy_connect_timeout 1600s;
</span><span class='line'>    proxy_pass http://loki;
</span><span class='line'>    proxy_http_version 1.1;
</span><span class='line'>    proxy_set_header Upgrade $http_upgrade;
</span><span class='line'>    proxy_set_header Connection $connection_upgrade;
</span><span class='line'>    proxy_set_header Connection "Keep-Alive";
</span><span class='line'>    proxy_set_header Proxy-Connection "Keep-Alive";
</span><span class='line'>    proxy_redirect off;
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  location /ready {
</span><span class='line'>    proxy_pass http://loki;
</span><span class='line'>    proxy_http_version 1.1;
</span><span class='line'>    proxy_set_header Connection "Keep-Alive";
</span><span class='line'>    proxy_set_header Proxy-Connection "Keep-Alive";
</span><span class='line'>    proxy_redirect off;
</span><span class='line'>    auth_basic "off";
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>As you&rsquo;ve noticed, we are providing a <code>auth_basic_user_file</code> to <code>/etc/nginx/passwords</code>, so let&rsquo;s create a user that we will be using to authenticate against loki:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ htpasswd -c /etc/nginx/passwords lokiisamazing</span></code></pre></td></tr></table></div></figure>


<h2>Enable and Start Services</h2>

<p>Because we created a systemd unit file, we need to reload the systemd daemon:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo systemctl daemon-reload</span></code></pre></td></tr></table></div></figure>


<p>Then enable nginx and loki on boot:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo systemctl enable nginx
</span><span class='line'>$ sudo systemctl enable loki</span></code></pre></td></tr></table></div></figure>


<p>Then start or restart both services:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo systemctl restart nginx
</span><span class='line'>$ sudo systemctl restart loki</span></code></pre></td></tr></table></div></figure>


<p>You should see both ports, 80 and 3100 are listening:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo netstat -tulpn | grep -E '(3100|80)'
</span><span class='line'>tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      8949/nginx: master
</span><span class='line'>tcp        0      0 127.0.0.1:3100          0.0.0.0:*               LISTEN      23498/loki</span></code></pre></td></tr></table></div></figure>


<h2>Test Access</h2>

<p>You will notice that I have a <code>/ready</code> endpoint that I am proxy passing to loki, which bypasses authentication, this has been setup for my AWS Application Load Balancer&rsquo;s Target Group to perform health checks against.</p>

<p>We can verify if we are getting a 200 response code without passing authentication:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -i http://loki.localdns.xyz/ready
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Server: nginx/1.14.0 (Ubuntu)
</span><span class='line'>Date: Thu, 29 Oct 2020 09:15:52 GMT
</span><span class='line'>Content-Type: text/plain; charset=utf-8
</span><span class='line'>Content-Length: 6
</span><span class='line'>Connection: keep-alive
</span><span class='line'>X-Content-Type-Options: nosniff
</span><span class='line'>
</span><span class='line'>ready</span></code></pre></td></tr></table></div></figure>


<p>If we try to make a request to Loki&rsquo;s labels API endpoint, you will notice that we are returned with a 401 unauthorized response:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -i http://loki.localdns.xyz/loki/api/v1/labels
</span><span class='line'>HTTP/1.1 401 Unauthorized
</span><span class='line'>Server: nginx/1.14.0 (Ubuntu)
</span><span class='line'>Date: Thu, 29 Oct 2020 09:16:52 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 204
</span><span class='line'>Connection: keep-alive
</span><span class='line'>WWW-Authenticate: Basic realm="loki auth"</span></code></pre></td></tr></table></div></figure>


<p>So let&rsquo;s access the labels API endpoint by passing our basic auth credentials. To leave no leaking passwords behind, create a file and save your password content in that file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vim /tmp/.pass
</span><span class='line'>-&gt; then enter your password and save the file &lt;-</span></code></pre></td></tr></table></div></figure>


<p>Expose the content as an environment variable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ pass=$(cat /tmp/.pass)</span></code></pre></td></tr></table></div></figure>


<p>Now make a request to Loki&rsquo;s labels endpoint by passing authentication:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -i -u lokiisawesome:$pass http://loki.localdns.xyz/loki/api/v1/labels
</span><span class='line'>HTTP/1.1 200 OK
</span><span class='line'>Server: nginx/1.14.0 (Ubuntu)
</span><span class='line'>Date: Thu, 29 Oct 2020 09:20:20 GMT
</span><span class='line'>Content-Type: application/json; charset=UTF-8
</span><span class='line'>Content-Length: 277
</span><span class='line'>Connection: keep-alive
</span><span class='line'>
</span><span class='line'>{"status":"success","data":["__name__","aws_account","cluster_name","container_name","environment","filename","job","service","team"]}</span></code></pre></td></tr></table></div></figure>


<p>Then ensure that your remove the password file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rm -rf /tmp/.pass</span></code></pre></td></tr></table></div></figure>


<p>And unset your pass environment variable, to clean up your tracks:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ unset pass</span></code></pre></td></tr></table></div></figure>


<h2>LogCLI</h2>

<p>Now for my favorite part, using logcli to interact with Loki, but more specifically using <code>--tail</code> as it requires websockets, nginx will now be able to upgrade those connections:</p>

<p>Install logcli, in my case I am using a mac, so I will be using darwin:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget https://github.com/grafana/loki/releases/download/v2.0.0/logcli-darwin-amd64.zip
</span><span class='line'>$ unzip logcli-darwin-amd64.zip
</span><span class='line'>$ mv logcli-darwin-amd64 /usr/local/bin/logcli</span></code></pre></td></tr></table></div></figure>


<p>Set your environment variables for logcli:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export LOKI_ADDR=https://loki.yourdomain.com # im doing ssl termination on the aws alb
</span><span class='line'>$ export LOKI_USERNAME=lokiisawesome
</span><span class='line'>$ export LOKI_PASSWORD=$pass </span></code></pre></td></tr></table></div></figure>


<p>Now for that sweetness of tailing ALL THE LOGS!! :-D . Let&rsquo;s first discover the label that we want to select:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ logcli labels --quiet container_name | grep deadman
</span><span class='line'>ecs-deadmanswitch-4-deadmanswitch-01234567890abcdefghi</span></code></pre></td></tr></table></div></figure>


<p>Then tail for the win!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ logcli query --quiet --output raw --tail '{job="prod/dockerlogs", container_name=~"ecs-deadmanswitch.*"}'
</span><span class='line'>time="2020-10-29T09:03:36Z" level=info msg="timerID: xxxxxxxxxxxxxxxxxxxx"
</span><span class='line'>time="2020-10-29T09:03:36Z" level=info msg="POST - /ping/xxxxxxxxxxxxxxxxxxx"</span></code></pre></td></tr></table></div></figure>


<p>Awesome right?</p>

<p><img src="https://media.giphy.com/media/3ohzdIuqJoo8QdKlnW/giphy.gif" alt="" /></p>

<h2>Thank You</h2>

<p>Hope that you found this useful, make sure to follow Grafana&rsquo;s blog for more awesome content:</p>

<ul>
<li><a href="https://grafana.com/blog/">https://grafana.com/blog/</a></li>
</ul>


<p>If you liked this content, please make sure to share or come say hi on my website or twitter:</p>

<ul>
<li><a href="https://ruan.dev">w: ruan.dev</a></li>
<li><a href="https://ruan.dev">t: @ruanbekker</a></li>
</ul>


<p>For other content of mine on Loki:</p>

<ul>
<li><a href="https://blog.ruanbekker.com/blog/categories/loki/">https://blog.ruanbekker.com/blog/categories/loki/</a></li>
<li><a href="https://github.com/ruanbekker/docker-loki-distributed-minio">https://github.com/ruanbekker/docker-loki-distributed-minio</a></li>
<li><a href="https://github.com/ruanbekker/loki-docker-nginx-example">https://github.com/ruanbekker/loki-docker-nginx-example</a></li>
<li><a href="https://github.com/ruanbekker/loki-minio-docker">https://github.com/ruanbekker/loki-minio-docker</a></li>
<li><a href="https://github.com/ruanbekker/cheatsheets/tree/master/loki">https://github.com/ruanbekker/cheatsheets/tree/master/loki</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/10/26/upload-public-ssh-keys-using-ansible/">Upload Public SSH Keys Using Ansible</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-10-26T07:44:25+00:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>7:44 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post I will demonstrate how you can use ansible to automate the task of adding one or more ssh public keys to multiple servers authorized_keys file.</p>

<p>This will be focused in a scenario where you have 5 new ssh keys that we would want to copy to our bastion hosts authorized_keys file</p>

<h2>The User Accounts</h2>

<p>We have our bastion server named <code>bastion.mydomain.com</code> where would like to create the following accounts: <code>john, bob, sarah, sam, adam</code> and also upload their personal ssh public keys to those accounts so that they can logon with their ssh private keys.</p>

<p>On my local directory, I have their ssh public keys as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>~/workspace/sshkeys/john.pub
</span><span class='line'>~/workspace/sshkeys/bob.pub
</span><span class='line'>~/workspace/sshkeys/sarah.pub
</span><span class='line'>~/workspace/sshkeys/sam.pub
</span><span class='line'>~/workspace/sshkeys/adam.pub</span></code></pre></td></tr></table></div></figure>


<p>They will be referenced in our playbook as <code>key: ".pub') }}"</code> but if they were on github we can reference them as <code>key: https://github.com/.keys</code>, more info on that can be found on the <a href="https://docs.ansible.com/ansible/2.4/authorized_key_module.html">authorized_key_module</a> documentation.</p>

<h2>The Target Server</h2>

<p>Our inventory for the target server only includes one host, but we can add as many as we want, but our inventory will look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat inventory.ini
</span><span class='line'>[bastion]
</span><span class='line'>bastion-host ansible_host=34.x.x.x ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/ansible.pem ansible_python_interpreter=/usr/bin/python3
</span><span class='line'>[bastion:vars]
</span><span class='line'>ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'</span></code></pre></td></tr></table></div></figure>


<p>Test if the target server is reachable using the user <code>ubuntu</code> using our admin accounts ssh key <code>ansible.pem</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ansible -i inventory.ini -m ping bastion
</span><span class='line'>bastion | SUCCESS =&gt; {
</span><span class='line'>    "changed": false,
</span><span class='line'>    "ping": "pong"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Our Playbook</h2>

<p>In this playbook, we will reference the users that we want to create and it will loop through those users, creating them on the target server and also use those names to match to the files on our laptop to match the ssh public keys:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cat playbook.yml
</span><span class='line'>---
</span><span class='line'>- hosts: bastion
</span><span class='line'>  become: yes
</span><span class='line'>  become_user: root
</span><span class='line'>  become_method: sudo
</span><span class='line'>  tasks:
</span><span class='line'>    - name: create local user account on the target server
</span><span class='line'>      user:
</span><span class='line'>        name: ''
</span><span class='line'>        comment: ''
</span><span class='line'>        shell: /bin/bash
</span><span class='line'>        append: yes
</span><span class='line'>        groups: sudo
</span><span class='line'>        generate_ssh_key: yes
</span><span class='line'>        ssh_key_type: rsa
</span><span class='line'>      with_items:
</span><span class='line'>        - john
</span><span class='line'>        - bob
</span><span class='line'>        - sarah
</span><span class='line'>        - sam
</span><span class='line'>        - adam
</span><span class='line'>
</span><span class='line'>    - name: upload ssh public key to users authorized keys file
</span><span class='line'>      authorized_key:
</span><span class='line'>        user: ''
</span><span class='line'>        state: present
</span><span class='line'>        manage_dir: yes
</span><span class='line'>        key: ".pub') }}"
</span><span class='line'>      with_items:
</span><span class='line'>        - john
</span><span class='line'>        - bob
</span><span class='line'>        - sarah
</span><span class='line'>        - sam
</span><span class='line'>        - adam</span></code></pre></td></tr></table></div></figure>


<h2>Deploy</h2>

<p>Run the playbook:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ansible-playbook -i inventory.ini ssh-setup.yml
</span><span class='line'>
</span><span class='line'>PLAY [bastion]
</span><span class='line'>
</span><span class='line'>TASK [Gathering Facts]
</span><span class='line'>ok: [bastion-host]
</span><span class='line'>
</span><span class='line'>TASK [create local user account on the target server]
</span><span class='line'>changed: [bastion-host] =&gt; (item=john)
</span><span class='line'>changed: [bastion-host] =&gt; (item=bob)
</span><span class='line'>changed: [bastion-host] =&gt; (item=sarah)
</span><span class='line'>changed: [bastion-host] =&gt; (item=sam)
</span><span class='line'>changed: [bastion-host] =&gt; (item=adam)
</span><span class='line'>
</span><span class='line'>TASK [upload ssh public key to users authorized keys file]
</span><span class='line'>changed: [bastion-host] =&gt; (item=john)
</span><span class='line'>changed: [bastion-host] =&gt; (item=bob)
</span><span class='line'>changed: [bastion-host] =&gt; (item=sarah)
</span><span class='line'>changed: [bastion-host] =&gt; (item=sam)
</span><span class='line'>changed: [bastion-host] =&gt; (item=adam)
</span><span class='line'>
</span><span class='line'>PLAY RECAP
</span><span class='line'>bastion-host                   : ok=6    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span></code></pre></td></tr></table></div></figure>


<p>Now when we ask one of the users, adam for example, to authenticate with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh -i ~/.ssh/path_to_his_private_key.pem adamin@bastion.mydomain.com</span></code></pre></td></tr></table></div></figure>


<p>They should have access to the server.</p>

<h2>Thank You</h2>

<p>Thanks for reading, for more information on this module check out their documentation:</p>

<ul>
<li><a href="https://docs.ansible.com/ansible/2.4/authorized_key_module.html">https://docs.ansible.com/ansible/2.4/authorized_key_module.html</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/6">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/4">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>

<section>
  <h1>Say Hi!</h1>
  Send me a note using the <a href="https://saythanks.io/to/ruanbekker">saythanks.io</a> project.
</section>

<section>
  <h1>Newsletter</h1>
  View my newsletter on <a href="http://digests.ruanbekker.com/?via=ruanbekker-blog" target="_blank">digests.ruanbekker.com</a>
</section>

<section>
  <h1>Cheetsheet Repository</h1>
  Have a look at my <strong>Cheetsheets Github Repository</strong>:
  <p></p>
  <a href="https://github.com/ruanbekker/cheatsheets" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719365-1d8a05e2-a0d3-4078-a84f-c691544e4b8f.png" width="480" height="240"></a>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/06/15/how-to-persist-iptables-rules-after-reboots/">How to Persist Iptables Rules After Reboots</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/06/14/how-to-read-and-write-json-data-with-python/">How to Read and Write Json Data With Python</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/05/31/setup-linkding-bookmarks-manager-on-docker/">Setup Linkding Bookmarks Manager on Docker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/05/31/python-flask-forms-with-jinja-templating/">Python Flask Forms With Jinja Templating</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/05/30/prometheus-relabel-config-examples/">Prometheus Relabel Config Examples</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Store</h1>
  <ul id=""></ul>
  <p></p>
  <strong>Check out my Store</strong>: Have a look at my latest elasticsearch cheatsheet in PDF format.
  <p></p>
  <a href="https://ruan.dev/store/elasticsearch-cheatsheet/?source=blog.ruanbekker.com" target="_blank"><img src="https://user-images.githubusercontent.com/567298/169719853-fe9a50a4-03f2-4a26-a422-0deb946ca09c.png" width="480" height="240"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ruanbekker" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FFDD00" data-position="Right" data-x_margin="18" data-y_margin="18"></script>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
