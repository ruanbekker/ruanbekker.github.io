
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="Today we will use Docker Secrets, more specifically store our MySQL Passwords in Secrets, which will be passed to our containers, so that we don& &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="canonical" href="http://blog.ruanbekker.com/posts/6/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My HowTo Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/23/use-docker-secrets-with-mysql-on-docker-swarm/">Use Docker Secrets With MySQL on Docker Swarm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-23T16:55:15-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2017</span></span> <span class='time'>4:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://obj-cache.cloud.ruanbekker.com/docker-logo.png" alt="" /></p>

<p>Today we will use Docker Secrets, more specifically store our MySQL Passwords in Secrets, which will be passed to our containers, so that we don&rsquo;t use clear text passwords in our Compose files.</p>

<h2>What is Docker Secrets:</h2>

<p>In Docker, Docker Secrets are encrypted during transit and at rest in a Docker Swarm Cluster. The great thing about Docker Secrets is that you can manage these secrets from a central place, and the fact that it encrypts the data and transfers the data securely to the containers that needs the secrets. So you authorize which containers needs access to these secrets.</p>

<p>So instead of setting the MySQL Root Passwords in clear text, you will create the secrets, then in your docker-compose file, you will reference the secret name.</p>

<h2>Deploy MySQL with Docker Secrets</h2>

<p>We will deploy a Stack that contains MySQL and Adminer (WebUI for MySQL).</p>

<p>We will make the MySQL Service Persistent by setting a constraint to only run on the Manager node, as we will create the volume path on the host, and then map the host to the container so that the container can have persistent data. We will also create secrets for our MySQL Service so that we dont expose any plaintext passwords in our compose file.</p>

<p>Our Docker Compose file:</p>

<figure class='code'><figcaption><span>docker-compose.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">db</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql</span>
</span><span class='line'>    <span class="l-Scalar-Plain">secrets</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">db_root_password</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">db_dba_password</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">placement</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">node.role == manager</span><span class="p-Indicator">]</span>
</span><span class='line'>      <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">reservations</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">128M</span>
</span><span class='line'>        <span class="l-Scalar-Plain">limits</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">256M</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3306:3306</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">MYSQL_USER</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dba</span>
</span><span class='line'>      <span class="l-Scalar-Plain">MYSQL_DATABASE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mydb</span>
</span><span class='line'>      <span class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD_FILE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/run/secrets/db_root_password</span>
</span><span class='line'>      <span class="l-Scalar-Plain">MYSQL_PASSWORD_FILE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/run/secrets/db_dba_password</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bind</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/opt/docker/volumes/mysql</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/lib/mysql</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">adminer</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">adminer</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:8080</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">secrets</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">db_root_password</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">db_dba_password</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">appnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Dependencies:</h2>

<p>As we specified our secrets and networks as external resources, it needs to exist before we deploy our stack. We also need to create the directory for our mysql data, as the data will be mapped from our host to our container.</p>

<p>Create the Overlay Network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create --driver overlay appnet
</span></code></pre></td></tr></table></div></figure>


<p>Create the Secrets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>openssl rand -base64 <span class="m">12</span> <span class="p">|</span> docker secret create db_root_password -
</span><span class='line'><span class="nv">$ </span>openssl rand -base64 <span class="m">12</span> <span class="p">|</span> docker secret create db_dba_password -
</span></code></pre></td></tr></table></div></figure>


<p>List the Secrets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker secret ls
</span><span class='line'>ID                          NAME                CREATED             UPDATED
</span><span class='line'>jzhrwyxkiqt8v81ow0xjktqnw   db_root_password    <span class="m">12</span> seconds ago      <span class="m">12</span> seconds ago
</span><span class='line'>plr6rbrqkqy7oplrd21pja3ol   db_dba_password     <span class="m">4</span> seconds ago       <span class="m">4</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>Inspect the secret, so that we can see that theres not value exposed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker secret inspect db_root_password
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;ID&quot;</span>: <span class="s2">&quot;jzhrwyxkiqt8v81ow0xjktqnw&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Version&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Index&quot;</span>: 982811
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;CreatedAt&quot;</span>: <span class="s2">&quot;2017-11-23T14:33:17.005968748Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;UpdatedAt&quot;</span>: <span class="s2">&quot;2017-11-23T14:33:17.005968748Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Spec&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;db_root_password&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Labels&quot;</span>: <span class="o">{}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the Directory for MySQL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /opt/docker/volumes/mysql
</span></code></pre></td></tr></table></div></figure>


<h2>Deployment Time!</h2>

<p>Deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml apps
</span><span class='line'>Creating service apps_adminer
</span><span class='line'>Creating service apps_db
</span></code></pre></td></tr></table></div></figure>


<p>As you can see the data of our MySQL container resides on our host, which makes the data persistent for the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls /opt/docker/volumes/mysql/
</span><span class='line'>auto.cnf  ca-key.pem  ca.pem  client-cert.pem  client-key.pem  ib_buffer_pool  ibdata1  ib_logfile0  ib_logfile1  ibtmp1  mydb  mysql  performance_schema  private_key.pem  public_key.pem  server-cert.pem  server-key.pem  sys
</span></code></pre></td></tr></table></div></figure>


<h2>Connect to MySQL</h2>

<p>The value of our secrets will reside under <code>/run/secrets/</code> in our container, as we have mapped it to our mysql container, lets have a look at them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> ls /run/secrets/
</span><span class='line'>db_dba_password  db_root_password
</span></code></pre></td></tr></table></div></figure>


<p>View the actual value of the <code>db_root_password</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> cat /run/secrets/db_root_password
</span><span class='line'>mRpcY1eY2+wimf10
</span></code></pre></td></tr></table></div></figure>


<p>Connecting to MySQL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> mysql -u root -p
</span><span class='line'>Enter password:
</span><span class='line'>Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span><span class='line'>Your MySQL connection id is 8
</span><span class='line'>Server version: 5.7.20 MySQL Community Server <span class="o">(</span>GPL<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2017, Oracle and/or its affiliates. All rights reserved.
</span><span class='line'>
</span><span class='line'>Oracle is a registered trademark of Oracle Corporation and/or its
</span><span class='line'>affiliates. Other names may be trademarks of their respective
</span><span class='line'>owners.
</span><span class='line'>
</span><span class='line'>Type <span class="s1">&#39;help;&#39;</span> or <span class="s1">&#39;\h&#39;</span> <span class="k">for</span> help. Type <span class="s1">&#39;\c&#39;</span> to clear the current input statement.
</span><span class='line'>
</span><span class='line'>mysql&gt; show databases<span class="p">;</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> Database           <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> information_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mydb               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mysql              <span class="p">|</span>
</span><span class='line'><span class="p">|</span> performance_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> sys                <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="m">5</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we have deployed adminer, you can access the Adminer WebUI on the Host&rsquo;s IP and the Defined Port.</p>

<h2>Testing Data Persistance:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> mysql -u root -p
</span><span class='line'>Enter password:
</span><span class='line'>Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span><span class='line'>
</span><span class='line'>mysql&gt; create database ruan<span class="p">;</span>
</span><span class='line'>Query OK, <span class="m">1</span> row affected <span class="o">(</span>0.00 sec<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>mysql&gt; show databases<span class="p">;</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> Database           <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> information_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mydb               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mysql              <span class="p">|</span>
</span><span class='line'><span class="p">|</span> performance_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> ruan               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> sys                <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="m">6</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>mysql&gt; <span class="nb">exit</span><span class="p">;</span>
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<p>Verify the hostname of our container, before we kill the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> hostname
</span><span class='line'>bdedb54bbc2b
</span></code></pre></td></tr></table></div></figure>


<p>Kill the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">kill</span> <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span>
</span><span class='line'>bdedb54bbc2b
</span></code></pre></td></tr></table></div></figure>


<p>Verify the status of the MySQL Service, as we can see the service count is 0, so the container was succesfully killed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ls -f <span class="nv">name</span><span class="o">=</span>apps_db
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
</span><span class='line'>nzf96q05fktm        apps_db             replicated          0/1                 mysql:latest        *:3306-&gt;3306/tcp
</span></code></pre></td></tr></table></div></figure>


<p>After waiting for a couple of seconds, we can see the service is in service again, then check the hostname so that we can confirm that its a new container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ls -f <span class="nv">name</span><span class="o">=</span>apps_db
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
</span><span class='line'>nzf96q05fktm        apps_db             replicated          1/1                 mysql:latest        *:3306-&gt;3306/tcp
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> hostname
</span><span class='line'>95c15c89f891
</span></code></pre></td></tr></table></div></figure>


<p>Logong to MySQL again and verify if our perviously created database is still there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> mysql -u root -p
</span><span class='line'>Enter password:
</span><span class='line'>Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span><span class='line'>
</span><span class='line'>mysql&gt; show databases<span class="p">;</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> Database           <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> information_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mydb               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mysql              <span class="p">|</span>
</span><span class='line'><span class="p">|</span> performance_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> ruan               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> sys                <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="m">6</span> rows in <span class="nb">set</span> <span class="o">(</span>0.01 sec<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>By design docker is stateless, but as we mapped the host&rsquo;s path to the container our data is persistent. As we have set a constraint so that the container must only spin up on this node, the container will always have access to the data path.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/22/setup-a-3-node-galera-mariadb-cluster-on-ubuntu-16/">Setup a 3 Node Galera MariaDB Cluster on Ubuntu 16</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-22T18:17:14-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>6:17 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/lpT6Du.jpg" alt="" /></p>

<p>Today we will setup a 3-Node Galera MariaDB Cluster which is a Multi Master MySQL/MariaDB Cluster on Ubuntu 16.04</p>

<h2>Our Server Details:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>172.31.11.174     mysql-1
</span><span class='line'>172.31.13.206     mysql-2
</span><span class='line'>172.31.6.93       mysql-3
</span></code></pre></td></tr></table></div></figure>


<h2>Update Repo Index and Upgrade:</h2>

<p>Update the repository indexes and install the needed packages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span></code></pre></td></tr></table></div></figure>


<p>Install the needed repository and packages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install software-properties-common -y
</span><span class='line'><span class="nv">$ </span>apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8
</span><span class='line'><span class="nv">$ </span>add-apt-repository <span class="s1">&#39;deb [arch=amd64,i386,ppc64el] http://mirror.lstn.net/mariadb/repo/10.1/ubuntu xenial main&#39;</span>
</span><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>apt install mariadb-server rsync -y
</span></code></pre></td></tr></table></div></figure>


<h2>Configuration:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &gt; /etc/mysql/conf.d/galera.cnf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">[mysqld]</span>
</span><span class='line'><span class="s">binlog_format=ROW</span>
</span><span class='line'><span class="s">default-storage-engine=innodb</span>
</span><span class='line'><span class="s">innodb_autoinc_lock_mode=2</span>
</span><span class='line'><span class="s">bind-address=0.0.0.0</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Galera Provider Configuration</span>
</span><span class='line'><span class="s">wsrep_on=ON</span>
</span><span class='line'><span class="s">wsrep_provider=/usr/lib/galera/libgalera_smm.so</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Galera Cluster Configuration</span>
</span><span class='line'><span class="s">wsrep_cluster_name=&quot;my-galera-cluster&quot;</span>
</span><span class='line'><span class="s">wsrep_cluster_address=&quot;gcomm://172.31.11.174,172.31.13.206,172.31.6.93&quot;</span>
</span><span class='line'><span class="s"># Galera Synchronization Configuration</span>
</span><span class='line'><span class="s">wsrep_sst_method=rsync</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Galera Node Configuration</span>
</span><span class='line'><span class="s">wsrep_node_address=&quot;172.31.11.174&quot;</span>
</span><span class='line'><span class="s">wsrep_node_name=&quot;mysql-1&quot;</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Comment out bind-address, so that MariaDB process is reachable from other nodes, by default it wont be in the config, but just to make sure, if it is uncommented, comment the config:</p>

<figure class='code'><figcaption><span>/etc/mysql/my.cnf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># bind-address = 127.0.0.1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Stop the MariaDB Process:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl stop mariadb
</span></code></pre></td></tr></table></div></figure>


<p>Note: Repeat the above steps on all 3 nodes.</p>

<h2>Initialize the Cluster:</h2>

<p>On the First Node, Initialize the Galera Cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/usr/bin/galera_new_cluster
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>mariadb
</span></code></pre></td></tr></table></div></figure>


<p>Check how many nodes are active in the Cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Node-2: Start and Enable MariaDB</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl start mariadb
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>mariadb
</span></code></pre></td></tr></table></div></figure>


<p>Verify that the Node has checked in with the Cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">2</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Node-3: Start and Enable MariaDB</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl start mariadb
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>mariadb
</span></code></pre></td></tr></table></div></figure>


<p>Verify that the Node has checked in with the Cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">3</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create a Database, Table and Record:</h2>

<p>Write some data to the table, then reboot the node, in this example on node-1, then logon to node-2 check the number of nodes that&rsquo;s active in the cluster, which should be 2, then at the same time, look if the data is replicated:</p>

<h2>Node-1: Writing the Data to Our Galera Cluster</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">use</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">create</span> <span class="k">database</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">create</span> <span class="k">table</span> <span class="nf">foo</span> <span class="p">(</span><span class="n">name</span> <span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;ruan&#39;</span><span class="p">);</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'><span class="o">+------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">name</span> <span class="o">|</span>
</span><span class='line'><span class="o">+------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">ruan</span> <span class="o">|</span>
</span><span class='line'><span class="o">+------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that our data is in our database, reboot the node, logon to node-2 and check if the data is replicated:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">use</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'><span class="o">+------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">name</span> <span class="o">|</span>
</span><span class='line'><span class="o">+------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">ruan</span> <span class="o">|</span>
</span><span class='line'><span class="o">+------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>While the one node is rebooting, check how many nodes are checked into our cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">2</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our data is replicated, and after waiting for a couple of seconds, we retry our command to see if the rebooted node checked into the cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">3</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can confirm that the node that was rebooted, has checked in with the cluster again.</p>

<h2>Firewall Rules opened while testing:</h2>

<p>TCP: <code>3306, 4567, 4568, 4444</code>
UDP: <code>4567</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/22/delete-old-items-with-amazons-dynamodb-ttl-feature/">Delete Old Items With Amazons DynamoDB TTL Feature</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-22T17:47:31-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>5:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://obj-cache.cloud.ruanbekker.com/dynamodb.png" alt="" /></p>

<p>As you may know a DynamoDB Table&rsquo;s Partition Splits on 2 factors, Read/Write Capacity Units and when Storage goes over 10GB.</p>

<h2>Automatically Deleting Old Data in DynamoDB:</h2>

<p>With the TTL Feature in DynamoDB, we can enable TTL on a Attribute on our Table, the attributes value needs to have an epoc time value, more specifically, when the current time is the same as the value of on of the items attribute value, that item will be expired, which will be deleted.</p>

<h2>What we will be doing:</h2>

<ul>
<li>Use Boto3 in Python</li>
<li>Create DynamoDB Table: &lsquo;session-table&rsquo;</li>
<li>Set TTL Attribute on &lsquo;ExpirationTime&rsquo;, so whenever the epoch time is equals to the AttributeValue it will delete the item</li>
<li>Do one PUT Item with 48 Hours expiry Date from the Write</li>
<li>Do 240 PUT Items with 24 Hours expiry Date from the Write</li>
<li>Verify after 24 hours if only one item is in our table.</li>
</ul>


<h2>Pre-Requisites:</h2>

<p>Install the AWS CLI, Boto3 and configure your credentials, so that boto3 can read from your credential provider:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install awscli
</span><span class='line'><span class="nv">$ </span>pip install boto3
</span><span class='line'><span class="nv">$ </span>aws configure
</span><span class='line'>AWS Access Key ID <span class="o">[</span>****************XYZ<span class="o">]</span>:
</span><span class='line'>AWS Secret Access Key <span class="o">[</span>****************xyz<span class="o">]</span>:
</span><span class='line'>Default region name <span class="o">[</span>eu-west-1<span class="o">]</span>:
</span><span class='line'>Default output format <span class="o">[</span>json<span class="o">]</span>:
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Table:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
</span><span class='line'>    <span class="n">TableName</span><span class="o">=</span><span class="s">&#39;session-table&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">KeySchema</span><span class="o">=</span><span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s">&#39;sessionid&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;KeyType&#39;</span><span class="p">:</span> <span class="s">&#39;HASH&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="n">AttributeDefinitions</span><span class="o">=</span><span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s">&#39;sessionid&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;AttributeType&#39;</span><span class="p">:</span> <span class="s">&#39;S&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="n">ProvisionedThroughput</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;ReadCapacityUnits&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;WriteCapacityUnits&#39;</span><span class="p">:</span> <span class="mi">2</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>From the Console, enable TTL and set the TTL Attribute on <code>ExpirationTime</code></p>

<h2>Write Data to DynamoDB</h2>

<p>We have 2 functions that will write the current epoch time to the <code>CreationTime</code> attribute and <code>ExpirationTime</code> will have the current time plus the 24 hours in seconds, which will be used for the 240 items that will be written using the for loop and the other function with the 48 hours of seconds, which will be a single write item.</p>

<p>Then we will just write random data to the session data attribute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
</span><span class='line'>
</span><span class='line'><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;james&#39;</span><span class="p">,</span> <span class="s">&#39;john&#39;</span><span class="p">,</span> <span class="s">&#39;steve&#39;</span><span class="p">,</span> <span class="s">&#39;peter&#39;</span><span class="p">,</span> <span class="s">&#39;frank&#39;</span><span class="p">,</span> <span class="s">&#39;steven&#39;</span><span class="p">,</span> <span class="s">&#39;jonathan&#39;</span><span class="p">,</span> <span class="s">&#39;stephen&#39;</span><span class="p">,</span> <span class="s">&#39;will&#39;</span><span class="p">,</span> <span class="s">&#39;adam&#39;</span><span class="p">,</span> <span class="s">&#39;william&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">retailer</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;shoprite&#39;</span><span class="p">,</span> <span class="s">&#39;edgars&#39;</span><span class="p">,</span> <span class="s">&#39;pnp&#39;</span><span class="p">,</span> <span class="s">&#39;bestbuy&#39;</span><span class="p">,</span> <span class="s">&#39;ok&#39;</span><span class="p">,</span> <span class="s">&#39;grocer-a&#39;</span><span class="p">,</span> <span class="s">&#39;amazon&#39;</span><span class="p">,</span> <span class="s">&#39;seveneleven&#39;</span><span class="p">,</span> <span class="s">&#39;shop-a&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;dev&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">ddb</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;session-table&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">current_time</span><span class="p">():</span>
</span><span class='line'>    <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">current_time</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">expiration_time</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="mi">86400</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="err">48</span><span class="nf">h_expiration_time</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="mi">172800</span>
</span><span class='line'>
</span><span class='line'><span class="c"># expiry on 48 hours</span>
</span><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
</span><span class='line'>    <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;sessionid&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span class='line'>        <span class="s">&#39;CreationTime&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">(),</span>
</span><span class='line'>        <span class="s">&#39;ExpirationTime&#39;</span><span class="p">:</span> <span class="mi">48</span><span class="n">h_expiration_time</span><span class="p">(),</span>
</span><span class='line'>        <span class="s">&#39;SessionData&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">names</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&#39;Retailer&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">retailer</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&#39;TimeOfTransaction&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">(),</span>
</span><span class='line'>            <span class="s">&#39;Amount&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">9000</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># expiry on 24 hours</span>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">240</span><span class="p">):</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">client</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;sessionid&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span class='line'>            <span class="s">&#39;CreationTime&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">(),</span>
</span><span class='line'>            <span class="s">&#39;ExpirationTime&#39;</span><span class="p">:</span> <span class="n">expiration_time</span><span class="p">(),</span>
</span><span class='line'>            <span class="s">&#39;SessionData&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">names</span><span class="p">),</span>
</span><span class='line'>                <span class="s">&#39;Retailer&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">retailer</span><span class="p">),</span>
</span><span class='line'>                <span class="s">&#39;TimeOfTransaction&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">(),</span>
</span><span class='line'>                <span class="s">&#39;Amount&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">9000</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Verify:</h2>

<p>Verify after 24 hours if the item with the 48 hour expiration time is still in our table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span> <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;sessionid&#39;</span><span class="p">:</span> <span class="s">&#39;69c2a472-f70e-4d72-b25f-e27573696b0c&#39;</span><span class="p">}</span> <span class="p">)[</span><span class="s">&#39;Item&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s">u&#39;ExpirationTime&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;1510672221&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="s">u&#39;CreationTime&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;1510585821&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="s">u&#39;sessionid&#39;</span><span class="p">:</span> <span class="s">u&#39;69c2a472-f70e-4d72-b25f-e27573696b0c&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">u&#39;SessionData&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">u&#39;Amount&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;3553&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="s">u&#39;Retailer&#39;</span><span class="p">:</span> <span class="s">u&#39;amazon&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">u&#39;TimeOfTransaction&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;1510585821&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="s">u&#39;Name&#39;</span><span class="p">:</span> <span class="s">u&#39;steve&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which we can see is still there, when doing a GET item on one of our 24 hour expired items, we can see that its no longer there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span> <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;sessionid&#39;</span><span class="p">:</span> <span class="s">&#39;70b9fc8c-19c4-49d3-bf63-046e992335af&#39;</span><span class="p">}</span> <span class="p">)[</span><span class="s">&#39;Item&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
</span><span class='line'><span class="ne">KeyError</span><span class="p">:</span> <span class="s">&#39;Item&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing a SCAN operation, we should see one item:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="s">&#39;session-table&#39;</span><span class="p">,</span> <span class="n">Limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">Select</span><span class="o">=</span><span class="s">&#39;COUNT&#39;</span><span class="p">,</span> <span class="n">ReturnConsumedCapacity</span><span class="o">=</span><span class="s">&#39;TOTAL&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;Count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;ScannedCount&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;ConsumedCapacity&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;CapacityUnits&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;TableName&quot;</span><span class="p">:</span> <span class="s">&quot;session-table&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&quot;ResponseMetadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;RetryAttempts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;HTTPStatusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;RequestId&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;HTTPHeaders&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;x-amzn-requestid&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;content-length&quot;</span><span class="p">:</span> <span class="s">&quot;107&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;server&quot;</span><span class="p">:</span> <span class="s">&quot;Server&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;connection&quot;</span><span class="p">:</span> <span class="s">&quot;keep-alive&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;x-amz-crc32&quot;</span><span class="p">:</span> <span class="s">&quot;2228370918&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;date&quot;</span><span class="p">:</span> <span class="s">&quot;Tue, 14 Nov 2017 12:02:31 GMT&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;content-type&quot;</span><span class="p">:</span> <span class="s">&quot;application/x-amz-json-1.0&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we can confirm that the TTL feature expires the data based on the epoch value we provide our item.</p>

<h2>Delete the Table:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="s">&#39;session-table&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://sysadmins.co.za/interfacing-amazon-dynamodb-with-python-using-boto3/">https://sysadmins.co.za/interfacing-amazon-dynamodb-with-python-using-boto3/</a></li>
<li><a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html">http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/22/update-your-ghost-blog-with-the-ghost-cli/">Update Your Ghost Blog With the Ghost-CLI</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-22T17:36:45-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>5:36 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you installed your Ghost Blog with the <a href="https://docs.ghost.org/docs/install">Ghost-CLI</a>, you can easily upgrade your Ghost version using the CLI.</p>

<h2>Backups</h2>

<p>Backup your blog by exporting the json via the Ghost Admin Interface, and also update your content directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo su - ghost
</span><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /var/www/ghost
</span><span class='line'><span class="nv">$ </span>tar -zcf /home/ghost/backups/ghost-content-<span class="k">$(</span>date +%F<span class="k">)</span>.tar.gz content
</span></code></pre></td></tr></table></div></figure>


<h2>Check the Current Version:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ghost status
</span><span class='line'>
</span><span class='line'>Version:
</span><span class='line'>1.17.0
</span></code></pre></td></tr></table></div></figure>


<h2>Update Ghost:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>npm i -g ghost-cli
</span><span class='line'><span class="nv">$ </span>ghost update
</span></code></pre></td></tr></table></div></figure>


<h2>Verify Version:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ghost status
</span><span class='line'>
</span><span class='line'>Version:
</span><span class='line'>1.17.0
</span></code></pre></td></tr></table></div></figure>


<p>No need to restart Ghost as the update function restarted the process already.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://docs.ghost.org/docs/upgrade">https://docs.ghost.org/docs/upgrade</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/22/use-the-reindex-api-on-elasticsearch-to-reindex-your-data/">Use the Reindex API on Elasticsearch to Reindex Your Data</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-22T09:32:00-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>9:32 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A Basic Example of Reindexing Data with the <code>/_reindex</code> API on Elasticsearch:</p>

<h2>Provision Elasticsearch with Docker:</h2>

<p>I will be using Elasticsearch on Docker for this Example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run -itd --name elasticsearch --publish 9200:9200 elasticsearch:alpine
</span></code></pre></td></tr></table></div></figure>


<h2>Create Indexes:</h2>

<p>Create 3 Indexes and POST 2 Documents to each Index:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPUT http://127.0.0.1:9200/animals-2017.11.20
</span><span class='line'><span class="nv">$ </span>curl -XPUT http://127.0.0.1:9200/animals-2017.11.21
</span><span class='line'><span class="nv">$ </span>curl -XPUT http://127.0.0.1:9200/animals-2017.11.21
</span></code></pre></td></tr></table></div></figure>


<p>Create the Index where we will reindex the data to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPUT http://127.0.0.1:9200/animals-2017.11 -d <span class="s1">&#39;{&quot;settings&quot;: {&quot;number_of_shards&quot;: 5, &quot;number_of_replicas&quot;: 0}}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>POST 2 documents to each index:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST http://127.0.0.1:9200/animals-2017.11.20/name/ -d <span class="s1">&#39;{&quot;name&quot;: &quot;max&quot;, &quot;type&quot;: &quot;labrador&quot;}&#39;</span>
</span><span class='line'><span class="nv">$ </span>curl -XPOST http://127.0.0.1:9200/animals-2017.11.20/name/ -d <span class="s1">&#39;{&quot;name&quot;: &quot;sam&quot;, &quot;type&quot;: &quot;pooch&quot;}&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -XPOST http://127.0.0.1:9200/animals-2017.11.21/name/ -d <span class="s1">&#39;{&quot;name&quot;: &quot;doggie&quot;, &quot;type&quot;: &quot;bulldog&quot;}&#39;</span>
</span><span class='line'><span class="nv">$ </span>curl -XPOST http://127.0.0.1:9200/animals-2017.11.21/name/ -d <span class="s1">&#39;{&quot;name&quot;: &quot;james&quot;, &quot;type&quot;: &quot;huskey&quot;}&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -XPOST http://127.0.0.1:9200/animals-2017.11.22/name/ -d <span class="s1">&#39;{&quot;name&quot;: &quot;sarah&quot;, &quot;type&quot;: &quot;poodle&quot;}&#39;</span>
</span><span class='line'><span class="nv">$ </span>curl -XPOST http://127.0.0.1:9200/animals-2017.11.22/name/ -d <span class="s1">&#39;{&quot;name&quot;: &quot;frank&quot;, &quot;type&quot;: &quot;alsation&quot;}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>View the Indexes:</h2>

<p>As you can see we have 2 documents per index, and a empty index for the data that we would like to reindex to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1:9200/_cat/indices?v
</span><span class='line'>health status index               uuid                     pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>yellow open   animals-2017.11.20  AxRYUfNpQ5ev2mdZf0bYrw   <span class="m">5</span>   <span class="m">1</span>          <span class="m">2</span>            <span class="m">0</span>      8.9kb          8.9kb
</span><span class='line'>green  open   animals-2017.11     1T6TkYWwRuerIZ5_np1B0w   <span class="m">5</span>   <span class="m">0</span>          <span class="m">0</span>            <span class="m">0</span>      1.5kb          1.5kb
</span><span class='line'>yellow open   animals-2017.11.22  fCdaRyBZRiWyQ3tZLhdBrw   <span class="m">5</span>   <span class="m">1</span>          <span class="m">2</span>            <span class="m">0</span>      8.9kb          8.9kb
</span><span class='line'>yellow open   animals-2017.11.21  4Ei9zMDITHy1dI8lIzfjjA   <span class="m">5</span>   <span class="m">1</span>          <span class="m">2</span>            <span class="m">0</span>      8.9kb          8.9kb
</span></code></pre></td></tr></table></div></figure>


<h2>Reindex the Data to our Monthly Index:</h2>

<p>We will define our query to match all the indexes that has the data and reindex to our new index <code>animals-2017.11</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPOST http://127.0.0.1:9200/_reindex -d <span class="s1">&#39;{&quot;source&quot;: {&quot;index&quot;: &quot;animals-2017.11.*&quot;}, &quot;dest&quot;: {&quot;index&quot;: &quot;animals-2017.11&quot;} }&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;took&quot;</span>:219,<span class="s2">&quot;timed_out&quot;</span>:false,<span class="s2">&quot;total&quot;</span>:6,<span class="s2">&quot;updated&quot;</span>:0,<span class="s2">&quot;created&quot;</span>:6,<span class="s2">&quot;deleted&quot;</span>:0,<span class="s2">&quot;batches&quot;</span>:1,<span class="s2">&quot;version_conflicts&quot;</span>:0,<span class="s2">&quot;noops&quot;</span>:0,<span class="s2">&quot;retries&quot;</span>:<span class="o">{</span><span class="s2">&quot;bulk&quot;</span>:0,<span class="s2">&quot;search&quot;</span>:0<span class="o">}</span>,<span class="s2">&quot;throttled_millis&quot;</span>:0,<span class="s2">&quot;requests_per_second&quot;</span>:-1.0,<span class="s2">&quot;throttled_until_millis&quot;</span>:0,<span class="s2">&quot;failures&quot;</span>:<span class="o">[]}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>View the Indexes:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1:9200/_cat/indices?v
</span><span class='line'>health status index               uuid                     pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>yellow open   animals-2017.11.20  AxRYUfNpQ5ev2mdZf0bYrw   <span class="m">5</span>   <span class="m">1</span>          <span class="m">2</span>            <span class="m">0</span>      8.9kb          8.9kb
</span><span class='line'>green  open   animals-2017.11     1T6TkYWwRuerIZ5_np1B0w   <span class="m">5</span>   <span class="m">0</span>          <span class="m">6</span>            <span class="m">0</span>     20.2kb         20.2kb
</span><span class='line'>yellow open   animals-2017.11.22  fCdaRyBZRiWyQ3tZLhdBrw   <span class="m">5</span>   <span class="m">1</span>          <span class="m">2</span>            <span class="m">0</span>      8.9kb          8.9kb
</span><span class='line'>yellow open   animals-2017.11.21  4Ei9zMDITHy1dI8lIzfjjA   <span class="m">5</span>   <span class="m">1</span>          <span class="m">2</span>            <span class="m">0</span>      8.9kb          8.9kb
</span></code></pre></td></tr></table></div></figure>


<h2>Delete the Old Indexes:</h2>

<p>As your data is now reindexed, we can safely remove our old indexes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XDELETE <span class="s1">&#39;http://127.0.0.1:9200/animals-2017.11.*&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To verify:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XGET http://127.0.0.1:9200/_cat/indices?v
</span><span class='line'>health status index               uuid                     pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   animals-2017.11     1T6TkYWwRuerIZ5_np1B0w   <span class="m">5</span>   <span class="m">0</span>          <span class="m">6</span>            <span class="m">0</span>     20.2kb         20.2kb
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/22/using-elasticsearch-curator-to-reindex-data/">Using Elasticsearch Curator to Reindex Data</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-22T09:09:28-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>9:09 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I was using Elasticsearch Curator to reindex indices that was created on a daily basis, to reindex all the data to one index. I used this route as the old data will not be accessed frequently.</p>

<h2>Install Elasticsearch Curator</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run -it python:2.7-alpine sh
</span><span class='line'><span class="nv">$ </span>pip install elasticsearch-curator
</span></code></pre></td></tr></table></div></figure>


<h2>Create Configs:</h2>

<p>Create the curator config:</p>

<figure class='code'><figcaption><span>config.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="c1"># Remember, leave a key empty if there is no value.  None will be a string,</span>
</span><span class='line'><span class="c1"># not a Python &quot;NoneType&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">client</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">es.endpoint.com</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>  <span class="l-Scalar-Plain">use_ssl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ssl_no_validate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>  <span class="l-Scalar-Plain">http_auth</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">admin:pass</span>
</span><span class='line'>  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
</span><span class='line'>  <span class="l-Scalar-Plain">master_only</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">loglevel</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INFO</span>
</span><span class='line'>  <span class="l-Scalar-Plain">logfile</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">logformat</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">blacklist</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;urllib3&#39;</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the action config:</p>

<figure class='code'><figcaption><span>action-reindex.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="c1"># Remember, leave a key empty if there is no value.  None will be a string,</span>
</span><span class='line'><span class="c1"># not a Python &quot;NoneType&quot;</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Also remember that all examples have &#39;disable_action&#39; set to True.  If you</span>
</span><span class='line'><span class="c1"># want to use this action as a template, be sure to set this to False after</span>
</span><span class='line'><span class="c1"># copying it.</span>
</span><span class='line'><span class="l-Scalar-Plain">actions</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">1</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="s">&quot;Reindex</span><span class="nv"> </span><span class="s">index-2017.10.{30,31}</span><span class="nv"> </span><span class="s">into</span><span class="nv"> </span><span class="s">new-index-2017.10&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">reindex</span>
</span><span class='line'>    <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">disable_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>      <span class="l-Scalar-Plain">wait_interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9</span>
</span><span class='line'>      <span class="l-Scalar-Plain">max_wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">-1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">request_body</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">index</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;index-2017.10.*&#39;</span><span class="p-Indicator">]</span>
</span><span class='line'>        <span class="l-Scalar-Plain">dest</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">index</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">new-index-2017.10</span>
</span><span class='line'>    <span class="l-Scalar-Plain">filters</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">filtertype</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">none</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Elasticsearch Index:</h2>

<p>Create the Index where we will reindex the data to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPUT http://es.endpoint.com/new-index-2017.10 -d <span class="s1">&#39;{&quot;settings&quot;: {&quot;number_of_shards&quot;: 5, &quot;number_of_replicas&quot;: 1}}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Run the Curator:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curator --config curator.yml action-reindex.yml
</span><span class='line'>
</span><span class='line'>2017-11-22 14:18:15,138 INFO      Task <span class="s2">&quot;reindex from [index-2017.10.*] to [index-2017.10]&quot;</span> with task_id <span class="s2">&quot;Za-sn0z3Q9-75xCMRwJ3-A:15782886&quot;</span> has been running <span class="k">for</span> 928.948195354 seconds
</span><span class='line'>2017-11-22 14:18:24,152 INFO      GET https://es.endpoint.com:443/_tasks/Za-sn0z3Q9-75xCMRwJ3-A%3A15782886 <span class="o">[</span>status:200 request:0.005s<span class="o">]</span>
</span><span class='line'>2017-11-22 14:18:24,153 INFO      Task <span class="s2">&quot;reindex from [index-2017.10.*] to [new-index-2017.10]&quot;</span> with task_id <span class="s2">&quot;Za-sn0z3Q9-75xCMRwJ3-A:15782886&quot;</span> has been running <span class="k">for</span> 937.962740393 seconds
</span><span class='line'>2017-11-22 14:22:23,171 INFO      Action ID: 1, <span class="s2">&quot;reindex&quot;</span> completed.
</span><span class='line'>2017-11-22 14:22:23,171 INFO      Job completed.
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html">https://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html</a></li>
<li><a href="https://qbox.io/blog/logstash-elasticsearch-curator-data-retention">https://qbox.io/blog/logstash-elasticsearch-curator-data-retention</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/22/using-elasticdump-to-backup-elasticsearch-indexes-to-json/">Using Elasticdump to Backup Elasticsearch Indexes to JSON</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-22T08:35:28-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>8:35 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We will use Elasticdump to dump data from Elasticsearch to json files on disk, then delete the index, then restore data back to elasticsearch</p>

<h2>Install Elasticdump:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker run -it node:alpine sh
</span><span class='line'><span class="nv">$ </span>npm install elasticdump -g
</span></code></pre></td></tr></table></div></figure>


<h2>Create a Index:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPUT http://10.79.2.193:9200/test-index
</span><span class='line'><span class="o">{</span><span class="s2">&quot;acknowledged&quot;</span>:true<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ingest Some Data into the Index:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XPUT http://10.79.2.193:9200/test-index/docs/doc1 -d <span class="s1">&#39;{&quot;name&quot;: &quot;ruan&quot;, &quot;age&quot;: 30}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;_index&quot;</span>:<span class="s2">&quot;test-index&quot;</span>,<span class="s2">&quot;_type&quot;</span>:<span class="s2">&quot;docs&quot;</span>,<span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;doc1&quot;</span>,<span class="s2">&quot;_version&quot;</span>:1,<span class="s2">&quot;_shards&quot;</span>:<span class="o">{</span><span class="s2">&quot;total&quot;</span>:2,<span class="s2">&quot;successful&quot;</span>:1,<span class="s2">&quot;failed&quot;</span>:0<span class="o">}</span>,<span class="s2">&quot;created&quot;</span>:true<span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>curl -XPUT http://10.79.2.193:9200/test-index/docs/doc2 -d <span class="s1">&#39;{&quot;name&quot;: &quot;stefan&quot;, &quot;age&quot;: 29}&#39;</span>
</span><span class='line'><span class="o">{</span><span class="s2">&quot;_index&quot;</span>:<span class="s2">&quot;test-index&quot;</span>,<span class="s2">&quot;_type&quot;</span>:<span class="s2">&quot;docs&quot;</span>,<span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;doc2&quot;</span>,<span class="s2">&quot;_version&quot;</span>:1,<span class="s2">&quot;_shards&quot;</span>:<span class="o">{</span><span class="s2">&quot;total&quot;</span>:2,<span class="s2">&quot;successful&quot;</span>:1,<span class="s2">&quot;failed&quot;</span>:0<span class="o">}</span>,<span class="s2">&quot;created&quot;</span>:true<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Elasticdump to dump the ata</h2>

<p>First dump the mappings:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>elasticdump --input<span class="o">=</span>http://10.79.2.193:9200/test-index --output<span class="o">=</span>/opt/backup/elasticsearch/es_test-index_mapping.json --type<span class="o">=</span>mapping
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:34 GMT <span class="p">|</span> starting dump
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:34 GMT <span class="p">|</span> got <span class="m">1</span> objects from <span class="nb">source </span>elasticsearch <span class="o">(</span>offset: 0<span class="o">)</span>
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:34 GMT <span class="p">|</span> sent <span class="m">1</span> objects to destination file, wrote 1
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:34 GMT <span class="p">|</span> got <span class="m">0</span> objects from <span class="nb">source </span>elasticsearch <span class="o">(</span>offset: 1<span class="o">)</span>
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:34 GMT <span class="p">|</span> Total Writes: 1
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:34 GMT <span class="p">|</span> dump <span class="nb">complete</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then dump the data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>elasticdump --input<span class="o">=</span>http://10.79.2.193:9200/test-index --output<span class="o">=</span>/opt/backup/elasticsearch/es_test-index.json --type<span class="o">=</span>data
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:43 GMT <span class="p">|</span> starting dump
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:43 GMT <span class="p">|</span> got <span class="m">2</span> objects from <span class="nb">source </span>elasticsearch <span class="o">(</span>offset: 0<span class="o">)</span>
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:43 GMT <span class="p">|</span> sent <span class="m">2</span> objects to destination file, wrote 2
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:43 GMT <span class="p">|</span> got <span class="m">0</span> objects from <span class="nb">source </span>elasticsearch <span class="o">(</span>offset: 2<span class="o">)</span>
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:43 GMT <span class="p">|</span> Total Writes: 2
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:15:43 GMT <span class="p">|</span> dump <span class="nb">complete</span>
</span></code></pre></td></tr></table></div></figure>


<p>Preview the Metadata</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /opt/backup/elasticsearch/es_test-index_mapping.json <span class="p">|</span> python -m json.tool
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;test-index&quot;</span>: <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;mappings&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;docs&quot;</span>: <span class="o">{</span>
</span><span class='line'>                <span class="s2">&quot;properties&quot;</span>: <span class="o">{</span>
</span><span class='line'>                    <span class="s2">&quot;age&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;long&quot;</span>
</span><span class='line'>                    <span class="o">}</span>,
</span><span class='line'>                    <span class="s2">&quot;name&quot;</span>: <span class="o">{</span>
</span><span class='line'>                        <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;string&quot;</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Preview the Data</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /opt/backup/elasticsearch/es_test-index.json <span class="p">|</span> jq
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;_index&quot;</span>: <span class="s2">&quot;test-index&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;_type&quot;</span>: <span class="s2">&quot;docs&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;_id&quot;</span>: <span class="s2">&quot;doc1&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;_score&quot;</span>: 1,
</span><span class='line'>  <span class="s2">&quot;_source&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;ruan&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;age&quot;</span>: 30
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;_index&quot;</span>: <span class="s2">&quot;test-index&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;_type&quot;</span>: <span class="s2">&quot;docs&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;_id&quot;</span>: <span class="s2">&quot;doc2&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;_score&quot;</span>: 1,
</span><span class='line'>  <span class="s2">&quot;_source&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;stefan&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;age&quot;</span>: 29
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Restore The Data</h2>

<p>Let&rsquo;s test the restoring part, go ahead and delete The index:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -XDELETE http://10.79.2.193:9200/test-index
</span><span class='line'><span class="o">{</span><span class="s2">&quot;acknowledged&quot;</span>:true<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Restore the Index by Importing the Mapping:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>elasticdump --input<span class="o">=</span>/opt/backup/elasticsearch/es_test-index_mapping.json --output<span class="o">=</span>http://10.79.2.193:9200/test-index --type<span class="o">=</span>mapping
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:51:48 GMT <span class="p">|</span> starting dump
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:51:48 GMT <span class="p">|</span> got <span class="m">1</span> objects from <span class="nb">source </span>file <span class="o">(</span>offset: 0<span class="o">)</span>
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:51:48 GMT <span class="p">|</span> sent <span class="m">1</span> objects to destination elasticsearch, wrote 1
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:51:48 GMT <span class="p">|</span> got <span class="m">0</span> objects from <span class="nb">source </span>file <span class="o">(</span>offset: 1<span class="o">)</span>
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:51:48 GMT <span class="p">|</span> Total Writes: 1
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:51:48 GMT <span class="p">|</span> dump <span class="nb">complete</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify to see if the Index Exist:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -XGET http://10.79.2.193:9200/_cat/indices?v <span class="p">|</span> grep -E <span class="s1">&#39;(docs.count|test)&#39;</span>
</span><span class='line'>health status index                     pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>yellow open   <span class="nb">test</span>-index                  <span class="m">5</span>   <span class="m">1</span>          <span class="m">0</span>            <span class="m">0</span>       650b           650b
</span></code></pre></td></tr></table></div></figure>


<h2>Restore the Data for the Index:</h2>

<p>Use elasticdump to restore the data from json to elasticsearch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>elasticdump --input<span class="o">=</span>/opt/backup/elasticsearch/es_test-index.json --output<span class="o">=</span>http://10.79.2.193:9200/test-index --type<span class="o">=</span>data
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:53:56 GMT <span class="p">|</span> starting dump
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:53:56 GMT <span class="p">|</span> got <span class="m">2</span> objects from <span class="nb">source </span>file <span class="o">(</span>offset: 0<span class="o">)</span>
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:53:56 GMT <span class="p">|</span> sent <span class="m">2</span> objects to destination elasticsearch, wrote 2
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:53:56 GMT <span class="p">|</span> got <span class="m">0</span> objects from <span class="nb">source </span>file <span class="o">(</span>offset: 2<span class="o">)</span>
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:53:56 GMT <span class="p">|</span> Total Writes: 2
</span><span class='line'>Mon, <span class="m">26</span> Jun <span class="m">2017</span> 14:53:56 GMT <span class="p">|</span> dump <span class="nb">complete</span>
</span></code></pre></td></tr></table></div></figure>


<p>Verify to see if the Documents was Ingested:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -XGET http://10.79.2.193:9200/_cat/indices?v <span class="p">|</span> grep -E <span class="s1">&#39;(docs.count|test)&#39;</span>
</span><span class='line'>health status index                     pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>yellow open   <span class="nb">test</span>-index                  <span class="m">5</span>   <span class="m">1</span>          <span class="m">2</span>            <span class="m">0</span>       650b           650b
</span></code></pre></td></tr></table></div></figure>


<p>Preview the Data from Elasticsearch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -XGET http://10.79.2.193:9200/test-index/_search?pretty
</span><span class='line'>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;took&quot;</span> : 3,
</span><span class='line'>  <span class="s2">&quot;timed_out&quot;</span> : <span class="nb">false</span>,
</span><span class='line'>  <span class="s2">&quot;_shards&quot;</span> : <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;total&quot;</span> : 5,
</span><span class='line'>    <span class="s2">&quot;successful&quot;</span> : 5,
</span><span class='line'>    <span class="s2">&quot;failed&quot;</span> : 0
</span><span class='line'>  <span class="o">}</span>,
</span><span class='line'>  <span class="s2">&quot;hits&quot;</span> : <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;total&quot;</span> : 2,
</span><span class='line'>    <span class="s2">&quot;max_score&quot;</span> : 1.0,
</span><span class='line'>    <span class="s2">&quot;hits&quot;</span> : <span class="o">[</span> <span class="o">{</span>
</span><span class='line'>      <span class="s2">&quot;_index&quot;</span> : <span class="s2">&quot;test-index&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;_type&quot;</span> : <span class="s2">&quot;docs&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;doc1&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;_score&quot;</span> : 1.0,
</span><span class='line'>      <span class="s2">&quot;_source&quot;</span> : <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;ruan&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;age&quot;</span> : 30
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>, <span class="o">{</span>
</span><span class='line'>      <span class="s2">&quot;_index&quot;</span> : <span class="s2">&quot;test-index&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;_type&quot;</span> : <span class="s2">&quot;docs&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;_id&quot;</span> : <span class="s2">&quot;doc2&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;_score&quot;</span> : 1.0,
</span><span class='line'>      <span class="s2">&quot;_source&quot;</span> : <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;name&quot;</span> : <span class="s2">&quot;stefan&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;age&quot;</span> : 29
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://www.npmjs.com/package/elasticdump">https://www.npmjs.com/package/elasticdump</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/14/routing-web-traffic-with-a-socks-tunnel/">Routing Web Traffic With a SOCKS Tunnel</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-14T10:17:07-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>14</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>10:17 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I wanted to access a Non Standard HTTP Port on one of my RaspberryPi Hosts, which was not directly available to the Internet, so I have chosen to establish a SOCKS Tunnel to achieve that.</p>

<h2>Web Application on my LAN</h2>

<p>Getting my RaspberryPi&rsquo;s Private IP Address:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ifconfig eth0 <span class="p">|</span> grep <span class="s1">&#39;inet 192&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span>
</span><span class='line'>192.168.1.118
</span></code></pre></td></tr></table></div></figure>


<p>For demonstration purposes, I will use Python&rsquo;s SimpleHTTPServer:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir web
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>web
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;yeehaa&#39;</span> &gt; index.html
</span><span class='line'><span class="nv">$ </span>python -m SimpleHTTPServer 5050
</span><span class='line'>Serving HTTP on 0.0.0.0 port <span class="m">5050</span> ...
</span></code></pre></td></tr></table></div></figure>


<h2>Establish the SOCKS Tunnel</h2>

<p>From my laptop, establishing the SOCKS Tunnel with SSH, you can use <code>-f</code> to fork it in the background:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh -D <span class="m">8157</span> -CqN user@home.domain.com
</span></code></pre></td></tr></table></div></figure>


<h2>Configure your Browser:</h2>

<p>Configure your browser to Proxy via:</p>

<ul>
<li>Host: localhost</li>
<li>Port: 8157</li>
</ul>


<p>Now when you access the destined host&rsquo;s private ip, you will get a response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Browse to http://192.168.1.118:5050/ and in my <span class="k">case</span> my response is:
</span><span class='line'>-&gt; yeehaa
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/13/local-dev-environment-with-docker-mysql-and-adminer-webui-with-docker-compose/">Local Dev Environment With Docker MySQL and Adminer WebUI With Docker Compose</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-13T16:15:34-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>4:15 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let&rsquo;s setup a local development environment with Docker, MySQL and Adminer WebUI using Docker Compose</p>

<h2>Docker Compose File:</h2>

<p>Let&rsquo;s look at our docker-compose file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.2&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">mysql-client</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine:edge</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bind</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./workspace</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/root/workspace</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docknet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ping 127.0.0.1</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">db</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">example</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docknet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">volume</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dbdata</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/lib/mysql</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">adminer</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">adminer</span>
</span><span class='line'>    <span class="l-Scalar-Plain">restart</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">always</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:8080</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docknet</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">docknet</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">dbdata</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Pre-Requirements:</h2>

<p>Let&rsquo;s create our pre-requirement:</p>

<ol>
<li>Networks:</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create docknet
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Volumes:</li>
</ol>


<p>Our Volume for MySQL so that we have persistent data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker volume create dbdata
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>workspace</code> directory that will be persistent in our <code>debug-client</code> alpine container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p workspace/python
</span></code></pre></td></tr></table></div></figure>


<h2>Launching our Services:</h2>

<p>Let&rsquo;s launch our services:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-compose -f mysql-compose.yml up -d
</span><span class='line'>Creating mysql_db_1 ...
</span><span class='line'>Creating mysql_adminer_1
</span><span class='line'>Creating mysql_debug-client_1
</span></code></pre></td></tr></table></div></figure>


<p>Listing our Containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker ps
</span><span class='line'>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                      NAMES
</span><span class='line'>e05804ab6d64        alpine:edge         <span class="s2">&quot;ping 127.0.0.1&quot;</span>         <span class="m">21</span> seconds ago      Up <span class="m">4</span> seconds                                   mysql_debug-client_1
</span><span class='line'>c052ceeb6d3b        mysql               <span class="s2">&quot;docker-entrypoint...&quot;</span>   <span class="m">21</span> seconds ago      Up <span class="m">5</span> seconds        3306/tcp                   mysql_db_1
</span><span class='line'>2b0446daab4c        adminer             <span class="s2">&quot;entrypoint.sh doc...&quot;</span>   <span class="m">26</span> seconds ago      Up <span class="m">5</span> seconds        0.0.0.0:8080-&gt;8080/tcp     mysql_adminer_1
</span></code></pre></td></tr></table></div></figure>


<h2>Using the Debug Container:</h2>

<p>I will use the debug container as the client to connect to the internal services, for example, the mysql-client:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apk update
</span><span class='line'><span class="nv">$ </span>apk add mysql-client
</span><span class='line'><span class="nv">$ </span>mysql -h db -u root -ppassword
</span><span class='line'>MySQL <span class="o">[(</span>none<span class="o">)]</span>&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Also, you will find the persistent data directory for our workspace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls /root/workspace/
</span><span class='line'>python
</span></code></pre></td></tr></table></div></figure>


<h2>Accessing the MySQL WebUI: Adminer</h2>

<p>Access the service via the exposed endpoint:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>+ http://localhost:8080/
</span></code></pre></td></tr></table></div></figure>


<p>The login view:</p>

<p><img src="https://i.snag.gy/m8dUxe.jpg" alt="" /></p>

<p>Creating the Table:</p>

<p><img src="https://i.snag.gy/tPVbg6.jpg" alt="" /></p>

<h2>Deleting the Environment:</h2>

<p>The External Resources will not be deleted:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-compose -f mysql-compose.yml down
</span><span class='line'>Removing mysql_debug-client_1 ... <span class="k">done</span>
</span><span class='line'>Removing mysql_db_1           ... <span class="k">done</span>
</span><span class='line'>Removing mysql_adminer_1      ... <span class="k">done</span>
</span><span class='line'>Network docknet is external, skipping
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/07/setup-a-concourse-ci-server-on-ubuntu-16/">Setup a Concourse-CI Server on Ubuntu 16</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-07T17:55:46-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>5:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495" alt="" /></p>

<p>Concourse is a Pipeline Based Continious Integration system written in Go</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://concourse.ci/">https://concourse.ci/</a></li>
<li><a href="https://github.com/concourse/concourse">https://github.com/concourse/concourse</a></li>
<li><a href="https://concourse.ci/hello-world.html">https://concourse.ci/hello-world.html</a></li>
<li><a href="https://github.com/starkandwayne/concourse-tutorial">https://github.com/starkandwayne/concourse-tutorial</a></li>
</ul>


<h2>What is Concourse CI:</h2>

<p>Concourse CI is a Continious Integration Platform. Concourse enables you to construct pipelines with a yaml configuration that can consist out of 3 core concepts, tasks, resources, and jobs that compose them. For more information about this have a look at their <a href="https://concourse.ci/concepts.html">docs</a></p>

<h2>What will we be doing today</h2>

<p>We will setup a Concourse Server on Ubuntu 16.04 and run the traditional <code>Hello, World</code> pipeline</p>

<h2>Setup the Server:</h2>

<p>Concourse needs <code>PostgresSQL 9.3+</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install postgresql postgresql-contrib -y
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>postgresql
</span></code></pre></td></tr></table></div></figure>


<p>Create the Database and User for Concourse on Postgres:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo -u postgres createuser concourse
</span><span class='line'><span class="nv">$ </span>sudo -u postgres createdb --owner<span class="o">=</span>concourse atc
</span></code></pre></td></tr></table></div></figure>


<p>Download the Concourse and Fly Cli Binaries:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v3.6.0/concourse_linux_amd64
</span><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v3.6.0/fly_linux_amd64
</span><span class='line'><span class="nv">$ </span>chmod +x concourse_linux_amd64 fly_linux_amd64
</span><span class='line'><span class="nv">$ </span>mv concourse_linux_amd64 /usr/bin/concourse
</span><span class='line'><span class="nv">$ </span>mv fly_linux_amd64 /usr/bin/fly
</span></code></pre></td></tr></table></div></figure>


<p>Create the Encryption Keys:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /etc/concourse
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/tsa_host_key
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/worker_key
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t rsa -q -N <span class="s1">&#39;&#39;</span> -f /etc/concourse/session_signing_key
</span><span class='line'><span class="nv">$ </span>cp /etc/concourse/worker_key.pub /etc/concourse/authorized_worker_keys
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Web Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/concourse/web_environment
</span><span class='line'>
</span><span class='line'><span class="nv">CONCOURSE_SESSION_SIGNING_KEY</span><span class="o">=</span>/etc/concourse/session_signing_key
</span><span class='line'><span class="nv">CONCOURSE_TSA_HOST_KEY</span><span class="o">=</span>/etc/concourse/tsa_host_key
</span><span class='line'><span class="nv">CONCOURSE_TSA_AUTHORIZED_KEYS</span><span class="o">=</span>/etc/concourse/authorized_worker_keys
</span><span class='line'><span class="nv">CONCOURSE_POSTGRES_SOCKET</span><span class="o">=</span>/var/run/postgresql
</span><span class='line'>
</span><span class='line'><span class="nv">CONCOURSE_BASIC_AUTH_USERNAME</span><span class="o">=</span>admin
</span><span class='line'><span class="nv">CONCOURSE_BASIC_AUTH_PASSWORD</span><span class="o">=</span>secret
</span><span class='line'><span class="nv">CONCOURSE_EXTERNAL_URL</span><span class="o">=</span>http://10.20.30.40:8080
</span></code></pre></td></tr></table></div></figure>


<p>Concourse Worker Process Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/concourse/worker_environment
</span><span class='line'>
</span><span class='line'><span class="nv">CONCOURSE_WORK_DIR</span><span class="o">=</span>/var/lib/concourse
</span><span class='line'><span class="nv">CONCOURSE_TSA_WORKER_PRIVATE_KEY</span><span class="o">=</span>/etc/concourse/worker_key
</span><span class='line'><span class="nv">CONCOURSE_TSA_PUBLIC_KEY</span><span class="o">=</span>/etc/concourse/tsa_host_key.pub
</span><span class='line'><span class="nv">CONCOURSE_TSA_HOST</span><span class="o">=</span>127.0.0.1
</span></code></pre></td></tr></table></div></figure>


<p>Create a Concourse user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo adduser --system --group concourse
</span><span class='line'><span class="nv">$ </span>sudo chown -R concourse:concourse /etc/concourse
</span><span class='line'><span class="nv">$ </span>sudo chmod <span class="m">600</span> /etc/concourse/*_environment
</span></code></pre></td></tr></table></div></figure>


<p>Create SystemD Unit Files, first for the Web Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/systemd/system/concourse-web.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Concourse CI web process <span class="o">(</span>ATC and TSA<span class="o">)</span>
</span><span class='line'><span class="nv">After</span><span class="o">=</span>postgresql.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">User</span><span class="o">=</span>concourse
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>on-failure
</span><span class='line'><span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/concourse/web_environment
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/concourse web
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></code></pre></td></tr></table></div></figure>


<p>Then the SystemD Unit File for the Worker Service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/systemd/system/concourse-worker.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Concourse CI worker process
</span><span class='line'><span class="nv">After</span><span class="o">=</span>concourse-web.service
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">User</span><span class="o">=</span>root
</span><span class='line'><span class="nv">Restart</span><span class="o">=</span>on-failure
</span><span class='line'><span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/concourse/worker_environment
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/concourse worker
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span></code></pre></td></tr></table></div></figure>


<p>Start and Enable the Services:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl start concourse-web concourse-worker
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>concourse-web concourse-worker
</span><span class='line'><span class="nv">$ </span>systemctl status concourse-web concourse-worker
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>systemctl is-active concourse-worker concourse-web
</span><span class='line'>active
</span><span class='line'>active
</span></code></pre></td></tr></table></div></figure>


<p>The listening ports should more or less look like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>netstat -tulpn
</span><span class='line'>
</span><span class='line'>Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7777          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:7788          0.0.0.0:*               LISTEN      4530/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:8079          0.0.0.0:*               LISTEN      4525/concourse
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      1283/sshd
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:5432          0.0.0.0:*               LISTEN      4047/postgres
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::36159                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::46829                :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::2222                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::8080                 :::*                    LISTEN      4525/concourse
</span><span class='line'>tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      1283/sshd
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:68              0.0.0.0:*                           918/dhclient
</span><span class='line'>udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:42165           0.0.0.0:*                           4530/concourse
</span></code></pre></td></tr></table></div></figure>


<h2>Client Side:</h2>

<p>I will be using a the Fly cli from a Mac, so first we need to download the fly-cli for Mac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget https://github.com/concourse/concourse/releases/download/v3.6.0/fly_darwin_amd64
</span><span class='line'><span class="nv">$ </span>chmod +x fly_darwin_amd64
</span><span class='line'><span class="nv">$ </span><span class="nb">alias </span><span class="nv">fly</span><span class="o">=</span><span class="s1">&#39;./fly_darwin_amd64&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need to setup our Concourse Target by Authenticating against our Concourse Endpoint, lets setup our target with the name <code>ci</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci login -c http://10.20.30.40:8080
</span><span class='line'>logging in to team <span class="s1">&#39;main&#39;</span>
</span><span class='line'>
</span><span class='line'>username: admin
</span><span class='line'>password:
</span><span class='line'>
</span><span class='line'>target saved
</span></code></pre></td></tr></table></div></figure>


<p>Lets list our targets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly targets
</span><span class='line'>name  url                        team  expiry
</span><span class='line'>ci    http://10.20.30.40:8080    main  Wed, <span class="m">08</span> Nov <span class="m">2017</span> 15:32:59 UTC
</span></code></pre></td></tr></table></div></figure>


<p>Listing Registered Workers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>ip-172-31-12-134  <span class="m">0</span>           linux     none  none  running  1.2
</span></code></pre></td></tr></table></div></figure>


<p>Listing Active Containers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job            build <span class="c">#  build id  type   name                  attempt</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hello World Pipeline:</h2>

<p>Let&rsquo;s create a basic pipeline, that will print out <code>Hello, World!</code>:</p>

<p>Our <code>hello-world.yml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-job</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">say-hello</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine</span>
</span><span class='line'>          <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">edge</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/bin/sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">-c</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Hello, World!&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;=============&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Applying the configuration to our pipeline:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci <span class="nb">set</span>-pipeline -p yeeehaa -c hello-world.yml
</span><span class='line'><span class="nb">jobs</span>:
</span><span class='line'>  job my-job has been added:
</span><span class='line'>    name: my-job
</span><span class='line'>    plan:
</span><span class='line'>    - task: say-hello
</span><span class='line'>      config:
</span><span class='line'>        platform: linux
</span><span class='line'>        image_resource:
</span><span class='line'>          <span class="nb">type</span>: docker-image
</span><span class='line'>          <span class="nb">source</span>:
</span><span class='line'>            repository: alpine
</span><span class='line'>            tag: edge
</span><span class='line'>        run:
</span><span class='line'>          path: /bin/sh
</span><span class='line'>          args:
</span><span class='line'>          - -c
</span><span class='line'>          - <span class="p">|</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'>            <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'>apply configuration? <span class="o">[</span>yN<span class="o">]</span>: y
</span><span class='line'>pipeline created!
</span><span class='line'>you can view your pipeline here: http://10.20.30.40:8080/teams/main/pipelines/yeeehaa
</span><span class='line'>
</span><span class='line'>the pipeline is currently paused. to unpause, either:
</span><span class='line'>  - run the unpause-pipeline <span class="nb">command</span>
</span><span class='line'>  - click play next to the pipeline in the web ui
</span></code></pre></td></tr></table></div></figure>


<p>We can browse to the WebUI to unpause the pipeline, but since I like to do everything on cli as far as possible, I will unpause the pipeline via cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci unpause-pipeline -p yeeehaa
</span><span class='line'>unpaused <span class="s1">&#39;yeeehaa&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now our Pipeline is unpaused, but since we did not specify any triggers, we need to manually trigger the pipeline to run, you can either via the WebUI, select your pipeline which in this case will be named <code>yeeehaa</code> and then select the job, which will be <code>my-job</code> then hit the <code>+</code> sign, which will trigger the pipeline.</p>

<p>I will be using the cli:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job
</span><span class='line'>started yeeehaa/my-job <span class="c">#1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Via the WebUI on <code>http://10.20.30.40:8080/teams/main/pipelines/yeeehaa/jobs/my-job/builds/1</code> you should see the <code>Hello, World!</code> output, or via the cli, we also have the option to see the output, so let&rsquo;s trigger it again, but this time passing the <code>--watch</code> flag:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job yeeehaa/my-job --watch
</span><span class='line'>started yeeehaa/my-job <span class="c">#2</span>
</span><span class='line'>
</span><span class='line'>initializing
</span><span class='line'>running /bin/sh -c <span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Hello, World!&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=============&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>Hello, World!
</span><span class='line'><span class="o">=============</span>
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>


<p>Listing our Workers and Containers again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci workers
</span><span class='line'>name              containers  platform  tags  team  state    version
</span><span class='line'>ip-172-31-12-134  <span class="m">2</span>           linux     none  none  running  1.2
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>fly -t ci containers
</span><span class='line'>handle                                worker            pipeline     job         build <span class="c">#  build id  type   name           attempt</span>
</span><span class='line'>36982955-54fd-4c1b-57b8-216486c58db8  ip-172-31-12-134  yeeehaa      my-job      <span class="m">2</span>        <span class="m">729</span>       task   say-hello      n/a
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/7">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/5">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/05/28/wildcard-ssl-certificate-with-letsencrypt-on-docker-swarm-using-traefik/">Wildcard SSL Certificate With Letsencrypt on Docker Swarm Using Traefik</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/27/web-forms-with-python-flask-and-the-wtforms-module-with-bootstrap/">Web Forms With Python Flask and the WTForms Module With Bootstrap</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/23/generate-random-characters-with-python-using-random-and-string-modules/">Generate Random Characters With Python Using Random and String Modules</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/09/manage-scaleway-instances-via-their-api-like-a-boss-with-their-command-line-tool-scw/">Manage Scaleway Instances via Their API Like a Boss With Their Command Line Tool Scw</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/05/09/temporary-iam-credentials-from-ec2-instance-metadata-using-python/">Temporary IAM Credentials From EC2 Instance Metadata Using Python</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
