
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In one of my earlier posts on GlusterFS, we went through the steps on how to setup a Distributed Storage Volume, where the end result was to have &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="http://blog.ruanbekker.com/posts/6/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.ruan.dev/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/05/setup-a-3-node-replicated-storage-volume-with-glusterfs/">Setup a 3 Node Replicated Storage Volume With GlusterFS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-05T21:01:37+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>9:01 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://access.redhat.com/documentation/en-US/Red_Hat_Storage/2.1/html/Administration_Guide/images/Replicated_Volume.png" alt="" /></p>

<p>In one of my earlier posts on <a href="https://sysadmins.co.za/tag/glusterfs">GlusterFS</a>, we went through the steps on how to setup a <a href="https://sysadmins.co.za/setup-a-distributed-storage-volume-with-glusterfs/">Distributed Storage Volume</a>, where the end result was to have scalable storage, where size was the requirement.</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>


<p><p></p>

<h2>What will we be doing today with GlusterFS?</h2>

<p>Today, we will be going through the steps on how to setup a Replicated Storage Volume with GlusterFS, where we will have 3 GlusterFS Nodes, and using the replication factor of 3.</p>

<p><strong>Replication Factor of 3:</strong></p>

<p>In other words, having 3 copies of our data and in our case, since we will have 3 nodes in our cluster, a copy of our data will reside on each node.</p>

<p><strong>What about Split-Brain:</strong></p>

<p>In Clustering, we get the term Split-Brain, where a node dies or leaves the cluster, the cluster reforms itself with the available nodes and then during this reformation, instead of the remaining nodes staying with the same cluster, 2 subset of cluster are created, and they are not aware of each other, which causes data corruption, here&rsquo;s a great resource on <a href="http://techthoughts.typepad.com/managing_computers/2007/10/split-brain-quo.html">Split-Brain</a></p>

<p>To prevent Split-Brain in GlusterFS, we can setup a <a href="https://gluster.readthedocs.io/en/latest/Administrator%20Guide/arbiter-volumes-and-quorum/">Arbiter Volume</a>. In a Replica Count of 3 and Arbiter count of 1: 2 Nodes will hold the replicated data, and the 1 Node which will be the Arbiter node, will only host the file/directory names and metadata but not any data. I will write up an <a href="">article</a> on this in the future.</p>

<h2>Getting Started:</h2>

<p>Let&rsquo;s get started on setting up a 3 Node Replicated GlusterFS. Each node will have an additional drive that is 50GB in size, which will be part of our GlusterFS Replicated Volume. I will also be using Ubuntu 16.04 as my linux distro.</p>

<p><strong>Preparing DNS Resolution:</strong></p>

<p>I will install GlusterFS on each node, and in my setup I have the following DNS entries:</p>

<ul>
<li>gfs01 (10.0.0.2)</li>
<li>gfs02 (10.0.0.3)</li>
<li>gfs03 (10.0.0.4)</li>
</ul>


<p><strong>Preparing our Secondary Drives:</strong></p>

<p>I will be formatting my drives with <code>XFS</code>. Listing our block volumes:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsblk
</span><span class='line'>NAME MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span><span class='line'>vdb  253:16   <span class="m">0</span> 46.6G  <span class="m">0</span> disk
</span><span class='line'>vda  253:0    <span class="m">0</span> 18.6G  <span class="m">0</span> disk /
</span></code></pre></td></tr></table></div></figure></p>

<p>Creating the FileSystem with XFS, which we will be running on each node:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkfs.xfs /dev/vdb
</span></code></pre></td></tr></table></div></figure></p>

<p>Then creating the directories where our bricks will reside, and also add an entry to our <code>/etc/fstab</code> so that our disk gets mounted when the operating system boots:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># node: gfs01</span>
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/1 -p
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/dev/vdb /gluster/bricks/1 xfs defaults 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/1/brick
</span><span class='line'>
</span><span class='line'><span class="c"># node: gfs02</span>
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/2 -p
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/dev/vdb /gluster/bricks/2 xfs defaults 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/2/brick
</span><span class='line'>
</span><span class='line'><span class="c"># node: gfs03</span>
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/3 -p
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/dev/vdb /gluster/bricks/3 xfs defaults 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span><span class='line'><span class="nv">$ </span>mkdir /gluster/bricks/3/brick
</span></code></pre></td></tr></table></div></figure></p>

<p>After this has been done, we should see that the disks are mounted, for example on node: <code>gfs01</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/vda         18G  909M   17G   3% /
</span><span class='line'>/dev/vdb         47G   80M   47G   1% /gluster/bricks/1
</span></code></pre></td></tr></table></div></figure></p>

<h2>Installing GlusterFS on Each Node:</h2>

<p>Installing GlusterFS, repeat this on all 3 Nodes:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install xfsprogs attr glusterfs-server glusterfs-common glusterfs-client -y
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>glusterfs-server
</span></code></pre></td></tr></table></div></figure></p>

<p>In order to add the nodes to the trusted storage pool, we will have to add them by using <code>gluster peer probe</code>. Make sure that you can resolve the hostnames to the designated IP Addresses, and that traffic is allowed.</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster peer probe gfs01
</span><span class='line'><span class="nv">$ </span>gluster peer probe gfs02
</span><span class='line'><span class="nv">$ </span>gluster peer probe gfs03
</span></code></pre></td></tr></table></div></figure></p>

<p>Now that we have added our nodes to our trusted storage pool, lets verify that by listing our pool:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster pool list
</span><span class='line'>UUID                                    Hostname                State
</span><span class='line'>f63d0e77-9602-4024-8945-5a7f7332bf89    gfs02                   Connected
</span><span class='line'>2d4ac6c1-0611-4e2e-b4af-9e4aa8c1556d    gfs03                   Connected
</span><span class='line'>6a604cd9-9a9c-406d-b1b7-69caf166a20e    localhost               Connected
</span></code></pre></td></tr></table></div></figure></p>

<p>Great! All looks good.</p>

<h2>Create the Replicated GlusterFS Volume:</h2>

<p>Let&rsquo;s create our Replicated GlusterFS Volume, named <code>gfs</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume create gfs <span class="se">\</span>
</span><span class='line'>  replica <span class="m">3</span> <span class="se">\</span>
</span><span class='line'>  gfs01:/gluster/bricks/1/brick <span class="se">\</span>
</span><span class='line'>  gfs02:/gluster/bricks/2/brick <span class="se">\</span>
</span><span class='line'>  gfs03:/gluster/bricks/2/brick
</span><span class='line'>
</span><span class='line'>volume create: gfs: success: please start the volume to access data
</span></code></pre></td></tr></table></div></figure></p>

<p>Now that our volume is created, lets list it to verify that it is created:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume list
</span><span class='line'>gfs
</span></code></pre></td></tr></table></div></figure></p>

<p>Now, start the volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume start gfs
</span><span class='line'>volume start: gfs: success
</span></code></pre></td></tr></table></div></figure></p>

<p>View the status of our volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume status gfs
</span><span class='line'>Status of volume: gfs
</span><span class='line'>Gluster process                             TCP Port  RDMA Port  Online  Pid
</span><span class='line'>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
</span><span class='line'>Brick gfs01:/gluster/bricks/1/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       6450
</span><span class='line'>Brick gfs02:/gluster/bricks/2/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       3460
</span><span class='line'>Brick gfs03:/gluster/bricks/3/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       3309
</span></code></pre></td></tr></table></div></figure></p>

<p>Next, view the volume inforation:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume info gfs
</span><span class='line'>
</span><span class='line'>Volume Name: gfs
</span><span class='line'>Type: Replicate
</span><span class='line'>Volume ID: 6f827df4-6df5-4c25-99ee-8d1a055d30f0
</span><span class='line'>Status: Started
</span><span class='line'>Number of Bricks: <span class="m">1</span> x <span class="nv">3</span> <span class="o">=</span> 3
</span><span class='line'>Transport-type: tcp
</span><span class='line'>Bricks:
</span><span class='line'>Brick1: gfs01:/gluster/bricks/1/brick
</span><span class='line'>Brick2: gfs02:/gluster/bricks/2/brick
</span><span class='line'>Brick3: gfs03:/gluster/bricks/3/brick
</span></code></pre></td></tr></table></div></figure></p>

<h2>Security:</h2>

<p>From a GlusterFS level, it will allow clients to connect by default. To authorize these 3 nodes to connect to the GlusterFS Volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume <span class="nb">set </span>gfs auth.allow 10.0.0.2,10.0.0.3,10.0.0.4
</span></code></pre></td></tr></table></div></figure></p>

<p>Then if you would like to remove this rule:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume <span class="nb">set </span>gfs auth.allow *
</span></code></pre></td></tr></table></div></figure></p>

<h2>Mount the GlusterFS Volume to the Host:</h2>

<p>Mount the GlusterFS Volume to each node, so we will have to mount it to each node, and also append it to our <code>/etc/fstab</code> file so that it mounts on boot:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;localhost:/gfs /mnt glusterfs defaults,_netdev,backupvolfile-server=localhost 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount.glusterfs localhost:/gfs /mnt
</span></code></pre></td></tr></table></div></figure></p>

<p><strong>Verify the Mounted Volume:</strong></p>

<p>Check the mounted disks, and you will find that the Replicated GlusterFS Volume is mounted on our <code>/mnt</code> partition.</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/vda         18G  909M   17G   3% /
</span><span class='line'>/dev/vdb         47G   80M   47G   1% /gluster/bricks/1
</span><span class='line'>localhost:/gfs   47G   80M   47G   1% /mnt
</span></code></pre></td></tr></table></div></figure></p>

<p>You will note that GlusterFS Volume has a total size of 47GB usable space, which is the same size as one of our disks, but that is because we have a replicated volume with a replication factor of 3:  <code>(47 * 3 / 3)</code></p>

<p>Now we have a Storage Volume which has 3 Replicas, one copy on each node, which allows us Data Durability on our Storage.</p>

<p><p></p>

<p><center><script type='text/javascript' src='https://ko-fi.com/widgets/widget_2.js'></script><script type='text/javascript'>kofiwidget2.init(&lsquo;Buy Me a Coffee&rsquo;, &lsquo;#46b798&rsquo;, &lsquo;A6423ZIQ&rsquo;);kofiwidget2.draw();</script></center></p>

<p><p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/05/container-persistent-storage-for-docker-swarm-using-a-glusterfs-volume-plugin/">Container Persistent Storage for Docker Swarm Using a GlusterFS Volume Plugin</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-05T20:18:30+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>8:18 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg" alt="" /></p>

<p>From one of my previous posts I demonstrated how to provide persistent storage for your containers by using a <a href="https://blog.ruanbekker.com/blog/2018/02/16/guide-to-setup-docker-convoy-volume-driver-for-docker-swarm-with-nfs/">Convoy NFS Plugin</a>.</p>

<p>I&rsquo;ve stumbled upon one AWESOME GlusterFS Volume Plugin for Docker by <a href="https://github.com/trajano/docker-volume-plugins/tree/master/glusterfs-volume-plugin">@trajano</a>, please have a look at his repository. I&rsquo;ve been waiting for some time for one solid glusterfs volume plugin, and it works great.</p>

<h2>What we will be doing today</h2>

<p>We will setup a 3 node replicated glusterfs volume and show how easy it is to install the volume plugin and then demonstrate how storage from our swarms containers are persisted.</p>

<p>Our servers that we will be using will have the private ip&rsquo;s as shown below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>10.22.125.101
</span><span class='line'>10.22.125.102
</span><span class='line'>10.22.125.103</span></code></pre></td></tr></table></div></figure>


<h2>Setup GlusterFS</h2>

<p>Have a look at <a href="https://blog.ruanbekker.com/blog/2019/03/05/setup-a-3-node-replicated-storage-volume-with-glusterfs/?referral=github.com">this</a> post to setup the glusterfs volume.</p>

<h2>Install the GlusterFS Volume Plugin</h2>

<p>Below I&rsquo;m installing the plugin and setting the alias name as <code>glusterfs</code>, granting all permissions and keeping the plugin in a disabled state.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker plugin install --alias glusterfs trajano/glusterfs-volume-plugin --grant-all-permissions --disable
</span></code></pre></td></tr></table></div></figure>


<p>Set the glusterfs servers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker plugin <span class="nb">set </span>glusterfs <span class="nv">SERVERS</span><span class="o">=</span>10.22.125.101,10.22.125.102,10.22.125.103
</span></code></pre></td></tr></table></div></figure>


<p>Enable the glusterfs plugin:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker plugin <span class="nb">enable </span>glusterfs
</span></code></pre></td></tr></table></div></figure>


<h2>Create a Service in Docker Swarm</h2>

<p>Deploy a sample service on docker swarm with a volume backed by glusterfs. Note that my glusterfs volume is called <code>gfs</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.4&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">foo</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ping localhost</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">net</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">vol1:/tmp</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">net</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">overlay</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vol1</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">glusterfs</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;gfs/vol1&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml <span class="nb">test</span>
</span><span class='line'>Creating service test_foo
</span></code></pre></td></tr></table></div></figure>


<p>Have a look on which node is your container running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ps test_foo
</span><span class='line'>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
</span><span class='line'>jfwzb7yxnrxx        test_foo.1          alpine:latest       swarm-worker-1      Running             Running <span class="m">37</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>Now jump to the <code>swarm-worker-1</code> node and verify that the container is running on that node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker ps
</span><span class='line'>CONTAINER ID        IMAGE                                          COMMAND                  CREATED             STATUS                  PORTS               NAMES
</span><span class='line'>d469f341d836        alpine:latest                                  <span class="s2">&quot;ping localhost&quot;</span>           <span class="m">59</span> seconds ago      Up <span class="m">57</span> seconds                               test_foo.1.jfwzb7yxnrxxnd0qxtcjex8lu
</span></code></pre></td></tr></table></div></figure>


<p>Now since the container is running on this node, we will also see that the volume defined in our task configuration will also be present:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker volume ls
</span><span class='line'>DRIVER                       VOLUME NAME
</span><span class='line'>glusterfs:latest             gfs/vol1
</span></code></pre></td></tr></table></div></figure>


<p>Exec into the container and look at the disk layout:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it d469f341d836 sh
</span><span class='line'>/ <span class="c"># df -h</span>
</span><span class='line'>Filesystem                Size      Used Available Use% Mounted on
</span><span class='line'>overlay                  45.6G      3.2G     40.0G   7% /
</span><span class='line'>10.22.125.101:gfs/vol1   45.6G      3.3G     40.0G   8% /tmp
</span></code></pre></td></tr></table></div></figure>


<p>While you are in the container, write the hostname&rsquo;s value into a file which is mapped to the glusterfs volume:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$HOSTNAME</span> &gt; /tmp/data.txt
</span><span class='line'><span class="nv">$ </span>cat /tmp/data.txt
</span><span class='line'>d469f341d836
</span></code></pre></td></tr></table></div></figure>


<h2>Testing Data Persistence</h2>

<p>Time to test the data persistence. Scale the service to 3 replicas, then hop onto a new node where a replica resides and check if the data was persisted.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service scale <span class="nv">test_foo</span><span class="o">=</span>3
</span><span class='line'>test_foo scaled to 3
</span><span class='line'>overall progress: <span class="m">3</span> out of <span class="m">3</span> tasks
</span><span class='line'>1/3: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
</span><span class='line'>2/3: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
</span><span class='line'>3/3: running   <span class="o">[==================================================</span>&gt;<span class="o">]</span>
</span><span class='line'>verify: Service converged
</span></code></pre></td></tr></table></div></figure>


<p>Check where the containers are running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ps test_foo
</span><span class='line'>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
</span><span class='line'>jfwzb7yxnrxx        test_foo.1          alpine:latest       swarm-worker-1      Running             Running <span class="m">2</span> minutes ago
</span><span class='line'>mdsg6c5b2nqb        test_foo.2          alpine:latest       swarm-worker-3      Running             Running <span class="m">15</span> seconds ago
</span><span class='line'>iybat57t4lha        test_foo.3          alpine:latest       swarm-worker-2      Running             Running <span class="m">15</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>Hop onto the <code>swarm-worker-2</code> node and check if the data is persisted from our previous write:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it 4228529aba29 sh
</span><span class='line'><span class="nv">$ </span>cat /tmp/data.txt
</span><span class='line'>d469f341d836
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s append data to that file, then delete the stack and recreate to test if the data is still persisted:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$HOSTNAME</span> &gt;&gt; /tmp/data.txt
</span><span class='line'><span class="nv">$ </span>cat /tmp/data.txt
</span><span class='line'>d469f341d836
</span><span class='line'>4228529aba29
</span></code></pre></td></tr></table></div></figure>


<p>On the manager delete the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack rm <span class="nb">test</span>
</span><span class='line'>Removing service test_foo
</span></code></pre></td></tr></table></div></figure>


<p>The deploy the stack again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml <span class="nb">test</span>
</span><span class='line'>Creating service test_foo
</span></code></pre></td></tr></table></div></figure>


<p>Check where the container is running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ps test_foo
</span><span class='line'>ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS
</span><span class='line'>9d6z02m123jk        test_foo.1          alpine:latest       swarm-worker-1      Running             Running <span class="m">2</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>Exec into the container and read the data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it 3008b1e1bba1 cat /tmp/data.txt
</span><span class='line'>d469f341d836
</span><span class='line'>4228529aba29
</span></code></pre></td></tr></table></div></figure>


<p>And as you can see the data is persisted.</p>

<h2>Resources</h2>

<p>Please have a look and star <a href="https://github.com/trajano/docker-volume-plugins">@trajano&rsquo;s</a> repository:</p>

<ul>
<li><a href="https://github.com/trajano/docker-volume-plugins">https://github.com/trajano/docker-volume-plugins</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/04/setup-a-distributed-storage-volume-with-glusterfs/">Setup a Distributed Storage Volume With GlusterFS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-04T22:32:53+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>10:32 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://glusterdocs-beta.readthedocs.io/en/latest/_images/dist-volume.png" alt="" /></p>

<p>GlusterFS is a Awesome Scalable Networked Filesystem, which makes it Easy to Create Large and Scalable Storage Solutions on Commodity Hardware.</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>


<p><p></p>

<p><strong>Basic Concepts of GlusterFS:</strong></p>

<p>Brick:
* In GlusterFS, a brick is the basic unit of storage, represented by a directory on the server in the trusted storage pool.</p>

<p>Gluster Volume:
* A Gluster volume is a Logical Collection of Bricks.</p>

<p>Distributed Filesystem:
* The concept is to enable multiple clients to concurrently access data which is spread across multple servers in a trusted storage pool. This is also a great solution to prevent data corruption, enable highly available storage systems, etc.</p>

<p><a href="http://gluster.readthedocs.io/en/latest/Administrator%20Guide/glossary/">More concepts</a> can be retrieved from their documentation.</p>

<h2>Different GlusterFS Volume Types:</h2>

<p>With GlusterFS you can create the following types of Gluster Volumes:</p>

<ul>
<li>Distributed Volumes: (Ideal for Scalable Storage, No Data Redundancy)</li>
<li>Replicated Volumes: (Better reliability and data redundancy)</li>
<li>Distributed-Replicated Volumes: (HA of Data due to Redundancy and Scaling Storage)</li>
<li><a href="http://gluster.readthedocs.io/en/latest/Quick-Start-Guide/Architecture/">More detail</a> on GlusterFS Architecture</li>
</ul>


<h2>Setup a Distributed Gluster Volume:</h2>

<p>In this guide we will setup a 3 Node Distributed GlusterFS Volume on Ubuntu 16.04.</p>

<p>For this use case we would like to achieve a storage solution to scale the size of our storage, and not really worried about redundancy as, with a Distributed Setup we can increase the size of our volume, the more bricks we add to our GlusterFS Volume.</p>

<h2>Setup: Our Environment</h2>

<p>Each node has 2 disks, <code>/dev/xvda</code> for the Operating System wich is 20GB and <code>/dev/xvdb</code> which has 100GB. After we have created our GlusterFS Volume, we will have a Gluster Volume of 300GB.</p>

<p>Having a look at our disks:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>lsblk
</span><span class='line'>NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span><span class='line'>xvda    202:0    <span class="m">0</span>   20G  <span class="m">0</span> disk
</span><span class='line'>└─xvda1 202:1    <span class="m">0</span>   20G  <span class="m">0</span> part /
</span><span class='line'>xvdb    202:16   <span class="m">0</span>  100G  <span class="m">0</span> disk
</span></code></pre></td></tr></table></div></figure></p>

<p>If you don&rsquo;t have DNS setup for your nodes, you can use your /etc/hosts file for all 3 nodes, which I will be using in this demonstration:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/hosts
</span><span class='line'>172.31.13.226   gluster-node-1
</span><span class='line'>172.31.9.7      gluster-node-2
</span><span class='line'>172.31.15.34    gluster-node-3
</span><span class='line'>127.0.0.1       localhost
</span></code></pre></td></tr></table></div></figure></p>

<h2>Install GlusterFS from the Package Manager:</h2>

<p>Note that all the steps below needs to be performed on all 3 nodes, unless specified otherwise:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install xfsprogs attr glusterfs-server glusterfs-client glusterfs-common -y
</span></code></pre></td></tr></table></div></figure></p>

<h2>Format and Prepare the Gluster Disks:</h2>

<p>We will create a XFS Filesystem for our 100GB disk, create the directory path where we will mount our disk onto, and also load it into <code>/etc/fstab</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkfs.xfs /dev/xvdb
</span><span class='line'><span class="nv">$ </span>mkdir /gluster
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;/dev/xvdb /gluster xfs defaults 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span></code></pre></td></tr></table></div></figure></p>

<p>After we mounted the disk, we should see that our disk is mounted to <code>/gluster</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/xvda1       20G  1.2G   19G   7% /
</span><span class='line'>/dev/xvdb       100G   33M  100G   1% /gluster
</span></code></pre></td></tr></table></div></figure></p>

<p>After our disk is mounted, we can proceed by creating the brick directory on our disk that we mounted, from the step above:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir /gluster/brick
</span></code></pre></td></tr></table></div></figure></p>

<h2>Start GlusterFS Service:</h2>

<p>Enable GlusterFS on startup, start the service and make sure that the service is running:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>glusterfs-server
</span><span class='line'><span class="nv">$ </span>systemctl restart glusterfs-server
</span><span class='line'><span class="nv">$ </span>systemctl is-active glusterfs-server
</span><span class='line'>active
</span></code></pre></td></tr></table></div></figure></p>

<h2>Discover All the Nodes for our Cluster:</h2>

<p>The following will only be done on one of the nodes. First we need to discover our other nodes.</p>

<p>The node that you are currently on, will be discovered by default and only needs the other 2 nodes to be discovered:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster peer probe gluster-node-2
</span><span class='line'><span class="nv">$ </span>gluster peer probe gluster-node-3
</span></code></pre></td></tr></table></div></figure></p>

<p>Let&rsquo;s verify this by listing all the nodes in our cluster:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster pool list
</span><span class='line'>UUID                                    Hostname        State
</span><span class='line'>6e02731c-6472-4ea4-bd48-d5dd87150e8b    gluster-node-2  Connected
</span><span class='line'>9d4c2605-57ba-49e2-b5da-a970448dc886    gluster-node-3  Connected
</span><span class='line'>608f027e-e953-413b-b370-ce84050a83c9    localhost       Connected
</span></code></pre></td></tr></table></div></figure></p>

<h2>Create the Distributed GlusterFS Volume:</h2>

<p>We will create a Distributed GlusterFS Volume across 3 nodes, and we will name the volume <code>gfs</code>:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume create gfs <span class="se">\</span>
</span><span class='line'>  gluster-node-1:/gluster/brick <span class="se">\</span>
</span><span class='line'>  gluster-node-2:/gluster/brick <span class="se">\</span>
</span><span class='line'>  gluster-node-3:/gluster/brick
</span><span class='line'>
</span><span class='line'>volume create: gfs: success: please start the volume to access data
</span></code></pre></td></tr></table></div></figure></p>

<h2>Start the GlusterFS Volume:</h2>

<p>Now start the <code>gfs</code> GlusterFS Volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume start gfs
</span><span class='line'>volume start: gfs: success
</span></code></pre></td></tr></table></div></figure></p>

<p>To get information about the volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume info gfs
</span><span class='line'>
</span><span class='line'>Volume Name: gfs
</span><span class='line'>Type: Distribute
</span><span class='line'>Volume ID: c08bc2e8-59b3-49e7-bc17-d4bc8d99a92f
</span><span class='line'>Status: Started
</span><span class='line'>Number of Bricks: 3
</span><span class='line'>Transport-type: tcp
</span><span class='line'>Bricks:
</span><span class='line'>Brick1: gluster-node-1:/gluster/brick
</span><span class='line'>Brick2: gluster-node-2:/gluster/brick
</span><span class='line'>Brick3: gluster-node-3:/gluster/brick
</span><span class='line'>Options Reconfigured:
</span><span class='line'>performance.readdir-ahead: on
</span></code></pre></td></tr></table></div></figure></p>

<p>Status information about our Volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>gluster volume status
</span><span class='line'>
</span><span class='line'>Status of volume: gfs
</span><span class='line'>Gluster process                             TCP Port  RDMA Port  Online  Pid
</span><span class='line'>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
</span><span class='line'>Brick gluster-node-1:/gluster/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       7139
</span><span class='line'>Brick gluster-node-2:/gluster/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       7027
</span><span class='line'>Brick gluster-node-3:/gluster/brick         <span class="m">49152</span>     <span class="m">0</span>          Y       7099
</span><span class='line'>NFS Server on localhost                     <span class="m">2049</span>      <span class="m">0</span>          Y       7158
</span><span class='line'>NFS Server on gluster-node-2                <span class="m">2049</span>      <span class="m">0</span>          Y       7046
</span><span class='line'>NFS Server on gluster-node-3                <span class="m">2049</span>      <span class="m">0</span>          Y       7118
</span><span class='line'>
</span><span class='line'>Task Status of Volume gfs
</span><span class='line'>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;
</span><span class='line'>There are no active volume tasks
</span></code></pre></td></tr></table></div></figure></p>

<h2>Mounting our GlusterFS Volume:</h2>

<p>On all the clients, in this case our 3 nodes, load the mount information into <code>/etc/fstab</code> and then mount the GlusterFS Volume:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;localhost:/gfs /mnt glusterfs defaults,_netdev,backupvolfile-server=gluster-node-1 0 0&#39;</span> &gt;&gt; /etc/fstab
</span><span class='line'><span class="nv">$ </span>mount -a
</span></code></pre></td></tr></table></div></figure></p>

<p>Now that the volume is mounted, have a look at your disk info, and you will find that you have a <code>300GB</code> GlusterFS Volume mounted:</p>

<p><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>df -h
</span><span class='line'>Filesystem      Size  Used Avail Use% Mounted on
</span><span class='line'>/dev/xvda1       20G  1.3G   19G   7% /
</span><span class='line'>/dev/xvdb       100G   33M  100G   1% /gluster
</span><span class='line'>localhost:/gfs  300G   98M  300G   1% /mnt
</span></code></pre></td></tr></table></div></figure></p>

<p>As mentioned before, this is most probably for a scenario where you would like to achieve a high storage size and not really concerned about data availability.</p>

<p>In the next couple of weeks I will also go through the Replicated, Distributed-Replicated and <a href="https://gluster.readthedocs.io/en/latest/Administrator%20Guide/Gluster%20On%20ZFS/">GlusterFS with ZFS</a> setups.</p>

<h2>Resources:</h2>

<ul>
<li><a href="http://gluster.readthedocs.io/en/latest/Quick-Start-Guide/Terminologies/">GlusterFS Terminologies</a></li>
<li><a href="http://gluster.readthedocs.io/en/latest/Quick-Start-Guide/Architecture/">GlusterFS Architecture</a></li>
<li><a href="http://gluster.readthedocs.io/en/latest/Administrator%20Guide/Gluster%20On%20ZFS/">GlusterFS with ZFS</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/02/28/use-swarm-managed-configs-in-docker-swarm-to-store-your-application-configs/">Use Swarm Managed Configs in Docker Swarm to Store Your Application Configs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-28T16:48:28+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>4:48 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg" alt="" /></p>

<p>Docker version 17.06 introduced Swarm Service Configs, which allows you to store data like configuration files, note that this is for non-sensitive information.</p>

<p>In this tutorial we will store the data of our <code>index.html</code> in a service config, then attach the config to our service.</p>

<h2>Creating the Config</h2>

<p>Create the <code>index.html</code> file and store it as a config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat &gt; index.html <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">&lt;html&gt;</span>
</span><span class='line'><span class="s">  &lt;body&gt;</span>
</span><span class='line'><span class="s">    Hello, World!</span>
</span><span class='line'><span class="s">  &lt;/body&gt;</span>
</span><span class='line'><span class="s">&lt;/html&gt;</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Store the config as <code>nginx_root_doc</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker config create nginx_root_doc index.html
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Service</h2>

<p>Create the swarm service and associate the config with the service and set the target path where the config will reside:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service create --name web <span class="se">\</span>
</span><span class='line'>  --config <span class="nb">source</span><span class="o">=</span>nginx_root_doc,target<span class="o">=</span>/usr/share/nginx/html/index.html <span class="se">\</span>
</span><span class='line'>  --publish 8080:80 nginx:alpine
</span></code></pre></td></tr></table></div></figure>


<p>Once the service is up, test it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i http://localhost:8080/
</span><span class='line'>&lt;html&gt;
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.15.9
</span><span class='line'>Date: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:00:19 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 52
</span><span class='line'>Last-Modified: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 11:59:37 GMT
</span><span class='line'>Connection: keep-alive
</span><span class='line'>ETag: <span class="s2">&quot;5c77cd29-34&quot;</span>
</span><span class='line'>Accept-Ranges: bytes
</span><span class='line'>
</span><span class='line'>&lt;html&gt;
</span><span class='line'>  &lt;body&gt;
</span><span class='line'>    Hello, World!
</span><span class='line'>  &lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Delete the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service rm web
</span></code></pre></td></tr></table></div></figure>


<p>Delete the config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker config rm nginx_root_doc
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Service using Compose:</h2>

<p>Doing the same with a docker-compose file, will look like the following. The first example will be where we will explicitly define our path of our secret, and will create on deploy time. Our compose file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">web</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx:alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">net</span>
</span><span class='line'>    <span class="l-Scalar-Plain">configs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx_root_doc</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/share/nginx/html/index.html</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">configs</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">nginx_root_doc</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./index.html</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">net</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">overlay</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploying our stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml apps
</span><span class='line'>Creating network apps_net
</span><span class='line'>Creating config apps_nginx_root_doc
</span><span class='line'>Creating service apps_web
</span></code></pre></td></tr></table></div></figure>


<p>Testing our our service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i http://localhost:8080/
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.15.9
</span><span class='line'>Date: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:20:52 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 56
</span><span class='line'>Last-Modified: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:20:47 GMT
</span><span class='line'>Connection: keep-alive
</span><span class='line'>ETag: <span class="s2">&quot;5c77d21f-38&quot;</span>
</span><span class='line'>Accept-Ranges: bytes
</span><span class='line'>
</span><span class='line'>&lt;html&gt;
</span><span class='line'>  &lt;body&gt;
</span><span class='line'>    Hello, World!
</span><span class='line'>  &lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Note, that configs cant be updated, if you want to rotate a config you will create a new config and update the target in your task definition to point to your new config.</p>

<p>Delete the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack rm apps
</span><span class='line'>Removing service apps_web
</span><span class='line'>Removing config apps_nginx_root_doc
</span><span class='line'>Removing network apps_net
</span></code></pre></td></tr></table></div></figure>


<p>Another example will be to point to a external config which already exists in swarm. The only change will be that we need to set the config as a external type.</p>

<p>Create the config:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker config create nginx_root_doc index.html
</span></code></pre></td></tr></table></div></figure>


<p>Now that the config exists, create this compose file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.3&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">web</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx:alpine</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">net</span>
</span><span class='line'>    <span class="l-Scalar-Plain">configs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx_root_doc</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/share/nginx/html/index.html</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">configs</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">nginx_root_doc</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">net</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">driver</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">overlay</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml apps
</span><span class='line'>Creating network apps_net
</span><span class='line'>Creating service apps_web
</span></code></pre></td></tr></table></div></figure>


<p>Then testing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -i http://localhost:8080/
</span><span class='line'>HTTP/1.1 <span class="m">200</span> OK
</span><span class='line'>Server: nginx/1.15.9
</span><span class='line'>Date: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:28:11 GMT
</span><span class='line'>Content-Type: text/html
</span><span class='line'>Content-Length: 56
</span><span class='line'>Last-Modified: Thu, <span class="m">28</span> Feb <span class="m">2019</span> 12:28:09 GMT
</span><span class='line'>Connection: keep-alive
</span><span class='line'>ETag: <span class="s2">&quot;5c77d3d9-38&quot;</span>
</span><span class='line'>Accept-Ranges: bytes
</span><span class='line'>
</span><span class='line'>&lt;html&gt;
</span><span class='line'>  &lt;body&gt;
</span><span class='line'>    Hello, World!
</span><span class='line'>  &lt;/body&gt;
</span><span class='line'>&lt;/html&gt;
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<p>For more information on docker swarm configs have a look at <a href="https://docs.docker.com/engine/swarm/configs/#example-rotate-a-config">docker&rsquo;s documentation</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/02/27/how-to-validate-strings-in-python-with-regex/">How to Validate Strings in Python With Regex</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-27T13:47:53+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>1:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let&rsquo;s say you need to validate strings in Python. Making decisions if a string is valid or not, is what we will be looking at today.</p>

<script src="//ap.lijit.com/www/delivery/fpi.js?z=601358&width=300&height=250"></script>


<p></p>

<h2>The Scenario</h2>

<p>We have a string that will look like this: <code>my-random-abc-string-2947104284738593726152637836291</code>. The <code>abc</code> section will always be 3 random string characters and the integers, will always be 32 integer characters, the rest will always stay the same.</p>

<p>Using the <code>re</code> library, we will create our regex expression and match them up with a input string, then if they are the same, we will pass the validation check, and make a decision from there.</p>

<h2>The Script</h2>

<p>Our random string generator:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">uuid</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">letters</span> <span class="o">=</span> <span class="s">&#39;abcdefghijklmnopqrstuvwxyz&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">generate_string</span><span class="p">():</span>
</span><span class='line'><span class="o">...</span>     <span class="n">random_letters</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</span><span class='line'><span class="o">...</span>     <span class="n">response</span> <span class="o">=</span> <span class="s">&#39;my-random-&#39;</span> <span class="o">+</span> <span class="n">random_letters</span> <span class="o">+</span> <span class="s">&#39;-string_&#39;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
</span><span class='line'><span class="o">...</span>     <span class="k">return</span> <span class="n">response</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our validation check:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">validation_check</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>     <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;my-random-[a-z]{3}-string_[0-9a-z]{32}\Z&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>     <span class="n">match</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_string</span><span class="p">))</span>
</span><span class='line'><span class="o">...</span>     <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing the validation check against our data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mystring</span> <span class="o">=</span> <span class="n">generate_string</span><span class="p">()</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">mystring</span>
</span><span class='line'><span class="s">&#39;my-random-ngt-string_6346145281738193742120539836241&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">validate</span> <span class="o">=</span> <span class="n">validation_check</span><span class="p">(</span><span class="n">mystring</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">if</span> <span class="n">validate</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="s">&#39;The string {} is valid&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mystring</span><span class="p">))</span>
</span><span class='line'><span class="o">...</span> <span class="k">else</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="s">&#39;The string {} is not valid&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mystring</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">the</span> <span class="n">string</span> <span class="n">my</span><span class="o">-</span><span class="n">random</span><span class="o">-</span><span class="n">ngt</span><span class="o">-</span><span class="n">string_6346145281738193742120539836241</span> <span class="ow">is</span> <span class="n">valid</span>
</span></code></pre></td></tr></table></div></figure>


<p>The function checks for a strict 32 characters in the random hex number, if you had to randomize the length, you can always use this regex:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;my-random-[a-z]{3}-string__[0-9]+&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/02/25/how-to-tag-all-your-aws-iam-users-with-python/">How to Tag All Your AWS IAM Users With Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-25T13:44:55+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>1:44 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let&rsquo;s say that all your IAM users are named in <code>name.surname</code> and your system accounts are named as <code>my-system-account</code> and you find yourself in a position that you need to tag all your IAM users based on Human/System account type.</p>

<script src="//ap.lijit.com/www/delivery/fpi.js?z=601358&width=300&height=250"></script>


<p>With AWS and Python&rsquo;s Boto library, it makes things easy. We would list all our users, loop through each one and tag them with the predefined tag values that we chose.</p>

<h2>Batch Tagging AWS IAM Users with Python</h2>

<p>This script wil tag all users with the tag: Name, Email, Environment and Account_Type.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'>
</span><span class='line'><span class="n">iam</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;test&#39;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;iam&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">paginator</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s">&#39;list_users&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">iam_environment</span> <span class="o">=</span> <span class="s">&#39;test&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">unstructed_users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="n">userlist</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="n">taggable_users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="n">already_tagged_users</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'><span class="n">email_address_domain</span> <span class="o">=</span> <span class="s">&#39;@example.com&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># generate tag list based on account type</span>
</span><span class='line'><span class="k">def</span> <span class="nf">tag_template</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">environment</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">username</span><span class="p">:</span>
</span><span class='line'>        <span class="n">account_type</span> <span class="o">=</span> <span class="s">&#39;human&#39;</span>
</span><span class='line'>  <span class="n">email</span> <span class="o">=</span> <span class="n">username</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">account_type</span> <span class="o">=</span> <span class="s">&#39;system&#39;</span>
</span><span class='line'>  <span class="n">email</span> <span class="o">=</span> <span class="s">&#39;system-admin&#39;</span>
</span><span class='line'>  
</span><span class='line'>    <span class="n">template</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>        <span class="p">{</span><span class="s">&#39;Key&#39;</span><span class="p">:</span> <span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="n">username</span><span class="o">.</span><span class="n">lower</span><span class="p">()},</span>
</span><span class='line'>        <span class="p">{</span><span class="s">&#39;Key&#39;</span><span class="p">:</span> <span class="s">&#39;Email&#39;</span><span class="p">,</span> <span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="n">email_address_domain</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="s">&#39;Key&#39;</span><span class="p">:</span> <span class="s">&#39;Environment&#39;</span><span class="p">,</span><span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="n">environment</span><span class="p">},</span>
</span><span class='line'>        <span class="p">{</span><span class="s">&#39;Key&#39;</span><span class="p">:</span> <span class="s">&#39;Account_Type&#39;</span><span class="p">,</span><span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="n">account_type</span><span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">template</span>
</span><span class='line'>
</span><span class='line'><span class="c"># generate userlist</span>
</span><span class='line'><span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">():</span>
</span><span class='line'>    <span class="n">unstructed_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;Users&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unstructed_users</span><span class="p">)):</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">userobj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unstructed_users</span><span class="p">[</span><span class="n">iteration</span><span class="p">])):</span>
</span><span class='line'>        <span class="n">userlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">unstructed_users</span><span class="p">[</span><span class="n">iteration</span><span class="p">][</span><span class="n">userobj</span><span class="p">][</span><span class="s">&#39;UserName&#39;</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># generate taggable userlist:</span>
</span><span class='line'><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">userlist</span><span class="p">:</span>
</span><span class='line'>    <span class="n">tag_response</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">list_user_tags</span><span class="p">(</span><span class="n">UserName</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag_response</span><span class="p">[</span><span class="s">&#39;Tags&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span class='line'>        <span class="n">taggable_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">already_tagged_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># tag users from taggable_list</span>
</span><span class='line'><span class="k">for</span> <span class="n">tag_user</span> <span class="ow">in</span> <span class="n">taggable_users</span><span class="p">:</span>
</span><span class='line'>    <span class="n">user_template</span> <span class="o">=</span> <span class="n">tag_template</span><span class="p">(</span><span class="n">tag_user</span><span class="p">,</span> <span class="n">iam_environment</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">tag_user</span><span class="p">,</span> <span class="n">user_template</span><span class="p">)</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">iam</span><span class="o">.</span><span class="n">tag_user</span><span class="p">(</span><span class="n">UserName</span><span class="o">=</span><span class="n">tag_user</span><span class="p">,</span> <span class="n">Tags</span><span class="o">=</span><span class="n">user_template</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># print lists</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&#39;Userlists: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">userlist</span><span class="p">))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&#39;Taggable Users: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">taggable_users</span><span class="p">))</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&#39;Already Tagged Users: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">already_tagged_users</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>After it completes, your IAM users should be tagged in the following format:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Name</span><span class="p">:</span> <span class="n">john</span><span class="o">.</span><span class="n">doe</span>
</span><span class='line'><span class="n">Email</span><span class="p">:</span> <span class="n">john</span><span class="o">.</span><span class="n">doe</span><span class="nd">@example.com</span>
</span><span class='line'><span class="n">Environment</span><span class="p">:</span> <span class="n">test</span>
</span><span class='line'><span class="n">Account_Type</span><span class="p">:</span> <span class="n">human</span>
</span><span class='line'>
</span><span class='line'><span class="ow">or</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">Name</span><span class="p">:</span> <span class="n">system</span><span class="o">-</span><span class="n">account</span>
</span><span class='line'><span class="n">Email</span><span class="p">:</span> <span class="n">system</span><span class="o">-</span><span class="n">admin</span><span class="nd">@example.com</span>
</span><span class='line'><span class="n">Environment</span><span class="p">:</span> <span class="n">test</span>
</span><span class='line'><span class="n">Account</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">system</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
<img alt="" border="0" src="https://www.paypal.com/en_ZA/i/scr/pixel.gif" width="1" height="1" />
</form>
</center>


<p><br></p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/02/21/building-python-serverless-slack-apps-on-openfaas/">Building Python Serverless Slack Apps on OpenFaas</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-21T23:29:15+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2019</span></span> <span class='time'>11:29 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://camo.githubusercontent.com/cf01eefb5b6905f3774376d6d1ed55b8f052d211/68747470733a2f2f626c6f672e616c6578656c6c69732e696f2f636f6e74656e742f696d616765732f323031372f30382f666161735f736964652e706e67" alt="" /></p>

<p>If you are not familliar with OpenFaas, it&rsquo;s definitely time that you should have a look at it, plus, they are doing some pretty awesome work!</p>

<script src="//ap.lijit.com/www/delivery/fpi.js?z=601358&width=300&height=250"></script>


<p></p>

<p>From their documentation: &ldquo;OpenFaaS (Functions as a Service) is a framework for building serverless functions with Docker and Kubernetes which has first class support for metrics. Any process can be packaged as a function enabling you to consume a range of web events without repetitive boiler-plate coding.&rdquo;</p>

<p>Make sure to give them a visit at <a href="https://docs.openfaas.com">openfaas.com</a> and while you are there, in the world of serverless, have a look at how Alex outlines architecture and patterns he applies in a real-world example, <a href="https://www.openfaas.com/blog/serverless-single-page-app/">absolutely great read!</a></p>

<h2>What are we doing today?</h2>

<p>Today we will build a slack app using python which we will deploy as a function on OpenFaas!</p>

<p>Our slash command will make a request to our <code>slack-request</code> function, which will respond with a json string, which will then be parsed in a slack attachment message, then based on your button decision, it will then invoke our <code>slack-interaction</code> function, which will then respond with another message that will allow you to follow the embedded link.</p>

<p>The slack messages are really basic, but you can create a awesome workflow using slack apps. And the best of all, its running on OpenFaas!</p>

<h2>Deploying OpenFaas</h2>

<p>Docker Swarm and Kubernetes are supported, but since I am using Docker Swarm at the moment of writing, this tutorial will show how to deploy OpenFaas to your cluster. Have a look at <a href="https://docs.openfaas.com/deployment/docker-swarm/">OpenFaas Documentation</a> for more detailed information.</p>

<p>Installing OpenFaas CLI for Mac:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install faas-cli
</span></code></pre></td></tr></table></div></figure>


<p>Deploy the OpenFaas Stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git clone https://github.com/openfaas/faas
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>faas
</span><span class='line'><span class="nv">$ </span>./deploy_stack.sh
</span></code></pre></td></tr></table></div></figure>


<p>Credentials: The default configuration will create credentials for you and returns instructions on how to authorize faas-cli, for demonstration it will look more or less like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> -n &lt;some_hash_secret&gt; <span class="p">|</span> faas-cli login --username<span class="o">=</span>admin --password-stdin
</span></code></pre></td></tr></table></div></figure>


<p>The UI will be available at: <a href="http://127.0.0.1:8080.">http://127.0.0.1:8080.</a> For this demonstration we will only use the cli.</p>

<h2>Create the Functions</h2>

<p>I will create 2 python functions:</p>

<ul>
<li>The <code>slack-request</code> function, which will be associated to the slash command</li>
<li>The <code>slack-interactive</code> function, which will be used for interactivity</li>
</ul>


<p>Create a home directory for your functions and create 2 functions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p ~/functions <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ~/functions
</span><span class='line'><span class="nv">$ </span>faas-cli new --lang python slack-request
</span><span class='line'><span class="nv">$ </span>faas-cli new --lang python slack-interactive
</span></code></pre></td></tr></table></div></figure>


<p>Read the <a href="https://docs.openfaas.com/tutorials/first-python-function/">documentation</a> if you&rsquo;d like to learn more.</p>

<p>Configure the first function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim slack-request/handler.py
</span></code></pre></td></tr></table></div></figure>


<p>And our function code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;Serverless Message&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;attachments&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span class='line'>            <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;The Awesome world of Serverless introduces: OpenFaas!&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span class='line'>                <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Amazing Level&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="s">&quot;10&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="bp">True</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>                <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Github Stars&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="s">&quot;15k +&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;short&quot;</span><span class="p">:</span> <span class="bp">True</span>
</span><span class='line'>            <span class="p">}],</span>
</span><span class='line'>            <span class="s">&quot;author_name&quot;</span><span class="p">:</span> <span class="s">&quot;OpenFaas&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;author_icon&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;image_url&quot;</span><span class="p">:</span> <span class="s">&quot;https://blog.alexellis.io/content/images/2017/08/small.png&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;About OpenFaas&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;OpenFaaS is a framework for packaging code, binaries or containers as Serverless functions on any platform.&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;fallback&quot;</span><span class="p">:</span> <span class="s">&quot;Would you recommend OpenFaas to your friends?&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;Would you recommend OpenFaas to your friends?&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;callback_id&quot;</span><span class="p">:</span> <span class="s">&quot;response123&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;color&quot;</span><span class="p">:</span> <span class="s">&quot;#3AA3E3&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;attachment_type&quot;</span><span class="p">:</span> <span class="s">&quot;default&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;recommend&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;Ofcourse!&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;button&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="s">&quot;recommend&quot;</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;definitely&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;Most Definitely!&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;button&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="s">&quot;definitely&quot;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">]</span>
</span><span class='line'>        <span class="p">}]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since our response needs to be parsed as json, we need to set the content type for our environment in our yaml configuration. Read more on it <a href="https://docs.openfaas.com/reference/yaml/">here</a>. Edit the <code>slack-request.yml</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">provider</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">faas</span>
</span><span class='line'>  <span class="l-Scalar-Plain">gateway</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://&lt;your.gw.address&gt;:8080</span>
</span><span class='line'><span class="l-Scalar-Plain">functions</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">slack-request</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lang</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">python</span>
</span><span class='line'>    <span class="l-Scalar-Plain">handler</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./slack-request</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;your-repo&gt;/slack-request:latest</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">content_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">application/json</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to build our image, push it to our repository like dockerhub, then deploy to openfaas:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>faas-cli build -f ./slack-request.yml
</span><span class='line'><span class="nv">$ </span>faas-cli push -f ./slack-request.yml
</span><span class='line'><span class="nv">$ </span>faas-cli deploy -f ./slack-request.yml
</span><span class='line'>Deploying: slack-request.
</span><span class='line'>
</span><span class='line'>Deployed. <span class="m">202</span> Accepted.
</span><span class='line'>URL: http://your.gw.address:8080/function/slack-interactive
</span></code></pre></td></tr></table></div></figure>


<p>Configure the <code>slack-interactive</code> function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim slack-interactive/handler.py
</span></code></pre></td></tr></table></div></figure>


<p>Note that whenever your interact with the first message, a post request will be made against the interactivity request url, you will notice that I decoded the payload (but not doing anything with it), where you will find the callback_id, request_url etc. But for simplicity, I am just using a static json message to respond. Our function code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">urllib</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
</span><span class='line'>    <span class="n">urlstring</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;payload=&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urlstring</span><span class="p">)</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;attachments&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="s">&quot;replace_original&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;response_type&quot;</span><span class="p">:</span> <span class="s">&quot;ephemeral&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;fallback&quot;</span><span class="p">:</span> <span class="s">&quot;Required plain-text summary of the attachment.&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;color&quot;</span><span class="p">:</span> <span class="s">&quot;#36a64f&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;pretext&quot;</span><span class="p">:</span> <span class="s">&quot;Ahh yeah! Great choice, OpenFaas is absolutely brilliant!&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;author_name&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;author_link&quot;</span><span class="p">:</span> <span class="s">&quot;https://github.com/openfaas/faas&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;author_icon&quot;</span><span class="p">:</span> <span class="s">&quot;http://flickr.com/icons/bobby.jpg&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;title&quot;</span><span class="p">:</span> <span class="s">&quot;OpenFaas&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;title_link&quot;</span><span class="p">:</span> <span class="s">&quot;https://github.com/openfaas/faas&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;text&quot;</span><span class="p">:</span> <span class="s">&quot;Head over to OpenFaas&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;image_url&quot;</span><span class="p">:</span> <span class="s">&quot;https://avatars2.githubusercontent.com/u/27013154?s=400&amp;v=4&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;thumb_url&quot;</span><span class="p">:</span> <span class="s">&quot;https://github.com/openfaas/faas&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;footer&quot;</span><span class="p">:</span> <span class="s">&quot;Slack Apps built on OpenFaas&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;footer_icon&quot;</span><span class="p">:</span> <span class="s">&quot;https://a.slack-edge.com/45901/marketing/img/_rebrand/meta/slack_hash_256.png&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;ts&quot;</span><span class="p">:</span> <span class="mi">123456789</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We also need to set the content type to json:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>provider:
</span><span class='line'>  name: faas
</span><span class='line'>  gateway: http://&lt;your.gw.address&gt;:8080
</span><span class='line'>functions:
</span><span class='line'>  slack-interactive:
</span><span class='line'>    lang: python
</span><span class='line'>    handler: ./slack-interactive
</span><span class='line'>    image: &lt;repo&gt;/slack-interactive:latest
</span><span class='line'>    environment:
</span><span class='line'>      content_type: application/json
</span></code></pre></td></tr></table></div></figure>


<p>Build, deploy and ship:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>faas-cli build -f ./slack-interactive.yml
</span><span class='line'><span class="nv">$ </span>faas-cli push -f ./slack-interactive.yml
</span><span class='line'><span class="nv">$ </span>faas-cli deploy -f ./slack-interactive.yml
</span><span class='line'>
</span><span class='line'>Deploying: slack-interactive.
</span><span class='line'>
</span><span class='line'>Deployed. <span class="m">202</span> Accepted.
</span><span class='line'>URL: http://&lt;your.gw.address&gt;:8080/function/slack-interactive
</span></code></pre></td></tr></table></div></figure>


<p>When your functions are deployed, go ahead and create the slack app.</p>

<h2>Create the Slack App</h2>

<ul>
<li>Head over to <a href="https://api.slack.com/apps">https://api.slack.com/apps</a> and create a new app</li>
<li>Create a incoming webhook</li>
<li>Head over to slash commands and create a new command, in my case it was <code>/supersam</code>, set the request url to the public endpoint of your function: <code>http://pub-ip:8080/function/slack-request</code></li>
<li>Head over to interactive components, set the request url for the interactivity: <code>http://pub-ip:8080/function/slack-interactive</code></li>
<li>If you dont have a public routable address, have a look at <a href="https://ngrok.com">ngrok</a></li>
</ul>


<p>Once you are set, you should be able to see the slash command integration in your slack workspace, head over to slacks <a href="https://api.slack.com/docs">documentation</a> if you run into any trouble.</p>

<h2>Test your Slack App</h2>

<p>Now that everything is good to go, its time to test your slack app running on OpenFaas!</p>

<p>Head over to slack and run your command <code>/&lt;your-slack-slash-command&gt;</code>. You should see this output:</p>

<p><img src="https://user-images.githubusercontent.com/567298/53206700-56932e00-363a-11e9-8d44-dfd27f005ab0.png" alt="" /></p>

<p>When you select one of the buttons, you will get a new message:</p>

<p><img src="https://user-images.githubusercontent.com/567298/53206764-74f92980-363a-11e9-91cb-6cfc30c74457.png" alt="" /></p>

<p>This is a real basic example of slack apps, but slack apps are really powerful. You can for example create a slack app that deploys ephemeral environments on swarm, or create change management approval workflows etc.</p>

<p>I hope this was informative, I am really enjoying OpenFaas at the moment and if your have not tested it, I encourage you to try it out, its really, really amazing!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/02/19/parallel-processing-on-aws-lambda-with-python-using-multiprocessing/">Parallel Processing on AWS Lambda With Python Using Multiprocessing</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-19T16:39:47+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>4:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53020033-c51b9480-345e-11e9-9625-b73062e2464a.png" alt="" /></p>

<p>If you are trying to use <code>multiprocessing.Queue</code> or <code>multiprocessing.Pool</code> on AWS Lambda, you are probably getting the exception:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Errno 38] Function not implemented: OSError
</span><span class='line'>
</span><span class='line'>    sl = self._semlock = _multiprocessing.SemLock(kind, value, maxvalue)
</span><span class='line'>OSError: [Errno 38] Function not implemented</span></code></pre></td></tr></table></div></figure>


<p>The reason for that is due to the Lambda execution environment not having support on shared memory for processes, therefore you can’t use <code>multiprocessing.Queue</code> or <code>multiprocessing.Pool</code>.</p>

<p>As a workaround, Lambda does support the usage of <code>multiprocessing.Pipe</code> instead of Queue.</p>

<h2>Parallel Processing on Lambda Example</h2>

<p>Below is a very basic example on how you would achieve the task of executing parallel processing on AWS Lambda for Python:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">multiprocessing</span>
</span><span class='line'>
</span><span class='line'><span class="n">region_maps</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;eu-west-1&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;dynamodb&quot;</span><span class="p">:</span><span class="s">&quot;dynamodb.eu-west-1.amazonaws.com&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;us-east-1&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;dynamodb&quot;</span><span class="p">:</span><span class="s">&quot;dynamodb.us-east-1.amazonaws.com&quot;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;us-east-2&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;dynamodb&quot;</span><span class="p">:</span> <span class="s">&quot;dynamodb.us-east-2.amazonaws.com&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">multiprocessing_func</span><span class="p">(</span><span class="n">region</span><span class="p">):</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">endpoint</span> <span class="o">=</span> <span class="n">region_maps</span><span class="p">[</span><span class="n">region</span><span class="p">][</span><span class="s">&#39;dynamodb&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&#39;endpoint for {} is {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span><span class='line'>    <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class='line'>    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;us-east-1&#39;</span><span class="p">,</span> <span class="s">&#39;us-east-2&#39;</span><span class="p">,</span> <span class="s">&#39;eu-west-1&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">multiprocessing_func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">region</span><span class="p">,))</span>
</span><span class='line'>        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span class='line'>        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
</span><span class='line'>        <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;That took {} seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">starttime</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">output</span>
</span></code></pre></td></tr></table></div></figure>


<p>The output when the function gets invoked:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">pid</span><span class="p">:</span> <span class="mi">30913</span> <span class="o">-</span> <span class="n">endpoint</span> <span class="k">for</span> <span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span> <span class="ow">is</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="n">pid</span><span class="p">:</span> <span class="mi">30914</span> <span class="o">-</span> <span class="n">endpoint</span> <span class="k">for</span> <span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">2</span> <span class="ow">is</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mf">2.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="n">pid</span><span class="p">:</span> <span class="mi">30915</span> <span class="o">-</span> <span class="n">endpoint</span> <span class="k">for</span> <span class="n">eu</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">1</span> <span class="ow">is</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">eu</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">1.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="n">That</span> <span class="n">took</span> <span class="mf">1.014902114868164</span> <span class="n">seconds</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
<img alt="" border="0" src="https://www.paypal.com/en_ZA/i/scr/pixel.gif" width="1" height="1" />
</form>
</center>


<p><br></p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/02/19/sharing-global-variables-in-python-using-multiprocessing/">Sharing Global Variables in Python Using Multiprocessing</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-19T16:02:43+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>4:02 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53020033-c51b9480-345e-11e9-9625-b73062e2464a.png" alt="" /></p>

<p>While I was using multiprocessing, I found out that global variables are not shared between processes.</p>

<h2>Example of the Issue</h2>

<p>Let me first provide an example of the issue that I was facing.</p>

<p>I have 2 input lists, which 2 processes wil read from and append them to the final list and print the aggregated list to stdout</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">multiprocessing</span>
</span><span class='line'><span class="n">final_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'><span class="n">input_list_one</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="s">&#39;two&#39;</span><span class="p">,</span> <span class="s">&#39;three&#39;</span><span class="p">,</span> <span class="s">&#39;four&#39;</span><span class="p">,</span> <span class="s">&#39;five&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">input_list_two</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;six&#39;</span><span class="p">,</span> <span class="s">&#39;seven&#39;</span><span class="p">,</span> <span class="s">&#39;eight&#39;</span><span class="p">,</span> <span class="s">&#39;nine&#39;</span><span class="p">,</span> <span class="s">&#39;ten&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>        <span class="n">final_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">process1</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">final_list_one</span><span class="p">])</span>
</span><span class='line'><span class="n">process2</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">final_list_two</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">process1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'><span class="n">process2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'><span class="n">process1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class='line'><span class="n">process2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">final_list</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>When running the example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python3 mp_list_issue.py
</span><span class='line'><span class="o">[]</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see the response from the list is still empty.</p>

<h2>Resolution</h2>

<p>We need to use <a href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.sharedctypes.multiprocessing.Manager">multiprocessing.Manager.List</a>.</p>

<p>From Python&rsquo;s Documentation:</p>

<p>&ldquo;The <code>multiprocessing.Manager</code> returns a started SyncManager object which can be used for sharing objects between processes. The returned manager object corresponds to a spawned child process and has methods which will create shared objects and return corresponding proxies.&rdquo;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">multiprocessing</span>
</span><span class='line'><span class="n">manager</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
</span><span class='line'><span class="n">final_list</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">input_list_one</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="s">&#39;two&#39;</span><span class="p">,</span> <span class="s">&#39;three&#39;</span><span class="p">,</span> <span class="s">&#39;four&#39;</span><span class="p">,</span> <span class="s">&#39;five&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">input_list_two</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;six&#39;</span><span class="p">,</span> <span class="s">&#39;seven&#39;</span><span class="p">,</span> <span class="s">&#39;eight&#39;</span><span class="p">,</span> <span class="s">&#39;nine&#39;</span><span class="p">,</span> <span class="s">&#39;ten&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span class='line'>        <span class="n">final_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">process1</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">final_list_one</span><span class="p">])</span>
</span><span class='line'><span class="n">process2</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">final_list_two</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">process1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'><span class="n">process2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'><span class="n">process1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class='line'><span class="n">process2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">final_list</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now when we run our script, we can see that our processes are aware of our defined list:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python3</span> <span class="n">mp_list</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="p">[</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="s">&#39;two&#39;</span><span class="p">,</span> <span class="s">&#39;three&#39;</span><span class="p">,</span> <span class="s">&#39;four&#39;</span><span class="p">,</span> <span class="s">&#39;five&#39;</span><span class="p">,</span> <span class="s">&#39;six&#39;</span><span class="p">,</span> <span class="s">&#39;seven&#39;</span><span class="p">,</span> <span class="s">&#39;eight&#39;</span><span class="p">,</span> <span class="s">&#39;nine&#39;</span><span class="p">,</span> <span class="s">&#39;ten&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
<img alt="" border="0" src="https://www.paypal.com/en_ZA/i/scr/pixel.gif" width="1" height="1" />
</form>
</center>


<p><br></p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/02/19/parallel-processing-with-python-and-multiprocessing-using-queue/">Parallel Processing With Python and Multiprocessing Using Queue</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-02-19T15:05:47+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>3:05 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53020033-c51b9480-345e-11e9-9625-b73062e2464a.png" alt="" /></p>

<p>Today I had the requirement to achieve a task by using parallel processing in order to save time.</p>

<h2>The task to be achieved</h2>

<p>For this demonstration, I have a list of people and each task needs to lookup its pet name and return to stdout. I want to spawn a task for each persons pet name lookup and run the tasks in parallel so that all the results can be returned back at once, instead of sequential.</p>

<p>This is a basic task, but you could have a CPU intensive job, where it will shine better.</p>

<h2>Multiprocesing Queues</h2>

<p>When using multiple processes, one generally uses message passing for communication between processes and avoids having to use any synchronization primitives like locks.</p>

<p>The Queue type is a multi producer, multi consumer FIFO queues modelled on the queue.Queue class in the standard library. You can read more up on it <a href="https://docs.python.org/3.4/library/multiprocessing.html?highlight=process#pipes-and-queues">here</a></p>

<h2>Our Workflow</h2>

<p>Our multiprocessing workflow will look like this:</p>

<ul>
<li>We will define our data, which will be a dictionary of people and their pet names</li>
<li>We will define an output queue</li>
<li>Create a example function that will produce each task to the queue</li>
<li>Then we will setup a lost of processes that we want to run</li>
<li>From the list of processes that we defined, we will run each process, then wait and exit the completed processes</li>
<li>We will then consume from the queue. For each process in our processes list</li>
</ul>


<p>Note that I also added a delay of 2 seconds, so that you can see that the tasks are run in parallel, so the delay will only be 2 seconds.</p>

<p>Our code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="kn">as</span> <span class="nn">mp</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">string</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="n">pet_maps</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;adam&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;max&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;steve&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;sylvester&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;michelle&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;fuzzy&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;frank&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;pete&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;will&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;cat&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;natasha&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;tweety&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;samantha&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;bob&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;peter&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;garfield&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;susan&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;zazu&quot;</span><span class="p">},</span>
</span><span class='line'>        <span class="s">&quot;josh&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;pet_name&quot;</span><span class="p">:</span> <span class="s">&quot;tom&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">pet_owners</span> <span class="o">=</span> <span class="n">pet_maps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">output</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_pet_name</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&#39;adding to queue&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="s">&#39;pet name: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">processes</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">get_pet_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">pet_maps</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s">&#39;pet_name&#39;</span><span class="p">],</span> <span class="n">output</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pet_owners</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
</span><span class='line'>    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
</span><span class='line'>    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&#39;consuming from queue:&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">]</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python3</span> <span class="n">mp</span><span class="o">.</span><span class="n">py</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'><span class="n">adding</span> <span class="n">to</span> <span class="n">queue</span>
</span><span class='line'>
</span><span class='line'><span class="n">consuming</span> <span class="kn">from</span> <span class="nn">queue</span><span class="p">:</span>
</span><span class='line'><span class="p">[</span><span class="s">&#39;pet name: max&#39;</span><span class="p">,</span> <span class="s">&#39;pet name: sylvester&#39;</span><span class="p">,</span> <span class="s">&#39;pet name: fuzzy&#39;</span><span class="p">,</span> <span class="s">&#39;pet name: pete&#39;</span><span class="p">,</span> <span class="s">&#39;pet name: cat&#39;</span><span class="p">,</span> <span class="s">&#39;pet name: tweety&#39;</span><span class="p">,</span> <span class="s">&#39;pet name: garfield&#39;</span><span class="p">,</span> <span class="s">&#39;pet name: bob&#39;</span><span class="p">,</span> <span class="s">&#39;pet name: zazu&#39;</span><span class="p">,</span> <span class="s">&#39;pet name: tom&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thank You</h2>

<p>Please feel free to show support by, <strong>sharing</strong> this post, making a <strong>donation</strong>, <strong>subscribing</strong> or <strong>reach out to me</strong> if you want me to demo and write up on any specific tech topic.</p>

<center>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="W7CBGYTCWGANQ" />
<input type="image" src="https://user-images.githubusercontent.com/567298/49853901-461c3700-fdf1-11e8-9d80-8a424a3173af.png" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
<img alt="" border="0" src="https://www.paypal.com/en_ZA/i/scr/pixel.gif" width="1" height="1" />
</form>
</center>


<p><br></p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/7">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/5">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/09/04/deploy-traefik-using-bekker-stacks/">Deploy Traefik Using Bekker Stacks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/09/04/aws-s3-kms-and-python-for-secrets-management/">AWS S3 KMS and Python for Secrets Management</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/07/making-deploying-functions-even-easier-with-faas-cli-up-using-openfaas/">Making Deploying Functions Even Easier With Faas-cli Up Using OpenFaaS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/07/using-openfaas-with-amazon-dynamodb/">Using OpenFaas With Amazon DynamoDB</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/22/play-with-kinesis-data-streams-for-free/">Play With Kinesis Data Streams for Free</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>

</body>
</html>
