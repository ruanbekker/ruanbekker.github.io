
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="In this post we will setup the Elastic Stack with Elasticsearc, Kibana and APM . The APM Server (Application Performance Metrics) which will receive &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="canonical" href="http://blog.ruanbekker.com/posts/6/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/11/11/setup-apm-server-on-ubuntu-for-your-elastic-stack-to-get-insights-in-your-application-performance-metrics/">Setup APM Server on Ubuntu for Your Elastic Stack to Get Insights in Your Application Performance Metrics</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-11-11T12:31:43-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>12:31 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://objects.ruanbekker.com/assets/images/elastic-apm-overview.png" alt="" /></p>

<p>In this post we will setup the Elastic Stack with Elasticsearc, Kibana and APM . The APM Server (Application Performance Metrics) which will receive the metric data from the application side, and is then pushed to apm indices on Elasticsearch.</p>

<p>This will be a 2 post blog on APM:</p>

<ul>
<li>1) <a href="">Setup the Elastic Stack with Elasticsearch, Kibana and APM Server</a> - this post</li>
<li>2) <a href="https://blog.ruanbekker.com/blog/2018/11/11/get-application-performance-metrics-on-python-flask-with-elastic-apm-on-kibana-and-elasticsearch/">Setup a Python Flask application with the APM Agent</a></li>
</ul>


<h2>What is APM</h2>

<p>From their website APM is described as: &ldquo;Elastic APM is an application performance monitoring system built on the Elastic Stack. It allows you to monitor software services and applications in real time, collecting detailed performance information on response time for incoming requests, database queries, calls to caches, external HTTP requests, etc.&rdquo;</p>

<p>You get metrics like average, p99 response times etc, and also have insights when errors occur, it even allows you to look at the stacktrace, poinpointing on which line of your code it ocurred etc.</p>

<ul>
<li><a href="https://www.elastic.co/solutions/apm">More Info</a></li>
</ul>


<h2>APM Agents:</h2>

<p>The APM Agents will be loaded inside your application, application metrics will then be pushed to the APM Server (which we will setup in this post), which then gets pushed to Elasticsearch and is then consumed by Kibana.</p>

<p>At the time of writing, the APM Agents are supported in the following languages:</p>

<ul>
<li>Node.js</li>
<li>Django</li>
<li>Flask</li>
<li>Ruby on Rails</li>
<li>Rack</li>
<li>RUM</li>
<li>Golang</li>
<li>Java</li>
</ul>


<h2>Setup the Elastic Stack</h2>

<p>One thing to note, every service in your Elastic Stack needs to be running on the same version. In this post we will setup Elasticsearch, APM and Kibana all running on version <code>6.4.3</code></p>

<h2>Setup the Pre-Requirements:</h2>

<p>Elasticsearch depends on Java, se we will go ahead and setup the repositories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch <span class="p">|</span> sudo apt-key add -
</span><span class='line'><span class="nv">$ </span>apt-get install apt-transport-https -y
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;deb https://artifacts.elastic.co/packages/6.x/apt stable main&quot;</span> <span class="p">|</span> sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list
</span><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span><span class='line'><span class="nv">$ </span>apt install openjdk-8-jdk -y
</span></code></pre></td></tr></table></div></figure>


<p>Verify that Java is installed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>java -version
</span><span class='line'>openjdk version <span class="s2">&quot;1.8.0_181&quot;</span>
</span><span class='line'>OpenJDK Runtime Environment <span class="o">(</span>build 1.8.0_181-8u181-b13-1ubuntu0.16.04.1-b13<span class="o">)</span>
</span><span class='line'>OpenJDK 64-Bit Server VM <span class="o">(</span>build 25.181-b13, mixed mode<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Setup Kernel parameters for Elasticsearch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sysctl -w vm.max_map_count<span class="o">=</span>262144
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;vm.max_map_count=262144&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></code></pre></td></tr></table></div></figure>


<h2>Setup Elasticsearch:</h2>

<p>Search for the latest versions (when already having elasticsearch, either upgrade or install apm on the same version as elasticsearch/kibana):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt-cache madison elasticsearch
</span><span class='line'>elasticsearch <span class="p">|</span>      6.4.3 <span class="p">|</span> https://artifacts.elastic.co/packages/6.x/apt stable/main amd64 Packages
</span><span class='line'>elasticsearch <span class="p">|</span>      6.4.2 <span class="p">|</span> https://artifacts.elastic.co/packages/6.x/apt stable/main amd64 Packages
</span></code></pre></td></tr></table></div></figure>


<p>Install Elasticsearch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt-get install <span class="nv">elasticsearch</span><span class="o">=</span>6.4.3 -y
</span></code></pre></td></tr></table></div></figure>


<p>Configure Elasticsearch to lock the memory on startup:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sed -i <span class="s1">&#39;s/#bootstrap.memory_lock: true/bootstrap.memory_lock: true/g&#39;</span> /etc/elasticsearch/elasticsearch.yml
</span></code></pre></td></tr></table></div></figure>


<p>Enable Elasticsearch on startup and start the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl daemon-reload
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>elasticsearch.service
</span><span class='line'><span class="nv">$ </span>systemctl start elasticsearch.service
</span></code></pre></td></tr></table></div></figure>


<h2>Install Kibana:</h2>

<p>Install Kibana version <code>6.4.3</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install <span class="nv">kibana</span><span class="o">=</span>6.4.3 -y
</span></code></pre></td></tr></table></div></figure>


<p>For demonstration, I will configure Kibana to listen on all interfaces on port <code>5601</code>, but note this will enable access for everyone, you can [follow this blogpost] to setup a Nginx Reverse Proxy to upstream to localhost on port 5601.</p>

<p>Since this demonstration we are using Elasticsearch locally, so if you have a remote cluster, configuration can be applied where needed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sed -i <span class="s1">&#39;s/#server.host: &quot;localhost&quot;/server.host: &quot;0.0.0.0&quot;/&#39;</span>g /etc/kibana/kibana.yml
</span><span class='line'><span class="nv">$ </span>sed -i <span class="s1">&#39;s/#elasticsearch.url: &quot;http:\/\/localhost:9200&quot;/elasticsearch.url: &quot;http:\/\/localhost:9200&quot;/&#39;</span>g /etc/kibana/kibana.yml
</span></code></pre></td></tr></table></div></figure>


<p>Enable Kibana on startup and start the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>kibana.service
</span><span class='line'><span class="nv">$ </span>systemctl restart kibana.service
</span></code></pre></td></tr></table></div></figure>


<h2>Install the APM Server</h2>

<p>Install APM Server version <code>6.4.3</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install apm-server<span class="o">=</span>6.4.3 -y
</span></code></pre></td></tr></table></div></figure>


<p>Since we have everything locally, the configuration can be kept as is, but if you need to configure the elasticsearch or kibana hosts, it can be done via <code>/etc/apm-server/apm-server.yml</code></p>

<p>Then once Kibana and Elasticsearch is started, load the mapping templates, enable and start the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apm-server setup
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>apm-server.service
</span><span class='line'><span class="nv">$ </span>systemctl restart apm-server.service
</span></code></pre></td></tr></table></div></figure>


<p>Ensure all the services are running with <code>netstat -tulpn</code> and port <code>9200</code>, <code>9300</code>, <code>5601</code> and <code>8300</code> should be listening</p>

<h2>Access Your Elastic Stack</h2>

<p>Access Kibana on your routable endpoint on port <code>5601</code> and you should see something like this:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/elastic-apm-startup.png" alt="" /></p>

<h2>Configuring a Application to push metrics to APM</h2>

<p>In the <a href="https://blog.ruanbekker.com/blog/2018/11/11/get-application-performance-metrics-on-python-flask-with-elastic-apm-on-kibana-and-elasticsearch/">next post</a> I will setup a Python Flask Application on APM</p>

<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/31/benchmark-website-response-times-with-curl/">Benchmark Website Response Times With CURL</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-31T02:17:12-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2018</span></span> <span class='time'>2:17 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We can gain insights when making requests to websites such as:</p>

<ul>
<li>Lookup time</li>
<li>Connect time</li>
<li>AppCon time</li>
<li>Redirect time</li>
<li>PreXfer time</li>
<li>StartXfer time</li>
</ul>


<p>We will make a request to a website that has caching enabled, the first hit will be a MISS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -w <span class="s1">&#39;\nLookup time:\t%{time_namelookup}\nConnect time:\t%{time_connect}\nAppCon time:\t%{time_appconnect}\nRedirect time:\t%{time_redirect}\nPreXfer time:\t%{time_pretransfer}\nStartXfer time:\t%{time_starttransfer}\n\nTotal time:\t%{time_total}\n&#39;</span> -o /dev/null https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg
</span><span class='line'>
</span><span class='line'>Lookup <span class="nb">time</span>:  1.524465
</span><span class='line'>Connect <span class="nb">time</span>: 1.707561
</span><span class='line'>AppCon <span class="nb">time</span>:  0.000000
</span><span class='line'>Redirect <span class="nb">time</span>:    0.000000
</span><span class='line'>PreXfer <span class="nb">time</span>: 1.707656
</span><span class='line'>StartXfer <span class="nb">time</span>:   1.897660
</span><span class='line'>
</span><span class='line'>Total <span class="nb">time</span>:   2.451824
</span></code></pre></td></tr></table></div></figure>


<p>The next hit will be a HIT:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -w <span class="s1">&#39;\nLookup time:\t%{time_namelookup}\nConnect time:\t%{time_connect}\nAppCon time:\t%{time_appconnect}\nRedirect time:\t%{time_redirect}\nPreXfer time:\t%{time_pretransfer}\nStartXfer time:\t%{time_starttransfer}\n\nTotal time:\t%{time_total}\n&#39;</span> -o /dev/null https://user-images.githubusercontent.com/567298/53351889-85572000-392a-11e9-9720-464e9318206e.jpg
</span><span class='line'>
</span><span class='line'>Lookup <span class="nb">time</span>:  0.004441
</span><span class='line'>Connect <span class="nb">time</span>: 0.188065
</span><span class='line'>AppCon <span class="nb">time</span>:  0.000000
</span><span class='line'>Redirect <span class="nb">time</span>:    0.000000
</span><span class='line'>PreXfer <span class="nb">time</span>: 0.188160
</span><span class='line'>StartXfer <span class="nb">time</span>:   0.381344
</span><span class='line'>
</span><span class='line'>Total <span class="nb">time</span>:   0.926420
</span></code></pre></td></tr></table></div></figure>


<p>Similar Posts:</p>

<ul>
<li><a href="https://blog.josephscott.org/2011/10/14/timing-details-with-curl/">https://blog.josephscott.org/2011/10/14/timing-details-with-curl/</a></li>
<li><a href="https://ops.tips/gists/measuring-http-response-times-curl/">https://ops.tips/gists/measuring-http-response-times-curl/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/31/how-to-bootstrap-nodes-with-python-using-ansible/">How to Bootstrap Nodes With Python Using Ansible</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-31T01:48:15-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2018</span></span> <span class='time'>1:48 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://res.cloudinary.com/rbekker/image/upload/v1531083331/ansible_tojf8l.png" alt="" /></p>

<p>As Ansible depends on Python, therefore we can bootstrap our nodes with Python using a Ansible Playbook</p>

<h2>Inventory</h2>

<p>The nodes we want to bootstrap:</p>

<figure class='code'><figcaption><span>inventory.ini</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>new<span class="o">]</span>
</span><span class='line'>node-1
</span><span class='line'>node-2
</span><span class='line'>node-3
</span><span class='line'>
</span><span class='line'><span class="o">[</span>new:vars<span class="o">]</span>
</span><span class='line'><span class="nv">ansible_python_interpreter</span><span class="o">=</span>/usr/bin/python3
</span></code></pre></td></tr></table></div></figure>


<h2>Playbook</h2>

<p>Our playbook with what we want to do:</p>

<figure class='code'><figcaption><span>bootstrap-python.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install python</span>
</span><span class='line'>    <span class="l-Scalar-Plain">raw</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test -e /usr/bin/python || ( apt update &amp;&amp; apt install python -y )</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy</h2>

<p>Deploy with Ansible:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ansible-playbook -i inventory.ini bootstrap-python.yml
</span><span class='line'>
</span><span class='line'>PLAY <span class="o">[</span>all<span class="o">]</span> ***********************************************************************************************************************************************************************************************
</span><span class='line'>
</span><span class='line'>TASK <span class="o">[</span>install python<span class="o">]</span> ************************************************************************************************************************************************************************************
</span><span class='line'>changed: <span class="o">[</span>node-1<span class="o">]</span>
</span><span class='line'>changed: <span class="o">[</span>node-2<span class="o">]</span>
</span><span class='line'>changed: <span class="o">[</span>node-3<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>PLAY RECAP ***********************************************************************************************************************************************************************************************
</span><span class='line'>node-1                     : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">2</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>node-2                     : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">2</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>node-3                     : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">2</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span></code></pre></td></tr></table></div></figure>


<p>This is it for this post, all posts for this tutorial will be posted under <a href="http://blog.ruanbekker.com/blog/categories/ansible-tutorial">#ansible-tutorial</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/31/how-to-install-packages-on-remote-systems-with-ansible/">How to Install Packages on Remote Systems With Ansible</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-31T01:28:18-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2018</span></span> <span class='time'>1:28 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://res.cloudinary.com/rbekker/image/upload/v1531083331/ansible_tojf8l.png" alt="" /></p>

<p>We will use Ansible to deploy packages to remote systems and in this case all the remote systems are running Debian, therefore we will be using the APT package manager.</p>

<h2>Pre-Requisites:</h2>

<p>Ensure that you have installed Ansible and setup the SSH Config for your remote systems, how to do that can be found under the post: <a href="https://blog.ruanbekker.com/blog/2018/07/08/getting-started-with-ansible-on-ubuntu/">setting up ansible</a></p>

<h2>Our Inventory</h2>

<p>The inventory file that describes our hosts:</p>

<figure class='code'><figcaption><span>inventory.ini</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>scaleway<span class="o">]</span>
</span><span class='line'>cluster-node-1
</span><span class='line'>cluster-node-2
</span><span class='line'>
</span><span class='line'><span class="o">[</span>hetzner<span class="o">]</span>
</span><span class='line'>docker-node-1
</span><span class='line'>docker-node-2
</span><span class='line'>docker-node-3
</span><span class='line'>glusterfs-node-1
</span><span class='line'>glusterfs-node-2
</span><span class='line'>elasticsearch-node-1
</span><span class='line'>elasticsearch-node-2
</span><span class='line'>
</span><span class='line'><span class="o">[</span>scaleway:vars<span class="o">]</span>
</span><span class='line'><span class="nv">ansible_python_interpreter</span><span class="o">=</span>/usr/bin/python3
</span><span class='line'><span class="nv">location</span><span class="o">=</span>france
</span><span class='line'>
</span><span class='line'><span class="o">[</span>hetzner:vars<span class="o">]</span>
</span><span class='line'><span class="nv">ansible_python_interpreter</span><span class="o">=</span>/usr/bin/python3
</span><span class='line'><span class="nv">location</span><span class="o">=</span>germany
</span></code></pre></td></tr></table></div></figure>


<h2>Playbook</h2>

<p>Our playbook that we will define that we want to deploy packages using apt to all hosts:</p>

<figure class='code'><figcaption><span>packages.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install Packages</span>
</span><span class='line'>    <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name= state=latest update_cache=yes</span>
</span><span class='line'>    <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ntp</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">python</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">tcpdump</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">wget</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openssl</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">curl</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy</h2>

<p>Running the playbook to deploy the packages to the remote servers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ansible-playbook -i inventory.ini packages.yml
</span><span class='line'>
</span><span class='line'>PLAY <span class="o">[</span>all<span class="o">]</span> ***********************************************************************************************************************************************************************************************
</span><span class='line'>
</span><span class='line'>TASK <span class="o">[</span>Gathering Facts<span class="o">]</span> ***********************************************************************************************************************************************************************************
</span><span class='line'>ok: <span class="o">[</span>glusterfs-node-2<span class="o">]</span>
</span><span class='line'>ok: <span class="o">[</span>glusterfs-node-1<span class="o">]</span>
</span><span class='line'>ok: <span class="o">[</span>docker-node-1<span class="o">]</span>
</span><span class='line'>ok: <span class="o">[</span>docker-node-2<span class="o">]</span>
</span><span class='line'>ok: <span class="o">[</span>docker-node-3<span class="o">]</span>
</span><span class='line'>ok: <span class="o">[</span>elasticsearch-node-1<span class="o">]</span>
</span><span class='line'>ok: <span class="o">[</span>elasticsearch-node-2<span class="o">]</span>
</span><span class='line'>ok: <span class="o">[</span>cluster-node-1<span class="o">]</span>
</span><span class='line'>ok: <span class="o">[</span>cluster-node-2<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>TASK <span class="o">[</span>Install Packages<span class="o">]</span> **********************************************************************************************************************************************************************************
</span><span class='line'>changed: <span class="o">[</span>docker-node-1<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;ntp&#39;</span>, u<span class="s1">&#39;python&#39;</span>, u<span class="s1">&#39;tcpdump&#39;</span>, u<span class="s1">&#39;wget&#39;</span>, u<span class="s1">&#39;openssl&#39;</span>, u<span class="s1">&#39;curl&#39;</span><span class="o">])</span>
</span><span class='line'>changed: <span class="o">[</span>docker-node-2<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;ntp&#39;</span>, u<span class="s1">&#39;python&#39;</span>, u<span class="s1">&#39;tcpdump&#39;</span>, u<span class="s1">&#39;wget&#39;</span>, u<span class="s1">&#39;openssl&#39;</span>, u<span class="s1">&#39;curl&#39;</span><span class="o">])</span>
</span><span class='line'>changed: <span class="o">[</span>docker-node-3<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;ntp&#39;</span>, u<span class="s1">&#39;python&#39;</span>, u<span class="s1">&#39;tcpdump&#39;</span>, u<span class="s1">&#39;wget&#39;</span>, u<span class="s1">&#39;openssl&#39;</span>, u<span class="s1">&#39;curl&#39;</span><span class="o">])</span>
</span><span class='line'>changed: <span class="o">[</span>elasticsearch-node-1<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;ntp&#39;</span>, u<span class="s1">&#39;python&#39;</span>, u<span class="s1">&#39;tcpdump&#39;</span>, u<span class="s1">&#39;wget&#39;</span>, u<span class="s1">&#39;openssl&#39;</span>, u<span class="s1">&#39;curl&#39;</span><span class="o">])</span>
</span><span class='line'>changed: <span class="o">[</span>glusterfs-node-1<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;ntp&#39;</span>, u<span class="s1">&#39;python&#39;</span>, u<span class="s1">&#39;tcpdump&#39;</span>, u<span class="s1">&#39;wget&#39;</span>, u<span class="s1">&#39;openssl&#39;</span>, u<span class="s1">&#39;curl&#39;</span><span class="o">])</span>
</span><span class='line'>changed: <span class="o">[</span>glusterfs-node-2<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;ntp&#39;</span>, u<span class="s1">&#39;python&#39;</span>, u<span class="s1">&#39;tcpdump&#39;</span>, u<span class="s1">&#39;wget&#39;</span>, u<span class="s1">&#39;openssl&#39;</span>, u<span class="s1">&#39;curl&#39;</span><span class="o">])</span>
</span><span class='line'>changed: <span class="o">[</span>elasticsearch-node-2<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;ntp&#39;</span>, u<span class="s1">&#39;python&#39;</span>, u<span class="s1">&#39;tcpdump&#39;</span>, u<span class="s1">&#39;wget&#39;</span>, u<span class="s1">&#39;openssl&#39;</span>, u<span class="s1">&#39;curl&#39;</span><span class="o">])</span>
</span><span class='line'>ok: <span class="o">[</span>cluster-node-1<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;ntp&#39;</span>, u<span class="s1">&#39;python&#39;</span>, u<span class="s1">&#39;tcpdump&#39;</span>, u<span class="s1">&#39;wget&#39;</span>, u<span class="s1">&#39;openssl&#39;</span>, u<span class="s1">&#39;curl&#39;</span><span class="o">])</span>
</span><span class='line'>ok: <span class="o">[</span>cluster-node-2<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=[</span>u<span class="s1">&#39;ntp&#39;</span>, u<span class="s1">&#39;python&#39;</span>, u<span class="s1">&#39;tcpdump&#39;</span>, u<span class="s1">&#39;wget&#39;</span>, u<span class="s1">&#39;openssl&#39;</span>, u<span class="s1">&#39;curl&#39;</span><span class="o">])</span>
</span><span class='line'>
</span><span class='line'>PLAY RECAP ***********************************************************************************************************************************************************************************************
</span><span class='line'>docker-node-1              : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>docker-node-2              : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>docker-node-3              : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>elasticsearch-node-1       : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>elasticsearch-node-2       : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>glusterfs-node-1           : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>glusterfs-node-2           : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">1</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>cluster-node-1             : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span><span class='line'>cluster-node-2             : <span class="nv">ok</span><span class="o">=</span><span class="m">2</span>    <span class="nv">changed</span><span class="o">=</span><span class="m">0</span>    <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span>0
</span></code></pre></td></tr></table></div></figure>


<p>This is it for this post, all posts for this tutorial will be posted under <a href="http://blog.ruanbekker.com/blog/categories/ansible-tutorial">#ansible-tutorials</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/30/query-24-hours-worth-of-data-using-batchget-on-amazon-dynamodb-using-scan-and-filter-without-a-gsi/">Query 24 Hours Worth of Data Using BatchGet on Amazon DynamoDB Using Scan and Filter Without a GSI</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-30T14:53:43-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>2:53 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m testing how to query data in DynamoDB which will always be the retrieval of yesterdays data, without using a Global Secondary Index.</p>

<p>This is done just to see what other ways you can use to query data based on a specific timeframe.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>Use-Case:</h2>

<p>Data from DynamoDB needs to be batch processed (daily for the last 24-hours), into a external datasource. Data will be written into DynamoDB, the HK (uuid) and RK (timestamp) will be duplicated to the daily table. But only uuid and timestamp will be duplicated to the daily table, and only data for that day will be written into that datestamp formatted table name.</p>

<p>Let&rsquo;s say data for 2018-10-30 needs to be written into our external data source, we will do a scan on table <code>tbl-test_20181030</code>, then from our response we will have a list of HashKeys (uuid) which we will use to do a BatchGet Item on our base table: <code>tbl-test_base</code>, which essentially grabs all the data for that day.</p>

<p>If deeper filtering needs to be done on that day, the FilterExpression can be used to do a deeper filtering which leads to grabbing only the filtered down data from the base table.</p>

<p><em>Note:</em> The base table might have millions of items, so a Scan operation on the Base table would be really expensive, as it reads all the items in the table.</p>

<p>Once the data has been processed, the daily or metadata table can be removed.</p>

<h2>DynamoDB Table Design</h2>

<p>The base table: <code>tbl-test_base</code> will have:</p>

<ul>
<li>HashKey: uuid (string)</li>
<li>RangeKey: timestamp (number)</li>
<li>Attributes: city, stream, transaction_date, name, metric_uri</li>
<li>Item will look like:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s">u&#39;uuid&#39;</span><span class="p">:</span> <span class="s">u&#39;fb4ddeb9-3b5e-47b3-bbab-1aa1d8e8f47b&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s">u&#39;timestamp&#39;</span><span class="p">:</span> <span class="mi">1540891276</span><span class="p">,</span>
</span><span class='line'>  <span class="s">u&#39;city&#39;</span><span class="p">:</span> <span class="s">u&#39;sydney&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s">u&#39;stream&#39;</span><span class="p">:</span> <span class="s">u&#39;NONE&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s">u&#39;transaction_date&#39;</span><span class="p">:</span> <span class="s">u&#39;2018-10-30 11:21:16&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s">u&#39;metric_uri&#39;</span><span class="p">:</span> <span class="s">u&#39;some-dummy-metric-uri&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s">u&#39;name&#39;</span><span class="p">:</span> <span class="s">u&#39;frank&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>he Daily Table: <code>tbl-test_20181030</code> will look like:</p>

<ul>
<li>HashKey: <code>uuid</code></li>
<li>Attributes: <code>timestamp</code></li>
<li>Item will look like:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s">u&#39;uuid&#39;</span><span class="p">:</span> <span class="s">u&#39;fb4ddeb9-3b5e-47b3-bbab-1aa1d8e8f47b&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s">u&#39;timestamp&#39;</span><span class="p">:</span> <span class="mi">1540891276</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Demonstration using Python</h2>

<p>Creating the Metadata table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">uuid</span><span class="o">,</span> <span class="nn">random</span>
</span><span class='line'>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;dev&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">resource</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">create_table</span><span class="p">():</span>
</span><span class='line'>    <span class="n">table_name</span> <span class="o">=</span> <span class="s">&quot;tbl-test_{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
</span><span class='line'>        <span class="n">TableName</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
</span><span class='line'>        <span class="n">KeySchema</span><span class="o">=</span><span class="p">[{</span>
</span><span class='line'>            <span class="s">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s">&#39;uuid&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;KeyType&#39;</span><span class="p">:</span> <span class="s">&#39;HASH&#39;</span>
</span><span class='line'>        <span class="p">}],</span>
</span><span class='line'>        <span class="n">AttributeDefinitions</span><span class="o">=</span><span class="p">[{</span>
</span><span class='line'>            <span class="s">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s">&#39;uuid&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;AttributeType&#39;</span><span class="p">:</span> <span class="s">&#39;S&#39;</span>
</span><span class='line'>        <span class="p">}],</span>
</span><span class='line'>        <span class="n">ProvisionedThroughput</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;ReadCapacityUnits&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;WriteCapacityUnits&#39;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">resource</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="o">.</span><span class="n">wait_until_exists</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">arn</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">describe_table</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="n">table_name</span><span class="p">)[</span><span class="s">&#39;Table&#39;</span><span class="p">][</span><span class="s">&#39;TableArn&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="n">client</span><span class="o">.</span><span class="n">tag_resource</span><span class="p">(</span>
</span><span class='line'>        <span class="n">ResourceArn</span><span class="o">=</span><span class="n">arn</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Tags</span><span class="o">=</span><span class="p">[</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&#39;Key&#39;</span><span class="p">:</span> <span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="s">&#39;dynamo_table&#39;</span><span class="p">},</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&#39;Key&#39;</span><span class="p">:</span> <span class="s">&#39;Environment&#39;</span><span class="p">,</span><span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="s">&#39;Dev&#39;</span><span class="p">},</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&#39;Key&#39;</span><span class="p">:</span> <span class="s">&#39;CreatedBy&#39;</span><span class="p">,</span><span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="s">&#39;Ruan&#39;</span><span class="p">}</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="o">.</span><span class="n">table_status</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">create_table</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>Write 400 Items to DynamoDB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">uuid</span><span class="o">,</span> <span class="nn">random</span>
</span><span class='line'>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;dev&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">resource</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">base_table</span> <span class="o">=</span> <span class="s">&#39;tbl-test_base&#39;</span>
</span><span class='line'><span class="n">meta_table</span> <span class="o">=</span> <span class="s">&#39;tbl-test_{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y%m</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">people</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;james&#39;</span><span class="p">,</span> <span class="s">&#39;john&#39;</span><span class="p">,</span> <span class="s">&#39;frank&#39;</span><span class="p">,</span> <span class="s">&#39;paul&#39;</span><span class="p">,</span> <span class="s">&#39;nathan&#39;</span><span class="p">,</span> <span class="s">&#39;kevin&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">cities</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ireland&#39;</span><span class="p">,</span> <span class="s">&#39;cape town&#39;</span><span class="p">,</span> <span class="s">&#39;pretoria&#39;</span><span class="p">,</span> <span class="s">&#39;paris&#39;</span><span class="p">,</span> <span class="s">&#39;amsterdam&#39;</span><span class="p">,</span> <span class="s">&#39;auckland&#39;</span><span class="p">,</span> <span class="s">&#39;sydney&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">write_dynamo</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
</span><span class='line'>    <span class="n">resource</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">base_table</span><span class="p">)</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;metric_uri&#39;</span><span class="p">:</span> <span class="s">&#39;some-dummy-metric-uri&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;transaction_date&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">people</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&#39;stream&#39;</span><span class="p">:</span> <span class="s">&#39;NONE&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;city&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">resource</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">meta_table</span><span class="p">)</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;uuid&#39;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="s">&#39;Written&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">400</span><span class="p">):</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">write_dynamo</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Getting Data for 20181030 but also filter data greater than the timestamp attribute, greater than <code>1540841144</code> in epoch time (which will give us about 254 items).</p>

<p>The BatchGet Item supports up to 100 items per call, we will limit the scans on 100 items per call, then paginate using the ExlusiveStartKey with the value of our LastEvaluatedKey that we will get from our response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span><span class="o">,</span><span class="nn">time</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">boto3.dynamodb.conditions</span> <span class="kn">import</span> <span class="n">Key</span>
</span><span class='line'>
</span><span class='line'><span class="n">base_table</span> <span class="o">=</span> <span class="s">&#39;tbl-test_base&#39;</span>
</span><span class='line'><span class="n">meta_table</span> <span class="o">=</span> <span class="s">&#39;tbl-test_20181030&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;dev&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">resource</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">table</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">meta_table</span><span class="p">)</span>
</span><span class='line'><span class="n">filtering_expression</span> <span class="o">=</span> <span class="n">Key</span><span class="p">(</span><span class="s">&#39;timestamp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">1540841144</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">FilterExpression</span><span class="o">=</span><span class="n">filtering_expression</span><span class="p">,</span> <span class="n">Limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">finished</span><span class="o">=</span><span class="bp">False</span>
</span><span class='line'><span class="k">while</span> <span class="n">finished</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&#39;LastEvaluatedKey&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Getting {} Items&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;Count&#39;</span><span class="p">]))</span>
</span><span class='line'>        <span class="n">items</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">batch_get_item</span><span class="p">(</span><span class="n">RequestItems</span><span class="o">=</span><span class="p">{</span><span class="n">base_table</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;Keys&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;Items&#39;</span><span class="p">]}})</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="s">&#39;Responses&#39;</span><span class="p">][</span><span class="n">base_table</span><span class="p">])</span>
</span><span class='line'>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">FilterExpression</span><span class="o">=</span><span class="n">filtering_expression</span><span class="p">,</span> <span class="n">Limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">ExclusiveStartKey</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;LastEvaluatedKey&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Getting {} Items&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;Count&#39;</span><span class="p">]))</span>
</span><span class='line'>        <span class="n">items</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">batch_get_item</span><span class="p">(</span><span class="n">RequestItems</span><span class="o">=</span><span class="p">{</span><span class="n">base_table</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;Keys&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;Items&#39;</span><span class="p">]}})</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="s">&#39;Responses&#39;</span><span class="p">][</span><span class="n">base_table</span><span class="p">])</span>
</span><span class='line'>        <span class="n">finished</span><span class="o">=</span><span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python dynamodb-batch-get.py
</span><span class='line'>Getting <span class="m">100</span> Items
</span><span class='line'><span class="o">[{</span>u<span class="s1">&#39;city&#39;</span>: u<span class="s1">&#39;pretoria&#39;</span>, u<span class="s1">&#39;uuid&#39;</span>: u<span class="s1">&#39;e8bc0d1c-2b57-4de2-b0e1-35ef1fe0edf1&#39;</span>, u<span class="s1">&#39;stream&#39;</span>: u<span class="s1">&#39;NONE&#39;</span>, u<span class="s1">&#39;timestamp&#39;</span>: Decimal<span class="o">(</span><span class="s1">&#39;1540846990&#39;</span><span class="o">)</span>, u<span class="s1">&#39;transaction_date&#39;</span>: u<span class="s1">&#39;2018-10-29 23:03:10&#39;</span>, u<span class="s1">&#39;metric_uri&#39;</span>: u<span class="s1">&#39;some-dummy-metric-uri&#39;</span>, u<span class="s1">&#39;name&#39;</span>: u<span class="s1">&#39;frank&#39;</span><span class="o">}</span>, <span class="o">{</span>u<span class="s1">&#39;city&#39;</span>: u<span class="s1">&#39;amsterdam&#39;</span>, u<span class="s1">&#39;uuid&#39;</span>:
</span><span class='line'>...
</span><span class='line'>Getting <span class="m">100</span> Items
</span><span class='line'><span class="o">[{</span>u<span class="s1">&#39;city&#39;</span>: u<span class="s1">&#39;sydney&#39;</span>, u<span class="s1">&#39;uuid&#39;</span>: u<span class="s1">&#39;5bc51ce9-2809-46c9-a3f2-ff8180086d92&#39;</span>, u<span class="s1">&#39;stream&#39;</span>: u<span class="s1">&#39;NONE&#39;</span>, u<span class="s1">&#39;timestamp&#39;</span>: Decimal<span class="o">(</span><span class="s1">&#39;1540848599&#39;</span><span class="o">)</span>, u<span class="s1">&#39;transaction_date&#39;</span>: u<span class="s1">&#39;2018-10-29 23:29:59&#39;</span>, u<span class="s1">&#39;metric_uri&#39;</span>: u<span class="s1">&#39;some-dummy-metric-uri&#39;</span>, u<span class="s1">&#39;name&#39;</span>: u<span class="s1">&#39;frank&#39;</span><span class="o">}</span>
</span><span class='line'>...
</span><span class='line'>Getting <span class="m">54</span> Items
</span><span class='line'><span class="o">[{</span>u<span class="s1">&#39;city&#39;</span>: u<span class="s1">&#39;cape town&#39;</span>, u<span class="s1">&#39;uuid&#39;</span>: u<span class="s1">&#39;5e069f34-0e97-4a49-9ca9-da2213edb689&#39;</span>...
</span></code></pre></td></tr></table></div></figure>


<p>Verifying that each call only scans 100 at a time:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">FilterExpression</span><span class="o">=</span><span class="n">filtering_expression</span><span class="p">,</span> <span class="n">Limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span class='line'><span class="p">[</span><span class="s">u&#39;Count&#39;</span><span class="p">,</span> <span class="s">u&#39;Items&#39;</span><span class="p">,</span> <span class="s">u&#39;LastEvaluatedKey&#39;</span><span class="p">,</span> <span class="s">u&#39;ScannedCount&#39;</span><span class="p">,</span> <span class="s">&#39;ResponseMetadata&#39;</span><span class="p">]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LastEvaluatedKey&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;uuid&#39;</span><span class="p">:</span> <span class="s">u&#39;e8c52a55-ca9e-4718-83d2-1b44a90f43e6&#39;</span><span class="p">}</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Count&#39;</span><span class="p">)</span>
</span><span class='line'><span class="mi">100</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ScannedCount&#39;</span><span class="p">)</span>
</span><span class='line'><span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Other Thoughts:</h2>

<p>Querying data is a lot easier using a Global Secondary Index where you could similarly have the metric_uri as the HashKey and transaction_date as the RangeKey:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span><span class='line'>    <span class="n">IndexName</span><span class="o">=</span><span class="s">&#39;metric_uri-transaction_date-index&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">KeyConditionExpression</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s">&#39;metric_uri&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="s">&#39;some-dummy-metric-uri&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Key</span><span class="p">(</span><span class="s">&#39;transaction_date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">begins_with</span><span class="p">(</span><span class="s">&#39;2018-10-30&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;Count&#39;</span><span class="p">]</span>
</span><span class='line'><span class="mi">400</span>
</span></code></pre></td></tr></table></div></figure>


<p>Also note that depending on how you setup your GSI, in most cases its a exact duplicate in storage from your base table, so could potentially be double the costs.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/24/using-python-flask-and-javascript-for-client-side-filtering-through-returned-data/">Using Python Flask and JavaScript for Client Side Filtering Through Returned Data</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-24T05:39:33-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>5:39 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://objects.ruanbekker.com/assets/images/python-logo.png" alt="" /></p>

<p>This post will cover 2 sections, using Python Flask and Javascript to filter returned data, where you could have a table that represents 100 items, and you want to have a search box to filter down your results as you type.</p>

<p>The other section will be used as a demo, with solving a problem with Amazon CloudWatch Logs. I&rsquo;m a Massive AWS Fanatic, but when it comes to CloudWatch Logs, I&rsquo;m not so big of a fan of that specific service. Especially when you use Docker Swarm for AWS and have your logdriver set to CloudWatch Logs.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299"; 
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>The Problem I have with CloudWatch Logs</h2>

<p>When you point to your CloudWatch LogGroups, you can search for your streams, and in my case searching for a specific swarm service, but you can&rsquo;t sort by date, like this:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/cloudwatch-logs-date-issue.png" alt="" /></p>

<p>This makes it really tedious when trying to search find your logs in a quick way.</p>

<h2>Python Flask to the Resque</h2>

<p>We will create a Python Flask application that retrieves your data about all your Docker Swarm Services and Container Id&rsquo;s running on each node. For this demonstration, I have hard coded the services and container id&rsquo;s, but using it in a real environment, you can utilise the Docker API or some logic that retrieves it from a datastore where a process populates it to.</p>

<p>The Application Code will do the following:</p>

<ul>
<li>returns a list of your swarm services (mock data in the code)</li>
<li>when you select a service, it will get a list of the container ids and run through a for loop unsing jinja templates and display them in table format</li>
<li>when you select the containerId, it will populate the containerId to the cloudwatch logs filter, giving you the exact logstream which you are looking for</li>
<li><p>this will do a redirect to the AWS Console, and you will see the data in the sorted time of interest</p></li>
<li><p><code>app.py</code></p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># faking datasets that can be returned from a api or database</span>
</span><span class='line'><span class="n">swarm_services</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;my-web-service&#39;</span><span class="p">,</span> <span class="s">&#39;my-api-service&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">swarm_tasks</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;my-web-service&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;container_names&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s">&quot;my-web-service.1.alfjshoehfosfn&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;my-web-service.2.fuebchduehakjdu&quot;</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&quot;my-api-service&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;container_names&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s">&quot;my-api-service.1.oprudhyuythvbzx&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;my-api-service.2.sjduebansifotuf&quot;</span>
</span><span class='line'>        <span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_container_name</span><span class="p">(</span><span class="n">app_name</span><span class="p">):</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">swarm_tasks</span><span class="p">[</span><span class="n">app_name</span><span class="p">]</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;container_names&#39;</span><span class="p">]:</span>
</span><span class='line'>        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">container</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">app_name</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">list</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;list.html&#39;</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">swarm_services</span><span class="p">),</span> <span class="n">apps</span><span class="o">=</span><span class="n">swarm_services</span><span class="p">,</span> <span class="n">aws_region</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">cloudwatch_log_stream</span><span class="o">=</span><span class="s">&#39;docker-swarm-lg&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/describe/&lt;string:app_name&gt;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">get_app</span><span class="p">(</span><span class="n">app_name</span><span class="p">):</span>
</span><span class='line'>    <span class="n">app</span> <span class="o">=</span> <span class="n">get_container_name</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">app</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>index.html</code>:</p>

<script src="https://gist.github.com/ruanbekker/08b02a3ef30367ea7306a31eb5f33cb1.js"></script>


<p>The <code>list.html</code> :</p>

<script src="https://gist.github.com/ruanbekker/98eab090e218bbbf0e46d5efc1595e04.js"></script>


<h2>Filtering the Data</h2>

<p>So at this moment all your data will be returned when a list is done, if you are in a case where you have lots of information, it can be overwelming and you will need to search for the service of interest. Using HTML and JavaScript, you can filter through the results:</p>

<p>The JavaScript Function: <code>assets/js/filter.js</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">SearchAndFilterThingy</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">input</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">table</span><span class="p">,</span> <span class="nx">tr</span><span class="p">,</span> <span class="nx">td</span><span class="p">,</span> <span class="nx">x</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;UserInput&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">filter</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
</span><span class='line'>  <span class="nx">table</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;ServicesTable&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">tr</span> <span class="o">=</span> <span class="nx">table</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">tr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">td</span> <span class="o">=</span> <span class="nx">tr</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">td</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">td</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">tr</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">tr</span><span class="p">[</span><span class="nx">x</span><span class="p">].</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Screenshot</h2>

<p>Once you search for a specific keyword on the service you are looking for the output should more or less look like the following:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/docker-flask-running-services.png" alt="" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/23/building-ghost-version-2-blog-for-the-raspberrypi/">Building Ghost Version 2 Blog for the RaspberryPi</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-23T17:37:49-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2018</span></span> <span class='time'>5:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://objects.ruanbekker.com/assets/images/ghost-blog-main.png" alt="" /></p>

<p>In this post we will setup Ghost 2.0.3 for the Raspberry Pi on Docker Swarm</p>

<h2>Dockerfile</h2>

<p>Our dockerfile:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FROM rbekker87/armhf-node:8.11
</span><span class='line'>
</span><span class='line'>RUN apk add --no-cache 'su-exec&gt;=0.2' && apk --update add bash gcc g++ make python && npm install sqlite3 --build-from-source
</span><span class='line'>
</span><span class='line'>ENV NODE_ENV production
</span><span class='line'>ENV GHOST_CLI_VERSION 1.9.1
</span><span class='line'>ENV GHOST_VERSION 2.0.3
</span><span class='line'>ENV GHOST_INSTALL /var/lib/ghost
</span><span class='line'>ENV GHOST_CONTENT /var/lib/ghost/content
</span><span class='line'>
</span><span class='line'>RUN npm install -g "ghost-cli@$GHOST_CLI_VERSION"
</span><span class='line'>
</span><span class='line'>RUN set -ex; \
</span><span class='line'>        mkdir -p "$GHOST_INSTALL" \
</span><span class='line'>        && adduser -s /bin/sh -D node \
</span><span class='line'>        && chown node:node "$GHOST_INSTALL" \
</span><span class='line'>        && su-exec node ghost install "$GHOST_VERSION" --db sqlite3 --no-prompt --no-stack --no-setup --dir "$GHOST_INSTALL" \
</span><span class='line'>        && cd "$GHOST_INSTALL" \
</span><span class='line'>        && su-exec node ghost config --ip 0.0.0.0 --port 2368 --no-prompt --db sqlite3 --url http://localhost:2368 --dbpath "$GHOST_CONTENT/data/ghost.db" \
</span><span class='line'>        && su-exec node ghost config paths.contentPath "$GHOST_CONTENT" \
</span><span class='line'>        && su-exec node ln -s config.production.json "$GHOST_INSTALL/config.development.json" \
</span><span class='line'>        && readlink -f "$GHOST_INSTALL/config.development.json" \
</span><span class='line'>        && mv "$GHOST_CONTENT" "$GHOST_INSTALL/content.orig" \
</span><span class='line'>        && mkdir -p "$GHOST_CONTENT" && chown node:node "$GHOST_CONTENT" \
</span><span class='line'>        && "$GHOST_INSTALL/current/node_modules/knex-migrator/bin/knex-migrator" --version
</span><span class='line'>
</span><span class='line'>ENV PATH $PATH:$GHOST_INSTALL/current/node_modules/knex-migrator/bin
</span><span class='line'>
</span><span class='line'>WORKDIR $GHOST_INSTALL
</span><span class='line'>
</span><span class='line'>COPY docker-entrypoint.sh /usr/local/bin
</span><span class='line'>RUN chmod +x /usr/local/bin/docker-entrypoint.sh
</span><span class='line'>
</span><span class='line'>ENTRYPOINT ["docker-entrypoint.sh"]
</span><span class='line'>
</span><span class='line'>CMD ["node", "current/index.js"]</span></code></pre></td></tr></table></div></figure>


<h2>Our Boot Script</h2>

<p>Our entrypoint script <code>docker-entrypoint.sh</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>set -e
</span><span class='line'>
</span><span class='line'>if [[ "$*" == node*current/index.js* ]] && [ "$(id -u)" = '0' ];
</span><span class='line'>  then
</span><span class='line'>    chown -R node "$GHOST_CONTENT"
</span><span class='line'>    exec su-exec node "$BASH_SOURCE" "$@"
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>if [[ "$*" == node*current/index.js* ]];
</span><span class='line'>  then
</span><span class='line'>    baseDir="$GHOST_INSTALL/content.orig"
</span><span class='line'>    for src in "$baseDir"/*/ "$baseDir"/themes/*;
</span><span class='line'>      do
</span><span class='line'>        src="${src%/}"
</span><span class='line'>        target="$GHOST_CONTENT/${src#$baseDir/}"
</span><span class='line'>        mkdir -p "$(dirname "$target")"
</span><span class='line'>        if [ ! -e "$target" ];
</span><span class='line'>          then
</span><span class='line'>            tar -cC "$(dirname "$src")" "$(basename "$src")" | tar -xC "$(dirname "$target")"
</span><span class='line'>        fi
</span><span class='line'>      done
</span><span class='line'>
</span><span class='line'>    knex-migrator-migrate --init --mgpath "$GHOST_INSTALL/current"
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>prod() {
</span><span class='line'>cat &gt; /var/lib/ghost/config.development.json &lt;&lt; EOF
</span><span class='line'>{
</span><span class='line'>  "url": "http://${SERVER_URL:-localhost}:${SERVER_PORT:-2368}",
</span><span class='line'>  "server": {
</span><span class='line'>    "port": ${SERVER_PORT:-2368},
</span><span class='line'>    "host": "0.0.0.0"
</span><span class='line'>  },
</span><span class='line'>  "database": {
</span><span class='line'>    "client": "sqlite3",
</span><span class='line'>    "connection": {
</span><span class='line'>      "filename": "/var/lib/ghost/content/data/ghost.db"
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "mail": {
</span><span class='line'>    "transport": "SMTP",
</span><span class='line'>    "from": "${FROM_NAME:-MyBlog} &lt;${FROM_EMAIL:-ghost-blog@localhost}&gt;",
</span><span class='line'>    "options": {
</span><span class='line'>      "service": "Mailgun",
</span><span class='line'>      "host": "${SMTP_HOST:-localhost}",
</span><span class='line'>      "port": ${SMTP_PORT:-25},
</span><span class='line'>      "auth": {
</span><span class='line'>        "user": "${SMTP_AUTH_USERNAME:-root}",
</span><span class='line'>        "pass": "${SMTP_AUTH_PASSWORD:-password}"
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "logging": {
</span><span class='line'>    "transports": [
</span><span class='line'>      "file",
</span><span class='line'>      "stdout"
</span><span class='line'>    ]
</span><span class='line'>  },
</span><span class='line'>  "process": "systemd",
</span><span class='line'>  "paths": {
</span><span class='line'>    "contentPath": "/var/lib/ghost/content"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>dev() {
</span><span class='line'>cat &gt; /var/lib/ghost/config.development.json &lt;&lt; EOF
</span><span class='line'>{
</span><span class='line'>  "url": "http://${SERVER_URL:-localhost}:${SERVER_PORT:-2368}",
</span><span class='line'>  "server": {
</span><span class='line'>    "port": ${SERVER_PORT:-2368},
</span><span class='line'>    "host": "0.0.0.0"
</span><span class='line'>  },
</span><span class='line'>  "database": {
</span><span class='line'>    "client": "sqlite3",
</span><span class='line'>    "connection": {
</span><span class='line'>      "filename": "/var/lib/ghost/content/data/ghost.db"
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "mail": {
</span><span class='line'>    "transport": "Direct"
</span><span class='line'>  },
</span><span class='line'>  "logging": {
</span><span class='line'>    "transports": [
</span><span class='line'>      "file",
</span><span class='line'>      "stdout"
</span><span class='line'>    ]
</span><span class='line'>  },
</span><span class='line'>  "process": "systemd",
</span><span class='line'>  "paths": {
</span><span class='line'>    "contentPath": "/var/lib/ghost/content"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>test(){
</span><span class='line'>cat &gt; /var/lib/ghost/config.development.json &lt;&lt; EOF
</span><span class='line'>{
</span><span class='line'>  "url": "http://localhost:2368",
</span><span class='line'>  "server": {
</span><span class='line'>    "port": 2368,
</span><span class='line'>    "host": "0.0.0.0"
</span><span class='line'>  },
</span><span class='line'>  "database": {
</span><span class='line'>    "client": "sqlite3",
</span><span class='line'>    "connection": {
</span><span class='line'>      "filename": "/var/lib/ghost/content/data/ghost.db"
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  "mail": {
</span><span class='line'>    "transport": "Direct"
</span><span class='line'>  },
</span><span class='line'>  "logging": {
</span><span class='line'>    "transports": [
</span><span class='line'>      "file",
</span><span class='line'>      "stdout"
</span><span class='line'>    ]
</span><span class='line'>  },
</span><span class='line'>  "process": "systemd",
</span><span class='line'>  "paths": {
</span><span class='line'>    "contentPath": "/var/lib/ghost/content"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>if  [ "${ENV_TYPE}" = "PROD" ]
</span><span class='line'>  then prod
</span><span class='line'>
</span><span class='line'>elif [ "${ENV_TYPE}" = "DEV" ]
</span><span class='line'>  then dev
</span><span class='line'>  else test
</span><span class='line'>
</span><span class='line'>fi
</span><span class='line'>
</span><span class='line'>exec "$@"</span></code></pre></td></tr></table></div></figure>


<p>The entrypoint script takes a couple of environment variables, as you can see if they are not defined, defaults will be inherited.</p>

<p>Configurable Environment Variables:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  - ENV_TYPE=PROD
</span><span class='line'>  - SERVER_PORT=2368
</span><span class='line'>  - SERVER_URL=myblog.pistack.co.za
</span><span class='line'>  - FROM_NAME=MyName
</span><span class='line'>  - SMTP_HOST=mail.mydomain.co.za
</span><span class='line'>  - SMTP_PORT=587
</span><span class='line'>  - SMTP_AUTH_USERNAME=me@mydomain.co.za
</span><span class='line'>  - SMTP_AUTH_PASSWORD=secret</span></code></pre></td></tr></table></div></figure>


<h2>Building our Ghost Image</h2>

<p>I have a public image available if you dont want to build/push, but for building:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker build -t your-name/repo:tag</span></code></pre></td></tr></table></div></figure>


<h2>Deploy Ghost with Traefik</h2>

<p>Our <code>ghost-compose.yml</code> with traefik will look like the following, note that I mounted the source path to the container&rsquo;s path, the source path is running on a replicated glusterfs volume, which can be setup following <a href="https://blog.ruanbekker.com/blog/2018/10/23/setting-up-a-docker-swarm-cluster-on-3-raspberrypi-nodes/">this post</a></p>

<p>Also for this demonstration I was using the domain pistack.co.za, where you need to utilize the domain of your choice.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>version: "3.4"
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  ghost:
</span><span class='line'>    image: rbekker87/armhf-ghost:2.0.3
</span><span class='line'>    networks:
</span><span class='line'>      - appnet
</span><span class='line'>    volumes:
</span><span class='line'>      - type: bind
</span><span class='line'>        source: /mnt/volumes/myblog/content/data
</span><span class='line'>        target: /var/www/ghost/content/data
</span><span class='line'>    environment:
</span><span class='line'>      - ENV_TYPE=PROD
</span><span class='line'>      - SERVER_PORT=2368
</span><span class='line'>      - SERVER_URL=myblog.pistack.co.za
</span><span class='line'>      - FROM_NAME=MyName
</span><span class='line'>      - SMTP_HOST=mail.mydomain.co.za
</span><span class='line'>      - SMTP_PORT=587
</span><span class='line'>      - SMTP_AUTH_USERNAME=me@mydomain.co.za
</span><span class='line'>      - SMTP_AUTH_PASSWORD=secret
</span><span class='line'>    deploy:
</span><span class='line'>      replicas: 1
</span><span class='line'>      labels:
</span><span class='line'>        - "traefik.enable=true"
</span><span class='line'>        - "traefik.backend=ghost"
</span><span class='line'>        - "traefik.backend.loadbalancer.swarm=true"
</span><span class='line'>        - "traefik.docker.network=appnet"
</span><span class='line'>        - "traefik.port=2368"
</span><span class='line'>        - "traefik.frontend.passHostHeader=true"
</span><span class='line'>        - "traefik.frontend.rule=Host:myblog.pistack.co.za"
</span><span class='line'>      replicas: 3
</span><span class='line'>      update_config:
</span><span class='line'>        parallelism: 2
</span><span class='line'>        delay: 10s
</span><span class='line'>      restart_policy:
</span><span class='line'>        condition: on-failure
</span><span class='line'>      placement:
</span><span class='line'>        constraints: [node.role == worker]
</span><span class='line'>
</span><span class='line'>networks:
</span><span class='line'>  appnet:
</span><span class='line'>    external: true</span></code></pre></td></tr></table></div></figure>


<p>Deploy the stack:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker stack deploy -c ghost-compose.yml web</span></code></pre></td></tr></table></div></figure>


<p>Once the service is up, you will be able to reach your blog on the provided <code>traefik.frontend.rule</code>. If you don&rsquo;t have traefik running, you can follow <a href="https://blog.ruanbekker.com/blog/2018/10/23/build-a-traefik-proxy-image-for-your-raspberry-pi-on-docker-swarm/">this post</a> to get traefik up and running.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://hub.docker.com/r/rbekker87/armhf-ghost/">https://hub.docker.com/r/rbekker87/armhf-ghost/</a></li>
<li><a href="https://github.com/ruanbekker/ghost-armhf">https://github.com/ruanbekker/ghost-armhf</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/23/build-a-traefik-proxy-image-for-your-raspberry-pi-on-docker-swarm/">Build a Traefik Proxy Image for Your Raspberry Pi on Docker Swarm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-23T17:31:02-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2018</span></span> <span class='time'>5:31 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://objects.ruanbekker.com/assets/images/traefik-logo-routing.png" alt="" /></p>

<p>In this post we will setup a Docker Image for Traefik Proxy on the ARM Architecture, specifically on the Raspberry Pi, which we will deploy to our Raspberry Pi Docker Swarm.</p>

<p>Then we will build and push our image to a registry, then setup traefik and also setup a web application that sits behind our Traefik Proxy.</p>

<h2>What is Traefik</h2>

<p><a href="https://traefik.io/">Traefik</a> is a modern load balancer and reverse proxy built for micro services.</p>

<h2>Dockerfile</h2>

<p>We will be running Traefik on Alpine 3.8:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='dockerfile'><span class='line'><span class="k">FROM</span> rbekker87/armhf-alpine:3.8
</span><span class='line'>
</span><span class='line'><span class="k">ENV</span> TRAEFIK_VERSION 1.7.0-rc3
</span><span class='line'><span class="k">ENV</span> ARCH arm
</span><span class='line'>
</span><span class='line'><span class="k">ADD</span> https://github.com/containous/traefik/releases/download/v<span class="k">${</span><span class="nv">TRAEFIK_VERSION</span><span class="k">}</span>/traefik_linux-<span class="k">${</span><span class="nv">ARCH</span><span class="k">}</span> /traefik
</span><span class='line'>
</span><span class='line'><span class="k">RUN</span> apk add --no-cache ca-certificates <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> chmod +x /traefik <span class="err">\</span>
</span><span class='line'>    <span class="o">&amp;&amp;</span> rm -rf /var/cache/apk/*
</span><span class='line'>
</span><span class='line'><span class="k">EXPOSE</span> <span class="m">80</span> <span class="m">8080</span> <span class="m">443</span>
</span><span class='line'>
</span><span class='line'><span class="k">ENTRYPOINT</span> <span class="o">[</span><span class="s2">&quot;/traefik&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Build and Push</h2>

<p>Build and Push your image to your registry of choice:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker build -t your-user/repo:tag .
</span><span class='line'><span class="nv">$ </span>docker push your-user/repo:tag
</span></code></pre></td></tr></table></div></figure>


<p>If you do not want to push to a registry, I have a public image available at <a href="https://hub.docker.com/r/rbekker87/armhf-traefik/">https://hub.docker.com/r/rbekker87/armhf-traefik/</a>, the image itself is <code>rbekker87/armhf-traefik:1.7.0-rc3</code></p>

<h2>Deploy Traefik to the Swarm</h2>

<p>From our <code>traefik-compose.yml</code>, you will notice that I have set that our network is external, so the network should exist prior to deploying the stack.</p>

<p>Let&rsquo;s create the overlay network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create --driver overlay appnet
</span></code></pre></td></tr></table></div></figure>


<p>Below, the <code>traefik-compose.yml</code>, note that I&rsquo;m using pistack.co.za as my domain:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.4&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">traefik</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbekker87/armhf-traefik:1.7.0-rc3</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;--api&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;--docker&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;--docker.swarmmode&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;--docker.domain=pistack.co.za&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;--docker.watch&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;--logLevel=DEBUG&quot;</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="s">&quot;--web&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">80:80</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:8080</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">global</span>
</span><span class='line'>      <span class="l-Scalar-Plain">restart_policy</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">condition</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">on-failure</span>
</span><span class='line'>      <span class="l-Scalar-Plain">placement</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">node.role == manager</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">appnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c traefik-compose.yml proxy
</span></code></pre></td></tr></table></div></figure>


<p>List the stacks:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack ls
</span><span class='line'>NAME                SERVICES
</span><span class='line'>proxy               1
</span></code></pre></td></tr></table></div></figure>


<p>Check if the services in your stack is running. Since our deploy mode was global, there will be a replica running on each node, and in my swarm I&rsquo;ve got 3 nodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack services proxy
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE                    PORTS
</span><span class='line'>16x31j7o0f0r        proxy_traefik       global              3/3                 rbekker87/armhf-traefik:1.7.0-rc3   *:80-&gt;80/tcp,*:8080-&gt;8080/tcp
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy a Web Service hooked up to Traefik</h2>

<p>Pre-Requirement:</p>

<p>To register subdomains on the fly, set you DNS for your domain to the following (im using pistack.co.za in this example):</p>

<ul>
<li><code>pistack.co.za</code> <code>A</code> <code>x.x.x.x</code></li>
<li><code>*.pistack.co.za</code> <code>A</code> <code>x.x.x.x</code></li>
</ul>


<p>Next, we will deploy we app that will be associated to our Traefik service domain, so we will inform Traefik that our web app fqdn and port that will be registered with the proxy.</p>

<p>Our <code>app-compose.yml</code> file for our webapp:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&quot;3.4&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">whoami</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbekker87/golang-whoami:alpine-amrhf</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.backend=whoami&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.port=80&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;traefik.frontend.rule=Host:whoami.pistack.co.za&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">update_config</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">parallelism</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>        <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">restart_policy</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">condition</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">on-failure</span>
</span><span class='line'>      <span class="l-Scalar-Plain">placement</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">node.role == worker</span><span class="p-Indicator">]</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthcheck</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nc -vz 127.0.0.1 80 || exit 1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">60s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3s</span>
</span><span class='line'>      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">appnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the above compose, you will notice that our traefik backend is set to our service name, our port is the port that the proxy will forward requests to the containers port, since the proxy and the whoami container is in the same network, they will be able to communicate with each other. Then we also have our frontend rule which will be the endpoint we will reach our application on.</p>

<p>Deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c whoami.yml web
</span><span class='line'>Creating service web_whoami
</span></code></pre></td></tr></table></div></figure>


<p>List the tasks running in our web stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack services web
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE                                  PORTS
</span><span class='line'>31ylfcfb7uyw        web_whoami          replicated          3/3                 rbekker87/golang-whoami:alpine-amrhf
</span></code></pre></td></tr></table></div></figure>


<p>Once all the replicas is running, move along to test the application</p>

<h2>Testing our Application:</h2>

<p>I have 3 replicas each running on their own container, so each container will respond with its own hostname:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ps web_whoami
</span><span class='line'>ID                  NAME                IMAGE                                  NODE                DESIRED STATE       CURRENT STATE            ERROR                              PORTS
</span><span class='line'>ivn8fgfosvgd        web_whoami.1        rbekker87/golang-whoami:alpine-amrhf   rpi-01              Running             Running <span class="m">26</span> minutes ago
</span><span class='line'>rze6u6z56aop        web_whoami.2        rbekker87/golang-whoami:alpine-amrhf   rpi-02              Running             Running <span class="m">26</span> minutes ago
</span><span class='line'>6fjua869r498        web_whoami.3        rbekker87/golang-whoami:alpine-amrhf   rpi-04              Running             Running <span class="m">23</span> minutes ago
</span></code></pre></td></tr></table></div></figure>


<p>Making our 1st GET request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ $ </span>curl http://whoami.pistack.co.za/
</span><span class='line'>Hostname: 43f5f0a6682f
</span><span class='line'>IP: 127.0.0.1
</span><span class='line'>IP: 10.0.0.138
</span><span class='line'>IP: 10.0.0.218
</span><span class='line'>IP: 172.18.0.4
</span><span class='line'>GET / HTTP/1.1
</span><span class='line'>Host: whoami.pistack.co.za
</span><span class='line'>User-Agent: curl/7.38.0
</span><span class='line'>Accept: */*
</span><span class='line'>Accept-Encoding: gzip
</span><span class='line'>X-Forwarded-For: 165.73.96.95, 10.255.0.2
</span><span class='line'>X-Forwarded-Host: whoami.pistack.co.za
</span><span class='line'>X-Forwarded-Port: 80
</span><span class='line'>X-Forwarded-Proto: http
</span><span class='line'>X-Forwarded-Server: 31b37f9714d3
</span><span class='line'>X-Real-Ip: 10.255.0.2
</span></code></pre></td></tr></table></div></figure>


<p>Our 2nd GET Request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://whoami.pistack.co.za/
</span><span class='line'>Hostname: d1c17a476414
</span><span class='line'>IP: 127.0.0.1
</span><span class='line'>IP: 10.0.0.138
</span><span class='line'>IP: 10.0.0.71
</span><span class='line'>IP: 172.19.0.5
</span><span class='line'>GET / HTTP/1.1
</span><span class='line'>Host: whoami.pistack.co.za
</span><span class='line'>User-Agent: curl/7.38.0
</span><span class='line'>Accept: */*
</span><span class='line'>Accept-Encoding: gzip
</span><span class='line'>X-Forwarded-For: 165.73.96.95, 10.255.0.2
</span><span class='line'>X-Forwarded-Host: whoami.pistack.co.za
</span><span class='line'>X-Forwarded-Port: 80
</span><span class='line'>X-Forwarded-Proto: http
</span><span class='line'>X-Forwarded-Server: 02b0ff6eab73
</span><span class='line'>X-Real-Ip: 10.255.0.2
</span></code></pre></td></tr></table></div></figure>


<p>And our 3rd GET Request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://whoami.pistack.co.za/
</span><span class='line'>Hostname: 17c817a1813b
</span><span class='line'>IP: 172.18.0.6
</span><span class='line'>IP: 127.0.0.1
</span><span class='line'>IP: 10.0.0.138
</span><span class='line'>IP: 10.0.0.73
</span><span class='line'>GET / HTTP/1.1
</span><span class='line'>Host: whoami.pistack.co.za
</span><span class='line'>User-Agent: curl/7.38.0
</span><span class='line'>Accept: */*
</span><span class='line'>Accept-Encoding: gzip
</span><span class='line'>X-Forwarded-For: 165.73.96.95, 10.255.0.2
</span><span class='line'>X-Forwarded-Host: whoami.pistack.co.za
</span><span class='line'>X-Forwarded-Port: 80
</span><span class='line'>X-Forwarded-Proto: http
</span><span class='line'>X-Forwarded-Server: 31b37f9714d3
</span><span class='line'>X-Real-Ip: 10.255.0.2
</span></code></pre></td></tr></table></div></figure>


<p>Hope this was useful.</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://hub.docker.com/r/rbekker87/armhf-traefik/tags/">https://hub.docker.com/r/rbekker87/armhf-traefik/tags/</a></li>
<li><a href="https://github.com/containous/traefik/releases">https://github.com/containous/traefik/releases</a></li>
<li><a href="https://github.com/ruanbekker/traefik-armhf/blob/master/Dockerfile">https://github.com/ruanbekker/traefik-armhf/blob/master/Dockerfile</a></li>
</ul>


<script type="text/javascript">
  ( function() {
    if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"calltype":"async[2]","publisher":"rbekker87","width":728,"height":90,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
</script>


<script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>


<p></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/23/building-a-raspberry-pi-nginx-image-with-caching-on-alpine-for-docker-swarm/">Building a Raspberry Pi Nginx Image With Caching on Alpine for Docker Swarm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-23T17:00:02-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2018</span></span> <span class='time'>5:00 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this guide, we will be creating a nginx reverse proxy with the ability to cache static content using a alpine image.</p>

<p>We will then push the image to gitlab&rsquo;s private registry, and then run the service on docker swarm.</p>

<h2>Create the backend service:</h2>

<p>We will upstream to our blog using ghost, which you can deploy using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service create --name blog --network docknet rbekker87/armhf-ghost:2.0.3
</span></code></pre></td></tr></table></div></figure>


<h2>Current File Structure:</h2>

<p>Our file structure for the assets we need to build the reverse proxy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>find .
</span><span class='line'>./conf.d
</span><span class='line'>./conf.d/blog.conf
</span><span class='line'>./Dockerfile
</span><span class='line'>./nginx.conf
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>Dockerfile</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM hypriot/rpi-alpine-scratch
</span><span class='line'>MAINTAINER Ruan Bekker
</span><span class='line'>
</span><span class='line'>RUN apk update <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    apk add nginx <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    rm -rf /etc/nginx/nginx.conf <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    chown -R nginx:nginx /var/lib/nginx <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    rm -rf /var/cache/apk/*
</span><span class='line'>
</span><span class='line'>ADD nginx.conf /etc/nginx/
</span><span class='line'>ADD conf.d/blog.conf /etc/nginx/conf.d/
</span><span class='line'>
</span><span class='line'>EXPOSE 80
</span><span class='line'>
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;nginx&quot;</span>, <span class="s2">&quot;-g&quot;</span>, <span class="s2">&quot;daemon off;&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>nginx.conf</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>user nginx<span class="p">;</span>
</span><span class='line'>worker_processes 1<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>    worker_connections 1024<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>error_log  /var/log/nginx/nginx_error.log warn<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    sendfile        on<span class="p">;</span>
</span><span class='line'>    tcp_nodelay         on<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    gzip              on<span class="p">;</span>
</span><span class='line'>    gzip_http_version 1.0<span class="p">;</span>
</span><span class='line'>    gzip_proxied      any<span class="p">;</span>
</span><span class='line'>    gzip_min_length   500<span class="p">;</span>
</span><span class='line'>    gzip_disable      <span class="s2">&quot;MSIE [1-6]\.&quot;</span><span class="p">;</span>
</span><span class='line'>    gzip_types        text/plain text/xml text/css
</span><span class='line'>                      text/comma-separated-values
</span><span class='line'>                      text/javascript
</span><span class='line'>                      application/x-javascript
</span><span class='line'>                      application/atom+xml<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    log_format  main  <span class="s1">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
</span><span class='line'>                      <span class="s1">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    access_log  /var/log/nginx/access.log  main<span class="p">;</span>
</span><span class='line'>    error_log   /var/log/nginx/error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    proxy_cache_path /var/cache/nginx/ <span class="nv">levels</span><span class="o">=</span>1:2 <span class="nv">keys_zone</span><span class="o">=</span>nginx_cache:5m <span class="nv">max_size</span><span class="o">=</span>128m <span class="nv">inactive</span><span class="o">=</span>60m<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    keepalive_timeout  60<span class="p">;</span>
</span><span class='line'>    server_tokens      off<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    include /etc/nginx/conf.d/*.conf<span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hostname resolution to our Ghost Blog Service: In our swarm we have a service called blog which is associated to the docknet network, so the dns resolution will resolve to the vip of the service. As seen in the figure below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ls
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE                                                    PORTS
</span><span class='line'>nq42a6jfwx3d        blog                replicated          1/1                 rbekker87/armhf-ghost:2.0.3
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>conf.d/blog.conf</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>upstream ghost_blog <span class="o">{</span>
</span><span class='line'>    server blog:2368<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>    listen 80<span class="p">;</span>
</span><span class='line'>    server_name blog.yourdomain.com<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    access_log  /var/log/nginx/blog_access.log  main<span class="p">;</span>
</span><span class='line'>    error_log   /var/log/nginx/blog_error.log<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    location / <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        proxy_cache                 nginx_cache<span class="p">;</span>
</span><span class='line'>        add_header                  X-Proxy-Cache <span class="nv">$upstream_cache_status</span><span class="p">;</span>
</span><span class='line'>        proxy_ignore_headers        Cache-Control<span class="p">;</span>
</span><span class='line'>        proxy_cache_valid any       10m<span class="p">;</span>
</span><span class='line'>        proxy_cache_use_stale       error timeout http_500 http_502 http_503 http_504<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        proxy_pass                  http://ghost_blog<span class="p">;</span>
</span><span class='line'>        proxy_redirect              off<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        proxy_set_header            Host <span class="nv">$host</span><span class="p">;</span>
</span><span class='line'>        proxy_set_header            X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        proxy_set_header            X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>        proxy_set_header            X-Forwarded-Host <span class="nv">$server_name</span><span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Building the Image and Pushing to Gitlab</h2>

<p>I&rsquo;m using Gitlab in this demonstration, but you can use the registry of your choice:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker login registry.gitlab.com
</span><span class='line'><span class="nv">$ </span>docker build -t registry.gitlab.com/user/docker/arm-nginx:caching .
</span><span class='line'><span class="nv">$ </span>docker tag registry.gitlab.com/user/docker/arm-nginx:caching registry.gitlab.com/user/docker/arm-nginx:caching
</span><span class='line'><span class="nv">$ </span>docker push registry.gitlab.com/user/docker/arm-nginx:caching
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy</h2>

<p>Create the Nginx Reverse Proxy Service on Docker Swarm:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service create --name nginx_proxy <span class="se">\</span>
</span><span class='line'>--network docknet <span class="se">\</span>
</span><span class='line'>--publish 80:80 <span class="se">\</span>
</span><span class='line'>--replicas <span class="m">1</span> <span class="se">\</span>
</span><span class='line'>--with-registry-auth registry.gitlab.com/user/docker/arm-nginx:caching
</span></code></pre></td></tr></table></div></figure>


<p>Listing our Services:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ls
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE                                                    PORTS
</span><span class='line'>je7x21l7egoh        nginx_proxy         replicated          1/1                 registry.gitlab.com/user/docker/arm-nginx:caching   *:80-&gt;80/tcp
</span><span class='line'>nq42a6jfwx3d        blog                replicated          1/1                 rbekker87/armhf-ghost:2.0.3
</span></code></pre></td></tr></table></div></figure>


<p>Once you access your proxy on port 80, you should see your Ghost Blog Homepage like below:</p>

<p><img src="https://objects.ruanbekker.com/assets/images/ghost-blog-main.png" alt="" /></p>

<p>Have a look at the <a href="https://blog.ruanbekker.com/blog/2018/10/23/nginx-caching-performance-for-static-content-on-docker-swarm-with-raspberrypi/">benchmark performance</a> when using Nginx with caching enabled</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://hub.docker.com/r/rbekker87/armhf-ghost/">https://hub.docker.com/r/rbekker87/armhf-ghost/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/23/nginx-caching-performance-for-static-content-on-docker-swarm-with-raspberrypi/">Nginx Caching Performance for Static Content on Docker Swarm With RaspberryPi</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2018-10-23T16:41:41-04:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2018</span></span> <span class='time'>4:41 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://objects.ruanbekker.com/assets/images/nginx-logo.png" alt="" /></p>

<h2>The Environment:</h2>

<p>I had my Ghost Blog listening on port 2368 and exposing port 80 on Docker so that the port translation directs port 80 traffic to port 2368 on Ghost directly.</p>

<p>Alex responded on my tweet and introduced Nginx Caching:</p>

<ul>
<li><a href="https://twitter.com/alexellisuk/status/882347698636165121">https://twitter.com/alexellisuk/status/882347698636165121</a></li>
</ul>


<p><img src="https://objects.ruanbekker.com/assets/images/tweet-alexellis-04072017.png" alt="" /></p>

<p>With this approach benchmarking results was not so great in terms of requests per second, and as this hostname will be only used for a blog, its a great idea to cache the content, this was achieved with the help from Alex&rsquo;s blog: <a href="https://blog.alexellis.io/save-and-boost-with-nginx/">blog.alexellis.io/save-and-boost-with-nginx/</a></p>

<h2>How Nginx was Configured:</h2>

<p>I have a <a href="http://rbkr.ddns.net/building-nginx-on-alpine-image-for-docker-swarm-with-caching-enabled-config/">blogpost</a> on how I setup Nginx on an Alpine Image, where I setup caching and proxy-pass the connections through to my ghost blog.</p>

<h2>Benchmarking: Before Nginx with Caching was Implemented:</h2>

<p>When doing an apache benchmark I got <b>9.31 requests per second</b> performing the test on my LAN:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ab -n <span class="m">500</span> -c <span class="m">10</span> http://rbkr.ddns.net/
</span><span class='line'>
</span><span class='line'>This is ApacheBench, Version 2.3 &lt;<span class="nv">$Revision</span>: <span class="m">1706008</span> <span class="nv">$&gt;</span>
</span><span class='line'>Copyright <span class="m">1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span><span class='line'>Licensed to The Apache Software Foundation, http://www.apache.org/
</span><span class='line'>
</span><span class='line'>Benchmarking rbkr.ddns.net <span class="o">(</span>be patient<span class="o">)</span>
</span><span class='line'>Completed <span class="m">100</span> requests
</span><span class='line'>Completed <span class="m">200</span> requests
</span><span class='line'>Completed <span class="m">300</span> requests
</span><span class='line'>Completed <span class="m">400</span> requests
</span><span class='line'>Completed <span class="m">500</span> requests
</span><span class='line'>Finished <span class="m">500</span> requests
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Server Software:
</span><span class='line'>Server Hostname:        blog.pistack.co.za
</span><span class='line'>Server Port:            80
</span><span class='line'>
</span><span class='line'>Document Path:          /
</span><span class='line'>Document Length:        <span class="m">5470</span> bytes
</span><span class='line'>
</span><span class='line'>Concurrency Level:      10
</span><span class='line'>Time taken <span class="k">for</span> tests:   53.725 seconds
</span><span class='line'>Complete requests:      500
</span><span class='line'>Failed requests:        0
</span><span class='line'>Total transferred:      <span class="m">2863000</span> bytes
</span><span class='line'>HTML transferred:       <span class="m">2735000</span> bytes
</span><span class='line'>Requests per second:    9.31 <span class="o">[</span><span class="c">#/sec] (mean)</span>
</span><span class='line'>Time per request:       1074.501 <span class="o">[</span>ms<span class="o">]</span> <span class="o">(</span>mean<span class="o">)</span>
</span><span class='line'>Time per request:       107.450 <span class="o">[</span>ms<span class="o">]</span> <span class="o">(</span>mean, across all concurrent requests<span class="o">)</span>
</span><span class='line'>Transfer rate:          52.04 <span class="o">[</span>Kbytes/sec<span class="o">]</span> received
</span><span class='line'>
</span><span class='line'>Connection Times <span class="o">(</span>ms<span class="o">)</span>
</span><span class='line'>              min  mean<span class="o">[</span>+/-sd<span class="o">]</span> median   max
</span><span class='line'>Connect:        <span class="m">1</span>    <span class="m">2</span>   0.5      <span class="m">2</span>       6
</span><span class='line'>Processing:   <span class="m">685</span> <span class="m">1068</span>  68.7   <span class="m">1057</span>    1306
</span><span class='line'>Waiting:      <span class="m">683</span> <span class="m">1067</span>  68.6   <span class="m">1056</span>    1306
</span><span class='line'>Total:        <span class="m">689</span> <span class="m">1070</span>  68.7   <span class="m">1058</span>    1312
</span><span class='line'>
</span><span class='line'>Percentage of the requests served within a certain <span class="nb">time</span> <span class="o">(</span>ms<span class="o">)</span>
</span><span class='line'>  50%   1058
</span><span class='line'>  66%   1088
</span><span class='line'>  75%   1102
</span><span class='line'>  80%   1110
</span><span class='line'>  90%   1163
</span><span class='line'>  95%   1218
</span><span class='line'>  98%   1240
</span><span class='line'>  99%   1247
</span><span class='line'> 100%   <span class="m">1312</span> <span class="o">(</span>longest request<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Benchmarking: After Nginx Caching was Implemented:</h2>

<p>After Nginx Caching was Implemented, I got <b>1067.73 requests per second</b> using apache benchmark over a LAN connection! Absolutely awesome!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ab -n <span class="m">500</span> -c <span class="m">10</span> http://blog.pistack.co.za/
</span><span class='line'>This is ApacheBench, Version 2.3 &lt;<span class="nv">$Revision</span>: <span class="m">1706008</span> <span class="nv">$&gt;</span>
</span><span class='line'>Copyright <span class="m">1996</span> Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
</span><span class='line'>Licensed to The Apache Software Foundation, http://www.apache.org/
</span><span class='line'>
</span><span class='line'>Benchmarking blog.pistack.co.za <span class="o">(</span>be patient<span class="o">)</span>
</span><span class='line'>Completed <span class="m">100</span> requests
</span><span class='line'>Completed <span class="m">200</span> requests
</span><span class='line'>Completed <span class="m">300</span> requests
</span><span class='line'>Completed <span class="m">400</span> requests
</span><span class='line'>Completed <span class="m">500</span> requests
</span><span class='line'>Finished <span class="m">500</span> requests
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Server Software:        nginx
</span><span class='line'>Server Hostname:        blog.pistack.co.za
</span><span class='line'>Server Port:            80
</span><span class='line'>
</span><span class='line'>Document Path:          /
</span><span class='line'>Document Length:        <span class="m">5470</span> bytes
</span><span class='line'>
</span><span class='line'>Concurrency Level:      10
</span><span class='line'>Time taken <span class="k">for</span> tests:   0.468 seconds
</span><span class='line'>Complete requests:      500
</span><span class='line'>Failed requests:        0
</span><span class='line'>Total transferred:      <span class="m">2880500</span> bytes
</span><span class='line'>HTML transferred:       <span class="m">2735000</span> bytes
</span><span class='line'>Requests per second:    1067.73 <span class="o">[</span><span class="c">#/sec] (mean)</span>
</span><span class='line'>Time per request:       9.366 <span class="o">[</span>ms<span class="o">]</span> <span class="o">(</span>mean<span class="o">)</span>
</span><span class='line'>Time per request:       0.937 <span class="o">[</span>ms<span class="o">]</span> <span class="o">(</span>mean, across all concurrent requests<span class="o">)</span>
</span><span class='line'>Transfer rate:          6007.05 <span class="o">[</span>Kbytes/sec<span class="o">]</span> received
</span><span class='line'>
</span><span class='line'>Connection Times <span class="o">(</span>ms<span class="o">)</span>
</span><span class='line'>              min  mean<span class="o">[</span>+/-sd<span class="o">]</span> median   max
</span><span class='line'>Connect:        <span class="m">3</span>    <span class="m">4</span>   1.4      <span class="m">4</span>      10
</span><span class='line'>Processing:     <span class="m">3</span>    <span class="m">5</span>   1.6      <span class="m">4</span>      10
</span><span class='line'>Waiting:        <span class="m">2</span>    <span class="m">4</span>   1.6      <span class="m">4</span>      10
</span><span class='line'>Total:          <span class="m">6</span>    <span class="m">9</span>   2.7      <span class="m">8</span>      17
</span><span class='line'>
</span><span class='line'>Percentage of the requests served within a certain <span class="nb">time</span> <span class="o">(</span>ms<span class="o">)</span>
</span><span class='line'>  50%      8
</span><span class='line'>  66%      8
</span><span class='line'>  75%      9
</span><span class='line'>  80%      9
</span><span class='line'>  90%     15
</span><span class='line'>  95%     15
</span><span class='line'>  98%     15
</span><span class='line'>  99%     16
</span><span class='line'> 100%     <span class="m">17</span> <span class="o">(</span>longest request<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<p>Thanks to Alex Ellis for the suggestion on this, and definitely have a look at <a href="https://blog.alexellis.io/tag/nginx/">blog.alexellis.io</a> as he has some epic content on his blog!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/7">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/5">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/03/27/concourse-pipeline-to-build-a-docker-image-automatically-on-git-commit/">Concourse Pipeline to Build a Docker Image Automatically on Git Commit</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/03/27/ship-your-logs-to-elasticsearch-with-filebeat/">Ship Your Logs to Elasticsearch With Filebeat</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/03/21/how-to-deploy-a-docker-swarm-cluster-on-scaleway-with-terraform/">How to Deploy a Docker Swarm Cluster on Scaleway With Terraform</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/03/20/deploy-scaleway-servers-via-the-api-in-python/">Deploy Scaleway Servers via the API in Python</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/03/18/setup-nrpe-client-and-server-for-monitoring-remote-services-in-nagios/">Setup NRPE Client and Server for Monitoring Remote Services in Nagios</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>

</body>
</html>
