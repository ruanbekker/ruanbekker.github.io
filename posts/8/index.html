
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="When you format / reload a server and the host gets the same IP, when you try to SSH to that host, you might get a warning like this: 1
2
3
4
5
6
7
8 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  
  <link rel="canonical" href="http://blog.ruanbekker.com/posts/8/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My HowTo Blog</a></li>
  <li><a href="/awesome-links/">Awesome Links</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/12/13/ssh-host-key-warnings-with-strict-checking-enabled/">SSH Host Key Warnings With Strict Checking Enabled</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-12-13T02:07:29-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:07 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When you format / reload a server and the host gets the same IP, when you try to SSH to that host, you might get a warning like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh 192.168.1.104
</span><span class='line'>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span><span class='line'>@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
</span><span class='line'>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span><span class='line'>IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
</span><span class='line'>Someone could be eavesdropping on you right now <span class="o">(</span>man-in-the-middle attack<span class="o">)</span>!
</span><span class='line'>It is also possible that a host key has just been changed.
</span><span class='line'>The fingerprint <span class="k">for</span> the ECDSA key sent by the remote host is
</span><span class='line'>a1:a2:a3:a4:a5:a6:a7:a8:a9:b0:b1:b2:b3:b4:b5:b6.
</span><span class='line'>Please contact your system administrator.
</span><span class='line'>Add correct host key in /home/pi/.ssh/known_hosts to get rid of this message.
</span><span class='line'>Offending ECDSA key in /home/pi/.ssh/known_hosts:10
</span><span class='line'>ECDSA host key <span class="k">for</span> 192.168.1.104 has changed and you have requested strict checking.
</span><span class='line'>Host key verification failed.
</span></code></pre></td></tr></table></div></figure>


<p>This is because we have <code>StrictMode</code> enabled in our SSH Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/ssh/sshd_config <span class="p">|</span> grep -i stric
</span><span class='line'>StrictModes yes
</span></code></pre></td></tr></table></div></figure>


<p>To remove the offending key from your <code>known_hosts</code> file, without opening it, you can use <code>ssh-keygen</code> to remove it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ssh-keygen -f .ssh/known_hosts -R 192.168.1.104
</span><span class='line'><span class="c"># Host 192.168.1.104 found: line 10 type ECDSA</span>
</span><span class='line'>.ssh/known_hosts updated.
</span><span class='line'>Original contents retained as .ssh/known_hosts.old
</span></code></pre></td></tr></table></div></figure>


<p>Now when you SSH the warning should be removed.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/12/11/setup-a-3-node-kubernetes-cluster-on-ubuntu/">Setup a 3 Node Kubernetes Cluster on Ubuntu</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-12-11T09:31:47-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>11</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>9:31 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://kumorilabs.com/img/blog/kubernetes-logo.png" alt="" /></p>

<p>Setup a 3 Node Kubernetes Cluster on Ubuntu 16.04</p>

<h2>What is Kubernetes?</h2>

<p>As referenced from their <a href="https://kubernetes.io/">website</a>:</p>

<ul>
<li>&ldquo;Kubernetes is an open-source system for automating deployment, scaling, and management of containerized applications.&rdquo;</li>
</ul>


<h2>Our Setup:</h2>

<p>For this setup I will be using 3 AWS EC2 Instances with Ubuntu 16.04. One node will act as the master node, and the other 2 nodes, will act as nodes, previously named minions.</p>

<p>We will deploy Kubernetes on all 3 nodes, the master will be the node where we will initialize our cluster, deploy our weave network, applications and we will execute the join command on the worker nodes to join the master to form the cluster.</p>

<h2>Deploy Kubernetes: Master</h2>

<p>The following commands will be used to install Kubernetes, it will be executed with root permissions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span><span class='line'><span class="nv">$ </span>sudo apt install docker.io apt-transport-https -qy
</span><span class='line'><span class="nv">$ </span>sudo apt update
</span><span class='line'><span class="nv">$ </span>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class="p">|</span> sudo apt-key add -
</span><span class='line'><span class="nv">$ </span>sudo su -c <span class="s1">&#39;echo &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot; &gt; /etc/apt/sources.list.d/app&#39;</span> root
</span><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>sudo apt install kubelet kubeadm kubernetes-cni -y
</span></code></pre></td></tr></table></div></figure>


<p>Now we would like to set up the master by initializing the cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo kubeadm init --kubernetes-version stable-1.8
</span></code></pre></td></tr></table></div></figure>


<p>The output will provide you with instructions to setup the configurations for the master node, and provide you with a join token for your worker nodes, remember to make not of this token string, as we will need it later for our worker nodes. As your normal user, run the following to setup the config:</p>

<p>Remember to not run this as root, and as the normal user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p <span class="nv">$HOME</span>/.kube
</span><span class='line'><span class="nv">$ </span>sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span><span class='line'><span class="nv">$ </span>sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></code></pre></td></tr></table></div></figure>


<p>Now we need to deploy a network for our pods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>kubectl apply -f <span class="s2">&quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#39;\n&#39;)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lets confirm if all our resources are in its desired state, a small snippet of the output will look like the one below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>kubectl get all -n kube-system
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>NAME                                          READY     STATUS    RESTARTS   AGE
</span><span class='line'>po/etcd-ip-172-31-40-211                      1/1       Running   <span class="m">0</span>          6h
</span><span class='line'>po/kube-apiserver-ip-172-31-40-211            1/1       Running   <span class="m">0</span>          6h
</span></code></pre></td></tr></table></div></figure>


<p>Once all of the resources are in its desired state, we can head along to our worker nodes, to join them to the cluster</p>

<h2>Deploy Kubernetes: Worker Nodes</h2>

<p>As I have 2 worker nodes, we will need to deploy the following on both of our worker nodes, first to deploy Kubernetes on our nodes with root permission:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span><span class='line'><span class="nv">$ </span>sudo apt install docker.io apt-transport-https -qy
</span><span class='line'><span class="nv">$ </span>sudo apt update
</span><span class='line'><span class="nv">$ </span>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class="p">|</span> sudo apt-key add -
</span><span class='line'><span class="nv">$ </span>sudo su -c <span class="s1">&#39;echo &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot; &gt; /etc/apt/sources.list.d/app&#39;</span> root
</span><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>sudo apt install kubelet kubeadm kubernetes-cni -y
</span></code></pre></td></tr></table></div></figure>


<p>Once Kubernetes is installed, join the Master node by executing the join command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo kubeadm join --token 49abf7.247d663db97f8504 172.31.40.211:6443 --discovery-token-ca-cert-hash sha256:3a3b301cfbac0995c69a0115989ea384230470d6836ae0e13e71dbdf15ffbb48
</span></code></pre></td></tr></table></div></figure>


<p>Do the 2 steps on the other node, then head back to the master node.</p>

<h2>Verifying if All Nodes are Checked In</h2>

<p>To verify if all nodes are available and reachable in the cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>kubectl get nodes
</span><span class='line'>NAME               STATUS    ROLES     AGE       VERSION
</span><span class='line'>ip-172-31-36-68    Ready     &lt;none&gt;    6h        v1.8.5
</span><span class='line'>ip-172-31-40-211   Ready     master    6h        v1.8.5
</span><span class='line'>ip-172-31-44-80    Ready     &lt;none&gt;    6h        v1.8.5
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy Services to Kubernetes:</h2>

<p>Kubernetes has Awesome Examples on their <a href="https://github.com/kubernetes/kubernetes/tree/master/examples">Github Repository</a>.</p>

<p>Since the awesomeness of <a href="https://github.com/openfaas">OpenFaas</a>, I will deploy OpenFaas on Kubernetes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git clone https://github.com/openfaas/faas-netes
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>faas-netes
</span><span class='line'><span class="nv">$ </span>kubectl apply -f faas.yml,monitoring.yml,rbac.yml
</span></code></pre></td></tr></table></div></figure>


<p>Give it about a minute or so, then you should see the pods running in their desired state:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>kubectl get pods
</span><span class='line'>NAME                           READY     STATUS    RESTARTS   AGE
</span><span class='line'>alertmanager-77b4b476b-zxtcz   1/1       Running   <span class="m">0</span>          4h
</span><span class='line'>crypto-7d8b7f999c-7l85k        1/1       Running   <span class="m">0</span>          1h
</span><span class='line'>faas-netesd-64fb9b4dfb-hc8gh   1/1       Running   <span class="m">0</span>          4h
</span><span class='line'>gateway-69c9d949f-q57zh        1/1       Running   <span class="m">0</span>          4h
</span><span class='line'>prometheus-7fbfd8bfb8-d4cft    1/1       Running   <span class="m">0</span>          4h
</span></code></pre></td></tr></table></div></figure>


<p>When we have the desired state, head over to the OpenFaas Gateway WebUI: <code>http://master-public-ip:31112/ui/</code>, select &ldquo;Deploy New Function&rdquo;, you can use your own function or select one from the store.</p>

<p>I am going to use Figlet from the store, once the pod has been deployed, select the function, enter any text into the request body and select invoke. I have used my name and surname, and turns out into:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> ____                      ____       _    _
</span><span class='line'><span class="p">|</span>  _ <span class="se">\ </span>_   _  __ _ _ __   <span class="p">|</span> __ <span class="o">)</span>  ___<span class="p">|</span> <span class="p">|</span> _<span class="p">|</span> <span class="p">|</span> _____ _ __
</span><span class='line'><span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>/ _<span class="sb">`</span> <span class="p">|</span> <span class="s1">&#39;_ \  |  _ \ / _ \ |/ / |/ / _ \ &#39;</span>__<span class="p">|</span>
</span><span class='line'><span class="p">|</span>  _ &lt;<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span> <span class="o">(</span>_<span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="p">|</span>  __/   &lt;<span class="p">|</span>   &lt;  __/ <span class="p">|</span>
</span><span class='line'><span class="p">|</span>_<span class="p">|</span> <span class="se">\_\\</span>__,_<span class="p">|</span><span class="se">\_</span>_,_<span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>_<span class="p">|</span> <span class="p">|</span>____/ <span class="se">\_</span>__<span class="p">|</span>_<span class="p">|</span><span class="se">\_\_</span><span class="p">|</span><span class="se">\_\_</span>__<span class="p">|</span>_<span class="p">|</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/">Kubernetes Overview</a></li>
<li><a href="https://kubernetes.io/docs/concepts/">Kubernetes Concepts</a></li>
<li><a href="https://blog.alexellis.io/tag/kubernetes/">Kubernetes Blogs</a></li>
<li><a href="https://blog.alexellis.io/tag/openfaas/">OpenFaas Blogs</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/12/10/rejoining-or-bootstrapping-mysql-galera-cluster-nodes-after-shutdown/">Rejoining or Bootstrapping MySQL Galera Cluster Nodes After Shutdown</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-12-10T18:03:44-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>6:03 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have a 3 Node MySQL Galera Cluster that faced a shutdown on all 3 nodes at the same time, luckily this is only a testing environment, but at that time it was down and did not want to start up.</p>

<h2>Issues Faced</h2>

<p>When trying to start MySQL the only error visible was:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/etc/init.d/mysql restart
</span><span class='line'> * MySQL server PID file could not be found!
</span><span class='line'>Starting MySQL
</span><span class='line'>........ * The server quit without updating PID file <span class="o">(</span>/var/run/mysqld/mysqld.pid<span class="o">)</span>.
</span><span class='line'> * Failed to restart server.
</span></code></pre></td></tr></table></div></figure>


<p>At that time I can see that the galera port is started, but not mysql:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ps aux <span class="p">|</span> grep mysql
</span><span class='line'>root     <span class="m">23580</span>  0.0  0.0   <span class="m">4508</span>  <span class="m">1800</span> pts/0    S    00:37   0:00 /bin/sh /usr/bin/mysqld_safe --datadir<span class="o">=</span>/var/lib/mysql --pid-file<span class="o">=</span>/var/run/mysqld/mysqld.pid
</span><span class='line'>mysql    <span class="m">24144</span>  0.7 22.2 <span class="m">1185116</span> <span class="m">455660</span> pts/0  Sl   00:38   0:00 /usr/sbin/mysqld --basedir<span class="o">=</span>/usr --datadir<span class="o">=</span>/var/lib/mysql --plugin-dir<span class="o">=</span>/usr/lib/mysql/plugin --user<span class="o">=</span>mysql --log-error<span class="o">=</span>/var/log/mysql/error.log --pid-file<span class="o">=</span>/var/run/mysqld/mysqld.pid --socket<span class="o">=</span>/var/run/mysqld/mysqld.sock --port<span class="o">=</span><span class="m">3306</span> --wsrep_start_position<span class="o">=</span>long:string
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>netstat -tulpn
</span><span class='line'>Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span><span class='line'>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span><span class='line'>tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:4567            0.0.0.0:*               LISTEN      25507/mysqld
</span></code></pre></td></tr></table></div></figure>


<h2>Why?</h2>

<p>More in detail is explained on a <a href="https://severalnines.com/blog/how-bootstrap-mysqlmariadb-galera-cluster">SeveralNines Blog Post</a>, but due to the fact that all the nodes left the cluster, one of the nodes needs to be started as a referencing point, before the other nodes can rejoin or bootstrapped to the cluster.</p>

<h2>Rejoining the Cluster</h2>

<p>Consult the blog for more information, but from my end, I had a look at the node with the highest seqno and then updated <code>safe_to_bootstrap</code> to <code>1</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /var/lib/mysql/grastate.dat
</span><span class='line'><span class="c"># GALERA saved state</span>
</span><span class='line'>version: 2.1
</span><span class='line'>uuid:    e9f9cf6a-87a1-11e7-9fb4-52612b906897
</span><span class='line'>seqno:   123512
</span><span class='line'>safe_to_bootstrap: 1
</span></code></pre></td></tr></table></div></figure>


<p>Then made sure that no mysql processes are running, then did a bootstrap:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/etc/init.d/mysql bootstrap
</span><span class='line'>Bootstrapping the cluster
</span><span class='line'>Starting MySQL
</span></code></pre></td></tr></table></div></figure>


<p>Then restarted mysql on the other nodes.</p>

<h2>Verifying</h2>

<p>To verify that all your nodes has checked in, I have 3 nodes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="n">STATUS</span> <span class="k">LIKE</span> <span class="s1">&#39;wsrep_%&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span><span class="c1">------------------------------+---------------------------------------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>                <span class="o">|</span> <span class="n">Value</span>                                             <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">------------------------------+---------------------------------------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_local_recv_queue_avg</span>   <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">000000</span>                                          <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_local_state_comment</span>    <span class="o">|</span> <span class="n">Synced</span>                                            <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_incoming_addresses</span>     <span class="o">|</span> <span class="mi">10</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">132</span><span class="p">.</span><span class="mi">91</span><span class="p">:</span><span class="mi">3306</span><span class="p">,</span><span class="mi">10</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">201</span><span class="p">:</span><span class="mi">3306</span><span class="p">,</span><span class="mi">10</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">113</span><span class="p">.</span><span class="mi">21</span><span class="p">:</span><span class="mi">3306</span> <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_evs_state</span>              <span class="o">|</span> <span class="n">OPERATIONAL</span>                                       <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span>           <span class="o">|</span> <span class="mi">3</span>                                                 <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_status</span>         <span class="o">|</span> <span class="k">Primary</span>                                           <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_connected</span>              <span class="o">|</span> <span class="k">ON</span>                                                <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">------------------------------+---------------------------------------------------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>or a shorter version:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SHOW</span> <span class="k">GLOBAL</span> <span class="n">STATUS</span> <span class="k">LIKE</span> <span class="s1">&#39;wsrep_cluster_size&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span><span class="c1">------------------------------+---------------------------------------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>                <span class="o">|</span> <span class="n">Value</span>                                             <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">------------------------------+---------------------------------------------------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span>           <span class="o">|</span> <span class="mi">3</span>                                                 <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">------------------------------+---------------------------------------------------+</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/12/09/unmask-a-masked-service-in-systemd/">Unmask a Masked Service in Systemd</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-12-09T02:02:21-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:02 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was busy setting up a <code>docker-volume-netshare</code> plugin to use NFS Volumes for Docker, which relies on the <code>nfs-utils/nfs-common</code> package, and when trying to start the service, I found that the <code>nfs-common</code> service is <code>masked</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl start docker-volume-netshare.service
</span><span class='line'>Failed to start docker-volume-netshare.service: Unit nfs-common.service is masked.
</span></code></pre></td></tr></table></div></figure>


<p>Looking at the <code>nfs-common</code> service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo systemctl is-enabled nfs-common
</span><span class='line'>masked
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>nfs-common
</span><span class='line'>Synchronizing state of nfs-common.service with SysV service script with /lib/systemd/systemd-sysv-install.
</span><span class='line'>Executing: /lib/systemd/systemd-sysv-install <span class="nb">enable </span>nfs-common
</span><span class='line'>Failed to <span class="nb">enable </span>unit: Unit file /lib/systemd/system/nfs-common.service is masked.
</span></code></pre></td></tr></table></div></figure>


<p>It appears that the unit file has a symbolic link to /dev/null:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>file /lib/systemd/system/nfs-common.service
</span><span class='line'>/lib/systemd/system/nfs-common.service: symbolic link to /dev/null
</span></code></pre></td></tr></table></div></figure>


<p>I was able to unmask the service by removing the file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo rm /lib/systemd/system/nfs-common.service
</span></code></pre></td></tr></table></div></figure>


<p>Then reloading the daemon:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl daemon-reload
</span></code></pre></td></tr></table></div></figure>


<p>As we can see the <code>nfs-common</code> service is not running:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl status nfs-common
</span><span class='line'>● nfs-common.service - LSB: NFS support files common to client and server
</span><span class='line'>   Loaded: loaded <span class="o">(</span>/etc/init.d/nfs-common<span class="p">;</span> generated<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
</span><span class='line'>   Active: inactive <span class="o">(</span>dead<span class="o">)</span>
</span><span class='line'>     Docs: man:systemd-sysv-generator<span class="o">(</span>8<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s go ahead and start the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl start nfs-common
</span><span class='line'><span class="nv">$ </span>sudo systemctl status nfs-common
</span><span class='line'>● nfs-common.service - LSB: NFS support files common to client and server
</span><span class='line'>   Loaded: loaded <span class="o">(</span>/etc/init.d/nfs-common<span class="p">;</span> generated<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
</span><span class='line'>   Active: active <span class="o">(</span>running<span class="o">)</span> since Sat 2017-12-09 08:59:47 SAST<span class="p">;</span> 2s ago
</span><span class='line'>     Docs: man:systemd-sysv-generator<span class="o">(</span>8<span class="o">)</span>
</span><span class='line'>  Process: <span class="m">7382</span> <span class="nv">ExecStart</span><span class="o">=</span>/etc/init.d/nfs-common start <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
</span><span class='line'>      CPU: 162ms
</span><span class='line'>   CGroup: /system.slice/nfs-common.service
</span><span class='line'>           └─7403 /usr/sbin/rpc.idmapd
</span></code></pre></td></tr></table></div></figure>


<p>Now we can see the serive is unmasked and started, also remember to enable to service on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>nfs-common
</span><span class='line'>nfs-common.service is not a native service, redirecting to systemd-sysv-install.
</span><span class='line'>Executing: /lib/systemd/systemd-sysv-install <span class="nb">enable </span>nfs-common
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sudo systemctl is-enabled nfs-common
</span><span class='line'>enabled
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/12/05/setup-a-nfs-server-on-a-raspberrypi/">Setup a NFS Server on a RaspberryPi</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-12-05T10:45:35-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>10:45 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Setup a NFS Server/Client on RaspberryPi 3</p>

<h2>Setup the Server Side - Disks and Directories</h2>

<p>Prepare the directories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo mkdir -p /opt/nfs
</span><span class='line'><span class="nv">$ </span>sudo chown pi:pi /opt/nfs
</span><span class='line'><span class="nv">$ </span>sudo chmod <span class="m">755</span> /opt/nfs
</span></code></pre></td></tr></table></div></figure>


<p>For demonstration, I will be using the same disk as my OS, but if you have other disks that you would like to mount, mount them like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo lsblk
</span><span class='line'><span class="nv">$ </span>sudo mount /dev/sda2 /opt/nfs
</span><span class='line'><span class="nv">$ </span>sudo chown -R pi:pi /opt/nfs/existing_dirs
</span><span class='line'><span class="nv">$ </span>sudo find /opt/nfs/existing_dirs/ -type d -exec chmod <span class="m">755</span> <span class="o">{}</span> <span class="se">\;</span>
</span><span class='line'><span class="nv">$ </span>sudo find /opt/nfs/existing_dirs/ -type f -exec chmod <span class="m">644</span> <span class="o">{}</span> <span class="se">\;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you mounted the disk, and you would like to mount the disk on boot, we need to add it to our <code>/etc/fstab</code>. We can get the disk by running either:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo lsblk
</span><span class='line'><span class="c"># or</span>
</span><span class='line'><span class="nv">$ </span>sudo blkid
</span></code></pre></td></tr></table></div></figure>


<p>Populate the <code>/etc/fstab</code> with your disk info, it will look more or less like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/dev/sda2 /opt/nfs ext4 defaults,noatime <span class="m">0</span> 0
</span></code></pre></td></tr></table></div></figure>


<p>Append <code>rootdelay=10</code> after <code>rootwait</code> in <code>/boot/cmdline.txt</code>, then reboot for the changes to become active.</p>

<h2>Setup the Server Side - Installing NFS Server</h2>

<p>Install the NFS Server packages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt install nfs-kernel-server nfs-common rpcbind -y
</span></code></pre></td></tr></table></div></figure>


<p>Configure the paths in <code>/etc/exports</code>, we need to uid gid for the user that owns permission that we need to pass to the NFS Client. To get that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>id pi
</span><span class='line'><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>pi<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>pi<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Setup our path that we would like to be accessible via NFS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/opt/nfs 192.168.1.0/24<span class="o">(</span>rw,all_squash,no_hide,insecure,async,no_subtree_check,anonuid<span class="o">=</span>1000,anongid<span class="o">=</span>1000<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you would like to have open access:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/opt/nfs *<span class="o">(</span>rw,all_squash,no_hide,insecure,async,no_subtree_check,anonuid<span class="o">=</span>1000,anongid<span class="o">=</span>1000<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Export the config, enable the services on boot and start NFS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo exportfs -ra
</span><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>rpcbind
</span><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>nfs-kernel-server
</span><span class='line'><span class="nv">$ </span>sudo systemctl <span class="nb">enable </span>nfs-common
</span><span class='line'><span class="nv">$ </span>sudo systemctl start rpcbind
</span><span class='line'><span class="nv">$ </span>sudo systemctl start nfs-kernel-server
</span><span class='line'><span class="nv">$ </span>sudo systemctl start nfs-common
</span></code></pre></td></tr></table></div></figure>


<h2>Setup the NFS Client</h2>

<p>On the client install the NFS Client packages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt install nfs-common -y
</span></code></pre></td></tr></table></div></figure>


<p>Create the mountpoint of choice and change the ownership:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo chown pi:pi /mnt
</span></code></pre></td></tr></table></div></figure>


<p>Setup the <code>/etc/idmapd.conf</code> to match the user:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>Mapping<span class="o">]</span>
</span><span class='line'>Nobody-User <span class="o">=</span> pi
</span><span class='line'>Nobody-Group <span class="o">=</span> pi
</span></code></pre></td></tr></table></div></figure>


<p>Mount the NFS Share to your local mount point:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo mount 192.168.1.2:/opt/nfs /mnt
</span></code></pre></td></tr></table></div></figure>


<p>Enable mount on boot via <code>/etc/fstab</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>192.168.1.2:/opt/nfs /mnt nfs rw <span class="m">0</span> 0
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://zsiti.eu/nfs-file-sharing-server-raspberry-pi/">Great Resource on NFS</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/12/04/elasticsearch-curator-to-manage-and-curate-your-elasticsearch-indexes/">Elasticsearch Curator to Manage and Curate Your Elasticsearch Indexes</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-12-04T08:39:06-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>8:39 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://obj-cache.cloud.ruanbekker.com/elasticsearch-2.jpg" alt="" /></p>

<p>Elasticsearch Curator helps you to manage and curate your Elasticsearch Indices. I will show how to use the Curator in the following ways:</p>

<ul>
<li>Create Indexes</li>
<li>Reindex Indexes</li>
<li>Set Replica Counts on Indexes</li>
<li>Delete Indexes</li>
</ul>


<h2>Install Elasticsearch Curator</h2>

<p>Install Elasticsearch Curator as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>virtualenv .venv
</span><span class='line'><span class="nv">$ </span><span class="nb">source</span> .venv/bin/activate
</span><span class='line'><span class="nv">$ </span>pip install elasticsearch-curator
</span></code></pre></td></tr></table></div></figure>


<p>Populate the configuration whith your Elasticsearch Host details:</p>

<figure class='code'><figcaption><span>config.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">client</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">es.domain.com</span>
</span><span class='line'>  <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>  <span class="l-Scalar-Plain">use_ssl</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ssl_no_validate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>  <span class="l-Scalar-Plain">http_auth</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
</span><span class='line'>  <span class="l-Scalar-Plain">master_only</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">logging</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">loglevel</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">INFO</span>
</span><span class='line'>  <span class="l-Scalar-Plain">logfile</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">logformat</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">blacklist</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&#39;urllib3&#39;</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Action: Create Indices</h2>

<p>Use Curator to Create Elasticsearch Indexes:</p>

<figure class='code'><figcaption><span>action-create-indices.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">actions</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">create_web-app1-metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create_index</span>
</span><span class='line'>    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;-</span>
</span><span class='line'>      <span class="no">Create Elasticsearch Index based on Todays Date</span>
</span><span class='line'>      <span class="no">Specify Number of Primary and Replica Shards</span>
</span><span class='line'>      <span class="no">web-app1-metrics-2017.12.04</span>
</span><span class='line'>    <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;&lt;web-app1-metrics-{now/d}&gt;&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">extra_settings</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">settings</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">number_of_shards</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>          <span class="l-Scalar-Plain">number_of_replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>        <span class="l-Scalar-Plain">continue_if_exception</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class='line'>        <span class="l-Scalar-Plain">disable_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">create_web-app2-metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create_index</span>
</span><span class='line'>    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="s">&quot;Create</span><span class="nv"> </span><span class="s">Index</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">1st</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">this</span><span class="nv"> </span><span class="s">Month</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">Daily</span><span class="nv"> </span><span class="s">Format</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">web-app2-metrics-2017.12.01&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;&lt;web-app2-metrics-{now/M}&gt;&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">extra_settings</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">settings</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">number_of_shards</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>          <span class="l-Scalar-Plain">number_of_replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>        <span class="l-Scalar-Plain">continue_if_exception</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class='line'>        <span class="l-Scalar-Plain">disable_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">create_web-app3-metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create_index</span>
</span><span class='line'>    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="s">&quot;Create</span><span class="nv"> </span><span class="s">Index</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">Last</span><span class="nv"> </span><span class="s">Months</span><span class="nv"> </span><span class="s">Date</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">Month</span><span class="nv"> </span><span class="s">Format</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">web-app3-metrics-2017.11&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;&lt;web-app2-metrics-{now/M-1M{YYYY.MM}}&gt;&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">extra_settings</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">settings</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">number_of_shards</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>          <span class="l-Scalar-Plain">number_of_replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>        <span class="l-Scalar-Plain">continue_if_exception</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class='line'>        <span class="l-Scalar-Plain">disable_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">create_web-app4-metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create_index</span>
</span><span class='line'>    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="s">&quot;Create</span><span class="nv"> </span><span class="s">Index</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">Daily</span><span class="nv"> </span><span class="s">Format</span><span class="nv"> </span><span class="s">12</span><span class="nv"> </span><span class="s">Hours</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">Now</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">web-app4-metrics-2017.12.05&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;&lt;web-app2-metrics-{now/d{YYYY.MM.dd|+12:00}}&gt;&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">extra_settings</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">settings</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">number_of_shards</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'>          <span class="l-Scalar-Plain">number_of_replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>        <span class="l-Scalar-Plain">continue_if_exception</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class='line'>        <span class="l-Scalar-Plain">disable_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span></code></pre></td></tr></table></div></figure>


<p>When Running curator, you can append <code>--dry-run</code> to test your config/action without touching your data. To create these indexes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curator --config config.yml action-create-indices.yml
</span><span class='line'>
</span><span class='line'>2017-12-04 14:22:40,252 INFO      Preparing Action ID: create_web-app1-metrics, <span class="s2">&quot;create_index&quot;</span>
</span><span class='line'>2017-12-04 14:22:40,303 INFO      GET https://es.domain.com:443/ <span class="o">[</span>status:200 request:0.036s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:22:40,304 INFO      Trying Action ID: create_web-app1-metrics, <span class="s2">&quot;create_index&quot;</span>: Create Elasticsearch Index based on Todays Date Specify Number of Primary and Replica Shards web-app1-metrics-2017.12.04
</span><span class='line'>2017-12-04 14:22:40,304 INFO      <span class="s2">&quot;&lt;web-app1-metrics-{now/d}&gt;&quot;</span> is using Elasticsearch date math.
</span><span class='line'>2017-12-04 14:22:40,304 INFO      Creating index <span class="s2">&quot;&lt;web-app1-metrics-{now/d}&gt;&quot;</span> with settings: <span class="o">{</span><span class="s1">&#39;continue_if_exception&#39;</span>: True, <span class="s1">&#39;settings&#39;</span>: <span class="o">{</span><span class="s1">&#39;number_of_replicas&#39;</span>: 1, <span class="s1">&#39;number_of_shards&#39;</span>: 5<span class="o">}</span>, <span class="s1">&#39;disable_action&#39;</span>: False<span class="o">}</span>
</span><span class='line'>2017-12-04 14:22:41,490 INFO      PUT https://es.domain.com:443/%3Cweb-app1-metrics-%7Bnow%2Fd%7D%3E <span class="o">[</span>status:200 request:1.185s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:22:41,490 INFO      Action ID: create_web-app1-metrics, <span class="s2">&quot;create_index&quot;</span> completed.
</span><span class='line'>2017-12-04 14:22:41,490 INFO      Preparing Action ID: create_web-app2-metrics, <span class="s2">&quot;create_index&quot;</span>
</span><span class='line'>2017-12-04 14:22:41,533 INFO      GET https://es.domain.com:443/ <span class="o">[</span>status:200 request:0.033s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:22:41,534 INFO      Trying Action ID: create_web-app2-metrics, <span class="s2">&quot;create_index&quot;</span>: Create Index with the 1st of this Month in Daily Format - web-app2-metrics-2017.12.01
</span><span class='line'>2017-12-04 14:22:41,534 INFO      <span class="s2">&quot;&lt;web-app2-metrics-{now/M}&gt;&quot;</span> is using Elasticsearch date math.
</span><span class='line'>2017-12-04 14:22:41,534 INFO      Creating index <span class="s2">&quot;&lt;web-app2-metrics-{now/M}&gt;&quot;</span> with settings: <span class="o">{</span><span class="s1">&#39;continue_if_exception&#39;</span>: True, <span class="s1">&#39;settings&#39;</span>: <span class="o">{</span><span class="s1">&#39;number_of_replicas&#39;</span>: 2, <span class="s1">&#39;number_of_shards&#39;</span>: 5<span class="o">}</span>, <span class="s1">&#39;disable_action&#39;</span>: False<span class="o">}</span>
</span><span class='line'>2017-12-04 14:22:41,634 INFO      PUT https://es.domain.com:443/%3Cweb-app2-metrics-%7Bnow%2FM%7D%3E <span class="o">[</span>status:200 request:0.099s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:22:41,634 INFO      Action ID: create_web-app2-metrics, <span class="s2">&quot;create_index&quot;</span> completed.
</span><span class='line'>2017-12-04 14:22:41,634 INFO      Preparing Action ID: create_web-app3-metrics, <span class="s2">&quot;create_index&quot;</span>
</span><span class='line'>2017-12-04 14:22:41,673 INFO      GET https://es.domain.com:443/ <span class="o">[</span>status:200 request:0.028s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:22:41,674 INFO      Trying Action ID: create_web-app3-metrics, <span class="s2">&quot;create_index&quot;</span>: Create Index with Last Months Date in Month Format - web-app3-metrics-2017.11
</span><span class='line'>2017-12-04 14:22:41,674 INFO      <span class="s2">&quot;&lt;web-app2-metrics-{now/M-1M{YYYY.MM}}&gt;&quot;</span> is using Elasticsearch date math.
</span><span class='line'>2017-12-04 14:22:41,674 INFO      Creating index <span class="s2">&quot;&lt;web-app2-metrics-{now/M-1M{YYYY.MM}}&gt;&quot;</span> with settings: <span class="o">{</span><span class="s1">&#39;continue_if_exception&#39;</span>: True, <span class="s1">&#39;settings&#39;</span>: <span class="o">{</span><span class="s1">&#39;number_of_replicas&#39;</span>: 2, <span class="s1">&#39;number_of_shards&#39;</span>: 5<span class="o">}</span>, <span class="s1">&#39;disable_action&#39;</span>: False<span class="o">}</span>
</span><span class='line'>2017-12-04 14:22:41,750 INFO      PUT https://es.domain.com:443/%3Cweb-app2-metrics-%7Bnow%2FM-1M%7BYYYY.MM%7D%7D%3E <span class="o">[</span>status:200 request:0.076s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:22:41,751 INFO      Action ID: create_web-app3-metrics, <span class="s2">&quot;create_index&quot;</span> completed.
</span><span class='line'>2017-12-04 14:22:41,751 INFO      Preparing Action ID: create_web-app4-metrics, <span class="s2">&quot;create_index&quot;</span>
</span><span class='line'>2017-12-04 14:22:41,785 INFO      GET https://es.domain.com:443/ <span class="o">[</span>status:200 request:0.027s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:22:41,786 INFO      Trying Action ID: create_web-app4-metrics, <span class="s2">&quot;create_index&quot;</span>: Create Index with Daily Format <span class="m">12</span> Hours from Now - web-app4-metrics-2017.12.05
</span><span class='line'>2017-12-04 14:22:41,786 INFO      <span class="s2">&quot;&lt;web-app2-metrics-{now/d{YYYY.MM.dd|+12:00}}&gt;&quot;</span> is using Elasticsearch date math.
</span><span class='line'>2017-12-04 14:22:41,786 INFO      Creating index <span class="s2">&quot;&lt;web-app2-metrics-{now/d{YYYY.MM.dd|+12:00}}&gt;&quot;</span> with settings: <span class="o">{</span><span class="s1">&#39;continue_if_exception&#39;</span>: True, <span class="s1">&#39;settings&#39;</span>: <span class="o">{</span><span class="s1">&#39;number_of_replicas&#39;</span>: 2, <span class="s1">&#39;number_of_shards&#39;</span>: 5<span class="o">}</span>, <span class="s1">&#39;disable_action&#39;</span>: False<span class="o">}</span>
</span><span class='line'>2017-12-04 14:22:42,182 INFO      PUT https://es.domain.com:443/%3Cweb-app2-metrics-%7Bnow%2Fd%7BYYYY.MM.dd%7C%2B12%3A00%7D%7D%3E <span class="o">[</span>status:200 request:0.396s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:22:42,183 INFO      Action ID: create_web-app4-metrics, <span class="s2">&quot;create_index&quot;</span> completed.
</span><span class='line'>2017-12-04 14:22:42,183 INFO      Job completed.
</span></code></pre></td></tr></table></div></figure>


<p>Lets have a look at our indices to confirm that our indices was created:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -s -XGET <span class="s2">&quot;https://es.domain.com/_cat/indices/web-*?v&quot;</span>
</span><span class='line'>health status index                       uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   web-app2-metrics-2017.12.01 qJHVyft1THemh1qGvA8u0w   <span class="m">5</span>   <span class="m">2</span>          <span class="m">0</span>            <span class="m">0</span>       810b           810b
</span><span class='line'>green  open   web-app2-metrics-2017.11    y5R4vNfOSh2tiC-yGtkgLg   <span class="m">5</span>   <span class="m">2</span>          <span class="m">0</span>            <span class="m">0</span>       810b           810b
</span><span class='line'>green  open   web-app2-metrics-2017.12.05 -ohbgD6-TmmCeJtVv84dPw   <span class="m">5</span>   <span class="m">2</span>          <span class="m">0</span>            <span class="m">0</span>       810b           810b
</span><span class='line'>green  open   web-app1-metrics-2017.12.04 WeGkgB9FSq-cuLVR7ccQFQ   <span class="m">5</span>   <span class="m">1</span>          <span class="m">0</span>            <span class="m">0</span>       810b           810b
</span></code></pre></td></tr></table></div></figure>


<h2>Action: Reindex Indices based on Timestring</h2>

<p>I would like to reindex a months worth of index data to a monthly index:</p>

<figure class='code'><figcaption><span>action-reindex.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">actions</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">re-index_web-app1-metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">reindex</span>
</span><span class='line'>    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="s">&quot;reindex</span><span class="nv"> </span><span class="s">web-app1-metrics</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">monthly</span><span class="nv"> </span><span class="s">index</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">last</span><span class="nv"> </span><span class="s">months</span><span class="nv"> </span><span class="s">date</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">archive-web-app1-metrics-2017.11&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">continue_if_exception</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>      <span class="l-Scalar-Plain">disable_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>      <span class="l-Scalar-Plain">wait_interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9</span>
</span><span class='line'>      <span class="l-Scalar-Plain">max_wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">-1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">request_body</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">index</span><span class="p-Indicator">:</span> <span class="s">&#39;&lt;web-app1-metrics-{now/d-31d{YYYY.MM.dd}}&gt;&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">dest</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">index</span><span class="p-Indicator">:</span> <span class="s">&#39;&lt;archive-web-app1-metrics-{now/M-1M{YYYY.MM}}&gt;&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">filters</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">filtertype</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">none</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running the Curator to reindex all last months data: <code>web-app1-metrics-2017.11.{01-31}</code> to the index: <code>web-app1-metrics-2017.11</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curator --config config action-reindex.yml
</span></code></pre></td></tr></table></div></figure>


<h2>Curator to Change Replica Counts on your Indices:</h2>

<p>We will change all our indices settings to replica count of 2, that is matched with our prefix pattern. We are using <code>wait_for_completion</code> so the job will only be completed once the replica count number is updated and data has been replicated to the replica shards.</p>

<p>Our action file:</p>

<figure class='code'><figcaption><span>action-replicas.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">actions</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">increase_replica_2</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">replicas</span>
</span><span class='line'>    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;-</span>
</span><span class='line'>      <span class="no">Increase the replica count to 2 for logstash- prefixed indices older than</span>
</span><span class='line'>      <span class="no">10 days (based on index creation_date)</span>
</span><span class='line'>    <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'>      <span class="l-Scalar-Plain">max_wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">-1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">wait_interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
</span><span class='line'>      <span class="l-Scalar-Plain">wait_for_completion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class='line'>      <span class="l-Scalar-Plain">disable_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>    <span class="l-Scalar-Plain">filters</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">filtertype</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pattern</span>
</span><span class='line'>      <span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prefix</span>
</span><span class='line'>      <span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">packet-capture-2017.11.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using Curator to increase our replica count on all the matched indices:</p>

<figure class='code'><figcaption><span>action-replicas.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ curator --config config.yml action-replicas.yml</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 13:42:41,322 INFO      Health Check for all provided keys passed.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 13:42:41,323 INFO      Action ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">increase_replica_2, &quot;replicas&quot; completed.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 13:42:41,323 INFO      Job completed.</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Curator to Delete your Indices:</h2>

<figure class='code'><figcaption><span>action-replicas.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="c1"># documentation:</span>
</span><span class='line'><span class="c1"># https://www.elastic.co/guide/en/elasticsearch/client/curator/current/ex_delete_indices.html</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">actions</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">delete-index_web-app1-metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span>
</span><span class='line'>    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;-</span>
</span><span class='line'>      <span class="no">Delete indices older than 21 days - based on index name, web-app1-metrics-</span>
</span><span class='line'>      <span class="no">prefixed indices. Ignore the error if the filter does not result in an</span>
</span><span class='line'>      <span class="no">actionable list of indices (ignore_empty_list) and exit cleanly.</span>
</span><span class='line'>    <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">ignore_empty_list</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class='line'>      <span class="l-Scalar-Plain">disable_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>    <span class="l-Scalar-Plain">filters</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">filtertype</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pattern</span>
</span><span class='line'>      <span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prefix</span>
</span><span class='line'>      <span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">filtertype</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">age</span>
</span><span class='line'>      <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name</span>
</span><span class='line'>      <span class="l-Scalar-Plain">direction</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">older</span>
</span><span class='line'>      <span class="l-Scalar-Plain">timestring</span><span class="p-Indicator">:</span> <span class="s">&#39;%Y.%m.%d&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">unit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">days</span>
</span><span class='line'>      <span class="l-Scalar-Plain">unit_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">21</span>
</span><span class='line'>      <span class="l-Scalar-Plain">exclude</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">delete-index_web-app2-metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span>
</span><span class='line'>    <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;-</span>
</span><span class='line'>      <span class="no">Delete indices older than 1 month - based on index name, web-app2-metrics-</span>
</span><span class='line'>      <span class="no">prefixed indices. Ignore the error if the filter does not result in an</span>
</span><span class='line'>      <span class="no">actionable list of indices (ignore_empty_list) and exit cleanly.</span>
</span><span class='line'>    <span class="l-Scalar-Plain">options</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">ignore_empty_list</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
</span><span class='line'>      <span class="l-Scalar-Plain">disable_action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
</span><span class='line'>    <span class="l-Scalar-Plain">filters</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">filtertype</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pattern</span>
</span><span class='line'>      <span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">prefix</span>
</span><span class='line'>      <span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app2-metrics-</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">filtertype</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">age</span>
</span><span class='line'>      <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name</span>
</span><span class='line'>      <span class="l-Scalar-Plain">direction</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">older</span>
</span><span class='line'>      <span class="l-Scalar-Plain">timestring</span><span class="p-Indicator">:</span> <span class="s">&#39;%Y.%m.%d&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">unit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">months</span>
</span><span class='line'>      <span class="l-Scalar-Plain">unit_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">exclude</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we will execute a Dry Run:</p>

<figure class='code'><figcaption><span>action-replicas.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">$ curator --config /opt/curator/es-dev/config.yml /opt/curator/es-dev/actions/action-delete.yml --dry-run</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,789 INFO      Preparing Action ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete-index_web-app1-metrics, &quot;delete_indices&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,850 INFO      GET https://es.domain.com:443/ [status:200 request:0.037s]</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,851 INFO      Trying Action ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete-index_web-app1-metrics, &quot;delete_indices&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Delete indices older than 21 days - based on index name, web-app1-metrics- prefixed indices. Ignore the error if the filter does not result in an actionable list of indices (ignore_empty_list) and exit cleanly.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,859 INFO      GET https://es.domain.com:443/_all/_settings?expand_wildcards=open%2Cclosed [status:200 request:0.008s]</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,862 INFO      GET https://es.domain.com:443/ [status:200 request:0.002s]</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,957 INFO      DRY-RUN MODE.  No changes will be made.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,957 INFO      (CLOSED) indices may be shown that may not be acted on by action &quot;delete_indices&quot;.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,957 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.01 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,958 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.02 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,958 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.03 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,958 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.04 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,958 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.05 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,958 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.06 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,958 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.07 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,958 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.08 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,959 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.09 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,959 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.10 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,959 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.11 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,959 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.12 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,959 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app1-metrics-2017.11.13 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,959 INFO      Action ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete-index_web-app1-metrics, &quot;delete_indices&quot; completed.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:19,959 INFO      Preparing Action ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete-index_web-app2-metrics, &quot;delete_indices&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,025 INFO      GET https://es.domain.com:443/ [status:200 request:0.050s]</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,026 INFO      Trying Action ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete-index_web-app2-metrics, &quot;delete_indices&quot;</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Delete indices older than 1 month - based on index name, web-app2-metrics- prefixed indices. Ignore the error if the filter does not result in an actionable list of indices (ignore_empty_list) and exit cleanly.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,034 INFO      GET https://es.domain.com:443/_all/_settings?expand_wildcards=open%2Cclosed [status:200 request:0.008s]</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,039 INFO      GET https://es.domain.com:443/ [status:200 request:0.003s]</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,090 INFO      DRY-RUN MODE.  No changes will be made.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,090 INFO      (CLOSED) indices may be shown that may not be acted on by action &quot;delete_indices&quot;.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,090 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app2-metrics-2017.11.01 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,090 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app2-metrics-2017.11.02 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,090 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app2-metrics-2017.11.03 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,090 INFO      DRY-RUN</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete_indices</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web-app2-metrics-2017.11.04 with arguments</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,090 INFO      Action ID</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">delete-index_web-app2-metrics, &quot;delete_indices&quot; completed.</span>
</span><span class='line'><span class="l-Scalar-Plain">2017-12-04 14:43:20,090 INFO      Job completed.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Everything seems to be as expected, lets run the Curator without the Dry-Run mode:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curator --config config.yml action-delete.yml
</span><span class='line'>
</span><span class='line'>2017-12-04 14:43:40,042 INFO      Deleting selected indices: <span class="o">[</span>u<span class="s1">&#39;web-app1-metrics-2017.11.06&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.07&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.04&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.05&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.02&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.03&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.01&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.08&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.09&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.11&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.10&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.13&#39;</span>, u<span class="s1">&#39;web-app1-metrics-2017.11.12&#39;</span><span class="o">]</span>
</span><span class='line'>2017-12-04 14:43:40,043 INFO      ---deleting index web-app1-metrics-2017.11.06
</span><span class='line'>2017-12-04 14:43:40,043 INFO      ---deleting index web-app1-metrics-2017.11.07
</span><span class='line'>2017-12-04 14:43:40,043 INFO      ---deleting index web-app1-metrics-2017.11.04
</span><span class='line'>2017-12-04 14:43:40,043 INFO      ---deleting index web-app1-metrics-2017.11.05
</span><span class='line'>2017-12-04 14:43:40,043 INFO      ---deleting index web-app1-metrics-2017.11.02
</span><span class='line'>2017-12-04 14:43:40,043 INFO      ---deleting index web-app1-metrics-2017.11.03
</span><span class='line'>2017-12-04 14:43:40,043 INFO      ---deleting index web-app1-metrics-2017.11.01
</span><span class='line'>2017-12-04 14:43:40,044 INFO      ---deleting index web-app1-metrics-2017.11.08
</span><span class='line'>2017-12-04 14:43:40,044 INFO      ---deleting index web-app1-metrics-2017.11.09
</span><span class='line'>2017-12-04 14:43:40,044 INFO      ---deleting index web-app1-metrics-2017.11.11
</span><span class='line'>2017-12-04 14:43:40,044 INFO      ---deleting index web-app1-metrics-2017.11.10
</span><span class='line'>2017-12-04 14:43:40,044 INFO      ---deleting index web-app1-metrics-2017.11.13
</span><span class='line'>2017-12-04 14:43:40,044 INFO      ---deleting index web-app1-metrics-2017.11.12
</span><span class='line'>2017-12-04 14:43:40,287 INFO      DELETE https://es.domain.com:443/web-app1-metrics-2017.11.01,web-app1-metrics-2017.11.02,web-app1-metrics-2017.11.03,web-app1-metrics-2017.11.04,web-app1-metrics-2017.11.05,web-app1-metrics-2017.11.06,web-app1-metrics-2017.11.07,web-app1-metrics-2017.11.08,web-app1-metrics-2017.11.09,web-app1-metrics-2017.11.10,web-app1-metrics-2017.11.11,web-app1-metrics-2017.11.12,web-app1-metrics-2017.11.13?master_timeout<span class="o">=</span>30s <span class="o">[</span>status:200 request:0.243s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:43:40,417 INFO      Action ID: delete-index_web-app1-metrics, <span class="s2">&quot;delete_indices&quot;</span> completed.
</span><span class='line'>2017-12-04 14:43:40,417 INFO      Preparing Action ID: delete-index_web-app2-metrics, <span class="s2">&quot;delete_indices&quot;</span>
</span><span class='line'>2017-12-04 14:43:40,453 INFO      Trying Action ID: delete-index_web-app2-metrics, <span class="s2">&quot;delete_indices&quot;</span>: Delete indices older than <span class="m">1</span> month - based on index name, web-app2-metrics- prefixed indices. Ignore the error <span class="k">if</span> the filter does not result in an actionable list of indices <span class="o">(</span>ignore_empty_list<span class="o">)</span> and <span class="nb">exit </span>cleanly.
</span><span class='line'>2017-12-04 14:43:40,491 INFO      Deleting selected indices: <span class="o">[</span>u<span class="s1">&#39;web-app2-metrics-2017.11.03&#39;</span>, u<span class="s1">&#39;web-app2-metrics-2017.11.01&#39;</span>, u<span class="s1">&#39;web-app2-metrics-2017.11.02&#39;</span>, u<span class="s1">&#39;web-app2-metrics-2017.11.04&#39;</span><span class="o">]</span>
</span><span class='line'>2017-12-04 14:43:40,492 INFO      ---deleting index web-app2-metrics-2017.11.03
</span><span class='line'>2017-12-04 14:43:40,492 INFO      ---deleting index web-app2-metrics-2017.11.01
</span><span class='line'>2017-12-04 14:43:40,492 INFO      ---deleting index web-app2-metrics-2017.11.02
</span><span class='line'>2017-12-04 14:43:40,492 INFO      ---deleting index web-app2-metrics-2017.11.04
</span><span class='line'>2017-12-04 14:43:40,566 INFO      DELETE https://es.domain.com:443/web-app2-metrics-2017.11.01,web-app2-metrics-2017.11.02,web-app2-metrics-2017.11.03,web-app2-metrics-2017.11.04?master_timeout<span class="o">=</span>30s <span class="o">[</span>status:200 request:0.074s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:43:40,595 INFO      GET https://es.domain.com:443/ <span class="o">[</span>status:200 request:0.002s<span class="o">]</span>
</span><span class='line'>2017-12-04 14:43:40,596 INFO      Action ID: delete-index_web-app2-metrics, <span class="s2">&quot;delete_indices&quot;</span> completed.
</span><span class='line'>2017-12-04 14:43:40,596 INFO      Job completed.
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/index.html">Elasticsearch Curator</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/24/basic-concourse-pipeline-with-bash-and-golang-jobs/">Basic Concourse Pipeline With Bash and Golang Jobs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-24T18:38:15-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>6:38 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495" alt="" /></p>

<p>From one of my previous posts, we went through the steps to setup a <a href="http://blog.ruanbekker.com/blog/2017/11/07/setup-a-concourse-ci-server-on-ubuntu-16/">Concourse CI Server on Ubuntu</a> .</p>

<h2>What are we doing today?</h2>

<p>Today we will setup a basic pipeline that executes 2 jobs, one using a alpine container that runs a couple of shell commands, and the other job will be using a Golang container to build and execute a golang app. I will also be experimenting with auto trigger, that will trigger the pipeline to run its jobs every 60 seconds.</p>

<p>Our Pipeline will look like the following:</p>

<p><img src="https://i.snag.gy/D0oO4M.jpg" alt="" /></p>

<h2>Our Pipeline Definition:</h2>

<figure class='code'><figcaption><span>bash-and-golang.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">container-resource</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">time</span>
</span><span class='line'>  <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">interval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">60m</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-alpine-job</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">get</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">container-resource</span>
</span><span class='line'>    <span class="l-Scalar-Plain">trigger</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vanilla-alpine-tasks</span>
</span><span class='line'>    <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">OWNER</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ruan</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">alpine</span>
</span><span class='line'>          <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">edge</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/bin/sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">-c</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">apk update &gt; /dev/null</span>
</span><span class='line'>          <span class="no">apk upgrade &gt; /dev/null</span>
</span><span class='line'>          <span class="no">apk add curl &gt; /dev/null</span>
</span><span class='line'>          <span class="no">echo &quot;Public IP is: `curl -s http://ip.ruanbekker.com`&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Hostname is: $HOSTNAME&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Owner is: $OWNER&quot;</span>
</span><span class='line'>          <span class="no">echo foo &gt; /tmp/word.txt</span>
</span><span class='line'>          <span class="no">export MAGIC_WORD=`cat /tmp/word.txt`</span>
</span><span class='line'>          <span class="no">echo &quot;Magic word is $MAGIC_WORD&quot;</span>
</span><span class='line'>          <span class="no">cat &gt; app.sh &lt;&lt; EOF</span>
</span><span class='line'>          <span class="no">#!/usr/bin/env sh</span>
</span><span class='line'>          <span class="no">echo &quot;Hello, World!&quot;</span>
</span><span class='line'>          <span class="no">EOF</span>
</span><span class='line'>          <span class="no">chmod +x app.sh</span>
</span><span class='line'>          <span class="no">echo &quot;Shell Script Executing:&quot;</span>
</span><span class='line'>          <span class="no">./app.sh</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-golang-job</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">get</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">container-resource</span>
</span><span class='line'>    <span class="l-Scalar-Plain">trigger</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">golang-tasks</span>
</span><span class='line'>    <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">OWNER</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">james</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">golang</span>
</span><span class='line'>          <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="s">&#39;1.6&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/bin/sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">-c</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">echo &quot;User: `whoami`&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Go Version: `go version`&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Hostname is: $HOSTNAME&quot;</span>
</span><span class='line'>          <span class="no">echo &quot;Owner is: $OWNER&quot;</span>
</span><span class='line'>          <span class="no">echo bar &gt; /tmp/word.txt</span>
</span><span class='line'>          <span class="no">export MAGIC_WORD=`cat /tmp/word.txt`</span>
</span><span class='line'>          <span class="no">echo &quot;Magic word is $MAGIC_WORD&quot;</span>
</span><span class='line'>          <span class="no">cat &gt; app.go &lt;&lt; EOF</span>
</span><span class='line'>          <span class="no">package main</span>
</span><span class='line'>
</span><span class='line'>          <span class="no">import &quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'>          <span class="no">func main() {</span>
</span><span class='line'>            <span class="no">fmt.Println(&quot;Hello, World!&quot;)</span>
</span><span class='line'>          <span class="no">}</span>
</span><span class='line'>          <span class="no">EOF</span>
</span><span class='line'>          <span class="no">go build app.go</span>
</span><span class='line'>          <span class="no">echo &quot;Go App Executing:&quot;</span>
</span><span class='line'>          <span class="no">./app</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Login to Concourse:</h2>

<p>Logon to concourse and set your target:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci login --concourse-url<span class="o">=</span>http://10.20.30.40:8080
</span><span class='line'>logging in to team <span class="s1">&#39;main&#39;</span>
</span><span class='line'>
</span><span class='line'>username: admin
</span><span class='line'>password:
</span><span class='line'>
</span><span class='line'>target saved
</span></code></pre></td></tr></table></div></figure>


<p>List your targets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly targets
</span><span class='line'>name      url                       team  expiry
</span><span class='line'>ci        http://10.20.30.40:8080   main  Sat, <span class="m">25</span> Nov <span class="m">2017</span> 23:30:55 UTC
</span></code></pre></td></tr></table></div></figure>


<h2>Apply Configuration</h2>

<p>Apply your Configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci <span class="nb">set</span>-pipeline -p bash-and-golang -c bash-and-golang.yml
</span><span class='line'>
</span><span class='line'>apply configuration? <span class="o">[</span>yN<span class="o">]</span>: y
</span><span class='line'>pipeline created!
</span><span class='line'>you can view your pipeline here: http://10.20.30.40:8080/teams/main/pipelines/bash-and-golang
</span><span class='line'>
</span><span class='line'>the pipeline is currently paused. to unpause, either:
</span><span class='line'>  - run the unpause-pipeline <span class="nb">command</span>
</span><span class='line'>  - click play next to the pipeline in the web ui
</span></code></pre></td></tr></table></div></figure>


<h2>Unpause</h2>

<p>Unpause your Pipeline:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci unpause-pipeline -p bash-and-golang
</span><span class='line'>unpaused <span class="s1">&#39;bash-and-golang&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Trigger</h2>

<p>Trigger your first job, which will be the Alpine job:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job bash-and-golang/my-alpine-job
</span><span class='line'>started bash-and-golang/my-alpine-job <span class="c">#2</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://i.snag.gy/x7ksQO.jpg?nocache=1511567544851" alt="" /></p>

<p>Trigger your second job, which will be the Golang job:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job bash-and-golang/my-golang-job
</span><span class='line'>started bash-and-golang/my-golang-job <span class="c">#2</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://i.snag.gy/07nDiZ.jpg" alt="" /></p>

<p>Remember, we can also monitor the output from the shell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t ci trigger-job --job bash-and-golang/my-golang-job --watch
</span><span class='line'>started bash-and-golang/my-golang-job <span class="c">#3</span>
</span><span class='line'>
</span><span class='line'>initializing
</span><span class='line'>running /bin/sh -c <span class="nb">echo</span> <span class="s2">&quot;User: `whoami`&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Go Version: `go version`&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Hostname is: $HOSTNAME&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Owner is: $OWNER&quot;</span>
</span><span class='line'><span class="nb">echo </span>bar &gt; /tmp/word.txt
</span><span class='line'><span class="nb">export </span><span class="nv">MAGIC_WORD</span><span class="o">=</span><span class="sb">`</span>cat /tmp/word.txt<span class="sb">`</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Magic word is $MAGIC_WORD&quot;</span>
</span><span class='line'>cat &gt; app.go <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">package main</span>
</span><span class='line'>
</span><span class='line'><span class="s">import &quot;fmt&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s">func main() {</span>
</span><span class='line'><span class="s">  fmt.Println(&quot;Hello, World!&quot;)</span>
</span><span class='line'><span class="s">}</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>go build app.go
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Go App Executing:&quot;</span>
</span><span class='line'>./app
</span><span class='line'>
</span><span class='line'>User: root
</span><span class='line'>Go Version: go version go1.6.4 linux/amd64
</span><span class='line'>Hostname is:
</span><span class='line'>Owner is: james
</span><span class='line'>Magic word is bar
</span><span class='line'>Go App Executing:
</span><span class='line'>Hello, World!
</span><span class='line'>succeeded
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/23/use-docker-secrets-with-mysql-on-docker-swarm/">Use Docker Secrets With MySQL on Docker Swarm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-23T16:55:15-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2017</span></span> <span class='time'>4:55 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://obj-cache.cloud.ruanbekker.com/docker-logo.png" alt="" /></p>

<p>Today we will use Docker Secrets, more specifically store our MySQL Passwords in Secrets, which will be passed to our containers, so that we don&rsquo;t use clear text passwords in our Compose files.</p>

<h2>What is Docker Secrets:</h2>

<p>In Docker, Docker Secrets are encrypted during transit and at rest in a Docker Swarm Cluster. The great thing about Docker Secrets is that you can manage these secrets from a central place, and the fact that it encrypts the data and transfers the data securely to the containers that needs the secrets. So you authorize which containers needs access to these secrets.</p>

<p>So instead of setting the MySQL Root Passwords in clear text, you will create the secrets, then in your docker-compose file, you will reference the secret name.</p>

<h2>Deploy MySQL with Docker Secrets</h2>

<p>We will deploy a Stack that contains MySQL and Adminer (WebUI for MySQL).</p>

<p>We will make the MySQL Service Persistent by setting a constraint to only run on the Manager node, as we will create the volume path on the host, and then map the host to the container so that the container can have persistent data. We will also create secrets for our MySQL Service so that we dont expose any plaintext passwords in our compose file.</p>

<p>Our Docker Compose file:</p>

<figure class='code'><figcaption><span>docker-compose.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="s">&#39;3.3&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">db</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mysql</span>
</span><span class='line'>    <span class="l-Scalar-Plain">secrets</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">db_root_password</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">db_dba_password</span>
</span><span class='line'>    <span class="l-Scalar-Plain">deploy</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>      <span class="l-Scalar-Plain">placement</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">constraints</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">node.role == manager</span><span class="p-Indicator">]</span>
</span><span class='line'>      <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">reservations</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">128M</span>
</span><span class='line'>        <span class="l-Scalar-Plain">limits</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">memory</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">256M</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3306:3306</span>
</span><span class='line'>    <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">MYSQL_USER</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dba</span>
</span><span class='line'>      <span class="l-Scalar-Plain">MYSQL_DATABASE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mydb</span>
</span><span class='line'>      <span class="l-Scalar-Plain">MYSQL_ROOT_PASSWORD_FILE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/run/secrets/db_root_password</span>
</span><span class='line'>      <span class="l-Scalar-Plain">MYSQL_PASSWORD_FILE</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/run/secrets/db_dba_password</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bind</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/opt/docker/volumes/mysql</span>
</span><span class='line'>        <span class="l-Scalar-Plain">target</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/lib/mysql</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">adminer</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">adminer</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8080:8080</span>
</span><span class='line'>    <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">appnet</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">secrets</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">db_root_password</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">db_dba_password</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">appnet</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">external</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Dependencies:</h2>

<p>As we specified our secrets and networks as external resources, it needs to exist before we deploy our stack. We also need to create the directory for our mysql data, as the data will be mapped from our host to our container.</p>

<p>Create the Overlay Network:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker network create --driver overlay appnet
</span></code></pre></td></tr></table></div></figure>


<p>Create the Secrets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>openssl rand -base64 <span class="m">12</span> <span class="p">|</span> docker secret create db_root_password -
</span><span class='line'><span class="nv">$ </span>openssl rand -base64 <span class="m">12</span> <span class="p">|</span> docker secret create db_dba_password -
</span></code></pre></td></tr></table></div></figure>


<p>List the Secrets:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker secret ls
</span><span class='line'>ID                          NAME                CREATED             UPDATED
</span><span class='line'>jzhrwyxkiqt8v81ow0xjktqnw   db_root_password    <span class="m">12</span> seconds ago      <span class="m">12</span> seconds ago
</span><span class='line'>plr6rbrqkqy7oplrd21pja3ol   db_dba_password     <span class="m">4</span> seconds ago       <span class="m">4</span> seconds ago
</span></code></pre></td></tr></table></div></figure>


<p>Inspect the secret, so that we can see that theres not value exposed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker secret inspect db_root_password
</span><span class='line'><span class="o">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s2">&quot;ID&quot;</span>: <span class="s2">&quot;jzhrwyxkiqt8v81ow0xjktqnw&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Version&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Index&quot;</span>: 982811
</span><span class='line'>        <span class="o">}</span>,
</span><span class='line'>        <span class="s2">&quot;CreatedAt&quot;</span>: <span class="s2">&quot;2017-11-23T14:33:17.005968748Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;UpdatedAt&quot;</span>: <span class="s2">&quot;2017-11-23T14:33:17.005968748Z&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;Spec&quot;</span>: <span class="o">{</span>
</span><span class='line'>            <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;db_root_password&quot;</span>,
</span><span class='line'>            <span class="s2">&quot;Labels&quot;</span>: <span class="o">{}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Create the Directory for MySQL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /opt/docker/volumes/mysql
</span></code></pre></td></tr></table></div></figure>


<h2>Deployment Time!</h2>

<p>Deploy the stack:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker stack deploy -c docker-compose.yml apps
</span><span class='line'>Creating service apps_adminer
</span><span class='line'>Creating service apps_db
</span></code></pre></td></tr></table></div></figure>


<p>As you can see the data of our MySQL container resides on our host, which makes the data persistent for the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls /opt/docker/volumes/mysql/
</span><span class='line'>auto.cnf  ca-key.pem  ca.pem  client-cert.pem  client-key.pem  ib_buffer_pool  ibdata1  ib_logfile0  ib_logfile1  ibtmp1  mydb  mysql  performance_schema  private_key.pem  public_key.pem  server-cert.pem  server-key.pem  sys
</span></code></pre></td></tr></table></div></figure>


<h2>Connect to MySQL</h2>

<p>The value of our secrets will reside under <code>/run/secrets/</code> in our container, as we have mapped it to our mysql container, lets have a look at them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> ls /run/secrets/
</span><span class='line'>db_dba_password  db_root_password
</span></code></pre></td></tr></table></div></figure>


<p>View the actual value of the <code>db_root_password</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> cat /run/secrets/db_root_password
</span><span class='line'>mRpcY1eY2+wimf10
</span></code></pre></td></tr></table></div></figure>


<p>Connecting to MySQL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> mysql -u root -p
</span><span class='line'>Enter password:
</span><span class='line'>Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span><span class='line'>Your MySQL connection id is 8
</span><span class='line'>Server version: 5.7.20 MySQL Community Server <span class="o">(</span>GPL<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2017, Oracle and/or its affiliates. All rights reserved.
</span><span class='line'>
</span><span class='line'>Oracle is a registered trademark of Oracle Corporation and/or its
</span><span class='line'>affiliates. Other names may be trademarks of their respective
</span><span class='line'>owners.
</span><span class='line'>
</span><span class='line'>Type <span class="s1">&#39;help;&#39;</span> or <span class="s1">&#39;\h&#39;</span> <span class="k">for</span> help. Type <span class="s1">&#39;\c&#39;</span> to clear the current input statement.
</span><span class='line'>
</span><span class='line'>mysql&gt; show databases<span class="p">;</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> Database           <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> information_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mydb               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mysql              <span class="p">|</span>
</span><span class='line'><span class="p">|</span> performance_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> sys                <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="m">5</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we have deployed adminer, you can access the Adminer WebUI on the Host&rsquo;s IP and the Defined Port.</p>

<h2>Testing Data Persistance:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> mysql -u root -p
</span><span class='line'>Enter password:
</span><span class='line'>Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span><span class='line'>
</span><span class='line'>mysql&gt; create database ruan<span class="p">;</span>
</span><span class='line'>Query OK, <span class="m">1</span> row affected <span class="o">(</span>0.00 sec<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>mysql&gt; show databases<span class="p">;</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> Database           <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> information_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mydb               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mysql              <span class="p">|</span>
</span><span class='line'><span class="p">|</span> performance_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> ruan               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> sys                <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="m">6</span> rows in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>mysql&gt; <span class="nb">exit</span><span class="p">;</span>
</span><span class='line'>Bye
</span></code></pre></td></tr></table></div></figure>


<p>Verify the hostname of our container, before we kill the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> hostname
</span><span class='line'>bdedb54bbc2b
</span></code></pre></td></tr></table></div></figure>


<p>Kill the container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">kill</span> <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span>
</span><span class='line'>bdedb54bbc2b
</span></code></pre></td></tr></table></div></figure>


<p>Verify the status of the MySQL Service, as we can see the service count is 0, so the container was succesfully killed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ls -f <span class="nv">name</span><span class="o">=</span>apps_db
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
</span><span class='line'>nzf96q05fktm        apps_db             replicated          0/1                 mysql:latest        *:3306-&gt;3306/tcp
</span></code></pre></td></tr></table></div></figure>


<p>After waiting for a couple of seconds, we can see the service is in service again, then check the hostname so that we can confirm that its a new container:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker service ls -f <span class="nv">name</span><span class="o">=</span>apps_db
</span><span class='line'>ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
</span><span class='line'>nzf96q05fktm        apps_db             replicated          1/1                 mysql:latest        *:3306-&gt;3306/tcp
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> hostname
</span><span class='line'>95c15c89f891
</span></code></pre></td></tr></table></div></figure>


<p>Logong to MySQL again and verify if our perviously created database is still there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker <span class="nb">exec</span> -it <span class="k">$(</span>docker ps -f <span class="nv">name</span><span class="o">=</span>apps_db -q<span class="k">)</span> mysql -u root -p
</span><span class='line'>Enter password:
</span><span class='line'>Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span><span class='line'>
</span><span class='line'>mysql&gt; show databases<span class="p">;</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> Database           <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="p">|</span> information_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mydb               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> mysql              <span class="p">|</span>
</span><span class='line'><span class="p">|</span> performance_schema <span class="p">|</span>
</span><span class='line'><span class="p">|</span> ruan               <span class="p">|</span>
</span><span class='line'><span class="p">|</span> sys                <span class="p">|</span>
</span><span class='line'>+--------------------+
</span><span class='line'><span class="m">6</span> rows in <span class="nb">set</span> <span class="o">(</span>0.01 sec<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>By design docker is stateless, but as we mapped the host&rsquo;s path to the container our data is persistent. As we have set a constraint so that the container must only spin up on this node, the container will always have access to the data path.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/22/setup-a-3-node-galera-mariadb-cluster-on-ubuntu-16/">Setup a 3 Node Galera MariaDB Cluster on Ubuntu 16</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-22T18:17:14-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>6:17 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/lpT6Du.jpg" alt="" /></p>

<p>Today we will setup a 3-Node Galera MariaDB Cluster which is a Multi Master MySQL/MariaDB Cluster on Ubuntu 16.04</p>

<h2>Our Server Details:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>172.31.11.174     mysql-1
</span><span class='line'>172.31.13.206     mysql-2
</span><span class='line'>172.31.6.93       mysql-3
</span></code></pre></td></tr></table></div></figure>


<h2>Update Repo Index and Upgrade:</h2>

<p>Update the repository indexes and install the needed packages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo apt update <span class="o">&amp;&amp;</span> sudo apt upgrade -y
</span></code></pre></td></tr></table></div></figure>


<p>Install the needed repository and packages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install software-properties-common -y
</span><span class='line'><span class="nv">$ </span>apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8
</span><span class='line'><span class="nv">$ </span>add-apt-repository <span class="s1">&#39;deb [arch=amd64,i386,ppc64el] http://mirror.lstn.net/mariadb/repo/10.1/ubuntu xenial main&#39;</span>
</span><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>apt install mariadb-server rsync -y
</span></code></pre></td></tr></table></div></figure>


<h2>Configuration:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat &gt; /etc/mysql/conf.d/galera.cnf <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">[mysqld]</span>
</span><span class='line'><span class="s">binlog_format=ROW</span>
</span><span class='line'><span class="s">default-storage-engine=innodb</span>
</span><span class='line'><span class="s">innodb_autoinc_lock_mode=2</span>
</span><span class='line'><span class="s">bind-address=0.0.0.0</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Galera Provider Configuration</span>
</span><span class='line'><span class="s">wsrep_on=ON</span>
</span><span class='line'><span class="s">wsrep_provider=/usr/lib/galera/libgalera_smm.so</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Galera Cluster Configuration</span>
</span><span class='line'><span class="s">wsrep_cluster_name=&quot;my-galera-cluster&quot;</span>
</span><span class='line'><span class="s">wsrep_cluster_address=&quot;gcomm://172.31.11.174,172.31.13.206,172.31.6.93&quot;</span>
</span><span class='line'><span class="s"># Galera Synchronization Configuration</span>
</span><span class='line'><span class="s">wsrep_sst_method=rsync</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Galera Node Configuration</span>
</span><span class='line'><span class="s">wsrep_node_address=&quot;172.31.11.174&quot;</span>
</span><span class='line'><span class="s">wsrep_node_name=&quot;mysql-1&quot;</span>
</span><span class='line'><span class="s">EOF</span>
</span></code></pre></td></tr></table></div></figure>


<p>Comment out bind-address, so that MariaDB process is reachable from other nodes, by default it wont be in the config, but just to make sure, if it is uncommented, comment the config:</p>

<figure class='code'><figcaption><span>/etc/mysql/my.cnf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># bind-address = 127.0.0.1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Stop the MariaDB Process:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl stop mariadb
</span></code></pre></td></tr></table></div></figure>


<p>Note: Repeat the above steps on all 3 nodes.</p>

<h2>Initialize the Cluster:</h2>

<p>On the First Node, Initialize the Galera Cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/usr/bin/galera_new_cluster
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>mariadb
</span></code></pre></td></tr></table></div></figure>


<p>Check how many nodes are active in the Cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Node-2: Start and Enable MariaDB</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl start mariadb
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>mariadb
</span></code></pre></td></tr></table></div></figure>


<p>Verify that the Node has checked in with the Cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">2</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Node-3: Start and Enable MariaDB</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl start mariadb
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>mariadb
</span></code></pre></td></tr></table></div></figure>


<p>Verify that the Node has checked in with the Cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">3</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Create a Database, Table and Record:</h2>

<p>Write some data to the table, then reboot the node, in this example on node-1, then logon to node-2 check the number of nodes that&rsquo;s active in the cluster, which should be 2, then at the same time, look if the data is replicated:</p>

<h2>Node-1: Writing the Data to Our Galera Cluster</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">use</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">create</span> <span class="k">database</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">create</span> <span class="k">table</span> <span class="nf">foo</span> <span class="p">(</span><span class="n">name</span> <span class="kt">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="k">values</span><span class="p">(</span><span class="s1">&#39;ruan&#39;</span><span class="p">);</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'><span class="o">+------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">name</span> <span class="o">|</span>
</span><span class='line'><span class="o">+------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">ruan</span> <span class="o">|</span>
</span><span class='line'><span class="o">+------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that our data is in our database, reboot the node, logon to node-2 and check if the data is replicated:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="k">use</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'><span class="n">MariaDB</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">&gt;</span>   <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'><span class="o">+------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">name</span> <span class="o">|</span>
</span><span class='line'><span class="o">+------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">ruan</span> <span class="o">|</span>
</span><span class='line'><span class="o">+------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>While the one node is rebooting, check how many nodes are checked into our cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">2</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our data is replicated, and after waiting for a couple of seconds, we retry our command to see if the rebooted node checked into the cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='mysql'><span class='line'><span class="err">$</span> <span class="n">mysql</span> <span class="o">-</span><span class="n">u</span> <span class="n">root</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;SHOW STATUS LIKE &#39;wsrep_cluster_size&#39;;&quot;</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">Variable_name</span>      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">wsrep_cluster_size</span> <span class="o">|</span> <span class="mi">3</span>     <span class="o">|</span>
</span><span class='line'><span class="o">+--------------------+-------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can confirm that the node that was rebooted, has checked in with the cluster again.</p>

<h2>Firewall Rules opened while testing:</h2>

<p>TCP: <code>3306, 4567, 4568, 4444</code>
UDP: <code>4567</code></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/11/22/delete-old-items-with-amazons-dynamodb-ttl-feature/">Delete Old Items With Amazons DynamoDB TTL Feature</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-11-22T17:47:31-05:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>5:47 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://obj-cache.cloud.ruanbekker.com/dynamodb.png" alt="" /></p>

<p>As you may know a DynamoDB Table&rsquo;s Partition Splits on 2 factors, Read/Write Capacity Units and when Storage goes over 10GB.</p>

<h2>Automatically Deleting Old Data in DynamoDB:</h2>

<p>With the TTL Feature in DynamoDB, we can enable TTL on a Attribute on our Table, the attributes value needs to have an epoc time value, more specifically, when the current time is the same as the value of on of the items attribute value, that item will be expired, which will be deleted.</p>

<h2>What we will be doing:</h2>

<ul>
<li>Use Boto3 in Python</li>
<li>Create DynamoDB Table: &lsquo;session-table&rsquo;</li>
<li>Set TTL Attribute on &lsquo;ExpirationTime&rsquo;, so whenever the epoch time is equals to the AttributeValue it will delete the item</li>
<li>Do one PUT Item with 48 Hours expiry Date from the Write</li>
<li>Do 240 PUT Items with 24 Hours expiry Date from the Write</li>
<li>Verify after 24 hours if only one item is in our table.</li>
</ul>


<h2>Pre-Requisites:</h2>

<p>Install the AWS CLI, Boto3 and configure your credentials, so that boto3 can read from your credential provider:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install awscli
</span><span class='line'><span class="nv">$ </span>pip install boto3
</span><span class='line'><span class="nv">$ </span>aws configure
</span><span class='line'>AWS Access Key ID <span class="o">[</span>****************XYZ<span class="o">]</span>:
</span><span class='line'>AWS Secret Access Key <span class="o">[</span>****************xyz<span class="o">]</span>:
</span><span class='line'>Default region name <span class="o">[</span>eu-west-1<span class="o">]</span>:
</span><span class='line'>Default output format <span class="o">[</span>json<span class="o">]</span>:
</span></code></pre></td></tr></table></div></figure>


<h2>Create the Table:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="err">$</span> <span class="n">python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
</span><span class='line'>    <span class="n">TableName</span><span class="o">=</span><span class="s">&#39;session-table&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">KeySchema</span><span class="o">=</span><span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s">&#39;sessionid&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;KeyType&#39;</span><span class="p">:</span> <span class="s">&#39;HASH&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="n">AttributeDefinitions</span><span class="o">=</span><span class="p">[</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;AttributeName&#39;</span><span class="p">:</span> <span class="s">&#39;sessionid&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;AttributeType&#39;</span><span class="p">:</span> <span class="s">&#39;S&#39;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">],</span>
</span><span class='line'>    <span class="n">ProvisionedThroughput</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;ReadCapacityUnits&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;WriteCapacityUnits&#39;</span><span class="p">:</span> <span class="mi">2</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>From the Console, enable TTL and set the TTL Attribute on <code>ExpirationTime</code></p>

<h2>Write Data to DynamoDB</h2>

<p>We have 2 functions that will write the current epoch time to the <code>CreationTime</code> attribute and <code>ExpirationTime</code> will have the current time plus the 24 hours in seconds, which will be used for the 240 items that will be written using the for loop and the other function with the 48 hours of seconds, which will be a single write item.</p>

<p>Then we will just write random data to the session data attribute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
</span><span class='line'>
</span><span class='line'><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;james&#39;</span><span class="p">,</span> <span class="s">&#39;john&#39;</span><span class="p">,</span> <span class="s">&#39;steve&#39;</span><span class="p">,</span> <span class="s">&#39;peter&#39;</span><span class="p">,</span> <span class="s">&#39;frank&#39;</span><span class="p">,</span> <span class="s">&#39;steven&#39;</span><span class="p">,</span> <span class="s">&#39;jonathan&#39;</span><span class="p">,</span> <span class="s">&#39;stephen&#39;</span><span class="p">,</span> <span class="s">&#39;will&#39;</span><span class="p">,</span> <span class="s">&#39;adam&#39;</span><span class="p">,</span> <span class="s">&#39;william&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">retailer</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;shoprite&#39;</span><span class="p">,</span> <span class="s">&#39;edgars&#39;</span><span class="p">,</span> <span class="s">&#39;pnp&#39;</span><span class="p">,</span> <span class="s">&#39;bestbuy&#39;</span><span class="p">,</span> <span class="s">&#39;ok&#39;</span><span class="p">,</span> <span class="s">&#39;grocer-a&#39;</span><span class="p">,</span> <span class="s">&#39;amazon&#39;</span><span class="p">,</span> <span class="s">&#39;seveneleven&#39;</span><span class="p">,</span> <span class="s">&#39;shop-a&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">,</span> <span class="n">profile_name</span><span class="o">=</span><span class="s">&#39;dev&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">ddb</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s">&#39;dynamodb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="n">ddb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">&#39;session-table&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">current_time</span><span class="p">():</span>
</span><span class='line'>    <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">current_time</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">expiration_time</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="mi">86400</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="err">48</span><span class="nf">h_expiration_time</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="mi">172800</span>
</span><span class='line'>
</span><span class='line'><span class="c"># expiry on 48 hours</span>
</span><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
</span><span class='line'>    <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;sessionid&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span class='line'>        <span class="s">&#39;CreationTime&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">(),</span>
</span><span class='line'>        <span class="s">&#39;ExpirationTime&#39;</span><span class="p">:</span> <span class="mi">48</span><span class="n">h_expiration_time</span><span class="p">(),</span>
</span><span class='line'>        <span class="s">&#39;SessionData&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">names</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&#39;Retailer&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">retailer</span><span class="p">),</span>
</span><span class='line'>            <span class="s">&#39;TimeOfTransaction&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">(),</span>
</span><span class='line'>            <span class="s">&#39;Amount&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">9000</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># expiry on 24 hours</span>
</span><span class='line'><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">240</span><span class="p">):</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>    <span class="n">client</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Item</span><span class="o">=</span><span class="p">{</span>
</span><span class='line'>            <span class="s">&#39;sessionid&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()),</span>
</span><span class='line'>            <span class="s">&#39;CreationTime&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">(),</span>
</span><span class='line'>            <span class="s">&#39;ExpirationTime&#39;</span><span class="p">:</span> <span class="n">expiration_time</span><span class="p">(),</span>
</span><span class='line'>            <span class="s">&#39;SessionData&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>                <span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">names</span><span class="p">),</span>
</span><span class='line'>                <span class="s">&#39;Retailer&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">retailer</span><span class="p">),</span>
</span><span class='line'>                <span class="s">&#39;TimeOfTransaction&#39;</span><span class="p">:</span> <span class="n">current_time</span><span class="p">(),</span>
</span><span class='line'>                <span class="s">&#39;Amount&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">9000</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Verify:</h2>

<p>Verify after 24 hours if the item with the 48 hour expiration time is still in our table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span> <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;sessionid&#39;</span><span class="p">:</span> <span class="s">&#39;69c2a472-f70e-4d72-b25f-e27573696b0c&#39;</span><span class="p">}</span> <span class="p">)[</span><span class="s">&#39;Item&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s">u&#39;ExpirationTime&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;1510672221&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="s">u&#39;CreationTime&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;1510585821&#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="s">u&#39;sessionid&#39;</span><span class="p">:</span> <span class="s">u&#39;69c2a472-f70e-4d72-b25f-e27573696b0c&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">u&#39;SessionData&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">u&#39;Amount&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;3553&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="s">u&#39;Retailer&#39;</span><span class="p">:</span> <span class="s">u&#39;amazon&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">u&#39;TimeOfTransaction&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;1510585821&#39;</span><span class="p">),</span>
</span><span class='line'>        <span class="s">u&#39;Name&#39;</span><span class="p">:</span> <span class="s">u&#39;steve&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which we can see is still there, when doing a GET item on one of our 24 hour expired items, we can see that its no longer there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span> <span class="n">Key</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;sessionid&#39;</span><span class="p">:</span> <span class="s">&#39;70b9fc8c-19c4-49d3-bf63-046e992335af&#39;</span><span class="p">}</span> <span class="p">)[</span><span class="s">&#39;Item&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
</span><span class='line'><span class="ne">KeyError</span><span class="p">:</span> <span class="s">&#39;Item&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doing a SCAN operation, we should see one item:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="s">&#39;session-table&#39;</span><span class="p">,</span> <span class="n">Limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">Select</span><span class="o">=</span><span class="s">&#39;COUNT&#39;</span><span class="p">,</span> <span class="n">ReturnConsumedCapacity</span><span class="o">=</span><span class="s">&#39;TOTAL&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;Count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;ScannedCount&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;ConsumedCapacity&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;CapacityUnits&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;TableName&quot;</span><span class="p">:</span> <span class="s">&quot;session-table&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&quot;ResponseMetadata&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;RetryAttempts&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;HTTPStatusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;RequestId&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;HTTPHeaders&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;x-amzn-requestid&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;content-length&quot;</span><span class="p">:</span> <span class="s">&quot;107&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;server&quot;</span><span class="p">:</span> <span class="s">&quot;Server&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;connection&quot;</span><span class="p">:</span> <span class="s">&quot;keep-alive&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;x-amz-crc32&quot;</span><span class="p">:</span> <span class="s">&quot;2228370918&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;date&quot;</span><span class="p">:</span> <span class="s">&quot;Tue, 14 Nov 2017 12:02:31 GMT&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;content-type&quot;</span><span class="p">:</span> <span class="s">&quot;application/x-amz-json-1.0&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we can confirm that the TTL feature expires the data based on the epoch value we provide our item.</p>

<h2>Delete the Table:</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">TableName</span><span class="o">=</span><span class="s">&#39;session-table&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<ul>
<li><a href="https://sysadmins.co.za/interfacing-amazon-dynamodb-with-python-using-boto3/">https://sysadmins.co.za/interfacing-amazon-dynamodb-with-python-using-boto3/</a></li>
<li><a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html">http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/9">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/7">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018/09/01/give-your-database-a-break-and-use-memcached-to-return-frequently-accessed-data/">Give Your Database a Break and Use Memcached to Return Frequently Accessed Data</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/09/01/dockerizing-a-memcached-server-for-docker-on-alpine/">Dockerizing a Memcached Server for Docker on Alpine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/08/29/review-and-secure-your-facebook-account/">Review and Secure Your Facebook Account</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/08/27/distributing-a-shared-secret-amongst-a-group-of-participants-using-shamirs-secret-sharing-scheme-aka-ssss/">Distributing a Shared Secret Amongst a Group of Participants Using Shamirs Secret Sharing Scheme Aka Ssss</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/08/27/improving-performance-from-your-lambda-function-from-the-use-of-global-variables/">Improving Performance From Your Lambda Function From the Use of Global Variables</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2018 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
