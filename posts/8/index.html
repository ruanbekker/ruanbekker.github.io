
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ruan Bekker's Blog</title>
  <meta name="author" content="Ruan">

  
  <meta name="description" content="A quick post on how create custom CloudWatch Metrics using Python on AWS. After you produced the metrics into CloudWatch, you will be able to see &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <!-- font awesome --!>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

  <!-- samwize.com/2012/09/24/octopress-table-stylesheet --!>
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  
  <link rel="canonical" href="https://blog.ruanbekker.com/posts/8/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ruan Bekker's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-105336110-1']);
    _gaq.push(['_setDomainName','ruanbekker.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  <!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.ruan.dev/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

  <!-- Twitter cards # www.brianbunke.com/blog/2017/09/06/twitter-cards-on-jekyll -->
<meta name="twitter:site"    content="@ruanbekker">
<meta name="twitter:creator" content="@">
<meta name="twitter:title"   content="">


<meta name="twitter:description" content="">



<meta name="twitter:card"  content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/567298/69000657-c093e780-08db-11ea-8464-bcd3023e9923.png">

<!-- end of Twitter cards -->

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ruan Bekker's Blog</a></h1>
  
    <h2>From a Curious mind to Posts on Github</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://blog.ruanbekker.com/search/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="blog.ruanbekker.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/categories/aws/">AWS</a></li>
  <li><a href="/blog/categories/docker/">Docker</a></li>
  <li><a href="/blog/categories/devops/">DevOps</a></li>
  <li><a href="/blog/categories/python/">Python</a></li>
  <li><a target="_blank" href="https://sysadmins.co.za">My Sysadmins Blog</a></li>
  <li><a href="https://ruan.dev/">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/28/snippet-create-custom-cloudwatch-metrics-with-python/">Snippet: Create Custom CloudWatch Metrics With Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-28T14:05:28+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>2:05 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/53865781-a984c200-3ff8-11e9-9ffa-ccad62ac08f6.png" alt="" /></p>

<p>A quick post on how create custom CloudWatch Metrics using Python on AWS.</p>

<p>After you produced the metrics into CloudWatch, you will be able to see them when navigating to:</p>

<ul>
<li>CloudWatch / Metrics / Custom Namespaces / statusdash/ec2client</li>
</ul>


<p>When selecting:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Select Metric: SomeKey1, SomeKey2
</span><span class='line'>Select MetricName HttpResponseTime</span></code></pre></td></tr></table></div></figure>


<p>And should look like this:</p>

<p><img src="https://user-images.githubusercontent.com/567298/53865426-d4224b00-3ff7-11e9-8bd5-bd04dfdd9f43.png" alt="" /></p>

<h2>The Script:</h2>

<p>The python script that will be using boto3 to talk to AWS:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">boto3</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'><span class="n">cloudwatch</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s">&#39;eu-west-1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;cloudwatch&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">cloudwatch</span><span class="o">.</span><span class="n">put_metric_data</span><span class="p">(</span>
</span><span class='line'><span class="n">MetricData</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;MetricName&#39;</span><span class="p">:</span> <span class="s">&#39;HttpResponseTime&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;Dimensions&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="s">&#39;Server&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="s">&#39;app.example.com&#39;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="s">&#39;Name&#39;</span><span class="p">:</span> <span class="s">&#39;Client&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="s">&#39;Client-ABC&#39;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>        <span class="s">&#39;Unit&#39;</span><span class="p">:</span> <span class="s">&#39;Milliseconds&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;Value&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">],</span>
</span><span class='line'><span class="n">Namespace</span> <span class="o">=</span> <span class="s">&#39;statusdash/ec2client&#39;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">response</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Resources:</h2>

<p><a href="https://stackify.com/custom-metrics-aws-lambda/">https://stackify.com/custom-metrics-aws-lambda/</a>
<a href="https://www.syntouch.nl/custom-cloudwatch-metrics-in-python-yes-we-can/">https://www.syntouch.nl/custom-cloudwatch-metrics-in-python-yes-we-can/</a> &lt;- psutil
<a href="https://aws.amazon.com/blogs/devops/new-how-to-better-monitor-your-custom-application-metrics-using-amazon-cloudwatch-agent/">https://aws.amazon.com/blogs/devops/new-how-to-better-monitor-your-custom-application-metrics-using-amazon-cloudwatch-agent/</a>
<a href="https://medium.com/@mrdoro/aws-lambda-as-the-website-monitoring-tool-184b09202ae2">https://medium.com/@mrdoro/aws-lambda-as-the-website-monitoring-tool-184b09202ae2</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/27/concourse-pipeline-to-build-a-docker-image-automatically-on-git-commit/">Concourse Pipeline to Build a Docker Image Automatically on Git Commit</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-27T23:50:54+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>11:50 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://i.snag.gy/gzkdu9.jpg?nocache=1511644783495" alt="" /></p>

<p>In this tutorial we will build a ci pipeline using concourse to build and push a image to dockerhub automatically, whenever a new git commit is made to the master branch.</p>

<h2>Our Project Setup</h2>

<p>Our Directory Tree:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>find .
</span><span class='line'>./Dockerfile
</span><span class='line'>./ci
</span><span class='line'>./ci/pipeline.yml
</span><span class='line'>./README.md
</span><span class='line'>./docker-tunnel
</span></code></pre></td></tr></table></div></figure>


<p>The project used in this example is not important, but you can check it out at <a href="https://github.com/ruanbekker/docker-remote-tunnel">https://github.com/ruanbekker/docker-remote-tunnel</a></p>

<h2>Our Pipeline</h2>

<p>A visual to see how the pipeline will look like in concourse:</p>

<p><img src="https://user-images.githubusercontent.com/567298/55114996-1832d800-50ec-11e9-85ef-bc283711fbde.png" alt="" /></p>

<p>Our pipeline definition will consist of 3 resources, <code>github repo</code>, <code>dockerhub image</code> and a <code>slack resource</code> to inform use whether a build has completed.</p>

<p>Then we are specifying that the job should be triggered on a git commit for the master branch, build and push to our dockerhub repo.</p>

<p>Our pipeline definition <code>ci/pipeline.yml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git</span>
</span><span class='line'>  <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">uri</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git@github.com:ruanbekker/docker-remote-tunnel.git</span>
</span><span class='line'>    <span class="l-Scalar-Plain">branch</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">master</span>
</span><span class='line'>    <span class="l-Scalar-Plain">private_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">((github_private_key))</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-remote-tunnel-image</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>  <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ruanbekker/docker-remote-tunnel</span>
</span><span class='line'>    <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>    <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">((dockerhub_user))</span>
</span><span class='line'>    <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">((dockerhub_password))</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-notification</span>
</span><span class='line'>  <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">((slack_notification_url))</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource_types</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-notification</span>
</span><span class='line'>    <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>    <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cfcommunity/slack-notification-resource</span>
</span><span class='line'>      <span class="l-Scalar-Plain">tag</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1.3.0</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">jobs</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">build-cached-image</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">get</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>    <span class="l-Scalar-Plain">trigger</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">build-cached-image-workspace</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">image_resource</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-image</span>
</span><span class='line'>        <span class="l-Scalar-Plain">source</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rbekker87/build-tools</span>
</span><span class='line'>
</span><span class='line'>      <span class="l-Scalar-Plain">outputs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">workspace</span>
</span><span class='line'>      <span class="l-Scalar-Plain">inputs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/bin/sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">-c</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">|</span>
</span><span class='line'>          <span class="no">output_dir=workspace</span>
</span><span class='line'>
</span><span class='line'>          <span class="no">cat &lt;&lt; EOF &gt; &quot;${output_dir}/Dockerfile&quot;</span>
</span><span class='line'>          <span class="no">FROM alpine</span>
</span><span class='line'>
</span><span class='line'>          <span class="no">ADD git-repo /tmp/git-repo</span>
</span><span class='line'>          <span class="no">RUN mv /tmp/git-repo/docker-tunnel /usr/bin/docker-tunnel</span>
</span><span class='line'>          <span class="no">RUN apk --no-cache add screen docker openssl openssh-client apache2-utils</span>
</span><span class='line'>          <span class="no">RUN /usr/bin/docker-tunnel -h</span>
</span><span class='line'>          <span class="no">RUN rm -rf /tmp/git-repo</span>
</span><span class='line'>          <span class="no">EOF</span>
</span><span class='line'>
</span><span class='line'>          <span class="no">cp -R ./git-repo &quot;${output_dir}/git-repo&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-remote-tunnel-image</span>
</span><span class='line'>    <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">workspace</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">on_failure</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>      <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">channel</span><span class="p-Indicator">:</span> <span class="s">&#39;#system_events&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;concourse&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">icon_emoji</span><span class="p-Indicator">:</span> <span class="s">&#39;:concourse:&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="l-Scalar-Plain">text</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>            <span class="no">*$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* ($BUILD_NAME) FAILED to build image</span>
</span><span class='line'>            <span class="no">https://ci.domain.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME</span>
</span><span class='line'>    <span class="l-Scalar-Plain">on_success</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>      <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">channel</span><span class="p-Indicator">:</span> <span class="s">&#39;#system_events&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;concourse&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">icon_emoji</span><span class="p-Indicator">:</span> <span class="s">&#39;:concourse:&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="l-Scalar-Plain">text</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>            <span class="no">*$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* ($BUILD_NAME) SUCCESS - Image has been published</span>
</span><span class='line'>            <span class="no">https://ci.domain.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
</span><span class='line'>  <span class="l-Scalar-Plain">plan</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">get</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-remote-tunnel-image</span>
</span><span class='line'>    <span class="l-Scalar-Plain">passed</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">build-cached-image</span><span class="p-Indicator">]</span>
</span><span class='line'>    <span class="l-Scalar-Plain">trigger</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">get</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>    <span class="l-Scalar-Plain">passed</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">build-cached-image</span><span class="p-Indicator">]</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">task</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">run-tests</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">docker-remote-tunnel-image</span>
</span><span class='line'>    <span class="l-Scalar-Plain">config</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">platform</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">linux</span>
</span><span class='line'>      <span class="l-Scalar-Plain">inputs</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>      <span class="l-Scalar-Plain">run</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">dir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git-repo</span>
</span><span class='line'>        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sh</span>
</span><span class='line'>        <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/usr/bin/docker-tunnel</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">--help</span>
</span><span class='line'>
</span><span class='line'>    <span class="l-Scalar-Plain">on_failure</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>      <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">channel</span><span class="p-Indicator">:</span> <span class="s">&#39;#system_events&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;concourse&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">icon_emoji</span><span class="p-Indicator">:</span> <span class="s">&#39;:concourse:&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="l-Scalar-Plain">text</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>            <span class="no">*$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* ($BUILD_NAME) FAILED - Testing image failure</span>
</span><span class='line'>            <span class="no">https://ci.domain.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME</span>
</span><span class='line'>    <span class="l-Scalar-Plain">on_success</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">put</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">slack-alert</span>
</span><span class='line'>      <span class="l-Scalar-Plain">params</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">channel</span><span class="p-Indicator">:</span> <span class="s">&#39;#system_events&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&#39;concourse&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">icon_emoji</span><span class="p-Indicator">:</span> <span class="s">&#39;:concourse:&#39;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">silent</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>        <span class="l-Scalar-Plain">text</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>            <span class="no">*$BUILD_PIPELINE_NAME/$BUILD_JOB_NAME* ($BUILD_NAME) SUCCESS - Testing image Succeeded</span>
</span><span class='line'>            <span class="no">https://ci.domain.com/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that our secret information is templatized and saved in our local <code>credentials.yml</code> which should never be stored in version control:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">slack_notification_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://api.slack.com/aaa/bbb/ccc</span>
</span><span class='line'><span class="l-Scalar-Plain">dockerhub_user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">myuser</span>
</span><span class='line'><span class="l-Scalar-Plain">dockerhub_password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mypasswd</span>
</span><span class='line'><span class="l-Scalar-Plain">github_private_key</span><span class="p-Indicator">:</span> <span class="p-Indicator">|-</span>
</span><span class='line'>        <span class="no">-----BEGIN RSA PRIVATE KEY-----</span>
</span><span class='line'>        <span class="no">some-secret-data</span>
</span><span class='line'>        <span class="no">-----END RSA PRIVATE KEY------</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Set the Pipeline:</h2>

<p>Now that we have our pipeline definition, credentials and application code (stored in version control), go ahead and set the pipeline, which will save the pipeline configuration in concourse:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># pipeline name: my-docker-app-pipeline</span>
</span><span class='line'><span class="nv">$ </span>fly -t scw sp -n main -c pipeline.yml -p my-docker-app-pipeline -l credentials.yml
</span></code></pre></td></tr></table></div></figure>


<p>Now the pipeline is saved on concourse but in a paused state, go ahead and unpause the pipeline:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>fly -t scw up -p my-docker-app-pipeline
</span></code></pre></td></tr></table></div></figure>


<h2>Test your Pipeline</h2>

<p>Make a commit to master and head over to concourse and look at it go:</p>

<p><img src="https://user-images.githubusercontent.com/567298/55116018-a5772c00-50ee-11e9-861e-a5ddc74550e2.png" alt="" /></p>

<p>Thanks for reading, make sure to check out my other posts on <a href="https://blog.ruanbekker.com/blog/categories/concourse">#concourse</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/27/ship-your-logs-to-elasticsearch-with-filebeat/">Ship Your Logs to Elasticsearch With Filebeat</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-27T16:52:21+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>4:52 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/55086561-4b0baa80-50b1-11e9-8062-a9e6de5ab56a.png" alt="" /></p>

<p><strong><a href="https://www.elastic.co/guide/en/beats/filebeat/6.7/filebeat-overview.html">Filebeat</a></strong> by Elastic is a lightweight log shipper, that ships your logs to Elastic products such as Elasticsearch and Logstash. Filbeat monitors the logfiles from the given configuration and ships the to the locations that is specified.</p>

<h2>Filebeat Overview</h2>

<p>Filebeat runs as agents, monitors your logs and ships them in response of events, or whenever the logfile receives data.</p>

<p>Below is a overview (credit: elastic.co) how Filebeat works</p>

<p><img src="https://user-images.githubusercontent.com/567298/55086346-e18b9c00-50b0-11e9-8eac-ea4880cb1aff.png" alt="" /></p>

<h2>Installing Filebeat</h2>

<p>Let&rsquo;s go ahead and install Filebeat. I will be using version 6.7 as that will be the same version that I am running on my Elasticsearch. To check the version of your elasticsearch cluster:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://127.0.0.1:9200/_cluster/health?pretty <span class="c"># i have es running locally</span>
</span></code></pre></td></tr></table></div></figure>


<p>Install the dependencies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install wget apt-transport-https -y
</span></code></pre></td></tr></table></div></figure>


<p>Get the public signing key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch <span class="p">|</span> sudo apt-key add -
</span></code></pre></td></tr></table></div></figure>


<p>Get the repository definition:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;deb https://artifacts.elastic.co/packages/6.x/apt stable main&quot;</span> <span class="p">|</span> tee -a /etc/apt/sources.list.d/elastic-6.x.list
</span></code></pre></td></tr></table></div></figure>


<p>Update the repositories:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update <span class="o">&amp;&amp;</span> apt upgrade -y
</span></code></pre></td></tr></table></div></figure>


<p>Install Filebeat and enable the service on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install filebeat -y
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>filebeat
</span></code></pre></td></tr></table></div></figure>


<h2>Configure Filebeat</h2>

<p>Let&rsquo;s configure our main configuration in filebeat, to specify our location where the data should be shipped to (in this case elasticsearch) and I will also like to set some extra fields that will apply to this specific server.</p>

<p>Open up <code>/etc/filebeat/filebeat.yml</code> and edit the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">filebeat.inputs</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">log</span>
</span><span class='line'>  <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>  <span class="l-Scalar-Plain">paths</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/log/nginx/*.log</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">filebeat.config.modules</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">${path.config}/modules.d/*.yml</span>
</span><span class='line'>  <span class="l-Scalar-Plain">reload.enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">setup.template.settings</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">index.number_of_shards</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">fields</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">blog_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sysadmins</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webserver</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cloud_provider</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">setup.kibana</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="s">&quot;http://localhost:5601&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&quot;elastic&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&quot;changeme&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">output.elasticsearch</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;localhost:9200&quot;</span><span class="p-Indicator">]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="s">&quot;http&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&quot;elastic&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&quot;changeme&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Above, just setting my path to nginx access logs, some extra fields, including that it shoulds seed kibana with example visualizations and the output configuration of elasticsearch.</p>

<h2>Filebeat Modules</h2>

<p>Filebeat comes with modules that has context on specific applications like nginx, mysql etc. Lets enable system (syslog, auth, etc) and nginx for our web server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>filebeat modules <span class="nb">enable </span>system
</span><span class='line'><span class="nv">$ </span>filebeat modules <span class="nb">enable </span>nginx
</span></code></pre></td></tr></table></div></figure>


<p>Example of my <code>/etc/filebeat/modules.d/system.yml</code> configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">system</span>
</span><span class='line'>  <span class="l-Scalar-Plain">syslog</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var.paths</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;/var/log/syslog&quot;</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">auth</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var.paths</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;/var/log/auth.log&quot;</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Example of my <code>/etc/filebeat/modules.d/nginx.yml</code> configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nginx</span>
</span><span class='line'>  <span class="l-Scalar-Plain">access</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var.paths</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;/var/log/nginx/access.log&quot;</span><span class="p-Indicator">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">error</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="l-Scalar-Plain">var.paths</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="s">&quot;/var/log/nginx/error.log&quot;</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now setup the <a href="https://www.elastic.co/guide/en/beats/filebeat/6.7/filebeat-template.html">templates</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>filebeat setup
</span></code></pre></td></tr></table></div></figure>


<p>Then restart filebeat:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/etc/init.d/filebeat restart
</span></code></pre></td></tr></table></div></figure>


<p>You can have a look at the logs, should you need to debug:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tail -f /var/log/filebeat/filebeat
</span></code></pre></td></tr></table></div></figure>


<p>Your data should now be shipped to elasticsearch, by default under the <code>filebeat-YYYY.mm.dd</code> index pattern.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl <span class="s1">&#39;http://127.0.0.1:9200/_cat/indices/filebeat*?v&#39;</span>
</span><span class='line'>health status index                     uuid                   pri rep docs.count docs.deleted store.size pri.store.size
</span><span class='line'>green  open   filebeat-6.7.1-2019.03.27 CBdV7adjRKypN1wguwuHDA   <span class="m">3</span>   <span class="m">1</span>     <span class="m">453220</span>            <span class="m">0</span>    230.2mb        115.9mb
</span></code></pre></td></tr></table></div></figure>


<h2>Kibana</h2>

<p>You can head over to Kibana at <a href="http://localhost:5601">http://localhost:5601</a> (in this case) to visualize the data that is ingested into your filebeat index. I will write a tutorial on how to graph up most common dashboards later this week.</p>

<p>Thats it for now :D</p>

<h2>Resources:</h2>

<ul>
<li><a href="https://www.elastic.co/guide/en/beats/filebeat/6.7/index.html">https://www.elastic.co/guide/en/beats/filebeat/6.7/index.html</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/21/how-to-deploy-a-docker-swarm-cluster-on-scaleway-with-terraform/">How to Deploy a Docker Swarm Cluster on Scaleway With Terraform</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-21T08:15:07+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2019</span></span> <span class='time'>8:15 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/54737111-09fa2e80-4bb7-11e9-97f4-a94a31fc9a3a.png" alt="" /></p>

<p>We will deploy a 3 node docker swarm cluster with terraform on scaleway. I have used the base source code from <a href="https://github.com/stefanprodan/scaleway-swarm-terraform">this</a> repository but tweaked the configuration to my needs.</p>

<h2>Pre-Requisites</h2>

<p>Ensure terraform and jq is instaled:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install terraform
</span><span class='line'><span class="nv">$ </span>brew install jq
</span></code></pre></td></tr></table></div></figure>


<h2>Terraform</h2>

<p>You can have a look at the linked source at the top for the source code, but below I will provide each file that will make up our terraform deployment.</p>

<p>Ource <code>main.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>provider <span class="s2">&quot;scaleway&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">region</span> <span class="o">=</span> <span class="s2">&quot;${var.region}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;scaleway_bootscript&quot;</span> <span class="s2">&quot;debian&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">architecture</span> <span class="o">=</span> <span class="s2">&quot;x86_64&quot;</span>
</span><span class='line'>  <span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;x86_64 mainline 4.15.11 rev1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;scaleway_image&quot;</span> <span class="s2">&quot;debian_stretch&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">architecture</span> <span class="o">=</span> <span class="s2">&quot;x86_64&quot;</span>
</span><span class='line'>  <span class="nv">name</span>         <span class="o">=</span> <span class="s2">&quot;Debian Stretch&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;template_file&quot;</span> <span class="s2">&quot;docker_conf&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">template</span> <span class="o">=</span> <span class="s2">&quot;${file(&quot;</span>conf/docker.tpl<span class="s2">&quot;)}&quot;</span>
</span><span class='line'>
</span><span class='line'>  vars <span class="o">{</span>
</span><span class='line'>    <span class="nv">ip</span> <span class="o">=</span> <span class="s2">&quot;${var.docker_api_ip}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>outputs.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>output <span class="s2">&quot;swarm_manager_public_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;swarm_manager_private_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_server.swarm_manager.0.private_ip}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;swarm_workers_public_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${concat(scaleway_server.swarm_worker.*.name, scaleway_server.swarm_worker.*.public_ip)}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;swarm_workers_private_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${concat(scaleway_server.swarm_worker.*.name, scaleway_server.swarm_worker.*.private_ip)}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>output <span class="s2">&quot;workspace&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;${terraform.workspace}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>security-groups.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;scaleway_security_group&quot;</span> <span class="s2">&quot;swarm_managers&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>        <span class="o">=</span> <span class="s2">&quot;swarm_managers&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;Allow HTTP/S and SSH traffic&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;ssh_accept&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 22
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;http_accept&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 80
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;https_accept&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 443
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group&quot;</span> <span class="s2">&quot;swarm_workers&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span>        <span class="o">=</span> <span class="s2">&quot;swarm_workers&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;Allow SSH traffic&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_security_group_rule&quot;</span> <span class="s2">&quot;ssh_accept_workers&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_workers.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">action</span>    <span class="o">=</span> <span class="s2">&quot;accept&quot;</span>
</span><span class='line'>  <span class="nv">direction</span> <span class="o">=</span> <span class="s2">&quot;inbound&quot;</span>
</span><span class='line'>  <span class="nv">ip_range</span>  <span class="o">=</span> <span class="s2">&quot;0.0.0.0/0&quot;</span>
</span><span class='line'>  <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;TCP&quot;</span>
</span><span class='line'>  <span class="nv">port</span>      <span class="o">=</span> 22
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>variables.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>variable <span class="s2">&quot;docker_version&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;18.06.3~ce~3-0~debian&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;region&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;ams1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;manager_instance_type&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;START1-M&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;worker_instance_type&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;START1-M&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;worker_instance_count&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> 2
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>variable <span class="s2">&quot;docker_api_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">default</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>managers.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;scaleway_ip&quot;</span> <span class="s2">&quot;swarm_manager_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span> <span class="o">=</span> 1
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_server&quot;</span> <span class="s2">&quot;swarm_manager&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>          <span class="o">=</span> 1
</span><span class='line'>  <span class="nv">name</span>           <span class="o">=</span> <span class="s2">&quot;${terraform.workspace}-manager-${count.index + 1}&quot;</span>
</span><span class='line'>  <span class="nv">image</span>          <span class="o">=</span> <span class="s2">&quot;${data.scaleway_image.debian_stretch.id}&quot;</span>
</span><span class='line'>  <span class="nb">type</span>           <span class="o">=</span> <span class="s2">&quot;${var.manager_instance_type}&quot;</span>
</span><span class='line'>  <span class="nv">bootscript</span>     <span class="o">=</span> <span class="s2">&quot;${data.scaleway_bootscript.debian.id}&quot;</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_managers.id}&quot;</span>
</span><span class='line'>  <span class="nv">public_ip</span>      <span class="o">=</span> <span class="s2">&quot;${element(scaleway_ip.swarm_manager_ip.*.ip, count.index)}&quot;</span>
</span><span class='line'>
</span><span class='line'>  volume <span class="o">{</span>
</span><span class='line'>    <span class="nv">size_in_gb</span> <span class="o">=</span> 50
</span><span class='line'>    <span class="nb">type</span>       <span class="o">=</span> <span class="s2">&quot;l_ssd&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">script</span> <span class="o">=</span> <span class="s2">&quot;scripts/mount-disk.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  connection <span class="o">{</span>
</span><span class='line'>    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>    <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="nv">private_key</span> <span class="o">=</span> <span class="s2">&quot;${file(&quot;</span>~/.ssh/id_rsa<span class="s2">&quot;)}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;mkdir -p /etc/systemd/system/docker.service.d&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">content</span>     <span class="o">=</span> <span class="s2">&quot;${data.template_file.docker_conf.rendered}&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/etc/systemd/system/docker.service.d/docker.conf&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/install-docker-ce.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/install-docker-ce.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/local-persist-plugin.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/install-docker-ce.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/install-docker-ce.sh ${var.docker_version}&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;docker swarm init --advertise-addr ${self.private_ip}&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/local-persist-plugin.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>workers.tf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;scaleway_ip&quot;</span> <span class="s2">&quot;swarm_worker_ip&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span> <span class="o">=</span> <span class="s2">&quot;${var.worker_instance_count}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;scaleway_server&quot;</span> <span class="s2">&quot;swarm_worker&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">count</span>          <span class="o">=</span> <span class="s2">&quot;${var.worker_instance_count}&quot;</span>
</span><span class='line'>  <span class="nv">name</span>           <span class="o">=</span> <span class="s2">&quot;${terraform.workspace}-worker-${count.index + 1}&quot;</span>
</span><span class='line'>  <span class="nv">image</span>          <span class="o">=</span> <span class="s2">&quot;${data.scaleway_image.debian_stretch.id}&quot;</span>
</span><span class='line'>  <span class="nb">type</span>           <span class="o">=</span> <span class="s2">&quot;${var.worker_instance_type}&quot;</span>
</span><span class='line'>  <span class="nv">bootscript</span>     <span class="o">=</span> <span class="s2">&quot;${data.scaleway_bootscript.debian.id}&quot;</span>
</span><span class='line'>  <span class="nv">security_group</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_security_group.swarm_workers.id}&quot;</span>
</span><span class='line'>  <span class="nv">public_ip</span>      <span class="o">=</span> <span class="s2">&quot;${element(scaleway_ip.swarm_worker_ip.*.ip, count.index)}&quot;</span>
</span><span class='line'>
</span><span class='line'>  volume <span class="o">{</span>
</span><span class='line'>    <span class="nv">size_in_gb</span> <span class="o">=</span> 50
</span><span class='line'>    <span class="nb">type</span>       <span class="o">=</span> <span class="s2">&quot;l_ssd&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">script</span> <span class="o">=</span> <span class="s2">&quot;scripts/mount-disk.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  connection <span class="o">{</span>
</span><span class='line'>    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>    <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>    <span class="nv">private_key</span> <span class="o">=</span> <span class="s2">&quot;${file(&quot;</span>~/.ssh/id_rsa<span class="s2">&quot;)}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;mkdir -p /etc/systemd/system/docker.service.d&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">content</span>     <span class="o">=</span> <span class="s2">&quot;${data.template_file.docker_conf.rendered}&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/etc/systemd/system/docker.service.d/docker.conf&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/install-docker-ce.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/install-docker-ce.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;file&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">source</span>      <span class="o">=</span> <span class="s2">&quot;scripts/local-persist-plugin.sh&quot;</span>
</span><span class='line'>    <span class="nv">destination</span> <span class="o">=</span> <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/install-docker-ce.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/install-docker-ce.sh ${var.docker_version}&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;docker swarm join --token ${data.external.swarm_tokens.result.worker} ${scaleway_server.swarm_manager.0.private_ip}:2377&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;chmod +x /tmp/local-persist-plugin.sh&quot;</span>,
</span><span class='line'>      <span class="s2">&quot;/tmp/local-persist-plugin.sh&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">when</span> <span class="o">=</span> <span class="s2">&quot;destroy&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;docker node update --availability drain ${self.name}&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">on_failure</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>
</span><span class='line'>
</span><span class='line'>    connection <span class="o">{</span>
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>      <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>      <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">when</span> <span class="o">=</span> <span class="s2">&quot;destroy&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;docker swarm leave&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">on_failure</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  provisioner <span class="s2">&quot;remote-exec&quot;</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">when</span> <span class="o">=</span> <span class="s2">&quot;destroy&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">inline</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>      <span class="s2">&quot;docker node rm --force ${self.name}&quot;</span>,
</span><span class='line'>    <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">on_failure</span> <span class="o">=</span> <span class="s2">&quot;continue&quot;</span>
</span><span class='line'>
</span><span class='line'>    connection <span class="o">{</span>
</span><span class='line'>      <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssh&quot;</span>
</span><span class='line'>      <span class="nv">user</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span>
</span><span class='line'>      <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>data <span class="s2">&quot;external&quot;</span> <span class="s2">&quot;swarm_tokens&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">program</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;./scripts/fetch-tokens.sh&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">query</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nv">host</span> <span class="o">=</span> <span class="s2">&quot;${scaleway_ip.swarm_manager_ip.0.ip}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">depends_on</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;scaleway_server.swarm_manager&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our config for the docker daemon: <code>conf/docker.tpl</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/dockerd -H fd:// <span class="se">\</span>
</span><span class='line'>  -H tcp://<span class="k">${</span><span class="nv">ip</span><span class="k">}</span>:2375 <span class="se">\</span>
</span><span class='line'>  --storage-driver<span class="o">=</span>overlay2 <span class="se">\</span>
</span><span class='line'>  --dns 8.8.4.4 --dns 8.8.8.8 <span class="se">\</span>
</span><span class='line'>  --log-driver json-file <span class="se">\</span>
</span><span class='line'>  --log-opt max-size<span class="o">=</span>50m --log-opt max-file<span class="o">=</span><span class="m">10</span> <span class="se">\</span>
</span><span class='line'>  --experimental<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
</span><span class='line'>  --metrics-addr 172.17.0.1:9323
</span></code></pre></td></tr></table></div></figure>


<p>Our script to mount our additional disk: <code>scripts/mount-disk.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>apt update
</span><span class='line'>apt install xfsprogs attr -y
</span><span class='line'>mkfs -t xfs /dev/vdb
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;/dev/vdb /mnt xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab
</span><span class='line'>mount -a
</span></code></pre></td></tr></table></div></figure>


<p>Our script to install docker: <code>scripts/install-docker-ce.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="nv">DOCKER_VERSION</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get -qq update
</span><span class='line'>apt-get -qq install apt-transport-https ca-certificates curl software-properties-common
</span><span class='line'>curl -fsSL https://download.docker.com/linux/debian/gpg <span class="p">|</span> sudo apt-key add -
</span><span class='line'>add-apt-repository <span class="s2">&quot;deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable&quot;</span>
</span><span class='line'>
</span><span class='line'>apt-get -q update -y
</span><span class='line'>apt-get -q install -y docker-ce<span class="o">=</span><span class="nv">$DOCKER_VERSION</span> containerd.io
</span></code></pre></td></tr></table></div></figure>


<p>Our script that retrieves the swarm tokens: <code>scripts/fetch-tokens.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Processing JSON in shell scripts</span>
</span><span class='line'><span class="c"># https://www.terraform.io/docs/providers/external/data_source.html#processing-json-in-shell-scripts</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="c"># Extract &quot;host&quot; argument from the input into HOST shell variable</span>
</span><span class='line'><span class="nb">eval</span> <span class="s2">&quot;$(jq -r &#39;@sh &quot;</span><span class="nv">HOST</span><span class="o">=</span><span class="se">\(</span>.host<span class="o">)</span><span class="s2">&quot;&#39;)&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">MANAGER</span><span class="o">=</span><span class="k">$(</span>ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null root@<span class="nv">$HOST</span> docker swarm join-token manager -q<span class="k">)</span>
</span><span class='line'><span class="nv">WORKER</span><span class="o">=</span><span class="k">$(</span>ssh -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null root@<span class="nv">$HOST</span> docker swarm join-token worker -q<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># produce a json object containing the tokens</span>
</span><span class='line'>jq -n --arg manager <span class="s2">&quot;$MANAGER&quot;</span> --arg worker <span class="s2">&quot;$WORKER&quot;</span> <span class="s1">&#39;{&quot;manager&quot;:$manager,&quot;worker&quot;:$worker}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our script to install the <a href="https://github.com/CWSpear/local-persist">local-persist docker volume</a> plugin: <code>scripts/local-persist-plugin.sh</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>curl -fsSL https://raw.githubusercontent.com/CWSpear/local-persist/master/scripts/install.sh <span class="p">|</span> bash
</span></code></pre></td></tr></table></div></figure>


<h2>Deploy your Swarm</h2>

<p>Note that we will be deploying 3x SMART1-M servers with Debian Stretch. At this moment the image id is the one of debian stretch but may change in the future. If you want to change the distro, update the install script, and the terraform files.</p>

<p><a href="https://www.scaleway.com/docs/generate-an-api-token/">Generate API Token on Scaleway</a> then export it to your current shell:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">SCALEWAY_ORGANIZATION</span><span class="o">=</span><span class="s2">&quot;&lt;organization-id&gt;&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">SCALEWAY_TOKEN</span><span class="o">=</span><span class="s2">&quot;&lt;secret&gt;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure that your ssh private key is the intended one as in the config, in my example: <code>~/.ssh/id_rsa</code> and that they are allowed in your servers <code>authorized_keys</code> file</p>

<p>Create a new workspace:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform new workspace swarm
</span></code></pre></td></tr></table></div></figure>


<p>Pull down the providers and initialize:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform init
</span></code></pre></td></tr></table></div></figure>


<p>Deploy!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform apply
</span><span class='line'>...
</span><span class='line'>...
</span><span class='line'>scaleway_server.swarm_worker<span class="o">[</span>0<span class="o">]</span>: Creation <span class="nb">complete </span>after 4m55s <span class="o">(</span>ID: xx-xx-xx-xx-xx<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Apply <span class="nb">complete</span>! Resources: <span class="m">14</span> added, <span class="m">0</span> changed, <span class="m">0</span> destroyed.
</span><span class='line'>Outputs:
</span><span class='line'>
</span><span class='line'><span class="nv">swarm_manager_private_ip</span> <span class="o">=</span> 10.21.x.x
</span><span class='line'><span class="nv">swarm_manager_public_ip</span> <span class="o">=</span> 51.xx.xx.xx
</span><span class='line'><span class="nv">swarm_workers_private_ip</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    swarm-worker-1,
</span><span class='line'>    swarm-worker-2,
</span><span class='line'>    10.20.xx.xx,
</span><span class='line'>    10.20.xx.xx,
</span><span class='line'><span class="o">]</span>
</span><span class='line'><span class="nv">swarm_workers_public_ip</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>    swarm-worker-1,
</span><span class='line'>    swarm-worker-2,
</span><span class='line'>    51.xx.xx.xx,
</span><span class='line'>    51.xx.xx.xx,
</span><span class='line'><span class="o">]</span>
</span><span class='line'><span class="nv">workspace</span> <span class="o">=</span> swarm
</span></code></pre></td></tr></table></div></figure>


<p>Once your deployment is done you will be prompted with the public/private ip addresses of your nodes as seen above, you can also manually retrieve them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform terraform output
</span></code></pre></td></tr></table></div></figure>


<p>Or for a specific node, such as the manager:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform terraform output swarm-manager
</span><span class='line'>51.xx.xx.xx
</span></code></pre></td></tr></table></div></figure>


<p>Go ahead and ssh to your manager nodes and list the swarm nodes, boom, easy right.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker node ls
</span><span class='line'>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
</span><span class='line'>2696o0vrt93x8qf2gblbfc8pf *   swarm-manager       Ready               Active              Leader              18.09.3
</span><span class='line'>72ava7rrp2acnyadisg52n7ym     swarm-worker-1      Ready               Active                                  18.09.3
</span><span class='line'>sy2otqn20qe9jc2v9io3a21jm     swarm-worker-2      Ready               Active                                  18.09.3
</span></code></pre></td></tr></table></div></figure>


<p>When you want to destroy the environment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>terraform destroy -force
</span></code></pre></td></tr></table></div></figure>


<h2>References:</h2>

<p>Big thanks goes to <a href="https://github.com/stefanprodan">@stefanprodan</a></p>

<ul>
<li><a href="https://www.terraform.io/docs/index.html">https://www.terraform.io/docs/index.html</a></li>
<li><a href="https://docs.docker.com/engine/swarm/">https://docs.docker.com/engine/swarm/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/21/deploy-scaleway-servers-via-the-api-in-python/">Deploy Scaleway Servers via the API in Python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-21T01:04:00+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2019</span></span> <span class='time'>1:04 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/54725016-2e81e680-4b76-11e9-9e69-ffe4cd470bb7.jpg" alt="" /></p>

<p>A quick post on how to deploy Scaleway Servers via their API using Python.</p>

<h2>API Documentation</h2>

<p>Scaleway has great <a href="https://developer.scaleway.com/#servers-servers">API Documentation</a> available, so for deeper info have a look at the link provided.</p>

<h2>Python</h2>

<p>Our python script has a function <code>create_server</code> that expects a server name, server size, the tag and the linux distribution:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="n">SCW_API_KEY</span> <span class="o">=</span> <span class="s">&quot;&lt;your-api-key&gt;&quot;</span>
</span><span class='line'><span class="n">SCW_OGRA_ID</span> <span class="o">=</span> <span class="s">&quot;&lt;your-organization-id&gt;&quot;</span>
</span><span class='line'><span class="n">SCW_REGION</span> <span class="o">=</span> <span class="s">&quot;ams1&quot;</span>
</span><span class='line'><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">=</span> <span class="s">&quot;https://cp-{region}.scaleway.com/{resource}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">SCW_REGION</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s">&#39;servers&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">SCW_VOLUME_API_URL</span> <span class="o">=</span> <span class="s">&quot;https://cp-{region}.scaleway.com/{resource}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">SCW_REGION</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s">&#39;volumes&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">SCW_HEADERS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;X-Auth-Token&quot;</span><span class="p">:</span> <span class="n">SCW_API_KEY</span><span class="p">,</span> <span class="s">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s">&quot;application/json&quot;</span><span class="p">}</span>
</span><span class='line'><span class="n">SCW_IMAGES</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;ubuntu/18&quot;</span><span class="p">:</span> <span class="s">&quot;6a601340-19c1-4ca7-9c1c-0704bcc9f5fe&quot;</span><span class="p">,</span> <span class="s">&quot;debian/stretch&quot;</span><span class="p">:</span> <span class="s">&quot;710ff1fa-0d16-4f8f-93ac-0647c44fa21d&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="n">server_id</span><span class="p">):</span>
</span><span class='line'>  <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>  <span class="n">state</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">state</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">create_server</span><span class="p">(</span><span class="n">instance_name</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">,</span> <span class="n">instance_tag</span><span class="p">,</span> <span class="n">os_distro</span><span class="p">):</span>
</span><span class='line'>  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">compute_payload</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">instance_name</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;image&quot;</span><span class="p">:</span> <span class="n">SCW_IMAGES</span><span class="p">[</span><span class="n">os_distro</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;commercial_type&quot;</span><span class="p">:</span> <span class="n">instance_type</span><span class="p">,</span>
</span><span class='line'>      <span class="s">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">instance_tag</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;organization&quot;</span><span class="p">:</span> <span class="n">SCW_OGRA_ID</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;creating server&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">r_create</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">compute_payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>  <span class="n">server_id</span> <span class="o">=</span> <span class="n">r_create</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">&quot;server&quot;</span><span class="p">][</span><span class="s">&quot;id&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">action_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="s">&quot;poweron&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="n">r_start</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server_id</span> <span class="o">+</span> <span class="s">&quot;/action&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">action_payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>  <span class="n">r_describe</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">server_state</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">server_id</span><span class="p">)[</span><span class="s">&#39;server&#39;</span><span class="p">][</span><span class="s">&#39;state&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="k">while</span> <span class="n">server_state</span> <span class="o">!=</span> <span class="s">&quot;running&quot;</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>
</span><span class='line'>      <span class="n">r_delete</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">SCW_COMPUTE_API_URL</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">action_payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">SCW_HEADERS</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">{</span><span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;task timed out while waiting for server to boot&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;waiting for server to become ready&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>    <span class="n">server_state</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">server_id</span><span class="p">)[</span><span class="s">&#39;server&#39;</span><span class="p">][</span><span class="s">&#39;state&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>  <span class="n">resp</span> <span class="o">=</span> <span class="n">get_status</span><span class="p">(</span><span class="n">server_id</span><span class="p">)[</span><span class="s">&quot;server&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="n">output</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;hostname&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;instance_type&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;commercial_type&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;public_ip&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;public_ip&quot;</span><span class="p">][</span><span class="s">&quot;address&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;private_ip&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;private_ip&quot;</span><span class="p">],</span>
</span><span class='line'>      <span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="n">resp</span><span class="p">[</span><span class="s">&quot;state&quot;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">output</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">create_server</span><span class="p">(</span><span class="s">&quot;swarm-manager&quot;</span><span class="p">,</span> <span class="s">&quot;START1-M&quot;</span><span class="p">,</span> <span class="s">&quot;swarm&quot;</span><span class="p">,</span> <span class="s">&quot;ubuntu/18&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deploying a server with the hostname: swarm-manager, instance-size: START1-M, tag: swarm and os distribution: ubuntu/18:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python scw.py
</span><span class='line'>creating server
</span><span class='line'>waiting <span class="k">for</span> server to become ready
</span><span class='line'>waiting <span class="k">for</span> server to become ready
</span><span class='line'>waiting <span class="k">for</span> server to become ready
</span><span class='line'><span class="o">{</span><span class="s1">&#39;status&#39;</span>: u<span class="s1">&#39;running&#39;</span>, <span class="s1">&#39;hostname&#39;</span>: u<span class="s1">&#39;swarm-manager&#39;</span>, <span class="s1">&#39;public_ip&#39;</span>: u<span class="s1">&#39;51.x.x.x&#39;</span>, <span class="s1">&#39;instance_type&#39;</span>: u<span class="s1">&#39;START1-M&#39;</span>, <span class="s1">&#39;private_ip&#39;</span>: u<span class="s1">&#39;10.x.x.x&#39;</span>, <span class="s1">&#39;id&#39;</span>: u<span class="s1">&#39;xx-xx-xx-xx-xx&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For more info on <a href="https://www.scaleway.com">Scaleway</a> please do check them out: <a href="https://www.scaleway.com">https://www.scaleway.com</a>}</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/18/setup-nrpe-client-and-server-for-monitoring-remote-services-in-nagios/">Setup NRPE Client and Server for Monitoring Remote Services in Nagios</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-18T18:49:59+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>6:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/54547916-65f26680-49af-11e9-8d42-e27c57ef8e2e.png" alt="" /></p>

<p>If you have not setup the <a href="https://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/">Nagios Server</a> have a look at that link to setup the Nagios server.</p>

<h2>Nagios NRPE</h2>

<p>Nagios Remote Plugin Executor (NRPE) allows you to remotely execute Nagios plugins on other linux systems. This allows you to monitor remote machine metrics (disk usage, CPU, local listening services, etc.).</p>

<p>NRPE has 2 sections:</p>

<ul>
<li>The nagios server side.</li>
<li>The client side.</li>
</ul>


<p>For nagios to execute remote plugins, the client configuration needs to allow the nrpe server which will be nagios.</p>

<p>Download, extract, configure and install NRPE server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget 'https://github.com/NagiosEnterprises/nrpe/releases/download/nrpe-3.2.1/nrpe-3.2.1.tar.gz'
</span><span class='line'>$ tar -xvf nrpe-3.2.1.tar.gz
</span><span class='line'>$ cd nrpe-3.2.1
</span><span class='line'>$ ./configure --enable-command-args --with-nagios-user=nagios --with-nagios-group=nagcmd --with-ssl=/usr/bin/openssl --with-ssl-lib=/usr/lib/x86_64-linux-gnu
</span><span class='line'>$ make all
</span><span class='line'>$ make install
</span><span class='line'>$ make install-init
</span><span class='line'>$ make install-config
</span><span class='line'>$ systemctl enable nrpe.service</span></code></pre></td></tr></table></div></figure>


<p>Installing NRPE on the client side:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt install nagios-nrpe-server -y
</span><span class='line'>$ systemctl enable nagios-nrpe-server
</span><span class='line'>$ systemctl start nagios-nrpe-server</span></code></pre></td></tr></table></div></figure>


<p>Allow your nagios server ip in <code>/etc/nagios/nrpe.cfg</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>allowed_hosts=nagios.ip.in.here</span></code></pre></td></tr></table></div></figure>


<p>Restart NRPE on the client:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart nagios-nrpe-server</span></code></pre></td></tr></table></div></figure>


<p>Ensure that the <code>check_nrpe</code> plugin is configured and available in the commands.cfg configuration for the nagios server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/objects/commands.cfg
</span><span class='line'>
</span><span class='line'>define command {
</span><span class='line'>    command_name check_nrpe
</span><span class='line'>    command_line $USER1$/check_nrpe -H $HOSTADDRESS$ -c $ARG1$
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Check <a href="">this</a> out how to create a python nrpe nagios plugin to check disk space on the client host</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/18/monitor-your-first-host-and-services-with-nagios/">Monitor Your First Host and Services With Nagios</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-18T18:49:23+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>6:49 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/54547916-65f26680-49af-11e9-8d42-e27c57ef8e2e.png" alt="" /></p>

<p>If you have not setup the <a href="https://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/">Nagios Server</a> have a look at that link to setup the Nagios server.</p>

<h2>Configure Nagios to Monitor our first Host</h2>

<p>I like to setup an isolated path for my custom host/service configigurations. First we will declare the configuration path for our servers.</p>

<p>Open up: <code>/usr/local/nagios/etc/nagios.cfg</code> and add a new cfg_dir:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cfg_dir=/usr/local/nagios/etc/servers</span></code></pre></td></tr></table></div></figure>


<p>Now, create the directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir /usr/local/nagios/etc/servers</span></code></pre></td></tr></table></div></figure>


<p>Configure your email address for notifications in <code>/usr/local/nagios/etc/objects/contacts.cfg</code> and configure:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>email     youremail@yourdomain.com;</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s say we want to configure a web server named web01 that sits at the location 10.10.10.10:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/servers/webservers.cfg</span></code></pre></td></tr></table></div></figure>


<p>First we define our host configuration:</p>

<ol>
<li>We are using the <code>linux-server</code> template that is defined in <code>/usr/local/nagios/etc/objects/templates.cfg</code></li>
<li>We set the hostname, alias and address as well as notification prediods</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define host {
</span><span class='line'>    use                      linux-server
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    alias                    WEB01
</span><span class='line'>    address                  10.10.10.10
</span><span class='line'>    max_check_attempts       5
</span><span class='line'>    check_period             24x7
</span><span class='line'>    notification_interval    30
</span><span class='line'>    notification_period      24x7
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>While you have the config open, we want to define the services that we would like to monitor, and associate the services to the host that we defined.</p>

<p>In this example, we want to ping the server and check port tcp 22 and 80. Ensure that your web server is allowing the mentioned ports from the nagios server ip.</p>

<p>In the config, we are declaring the following:</p>

<ol>
<li>Use the <code>generic-service</code> template</li>
<li>Map the hostname which the service should be associated to</li>
<li>The description that you will see in nagios</li>
<li>Use the check_ping / check_ssh / check_http plugin and set the thresholds for ok, warning, critical</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define service {
</span><span class='line'>    use                    generic-service
</span><span class='line'>    host_name              WEB01
</span><span class='line'>    service_description    PING
</span><span class='line'>    check_command          check_ping!100.0,20%!500.0,60%
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                      generic-service
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    service_description      SSH
</span><span class='line'>    check_command            check_ssh
</span><span class='line'>    notifications_enabled    1
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                      generic-service
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    service_description      HTTP
</span><span class='line'>    check_command            check_http
</span><span class='line'>    notifications_enabled    1
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Save the config, test the config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios</span></code></pre></td></tr></table></div></figure>


<p>If you don&rsquo;t see any errors, go ahead and restart to apply the configs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemctl restart nagios
</span><span class='line'>$ systemctl restart apache2</span></code></pre></td></tr></table></div></figure>


<p>Head over to nagios user interface at <a href="http://nagios-ip/nagios">http://nagios-ip/nagios</a> and you should see that the services are scheduled to be checked and should be reflecting in a minute or two.</p>

<h2>Up Next</h2>

<p>Next up, <a href="https://blog.ruanbekker.com/blog/2019/03/18/setup-nrpe-client-and-server-for-monitoring-remote-services-in-nagios/">Setup the NRPE Server and Client</a> to monitor remote systems using the nrpe plugin.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/18/how-to-setup-the-nagiosgraph-plugin-on-nagios-monitoring-server/">How to Setup the NagiosGraph Plugin on Nagios Monitoring Server</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-18T18:27:11+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>6:27 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/54547916-65f26680-49af-11e9-8d42-e27c57ef8e2e.png" alt="" /></p>

<p>If you have not setup the <a href="https://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/">Nagios Server</a> have a look at that link to setup the Nagios server.</p>

<h2>NagiosGraph</h2>

<p>In this post we will setup the nagiosgraph plugin to graph performance data of our monitored host and services.</p>

<h2>Download and Install</h2>

<p>Download the nagiosgraph plugin and extract:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget 'https://downloads.sourceforge.net/project/nagiosgraph/nagiosgraph/1.5.2/nagiosgraph-1.5.2.tar.gz' -O nagiosgraph-1.5.2.tar.gz
</span><span class='line'>$ tar -xvf nagiosgraph-1.5.2.tar.gz</span></code></pre></td></tr></table></div></figure>


<p>Install dependencies and install the nagiosgraph plugin:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt install libnet-snmp-perl libsensors4 libsnmp-base libtalloc2 libtdb1 libwbclient0  snmp whois mrtg  libcgi-pm-perl librrds-perl libgd-perl libnagios-object-perl nagios-plugins-contrib
</span><span class='line'>$ ./install.pl --check-prereq
</span><span class='line'>$ ./install.pl --layout standalone --prefix /usr/local/nagiosgraph
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Destination directory (prefix)? [/usr/local/nagiosgraph]
</span><span class='line'>Location of configuration files (etc-dir)? [/usr/local/nagiosgraph/etc]
</span><span class='line'>Location of executables? [/usr/local/nagiosgraph/bin]
</span><span class='line'>Location of CGI scripts? [/usr/local/nagiosgraph/cgi]
</span><span class='line'>Location of documentation (doc-dir)? [/usr/local/nagiosgraph/doc]
</span><span class='line'>Location of examples? [/usr/local/nagiosgraph/examples]
</span><span class='line'>Location of CSS and JavaScript files? [/usr/local/nagiosgraph/share]
</span><span class='line'>Location of utilities? [/usr/local/nagiosgraph/util]
</span><span class='line'>Location of state files (var-dir)? [/usr/local/nagiosgraph/var]
</span><span class='line'>Location of RRD files? [/usr/local/nagiosgraph/var/rrd]
</span><span class='line'>Location of log files (log-dir)? [/usr/local/nagiosgraph/var/log]
</span><span class='line'>Path of log file? [/usr/local/nagiosgraph/var/log/nagiosgraph.log]
</span><span class='line'>Path of CGI log file? [/usr/local/nagiosgraph/var/log/nagiosgraph-cgi.log]
</span><span class='line'>Base URL? [/nagiosgraph]
</span><span class='line'>URL of CGI scripts? [/nagiosgraph/cgi-bin]
</span><span class='line'>URL of CSS file? [/nagiosgraph/nagiosgraph.css]
</span><span class='line'>URL of JavaScript file? [/nagiosgraph/nagiosgraph.js]
</span><span class='line'>URL of Nagios CGI scripts? [/nagios/cgi-bin]
</span><span class='line'>Path of Nagios performance data file? [/tmp/perfdata.log]
</span><span class='line'>username or userid of Nagios user? [nagios]
</span><span class='line'>username or userid of web server user? [www-data]
</span><span class='line'>Modify the Nagios configuration? [n] y
</span><span class='line'>Path of Nagios configuration file? [/usr/local/nagios/etc/nagios.cfg]
</span><span class='line'>Path of Nagios commands file? [/usr/local/nagios/etc/objects/commands.cfg]
</span><span class='line'>Modify the Apache configuration? [n] y
</span><span class='line'>Path of Apache configuration directory? /etc/apache2/sites-enabled
</span></code></pre></td></tr></table></div></figure>


<p>Ensure that your nagiosgraph configuration under apache: <code>/etc/apache2/sites-enabled/nagiosgraph.conf</code> has the following config (might be standard)</p>

<p><img src="https://user-images.githubusercontent.com/567298/54547000-946f4200-49ad-11e9-933e-b0e8b19bf014.png" alt="" /></p>

<p>Ensure the following configuration is set under nagios main config:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/nagios.cfg
</span><span class='line'>
</span><span class='line'>process_performance_data=1 
</span><span class='line'>service_perfdata_file=/usr/local/nagios/var/service-perfdata.log 
</span><span class='line'>service_perfdata_file_template=$LASTSERVICECHECK$||$HOSTNAME$||$SERVICEDESC$||$SERVICEOUTPUT$||$SERVICEPERFDATA$ 
</span><span class='line'>service_perfdata_file_mode=a 
</span><span class='line'>service_perfdata_file_processing_interval=30 
</span><span class='line'>service_perfdata_file_processing_command=process-service-perfdata-for-nagiosgraph</span></code></pre></td></tr></table></div></figure>


<p>Ensure that we have the following commands in place for nagiosgraph:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/objects/commands.cfg
</span><span class='line'>
</span><span class='line'>define command {
</span><span class='line'>  command_name process-service-perfdata-for-nagiosgraph
</span><span class='line'>  command_line /usr/local/nagiosgraph/bin/insert.pl
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Create the template <code>graphed-service</code>, this will be mapped to each service that needs to be graphed in nagiosgraph:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/objects/templates.cfg
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>      name              graphed-service
</span><span class='line'>      action_url        /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&service=$SERVICEDESC$' onMouseOver='showGraphPopup(this)' onMouseOut='hideGraphPopup()' rel='/nagiosgraph/cgi-bin/showgraph.cgi?host=$HOSTNAME$&service=$SERVICEDESC$&period=week&rrdopts=-w+450+-j
</span><span class='line'>      register        0
</span><span class='line'>      }</span></code></pre></td></tr></table></div></figure>


<p>Next configure the services that needs to be graphed on nagios graph. Note, we only need to append the service template that we defined in our template configuration from above:</p>

<p>Note, if you have not checked out <a href="https://blog.ruanbekker.com/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/">Nagios Server Setup</a> post, in that post the inital configuration of the below config is explained.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vi /usr/local/nagios/etc/servers/vpn.cfg
</span><span class='line'>
</span><span class='line'>define host {
</span><span class='line'>    use                      linux-server
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    alias                    WEB01
</span><span class='line'>    address                  10.10.10.10
</span><span class='line'>    max_check_attempts       5
</span><span class='line'>    check_period             24x7
</span><span class='line'>    notification_interval    30
</span><span class='line'>    notification_period      24x7
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                    generic-service,graphed-service
</span><span class='line'>    host_name              WEB01
</span><span class='line'>    service_description    PING
</span><span class='line'>    check_command          check_ping!100.0,20%!500.0,60%
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                      generic-service,graphed-service
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    service_description      SSH
</span><span class='line'>    check_command            check_ssh
</span><span class='line'>    notifications_enabled    1
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use                      generic-service,graphed-service
</span><span class='line'>    host_name                WEB01
</span><span class='line'>    service_description      HTTP
</span><span class='line'>    check_command            check_http
</span><span class='line'>    notifications_enabled    1
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Test the nagios config and restart if there are no warnings:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
</span><span class='line'>$ systemctl restart nagios
</span><span class='line'>$ systemctl restart apache2</span></code></pre></td></tr></table></div></figure>


<p>Access your nagios server at <a href="http://nagios-ip/nagios">http://nagios-ip/nagios</a> and you will find that the graph icon next to the service will open the graph in a new tab, like the screenshot below:</p>

<p><img src="https://user-images.githubusercontent.com/567298/54546912-5d992c00-49ad-11e9-8a7a-331578d20f5b.png" alt="" /></p>

<h2>Up Next</h2>

<p>Next, <a href="https://blog.ruanbekker.com/blog/2019/03/18/monitor-your-first-host-and-services-with-nagios/">Monitor your first Server with Nagios</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/13/how-to-setup-a-nagios-monitoring-server/">How to Setup a Nagios Monitoring Server</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-13T23:53:42+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>11:53 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://user-images.githubusercontent.com/567298/54547916-65f26680-49af-11e9-8d42-e27c57ef8e2e.png" alt="" /></p>

<p>Good old nagios! Nagios is a great Open Source Monitoring Server that monitors your servers and services/applications that is hosted on top of them, and has the ability to notify in the event when they go down.</p>

<p>I&rsquo;ve been using Nagios for the last 7 years and worked for 3 business that chose Nagios as their preferred server monitoring solution.</p>

<p>All <a href="https://blog.ruanbekker.com/blog/categories/nagios/">Nagios</a> related posts are grouped under the <a href="https://blog.ruanbekker.com/blog/categories/nagios/">#nagios</a> category.</p>

<h2>What we are doing today</h2>

<p>Today we will setup a Nagios server and its plugins. The plugins helps to check different endpoints, such as custom tcp checks, ssh, snmp etc.</p>

<p>In this nagios tutorial series, I will publish a couple of post which will include:</p>

<ul>
<li>Setup the Nagios Server and its Plugins - this post</li>
<li>Setup the NRPE Server and NRPE Client Server (this is nice for local ports or custom checks)</li>
<li>Setup Nagiosgraph (Graph performance data and add it as extra host configuration)</li>
<li>Setup a custom Bash and Python Nagios Plugin for Custom Checks</li>
<li>Setup a Telegram / Slack Plugin</li>
</ul>


<h2>Installing Dependencies:</h2>

<p>Go ahead and install all the dependencies needed by nagios and add the nagios user and group:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt update
</span><span class='line'><span class="nv">$ </span>apt install build-essential libgd-dev openssl libssl-dev unzip apache2 -y
</span><span class='line'><span class="nv">$ </span>apt install autoconf gcc libc6 make wget unzip apache2 php libapache2-mod-php7.2 libgd-dev
</span><span class='line'><span class="nv">$ </span>apt install libmcrypt-dev libssl-dev bc gawk dc build-essential libnet-snmp-perl gettext
</span><span class='line'><span class="nv">$ </span>apt install libcarp-clan-perl rrdtool php-rrd libssl1.0-dev
</span><span class='line'><span class="nv">$ </span>useradd nagios
</span><span class='line'><span class="nv">$ </span>groupadd nagcmd
</span><span class='line'><span class="nv">$ </span>usermod -a -G nagcmd nagios
</span></code></pre></td></tr></table></div></figure>


<h2>Install Nagios</h2>

<p>Download the nagios tarball from their website, have a look at <a href="https://www.nagios.org/downloads/">https://www.nagios.org/downloads/</a> for the latest version.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget -O nagios.tar.gz <span class="s1">&#39;https://assets.nagios.com/downloads/nagioscore/releases/nagios-4.4.3.tar.gz?__hstc=118811158.7bdae752f04b6d927ddf150ae1ce5c71.1552389135285.1552394646569.1552410974898.3&amp;__hssc=118811158.1.1552410974898&amp;__hsfp=2323916385#_ga=2.246938692.1332751653.1552389134-913645931.1552389134&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Extract the archive:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>tar xpf nagios*.tar.gz
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>nagios-4.4.3/
</span></code></pre></td></tr></table></div></figure>


<p>Configure with nagios user and nagcmd group, install and change the ownership of the generated data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./configure --with-nagios-group<span class="o">=</span>nagios --with-command-group<span class="o">=</span>nagcmd
</span><span class='line'><span class="nv">$ </span>make -j4 all
</span><span class='line'><span class="nv">$ </span>make install
</span><span class='line'><span class="nv">$ </span>make install-commandmode
</span><span class='line'><span class="nv">$ </span>make install-init
</span><span class='line'><span class="nv">$ </span>make install-config
</span><span class='line'><span class="nv">$ </span>/usr/bin/install -c -m <span class="m">644</span> sample-config/httpd.conf /etc/apache2/sites-available/nagios.conf
</span><span class='line'><span class="nv">$ </span>usermod -a -G nagcmd www-data
</span></code></pre></td></tr></table></div></figure>


<h2>Install Nagios Plugins</h2>

<p>Get the nagios plugins tarball, extract and install:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>wget nagios-plugins.tar.gz <span class="s1">&#39;https://nagios-plugins.org/download/nagios-plugins-2.2.1.tar.gz#_ga=2.250909126.1332751653.1552389134-913645931.1552389134&#39;</span>
</span><span class='line'><span class="nv">$ </span>tar xpf nagios-plugins*.tar.gz
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>nagios-plugins-2.2.1
</span><span class='line'><span class="nv">$ </span>./configure --with-nagios-user<span class="o">=</span>nagios --with-nagios-group<span class="o">=</span>nagcmd --with-openssl
</span><span class='line'><span class="nv">$ </span>make -j4
</span><span class='line'><span class="nv">$ </span>make install
</span></code></pre></td></tr></table></div></figure>


<h2>Access Nagios</h2>

<p>Enable apache modules:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>a2enmod rewrite
</span><span class='line'><span class="nv">$ </span>a2enmod cgi
</span></code></pre></td></tr></table></div></figure>


<p>Setup basic auth for logging onto nagios:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>htpasswd -c /usr/local/nagios/etc/htpasswd.users nagiosadmin
</span></code></pre></td></tr></table></div></figure>


<p>Setup a symlink for apache&rsquo;s nagios configuration</p>

<p>The configuration for the above will look more or less like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat /etc/apache2/sites-enabled/nagios.conf
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>         Require all granted
</span><span class='line'>         AuthName <span class="s2">&quot;Nagios Access&quot;</span>
</span><span class='line'>         AuthType Basic
</span><span class='line'>         AuthUserFile /usr/local/nagios/etc/htpasswd.users
</span><span class='line'>         Require valid-user
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Create the systemd unit file for nagios <code>/etc/systemd/system/nagios.service</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Nagios
</span><span class='line'><span class="nv">BindTo</span><span class="o">=</span>network.target
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">Type</span><span class="o">=</span>simple
</span><span class='line'><span class="nv">User</span><span class="o">=</span>nagios
</span><span class='line'><span class="nv">Group</span><span class="o">=</span>nagcmd
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/usr/local/nagios/bin/nagios /usr/local/nagios/etc/nagios.cfg
</span></code></pre></td></tr></table></div></figure>


<p>Reload the daemon:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl daemon-reload
</span></code></pre></td></tr></table></div></figure>


<p>Enable the service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable</span> /etc/systemd/system/nagios.service
</span></code></pre></td></tr></table></div></figure>


<p>Ensure nagios is started:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl restart nagios
</span><span class='line'><span class="nv">$ </span>systemctl restart apache2
</span></code></pre></td></tr></table></div></figure>


<p>Access nagios on <a href="http://nagios-ip/nagios">http://nagios-ip/nagios</a> with the credentials that you configured earlier.</p>

<h2>Up Next</h2>

<p>In the next posts I will cover the following:</p>

<ol>
<li><a href="https://blog.ruanbekker.com/blog/2019/03/18/how-to-setup-the-nagiosgraph-plugin-on-nagios-monitoring-server/">Setup NagiosGraph for monitoring performance data</a></li>
<li>Show you how to create a custom nagios plugin in python</li>
<li>Create a Custom Notification service to send notifications to Telegram (or any API)</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/03/10/setup-a-reverse-proxy-on-nginx-for-your-backend-applications/">Setup a Reverse Proxy on Nginx for Your Backend Applications</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-03-10T00:50:32+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>12:50 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://www.nginx.com/wp-content/uploads/2018/08/NGINX-logo-rgb-large.png" alt="" /></p>

<p>Nginx is a great product! And today we will use nginx to setup a http reverse proxy to access our backend applications.</p>

<script id="mNCC" language="javascript">
    medianet_width = "728";
    medianet_height = "90";
    medianet_crid = "218284798";
    medianet_versionId = "3111299";
  </script>


<script src="//contextual.media.net/nmedianet.js?cid=8CUD78FSV"></script>


<h2>Our Setup</h2>

<p>We will have a flask backend application listening on <code>127.0.0.1:5000</code> and our nginx reverse proxy will listen on <code>0.0.0.0:80</code> which will proxy requests through to our flask upstream.</p>

<h2>Our Backend Application</h2>

<p>Our Flask application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>from flask import Flask
</span><span class='line'>app = Flask(__name__)
</span><span class='line'>
</span><span class='line'>@app.route('/')
</span><span class='line'>def index():
</span><span class='line'>    return 'Hello'
</span><span class='line'>
</span><span class='line'>if __name__ == '__main__':
</span><span class='line'>    app.run(host='127.0.0.1', port=5000)</span></code></pre></td></tr></table></div></figure>


<h2>Nginx</h2>

<p>Install nginx:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apt install nginx -y
</span></code></pre></td></tr></table></div></figure>


<p>Our main nginx configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># /etc/nginx/nginx.conf</span>
</span><span class='line'>user www-data<span class="p">;</span>
</span><span class='line'>worker_processes auto<span class="p">;</span>
</span><span class='line'>pid /run/nginx.pid<span class="p">;</span>
</span><span class='line'>include /etc/nginx/modules-enabled/*.conf<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>    worker_connections 768<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>    sendfile on<span class="p">;</span>
</span><span class='line'>    tcp_nopush on<span class="p">;</span>
</span><span class='line'>    tcp_nodelay on<span class="p">;</span>
</span><span class='line'>    keepalive_timeout 65<span class="p">;</span>
</span><span class='line'>    types_hash_max_size 2048<span class="p">;</span>
</span><span class='line'>    server_names_hash_bucket_size 64<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    include /etc/nginx/mime.types<span class="p">;</span>
</span><span class='line'>    default_type application/octet-stream<span class="p">;</span>
</span><span class='line'>    ssl_protocols TLSv1 TLSv1.1 TLSv1.2<span class="p">;</span> <span class="c"># Dropping SSLv3, ref: POODLE</span>
</span><span class='line'>    ssl_prefer_server_ciphers on<span class="p">;</span>
</span><span class='line'>    access_log /var/log/nginx/access.log<span class="p">;</span>
</span><span class='line'>    error_log /var/log/nginx/error.log<span class="p">;</span>
</span><span class='line'>    gzip on<span class="p">;</span>
</span><span class='line'>    gzip_disable <span class="s2">&quot;msie6&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    include /etc/nginx/conf.d/backend-*.conf<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our application&rsquo;s configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># /etc/nginx/conf.d/backend-flask.conf</span>
</span><span class='line'>upstream backend_flask <span class="o">{</span>
</span><span class='line'>    server 127.0.0.1:5000<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>server <span class="o">{</span>
</span><span class='line'>    listen <span class="m">80</span> default_server<span class="p">;</span>
</span><span class='line'>    listen <span class="o">[</span>::<span class="o">]</span>:80<span class="p">;</span>
</span><span class='line'>    server_name _<span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>    location / <span class="o">{</span>
</span><span class='line'>        include proxy_params<span class="p">;</span>
</span><span class='line'>        proxy_http_version 1.1<span class="p">;</span>
</span><span class='line'>        proxy_read_timeout 90<span class="p">;</span>
</span><span class='line'>        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>        proxy_set_header Upgrade <span class="nv">$http_upgrade</span><span class="p">;</span>
</span><span class='line'>        proxy_set_header Connection <span class="s2">&quot;upgrade&quot;</span><span class="p">;</span>
</span><span class='line'>        proxy_pass http://backend_flask<span class="p">;</span>
</span><span class='line'>        proxy_buffering off<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Restart nginx and enable nginx on boot:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>systemctl restart nginx
</span><span class='line'><span class="nv">$ </span>systemctl <span class="nb">enable </span>nginx
</span></code></pre></td></tr></table></div></figure>


<h2>Test your Application:</h2>

<p>Access your server on port 80 and you should receive the response from your flask application:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://nginx-public-ip:80/
</span><span class='line'>Hello
</span></code></pre></td></tr></table></div></figure>


<h2>Resoures</h2>

<ul>
<li><a href="https://itnext.io/step-over-nginx-buffer-issue-94a498bedb82">https://itnext.io/step-over-nginx-buffer-issue-94a498bedb82</a></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/9">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/7">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Subscribe</h1>
  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="https://sysadmins.us15.list-manage.com/subscribe/post?u=3dfcff447b6ee598231eeb658&amp;id=3542f323a9" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
      <div class="indicates-required"><span class="asterisk"></span></div>
      <div class="mc-field-group">
	<label for="mce-EMAIL">Email Address:  <span class="asterisk"></span>
        </label>
	<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
        </div>
	<div id="mce-responses" class="clear">
	  <div class="response" id="mce-error-response" style="display:none"></div>
	  <div class="response" id="mce-success-response" style="display:none"></div>
	</div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3dfcff447b6ee598231eeb658_3542f323a9" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
  </form>
</div>
<!--End mc_embed_signup-->
</section>

<section>
  <h1>Slack</h1>
  Join me on <a href="http://linux-hackers.slack.com">Slack</a>
</section>

<section>
  <h1>Twitter</h1>
  Follow me on Twitter: <a href="https://twitter.com/ruanbekker">@ruanbekker</a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/04/28/nginx-analysis-dashboard-using-grafana-and-elasticsearch/">Nginx Analysis Dashboard Using Grafana and Elasticsearch</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/27/how-to-do-port-forwarding-with-iptables/">How to Do Port Forwarding With Iptables</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/27/how-to-set-a-static-ip-in-ubuntu-18/">How to Set a Static IP in Ubuntu 18</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/26/graphing-covid-19-stats-with-grafana-and-elasticsearch-using-python/">Graphing Covid-19 Stats With Grafana and Elasticsearch Using Python</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/04/25/nginx-metrics-on-prometheus-with-the-nginx-log-exporter/">Nginx Metrics on Prometheus With the Nginx Log Exporter</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Free $100 Credit</h1>
  <ul id=""></ul>
  <p></p>
  <strong>May 2020</strong>: Receive $100 to test on Vultr when you sign up.
  <p></p>
  <a href="https://www.vultr.com/?ref=8373836-6G"><img src="https://www.vultr.com/media/banners/banner_160x600.png" width="160" height="600"></a>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Ruan -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>



  <li>
    <a href="https://twitter.com/ruanbekker">
      <i class="fa fa-twitter"></i> Twitter
    </a>
  </li>



  <li>
    <a href="https://github.com/ruanbekker">
      <i class="fa fa-github"></i> GitHub
    </a>
  </li>



  <li>
    <a href="https://sysadmins.co.za">
      <i class="fa fa-bars"></i> My HowTo Blog
    </a>
  </li>


</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blog-ruanbekker';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





      <script data-ad-client="ca-pub-1100086574264181" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- old
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-1543437721119411",
        enable_page_level_ads: true
      });
    </script>
    -->


</body>
</html>
